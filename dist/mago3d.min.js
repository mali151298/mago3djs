"use strict";function changeMagoStateAPI(t,e){if(null!==t){var i=new Mago3D.API("changeMagoState");i.setMagoEnable(e),t.callAPI(i)}}function changeLabelAPI(t,e){if(null!==t){var i=new Mago3D.API("changeLabel");i.setShowLabelInfo(e),t.callAPI(i)}}function changeOriginAPI(t,e){if(null!==t){var i=new Mago3D.API("changeOrigin");i.setShowOrigin(e),t.callAPI(i)}}function changeBoundingBoxAPI(t,e){if(null!==t){var i=new Mago3D.API("changeBoundingBox");i.setShowBoundingBox(e),t.callAPI(i)}}function changePropertyRenderingAPI(t,e,i,o){if(null!==t){var r=new Mago3D.API("changePropertyRendering");r.setShowShadow(e),r.setProjectId(i),r.setProperty(o),t.callAPI(r)}}function changeShadowAPI(t,e){if(null!==t){var i=new Mago3D.API("changeShadow");i.setShowShadow(e),t.callAPI(i)}}function changeColorAPI(t,e,i,o,r,n){if(null!==t){var a=new Mago3D.API("changeColor");a.setProjectId(e),a.setDataKey(i),a.setObjectIds(o),a.setProperty(r),a.setColor(n),t.callAPI(a)}}function changeLocationAndRotationAPI(t,e,i,o,r,n,a,s,l,d){if(null!==t){var h=new Mago3D.API("changeLocationAndRotation");h.setProjectId(e),h.setDataKey(i),h.setLatitude(o),h.setLongitude(r),h.setElevation(n),h.setHeading(a),h.setPitch(s),h.setRoll(l),h.setAnimationOption(d),t.callAPI(h)}}function changeObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("changeObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function saveObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("saveObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function deleteAllObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("deleteAllObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function deleteAllChangeColorAPI(t){if(null!==t){var e=new Mago3D.API("deleteAllChangeColor");t.callAPI(e)}}function changeInsertIssueModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeInsertIssueMode");i.setIssueInsertEnable(e),t.callAPI(i)}}function changeObjectInfoViewModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeObjectInfoViewMode");i.setObjectInfoViewEnable(e),t.callAPI(i)}}function changeOcclusionCullingAPI(t,e,i){if(null!==t){var o=new Mago3D.API("changeOcclusionCulling");o.setOcclusionCullingEnable(e),o.setDataKey(i),t.callAPI(o)}}function changeFPVModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeFPVMode");i.setFPVMode(e),t.callAPI(i)}}function changeMagoModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeMagoMode");i.setMagoMode(e),t.callAPI(i)}}function changeNearGeoIssueListViewModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeNearGeoIssueListViewMode");i.setNearGeoIssueListEnable(e),t.callAPI(i)}}function changeInsertIssueStateAPI(t,e){if(null!==t){var i=new Mago3D.API("changeInsertIssueState");i.setInsertIssueState(e),t.callAPI(i)}}function changeLodAPI(t,e,i,o,r,n,a){if(null!==t){var s=new Mago3D.API("changeLod");s.setLod0DistInMeters(e),s.setLod1DistInMeters(i),s.setLod2DistInMeters(o),s.setLod3DistInMeters(r),s.setLod4DistInMeters(n),s.setLod5DistInMeters(a),t.callAPI(s)}}function changeLightingAPI(t,e,i,o,r,n){if(null!==t){var a=new Mago3D.API("changeLighting");a.setAmbientReflectionCoef(e),a.setDiffuseReflectionCoef(i),a.setSpecularReflectionCoef(o),a.setAmbientColor(r),a.setSpecularColor(n),t.callAPI(a)}}function changeSsaoRadiusAPI(t,e){if(null!==t){var i=new Mago3D.API("changeSsaoRadius");i.setSsaoRadius(e),t.callAPI(i)}}function clearAllDataAPI(t){if(null!==t){var e=new Mago3D.API("clearAllData");Mago3D.MagoConfig.clearAllData(),t.callAPI(e)}}function drawInsertIssueImageAPI(t,e,i,o,r,n,a,s){if(null!==t){var l=new Mago3D.API("drawInsertIssueImage");l.setDrawType(e),l.setIssueId(i),l.setIssueId(o),l.setDataKey(r),l.setLatitude(n),l.setLongitude(a),l.setElevation(s),t.callAPI(l)}}function gotoProjectAPI(t,e,i,o,r,n,a,s){if(null!==t){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+o,o);var l=new Mago3D.API("gotoProject");l.setProjectId(e),l.setProjectDataFolder(o),l.setLatitude(n),l.setLongitude(r),l.setElevation(a),l.setDuration(s),t.callAPI(l)}}function gotoIssueAPI(t,e,i,o,r,n,a,s,l,d){if(null!==t){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+o,o);var h=new Mago3D.API("gotoIssue");h.setProjectId(e),h.setProjectDataFolder(o),h.setIssueId(r),h.setIssueType(n),h.setLatitude(s),h.setLongitude(a),h.setElevation(l),h.setDuration(d),t.callAPI(h)}}function gotoFlyAPI(t,e,i,o,r){if(null!==t){var n=new Mago3D.API("gotoFly");n.setLongitude(e),n.setLatitude(i),n.setElevation(o),n.setDuration(r),t.callAPI(n)}}function mouseMoveAPI(t,e){null!==t&&t.mouseMove(e)}function searchDataAPI(t,e,i){if(null!==t){var o=new Mago3D.API("searchData");o.setProjectId(e),o.setDataKey(i),t.callAPI(o)}}function isDataExistAPI(t){return!!Mago3D.MagoConfig.isDataExist(t)}function getDataAPI(t){return Mago3D.MagoConfig.getData(t)}function getDataInfoByDataKeyAPI(t,e,i){if(null!==t){var o=new Mago3D.API("getDataInfoByDataKey");o.setProjectId(e),o.setDataKey(i),t.callAPI(o)}}function drawAppendDataAPI(t,e,i,o){if(null!==t&&!(e.length<=0)){var r=new Mago3D.API("drawAppendData");e.forEach(function(e,n){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i[n]),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+o[n],o[n]),r.setProjectId(e),r.setProjectDataFolder(o[n]),t.callAPI(r)})}}function getCoordinateRelativeToBuildingAPI(t,e,i,o,r){if(null!==t){var n=new Mago3D.API("getCoordinateRelativeToBuilding");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(i),n.setInputPoint(o),n.setResultPoint(r),t.callAPI(n)}}function getAbsoluteCoodinateOfBuildingPointAPI(t,e,i,o,r){if(null!==t){var n=new Mago3D.API("getAbsoluteCoodinateOfBuildingPoint");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(i),n.setInputPoint(o),n.setResultPoint(r),t.callAPI(n)}}function getCameraCurrentPositionAPI(t,e){var i=new Mago3D.API("getCameraCurrentPosition");return i.setReturnable(!0),i.setUnit(e),t.callAPI(i)}function getCameraCurrentOrientaionAPI(t){var e=new Mago3D.API("getCameraCurrentOrientaion");return e.setReturnable(!0),t.callAPI(e)}function changeCameraOrientationAPI(t,e,i,o,r){var n=new Mago3D.API("changeCameraOrientation");n.setHeading(e),n.setPitch(i),n.setRoll(o),n.setDuration(r),t.callAPI(n)}function instantiateStaticModelAPI(t,e){var i=new Mago3D.API("instantiateStaticModel");i.setInstantiateObj(e),t.callAPI(i)}function addStaticModelAPI(t,e){var i=new Mago3D.API("addStaticModel");i.setStaticModelAttributeObj(e),t.callAPI(i)}function setTrackNodeAPI(t,e,i,o){var r=new Mago3D.API("setTrackNode");r.setProjectId(e),r.setDataKey(i),r.setTrackOption(o),t.callAPI(r)}function stopTrackAPI(t){var e=new Mago3D.API("stopTrack");t.callAPI(e)}function isExistStaticModelAPI(t,e){var i=new Mago3D.API("isExistStaticModel");return i.setReturnable(!0),i.setProjectId(e),t.callAPI(i)}function isExistDataAPI(t,e,i){var o=new Mago3D.API("isExistData");return o.setReturnable(!0),o.setProjectId(e),o.setDataKey(i),t.callAPI(o)}function isDataReadyToRenderAPI(t,e,i){var o=new Mago3D.API("isDataReadyToRender");return o.setReturnable(!0),o.setProjectId(e),o.setDataKey(i),t.callAPI(o)}function setNodeAttributeAPI(t,e,i,o){var r=new Mago3D.API("setNodeAttribute");r.setProjectId(e),r.setDataKey(i),r.setNodeAttribute(o),t.callAPI(r)}function togglePointCloudColorAPI(t){var e=new Mago3D.API("togglePointCloudColor");t.callAPI(e)}function apiResultCallback(t,e,i){window[t](e,i)}function selectedObjectCallback(t,e,i,o,r,n,a,s,l,d){window[t](e,i,o,r,n,a,s,l,d)}function movedDataCallback(t,e,i,o,r,n,a,s,l,d){window[t](e,i,o,r,n,a,s,l,d)}function dataInfoCallback(t,e,i,o,r,n,a,s,l,d){window[t](e,i,o,r,n,a,s,l,d)}function insertIssueCallback(t,e,i,o,r,n,a){window[t](e,i,o,r,n,a)}function clickPositionCallback(t,e){window[t](e)}var DataStream=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||1),this.position=0,this.endianness=null==i?DataStream.LITTLE_ENDIAN:i};DataStream.prototype={},void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT),DataStream.prototype.save=function(t){var e=new Blob(this.buffer),i=window.webkitURL||window.URL;if(!i||!i.createObjectURL)throw"DataStream.save: Can't create object URL.";var o=i.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",o),r.setAttribute("download",t),r.click(),i.revokeObjectURL(o)},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),DataStream.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i)e>this._byteLength&&(this._byteLength=e);else{for(i<1&&(i=1);e>i;)i*=2;var o=new ArrayBuffer(i),r=new Uint8Array(this._buffer);new Uint8Array(o,0,r.length).set(r),this.buffer=o,this._byteLength=e}}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},DataStream.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},DataStream.prototype.isEof=function(){return this.position>=this.byteLength},DataStream.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},DataStream.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},DataStream.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},DataStream.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Int32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Int16Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Uint32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Uint16Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var i=new Float64Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Float32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},DataStream.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},DataStream.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},DataStream.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},DataStream.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},DataStream.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},DataStream.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},DataStream.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},DataStream.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},DataStream.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},DataStream.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},DataStream.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},DataStream.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},DataStream.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(t,e,i,o,r){var n=new Uint8Array(t,e,r),a=new Uint8Array(i,o,r);n.set(a)},DataStream.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},DataStream.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},DataStream.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var o=i+t.BYTES_PER_ELEMENT-1,r=i;o>r;o--,r++){var n=e[r];e[r]=e[o],e[o]=n}return t},DataStream.createStringFromArray=function(t){for(var e=[],i=0;i<t.length;i+=32768)e.push(String.fromCharCode.apply(null,t.subarray(i,i+32768)));return e.join("")},DataStream.prototype.failurePosition=0,DataStream.prototype.readStruct=function(t){for(var e,i,o={},r=this.position,n=0;n<t.length;n+=2){if(e=t[n+1],null==(i=this.readType(e,o)))return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=r,null;o[t[n]]=i}return o},DataStream.prototype.readUCS2String=function(t,e){return DataStream.createStringFromArray(this.readUint16Array(t,e))},DataStream.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var o=0;o<t.length&&o<i;o++)this.writeUint16(t.charCodeAt(o),e);for(;o<i;o++)this.writeUint16(0)},DataStream.prototype.readString=function(t,e){return null==e||"ASCII"==e?DataStream.createStringFromArray(this.mapUint8Array(null==t?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))},DataStream.prototype.writeString=function(t,e,i){if(null==e||"ASCII"==e)if(null!=i){var o=0,r=Math.min(t.length,i);for(o=0;o<r;o++)this.writeUint8(t.charCodeAt(o));for(;o<i;o++)this.writeUint8(0)}else for(o=0;o<t.length;o++)this.writeUint8(t.charCodeAt(o));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},DataStream.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),o=e;null!=t&&(o=Math.min(t,e));for(var r=0;r<o&&0!=i[r];r++);var n=DataStream.createStringFromArray(this.mapUint8Array(r));return null!=t?this.position+=o-r:r!=e&&(this.position+=1),n},DataStream.prototype.writeCString=function(t,e){if(null!=e){var i=0,o=Math.min(t.length,e);for(i=0;i<o;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},DataStream.prototype.readType=function(t,e){if("function"==typeof t)return t(this,e);if(!("object"!=typeof t||t instanceof Array))return t.get(this,e);if(t instanceof Array&&3!=t.length)return this.readStruct(t,e);var i,o=null,r=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(i=t.split(":"))[0],r=null!=e[s=i[1]]?parseInt(e[s]):parseInt(i[1]));"string"==typeof t&&/,/.test(t)&&(t=(i=t.split(","))[0],n=parseInt(i[1]));switch(t){case"uint8":o=this.readUint8();break;case"int8":o=this.readInt8();break;case"uint16":o=this.readUint16(this.endianness);break;case"int16":o=this.readInt16(this.endianness);break;case"uint32":o=this.readUint32(this.endianness);break;case"int32":o=this.readInt32(this.endianness);break;case"float32":o=this.readFloat32(this.endianness);break;case"float64":o=this.readFloat64(this.endianness);break;case"uint16be":o=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":o=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":o=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":o=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":o=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":o=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":o=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":o=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":o=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":o=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":o=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":o=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":o=this.readCString(r);break;case"string":o=this.readString(r,n);break;case"u16string":o=this.readUCS2String(r,this.endianness);break;case"u16stringle":o=this.readUCS2String(r,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":o=this.readUCS2String(r,DataStream.BIG_ENDIAN);break;default:if(3==t.length){var s,l=t[1],d=0;if(d="function"==typeof(s=t[2])?s(e,this,t):"string"==typeof s&&null!=e[s]?parseInt(e[s]):parseInt(s),"string"==typeof l){var h=l.replace(/(le|be)$/,""),c=null;switch(/le$/.test(l)?c=DataStream.LITTLE_ENDIAN:/be$/.test(l)&&(c=DataStream.BIG_ENDIAN),"*"==s&&(d=null),h){case"uint8":o=this.readUint8Array(d);break;case"uint16":o=this.readUint16Array(d,c);break;case"uint32":o=this.readUint32Array(d,c);break;case"int8":o=this.readInt8Array(d);break;case"int16":o=this.readInt16Array(d,c);break;case"int32":o=this.readInt32Array(d,c);break;case"float32":o=this.readFloat32Array(d,c);break;case"float64":o=this.readFloat64Array(d,c);break;case"cstring":case"utf16string":case"string":if(null==d)for(o=[];!this.isEof();){if(null==(p=this.readType(l,e)))break;o.push(p)}else{o=new Array(d);for(var u=0;u<d;u++)o[u]=this.readType(l,e)}}}else if("*"==s)for(o=[],this.buffer;;){var f=this.position;try{var g=this.readType(l,e);if(null==g){this.position=f;break}o.push(g)}catch(t){this.position=f;break}}else{o=new Array(d);for(u=0;u<d;u++){var p;if(null==(p=this.readType(l,e)))return null;o[u]=p}}break}}return null!=r&&(this.position=a+r),o},DataStream.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var o=t[i+1];this.writeType(o,e[t[i]],e)}},DataStream.prototype.writeType=function(t,e,i){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var o,r=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(o=t.split(":"))[0],r=parseInt(o[1]));"string"==typeof t&&/,/.test(t)&&(t=(o=t.split(","))[0],n=parseInt(o[1]));switch(t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,r);break;case"string":this.writeString(e,n,r);break;case"u16string":this.writeUCS2String(e,this.endianness,r);break;case"u16stringle":this.writeUCS2String(e,DataStream.LITTLE_ENDIAN,r);break;case"u16stringbe":this.writeUCS2String(e,DataStream.BIG_ENDIAN,r);break;default:if(3==t.length){for(var s=t[1],l=0;l<e.length;l++)this.writeType(s,e[l]);break}this.writeStruct(t,e)}null!=r&&(this.position=a,this._realloc(r),this.position=a+r)},"function"==typeof define&&define.amd&&define("DataStream",[],function(){return DataStream}),"object"==typeof module&&module&&module.exports&&(module.exports=DataStream),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.glMatrix={})}(this,function(t){var e=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array,o=Math.random;var r=Math.PI/180;var n=Object.freeze({EPSILON:e,get ARRAY_TYPE(){return i},RANDOM:o,setMatrixArrayType:function(t){i=t},toRadian:function(t){return t*r},equals:function(t,i){return Math.abs(t-i)<=e*Math.max(1,Math.abs(t),Math.abs(i))}});function a(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=i[0],l=i[1],d=i[2],h=i[3];return t[0]=o*s+n*l,t[1]=r*s+a*l,t[2]=o*d+n*h,t[3]=r*d+a*h,t}function s(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}var l=a,d=s,h=Object.freeze({create:function(){var t=new i(4);return i!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new i(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},fromValues:function(t,e,o,r){var n=new i(4);return n[0]=t,n[1]=e,n[2]=o,n[3]=r,n},set:function(t,e,i,o,r){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t},transpose:function(t,e){if(t===e){var i=e[1];t[1]=e[2],t[2]=i}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=i*n-r*o;return a?(a=1/a,t[0]=n*a,t[1]=-o*a,t[2]=-r*a,t[3]=i*a,t):null},adjoint:function(t,e){var i=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=i,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:a,rotate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=o*l+n*s,t[1]=r*l+a*s,t[2]=o*-s+n*l,t[3]=r*-s+a*l,t},scale:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=i[0],l=i[1];return t[0]=o*s,t[1]=r*s,t[2]=n*l,t[3]=a*l,t},fromRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=o,t[1]=i,t[2]=-i,t[3]=o,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},LDU:function(t,e,i,o){return t[2]=o[2]/o[0],i[0]=o[0],i[1]=o[1],i[3]=o[3]-t[2]*i[1],[t,e,i]},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},subtract:s,exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=i[0],l=i[1],d=i[2],h=i[3];return Math.abs(o-s)<=e*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(r-l)<=e*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-d)<=e*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-h)<=e*Math.max(1,Math.abs(a),Math.abs(h))},multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},multiplyScalarAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t[3]=e[3]+i[3]*o,t},mul:l,sub:d});function c(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=i[0],h=i[1],c=i[2],u=i[3],f=i[4],g=i[5];return t[0]=o*d+n*h,t[1]=r*d+a*h,t[2]=o*c+n*u,t[3]=r*c+a*u,t[4]=o*f+n*g+s,t[5]=r*f+a*g+l,t}function u(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}var f=c,g=u,p=Object.freeze({create:function(){var t=new i(6);return i!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new i(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},fromValues:function(t,e,o,r,n,a){var s=new i(6);return s[0]=t,s[1]=e,s[2]=o,s[3]=r,s[4]=n,s[5]=a,s},set:function(t,e,i,o,r,n,a){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t[4]=n,t[5]=a,t},invert:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=i*n-o*r;return l?(l=1/l,t[0]=n*l,t[1]=-o*l,t[2]=-r*l,t[3]=i*l,t[4]=(r*s-n*a)*l,t[5]=(o*a-i*s)*l,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:c,rotate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=Math.sin(i),h=Math.cos(i);return t[0]=o*h+n*d,t[1]=r*h+a*d,t[2]=o*-d+n*h,t[3]=r*-d+a*h,t[4]=s,t[5]=l,t},scale:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=i[0],h=i[1];return t[0]=o*d,t[1]=r*d,t[2]=n*h,t[3]=a*h,t[4]=s,t[5]=l,t},translate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=i[0],h=i[1];return t[0]=o,t[1]=r,t[2]=n,t[3]=a,t[4]=o*d+n*h+s,t[5]=r*d+a*h+l,t},fromRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=o,t[1]=i,t[2]=-i,t[3]=o,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t},subtract:u,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t},multiplyScalarAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t[3]=e[3]+i[3]*o,t[4]=e[4]+i[4]*o,t[5]=e[5]+i[5]*o,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],d=i[0],h=i[1],c=i[2],u=i[3],f=i[4],g=i[5];return Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(r-h)<=e*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-c)<=e*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=e*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=e*Math.max(1,Math.abs(l),Math.abs(g))},mul:f,sub:g});function v(){var t=new i(9);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function y(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=e[8],u=i[0],f=i[1],g=i[2],p=i[3],v=i[4],y=i[5],m=i[6],x=i[7],b=i[8];return t[0]=u*o+f*a+g*d,t[1]=u*r+f*s+g*h,t[2]=u*n+f*l+g*c,t[3]=p*o+v*a+y*d,t[4]=p*r+v*s+y*h,t[5]=p*n+v*l+y*c,t[6]=m*o+x*a+b*d,t[7]=m*r+x*s+b*h,t[8]=m*n+x*l+b*c,t}function m(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t}var x=y,b=m,C=Object.freeze({create:v,fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new i(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromValues:function(t,e,o,r,n,a,s,l,d){var h=new i(9);return h[0]=t,h[1]=e,h[2]=o,h[3]=r,h[4]=n,h[5]=a,h[6]=s,h[7]=l,h[8]=d,h},set:function(t,e,i,o,r,n,a,s,l,d){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=d,t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var i=e[1],o=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=o,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=e[6],d=e[7],h=e[8],c=h*a-s*d,u=-h*n+s*l,f=d*n-a*l,g=i*c+o*u+r*f;return g?(g=1/g,t[0]=c*g,t[1]=(-h*o+r*d)*g,t[2]=(s*o-r*a)*g,t[3]=u*g,t[4]=(h*i-r*l)*g,t[5]=(-s*i+r*n)*g,t[6]=f*g,t[7]=(-d*i+o*l)*g,t[8]=(a*i-o*n)*g,t):null},adjoint:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=e[6],d=e[7],h=e[8];return t[0]=a*h-s*d,t[1]=r*d-o*h,t[2]=o*s-r*a,t[3]=s*l-n*h,t[4]=i*h-r*l,t[5]=r*n-i*s,t[6]=n*d-a*l,t[7]=o*l-i*d,t[8]=i*a-o*n,t},determinant:function(t){var e=t[0],i=t[1],o=t[2],r=t[3],n=t[4],a=t[5],s=t[6],l=t[7],d=t[8];return e*(d*n-a*l)+i*(-d*r+a*s)+o*(l*r-n*s)},multiply:y,translate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=e[8],u=i[0],f=i[1];return t[0]=o,t[1]=r,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=u*o+f*a+d,t[7]=u*r+f*s+h,t[8]=u*n+f*l+c,t},rotate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=e[8],u=Math.sin(i),f=Math.cos(i);return t[0]=f*o+u*a,t[1]=f*r+u*s,t[2]=f*n+u*l,t[3]=f*a-u*o,t[4]=f*s-u*r,t[5]=f*l-u*n,t[6]=d,t[7]=h,t[8]=c,t},scale:function(t,e,i){var o=i[0],r=i[1];return t[0]=o*e[0],t[1]=o*e[1],t[2]=o*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=o,t[1]=i,t[2]=0,t[3]=-i,t[4]=o,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromQuat:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=i+i,s=o+o,l=r+r,d=i*a,h=o*a,c=o*s,u=r*a,f=r*s,g=r*l,p=n*a,v=n*s,y=n*l;return t[0]=1-c-g,t[3]=h-y,t[6]=u+v,t[1]=h+y,t[4]=1-d-g,t[7]=f-p,t[2]=u-v,t[5]=f+p,t[8]=1-d-c,t},normalFromMat4:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=e[6],d=e[7],h=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15],m=i*s-o*a,x=i*l-r*a,b=i*d-n*a,C=o*l-r*s,A=o*d-n*s,M=r*d-n*l,P=h*p-c*g,T=h*v-u*g,_=h*y-f*g,w=c*v-u*p,S=c*y-f*p,R=u*y-f*v,L=m*R-x*S+b*w+C*_-A*T+M*P;return L?(L=1/L,t[0]=(s*R-l*S+d*w)*L,t[1]=(l*_-a*R-d*T)*L,t[2]=(a*S-s*_+d*P)*L,t[3]=(r*S-o*R-n*w)*L,t[4]=(i*R-r*_+n*T)*L,t[5]=(o*_-i*S-n*P)*L,t[6]=(p*M-v*A+y*C)*L,t[7]=(v*b-g*M-y*x)*L,t[8]=(g*A-p*b+y*m)*L,t):null},projection:function(t,e,i){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/i,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t},subtract:m,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t},multiplyScalarAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t[3]=e[3]+i[3]*o,t[4]=e[4]+i[4]*o,t[5]=e[5]+i[5]*o,t[6]=e[6]+i[6]*o,t[7]=e[7]+i[7]*o,t[8]=e[8]+i[8]*o,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],d=t[6],h=t[7],c=t[8],u=i[0],f=i[1],g=i[2],p=i[3],v=i[4],y=i[5],m=i[6],x=i[7],b=i[8];return Math.abs(o-u)<=e*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(r-f)<=e*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(n-g)<=e*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-v)<=e*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(l-y)<=e*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(d-m)<=e*Math.max(1,Math.abs(d),Math.abs(m))&&Math.abs(h-x)<=e*Math.max(1,Math.abs(h),Math.abs(x))&&Math.abs(c-b)<=e*Math.max(1,Math.abs(c),Math.abs(b))},mul:x,sub:b});function A(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function M(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11],p=e[12],v=e[13],y=e[14],m=e[15],x=i[0],b=i[1],C=i[2],A=i[3];return t[0]=x*o+b*s+C*c+A*p,t[1]=x*r+b*l+C*u+A*v,t[2]=x*n+b*d+C*f+A*y,t[3]=x*a+b*h+C*g+A*m,x=i[4],b=i[5],C=i[6],A=i[7],t[4]=x*o+b*s+C*c+A*p,t[5]=x*r+b*l+C*u+A*v,t[6]=x*n+b*d+C*f+A*y,t[7]=x*a+b*h+C*g+A*m,x=i[8],b=i[9],C=i[10],A=i[11],t[8]=x*o+b*s+C*c+A*p,t[9]=x*r+b*l+C*u+A*v,t[10]=x*n+b*d+C*f+A*y,t[11]=x*a+b*h+C*g+A*m,x=i[12],b=i[13],C=i[14],A=i[15],t[12]=x*o+b*s+C*c+A*p,t[13]=x*r+b*l+C*u+A*v,t[14]=x*n+b*d+C*f+A*y,t[15]=x*a+b*h+C*g+A*m,t}function P(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=o+o,l=r+r,d=n+n,h=o*s,c=o*l,u=o*d,f=r*l,g=r*d,p=n*d,v=a*s,y=a*l,m=a*d;return t[0]=1-(f+p),t[1]=c+m,t[2]=u-y,t[3]=0,t[4]=c-m,t[5]=1-(h+p),t[6]=g+v,t[7]=0,t[8]=u+y,t[9]=g-v,t[10]=1-(h+f),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function T(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function _(t,e){var i=e[0]+e[5]+e[10],o=0;return i>0?(o=2*Math.sqrt(i+1),t[3]=.25*o,t[0]=(e[6]-e[9])/o,t[1]=(e[8]-e[2])/o,t[2]=(e[1]-e[4])/o):e[0]>e[5]&&e[0]>e[10]?(o=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/o,t[0]=.25*o,t[1]=(e[1]+e[4])/o,t[2]=(e[8]+e[2])/o):e[5]>e[10]?(o=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/o,t[0]=(e[1]+e[4])/o,t[1]=.25*o,t[2]=(e[6]+e[9])/o):(o=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/o,t[0]=(e[8]+e[2])/o,t[1]=(e[6]+e[9])/o,t[2]=.25*o),t}function w(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}var S=M,R=w,L=Object.freeze({create:function(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new i(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fromValues:function(t,e,o,r,n,a,s,l,d,h,c,u,f,g,p,v){var y=new i(16);return y[0]=t,y[1]=e,y[2]=o,y[3]=r,y[4]=n,y[5]=a,y[6]=s,y[7]=l,y[8]=d,y[9]=h,y[10]=c,y[11]=u,y[12]=f,y[13]=g,y[14]=p,y[15]=v,y},set:function(t,e,i,o,r,n,a,s,l,d,h,c,u,f,g,p,v){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=d,t[9]=h,t[10]=c,t[11]=u,t[12]=f,t[13]=g,t[14]=p,t[15]=v,t},identity:A,transpose:function(t,e){if(t===e){var i=e[1],o=e[2],r=e[3],n=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=o,t[9]=n,t[11]=e[14],t[12]=r,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=e[6],d=e[7],h=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15],m=i*s-o*a,x=i*l-r*a,b=i*d-n*a,C=o*l-r*s,A=o*d-n*s,M=r*d-n*l,P=h*p-c*g,T=h*v-u*g,_=h*y-f*g,w=c*v-u*p,S=c*y-f*p,R=u*y-f*v,L=m*R-x*S+b*w+C*_-A*T+M*P;return L?(L=1/L,t[0]=(s*R-l*S+d*w)*L,t[1]=(r*S-o*R-n*w)*L,t[2]=(p*M-v*A+y*C)*L,t[3]=(u*A-c*M-f*C)*L,t[4]=(l*_-a*R-d*T)*L,t[5]=(i*R-r*_+n*T)*L,t[6]=(v*b-g*M-y*x)*L,t[7]=(h*M-u*b+f*x)*L,t[8]=(a*S-s*_+d*P)*L,t[9]=(o*_-i*S-n*P)*L,t[10]=(g*A-p*b+y*m)*L,t[11]=(c*b-h*A-f*m)*L,t[12]=(s*T-a*w-l*P)*L,t[13]=(i*w-o*T+r*P)*L,t[14]=(p*x-g*C-v*m)*L,t[15]=(h*C-c*x+u*m)*L,t):null},adjoint:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=e[4],s=e[5],l=e[6],d=e[7],h=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15];return t[0]=s*(u*y-f*v)-c*(l*y-d*v)+p*(l*f-d*u),t[1]=-(o*(u*y-f*v)-c*(r*y-n*v)+p*(r*f-n*u)),t[2]=o*(l*y-d*v)-s*(r*y-n*v)+p*(r*d-n*l),t[3]=-(o*(l*f-d*u)-s*(r*f-n*u)+c*(r*d-n*l)),t[4]=-(a*(u*y-f*v)-h*(l*y-d*v)+g*(l*f-d*u)),t[5]=i*(u*y-f*v)-h*(r*y-n*v)+g*(r*f-n*u),t[6]=-(i*(l*y-d*v)-a*(r*y-n*v)+g*(r*d-n*l)),t[7]=i*(l*f-d*u)-a*(r*f-n*u)+h*(r*d-n*l),t[8]=a*(c*y-f*p)-h*(s*y-d*p)+g*(s*f-d*c),t[9]=-(i*(c*y-f*p)-h*(o*y-n*p)+g*(o*f-n*c)),t[10]=i*(s*y-d*p)-a*(o*y-n*p)+g*(o*d-n*s),t[11]=-(i*(s*f-d*c)-a*(o*f-n*c)+h*(o*d-n*s)),t[12]=-(a*(c*v-u*p)-h*(s*v-l*p)+g*(s*u-l*c)),t[13]=i*(c*v-u*p)-h*(o*v-r*p)+g*(o*u-r*c),t[14]=-(i*(s*v-l*p)-a*(o*v-r*p)+g*(o*l-r*s)),t[15]=i*(s*u-l*c)-a*(o*u-r*c)+h*(o*l-r*s),t},determinant:function(t){var e=t[0],i=t[1],o=t[2],r=t[3],n=t[4],a=t[5],s=t[6],l=t[7],d=t[8],h=t[9],c=t[10],u=t[11],f=t[12],g=t[13],p=t[14],v=t[15];return(e*a-i*n)*(c*v-u*p)-(e*s-o*n)*(h*v-u*g)+(e*l-r*n)*(h*p-c*g)+(i*s-o*a)*(d*v-u*f)-(i*l-r*a)*(d*p-c*f)+(o*l-r*s)*(d*g-h*f)},multiply:M,translate:function(t,e,i){var o,r,n,a,s,l,d,h,c,u,f,g,p=i[0],v=i[1],y=i[2];return e===t?(t[12]=e[0]*p+e[4]*v+e[8]*y+e[12],t[13]=e[1]*p+e[5]*v+e[9]*y+e[13],t[14]=e[2]*p+e[6]*v+e[10]*y+e[14],t[15]=e[3]*p+e[7]*v+e[11]*y+e[15]):(o=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11],t[0]=o,t[1]=r,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=d,t[7]=h,t[8]=c,t[9]=u,t[10]=f,t[11]=g,t[12]=o*p+s*v+c*y+e[12],t[13]=r*p+l*v+u*y+e[13],t[14]=n*p+d*v+f*y+e[14],t[15]=a*p+h*v+g*y+e[15]),t},scale:function(t,e,i){var o=i[0],r=i[1],n=i[2];return t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t[3]=e[3]*o,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,i,o,r){var n,a,s,l,d,h,c,u,f,g,p,v,y,m,x,b,C,A,M,P,T,_,w,S,R=r[0],L=r[1],D=r[2],I=Math.sqrt(R*R+L*L+D*D);return I<e?null:(R*=I=1/I,L*=I,D*=I,n=Math.sin(o),s=1-(a=Math.cos(o)),l=i[0],d=i[1],h=i[2],c=i[3],u=i[4],f=i[5],g=i[6],p=i[7],v=i[8],y=i[9],m=i[10],x=i[11],b=R*R*s+a,C=L*R*s+D*n,A=D*R*s-L*n,M=R*L*s-D*n,P=L*L*s+a,T=D*L*s+R*n,_=R*D*s+L*n,w=L*D*s-R*n,S=D*D*s+a,t[0]=l*b+u*C+v*A,t[1]=d*b+f*C+y*A,t[2]=h*b+g*C+m*A,t[3]=c*b+p*C+x*A,t[4]=l*M+u*P+v*T,t[5]=d*M+f*P+y*T,t[6]=h*M+g*P+m*T,t[7]=c*M+p*P+x*T,t[8]=l*_+u*w+v*S,t[9]=d*_+f*w+y*S,t[10]=h*_+g*w+m*S,t[11]=c*_+p*w+x*S,i!==t&&(t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t)},rotateX:function(t,e,i){var o=Math.sin(i),r=Math.cos(i),n=e[4],a=e[5],s=e[6],l=e[7],d=e[8],h=e[9],c=e[10],u=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+d*o,t[5]=a*r+h*o,t[6]=s*r+c*o,t[7]=l*r+u*o,t[8]=d*r-n*o,t[9]=h*r-a*o,t[10]=c*r-s*o,t[11]=u*r-l*o,t},rotateY:function(t,e,i){var o=Math.sin(i),r=Math.cos(i),n=e[0],a=e[1],s=e[2],l=e[3],d=e[8],h=e[9],c=e[10],u=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r-d*o,t[1]=a*r-h*o,t[2]=s*r-c*o,t[3]=l*r-u*o,t[8]=n*o+d*r,t[9]=a*o+h*r,t[10]=s*o+c*r,t[11]=l*o+u*r,t},rotateZ:function(t,e,i){var o=Math.sin(i),r=Math.cos(i),n=e[0],a=e[1],s=e[2],l=e[3],d=e[4],h=e[5],c=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+d*o,t[1]=a*r+h*o,t[2]=s*r+c*o,t[3]=l*r+u*o,t[4]=d*r-n*o,t[5]=h*r-a*o,t[6]=c*r-s*o,t[7]=u*r-l*o,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,i,o){var r,n,a,s=o[0],l=o[1],d=o[2],h=Math.sqrt(s*s+l*l+d*d);return h<e?null:(s*=h=1/h,l*=h,d*=h,r=Math.sin(i),a=1-(n=Math.cos(i)),t[0]=s*s*a+n,t[1]=l*s*a+d*r,t[2]=d*s*a-l*r,t[3]=0,t[4]=s*l*a-d*r,t[5]=l*l*a+n,t[6]=d*l*a+s*r,t[7]=0,t[8]=s*d*a+l*r,t[9]=l*d*a-s*r,t[10]=d*d*a+n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=o,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var i=Math.sin(e),o=Math.cos(e);return t[0]=o,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:P,fromQuat2:function(t,e){var o=new i(3),r=-e[0],n=-e[1],a=-e[2],s=e[3],l=e[4],d=e[5],h=e[6],c=e[7],u=r*r+n*n+a*a+s*s;return u>0?(o[0]=2*(l*s+c*r+d*a-h*n)/u,o[1]=2*(d*s+c*n+h*r-l*a)/u,o[2]=2*(h*s+c*a+l*n-d*r)/u):(o[0]=2*(l*s+c*r+d*a-h*n),o[1]=2*(d*s+c*n+h*r-l*a),o[2]=2*(h*s+c*a+l*n-d*r)),P(t,e,o),t},getTranslation:T,getScaling:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[4],a=e[5],s=e[6],l=e[8],d=e[9],h=e[10];return t[0]=Math.sqrt(i*i+o*o+r*r),t[1]=Math.sqrt(n*n+a*a+s*s),t[2]=Math.sqrt(l*l+d*d+h*h),t},getRotation:_,fromRotationTranslationScale:function(t,e,i,o){var r=e[0],n=e[1],a=e[2],s=e[3],l=r+r,d=n+n,h=a+a,c=r*l,u=r*d,f=r*h,g=n*d,p=n*h,v=a*h,y=s*l,m=s*d,x=s*h,b=o[0],C=o[1],A=o[2];return t[0]=(1-(g+v))*b,t[1]=(u+x)*b,t[2]=(f-m)*b,t[3]=0,t[4]=(u-x)*C,t[5]=(1-(c+v))*C,t[6]=(p+y)*C,t[7]=0,t[8]=(f+m)*A,t[9]=(p-y)*A,t[10]=(1-(c+g))*A,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t},fromRotationTranslationScaleOrigin:function(t,e,i,o,r){var n=e[0],a=e[1],s=e[2],l=e[3],d=n+n,h=a+a,c=s+s,u=n*d,f=n*h,g=n*c,p=a*h,v=a*c,y=s*c,m=l*d,x=l*h,b=l*c,C=o[0],A=o[1],M=o[2],P=r[0],T=r[1],_=r[2],w=(1-(p+y))*C,S=(f+b)*C,R=(g-x)*C,L=(f-b)*A,D=(1-(u+y))*A,I=(v+m)*A,E=(g+x)*M,O=(v-m)*M,F=(1-(u+p))*M;return t[0]=w,t[1]=S,t[2]=R,t[3]=0,t[4]=L,t[5]=D,t[6]=I,t[7]=0,t[8]=E,t[9]=O,t[10]=F,t[11]=0,t[12]=i[0]+P-(w*P+L*T+E*_),t[13]=i[1]+T-(S*P+D*T+O*_),t[14]=i[2]+_-(R*P+I*T+F*_),t[15]=1,t},fromQuat:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=i+i,s=o+o,l=r+r,d=i*a,h=o*a,c=o*s,u=r*a,f=r*s,g=r*l,p=n*a,v=n*s,y=n*l;return t[0]=1-c-g,t[1]=h+y,t[2]=u-v,t[3]=0,t[4]=h-y,t[5]=1-d-g,t[6]=f+p,t[7]=0,t[8]=u+v,t[9]=f-p,t[10]=1-d-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,i,o,r,n,a){var s=1/(i-e),l=1/(r-o),d=1/(n-a);return t[0]=2*n*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(i+e)*s,t[9]=(r+o)*l,t[10]=(a+n)*d,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n*2*d,t[15]=0,t},perspective:function(t,e,i,o,r){var n,a=1/Math.tan(e/2);return t[0]=a/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(n=1/(o-r),t[10]=(r+o)*n,t[14]=2*r*o*n):(t[10]=-1,t[14]=-2*o),t},perspectiveFromFieldOfView:function(t,e,i,o){var r=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),l=2/(a+s),d=2/(r+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=d,t[6]=0,t[7]=0,t[8]=-(a-s)*l*.5,t[9]=(r-n)*d*.5,t[10]=o/(i-o),t[11]=-1,t[12]=0,t[13]=0,t[14]=o*i/(i-o),t[15]=0,t},ortho:function(t,e,i,o,r,n,a){var s=1/(e-i),l=1/(o-r),d=1/(n-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*d,t[11]=0,t[12]=(e+i)*s,t[13]=(r+o)*l,t[14]=(a+n)*d,t[15]=1,t},lookAt:function(t,i,o,r){var n,a,s,l,d,h,c,u,f,g,p=i[0],v=i[1],y=i[2],m=r[0],x=r[1],b=r[2],C=o[0],M=o[1],P=o[2];return Math.abs(p-C)<e&&Math.abs(v-M)<e&&Math.abs(y-P)<e?A(t):(c=p-C,u=v-M,f=y-P,n=x*(f*=g=1/Math.sqrt(c*c+u*u+f*f))-b*(u*=g),a=b*(c*=g)-m*f,s=m*u-x*c,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0),l=u*s-f*a,d=f*n-c*s,h=c*a-u*n,(g=Math.sqrt(l*l+d*d+h*h))?(l*=g=1/g,d*=g,h*=g):(l=0,d=0,h=0),t[0]=n,t[1]=l,t[2]=c,t[3]=0,t[4]=a,t[5]=d,t[6]=u,t[7]=0,t[8]=s,t[9]=h,t[10]=f,t[11]=0,t[12]=-(n*p+a*v+s*y),t[13]=-(l*p+d*v+h*y),t[14]=-(c*p+u*v+f*y),t[15]=1,t)},targetTo:function(t,e,i,o){var r=e[0],n=e[1],a=e[2],s=o[0],l=o[1],d=o[2],h=r-i[0],c=n-i[1],u=a-i[2],f=h*h+c*c+u*u;f>0&&(h*=f=1/Math.sqrt(f),c*=f,u*=f);var g=l*u-d*c,p=d*h-s*u,v=s*c-l*h;return(f=g*g+p*p+v*v)>0&&(g*=f=1/Math.sqrt(f),p*=f,v*=f),t[0]=g,t[1]=p,t[2]=v,t[3]=0,t[4]=c*v-u*p,t[5]=u*g-h*v,t[6]=h*p-c*g,t[7]=0,t[8]=h,t[9]=c,t[10]=u,t[11]=0,t[12]=r,t[13]=n,t[14]=a,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t},subtract:w,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12]*i,t[13]=e[13]*i,t[14]=e[14]*i,t[15]=e[15]*i,t},multiplyScalarAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t[3]=e[3]+i[3]*o,t[4]=e[4]+i[4]*o,t[5]=e[5]+i[5]*o,t[6]=e[6]+i[6]*o,t[7]=e[7]+i[7]*o,t[8]=e[8]+i[8]*o,t[9]=e[9]+i[9]*o,t[10]=e[10]+i[10]*o,t[11]=e[11]+i[11]*o,t[12]=e[12]+i[12]*o,t[13]=e[13]+i[13]*o,t[14]=e[14]+i[14]*o,t[15]=e[15]+i[15]*o,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],d=t[6],h=t[7],c=t[8],u=t[9],f=t[10],g=t[11],p=t[12],v=t[13],y=t[14],m=t[15],x=i[0],b=i[1],C=i[2],A=i[3],M=i[4],P=i[5],T=i[6],_=i[7],w=i[8],S=i[9],R=i[10],L=i[11],D=i[12],I=i[13],E=i[14],O=i[15];return Math.abs(o-x)<=e*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(r-b)<=e*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-C)<=e*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(a-A)<=e*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(s-M)<=e*Math.max(1,Math.abs(s),Math.abs(M))&&Math.abs(l-P)<=e*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(d-T)<=e*Math.max(1,Math.abs(d),Math.abs(T))&&Math.abs(h-_)<=e*Math.max(1,Math.abs(h),Math.abs(_))&&Math.abs(c-w)<=e*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(u-S)<=e*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(f-R)<=e*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(g-L)<=e*Math.max(1,Math.abs(g),Math.abs(L))&&Math.abs(p-D)<=e*Math.max(1,Math.abs(p),Math.abs(D))&&Math.abs(v-I)<=e*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(y-E)<=e*Math.max(1,Math.abs(y),Math.abs(E))&&Math.abs(m-O)<=e*Math.max(1,Math.abs(m),Math.abs(O))},mul:S,sub:R});function D(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function I(t){var e=t[0],i=t[1],o=t[2];return Math.sqrt(e*e+i*i+o*o)}function E(t,e,o){var r=new i(3);return r[0]=t,r[1]=e,r[2]=o,r}function O(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function F(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function N(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t}function V(t,e){var i=e[0]-t[0],o=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(i*i+o*o+r*r)}function B(t,e){var i=e[0]-t[0],o=e[1]-t[1],r=e[2]-t[2];return i*i+o*o+r*r}function j(t){var e=t[0],i=t[1],o=t[2];return e*e+i*i+o*o}function U(t,e){var i=e[0],o=e[1],r=e[2],n=i*i+o*o+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function G(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function k(t,e,i){var o=e[0],r=e[1],n=e[2],a=i[0],s=i[1],l=i[2];return t[0]=r*l-n*s,t[1]=n*a-o*l,t[2]=o*s-r*a,t}var z,H=O,W=F,X=N,K=V,Y=B,q=I,Z=j,Q=(z=D(),function(t,e,i,o,r,n){var a,s;for(e||(e=3),i||(i=0),s=o?Math.min(o*e+i,t.length):t.length,a=i;a<s;a+=e)z[0]=t[a],z[1]=t[a+1],z[2]=t[a+2],r(z,z,n),t[a]=z[0],t[a+1]=z[1],t[a+2]=z[2];return t}),J=Object.freeze({create:D,clone:function(t){var e=new i(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:I,fromValues:E,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,i,o){return t[0]=e,t[1]=i,t[2]=o,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t},subtract:O,multiply:F,divide:N,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t},scaleAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t},distance:V,squaredDistance:B,squaredLength:j,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:U,dot:G,cross:k,lerp:function(t,e,i,o){var r=e[0],n=e[1],a=e[2];return t[0]=r+o*(i[0]-r),t[1]=n+o*(i[1]-n),t[2]=a+o*(i[2]-a),t},hermite:function(t,e,i,o,r,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,d=a*(n-1),h=a*(3-2*n);return t[0]=e[0]*s+i[0]*l+o[0]*d+r[0]*h,t[1]=e[1]*s+i[1]*l+o[1]*d+r[1]*h,t[2]=e[2]*s+i[2]*l+o[2]*d+r[2]*h,t},bezier:function(t,e,i,o,r,n){var a=1-n,s=a*a,l=n*n,d=s*a,h=3*n*s,c=3*l*a,u=l*n;return t[0]=e[0]*d+i[0]*h+o[0]*c+r[0]*u,t[1]=e[1]*d+i[1]*h+o[1]*c+r[1]*u,t[2]=e[2]*d+i[2]*h+o[2]*c+r[2]*u,t},random:function(t,e){e=e||1;var i=2*o()*Math.PI,r=2*o()-1,n=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(i)*n,t[1]=Math.sin(i)*n,t[2]=r*e,t},transformMat4:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=i[3]*o+i[7]*r+i[11]*n+i[15];return a=a||1,t[0]=(i[0]*o+i[4]*r+i[8]*n+i[12])/a,t[1]=(i[1]*o+i[5]*r+i[9]*n+i[13])/a,t[2]=(i[2]*o+i[6]*r+i[10]*n+i[14])/a,t},transformMat3:function(t,e,i){var o=e[0],r=e[1],n=e[2];return t[0]=o*i[0]+r*i[3]+n*i[6],t[1]=o*i[1]+r*i[4]+n*i[7],t[2]=o*i[2]+r*i[5]+n*i[8],t},transformQuat:function(t,e,i){var o=i[0],r=i[1],n=i[2],a=i[3],s=e[0],l=e[1],d=e[2],h=r*d-n*l,c=n*s-o*d,u=o*l-r*s,f=r*u-n*c,g=n*h-o*u,p=o*c-r*h,v=2*a;return h*=v,c*=v,u*=v,f*=2,g*=2,p*=2,t[0]=s+h+f,t[1]=l+c+g,t[2]=d+u+p,t},rotateX:function(t,e,i,o){var r=[],n=[];return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],n[0]=r[0],n[1]=r[1]*Math.cos(o)-r[2]*Math.sin(o),n[2]=r[1]*Math.sin(o)+r[2]*Math.cos(o),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},rotateY:function(t,e,i,o){var r=[],n=[];return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],n[0]=r[2]*Math.sin(o)+r[0]*Math.cos(o),n[1]=r[1],n[2]=r[2]*Math.cos(o)-r[0]*Math.sin(o),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},rotateZ:function(t,e,i,o){var r=[],n=[];return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],n[0]=r[0]*Math.cos(o)-r[1]*Math.sin(o),n[1]=r[0]*Math.sin(o)+r[1]*Math.cos(o),n[2]=r[2],t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},angle:function(t,e){var i=E(t[0],t[1],t[2]),o=E(e[0],e[1],e[2]);U(i,i),U(o,o);var r=G(i,o);return r>1?0:r<-1?Math.PI:Math.acos(r)},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=i[0],s=i[1],l=i[2];return Math.abs(o-a)<=e*Math.max(1,Math.abs(o),Math.abs(a))&&Math.abs(r-s)<=e*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))},sub:H,mul:W,div:X,dist:K,sqrDist:Y,len:q,sqrLen:Z,forEach:Q});function $(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function tt(t){var e=new i(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function et(t,e,o,r){var n=new i(4);return n[0]=t,n[1]=e,n[2]=o,n[3]=r,n}function it(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function ot(t,e,i,o,r){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t}function rt(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t}function nt(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}function at(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}function st(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t[3]=e[3]/i[3],t}function lt(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function dt(t,e){var i=e[0]-t[0],o=e[1]-t[1],r=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(i*i+o*o+r*r+n*n)}function ht(t,e){var i=e[0]-t[0],o=e[1]-t[1],r=e[2]-t[2],n=e[3]-t[3];return i*i+o*o+r*r+n*n}function ct(t){var e=t[0],i=t[1],o=t[2],r=t[3];return Math.sqrt(e*e+i*i+o*o+r*r)}function ut(t){var e=t[0],i=t[1],o=t[2],r=t[3];return e*e+i*i+o*o+r*r}function ft(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=i*i+o*o+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=i*a,t[1]=o*a,t[2]=r*a,t[3]=n*a,t}function gt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function pt(t,e,i,o){var r=e[0],n=e[1],a=e[2],s=e[3];return t[0]=r+o*(i[0]-r),t[1]=n+o*(i[1]-n),t[2]=a+o*(i[2]-a),t[3]=s+o*(i[3]-s),t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function yt(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=i[0],l=i[1],d=i[2],h=i[3];return Math.abs(o-s)<=e*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(r-l)<=e*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-d)<=e*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-h)<=e*Math.max(1,Math.abs(a),Math.abs(h))}var mt=nt,xt=at,bt=st,Ct=dt,At=ht,Mt=ct,Pt=ut,Tt=function(){var t=$();return function(e,i,o,r,n,a){var s,l;for(i||(i=4),o||(o=0),l=r?Math.min(r*i+o,e.length):e.length,s=o;s<l;s+=i)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],n(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),_t=Object.freeze({create:$,clone:tt,fromValues:et,copy:it,set:ot,add:rt,subtract:nt,multiply:at,divide:st,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:lt,scaleAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t[2]=e[2]+i[2]*o,t[3]=e[3]+i[3]*o,t},distance:dt,squaredDistance:ht,length:ct,squaredLength:ut,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:ft,dot:gt,cross:function(t,e,i,o){var r=i[0]*o[1]-i[1]*o[0],n=i[0]*o[2]-i[2]*o[0],a=i[0]*o[3]-i[3]*o[0],s=i[1]*o[2]-i[2]*o[1],l=i[1]*o[3]-i[3]*o[1],d=i[2]*o[3]-i[3]*o[2],h=e[0],c=e[1],u=e[2],f=e[3];return t[0]=c*d-u*l+f*s,t[1]=-h*d+u*a-f*n,t[2]=h*l-c*a+f*r,t[3]=-h*s+c*n-u*r,t},lerp:pt,random:function(t,e){var i,r,n,a,s,l;e=e||1;do{s=(i=2*o()-1)*i+(r=2*o()-1)*r}while(s>=1);do{l=(n=2*o()-1)*n+(a=2*o()-1)*a}while(l>=1);var d=Math.sqrt((1-s)/l);return t[0]=e*i,t[1]=e*r,t[2]=e*n*d,t[3]=e*a*d,t},transformMat4:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3];return t[0]=i[0]*o+i[4]*r+i[8]*n+i[12]*a,t[1]=i[1]*o+i[5]*r+i[9]*n+i[13]*a,t[2]=i[2]*o+i[6]*r+i[10]*n+i[14]*a,t[3]=i[3]*o+i[7]*r+i[11]*n+i[15]*a,t},transformQuat:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=i[0],s=i[1],l=i[2],d=i[3],h=d*o+s*n-l*r,c=d*r+l*o-a*n,u=d*n+a*r-s*o,f=-a*o-s*r-l*n;return t[0]=h*d+f*-a+c*-l-u*-s,t[1]=c*d+f*-s+u*-a-h*-l,t[2]=u*d+f*-l+h*-s-c*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:vt,equals:yt,sub:mt,mul:xt,div:bt,dist:Ct,sqrDist:At,len:Mt,sqrLen:Pt,forEach:Tt});function wt(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function St(t,e,i){i*=.5;var o=Math.sin(i);return t[0]=o*e[0],t[1]=o*e[1],t[2]=o*e[2],t[3]=Math.cos(i),t}function Rt(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=i[0],l=i[1],d=i[2],h=i[3];return t[0]=o*h+a*s+r*d-n*l,t[1]=r*h+a*l+n*s-o*d,t[2]=n*h+a*d+o*l-r*s,t[3]=a*h-o*s-r*l-n*d,t}function Lt(t,e,i){i*=.5;var o=e[0],r=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=o*l+a*s,t[1]=r*l+n*s,t[2]=n*l-r*s,t[3]=a*l-o*s,t}function Dt(t,e,i){i*=.5;var o=e[0],r=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=o*l-n*s,t[1]=r*l+a*s,t[2]=n*l+o*s,t[3]=a*l-r*s,t}function It(t,e,i){i*=.5;var o=e[0],r=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=o*l+r*s,t[1]=r*l-o*s,t[2]=n*l+a*s,t[3]=a*l-n*s,t}function Et(t,i,o,r){var n,a,s,l,d,h=i[0],c=i[1],u=i[2],f=i[3],g=o[0],p=o[1],v=o[2],y=o[3];return(a=h*g+c*p+u*v+f*y)<0&&(a=-a,g=-g,p=-p,v=-v,y=-y),1-a>e?(n=Math.acos(a),s=Math.sin(n),l=Math.sin((1-r)*n)/s,d=Math.sin(r*n)/s):(l=1-r,d=r),t[0]=l*h+d*g,t[1]=l*c+d*p,t[2]=l*u+d*v,t[3]=l*f+d*y,t}function Ot(t,e){var i,o=e[0]+e[4]+e[8];if(o>0)i=Math.sqrt(o+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var n=(r+1)%3,a=(r+2)%3;i=Math.sqrt(e[3*r+r]-e[3*n+n]-e[3*a+a]+1),t[r]=.5*i,i=.5/i,t[3]=(e[3*n+a]-e[3*a+n])*i,t[n]=(e[3*n+r]+e[3*r+n])*i,t[a]=(e[3*a+r]+e[3*r+a])*i}return t}var Ft,Nt,Vt,Bt,jt,Ut,Gt=tt,kt=et,zt=it,Ht=ot,Wt=rt,Xt=Rt,Kt=lt,Yt=gt,qt=pt,Zt=ct,Qt=Zt,Jt=ut,$t=Jt,te=ft,ee=vt,ie=yt,oe=(Ft=D(),Nt=E(1,0,0),Vt=E(0,1,0),function(t,e,i){var o=G(e,i);return o<-.999999?(k(Ft,Nt,e),q(Ft)<1e-6&&k(Ft,Vt,e),U(Ft,Ft),St(t,Ft,Math.PI),t):o>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(k(Ft,e,i),t[0]=Ft[0],t[1]=Ft[1],t[2]=Ft[2],t[3]=1+o,te(t,t))}),re=(Bt=wt(),jt=wt(),function(t,e,i,o,r,n){return Et(Bt,e,r,n),Et(jt,i,o,n),Et(t,Bt,jt,2*n*(1-n)),t}),ne=(Ut=v(),function(t,e,i,o){return Ut[0]=i[0],Ut[3]=i[1],Ut[6]=i[2],Ut[1]=o[0],Ut[4]=o[1],Ut[7]=o[2],Ut[2]=-e[0],Ut[5]=-e[1],Ut[8]=-e[2],te(t,Ot(t,Ut))}),ae=Object.freeze({create:wt,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},setAxisAngle:St,getAxisAngle:function(t,i){var o=2*Math.acos(i[3]),r=Math.sin(o/2);return r>e?(t[0]=i[0]/r,t[1]=i[1]/r,t[2]=i[2]/r):(t[0]=1,t[1]=0,t[2]=0),o},multiply:Rt,rotateX:Lt,rotateY:Dt,rotateZ:It,calculateW:function(t,e){var i=e[0],o=e[1],r=e[2];return t[0]=i,t[1]=o,t[2]=r,t[3]=Math.sqrt(Math.abs(1-i*i-o*o-r*r)),t},slerp:Et,random:function(t){var e=o(),i=o(),r=o(),n=Math.sqrt(1-e),a=Math.sqrt(e);return t[0]=n*Math.sin(2*Math.PI*i),t[1]=n*Math.cos(2*Math.PI*i),t[2]=a*Math.sin(2*Math.PI*r),t[3]=a*Math.cos(2*Math.PI*r),t},invert:function(t,e){var i=e[0],o=e[1],r=e[2],n=e[3],a=i*i+o*o+r*r+n*n,s=a?1/a:0;return t[0]=-i*s,t[1]=-o*s,t[2]=-r*s,t[3]=n*s,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fromMat3:Ot,fromEuler:function(t,e,i,o){var r=.5*Math.PI/180;e*=r,i*=r,o*=r;var n=Math.sin(e),a=Math.cos(e),s=Math.sin(i),l=Math.cos(i),d=Math.sin(o),h=Math.cos(o);return t[0]=n*l*h-a*s*d,t[1]=a*s*h+n*l*d,t[2]=a*l*d-n*s*h,t[3]=a*l*h+n*s*d,t},str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},clone:Gt,fromValues:kt,copy:zt,set:Ht,add:Wt,mul:Xt,scale:Kt,dot:Yt,lerp:qt,length:Zt,len:Qt,squaredLength:Jt,sqrLen:$t,normalize:te,exactEquals:ee,equals:ie,rotationTo:oe,sqlerp:re,setAxes:ne});function se(t,e,i){var o=.5*i[0],r=.5*i[1],n=.5*i[2],a=e[0],s=e[1],l=e[2],d=e[3];return t[0]=a,t[1]=s,t[2]=l,t[3]=d,t[4]=o*d+r*l-n*s,t[5]=r*d+n*a-o*l,t[6]=n*d+o*s-r*a,t[7]=-o*a-r*s-n*l,t}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var de=zt;var he=zt;function ce(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=i[4],l=i[5],d=i[6],h=i[7],c=e[4],u=e[5],f=e[6],g=e[7],p=i[0],v=i[1],y=i[2],m=i[3];return t[0]=o*m+a*p+r*y-n*v,t[1]=r*m+a*v+n*p-o*y,t[2]=n*m+a*y+o*v-r*p,t[3]=a*m-o*p-r*v-n*y,t[4]=o*h+a*s+r*d-n*l+c*m+g*p+u*y-f*v,t[5]=r*h+a*l+n*s-o*d+u*m+g*v+f*p-c*y,t[6]=n*h+a*d+o*l-r*s+f*m+g*y+c*v-u*p,t[7]=a*h-o*s-r*l-n*d+g*m-c*p-u*v-f*y,t}var ue=ce;var fe=Yt;var ge=Zt,pe=ge,ve=Jt,ye=ve;var me=Object.freeze({create:function(){var t=new i(8);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},clone:function(t){var e=new i(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},fromValues:function(t,e,o,r,n,a,s,l){var d=new i(8);return d[0]=t,d[1]=e,d[2]=o,d[3]=r,d[4]=n,d[5]=a,d[6]=s,d[7]=l,d},fromRotationTranslationValues:function(t,e,o,r,n,a,s){var l=new i(8);l[0]=t,l[1]=e,l[2]=o,l[3]=r;var d=.5*n,h=.5*a,c=.5*s;return l[4]=d*r+h*o-c*e,l[5]=h*r+c*t-d*o,l[6]=c*r+d*e-h*t,l[7]=-d*t-h*e-c*o,l},fromRotationTranslation:se,fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromMat4:function(t,e){var o=wt();_(o,e);var r=new i(3);return T(r,e),se(t,o,r),t},copy:le,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},set:function(t,e,i,o,r,n,a,s,l){return t[0]=e,t[1]=i,t[2]=o,t[3]=r,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t},getReal:de,getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},setReal:he,setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},getTranslation:function(t,e){var i=e[4],o=e[5],r=e[6],n=e[7],a=-e[0],s=-e[1],l=-e[2],d=e[3];return t[0]=2*(i*d+n*a+o*l-r*s),t[1]=2*(o*d+n*s+r*a-i*l),t[2]=2*(r*d+n*l+i*s-o*a),t},translate:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=.5*i[0],l=.5*i[1],d=.5*i[2],h=e[4],c=e[5],u=e[6],f=e[7];return t[0]=o,t[1]=r,t[2]=n,t[3]=a,t[4]=a*s+r*d-n*l+h,t[5]=a*l+n*s-o*d+c,t[6]=a*d+o*l-r*s+u,t[7]=-o*s-r*l-n*d+f,t},rotateX:function(t,e,i){var o=-e[0],r=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=s*a+h*o+l*n-d*r,u=l*a+h*r+d*o-s*n,f=d*a+h*n+s*r-l*o,g=h*a-s*o-l*r-d*n;return Lt(t,e,i),o=t[0],r=t[1],n=t[2],a=t[3],t[4]=c*a+g*o+u*n-f*r,t[5]=u*a+g*r+f*o-c*n,t[6]=f*a+g*n+c*r-u*o,t[7]=g*a-c*o-u*r-f*n,t},rotateY:function(t,e,i){var o=-e[0],r=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=s*a+h*o+l*n-d*r,u=l*a+h*r+d*o-s*n,f=d*a+h*n+s*r-l*o,g=h*a-s*o-l*r-d*n;return Dt(t,e,i),o=t[0],r=t[1],n=t[2],a=t[3],t[4]=c*a+g*o+u*n-f*r,t[5]=u*a+g*r+f*o-c*n,t[6]=f*a+g*n+c*r-u*o,t[7]=g*a-c*o-u*r-f*n,t},rotateZ:function(t,e,i){var o=-e[0],r=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],d=e[6],h=e[7],c=s*a+h*o+l*n-d*r,u=l*a+h*r+d*o-s*n,f=d*a+h*n+s*r-l*o,g=h*a-s*o-l*r-d*n;return It(t,e,i),o=t[0],r=t[1],n=t[2],a=t[3],t[4]=c*a+g*o+u*n-f*r,t[5]=u*a+g*r+f*o-c*n,t[6]=f*a+g*n+c*r-u*o,t[7]=g*a-c*o-u*r-f*n,t},rotateByQuatAppend:function(t,e,i){var o=i[0],r=i[1],n=i[2],a=i[3],s=e[0],l=e[1],d=e[2],h=e[3];return t[0]=s*a+h*o+l*n-d*r,t[1]=l*a+h*r+d*o-s*n,t[2]=d*a+h*n+s*r-l*o,t[3]=h*a-s*o-l*r-d*n,s=e[4],l=e[5],d=e[6],h=e[7],t[4]=s*a+h*o+l*n-d*r,t[5]=l*a+h*r+d*o-s*n,t[6]=d*a+h*n+s*r-l*o,t[7]=h*a-s*o-l*r-d*n,t},rotateByQuatPrepend:function(t,e,i){var o=e[0],r=e[1],n=e[2],a=e[3],s=i[0],l=i[1],d=i[2],h=i[3];return t[0]=o*h+a*s+r*d-n*l,t[1]=r*h+a*l+n*s-o*d,t[2]=n*h+a*d+o*l-r*s,t[3]=a*h-o*s-r*l-n*d,s=i[4],l=i[5],d=i[6],h=i[7],t[4]=o*h+a*s+r*d-n*l,t[5]=r*h+a*l+n*s-o*d,t[6]=n*h+a*d+o*l-r*s,t[7]=a*h-o*s-r*l-n*d,t},rotateAroundAxis:function(t,i,o,r){if(Math.abs(r)<e)return le(t,i);var n=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]);r*=.5;var a=Math.sin(r),s=a*o[0]/n,l=a*o[1]/n,d=a*o[2]/n,h=Math.cos(r),c=i[0],u=i[1],f=i[2],g=i[3];t[0]=c*h+g*s+u*d-f*l,t[1]=u*h+g*l+f*s-c*d,t[2]=f*h+g*d+c*l-u*s,t[3]=g*h-c*s-u*l-f*d;var p=i[4],v=i[5],y=i[6],m=i[7];return t[4]=p*h+m*s+v*d-y*l,t[5]=v*h+m*l+y*s-p*d,t[6]=y*h+m*d+p*l-v*s,t[7]=m*h-p*s-v*l-y*d,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t},multiply:ce,mul:ue,scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t},dot:fe,lerp:function(t,e,i,o){var r=1-o;return fe(e,i)<0&&(o=-o),t[0]=e[0]*r+i[0]*o,t[1]=e[1]*r+i[1]*o,t[2]=e[2]*r+i[2]*o,t[3]=e[3]*r+i[3]*o,t[4]=e[4]*r+i[4]*o,t[5]=e[5]*r+i[5]*o,t[6]=e[6]*r+i[6]*o,t[7]=e[7]*r+i[7]*o,t},invert:function(t,e){var i=ve(e);return t[0]=-e[0]/i,t[1]=-e[1]/i,t[2]=-e[2]/i,t[3]=e[3]/i,t[4]=-e[4]/i,t[5]=-e[5]/i,t[6]=-e[6]/i,t[7]=e[7]/i,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},length:ge,len:pe,squaredLength:ve,sqrLen:ye,normalize:function(t,e){var i=ve(e);if(i>0){i=Math.sqrt(i);var o=e[0]/i,r=e[1]/i,n=e[2]/i,a=e[3]/i,s=e[4],l=e[5],d=e[6],h=e[7],c=o*s+r*l+n*d+a*h;t[0]=o,t[1]=r,t[2]=n,t[3]=a,t[4]=(s-o*c)/i,t[5]=(l-r*c)/i,t[6]=(d-n*c)/i,t[7]=(h-a*c)/i}return t},str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},equals:function(t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],d=t[6],h=t[7],c=i[0],u=i[1],f=i[2],g=i[3],p=i[4],v=i[5],y=i[6],m=i[7];return Math.abs(o-c)<=e*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(r-u)<=e*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(n-f)<=e*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=e*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(s-p)<=e*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-v)<=e*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(d-y)<=e*Math.max(1,Math.abs(d),Math.abs(y))&&Math.abs(h-m)<=e*Math.max(1,Math.abs(h),Math.abs(m))}});function xe(){var t=new i(2);return i!=Float32Array&&(t[0]=0,t[1]=0),t}function be(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function Ce(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t}function Ae(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t}function Me(t,e){var i=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(i*i+o*o)}function Pe(t,e){var i=e[0]-t[0],o=e[1]-t[1];return i*i+o*o}function Te(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)}function _e(t){var e=t[0],i=t[1];return e*e+i*i}var we=Te,Se=be,Re=Ce,Le=Ae,De=Me,Ie=Pe,Ee=_e,Oe=function(){var t=xe();return function(e,i,o,r,n,a){var s,l;for(i||(i=2),o||(o=0),l=r?Math.min(r*i+o,e.length):e.length,s=o;s<l;s+=i)t[0]=e[s],t[1]=e[s+1],n(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),Fe=Object.freeze({create:xe,clone:function(t){var e=new i(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var o=new i(2);return o[0]=t,o[1]=e,o},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,i){return t[0]=e,t[1]=i,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t},subtract:be,multiply:Ce,divide:Ae,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t},scaleAndAdd:function(t,e,i,o){return t[0]=e[0]+i[0]*o,t[1]=e[1]+i[1]*o,t},distance:Me,squaredDistance:Pe,length:Te,squaredLength:_e,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var i=e[0],o=e[1],r=i*i+o*o;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,i){var o=e[0]*i[1]-e[1]*i[0];return t[0]=t[1]=0,t[2]=o,t},lerp:function(t,e,i,o){var r=e[0],n=e[1];return t[0]=r+o*(i[0]-r),t[1]=n+o*(i[1]-n),t},random:function(t,e){e=e||1;var i=2*o()*Math.PI;return t[0]=Math.cos(i)*e,t[1]=Math.sin(i)*e,t},transformMat2:function(t,e,i){var o=e[0],r=e[1];return t[0]=i[0]*o+i[2]*r,t[1]=i[1]*o+i[3]*r,t},transformMat2d:function(t,e,i){var o=e[0],r=e[1];return t[0]=i[0]*o+i[2]*r+i[4],t[1]=i[1]*o+i[3]*r+i[5],t},transformMat3:function(t,e,i){var o=e[0],r=e[1];return t[0]=i[0]*o+i[3]*r+i[6],t[1]=i[1]*o+i[4]*r+i[7],t},transformMat4:function(t,e,i){var o=e[0],r=e[1];return t[0]=i[0]*o+i[4]*r+i[12],t[1]=i[1]*o+i[5]*r+i[13],t},rotate:function(t,e,i,o){var r=e[0]-i[0],n=e[1]-i[1],a=Math.sin(o),s=Math.cos(o);return t[0]=r*s-n*a+i[0],t[1]=r*a+n*s+i[1],t},angle:function(t,e){var i=t[0],o=t[1],r=e[0],n=e[1],a=i*i+o*o;a>0&&(a=1/Math.sqrt(a));var s=r*r+n*n;s>0&&(s=1/Math.sqrt(s));var l=(i*r+o*n)*a*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,i){var o=t[0],r=t[1],n=i[0],a=i[1];return Math.abs(o-n)<=e*Math.max(1,Math.abs(o),Math.abs(n))&&Math.abs(r-a)<=e*Math.max(1,Math.abs(r),Math.abs(a))},len:we,sub:Se,mul:Re,div:Le,dist:De,sqrDist:Ie,sqrLen:Ee,forEach:Oe});t.glMatrix=n,t.mat2=h,t.mat2d=p,t.mat3=C,t.mat4=L,t.quat=ae,t.quat2=me,t.vec2=Fe,t.vec3=J,t.vec4=_t,Object.defineProperty(t,"__esModule",{value:!0})}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).i18next=e()}(this,function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function o(t,e,o){return e&&i(t.prototype,e),o&&i(t,o),t}function r(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function n(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},o=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),o.forEach(function(e){r(t,e,i[e])})}return t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?d(t):e}function c(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],o=!0,r=!1,n=void 0;try{for(var a,s=t[Symbol.iterator]();!(o=(a=s.next()).done)&&(i.push(a.value),!e||i.length!==e);o=!0);}catch(t){r=!0,n=t}finally{try{o||null==s.return||s.return()}finally{if(r)throw n}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function u(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var f={type:"logger",log:function(t){this.output("log",t)},warn:function(t){this.output("warn",t)},error:function(t){this.output("error",t)},output:function(t,e){var i;console&&console[t]&&(i=console)[t].apply(i,u(e))}},g=new(function(){function t(i){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.init(i,o)}return o(t,[{key:"init",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.prefix=e.prefix||"i18next:",this.logger=t||f,this.options=e,this.debug=e.debug}},{key:"setDebug",value:function(t){this.debug=t}},{key:"log",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"log","",!0)}},{key:"warn",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"warn","",!0)}},{key:"error",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"error","")}},{key:"deprecate",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"warn","WARNING DEPRECATED: ",!0)}},{key:"forward",value:function(t,e,i,o){return o&&!this.debug?null:("string"==typeof t[0]&&(t[0]="".concat(i).concat(this.prefix," ").concat(t[0])),this.logger[e](t))}},{key:"create",value:function(e){return new t(this.logger,n({},{prefix:"".concat(this.prefix,":").concat(e,":")},this.options))}}]),t}()),p=function(){function t(){e(this,t),this.observers={}}return o(t,[{key:"on",value:function(t,e){var i=this;return t.split(" ").forEach(function(t){i.observers[t]=i.observers[t]||[],i.observers[t].push(e)}),this}},{key:"off",value:function(t,e){var i=this;this.observers[t]&&this.observers[t].forEach(function(){if(e){var o=i.observers[t].indexOf(e);o>-1&&i.observers[t].splice(o,1)}else delete i.observers[t]})}},{key:"emit",value:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),o=1;o<e;o++)i[o-1]=arguments[o];this.observers[t]&&[].concat(this.observers[t]).forEach(function(t){t.apply(void 0,i)});this.observers["*"]&&[].concat(this.observers["*"]).forEach(function(e){e.apply(e,[t].concat(i))})}}]),t}();function v(){var t,e,i=new Promise(function(i,o){t=i,e=o});return i.resolve=t,i.reject=e,i}function y(t){return null==t?"":""+t}function m(t,e,i){function o(t){return t&&t.indexOf("###")>-1?t.replace(/###/g,"."):t}function r(){return!t||"string"==typeof t}for(var n="string"!=typeof e?[].concat(e):e.split(".");n.length>1;){if(r())return{};var a=o(n.shift());!t[a]&&i&&(t[a]=new i),t=t[a]}return r()?{}:{obj:t,k:o(n.shift())}}function x(t,e,i){var o=m(t,e,Object);o.obj[o.k]=i}function b(t,e){var i=m(t,e),o=i.obj,r=i.k;if(o)return o[r]}function C(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var A={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function M(t){return"string"==typeof t?t.replace(/[&<>"'\/]/g,function(t){return A[t]}):t}var P=function(t){function i(t){var o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ns:["translation"],defaultNS:"translation"};return e(this,i),o=h(this,s(i).call(this)),p.call(d(d(o))),o.data=t||{},o.options=r,void 0===o.options.keySeparator&&(o.options.keySeparator="."),o}return a(i,p),o(i,[{key:"addNamespaces",value:function(t){this.options.ns.indexOf(t)<0&&this.options.ns.push(t)}},{key:"removeNamespaces",value:function(t){var e=this.options.ns.indexOf(t);e>-1&&this.options.ns.splice(e,1)}},{key:"getResource",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=void 0!==o.keySeparator?o.keySeparator:this.options.keySeparator,n=[t,e];return i&&"string"!=typeof i&&(n=n.concat(i)),i&&"string"==typeof i&&(n=n.concat(r?i.split(r):i)),t.indexOf(".")>-1&&(n=t.split(".")),b(this.data,n)}},{key:"addResource",value:function(t,e,i,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{silent:!1},n=this.options.keySeparator;void 0===n&&(n=".");var a=[t,e];i&&(a=a.concat(n?i.split(n):i)),t.indexOf(".")>-1&&(o=e,e=(a=t.split("."))[1]),this.addNamespaces(e),x(this.data,a,o),r.silent||this.emit("added",t,e,i,o)}},{key:"addResources",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{silent:!1};for(var r in i)"string"!=typeof i[r]&&"[object Array]"!==Object.prototype.toString.apply(i[r])||this.addResource(t,e,r,i[r],{silent:!0});o.silent||this.emit("added",t,e,i)}},{key:"addResourceBundle",value:function(t,e,i,o,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{silent:!1},s=[t,e];t.indexOf(".")>-1&&(o=i,i=e,e=(s=t.split("."))[1]),this.addNamespaces(e);var l=b(this.data,s)||{};o?function t(e,i,o){for(var r in i)r in e?"string"==typeof e[r]||e[r]instanceof String||"string"==typeof i[r]||i[r]instanceof String?o&&(e[r]=i[r]):t(e[r],i[r],o):e[r]=i[r];return e}(l,i,r):l=n({},l,i),x(this.data,s,l),a.silent||this.emit("added",t,e,i)}},{key:"removeResourceBundle",value:function(t,e){this.hasResourceBundle(t,e)&&delete this.data[t][e],this.removeNamespaces(e),this.emit("removed",t,e)}},{key:"hasResourceBundle",value:function(t,e){return void 0!==this.getResource(t,e)}},{key:"getResourceBundle",value:function(t,e){return e||(e=this.options.defaultNS),"v1"===this.options.compatibilityAPI?n({},{},this.getResource(t,e)):this.getResource(t,e)}},{key:"getDataByLanguage",value:function(t){return this.data[t]}},{key:"toJSON",value:function(){return this.data}}]),i}(),T={processors:{},addPostProcessor:function(t){this.processors[t.name]=t},handle:function(t,e,i,o,r){var n=this;return t.forEach(function(t){n.processors[t]&&(e=n.processors[t].process(e,i,o,r))}),e}},_=function(i){function r(t){var i,o,n,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e(this,r),i=h(this,s(r).call(this)),p.call(d(d(i))),o=["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat"],n=t,a=d(d(i)),o.forEach(function(t){n[t]&&(a[t]=n[t])}),i.options=l,void 0===i.options.keySeparator&&(i.options.keySeparator="."),i.logger=g.create("translator"),i}return a(r,p),o(r,[{key:"changeLanguage",value:function(t){t&&(this.language=t)}},{key:"exists",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}},i=this.resolve(t,e);return i&&void 0!==i.res}},{key:"extractFromKey",value:function(t,e){var i=e.nsSeparator||this.options.nsSeparator;void 0===i&&(i=":");var o=void 0!==e.keySeparator?e.keySeparator:this.options.keySeparator,r=e.ns||this.options.defaultNS;if(i&&t.indexOf(i)>-1){var n=t.split(i);(i!==o||i===o&&this.options.ns.indexOf(n[0])>-1)&&(r=n.shift()),t=n.join(o)}return"string"==typeof r&&(r=[r]),{key:t,namespaces:r}}},{key:"translate",value:function(e,i){var o=this;if("object"!==t(i)&&this.options.overloadTranslationOptionHandler&&(i=this.options.overloadTranslationOptionHandler(arguments)),i||(i={}),void 0===e||null===e)return"";Array.isArray(e)||(e=[String(e)]);var r=void 0!==i.keySeparator?i.keySeparator:this.options.keySeparator,a=this.extractFromKey(e[e.length-1],i),s=a.key,l=a.namespaces,d=l[l.length-1],h=i.lng||this.language,c=i.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(h&&"cimode"===h.toLowerCase()){if(c){var u=i.nsSeparator||this.options.nsSeparator;return d+u+s}return s}var f=this.resolve(e,i),g=f&&f.res,p=f&&f.usedKey||s,v=f&&f.exactUsedKey||s,y=Object.prototype.toString.apply(g),m=void 0!==i.joinArrays?i.joinArrays:this.options.joinArrays,x=!this.i18nFormat||this.i18nFormat.handleAsObject;if(x&&g&&("string"!=typeof g&&"boolean"!=typeof g&&"number"!=typeof g)&&["[object Number]","[object Function]","[object RegExp]"].indexOf(y)<0&&("string"!=typeof m||"[object Array]"!==y)){if(!i.returnObjects&&!this.options.returnObjects)return this.logger.warn("accessing an object - but returnObjects options is not enabled!"),this.options.returnedObjectHandler?this.options.returnedObjectHandler(p,g,i):"key '".concat(s," (").concat(this.language,")' returned an object instead of string.");if(r){var b="[object Array]"===y,C=b?[]:{},A=b?v:p;for(var M in g)if(Object.prototype.hasOwnProperty.call(g,M)){var P="".concat(A).concat(r).concat(M);C[M]=this.translate(P,n({},i,{joinArrays:!1,ns:l})),C[M]===P&&(C[M]=g[M])}g=C}}else if(x&&"string"==typeof m&&"[object Array]"===y)(g=g.join(m))&&(g=this.extendTranslation(g,e,i));else{var T=!1,_=!1;if(!this.isValidLookup(g)&&void 0!==i.defaultValue){if(T=!0,void 0!==i.count){var w=this.pluralResolver.getSuffix(h,i.count);g=i["defaultValue".concat(w)]}g||(g=i.defaultValue)}this.isValidLookup(g)||(_=!0,g=s);var S=i.defaultValue&&i.defaultValue!==g&&this.options.updateMissing;if(_||T||S){this.logger.log(S?"updateKey":"missingKey",h,d,s,S?i.defaultValue:g);var R=[],L=this.languageUtils.getFallbackCodes(this.options.fallbackLng,i.lng||this.language);if("fallback"===this.options.saveMissingTo&&L&&L[0])for(var D=0;D<L.length;D++)R.push(L[D]);else"all"===this.options.saveMissingTo?R=this.languageUtils.toResolveHierarchy(i.lng||this.language):R.push(i.lng||this.language);var I=function(t,e){o.options.missingKeyHandler?o.options.missingKeyHandler(t,d,e,S?i.defaultValue:g,S,i):o.backendConnector&&o.backendConnector.saveMissing&&o.backendConnector.saveMissing(t,d,e,S?i.defaultValue:g,S,i),o.emit("missingKey",t,d,e,g)};if(this.options.saveMissing){var E=void 0!==i.count&&"string"!=typeof i.count;this.options.saveMissingPlurals&&E?R.forEach(function(t){o.pluralResolver.getPluralFormsOfKey(t,s).forEach(function(e){return I([t],e)})}):I(R,s)}}g=this.extendTranslation(g,e,i,f),_&&g===s&&this.options.appendNamespaceToMissingKey&&(g="".concat(d,":").concat(s)),_&&this.options.parseMissingKeyHandler&&(g=this.options.parseMissingKeyHandler(g))}return g}},{key:"extendTranslation",value:function(t,e,i,o){var r=this;if(this.i18nFormat&&this.i18nFormat.parse)t=this.i18nFormat.parse(t,i,o.usedLng,o.usedNS,o.usedKey,{resolved:o});else if(!i.skipInterpolation){i.interpolation&&this.interpolator.init(n({},i,{interpolation:n({},this.options.interpolation,i.interpolation)}));var a=i.replace&&"string"!=typeof i.replace?i.replace:i;this.options.interpolation.defaultVariables&&(a=n({},this.options.interpolation.defaultVariables,a)),t=this.interpolator.interpolate(t,a,i.lng||this.language,i),!1!==i.nest&&(t=this.interpolator.nest(t,function(){return r.translate.apply(r,arguments)},i)),i.interpolation&&this.interpolator.reset()}var s=i.postProcess||this.options.postProcess,l="string"==typeof s?[s]:s;return void 0!==t&&null!==t&&l&&l.length&&!1!==i.applyPostProcessor&&(t=T.handle(l,t,e,i,this)),t}},{key:"resolve",value:function(t){var e,i,o,r,n,a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"==typeof t&&(t=[t]),t.forEach(function(t){if(!a.isValidLookup(e)){var l=a.extractFromKey(t,s),d=l.key;i=d;var h=l.namespaces;a.options.fallbackNS&&(h=h.concat(a.options.fallbackNS));var c=void 0!==s.count&&"string"!=typeof s.count,u=void 0!==s.context&&"string"==typeof s.context&&""!==s.context,f=s.lngs?s.lngs:a.languageUtils.toResolveHierarchy(s.lng||a.language,s.fallbackLng);h.forEach(function(t){a.isValidLookup(e)||(n=t,f.forEach(function(i){if(!a.isValidLookup(e)){r=i;var n,l,h=d,f=[h];if(a.i18nFormat&&a.i18nFormat.addLookupKeys)a.i18nFormat.addLookupKeys(f,d,i,t,s);else c&&(n=a.pluralResolver.getSuffix(i,s.count)),c&&u&&f.push(h+n),u&&f.push(h+="".concat(a.options.contextSeparator).concat(s.context)),c&&f.push(h+=n);for(;l=f.pop();)a.isValidLookup(e)||(o=l,e=a.getResource(i,t,l,s))}}))})}}),{res:e,usedKey:i,exactUsedKey:o,usedLng:r,usedNS:n}}},{key:"isValidLookup",value:function(t){return!(void 0===t||!this.options.returnNull&&null===t||!this.options.returnEmptyString&&""===t)}},{key:"getResource",value:function(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.i18nFormat&&this.i18nFormat.getResource?this.i18nFormat.getResource(t,e,i,o):this.resourceStore.getResource(t,e,i,o)}}]),r}();function w(t){return t.charAt(0).toUpperCase()+t.slice(1)}var S=function(){function t(i){e(this,t),this.options=i,this.whitelist=this.options.whitelist||!1,this.logger=g.create("languageUtils")}return o(t,[{key:"getScriptPartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return null;var e=t.split("-");return 2===e.length?null:(e.pop(),this.formatLanguageCode(e.join("-")))}},{key:"getLanguagePartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return t;var e=t.split("-");return this.formatLanguageCode(e[0])}},{key:"formatLanguageCode",value:function(t){if("string"==typeof t&&t.indexOf("-")>-1){var e=["hans","hant","latn","cyrl","cans","mong","arab"],i=t.split("-");return this.options.lowerCaseLng?i=i.map(function(t){return t.toLowerCase()}):2===i.length?(i[0]=i[0].toLowerCase(),i[1]=i[1].toUpperCase(),e.indexOf(i[1].toLowerCase())>-1&&(i[1]=w(i[1].toLowerCase()))):3===i.length&&(i[0]=i[0].toLowerCase(),2===i[1].length&&(i[1]=i[1].toUpperCase()),"sgn"!==i[0]&&2===i[2].length&&(i[2]=i[2].toUpperCase()),e.indexOf(i[1].toLowerCase())>-1&&(i[1]=w(i[1].toLowerCase())),e.indexOf(i[2].toLowerCase())>-1&&(i[2]=w(i[2].toLowerCase()))),i.join("-")}return this.options.cleanCode||this.options.lowerCaseLng?t.toLowerCase():t}},{key:"isWhitelisted",value:function(t){return("languageOnly"===this.options.load||this.options.nonExplicitWhitelist)&&(t=this.getLanguagePartFromCode(t)),!this.whitelist||!this.whitelist.length||this.whitelist.indexOf(t)>-1}},{key:"getFallbackCodes",value:function(t,e){if(!t)return[];if("string"==typeof t&&(t=[t]),"[object Array]"===Object.prototype.toString.apply(t))return t;if(!e)return t.default||[];var i=t[e];return i||(i=t[this.getScriptPartFromCode(e)]),i||(i=t[this.formatLanguageCode(e)]),i||(i=t.default),i||[]}},{key:"toResolveHierarchy",value:function(t,e){var i=this,o=this.getFallbackCodes(e||this.options.fallbackLng||[],t),r=[],n=function(t){t&&(i.isWhitelisted(t)?r.push(t):i.logger.warn("rejecting non-whitelisted language code: ".concat(t)))};return"string"==typeof t&&t.indexOf("-")>-1?("languageOnly"!==this.options.load&&n(this.formatLanguageCode(t)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&n(this.getScriptPartFromCode(t)),"currentOnly"!==this.options.load&&n(this.getLanguagePartFromCode(t))):"string"==typeof t&&n(this.formatLanguageCode(t)),o.forEach(function(t){r.indexOf(t)<0&&n(i.formatLanguageCode(t))}),r}}]),t}(),R=[{lngs:["ach","ak","am","arn","br","fil","gun","ln","mfe","mg","mi","oc","pt","pt-BR","tg","ti","tr","uz","wa"],nr:[1,2],fc:1},{lngs:["af","an","ast","az","bg","bn","ca","da","de","dev","el","en","eo","es","et","eu","fi","fo","fur","fy","gl","gu","ha","hi","hu","hy","ia","it","kn","ku","lb","mai","ml","mn","mr","nah","nap","nb","ne","nl","nn","no","nso","pa","pap","pms","ps","pt-PT","rm","sco","se","si","so","son","sq","sv","sw","ta","te","tk","ur","yo"],nr:[1,2],fc:2},{lngs:["ay","bo","cgg","fa","id","ja","jbo","ka","kk","km","ko","ky","lo","ms","sah","su","th","tt","ug","vi","wo","zh"],nr:[1],fc:3},{lngs:["be","bs","dz","hr","ru","sr","uk"],nr:[1,2,5],fc:4},{lngs:["ar"],nr:[0,1,2,3,11,100],fc:5},{lngs:["cs","sk"],nr:[1,2,5],fc:6},{lngs:["csb","pl"],nr:[1,2,5],fc:7},{lngs:["cy"],nr:[1,2,3,8],fc:8},{lngs:["fr"],nr:[1,2],fc:9},{lngs:["ga"],nr:[1,2,3,7,11],fc:10},{lngs:["gd"],nr:[1,2,3,20],fc:11},{lngs:["is"],nr:[1,2],fc:12},{lngs:["jv"],nr:[0,1],fc:13},{lngs:["kw"],nr:[1,2,3,4],fc:14},{lngs:["lt"],nr:[1,2,10],fc:15},{lngs:["lv"],nr:[1,2,0],fc:16},{lngs:["mk"],nr:[1,2],fc:17},{lngs:["mnk"],nr:[0,1,2],fc:18},{lngs:["mt"],nr:[1,2,11,20],fc:19},{lngs:["or"],nr:[2,1],fc:2},{lngs:["ro"],nr:[1,2,20],fc:20},{lngs:["sl"],nr:[5,1,2,3],fc:21},{lngs:["he"],nr:[1,2,20,21],fc:22}],L={1:function(t){return Number(t>1)},2:function(t){return Number(1!=t)},3:function(t){return 0},4:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},5:function(t){return Number(0===t?0:1==t?1:2==t?2:t%100>=3&&t%100<=10?3:t%100>=11?4:5)},6:function(t){return Number(1==t?0:t>=2&&t<=4?1:2)},7:function(t){return Number(1==t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},8:function(t){return Number(1==t?0:2==t?1:8!=t&&11!=t?2:3)},9:function(t){return Number(t>=2)},10:function(t){return Number(1==t?0:2==t?1:t<7?2:t<11?3:4)},11:function(t){return Number(1==t||11==t?0:2==t||12==t?1:t>2&&t<20?2:3)},12:function(t){return Number(t%10!=1||t%100==11)},13:function(t){return Number(0!==t)},14:function(t){return Number(1==t?0:2==t?1:3==t?2:3)},15:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&(t%100<10||t%100>=20)?1:2)},16:function(t){return Number(t%10==1&&t%100!=11?0:0!==t?1:2)},17:function(t){return Number(1==t||t%10==1?0:1)},18:function(t){return Number(0==t?0:1==t?1:2)},19:function(t){return Number(1==t?0:0===t||t%100>1&&t%100<11?1:t%100>10&&t%100<20?2:3)},20:function(t){return Number(1==t?0:0===t||t%100>0&&t%100<20?1:2)},21:function(t){return Number(t%100==1?1:t%100==2?2:t%100==3||t%100==4?3:0)},22:function(t){return Number(1===t?0:2===t?1:(t<0||t>10)&&t%10==0?2:3)}};var D=function(){function t(i){var o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.languageUtils=i,this.options=r,this.logger=g.create("pluralResolver"),this.rules=(o={},R.forEach(function(t){t.lngs.forEach(function(e){o[e]={numbers:t.nr,plurals:L[t.fc]}})}),o)}return o(t,[{key:"addRule",value:function(t,e){this.rules[t]=e}},{key:"getRule",value:function(t){return this.rules[t]||this.rules[this.languageUtils.getLanguagePartFromCode(t)]}},{key:"needsPlural",value:function(t){var e=this.getRule(t);return e&&e.numbers.length>1}},{key:"getPluralFormsOfKey",value:function(t,e){var i=this,o=[],r=this.getRule(t);return r?(r.numbers.forEach(function(r){var n=i.getSuffix(t,r);o.push("".concat(e).concat(n))}),o):o}},{key:"getSuffix",value:function(t,e){var i=this,o=this.getRule(t);if(o){var r=o.noAbs?o.plurals(e):o.plurals(Math.abs(e)),n=o.numbers[r];this.options.simplifyPluralSuffix&&2===o.numbers.length&&1===o.numbers[0]&&(2===n?n="plural":1===n&&(n=""));var a=function(){return i.options.prepend&&n.toString()?i.options.prepend+n.toString():n.toString()};return"v1"===this.options.compatibilityJSON?1===n?"":"number"==typeof n?"_plural_".concat(n.toString()):a():"v2"===this.options.compatibilityJSON?a():this.options.simplifyPluralSuffix&&2===o.numbers.length&&1===o.numbers[0]?a():this.options.prepend&&r.toString()?this.options.prepend+r.toString():r.toString()}return this.logger.warn("no plural rule found for: ".concat(t)),""}}]),t}(),I=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.logger=g.create("interpolator"),this.init(i,!0)}return o(t,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(arguments.length>1?arguments[1]:void 0)&&(this.options=t,this.format=t.interpolation&&t.interpolation.format||function(t){return t}),t.interpolation||(t.interpolation={escapeValue:!0});var e=t.interpolation;this.escape=void 0!==e.escape?e.escape:M,this.escapeValue=void 0===e.escapeValue||e.escapeValue,this.useRawValueToEscape=void 0!==e.useRawValueToEscape&&e.useRawValueToEscape,this.prefix=e.prefix?C(e.prefix):e.prefixEscaped||"{{",this.suffix=e.suffix?C(e.suffix):e.suffixEscaped||"}}",this.formatSeparator=e.formatSeparator?e.formatSeparator:e.formatSeparator||",",this.unescapePrefix=e.unescapeSuffix?"":e.unescapePrefix||"-",this.unescapeSuffix=this.unescapePrefix?"":e.unescapeSuffix||"",this.nestingPrefix=e.nestingPrefix?C(e.nestingPrefix):e.nestingPrefixEscaped||C("$t("),this.nestingSuffix=e.nestingSuffix?C(e.nestingSuffix):e.nestingSuffixEscaped||C(")"),this.maxReplaces=e.maxReplaces?e.maxReplaces:1e3,this.resetRegExp()}},{key:"reset",value:function(){this.options&&this.init(this.options)}},{key:"resetRegExp",value:function(){var t="".concat(this.prefix,"(.+?)").concat(this.suffix);this.regexp=new RegExp(t,"g");var e="".concat(this.prefix).concat(this.unescapePrefix,"(.+?)").concat(this.unescapeSuffix).concat(this.suffix);this.regexpUnescape=new RegExp(e,"g");var i="".concat(this.nestingPrefix,"(.+?)").concat(this.nestingSuffix);this.nestingRegexp=new RegExp(i,"g")}},{key:"interpolate",value:function(t,e,i,o){var r,n,a,s=this;function l(t){return t.replace(/\$/g,"$$$$")}var d=function(t){if(t.indexOf(s.formatSeparator)<0)return b(e,t);var o=t.split(s.formatSeparator),r=o.shift().trim(),n=o.join(s.formatSeparator).trim();return s.format(b(e,r),n,i)};this.resetRegExp();var h=o&&o.missingInterpolationHandler||this.options.missingInterpolationHandler;for(a=0;(r=this.regexpUnescape.exec(t))&&(n=d(r[1].trim()),t=t.replace(r[0],n),this.regexpUnescape.lastIndex=0,!(++a>=this.maxReplaces)););for(a=0;r=this.regexp.exec(t);){if(void 0===(n=d(r[1].trim())))if("function"==typeof h){var c=h(t,r,o);n="string"==typeof c?c:""}else this.logger.warn("missed to pass in variable ".concat(r[1]," for interpolating ").concat(t)),n="";else"string"==typeof n||this.useRawValueToEscape||(n=y(n));if(n=this.escapeValue?l(this.escape(n)):l(n),t=t.replace(r[0],n),this.regexp.lastIndex=0,++a>=this.maxReplaces)break}return t}},{key:"nest",value:function(t,e){var i,o,r=n({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{});function a(t,e){if(t.indexOf(",")<0)return t;var i=t.split(",");t=i.shift();var o=i.join(",");o=(o=this.interpolate(o,r)).replace(/'/g,'"');try{r=JSON.parse(o),e&&(r=n({},e,r))}catch(e){this.logger.error("failed parsing options string in nesting for key ".concat(t),e)}return t}for(r.applyPostProcessor=!1;i=this.nestingRegexp.exec(t);){if((o=e(a.call(this,i[1].trim(),r),r))&&i[0]===t&&"string"!=typeof o)return o;"string"!=typeof o&&(o=y(o)),o||(this.logger.warn("missed to resolve ".concat(i[1]," for nesting ").concat(t)),o=""),t=t.replace(i[0],o),this.regexp.lastIndex=0}return t}}]),t}();var E=function(t){function i(t,o,r){var n,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return e(this,i),n=h(this,s(i).call(this)),p.call(d(d(n))),n.backend=t,n.store=o,n.languageUtils=r.languageUtils,n.options=a,n.logger=g.create("backendConnector"),n.state={},n.queue=[],n.backend&&n.backend.init&&n.backend.init(r,a.backend,a),n}return a(i,p),o(i,[{key:"queueLoad",value:function(t,e,i,o){var r=this,n=[],a=[],s=[],l=[];return t.forEach(function(t){var o=!0;e.forEach(function(e){var s="".concat(t,"|").concat(e);!i.reload&&r.store.hasResourceBundle(t,e)?r.state[s]=2:r.state[s]<0||(1===r.state[s]?a.indexOf(s)<0&&a.push(s):(r.state[s]=1,o=!1,a.indexOf(s)<0&&a.push(s),n.indexOf(s)<0&&n.push(s),l.indexOf(e)<0&&l.push(e)))}),o||s.push(t)}),(n.length||a.length)&&this.queue.push({pending:a,loaded:{},errors:[],callback:o}),{toLoad:n,pending:a,toLoadLanguages:s,toLoadNamespaces:l}}},{key:"loaded",value:function(t,e,i){var o=c(t.split("|"),2),r=o[0],n=o[1];e&&this.emit("failedLoading",r,n,e),i&&this.store.addResourceBundle(r,n,i),this.state[t]=e?-1:2;var a={};this.queue.forEach(function(i){var o,s,l,d,h,c;o=i.loaded,s=n,d=m(o,[r],Object),h=d.obj,c=d.k,h[c]=h[c]||[],l&&(h[c]=h[c].concat(s)),l||h[c].push(s),function(t,e){for(var i=t.indexOf(e);-1!==i;)t.splice(i,1),i=t.indexOf(e)}(i.pending,t),e&&i.errors.push(e),0!==i.pending.length||i.done||(Object.keys(i.loaded).forEach(function(t){a[t]||(a[t]=[]),i.loaded[t].length&&i.loaded[t].forEach(function(e){a[t].indexOf(e)<0&&a[t].push(e)})}),i.done=!0,i.errors.length?i.callback(i.errors):i.callback())}),this.emit("loaded",a),this.queue=this.queue.filter(function(t){return!t.done})}},{key:"read",value:function(t,e,i){var o=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:250,a=arguments.length>5?arguments[5]:void 0;return t.length?this.backend[i](t,e,function(s,l){s&&l&&r<5?setTimeout(function(){o.read.call(o,t,e,i,r+1,2*n,a)},n):a(s,l)}):a(null,{})}},{key:"prepareLoading",value:function(t,e){var i=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),r&&r();"string"==typeof t&&(t=this.languageUtils.toResolveHierarchy(t)),"string"==typeof e&&(e=[e]);var n=this.queueLoad(t,e,o,r);if(!n.toLoad.length)return n.pending.length||r(),null;n.toLoad.forEach(function(t){i.loadOne(t)})}},{key:"load",value:function(t,e,i){this.prepareLoading(t,e,{},i)}},{key:"reload",value:function(t,e,i){this.prepareLoading(t,e,{reload:!0},i)}},{key:"loadOne",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=c(t.split("|"),2),r=o[0],n=o[1];this.read(r,n,"read",null,null,function(o,a){o&&e.logger.warn("".concat(i,"loading namespace ").concat(n," for language ").concat(r," failed"),o),!o&&a&&e.logger.log("".concat(i,"loaded namespace ").concat(n," for language ").concat(r),a),e.loaded(t,o,a)})}},{key:"saveMissing",value:function(t,e,i,o,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.backend&&this.backend.create&&this.backend.create(t,e,i,o,null,n({},a,{isUpdate:r})),t&&t[0]&&this.store.addResource(t[0],e,i,o)}}]),i}();function O(t){return"string"==typeof t.ns&&(t.ns=[t.ns]),"string"==typeof t.fallbackLng&&(t.fallbackLng=[t.fallbackLng]),"string"==typeof t.fallbackNS&&(t.fallbackNS=[t.fallbackNS]),t.whitelist&&t.whitelist.indexOf("cimode")<0&&(t.whitelist=t.whitelist.concat(["cimode"])),t}function F(){}return new(function(i){function r(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;if(e(this,r),t=h(this,s(r).call(this)),p.call(d(d(t))),t.options=O(i),t.services={},t.logger=g,t.modules={external:[]},o&&!t.isInitialized&&!i.isClone){if(!t.options.initImmediate)return t.init(i,o),h(t,d(d(t)));setTimeout(function(){t.init(i,o)},0)}return t}return a(r,p),o(r,[{key:"init",value:function(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;function r(t){return t?"function"==typeof t?new t:t:null}if("function"==typeof i&&(o=i,i={}),this.options=n({},{debug:!1,initImmediate:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,whitelist:!1,nonExplicitWhitelist:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,returnNull:!0,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:function(){},parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:function(e){var i={};if("object"===t(e[1])&&(i=e[1]),"string"==typeof e[1]&&(i.defaultValue=e[1]),"string"==typeof e[2]&&(i.tDescription=e[2]),"object"===t(e[2])||"object"===t(e[3])){var o=e[3]||e[2];Object.keys(o).forEach(function(t){i[t]=o[t]})}return i},interpolation:{escapeValue:!0,format:function(t,e,i){return t},prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",maxReplaces:1e3}},this.options,O(i)),this.format=this.options.interpolation.format,o||(o=F),!this.options.isClone){this.modules.logger?g.init(r(this.modules.logger),this.options):g.init(null,this.options);var a=new S(this.options);this.store=new P(this.options.resources,this.options);var s=this.services;s.logger=g,s.resourceStore=this.store,s.languageUtils=a,s.pluralResolver=new D(a,{prepend:this.options.pluralSeparator,compatibilityJSON:this.options.compatibilityJSON,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),s.interpolator=new I(this.options),s.backendConnector=new E(r(this.modules.backend),s.resourceStore,s,this.options),s.backendConnector.on("*",function(t){for(var i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];e.emit.apply(e,[t].concat(o))}),this.modules.languageDetector&&(s.languageDetector=r(this.modules.languageDetector),s.languageDetector.init(s,this.options.detection,this.options)),this.modules.i18nFormat&&(s.i18nFormat=r(this.modules.i18nFormat),s.i18nFormat.init&&s.i18nFormat.init(this)),this.translator=new _(this.services,this.options),this.translator.on("*",function(t){for(var i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];e.emit.apply(e,[t].concat(o))}),this.modules.external.forEach(function(t){t.init&&t.init(e)})}["getResource","addResource","addResources","addResourceBundle","removeResourceBundle","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach(function(t){e[t]=function(){var i;return(i=e.store)[t].apply(i,arguments)}});var l=v(),d=function(){e.changeLanguage(e.options.lng,function(t,i){e.isInitialized=!0,e.logger.log("initialized",e.options),e.emit("initialized",e.options),l.resolve(i),o(t,i)})};return this.options.resources||!this.options.initImmediate?d():setTimeout(d,0),l}},{key:"loadResources",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F;if(!this.options.resources||this.options.partialBundledLanguages){if(this.language&&"cimode"===this.language.toLowerCase())return e();var i=[],o=function(e){e&&t.services.languageUtils.toResolveHierarchy(e).forEach(function(t){i.indexOf(t)<0&&i.push(t)})};if(this.language)o(this.language);else this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach(function(t){return o(t)});this.options.preload&&this.options.preload.forEach(function(t){return o(t)}),this.services.backendConnector.load(i,this.options.ns,e)}else e(null)}},{key:"reloadResources",value:function(t,e,i){var o=v();return t||(t=this.languages),e||(e=this.options.ns),i||(i=F),this.services.backendConnector.reload(t,e,function(t){o.resolve(),i(t)}),o}},{key:"use",value:function(t){return"backend"===t.type&&(this.modules.backend=t),("logger"===t.type||t.log&&t.warn&&t.error)&&(this.modules.logger=t),"languageDetector"===t.type&&(this.modules.languageDetector=t),"i18nFormat"===t.type&&(this.modules.i18nFormat=t),"postProcessor"===t.type&&T.addPostProcessor(t),"3rdParty"===t.type&&this.modules.external.push(t),this}},{key:"changeLanguage",value:function(t,e){var i=this,o=v();this.emit("languageChanging",t);var r=function(t){t&&(i.language=t,i.languages=i.services.languageUtils.toResolveHierarchy(t),i.translator.language||i.translator.changeLanguage(t),i.services.languageDetector&&i.services.languageDetector.cacheUserLanguage(t)),i.loadResources(function(r){!function(t,r){i.translator.changeLanguage(r),r&&(i.emit("languageChanged",r),i.logger.log("languageChanged",r)),o.resolve(function(){return i.t.apply(i,arguments)}),e&&e(t,function(){return i.t.apply(i,arguments)})}(r,t)})};return t||!this.services.languageDetector||this.services.languageDetector.async?!t&&this.services.languageDetector&&this.services.languageDetector.async?this.services.languageDetector.detect(r):r(t):r(this.services.languageDetector.detect()),o}},{key:"getFixedT",value:function(e,i){var o=this,r=function e(i,r){var a=n({},r);if("object"!==t(r)){for(var s=arguments.length,l=new Array(s>2?s-2:0),d=2;d<s;d++)l[d-2]=arguments[d];a=o.options.overloadTranslationOptionHandler([i,r].concat(l))}return a.lng=a.lng||e.lng,a.lngs=a.lngs||e.lngs,a.ns=a.ns||e.ns,o.t(i,a)};return"string"==typeof e?r.lng=e:r.lngs=e,r.ns=i,r}},{key:"t",value:function(){var t;return this.translator&&(t=this.translator).translate.apply(t,arguments)}},{key:"exists",value:function(){var t;return this.translator&&(t=this.translator).exists.apply(t,arguments)}},{key:"setDefaultNamespace",value:function(t){this.options.defaultNS=t}},{key:"loadNamespaces",value:function(t,e){var i=this,o=v();return this.options.ns?("string"==typeof t&&(t=[t]),t.forEach(function(t){i.options.ns.indexOf(t)<0&&i.options.ns.push(t)}),this.loadResources(function(t){o.resolve(),e&&e(t)}),o):(e&&e(),Promise.resolve())}},{key:"loadLanguages",value:function(t,e){var i=v();"string"==typeof t&&(t=[t]);var o=this.options.preload||[],r=t.filter(function(t){return o.indexOf(t)<0});return r.length?(this.options.preload=o.concat(r),this.loadResources(function(t){i.resolve(),e&&e(t)}),i):(e&&e(),Promise.resolve())}},{key:"dir",value:function(t){if(t||(t=this.languages&&this.languages.length>0?this.languages[0]:this.language),!t)return"rtl";return["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam"].indexOf(this.services.languageUtils.getLanguagePartFromCode(t))>=0?"rtl":"ltr"}},{key:"createInstance",value:function(){return new r(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1?arguments[1]:void 0)}},{key:"cloneInstance",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F,o=n({},this.options,e,{isClone:!0}),a=new r(o);return["store","services","language"].forEach(function(e){a[e]=t[e]}),a.translator=new _(a.services,a.options),a.translator.on("*",function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),o=1;o<e;o++)i[o-1]=arguments[o];a.emit.apply(a,[t].concat(i))}),a.init(o,i),a.translator.options=a.options,a}}]),r}())}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextBrowserLanguageDetector=e()}(this,function(){var t=[],e=t.forEach,i=t.slice;var o=function(t,e,i,o){var r=void 0;if(i){var n=new Date;n.setTime(n.getTime()+60*i*1e3),r="; expires="+n.toGMTString()}else r="";o=o?"domain="+o+";":"",document.cookie=t+"="+e+r+";"+o+"path=/"},r=function(t){for(var e=t+"=",i=document.cookie.split(";"),o=0;o<i.length;o++){for(var r=i[o];" "===r.charAt(0);)r=r.substring(1,r.length);if(0===r.indexOf(e))return r.substring(e.length,r.length)}return null},n={name:"cookie",lookup:function(t){var e=void 0;if(t.lookupCookie&&"undefined"!=typeof document){var i=r(t.lookupCookie);i&&(e=i)}return e},cacheUserLanguage:function(t,e){e.lookupCookie&&"undefined"!=typeof document&&o(e.lookupCookie,t,e.cookieMinutes,e.cookieDomain)}},a={name:"querystring",lookup:function(t){var e=void 0;if("undefined"!=typeof window)for(var i=window.location.search.substring(1).split("&"),o=0;o<i.length;o++){var r=i[o].indexOf("=");if(r>0)i[o].substring(0,r)===t.lookupQuerystring&&(e=i[o].substring(r+1))}return e}},s=void 0;try{s="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(t){s=!1}var l={name:"localStorage",lookup:function(t){var e=void 0;if(t.lookupLocalStorage&&s){var i=window.localStorage.getItem(t.lookupLocalStorage);i&&(e=i)}return e},cacheUserLanguage:function(t,e){e.lookupLocalStorage&&s&&window.localStorage.setItem(e.lookupLocalStorage,t)}},d={name:"navigator",lookup:function(t){var e=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var i=0;i<navigator.languages.length;i++)e.push(navigator.languages[i]);navigator.userLanguage&&e.push(navigator.userLanguage),navigator.language&&e.push(navigator.language)}return e.length>0?e:void 0}},h={name:"htmlTag",lookup:function(t){var e=void 0,i=t.htmlTag||("undefined"!=typeof document?document.documentElement:null);return i&&"function"==typeof i.getAttribute&&(e=i.getAttribute("lang")),e}},c={name:"path",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var i=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(i instanceof Array)if("number"==typeof t.lookupFromPathIndex){if("string"!=typeof i[t.lookupFromPathIndex])return;e=i[t.lookupFromPathIndex].replace("/","")}else e=i[0].replace("/","")}return e}},u={name:"subdomain",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var i=window.location.href.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);i instanceof Array&&(e="number"==typeof t.lookupFromSubdomainIndex?i[t.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):i[0].replace("http://","").replace("https://","").replace(".",""))}return e}},f=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}();var g=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.type="languageDetector",this.detectors={},this.init(e,i)}return f(t,[{key:"init",value:function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=t,this.options=function(t){return e.call(i.call(arguments,1),function(e){if(e)for(var i in e)void 0===t[i]&&(t[i]=e[i])}),t}(o,this.options||{},{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"]}),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=r,this.addDetector(n),this.addDetector(a),this.addDetector(l),this.addDetector(d),this.addDetector(h),this.addDetector(c),this.addDetector(u)}},{key:"addDetector",value:function(t){this.detectors[t.name]=t}},{key:"detect",value:function(t){var e=this;t||(t=this.options.order);var i=[];t.forEach(function(t){if(e.detectors[t]){var o=e.detectors[t].lookup(e.options);o&&"string"==typeof o&&(o=[o]),o&&(i=i.concat(o))}});var o=void 0;if(i.forEach(function(t){if(!o){var i=e.services.languageUtils.formatLanguageCode(t);e.services.languageUtils.isWhitelisted(i)&&(o=i)}}),!o){var r=this.i18nOptions.fallbackLng;"string"==typeof r&&(r=[r]),r||(r=[]),o="[object Array]"===Object.prototype.toString.apply(r)?r[0]:r[0]||r.default&&r.default[0]}return o}},{key:"cacheUserLanguage",value:function(t,e){var i=this;e||(e=this.options.caches),e&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(t)>-1||e.forEach(function(e){i.detectors[e]&&i.detectors[e].cacheUserLanguage(t,i.options)}))}}]),t}();return g.type="languageDetector",g}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextXHRBackend=e()}(this,function(){var t=[],e=t.forEach,i=t.slice;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function r(t,e){if(e&&"object"===(void 0===e?"undefined":o(e))){var i="",r=encodeURIComponent;for(var n in e)i+="&"+r(n)+"="+r(e[n]);if(!i)return t;t=t+(-1!==t.indexOf("?")?"&":"?")+i.slice(1)}return t}function n(t,e,i,n,a){n&&"object"===(void 0===n?"undefined":o(n))&&(a||(n._t=new Date),n=r("",n).slice(1)),e.queryStringParams&&(t=r(t,e.queryStringParams));try{var s;(s=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0")).open(n?"POST":"GET",t,1),e.crossDomain||s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.withCredentials=!!e.withCredentials,n&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.overrideMimeType&&s.overrideMimeType("application/json");var l=e.customHeaders;if(l)for(var d in l)s.setRequestHeader(d,l[d]);s.onreadystatechange=function(){s.readyState>3&&i&&i(s.responseText,s)},s.send(n)}catch(t){console&&console.log(t)}}var a=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}();var s=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.init(e,i),this.type="backend"}return a(t,[{key:"init",value:function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.services=t,this.options=function(t){return e.call(i.call(arguments,1),function(e){if(e)for(var i in e)void 0===t[i]&&(t[i]=e[i])}),t}(o,this.options||{},{loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/add/{{lng}}/{{ns}}",allowMultiLoading:!1,parse:JSON.parse,crossDomain:!1,ajax:n})}},{key:"readMulti",value:function(t,e,i){var o=this.options.loadPath;"function"==typeof this.options.loadPath&&(o=this.options.loadPath(t,e));var r=this.services.interpolator.interpolate(o,{lng:t.join("+"),ns:e.join("+")});this.loadUrl(r,i)}},{key:"read",value:function(t,e,i){var o=this.options.loadPath;"function"==typeof this.options.loadPath&&(o=this.options.loadPath([t],[e]));var r=this.services.interpolator.interpolate(o,{lng:t,ns:e});this.loadUrl(r,i)}},{key:"loadUrl",value:function(t,e){var i=this;this.options.ajax(t,this.options,function(o,r){if(r.status>=500&&r.status<600)return e("failed loading "+t,!0);if(r.status>=400&&r.status<500)return e("failed loading "+t,!1);var n=void 0,a=void 0;try{n=i.options.parse(o,t)}catch(e){a="failed parsing "+t+" to json"}if(a)return e(a,!1);e(null,n)})}},{key:"create",value:function(t,e,i,o){var r=this;"string"==typeof t&&(t=[t]);var n={};n[i]=o||"",t.forEach(function(t){var i=r.services.interpolator.interpolate(r.options.addPath,{lng:t,ns:e});r.options.ajax(i,r.options,function(t,e){},n)})}}]),t}();return s.type="backend",s}),function(t){function e(){if(1==arguments.length){var t=arguments[0];this.header={idLength:i((n=t).idLength,0),colorMapType:i(n.colorMapType,0),imageType:i(n.imageType,e.Type.RGB),colorMapIndex:i(n.colorMapIndex,0),colorMapLength:i(n.colorMapLength,0),colorMapDepth:i(n.colorMapDepth,0),offsetX:i(n.offsetX,0),offsetY:i(n.offsetY,0),width:i(n.width,0),height:i(n.height,0),pixelDepth:i(n.pixelDepth,32),flags:i(n.flags,8)},o(this.header),r(this.header)}var n}function i(t,e){return void 0!==t?t:e}function o(t){t.hasEncoding=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.RLE_RGB||t.imageType===e.Type.RLE_GREY,t.hasColorMap=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.INDEXED,t.isGreyColor=t.imageType===e.Type.RLE_GREY||t.imageType===e.Type.GREY,t.bytePerPixel=t.pixelDepth>>3,t.origin=(t.flags&e.Origin.MASK)>>e.Origin.SHIFT,t.alphaBits=t.flags&e.Origin.ALPHA}function r(t){if(t.imageType===e.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(t.hasColorMap){if(t.colorMapLength>256||1!==t.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==t.colorMapDepth&&24!==t.colorMapDepth&&32!==t.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(t.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(t.width<=0||t.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+t.pixelDepth+'"');if(0!==t.alphaBits&&1!==t.alphaBits&&8!==t.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}function n(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g,p,v=this.header.colorMapDepth>>3;for(f=0,p=r;p!==a;p+=n)for(g=s;g!==d;g+=l,f++)u=4*(g+o*p),c=e[f]*v,4===v?(t[u]=i[c+2],t[u+1]=i[c+1],t[u+2]=i[c],t[u+3]=i[c+3]):3===v?(t[u]=i[c+2],t[u+1]=i[c+1],t[u+2]=i[c],t[u+3]=255):2===v&&(h=i[c]|i[c+1]<<8,t[u]=(31744&h)>>7,t[u+1]=(992&h)>>2,t[u+2]=(31&h)<<3,t[u+3]=32768&h?0:255);return t}function a(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==d;f+=l,u+=2)h=e[u]|e[u+1]<<8,t[c=4*(f+o*g)]=(31744&h)>>7,t[c+1]=(992&h)>>2,t[c+2]=(31&h)<<3,t[c+3]=32768&h?0:255;return t}function s(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g=this.header.pixelDepth>>3;for(c=0,f=r;f!==a;f+=n)for(u=s;u!==d;u+=l,c+=g)t[(h=4*(u+o*f))+3]=255,t[h+2]=e[c],t[h+1]=e[c+1],t[h]=e[c+2];return t}function l(t,e,i,o,r,n,a,s,l,d){var h,c,u,f;for(h=0,u=r;u!==a;u+=n)for(c=s;c!==d;c+=l,h+=4)t[(f=4*(c+o*u))+2]=e[h],t[f+1]=e[h+1],t[f]=e[h+2],t[f+3]=e[h+3];return t}function d(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g;for(h=0,u=r;u!==a;u+=n)for(c=s;c!==d;c+=l,h+=4)f=4*(c+o*u),g=255*e[h+3],t[f+2]=e[h]/g,t[f+1]=e[h+1]/g,t[f]=e[h+2]/g,t[f+3]=e[h+3];return t}function h(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==d;f+=l,u++)h=e[u],t[c=4*(f+o*g)]=h,t[c+1]=h,t[c+2]=h,t[c+3]=255;return t}function c(t,e,i,o,r,n,a,s,l,d){var h,c,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==d;f+=l,u+=2)h=e[u],t[c=4*(f+o*g)]=h,t[c+1]=h,t[c+2]=h,t[c+3]=e[u+1];return t}function u(t){var i=t.byteLength-e.FOOTER_SIZE,o=e.SIGNATURE,r={},n=new Uint8Array(t.buffer,i+8,o.length);return function(t){for(var i=e.SIGNATURE,o=0;o<i.length;o++)if(t.charCodeAt(o)!==i.charCodeAt(o))return!1;return!0}(String.fromCharCode.apply(null,n))?(r.hasFooter=!0,r.extensionOffset=t.getUint32(i,e.LITTLE_ENDIAN),r.developerOffset=t.getUint32(i+4,e.LITTLE_ENDIAN),r.hasExtensionArea=0!==r.extensionOffset,r.hasDeveloperArea=0!==r.developerOffset,r.extensionOffset&&(r.attributeType=t.getUint8(r.extensionOffset+494)),r):(r.hasFooter=!1,r)}e.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},e.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},e.HEADER_SIZE=18,e.FOOTER_SIZE=26,e.LITTLE_ENDIAN=!0,e.RLE_BIT=128,e.RLE_MASK=127,e.RLE_PACKET=1,e.RAW_PACKET=2,e.SIGNATURE="TRUEVISION-XFILE.\0",e.prototype.open=function(t,e){var i,o=this;(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(o.arrayBuffer=i.response,o.load(o.arrayBuffer),e&&e.call(o))},i.send(null)},e.prototype.load=function(t){var i=new DataView(t);this.headerData=new Uint8Array(t,0,e.HEADER_SIZE),this.header=function(t){var i=e.LITTLE_ENDIAN;if(t.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var o={};return o.idLength=t.getUint8(0),o.colorMapType=t.getUint8(1),o.imageType=t.getUint8(2),o.colorMapIndex=t.getUint16(3,i),o.colorMapLength=t.getUint16(5,i),o.colorMapDepth=t.getUint8(7),o.offsetX=t.getUint16(8,i),o.offsetY=t.getUint16(10,i),o.width=t.getUint16(12,i),o.height=t.getUint16(14,i),o.pixelDepth=t.getUint8(16),o.flags=t.getUint8(17),o}(i),o(this.header),r(this.header);var n=e.HEADER_SIZE;if((n+=this.header.idLength)>=t.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var a=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(t,n,a),n+=a}var s=this.header.pixelDepth>>3,l=this.header.width*this.header.height,d=l*s;if(this.header.hasEncoding){var h=t.byteLength-n-e.FOOTER_SIZE,c=new Uint8Array(t,n,h);this.imageData=function(t,i,o){var r,n,a,s,l,d,h;for(h=new Uint8Array(o),d=new Uint8Array(i),l=0,r=0;r<o;)if(a=1+((n=t[l++])&e.RLE_MASK),n&e.RLE_BIT){for(s=0;s<i;++s)d[s]=t[l++];for(s=0;s<a;++s)h.set(d,r),r+=i}else for(a*=i,s=0;s<a;++s)h[r++]=t[l++];if(r>o)throw new Error("Targa::decodeRLE() - Read bytes: "+r+" Expected bytes: "+o);return h}(c,s,d)}else this.imageData=new Uint8Array(t,n,this.header.hasColorMap?l:d);this.footer=u(i),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},e.prototype.getImageData=function(t){var i,o,r,u,f,g,p,v=this.header.width,y=this.header.height,m=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;switch(t||(t=document?document.createElement("canvas").getContext("2d").createImageData(v,y):{width:v,height:y,data:new Uint8ClampedArray(v*y*4)}),m===e.Origin.TOP_LEFT||m===e.Origin.TOP_RIGHT?(u=0,f=1,g=y):(u=y-1,f=-1,g=-1),m===e.Origin.TOP_LEFT||m===e.Origin.BOTTOM_LEFT?(i=0,o=1,r=v):(i=v-1,o=-1,r=-1),this.header.pixelDepth){case 8:p=this.header.isGreyColor?h:n;break;case 16:p=this.header.isGreyColor?c:a;break;case 24:p=s;break;case 32:p=this.footer.hasExtensionArea?3===this.footer.attributeType?l:4===this.footer.attributeType?d:s:0!==this.header.alphaBits?l:s}return p.call(this,t.data,this.imageData,this.palette,v,u,f,g,i,o,r),t},e.prototype.setImageData=function(t){if(!t)throw new Error("Targa::setImageData() - imageData argument missing");var i,o,r,n,a,s,d=this.header.width,h=this.header.height,c=d*h*(this.header.pixelDepth>>3),u=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;u===e.Origin.TOP_LEFT||u===e.Origin.TOP_RIGHT?(n=0,a=1,s=h):(n=h-1,a=-1,s=-1),u===e.Origin.TOP_LEFT||u===e.Origin.BOTTOM_LEFT?(i=0,o=1,r=d):(i=d-1,o=-1,r=-1),this.imageData||(this.imageData=new Uint8Array(c)),l(this.imageData,t.data,this.palette,d,n,a,s,i,o,r);var f=this.imageData;this.header.hasEncoding&&(f=function(t,i){for(var o,r,n,a,s=i,l=[],d=0,h=t.pixelDepth>>3,c=0,u=t.width*t.height*h,f=function(t,e){for(var i=0;i<h;i++)if(s[t*h+i]!==s[e*h+i])return!1;return!0},g=function(t){return f(t,t+1)?e.RLE_PACKET:e.RAW_PACKET};d*h<s.length&&d*h<u;){if(n=0,(r=g(d))===e.RLE_PACKET)for(;d+n<s.length&&n<128&&f(d,d+n);)n++;else for(;d+n<s.length&&n<128&&g(d+n)===e.RAW_PACKET;)n++;if(a=n-1,r===e.RLE_PACKET&&(a|=e.RLE_BIT),l[c++]=a,r===e.RLE_PACKET){for(o=0;o<h;o++)l[o+c]=s[o+d*h];c+=h}else{for(o=0;o<h*n;o++)l[o+c]=s[o+d*h];c+=h*n}d+=n}return new Uint8Array(l)}(this.header,f));var g=e.HEADER_SIZE+f.length+e.FOOTER_SIZE,p=new ArrayBuffer(g);this.arrayBuffer=p,this.headerData=new Uint8Array(p,0,e.HEADER_SIZE),this.RLEData=new Uint8Array(p,e.HEADER_SIZE,f.length),this.footerData=new Uint8Array(p,e.HEADER_SIZE+f.length,e.FOOTER_SIZE);var v,y,m,x=new DataView(this.headerData.buffer);v=this.header,y=x,m=e.LITTLE_ENDIAN,y.setUint8(0,v.idLength),y.setUint8(1,v.colorMapType),y.setUint8(2,v.imageType),y.setUint16(3,v.colorMapIndex,m),y.setUint16(5,v.colorMapLength,m),y.setUint8(7,v.colorMapDepth),y.setUint16(8,v.offsetX,m),y.setUint16(10,v.offsetY,m),y.setUint16(12,v.width,m),y.setUint16(14,v.height,m),y.setUint8(16,v.pixelDepth),y.setUint8(17,v.flags),this.RLEData.set(f),function(t){for(var i=e.SIGNATURE,o=t.byteLength-i.length,r=0;r<i.length;r++)t[o+r]=i.charCodeAt(r)}(this.footerData)},e.prototype.getCanvas=function(){var t,e,i;return i=(e=(t=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(i),0,0),t},e.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},e.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var t=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(t)};var f={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):f.exports="undefined"!=typeof window?window:t:f.exports=exports,f.exports&&(f.exports.TGA=e)}(this);var Mago3D=function(){var t={changeColor:function(t,e){var i=t.getProjectId(),o=t.getDataKey(),r=t.getObjectIds(),a=t.getProperty(),s=null,d=null;if(null!==a&&""!==a){var h=a.split("=");s=h[0],d=h[1]}var c=t.getColor();if(void 0!==c&&0!==c){var u=t.getColor().split(","),f=[u[0]/255,u[1]/255,u[2]/255],g=!1;null!==r&&0!==r.length&&(g=!0);var p=[];if(g)for(var v=0,y=r.length;v<y;v++){var m;(m=new n).setProjectId(i),m.setDataKey(o),m.setObjectId(r[v]),m.setProperty(a),m.setPropertyKey(s),m.setPropertyValue(d),m.setRgbColor(f),p.push(m)}else(m=new n).setProjectId(i),m.setDataKey(o),m.setObjectId(null),m.setProperty(a),m.setPropertyKey(s),m.setPropertyValue(d),m.setRgbColor(f),p.push(m);var x=p.length;for(v=0;v<x;v++)m=p[v],l.saveColorHistory(i,o,m.getObjectId(),m)}}},e={drawAppendData:function(t,e){e.getObjectIndexFile(t.getProjectId(),t.getProjectDataFolder())},drawInsertIssueImage:function(t,e){void 0!==e.objMarkerSC&&0!==t.getDrawType()||(e.objMarkerSC=new G,e.objMarkerSC.geoLocationData.geographicCoord=new R,Ai.calculateGeoLocationData(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation()),void 0,void 0,void 0,e.objMarkerSC.geoLocationData,e));var i=e.objMarkerManager.newObjectMarker();e.objMarkerSC.issue_id=t.getIssueId(),e.objMarkerSC.issue_type=t.getIssueType(),e.objMarkerSC.geoLocationData.geographicCoord.setLonLatAlt(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation())),i.copyFrom(e.objMarkerSC),e.objMarkerSC=void 0}},i={changeLocationAndRotation:function(t,e){var i=new n;i.setProjectId(t.getProjectId()),i.setDataKey(t.getDataKey()),i.setLatitude(parseFloat(t.getLatitude())),i.setLongitude(parseFloat(t.getLongitude())),i.setElevation(parseFloat(t.getElevation())),i.setHeading(parseFloat(t.getHeading())),i.setPitch(parseFloat(t.getPitch())),i.setRoll(parseFloat(t.getRoll())),e.changeLocationAndRotation(t.getProjectId(),t.getDataKey(),parseFloat(t.getLatitude()),parseFloat(t.getLongitude()),parseFloat(t.getElevation()),parseFloat(t.getHeading()),parseFloat(t.getPitch()),parseFloat(t.getRoll()),t.getAnimationOption())}},o={};function r(t){if(!(this instanceof r))throw new Error(j.CONSTRUCT_ERROR);this.magoEnable=!0,this.returnable=!1,this.apiName=t,this.projectId=null,this.projectDataFolder=null,this.objectIds=null,this.dataKey=null,this.issueId=null,this.issueType=null,this.drawType=0,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.property=null,this.color=0,this.blockType=null,this.showOutFitting=!1,this.showLabelInfo=!0,this.showOrigin=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarDistance=0,this.objectMoveMode=a.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.insertIssueState=0,this.lod0DistInMeters=null,this.lod1DistInMeters=null,this.lod2DistInMeters=null,this.lod3DistInMeters=null,this.lod4DistInMeters=null,this.lod5DistInMeters=null,this.ambientReflectionCoef=null,this.diffuseReflectionCoef=null,this.specularReflectionCoef=null,this.ambientColor=null,this.specularColor=null,this.ssaoRadius=null,this.FPVMode=!1,this.inputPoint=null,this.resultPoint=null,this.magoMode=a.magoMode.NORMAL,this.unit=a.units.DEGREE,this.instantiateObj=null,this.staticModelAttributeObj=null,this.animationOption=null,this.trackOption=null,this.nodeAttribute=null}o.changeLod=function(t,e){null!==t.getLod0DistInMeters()&&""!==t.getLod0DistInMeters()&&e.magoPolicy.setLod0DistInMeters(t.getLod0DistInMeters()),null!==t.getLod1DistInMeters()&&""!==t.getLod1DistInMeters()&&e.magoPolicy.setLod1DistInMeters(t.getLod1DistInMeters()),null!==t.getLod2DistInMeters()&&""!==t.getLod2DistInMeters()&&e.magoPolicy.setLod2DistInMeters(t.getLod2DistInMeters()),null!==t.getLod3DistInMeters()&&""!==t.getLod3DistInMeters()&&e.magoPolicy.setLod3DistInMeters(t.getLod3DistInMeters()),null!==t.getLod4DistInMeters()&&""!==t.getLod4DistInMeters()&&e.magoPolicy.setLod4DistInMeters(t.getLod4DistInMeters()),null!==t.getLod5DistInMeters()&&""!==t.getLod5DistInMeters()&&e.magoPolicy.setLod5DistInMeters(t.getLod5DistInMeters())},r.prototype.getMagoEnable=function(){return this.magoEnable},r.prototype.setMagoEnable=function(t){this.magoEnable=t},r.prototype.getReturnable=function(){return this.returnable},r.prototype.setReturnable=function(t){this.returnable=t},r.prototype.getAPIName=function(){return this.apiName},r.prototype.getProjectId=function(){return this.projectId},r.prototype.setProjectId=function(t){this.projectId=t},r.prototype.getProjectDataFolder=function(){return this.projectDataFolder},r.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},r.prototype.getObjectIds=function(){return this.objectIds},r.prototype.setObjectIds=function(t){this.objectIds=t},r.prototype.getIssueId=function(){return this.issueId},r.prototype.setIssueId=function(t){this.issueId=t},r.prototype.getIssueType=function(){return this.issueType},r.prototype.setIssueType=function(t){this.issueId=t},r.prototype.getDataKey=function(){return this.dataKey},r.prototype.setDataKey=function(t){this.dataKey=t},r.prototype.getLatitude=function(){return this.latitude},r.prototype.setLatitude=function(t){this.latitude=t},r.prototype.getLongitude=function(){return this.longitude},r.prototype.setLongitude=function(t){this.longitude=t},r.prototype.getElevation=function(){return this.elevation},r.prototype.setElevation=function(t){this.elevation=t},r.prototype.getHeading=function(){return this.heading},r.prototype.setHeading=function(t){this.heading=t},r.prototype.getPitch=function(){return this.pitch},r.prototype.setPitch=function(t){this.pitch=t},r.prototype.getRoll=function(){return this.roll},r.prototype.setRoll=function(t){this.roll=t},r.prototype.getProperty=function(){return this.property},r.prototype.setProperty=function(t){this.property=t},r.prototype.getColor=function(){return this.color},r.prototype.setColor=function(t){this.color=t},r.prototype.getBlockType=function(){return this.blockType},r.prototype.setBlockType=function(t){this.blockType=t},r.prototype.getShowOutFitting=function(){return this.showOutFitting},r.prototype.setShowOutFitting=function(t){this.showOutFitting=t},r.prototype.getShowLabelInfo=function(){return this.showLabelInfo},r.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},r.prototype.getShowOrigin=function(){return this.showOrigin},r.prototype.setShowOrigin=function(t){this.showOrigin=t},r.prototype.getShowBoundingBox=function(){return this.showBoundingBox},r.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},r.prototype.getShowShadow=function(){return this.showShadow},r.prototype.setShowShadow=function(t){this.showShadow=t},r.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},r.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},r.prototype.getObjectMoveMode=function(){return this.objectMoveMode},r.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},r.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},r.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},r.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},r.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},r.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},r.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},r.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},r.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},r.prototype.getInsertIssueState=function(){return this.insertIssueState},r.prototype.setInsertIssueState=function(t){this.insertIssueState=t},r.prototype.getDrawType=function(){return this.drawType},r.prototype.setDrawType=function(t){this.drawType=t},r.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},r.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},r.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},r.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},r.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},r.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},r.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},r.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},r.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},r.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},r.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},r.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},r.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},r.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},r.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},r.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},r.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},r.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},r.prototype.getAmbientColor=function(){return this.ambientColor},r.prototype.setAmbientColor=function(t){this.ambientColor=t},r.prototype.getSpecularColor=function(){return this.specularColor},r.prototype.setSpecularColor=function(t){this.specularColor=t},r.prototype.getSsaoRadius=function(){return this.ssaoRadius},r.prototype.setSsaoRadius=function(t){this.ssaoRadius=t},r.prototype.getFPVMode=function(){return this.FPVMode},r.prototype.setFPVMode=function(t){this.FPVMode=t},r.prototype.getMagoMode=function(){return this.magoMode},r.prototype.setMagoMode=function(t){this.magoMode=t},r.prototype.getDuration=function(){return this.duration},r.prototype.setDuration=function(t){this.duration=t},r.prototype.getInputPoint=function(){return this.inputPoint},r.prototype.setInputPoint=function(t){this.inputPoint=t},r.prototype.getResultPoint=function(){return this.resultPoint},r.prototype.setResultPoint=function(t){this.resultPoint=t},r.prototype.getUnit=function(){return this.unit},r.prototype.setUnit=function(t){if(void 0!==t){if(isNaN(t)||t>a.units.RADIAN)throw new Error("unit parameter needs CODE.units");this.unit=t}},r.prototype.getInstantiateObj=function(){return this.instantiateObj},r.prototype.setInstantiateObj=function(t){this.instantiateObj=t},r.prototype.getStaticModelAttributeObj=function(){return this.staticModelAttributeObj},r.prototype.setStaticModelAttributeObj=function(t){this.staticModelAttributeObj=t},r.prototype.getAnimationOption=function(){return this.animationOption},r.prototype.setAnimationOption=function(t){this.animationOption=t},r.prototype.getTrackOption=function(){return this.trackOption},r.prototype.setTrackOption=function(t){this.trackOption=t},r.prototype.getNodeAttribute=function(){return this.nodeAttribute},r.prototype.setNodeAttribute=function(t){this.nodeAttribute=t};var n=function(){if(!(this instanceof n))throw new Error(j.CONSTRUCT_ERROR);this.moveHistory=!1,this.colorHistory=!1,this.rotationHistory=!1,this.objectMoveMode=null,this.projectId=null,this.projectDataFolder=null,this.dataKey=null,this.objectId=null,this.objectIndexOrder=0,this.refObjectAditionalMove,this.refObjectAditionalMoveRelToBuilding,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.color=0,this.rgbColor=[],this.property=null,this.propertyKey=null,this.propertyValue=null};n.prototype.getReferenceObjectAditionalMovement=function(){return void 0===this.refObjectAditionalMove&&(this.refObjectAditionalMove=new Ce),this.refObjectAditionalMove},n.prototype.getReferenceObjectAditionalMovementRelToBuilding=function(){return void 0===this.refObjectAditionalMoveRelToBuilding&&(this.refObjectAditionalMoveRelToBuilding=new Ce),this.refObjectAditionalMoveRelToBuilding},n.prototype.getProjectId=function(){return this.projectId},n.prototype.setProjectId=function(t){this.projectId=t},n.prototype.getProjectDataFolder=function(){return this.projectDataFolder},n.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},n.prototype.getDataKey=function(){return this.dataKey},n.prototype.setDataKey=function(t){this.dataKey=t},n.prototype.getObjectId=function(){return this.objectId},n.prototype.setObjectId=function(t){this.objectId=t},n.prototype.getObjectIndexOrder=function(){return this.objectIndexOrder},n.prototype.setObjectIndexOrder=function(t){this.objectIndexOrder=t},n.prototype.getLatitude=function(){return this.latitude},n.prototype.setLatitude=function(t){this.latitude=t},n.prototype.getLongitude=function(){return this.longitude},n.prototype.setLongitude=function(t){this.longitude=t},n.prototype.getElevation=function(){return this.elevation},n.prototype.setElevation=function(t){this.elevation=t},n.prototype.getHeading=function(){return this.heading},n.prototype.setHeading=function(t){this.heading=t},n.prototype.getPitch=function(){return this.pitch},n.prototype.setPitch=function(t){this.pitch=t},n.prototype.getRoll=function(){return this.roll},n.prototype.setRoll=function(t){this.roll=t},n.prototype.getColor=function(){return this.color},n.prototype.setColor=function(t){this.color=t},n.prototype.getRgbColor=function(){return this.rgbColor},n.prototype.setRgbColor=function(t){this.rgbColor=t},n.prototype.getProperty=function(){return this.property},n.prototype.setProperty=function(t){this.property=t},n.prototype.getPropertyKey=function(){return this.propertyKey},n.prototype.setPropertyKey=function(t){this.propertyKey=t},n.prototype.getPropertyValue=function(){return this.propertyValue},n.prototype.setPropertyValue=function(t){this.propertyValue=t},n.prototype.getDuration=function(){return this.duration},n.prototype.setDuration=function(t){this.duration=t},n.prototype.getObjectMoveMode=function(){return this.objectMoveMode},n.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t};var a={magoManagerState:{INIT:0,STARTED:1,READY:2},fileLoadState:{READY:0,LOADING_STARTED:1,LOADING_FINISHED:2,PARSE_STARTED:3,PARSE_FINISHED:4,IN_QUEUE:5,LOAD_FAILED:6},moveMode:{ALL:"0",OBJECT:"1",GEOGRAPHICPOINTS:"2",NONE:"3"},magoMode:{NORMAL:0,DRAWING:1},modelerMode:{INACTIVE:0,DRAWING_POLYLINE:1,DRAWING_PLANEGRID:2,DRAWING_GEOGRAPHICPOINTS:3,DRAWING_EXCAVATIONPOINTS:4,DRAWING_TUNNELPOINTS:5,DRAWING_BSPLINE:6,DRAWING_BASICFACTORY:7,DRAWING_STATICGEOMETRY:8,DRAWING_PIPE:9},modelerDrawingState:{NO_STARTED:0,STARTED:1},modelerDrawingElement:{NOTHING:0,POINTS:1,LINES:2,POLYLINES:3,GEOGRAPHICPOINTS:4},units:{METRE:0,DEGREE:1,RADIAN:2},trackMode:{TRACKING:0,DRIVER:1},imageryType:{UNKNOWN:0,CRS84:1,WEB_MERCATOR:2},animationType:{UNKNOWN:0,REALTIME_POINTS:1,PATH:2},PROJECT_ID_PREFIX:"projectId_",PROJECT_DATA_FOLDER_PREFIX:"projectDataFolder_"},s={CESIUM:"cesium",WORLDWIND:"worldwind",MAGOWORLD:"magoworld",OBJECT_INDEX_FILE:"/objectIndexFile.ihe",CACHE_VERSION:"?cache_version=",SIMPLE_BUILDING_TEXTURE3x3_BMP:"/SimpleBuildingTexture3x3.bmp",RESULT_XDO2F4D:"/Result_xdo2f4d/Images/",RESULT_XDO2F4D_TERRAINTILES:"/Result_xdo2f4d/F4D_TerrainTiles/",RESULT_XDO2F4D_TERRAINTILEFILE_TXT:"/Result_xdo2f4d/f4dTerranTileFile.txt",INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4},l={getPolicy:function(){return this.serverPolicy},getData:function(t){return this.dataObject[t]},isDataExist:function(t){return this.dataObject.hasOwnProperty(t)},deleteData:function(t){return delete this.dataObject[t]},setData:function(t,e){this.isDataExist(t)||(this.dataObject[t]=e)},getProjectDataFolder:function(t){var e=a.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject[e]},isProjectDataFolderExist:function(t){var e=a.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject.hasOwnProperty(e)},deleteProjectDataFolder:function(t){var e=a.PROJECT_DATA_FOLDER_PREFIX+t;return delete this.dataObject[e]},setProjectDataFolder:function(t,e){var i=a.PROJECT_DATA_FOLDER_PREFIX+t;this.isProjectDataFolderExist(i)||(this.dataObject[i]=e)},init:function(t,e,i){if(this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.serverPolicy=t,null!==e&&e.length>0)for(var o=0;o<e.length;o++)this.isDataExist(a.PROJECT_ID_PREFIX+e[o])||(this.setData(a.PROJECT_ID_PREFIX+e[o],i[o]),this.setProjectDataFolder(a.PROJECT_DATA_FOLDER_PREFIX+i[o].data_key,i[o].data_key))},clearAllData:function(){this.dataObject={}},clearSelectHistory:function(){this.selectHistoryObject={}},getAllSelectHistory:function(){return this.selectHistoryObject},getSelectHistoryObjects:function(t,e){var i=this.selectHistoryObject[t];if(void 0!==i)return i[e]},getSelectHistoryObject:function(t,e,i){var o=this.selectHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return r[i]}},saveSelectHistory:function(t,e,i,o){var r=this.selectHistoryObject.get(t);void 0===r&&(r={},this.selectHistoryObject[t]=r);var n=r[e];void 0===n&&(n={},r[e]=n),n[i]=o},deleteSelectHistoryObject:function(t,e,i){var o=this.selectHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return delete r[i]}},clearMovingHistory:function(){this.movingHistoryObject={}},getAllMovingHistory:function(){return this.movingHistoryObject},getMovingHistoryObjects:function(t,e){var i=this.movingHistoryObject[t];if(void 0!==i)return i[e]},getMovingHistoryObject:function(t,e,i){var o=this.movingHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return r[i]}},saveMovingHistory:function(t,e,i,o){var r=this.movingHistoryObject[t];void 0===r&&(r={},this.movingHistoryObject[t]=r);var n=r[e];void 0===n&&(n={},r[e]=n),n[i]=o},deleteMovingHistoryObject:function(t,e,i){var o=this.movingHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return delete r[i]}},getAllColorHistory:function(){return this.colorHistoryObject},clearColorHistory:function(){this.colorHistoryObject={}},getColorHistorys:function(t,e){var i=this.colorHistoryObject[t];if(void 0!==i)return i[e]},getColorHistory:function(t,e,i){var o=this.colorHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return r[i]}},saveColorHistory:function(t,e,i,o){var r=this.colorHistoryObject[t];void 0===r&&(r={},this.colorHistoryObject[t]=r);var n=r[e];void 0===n&&(n={},r[e]=n),null===i||""===i?n[e]=o:n[i]=o},deleteColorHistory:function(t,e,i){var o=this.colorHistoryObject[t];if(void 0!==o){var r=o[e];if(void 0!==r)return delete r[i]}}};l.clearColorHistory=function(){this.colorHistoryObject={}},l.getAllLocationAndRotationHistory=function(){return this.locationAndRotationHistoryObject},l.getLocationAndRotationHistorys=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)return i[e]},l.getLocationAndRotationHistory=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)return i[e]},l.saveLocationAndRotationHistory=function(t,e,i){var o=this.locationAndRotationHistoryObject[t];void 0===o&&(o={},this.locationAndRotationHistoryObject[t]=o);var r=o[e];void 0===r&&(r={}),r[e]=i},l.deleteLocationAndRotationHistory=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)delete i[e]},l.clearLocationAndRotationHistory=function(){this.locationAndRotationHistoryObject={}};var d=function(){if(!(this instanceof d))throw new Error(j.CONSTRUCT_ERROR);this.magoEnable=!0,this.showOutFitting=!1,this.showLabelInfo=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarSquaredDistance=5e6,this.frustumFarDistance=2e4,this.highLightedBuildings=[],this.colorBuildings=[],this.color=[],this.hideBuildings=[],this.objectMoveMode=a.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.showOrigin=!1,this.magoMode=a.magoMode.NORMAL,this.imagePath="",this.colorChangedObjectId,this.lod0DistInMeters=15,this.lod1DistInMeters=50,this.lod2DistInMeters=90,this.lod3DistInMeters=200,this.lod4DistInMeters=1e3,this.lod5DistInMeters=5e4,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.ambientColor=null,this.specularColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=.15;var t=l.getPolicy();this.pointsCloudSettings={},xi(t)?(this.pointsCloudSettings.maxPartitionsLod0=mi(t.max_partitions_lod0,4),this.pointsCloudSettings.maxPartitionsLod1=mi(t.max_partitions_lod1,2),this.pointsCloudSettings.maxPartitionsLod2orLess=mi(t.max_partitions_lod2_or_less,1),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam0m=1/mi(t.max_per_unit_points_render_dist_to_cam_0m,10),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam100m=1/mi(t.max_per_unit_points_render_dist_to_cam_100m,120),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam200m=1/mi(t.max_per_unit_points_render_dist_to_cam_200m,240),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam400m=1/mi(t.max_per_unit_points_render_dist_to_cam_400m,480),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam800m=1/mi(t.max_per_unit_points_render_dist_to_cam_800m,960),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam1600m=1/mi(t.max_per_unit_points_render_dist_to_cam_1600m,1920),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCamMoreThan1600m=1/mi(t.max_per_unit_points_render_dist_to_cam_more_than_1600m,3840),this.pointsCloudSettings.maxPointSize=mi(t.max_point_size_for_pc,40),this.pointsCloudSettings.minPointSize=mi(t.min_point_size_for_pc,3),this.pointsCloudSettings.pendentPointSize=mi(t.pendent_point_size_for_pc,60),this.pointsCloudSettings.minHeightRainbow=mi(t.minHeight_rainbow_loc,0),this.pointsCloudSettings.maxHeightRainbow=mi(t.maxHeight_rainbow_loc,100)):(this.pointsCloudSettings.maxPartitionsLod0=4,this.pointsCloudSettings.maxPartitionsLod1=2,this.pointsCloudSettings.maxPartitionsLod2orLess=1,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam0m=.1,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam100m=1/120,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam200m=1/240,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam400m=1/480,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam800m=1/960,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam1600m=1/1920,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCamMoreThan1600m=1/3840,this.pointsCloudSettings.maxPointSize=40,this.pointsCloudSettings.minPointSize=3,this.pointsCloudSettings.pendentPointSize=60,this.pointsCloudSettings.minHeightRainbow=0,this.pointsCloudSettings.maxHeightRainbow=100)};d.prototype.getPointsCloudSettings=function(){return this.pointsCloudSettings},d.prototype.getShowOrigin=function(){return this.showOrigin},d.prototype.setShowOrigin=function(t){this.showOrigin=t},d.prototype.getMagoEnable=function(){return this.magoEnable},d.prototype.setMagoEnable=function(t){this.magoEnable=t},d.prototype.getShowOutFitting=function(){return this.showOutFitting},d.prototype.setShowOutFitting=function(t){this.showOutFitting=t},d.prototype.getShowLabelInfo=function(){return this.showLabelInfo},d.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},d.prototype.getShowBoundingBox=function(){return this.showBoundingBox},d.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},d.prototype.getShowShadow=function(){return this.showShadow},d.prototype.setShowShadow=function(t){this.showShadow=t},d.prototype.getFrustumFarSquaredDistance=function(){return this.frustumFarSquaredDistance},d.prototype.setFrustumFarSquaredDistance=function(t){this.frustumFarSquaredDistance=t},d.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},d.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},d.prototype.getHighLightedBuildings=function(){return this.highLightedBuildings},d.prototype.setHighLightedBuildings=function(t){this.highLightedBuildings=t},d.prototype.getColorBuildings=function(){return this.colorBuildings},d.prototype.setColorBuildings=function(t){this.colorBuildings=t},d.prototype.getColor=function(){return this.color},d.prototype.setColor=function(t){this.color=t},d.prototype.getHideBuildings=function(){return this.hideBuildings},d.prototype.setHideBuildings=function(t){this.hideBuildings=t},d.prototype.getObjectMoveMode=function(){return this.objectMoveMode},d.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},d.prototype.getMagoMode=function(){return this.magoMode},d.prototype.setMagoMode=function(t){this.magoMode=t},d.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},d.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},d.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},d.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},d.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},d.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},d.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},d.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},d.prototype.getImagePath=function(){return this.imagePath},d.prototype.setImagePath=function(t){this.imagePath=t},d.prototype.getLod=function(t){return t<this.lod0DistInMeters?0:t<this.lod1DistInMeters?1:t<this.lod2DistInMeters?2:t<this.lod3DistInMeters?3:t<this.lod4DistInMeters?4:5},d.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},d.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},d.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},d.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},d.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},d.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},d.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},d.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},d.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},d.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},d.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},d.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},d.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},d.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},d.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},d.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},d.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},d.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},d.prototype.getAmbientColor=function(){return this.ambientColor},d.prototype.setAmbientColor=function(t){this.ambientColor=t},d.prototype.getSpecularColor=function(){return this.specularColor},d.prototype.setSpecularColor=function(t){this.specularColor=t},d.prototype.getSsaoRadius=function(){return this.ssaoRadius},d.prototype.setSsaoRadius=function(t){this.ssaoRadius=t};var h=function(){if(!(this instanceof h))throw new Error(j.CONSTRUCT_ERROR);this.animationType=a.animationType.UNKNOWN,this.birthTime,this.lastTime,this.durationInSeconds,this.path,this.startLongitude,this.startLatitude,this.startAltitude,this.targetLongitude,this.targetLatitude,this.targetAltitude,this.targetHeading,this.targetPitch,this.targetRoll,this.linearVelocityInMetersSecond,this.headingAngDegSecondVelocity,this.pitchAngDegSecondVelocity,this.rollAngDegSecondVelocity},c=function(){if(!(this instanceof c))throw new Error(j.CONSTRUCT_ERROR);this.nodesMap};c.prototype.putNode=function(t){void 0===this.nodesMap&&(this.nodesMap={});var e=t.data.nodeId;this.nodesMap[e]=t},c.prototype.checkAnimation=function(t){if(void 0!==this.nodesMap)for(var e in this.nodesMap)Object.prototype.hasOwnProperty.call(this.nodesMap,e)&&this.nodesMap[e].finishedAnimation(t)&&delete this.nodesMap[e]},c.getNextPosition=function(t,e,i){return void 0===t||(t.animationType===a.animationType.PATH?c.getNextPositionByPath(t,e,i):void 0)},c.getNextPositionByPath=function(t,e,i){if(void 0===t)return!0;var o=t.path;if(void 0===o)return!0;void 0===t.linearVelocityInMetersSecond&&(t.linearVelocityInMetersSecond=20);var r=t.linearVelocityInMetersSecond*((e-t.birthTime)/1e3);return ge.prototype.isPrototypeOf(o)?o.getTangent(r,void 0,i):void 0};var u=function(){if(!(this instanceof u))throw new Error(j.CONSTRUCT_ERROR);this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};u.prototype.init=function(t){t=t||new Ce,this.minX=t.x,this.minY=t.y,this.minZ=t.z,this.maxX=t.x,this.maxY=t.y,this.maxZ=t.z},u.prototype.set=function(t,e,i,o,r,n){this.minX=t,this.minY=e,this.minZ=i,this.maxX=o,this.maxY=r,this.maxZ=n},u.prototype.deleteObjects=function(){this.minX=void 0,this.minY=void 0,this.minZ=void 0,this.maxX=void 0,this.maxY=void 0,this.maxZ=void 0},u.prototype.copyFrom=function(t){this.minX=t.minX,this.minY=t.minY,this.minZ=t.minZ,this.maxX=t.maxX,this.maxY=t.maxY,this.maxZ=t.maxZ},u.prototype.translateToOrigin=function(){var t=this.getXLength()/2,e=this.getYLength()/2,i=this.getZLength()/2;this.minX=-t,this.minY=-e,this.minZ=-i,this.maxX=t,this.maxY=e,this.maxZ=i},u.prototype.expand=function(t){t=t||0,t=Math.abs(t),this.minX-=t,this.minY-=t,this.minZ-=t,this.maxX+=t,this.maxY+=t,this.maxZ+=t},u.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y),t.z<this.minZ?this.minZ=t.z:t.z>this.maxZ&&(this.maxZ=t.z))},u.prototype.addBox=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY),t.minZ<this.minZ&&(this.minZ=t.minZ),t.maxZ>this.maxZ&&(this.maxZ=t.maxZ))},u.prototype.getMinLength=function(){return Math.min(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},u.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},u.prototype.getXLength=function(){return this.maxX-this.minX},u.prototype.getYLength=function(){return this.maxY-this.minY},u.prototype.getZLength=function(){return this.maxZ-this.minZ},u.prototype.getCenterPoint=function(t){return void 0===t&&(t=new Ce),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),t},u.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},u.prototype.intersectWithPoint=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.y<this.minY||t.y>this.maxY||t.z<this.minZ||t.z>this.maxZ)},u.prototype.isPoint3dInside=function(t,e,i){return!(t<this.minX||t>this.maxX)&&(!(e<this.minY||e>this.maxY)&&!(i<this.minZ||i>this.maxZ))},u.prototype.intersectWithBox=function(t){return void 0!==t&&!(t.minX>this.maxX||t.maxX<this.minX||t.minY>this.maxY||t.maxY<this.minY||t.minZ>this.maxZ||t.maxZ<this.minZ)},u.prototype.intersectsWithBBox=function(t){var e=!0;return this.maxX<t.minX?e=!1:this.minX>t.maxX?e=!1:this.maxY<t.minY?e=!1:this.minY>t.maxY?e=!1:this.maxZ<t.minZ?e=!1:this.minZ>t.maxZ&&(e=!1),e};var f=function(){if(!(this instanceof f))throw new Error(j.CONSTRUCT_ERROR);this.center=new Ce,this.radius=0},g=function(){if(!(this instanceof g))throw new Error(j.CONSTRUCT_ERROR);this.fisrtName,this.name="",this.buildingId,this.buildingFileName,this.geographicCoord,this.rotationsDegree,this.bBox,this.geographicCoordOfBBox,this.smartTileOwner};g.prototype.deleteObjects=function(){this.fisrtName=void 0,this.name=void 0,this.buildingId=void 0,this.buildingFileName=void 0,this.geographicCoord.deleteObjects(),this.rotationsDegree.deleteObjects(),this.bBox.deleteObjects(),this.geographicCoordOfBBox.deleteObjects(),this.geographicCoord=void 0,this.rotationsDegree=void 0,this.bBox=void 0,this.geographicCoordOfBBox=void 0};var p=function(){if(!(this instanceof p))throw new Error(j.CONSTRUCT_ERROR);this.buildingSeedArray=[],this.minGeographicCoord,this.maxGeographicCoord,this.dataArrayBuffer};p.prototype.deleteObjects=function(){if(this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.buildingSeedArray){for(var t=this.buildingSeedArray.length,e=0;e<t;e++)this.buildingSeedArray[e].deleteObjects(),this.buildingSeedArray[e]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},p.prototype.newBuildingSeed=function(){var t=new g;return this.buildingSeedArray.push(t),t},p.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var t,e,i,o,r=this.dataArrayBuffer,n=0,a=new Int32Array(r.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=this.newBuildingSeed();void 0===l.geographicCoord&&(l.geographicCoord=new R),void 0===l.bBox&&(l.bBox=new u),t=new Int32Array(r.slice(n,n+4))[0],n+=4;var d=new TextDecoder("utf-8").decode(new Uint8Array(r.slice(n,n+t)));n+=t,e=new Float64Array(r.slice(n,n+8))[0],n+=8,i=new Float64Array(r.slice(n,n+8))[0],n+=8,o=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(r.slice(n,n+4))[0],n+=4,l.buildingId=d.substr(4,t-4),l.buildingFileName=d,l.geographicCoord.setLonLatAlt(e,i,o)}return!0},p.prototype.getBuildingSeedLength=function(){return this.buildingSeedArray.length},p.prototype.getBuildingSeed=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("idx is required to be a string or number.");if(!this.buildingSeedArray[t])throw new Error("range over.");return this.buildingSeedArray[t]};var v=function(){if(!(this instanceof v))throw new Error(j.CONSTRUCT_ERROR);this.position=new Ce,this.direction=new Ce,this.up=new Ce,this.right=new Ce,this.frustum=new w,this.bigFrustum=new w,this.dirty=!0,this.frustumsArray=[],this.frustumsArray.push(this.frustum),this.nearCenterPoint=new Ce,this.farCenterPoint=new Ce,this.farLeftBottomPoint=new Ce,this.farRightTopPoint=new Ce,this.leftBottomDir=new Ce,this.rightTopDir=new Ce,this.leftNormal=new Ce,this.rightNormal=new Ce,this.bottomNormal=new Ce,this.topNormal=new Ce,this.tracked,this.trackType=a.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12};v.prototype.copyPosDirUpFrom=function(t){this.position.copyFrom(t.position),this.direction.copyFrom(t.direction),this.up.copyFrom(t.up)},v.prototype.translate=function(t){this.position.add(t.x,t.y,t.z)},v.prototype.transformByMatrix4=function(t){this.position=t.transformPoint3D(this.position,this.position),this.direction=t.rotatePoint3D(this.direction,this.direction),this.up=t.rotatePoint3D(this.up,this.up)},v.prototype.getCameraDirectionLine=function(t){return void 0===t&&(t=new se),t.point.set(this.position.x,this.position.y,this.position.z),t.direction.set(this.direction.x,this.direction.y,this.direction.z),t},v.prototype.getCameraElevation=function(){var t,e=(t=F.CartesianToGeographicWgs84(this.position.x,this.position.y,this.position.z,t)).latitude;return this.position.getModul()-F.radiusAtLatitudeDeg(e)},v.prototype.getCameraRight=function(){return void 0===this.right&&(this.right=new Ce),this.right=this.direction.crossProduct(this.up,this.right),this.right},v.prototype.transformPoint3DByMatrix4=function(t,e){var i=glMatrix.vec3.clone([t.x,t.y,t.z]),o=glMatrix.vec3.create();return o=glMatrix.vec3.transformMat4(o,i,e),t.set(o[0],o[1],o[2]),t},v.prototype.rotatePoint3DByMatrix3=function(t,e){var i=glMatrix.vec3.clone([t.x,t.y,t.z]),o=glMatrix.vec3.create();return o=glMatrix.vec3.transformMat3(o,i,e),t.set(o[0],o[1],o[2]),t},v.prototype.setDirty=function(t){this.dirty=t},v.prototype.getDirty=function(){return this.dirty},v.prototype.isCameraMoved=function(t,e,i,o,r,n,a,s,l){var d=this.position;if(Math.abs(d.x-t)>.001||Math.abs(d.y-e)>.001||Math.abs(d.z-i)>.001)return!0;var h=this.direction;if(Math.abs(h.x-o)>.001||Math.abs(h.y-r)>.001||Math.abs(h.z-n)>1e-5)return!0;var c=this.up;return Math.abs(c.x-a)>.001||Math.abs(c.y-s)>.001||Math.abs(c.z-l)>1e-5},v.prototype.getFrustum=function(t){return void 0===this.frustumsArray[t]&&(this.frustumsArray[t]=new w,this.frustumsArray[t].fovRad[0]=this.frustumsArray[0].fovRad[0],this.frustumsArray[t].fovyRad[0]=this.frustumsArray[0].fovyRad[0],this.frustumsArray[t].aspectRatio[0]=this.frustumsArray[0].aspectRatio[0],this.frustumsArray[t].tangentOfHalfFovy[0]=this.frustumsArray[0].tangentOfHalfFovy[0]),this.frustumsArray[t]},v.prototype.getLastFrustum=function(){return this.getFrustum(this.frustumsArray.length-1)},v.prototype.setFrustumsDistances=function(t,e){for(var i,o=0;o<t;o++)e[o],(i=this.getFrustum(o)).near[0]=e[2*o],i.far[0]=e[2*o+1],0===o&&(this.bigFrustum.near[0]=e[2*o]),o===t-1&&(this.bigFrustum.far[0]=e[2*o+1])},v.prototype.setAspectRatioAndFovyRad=function(t,e){var i,o;(o=this.getFrustum(0)).aspectRatio[0]=t,o.fovyRad[0]=e,o.fovRad[0]=e*t,o.tangentOfHalfFovy[0]=Math.tan(e/2);for(var r=this.frustumsArray.length,n=1;n<r;n++)(i=this.getFrustum(n)).aspectRatio[0]=o.aspectRatio[0],i.fovyRad[0]=o.fovyRad[0],i.fovRad[0]=o.fovRad[0],i.tangentOfHalfFovy[0]=o.tangentOfHalfFovy[0];this.bigFrustum.aspectRatio[0]=o.aspectRatio[0],this.bigFrustum.fovyRad[0]=o.fovyRad[0],this.bigFrustum.fovRad[0]=o.fovRad[0],this.bigFrustum.tangentOfHalfFovy[0]=o.tangentOfHalfFovy[0]},v.prototype.setCurrentFrustum=function(t){this.frustum=this.getFrustum(t)},v.prototype.bindUniforms=function(t,e){var i=this.frustum;t.uniform1f(e.frustumNear_loc,i.near[0]),t.uniform1f(e.frustumFar_loc,i.far[0])},v.prototype.calculateFrustumsPlanes=function(){var t,e,i=(t=this.getFrustum(0)).tangentOfHalfFovy*t.near*2,o=t.tangentOfHalfFovy*t.far*2,r=(t.aspectRatio[0],o*t.aspectRatio[0]),n=this.position.x,a=this.position.y,s=this.position.z,l=this.direction.x,d=this.direction.y,h=this.direction.z;this.right=this.direction.crossProduct(this.up,this.right),this.nearCenterPoint.set(n+l*t.near,a+d*t.near,s+h*t.near),this.farCenterPoint.set(n+l*t.far,a+d*t.far,s+h*t.far),this.farLeftBottomPoint.set(this.farCenterPoint.x-this.right.x*r*.5-this.up.x*o*.5,this.farCenterPoint.y-this.right.y*r*.5-this.up.y*o*.5,this.farCenterPoint.z-this.right.z*r*.5-this.up.z*o*.5),this.farRightTopPoint.set(this.farLeftBottomPoint.x+this.right.x*r+this.up.x*o,this.farLeftBottomPoint.y+this.right.y*r+this.up.y*o,this.farLeftBottomPoint.z+this.right.z*r+this.up.z*o),this.leftBottomDir.set(this.farLeftBottomPoint.x-n,this.farLeftBottomPoint.y-a,this.farLeftBottomPoint.z-s),this.leftBottomDir.unitary(),this.rightTopDir.set(this.farRightTopPoint.x-n,this.farRightTopPoint.y-a,this.farRightTopPoint.z-s),this.rightTopDir.unitary(),t.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,d,h),t.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-d,-h),this.leftNormal=this.leftBottomDir.crossProduct(this.up,this.leftNormal),this.leftNormal.unitary(),t.planesArray[2].setPointAndNormal(n,a,s,this.leftNormal.x,this.leftNormal.y,this.leftNormal.z),this.bottomNormal=this.right.crossProduct(this.leftBottomDir,this.bottomNormal),this.bottomNormal.unitary(),t.planesArray[3].setPointAndNormal(n,a,s,this.bottomNormal.x,this.bottomNormal.y,this.bottomNormal.z),this.rightNormal=this.up.crossProduct(this.rightTopDir,this.rightNormal),this.rightNormal.unitary(),t.planesArray[4].setPointAndNormal(n,a,s,this.rightNormal.x,this.rightNormal.y,this.rightNormal.z),this.topNormal=this.rightTopDir.crossProduct(this.right,this.topNormal),this.topNormal.unitary(),t.planesArray[5].setPointAndNormal(n,a,s,this.topNormal.x,this.topNormal.y,this.topNormal.z);for(var c=this.frustumsArray.length,u=1;u<c;u++){e=this.getFrustum(u),this.nearCenterPoint.set(n+l*e.near,a+d*e.near,s+h*e.near),this.farCenterPoint.set(n+l*e.far,a+d*e.far,s+h*e.far),e.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,d,h),e.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-d,-h);for(var f=2;f<6;f++)e.planesArray[f]=t.planesArray[f]}this.nearCenterPoint.set(n+l*this.bigFrustum.near,a+d*this.bigFrustum.near,s+h*this.bigFrustum.near),this.farCenterPoint.set(n+l*this.bigFrustum.far,a+d*this.bigFrustum.far,s+h*this.bigFrustum.far),this.bigFrustum.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,d,h),this.bigFrustum.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-d,-h);for(this.getLastFrustum(),f=2;f<6;f++)this.bigFrustum.planesArray[f]=t.planesArray[f]},v.prototype.doTrack=function(t){if(this.tracked){var e=this.tracked;if(l.getPolicy().geo_view_library===s.CESIUM){var i,o=t.scene.camera,r=o.positionWC,n=e.getNodeGeoLocDataManager();if(void 0===n)return;var d=n.getCurrentGeoLocationData();if(void 0===d)return;var h=n.getGeoLocationData(1);if(xi(h)){var c=d.position,u=h.position,f=c.x-u.x,g=c.y-u.y,p=c.z-u.z;(i=new Cesium.Cartesian3).x=r.x+f,i.y=r.y+g,i.z=r.z+p}var y=d.getGeographicCoords();if(void 0===y)return;var m=Cesium.Cartesian3.fromDegrees(y.longitude,y.latitude,y.altitude);if(this.trackType===a.trackMode.TRACKING){var x=Cesium.Cartesian3.distance(i||r,m),b=new Cesium.HeadingPitchRange(o.heading,o.pitch,x);o.lookAt(m,b)}else{var C=d.rotMatrix,A=C.rotatePoint3D(new Ce(0,this.targetOffset,0)),M=C.rotatePoint3D(new Ce(0,this.trackCameraOffsetY,this.trackCameraOffsetZ));M.x=m.x+M.x,M.y=m.y+M.y,M.z=m.z+M.z,A.x=m.x+A.x,A.y=m.y+A.y,A.z=m.z+A.z;var P=d.geoLocMatrix._floatArrays,T=new Ce(P[8],P[9],P[10]);v.setByPositionAndTarget(o,A,M,T)}}}},v.prototype.stopTrack=function(t){this.tracked=void 0,l.getPolicy().geo_view_library===s.CESIUM&&t.scene.camera.lookAtTransform(Cesium.Matrix4.IDENTITY)},v.prototype.setTrack=function(t,e){this.initTrackOption(),this.tracked=t,e&&(this.trackType=mi(e.type,this.trackType),this.targetOffset=mi(e.targetOffset,this.targetOffset),e.trackCameraOffset&&(this.trackCameraOffsetY=mi(e.trackCameraOffset.y,this.trackCameraOffsetY),this.trackCameraOffsetZ=mi(e.trackCameraOffset.z,this.trackCameraOffsetZ)))},v.prototype.initTrackOption=function(){this.trackType=a.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12},v.prototype.getDirection=function(){},v.setByPositionAndTarget=function(t,e,i,o){var r=new Ce;r.set(e.x-i.x,e.y-i.y,e.z-i.z),r.unitary();var n=r.crossProduct(o).crossProduct(r);n.unitary(),t.setView({destination:i,orientation:{direction:new Cesium.Cartesian3(r.x,r.y,r.z),up:new Cesium.Cartesian3(n.x,n.y,n.z)}})};var y,m=function(t){if(!(this instanceof m))throw new Error(j.CONSTRUCT_ERROR);this.name="noName",void 0!==t&&(this.name=t),this.geoLocationData=new E,this.minHeading=0,this.maxHeading=90,this.heading=0,this.pitch=0,this.roll=0,this.targetHeading,this.targetPitch,this.targetRoll,this.rotMat=new B,this.camera=new v,this.vboKeyContainer,this.vboKeyContainerEdges,this.color=new x,this.color.setRGBA(0,.5,.9,.3),this.greenFactorSpeed=1,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.headingAngularSpeed=25,this.pitchAngularSpeed,this.rollAngularSpeed,this.lastTime,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1};m.prototype.updateTime=function(t){this.lastTime=t},m.prototype.setOrientation=function(t,e,i,o){if(this.targetHeading=t,this.targetPitch=e,this.targetRoll=i,void 0!==this.targetHeading){var r=this.targetHeading-this.heading;this.headingAngularSpeed=r/o,0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)}if(void 0!==this.targetPitch){var n=this.targetPitch-this.pitch;this.pitchAngularSpeed=n/o,0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=void 0)}if(void 0!==this.targetRoll){var a=this.targetRoll-this.roll;this.rollAngularSpeed=a/o,0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)}},m.prototype.updateOrientation=function(t){if(void 0!==this.targetHeading||void 0!==this.targetPitch||void 0!==this.targetRoll){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0!==this.headingAngularSpeed&&(this.heading+=e*this.headingAngularSpeed,this.headingAngularSpeed>0?this.heading>=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0):this.heading<=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0),0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)),void 0!==this.pitchAngularSpeed&&(this.pitch+=e*this.pitchAngularSpeed,this.pitchAngularSpeed>0?this.pitch>=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0):this.pitch<=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0),0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=0)),void 0!==this.rollAngularSpeed&&(this.roll+=e*this.rollAngularSpeed,this.rollAngularSpeed>0?this.roll>=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0):this.roll<=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0),0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)),this.calculateRotationMatrix()}},m.prototype.updateHeading=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;this.heading+=e*this.headingAngularSpeed,this.heading>this.maxHeading?(this.heading=this.maxHeading,this.headingAngularSpeed*=-1):this.heading<this.minHeading&&(this.heading=this.minHeading,this.headingAngularSpeed*=-1),this.calculateRotationMatrix()},m.prototype.updateColor=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.greenFactor+=this.greenFactorSpeed*e,this.blueFactor+=this.blueFactorSpeed*e,this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1),this.greenFactor<0&&(this.greenFactor=0,this.greenFactorSpeed*=-1),this.blueFactor>.9&&(this.blueFactor=.9,this.blueFactorSpeed*=-1),this.blueFactor<0&&(this.blueFactor=0,this.blueFactorSpeed*=-1),this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1),this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.color.setRGBA(0,this.greenFactor,this.blueFactor,this.alphaFactor)},m.prototype.calculateRotationMatrix=function(){var t;t=B.getRotationDegZXYMatrix(this.heading,this.pitch,this.roll,t),this.rotMat=t.getMultipliedByMatrix(this.geoLocationData.rotMatrix,this.rotMat)},m.prototype.getVbo=function(t,e,i){var o;void 0===t&&(t=new ft),void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new ft),o=this.makeFrustumGeometry_2(o);var r=new B,n=this.camera.bigFrustum.fovyRad/2;r.rotationAxisAngDeg(180*-n/Math.PI,1,0,0);var a=o.getSurfaceIndependentMesh(void 0,!0,!0);return a.transformByMatrix4(r),a.setColor(0,.5,.9,.3),a.getVbo(t,i),a.getVboEdges(this.vboKeyContainerEdges,i),t},m.prototype.render=function(t,e,i){if(void 0!==this.vboKeyContainer){var o;this.vboKeyContainer.vboCacheKeysArray.length;t.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.geoLocationData.rotMatrix._floatArrays),t.uniform3fv(i.buildingPosHIGH_loc,this.geoLocationData.positionHIGH),t.uniform3fv(i.buildingPosLOW_loc,this.geoLocationData.positionLOW),t.uniform1i(i.hasTexture_loc,!1),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(1,3);t.uniform1i(i.refMatrixType_loc,2),t.uniformMatrix4fv(i.refMatrix_loc,!1,this.rotMat._floatArrays);var r=e.renderer;o=!0,r.renderNormals=!1,t.uniform4fv(i.oneColor4_loc,[0,0,0,1]),r.renderVboContainer(t,this.vboKeyContainerEdges,e,i,o),t.enable(t.BLEND),o=!1,r.renderNormals=!0,t.uniform4fv(i.oneColor4_loc,[this.blueFactor,0,0,this.alphaFactor]),r.renderVboContainer(t,this.vboKeyContainer,e,i,o),t.disable(t.BLEND),t.disable(t.POLYGON_OFFSET_FILL)}},m.prototype.makeFrustumGeometry_2=function(t){void 0===t&&(t=new fe),t.profile=new _e;var e,i,o=t.profile,r=this.camera.bigFrustum,n=r.far,a=r.fovyRad/2,s=r.fovRad/2,l=(Math.tan(s),Math.tan(a),o.newOuterRing());(e=l.newElement("POLYLINE")).newPoint2d(-n*Math.sin(s),n*Math.cos(s)),e.newPoint2d(0,0),e.newPoint2d(n*Math.sin(s),n*Math.cos(s));var d,h,c=90-180*s/Math.PI,u=90+180*s/Math.PI;i=l.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(n),i.setStartAngleDegree(c),i.setSweepAngleDegree(u-c),i.numPointsFor360Deg=36,d=2*a*180/Math.PI,h=new De;var f=new me(-1,0),g=new me(1,0);return h.setPoints(f,g),6,t.revolve(o,d,6,h),t},m.prototype.makeFrustumGeometry=function(t){void 0===t&&(t=new ce),void 0===t.hedgesList&&(t.hedgesList=new re);var e,i,o,r,n,a,s=new Ce(0,0,0),l=this.camera.bigFrustum,d=l.far,h=l.fovyRad/2,c=l.fovRad/2,u=-d*Math.tan(c),f=-u,g=d*Math.tan(h),p=-g,v=new Ce(u,p,-d),y=new Ce(f,p,-d),m=new Ce(f,g,-d),x=new Ce(u,g,-d),b=new ke(s),C=new ke(v),A=new ke(y),M=new ke(m),P=new ke(x);void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new ft),(e=t.newSurface().newFace()).addVertex(C),e.addVertex(P),e.addVertex(M),e.addVertex(A);for(var T=0,_=[],w=[],S=e.vertexArray.length,R=0;R<S;R++)i=e.vertexArray[R],a=ze.getNextIdx(R,e.vertexArray),o=e.vertexArray[a],r=i.point3d,n=o.point3d,_.push(r.x),_.push(r.y),_.push(r.z),_.push(n.x),_.push(n.y),_.push(n.z),w.push(T),T++,w.push(T),T++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(M),e.addVertex(P),S=e.vertexArray.length;for(R=0;R<S;R++)i=e.vertexArray[R],a=ze.getNextIdx(R,e.vertexArray),o=e.vertexArray[a],r=i.point3d,n=o.point3d,_.push(r.x),_.push(r.y),_.push(r.z),_.push(n.x),_.push(n.y),_.push(n.z),w.push(T),T++,w.push(T),T++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(P),e.addVertex(C),S=e.vertexArray.length;for(R=0;R<S;R++)i=e.vertexArray[R],a=ze.getNextIdx(R,e.vertexArray),o=e.vertexArray[a],r=i.point3d,n=o.point3d,_.push(r.x),_.push(r.y),_.push(r.z),_.push(n.x),_.push(n.y),_.push(n.z),w.push(T),T++,w.push(T),T++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(C),e.addVertex(A),S=e.vertexArray.length;for(R=0;R<S;R++)i=e.vertexArray[R],a=ze.getNextIdx(R,e.vertexArray),o=e.vertexArray[a],r=i.point3d,n=o.point3d,_.push(r.x),_.push(r.y),_.push(r.z),_.push(n.x),_.push(n.y),_.push(n.z),w.push(T),T++,w.push(T),T++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(A),e.addVertex(M),S=e.vertexArray.length;for(R=0;R<S;R++)i=e.vertexArray[R],a=ze.getNextIdx(R,e.vertexArray),o=e.vertexArray[a],r=i.point3d,n=o.point3d,_.push(r.x),_.push(r.y),_.push(r.z),_.push(n.x),_.push(n.y),_.push(n.z),w.push(T),T++,w.push(T),T++;var L=this.vboKeyContainerEdges.newVBOVertexIdxCacheKey();return L.posVboDataArray=Float32Array.from(_),L.idxVboDataArray=Int16Array.from(w),L.indicesCount=L.idxVboDataArray.length,t.calculateVerticesNormals(),t},(y=function(){if(!(this instanceof y))throw new Error(j.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new m;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},y.prototype.getCCTV=function(t){return this.camerasList[t]},y.prototype.getCCTVByName=function(t){for(var e,i,o=!1,r=this.getCCTVCount(),n=0;!o&&n<r;)(e=this.getCCTV(n)).name===t&&(i=e,o=!0),n++;return i},y.prototype.getCCTVCount=function(){return this.camerasList.length},y.prototype.render=function(t,e){var i=this.getCCTVCount();if(0!==i){var o=t.sceneState.gl;e.resetLastBuffersBinded();var r=e.program;o.useProgram(r),o.uniform1i(e.bApplySpecularLighting_loc,!1),o.disableVertexAttribArray(e.texCoord2_loc),o.enableVertexAttribArray(e.position3_loc),o.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),o.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),o.uniform1i(e.colorType_loc,0),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.depthFboNeo.colorBuffer),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.noiseTexture),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<i;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(o,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}},(y=function(){if(!(this instanceof y))throw new Error(j.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new m;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},y.prototype.getCCTV=function(t){return this.camerasList[t]},y.prototype.getCCTVByName=function(t){for(var e,i,o=!1,r=this.getCCTVCount(),n=0;!o&&n<r;)(e=this.getCCTV(n)).name===t&&(i=e,o=!0),n++;return i},y.prototype.getCCTVCount=function(){return this.camerasList.length},y.prototype.render=function(t,e){var i=this.getCCTVCount();if(0!==i){var o=t.sceneState.gl;e.resetLastBuffersBinded();var r=e.program;o.useProgram(r),o.uniform1i(e.bApplySpecularLighting_loc,!1),o.disableVertexAttribArray(e.texCoord2_loc),o.enableVertexAttribArray(e.position3_loc),o.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),o.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),o.uniform1i(e.colorType_loc,0),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.depthFboNeo.colorBuffer),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.noiseTexture),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<i;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(o,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}};var x=function(){if(!(this instanceof x))throw new Error(j.CONSTRUCT_ERROR);this.r=0,this.g=0,this.b=0,this.a=1};x.grayToRGB_MagoStyle=function(t,e){var i,o,r;return void 0===e&&(e=new x),t>1?t=1:t<0&&(t=0),i=1-t,o=t>.5?2*-t+2:2*t,r=t,e.setRGB(i,o,r),e},x.prototype.copyFrom=function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},x.prototype.deleteObjects=function(){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0},x.prototype.set=function(t,e,i,o){this.r=t,this.g=e,this.b=i,this.a=o},x.prototype.setRGB=function(t,e,i){this.r=t,this.g=e,this.b=i},x.prototype.setRGBA=function(t,e,i,o){this.r=t,this.g=e,this.b=i,this.a=o};var b=function(t,e,i){if(!(this instanceof b))throw new Error(j.CONSTRUCT_ERROR);if(this.gl=t,this.width=new Int32Array(1),this.height=new Int32Array(1),this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer(),this.colorBuffer=t.createTexture(),this.dirty=!0,this.width[0]=e,this.height[0]=i,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.colorBuffer),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],i[0],0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],i[0]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.colorBuffer,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)};b.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)},b.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},b.prototype.deleteObjects=function(t){this.depthBuffer&&t.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=void 0,this.colorBuffer&&t.deleteTexture(this.colorBuffer),this.colorBuffer=void 0,this.fbo&&t.deleteFramebuffer(this.fbo),this.fbo=void 0},b.createBuffer=function(t,e){var i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i},b.bindFramebuffer=function(t,e,i){t.bindFramebuffer(t.FRAMEBUFFER,e),i&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0)},b.bindAttribute=function(t,e,i,o){t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,o,t.FLOAT,!1,0,0)},b.bindTexture=function(t,e,i){t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,e)};var C=function(){if(!(this instanceof C))throw new Error(j.CONSTRUCT_ERROR);this.maxFilesRequestedCount=1,this.filesRequestedCount=0,this.headerFilesRequestedCount=0,this.modelRefFilesRequestedCount=0,this.lowLodDataRequestedCount=0,this.lowLodImagesRequestedCount=0};C.prototype.isFull=function(){return this.filesRequestedCount>=this.maxFilesRequestedCount},C.prototype.isFullHeaders=function(){return this.headerFilesRequestedCount>=1},C.prototype.isFullPlus=function(t){return void 0===t&&(t=0),this.filesRequestedCount>=this.maxFilesRequestedCount+t},C.prototype.isFullPlusModelReferences=function(t){return void 0===t&&(t=0),this.modelRefFilesRequestedCount>=this.maxFilesRequestedCount+t},C.prototype.isFullPlusLowLodData=function(t){return void 0===t&&(t=0),this.lowLodDataRequestedCount>=this.maxFilesRequestedCount+t},C.prototype.isFullPlusLowLodImages=function(t){return void 0===t&&(t=0),this.lowLodImagesRequestedCount>=this.maxFilesRequestedCount+t};var A={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function M(t){switch(t){case 37:return"moveLeft";case 38:return"moveForward";case 39:return"moveRight";case 40:return"moveBackward";default:return}}function P(t){var e=M(t.keyCode);void 0!==e&&(A[e]=!0)}function T(t){var e=M(t.keyCode);void 0!==e&&(A[e]=!1)}function _(){this._camera=void 0,this._cameraBAK=void 0,this._position=new Ce,this._rotation=new Ce,this._positionSpeed=1,this._ratationSpeed=1}Object.defineProperties(_.prototype,{camera:{get:function(){return this._camera},set:function(t){this._camera=t}},position:{get:function(){return this._position},set:function(t){this._position=t}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t}},positionSpeed:{get:function(){return this._positionSpeed},set:function(t){this._positionSpeed=t}},rotationSpeed:{get:function(){return this._ratationSpeed},set:function(t){this._ratationSpeed=t}}}),_.prototype.init=function(){this._position.set(0,0,0),this._rotation.set(0,0,0),document.addEventListener("keydown",P,!1),document.addEventListener("keyup",T,!1)},_.prototype.release=function(){this._camera=void 0,this._cameraBAK=void 0,document.removeEventListener("keydown",P,!1),document.removeEventListener("keyup",T,!1)},_.prototype.move=function(t){var e=glMatrix.vec3.fromValues(this._position.x,this._position.y,this.position.z),i=glMatrix.mat4.create();glMatrix.mat4.rotateY(i,i,this._rotation.y),glMatrix.vec3.transformMat4(t,t,i),glMatrix.vec3.add(e,e,t),this._position.set(e[0],e[1],e[2])},_.prototype.update=function(t){void 0!==this._camera&&(A.moveForward&&(this._camera.moveForward(.5),this.move(vec3.fromValues(0,1,0))),A.moveBackward&&(this._camera.moveBackward(.5),this.move(vec3.fromValues(0,-1,0))),A.moveLeft&&(this._camera.lookLeft(.1),this.move(vec3.fromValues(-1,0,0))),A.moveRight&&(this._camera.lookRight(.1),this.move(vec3.fromValues(1,0,0))))};var w=function(){if(!(this instanceof w))throw new Error(j.CONSTRUCT_ERROR);this.near=new Float32Array([.1]),this.far=new Float32Array([1e3]),this.fovyRad=new Float32Array([.8037]),this.tangentOfHalfFovy=new Float32Array([0]),this.fovRad=new Float32Array([1.047]),this.aspectRatio=new Float32Array([1.3584]),this.planesArray=[],this.dirty=!0;for(var t=0;t<6;t++){var e=new X;this.planesArray.push(e)}};w.prototype.copyParametersFrom=function(t){this.near[0]=t.near[0],this.far[0]=t.far[0],this.fovyRad[0]=t.fovyRad[0],this.tangentOfHalfFovy[0]=t.tangentOfHalfFovy[0],this.fovRad[0]=t.fovRad[0],this.aspectRatio[0]=t.aspectRatio[0]},w.prototype.setNear=function(t){this.near[0]=t},w.prototype.setFar=function(t){this.far[0]=t},w.prototype.intersectionNearFarSphere=function(t){for(var e=!1,i=0;i<2;i++){var o=this.planesArray[i].intersectionSphere(t);if(o===s.INTERSECTION_OUTSIDE)return s.INTERSECTION_OUTSIDE;o===s.INTERSECTION_INTERSECT&&(e=!0)}return e?s.INTERSECTION_INTERSECT:s.INTERSECTION_INSIDE},w.prototype.intersectionSphere=function(t){for(var e=!1,i=0;i<6;i++){var o=this.planesArray[i].intersectionSphere(t);if(o===s.INTERSECTION_OUTSIDE)return s.INTERSECTION_OUTSIDE;o===s.INTERSECTION_INTERSECT&&(e=!0)}return e?s.INTERSECTION_INTERSECT:s.INTERSECTION_INSIDE};var S=function(){if(!(this instanceof S))throw new Error(j.CONSTRUCT_ERROR);this.frustumVolumensMap={}};S.prototype.getFrustumVolumeCulling=function(t){return this.frustumVolumensMap.hasOwnProperty(t)||(this.frustumVolumensMap[t]={},this.frustumVolumensMap[t].fullyIntersectedLowestTilesArray=[],this.frustumVolumensMap[t].partiallyIntersectedLowestTilesArray=[],this.frustumVolumensMap[t].visibleNodes=new gt),this.frustumVolumensMap[t]},S.prototype.initArrays=function(){var t;for(var e in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,e)&&((t=this.frustumVolumensMap[e]).fullyIntersectedLowestTilesArray.length=0,t.partiallyIntersectedLowestTilesArray.length=0,t.visibleNodes.initArrays())};var R=function(t,e,i){if(!(this instanceof R))throw new Error(j.CONSTRUCT_ERROR);this.longitude,this.latitude,this.altitude,void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==i&&(this.altitude=i),this.absolutePoint,this.vboKeysContainer,this.geoLocDataManager,this.owner};R.prototype.deleteObjects=function(t){this.longitude=void 0,this.latitude=void 0,this.altitude=void 0,void 0!==this.absolutePoint&&(this.absolutePoint.deleteObjects(),this.absolutePoint=void 0),void 0!==this.vboKeysContainer&&this.vboKeysContainer.deleteGlObjects(t.gl,t),void 0!==this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.owner=void 0},R.prototype.getWgs84Point3D=function(t){var e=F.geographicToCartesianWgs84(this.longitude,this.latitude,this.altitude,void 0);return void 0===t&&(t=new Ce),t.set(e[0],e[1],e[2]),t},R.prototype.getMercatorProjection=function(t){return F.geographicToMercatorProjection(this.longitude,this.latitude,t)},R.prototype.getGeoLocationDataManager=function(){return void 0===this.geoLocDataManager&&(this.geoLocDataManager=new O),this.geoLocDataManager},R.prototype.copyFrom=function(t){this.longitude=t.longitude,this.latitude=t.latitude,this.altitude=t.altitude},R.prototype.setLonLatAlt=function(t,e,i){void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==i&&(this.altitude=i)},R.prototype.getLatitudeRad=function(){if(void 0!==this.latitude)return this.latitude*Math.PI/180},R.prototype.getLongitudeRad=function(){if(void 0!==this.longitude)return this.longitude*Math.PI/180},R.getMidPoint=function(t,e,i){var o=(t.latitude+e.latitude)/2,r=(t.longitude+e.longitude)/2,n=(t.altitude+e.altitude)/2;return void 0===i?i=new R(r,o,n):i.setLonLatAlt(r,o,n),i},R.getAngleBetweenCoords=function(t,e){var i=e.longitude-t.longitude,o=e.latitude-t.latitude;return Math.sqrt(i*i+o*o)},R.prototype.prepareData=function(t){if(void 0===this.vboKeysContainer&&(this.vboKeysContainer=new ft),0===this.vboKeysContainer.getVbosCount()){var e=this.vboKeysContainer.newVBOVertexIdxCacheKey(),i=new Float32Array([0,0,0]);e.setDataArrayPos(i,t)}return!0},R.prototype.renderPoint=function(t,e,i,o){if(!this.prepareData(t.vboMemoryManager))return!1;if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,e),2===o){var r=t.selectionManager,n=t.selectionColor,a=n.getAvailableColor(void 0),s=n.decodeColor3(a.r,a.g,a.b);r.setCandidateGeneral(s,this),i.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}var l=this.vboKeysContainer.vboCacheKeysArray[0];if(!l.bindDataPosition(e,t.vboMemoryManager))return!1;i.drawArrays(i.POINTS,0,l.vertexCount)};var L=function(t,e){if(!(this instanceof L))throw new Error(j.CONSTRUCT_ERROR);this.strGeoCoord=t,this.endGeoCoord=e};L.calculateHeadingAngRadToNorthOfSegment=function(t,e){var i=t.strGeoCoord,o=t.endGeoCoord,r=Ai.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e),n=Ai.geographicCoordToWorldPoint(o.longitude,o.latitude,o.altitude,void 0,e),a=Ai.calculateGeoLocationMatrixAtWorldPosition(r,void 0),s=glMatrix.mat4.create();s=glMatrix.mat4.invert(s,a._floatArrays);var l=new B;l.setByFloat32Array(s);var d=l.transformPoint3D(n,void 0),h=new me(0,1),c=new me(d.x,d.y);c.unitary();var u=h.angleRadToVector(c);return c.x>0&&(u*=-1),u},L.getLengthInMeters=function(t,e){var i=t.strGeoCoord,o=t.endGeoCoord,r=Ai.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e),n=Ai.geographicCoordToWorldPoint(o.longitude,o.latitude,o.altitude,void 0,e);return r.distToPoint(n)};var D=function(t){if(!(this instanceof D))throw new Error(j.CONSTRUCT_ERROR);this.geographicCoordsArray=void 0!==t?t:[],this.vboKeysContainer,this.owner,this.points3dList};D.prototype.addGeoCoord=function(t){this.geographicCoordsArray.push(t),t.owner=this},D.prototype.getGeoCoord=function(t){if(void 0!==this.geographicCoordsArray)return this.geographicCoordsArray[t]},D.prototype.getGeoCoordsCount=function(){return void 0===this.geographicCoordsArray?0:this.geographicCoordsArray.length},D.prototype.getPointsRelativeToGeoLocation=function(t,e){void 0===e&&(e=[]);for(var i=this.getGeoCoordsCount(),o=0;o<i;o++){var r=this.getGeoCoord(o).geoLocDataManager.getCurrentGeoLocationData().position;e[o]=t.getTransformedRelativePosition(r,e[o])}return e},D.prototype.deleteObjects=function(t){if(void 0!==this.geographicCoordsArray){for(var e=this.getGeoCoordsCount(),i=0;i<e;i++)this.geographicCoordsArray[i].deleteGlObjects(t),this.geographicCoordsArray[i]=void 0;this.geographicCoordsArray=void 0}void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t),this.vboKeysContainer=void 0),this.owner=void 0},D.prototype.makeLines=function(t){if(void 0===this.geographicCoordsArray||0===this.geographicCoordsArray.length)return!1;void 0===this.points3dList&&(this.points3dList=new be);var e=this.points3dList.getGeographicLocation(),i=this.getGeoCoord(0),o=i.getGeoLocationDataManager().getCurrentGeoLocationData();void 0===o&&(o=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,o,t)),e.copyFrom(o);var r=this.getPointsRelativeToGeoLocation(e,void 0);this.points3dList.deleteVboKeysContainer(t),this.points3dList.deletePoints3d(),this.points3dList.addPoint3dArray(r)},D.prototype.renderLines=function(t,e,i,o,r){if(void 0===this.geographicCoordsArray)return!1;if(void 0===this.points3dList)return!1;(e=t.postFxShadersManager.getShader("pointsCloud")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals();var n=t.sceneState.gl;n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),this.points3dList.renderLines(t,e,i,o,r),e.disableVertexAttribArrayAll()},D.prototype.renderPoints=function(t,e,i,o){if(void 0===this.geographicCoordsArray)return!1;var r,n=t.sceneState.gl;(e=t.postFxShadersManager.getShader("pointsCloud")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,1),void 0===o&&(o=!0),o?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST);for(var a=this.geographicCoordsArray.length,s=0;s<a;s++)(r=this.geographicCoordsArray[s]).renderPoint(t,e,n,i);var l=t.selectionManager.getSelectedGeneral();void 0!==l&&"GeographicCoord"===l.constructor.name&&(n.uniform4fv(e.oneColor4_loc,[1,.1,.1,1]),n.uniform1f(e.fixPointSize_loc,10),l.renderPoint(t,e,n,i)),e.disableVertexAttribArrayAll(),n.enable(n.DEPTH_TEST);var d=t.getObjectLabel().getContext("2d");d.clearRect(0,0,d.canvas.width,d.canvas.height),d.font="13px Arial";var h,c;for(n=t.sceneState.gl,s=0;s<a;s++){if(h=(r=this.geographicCoordsArray[s]).getGeoLocationDataManager().getCurrentGeoLocationData().position,(c=Ai.calculateWorldPositionToScreenCoord(n,h.x,h.y,h.z,c,t)).x+=15,c.y-=15,c.x>=0&&c.y>=0){var u="lon: "+r.longitude.toFixed(5)+", lat: "+r.latitude.toFixed(5);d.strokeText(u,c.x,c.y),d.fillText(u,c.x,c.y)}}d.restore()},D.prototype.getWgs84Points3D=function(t){void 0===t&&(t=[]);for(var e=this.geographicCoordsArray.length,i=0;i<e;i++){var o=this.geographicCoordsArray[i].getWgs84Point3D(void 0);t.push(o)}return t};var I=function(){if(!(this instanceof I))throw new Error(j.CONSTRUCT_ERROR);this.minGeographicCoord,this.maxGeographicCoord};I.prototype.deleteObjects=function(){void 0!==this.minGeographicCoord&&(this.minGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0),void 0!==this.maxGeographicCoord&&(this.maxGeographicCoord.deleteObjects(),this.maxGeographicCoord=void 0)},I.prototype.setExtent=function(t,e,i,o,r,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new R),this.minGeographicCoord.setLonLatAlt(t,e,i),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new R),this.maxGeographicCoord.setLonLatAlt(o,r,n)},I.prototype.getMidPoint=function(t){return R.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,t)},I.prototype.getMinLatitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLatitudeRad()},I.prototype.getMinLongitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLongitudeRad()},I.prototype.getMaxLatitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLatitudeRad()},I.prototype.getMaxLongitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLongitudeRad()};var E=function(t){if(!(this instanceof E))throw new Error(j.CONSTRUCT_ERROR);this.name,this.name=void 0===t?"noName":t,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslationLC};E.prototype.setRotationHeadingPitchRoll=function(t,e,i){void 0!==t&&(this.heading=t),void 0!==e&&(this.pitch=e),void 0!==i&&(this.roll=i)},E.prototype.getGeographicCoords=function(){return this.geographicCoord},E.prototype.setGeographicCoordsLonLatAlt=function(t,e,i){void 0===this.geographicCoord&&(this.geographicCoord=new R),this.geographicCoord.setLonLatAlt(t,e,i)},E.prototype.deleteObjects=function(t){this.name=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(t),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.date=void 0,this.position&&this.position.deleteObjects(),this.position=void 0,this.positionHIGH=void 0,this.positionLOW=void 0,this.pivotPoint&&this.pivotPoint.deleteObjects(),this.pivotPoint=void 0,this.geoLocMatrix&&this.geoLocMatrix.deleteObjects(),this.geoLocMatrixInv&&this.geoLocMatrixInv.deleteObjects(),this.tMatrix&&this.tMatrix.deleteObjects(),this.tMatrixInv&&this.tMatrixInv.deleteObjects(),this.rotMatrix&&this.rotMatrix.deleteObjects(),this.rotMatrixInv&&this.rotMatrixInv.deleteObjects(),this.geoLocMatrix=void 0,this.geoLocMatrixInv=void 0,this.tMatrix=void 0,this.tMatrixInv=void 0,this.rotMatrix=void 0,this.rotMatrixInv=void 0,this.pivotPointTraslationLC&&this.pivotPointTraslationLC.deleteObjects(),this.pivotPointTraslationLC=void 0},E.prototype.doEffectivePivotPointTranslation=function(){var t;void 0!==this.pivotPointTraslationLC&&(t=this.tMatrix.rotatePoint3D(this.pivotPointTraslationLC,t),this.position.x+=t.x,this.position.y+=t.y,this.position.z+=t.z,this.positionLOW[0]+=t.x,this.positionLOW[1]+=t.y,this.positionLOW[2]+=t.z,void 0===this.pivotPoint&&(this.pivotPoint=new Ce),this.pivotPoint.set(this.position.x,this.position.y,this.position.z))},E.prototype.copyFrom=function(t){void 0!==t&&(this.name=t.name,t.geographicCoord&&(void 0===this.geographicCoord&&(this.geographicCoord=new R),this.geographicCoord.copyFrom(t.geographicCoord)),this.heading=t.heading,this.pitch=t.pitch,this.roll=t.roll,this.date=t.date,t.position&&(void 0===this.position&&(this.position=new Ce),this.position.copyFrom(t.position)),t.positionHIGH&&(void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array(3)),this.positionHIGH[0]=t.positionHIGH[0],this.positionHIGH[1]=t.positionHIGH[1],this.positionHIGH[2]=t.positionHIGH[2]),t.positionLOW&&(void 0===this.positionLOW&&(this.positionLOW=new Float32Array(3)),this.positionLOW[0]=t.positionLOW[0],this.positionLOW[1]=t.positionLOW[1],this.positionLOW[2]=t.positionLOW[2]),t.pivotPoint&&(void 0===this.pivotPoint&&(this.pivotPoint=new Ce),this.pivotPoint.copyFrom(t.pivotPoint)),t.geoLocMatrix&&(void 0===this.geoLocMatrix&&(this.geoLocMatrix=new B),this.geoLocMatrix.copyFromMatrix4(t.geoLocMatrix)),t.geoLocMatrixInv&&(void 0===this.geoLocMatrixInv&&(this.geoLocMatrixInv=new B),this.geoLocMatrixInv.copyFromMatrix4(t.geoLocMatrixInv)),t.tMatrix&&(void 0===this.tMatrix&&(this.tMatrix=new B),this.tMatrix.copyFromMatrix4(t.tMatrix)),t.tMatrixInv&&(void 0===this.tMatrixInv&&(this.tMatrixInv=new B),this.tMatrixInv.copyFromMatrix4(t.tMatrixInv)),t.rotMatrix&&(void 0===this.rotMatrix&&(this.rotMatrix=new B),this.rotMatrix.copyFromMatrix4(t.rotMatrix)),t.rotMatrixInv&&(void 0===this.rotMatrixInv&&(this.rotMatrixInv=new B),this.rotMatrixInv.copyFromMatrix4(t.rotMatrixInv)),t.aditionalTraslation&&(void 0===this.aditionalTraslation&&(this.aditionalTraslation=new Ce),this.aditionalTraslation.copyFrom(t.aditionalTraslation)))},E.prototype.localCoordToWorldCoord=function(t,e){if(void 0!==t&&void 0!==this.tMatrix)return void 0===e&&(e=new Ce),e=this.tMatrix.transformPoint3D(t,e)},E.prototype.worldCoordToLocalCoord=function(t,e){var i=this.getTMatrixInv();if(void 0!==t&&void 0!==i)return void 0===e&&(e=new Ce),e=i.transformPoint3D(t,e)},E.prototype.getLocMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new B,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},E.prototype.getRotMatrixInv=function(){if(void 0===this.rotMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.rotMatrix._floatArrays),this.rotMatrixInv=new B,this.rotMatrixInv.setByFloat32Array(t)}return this.rotMatrixInv},E.prototype.getTMatrixInv=function(){if(void 0===this.tMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.tMatrix._floatArrays),this.tMatrixInv=new B,this.tMatrixInv.setByFloat32Array(t)}return this.tMatrixInv},E.prototype.getGeoLocationMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new B,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},E.prototype.getTransformedRelativeCamera=function(t,e){void 0===e&&(e=new v);var i=new Ce;i.set(t.position.x-this.position.x,t.position.y-this.position.y,t.position.z-this.position.z);var o=this.getRotMatrixInv();return e.position=o.transformPoint3D(i,e.position),i.set(t.direction.x,t.direction.y,t.direction.z),e.direction=o.transformPoint3D(i,e.direction),i.set(t.up.x,t.up.y,t.up.z),e.up=o.transformPoint3D(i,e.up),i.x=void 0,i.y=void 0,i.z=void 0,i=void 0,e},E.prototype.getTransformedRelativePositionNoApplyHeadingPitchRoll=function(t,e){void 0===e&&(e=new Ce);var i=new Ce;return i.set(t.x,t.y,t.z),e=this.getLocMatrixInv().transformPoint3D(i,e)},E.prototype.getTransformedRelativePosition=function(t,e){void 0===e&&(e=new Ce);var i=new Ce;return i.set(t.x-this.position.x,t.y-this.position.y,t.z-this.position.z),e=this.getRotMatrixInv().transformPoint3D(i,e)},E.prototype.getTransformedRelativePositionsArray=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]);for(var i=t.length,o=0;o<i;o++){var r=this.getTransformedRelativePosition(t[o],void 0);e.push(r)}return e},E.prototype.bindGeoLocationUniforms=function(t,e){if(void 0===this.rotMatrix);t.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.rotMatrix._floatArrays),t.uniform3fv(e.buildingPosHIGH_loc,[this.positionHIGH[0],this.positionHIGH[1],this.positionHIGH[2]]),t.uniform3fv(e.buildingPosLOW_loc,[this.positionLOW[0],this.positionLOW[1],this.positionLOW[2]])};var O=function(){if(!(this instanceof O))throw new Error(j.CONSTRUCT_ERROR);this.geoLocationDataArray=[],this.geoLocationDataArrayMaxLengthAllowed=15};O.prototype.deleteObjects=function(){if(this.geoLocationDataArray){for(var t=0;t<this.geoLocationDataArray.length;t++)this.geoLocationDataArray[t].deleteObjects(),this.geoLocationDataArray[t]=void 0;this.geoLocationDataArray=[]}},O.prototype.popGeoLocationData=function(){this.geoLocationDataArray.pop()},O.prototype.newGeoLocationData=function(t){void 0===t&&(t="noName"+this.geoLocationDataArray.length.toString());var e=new E(t);return this.geoLocationDataArray.unshift(e),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop(),e},O.prototype.getGeoLocationDatasCount=function(){return this.geoLocationDataArray.length},O.prototype.getGeoLocationData=function(t){if(!(t>this.geoLocationDataArray.length-1))return this.geoLocationDataArray[t]},O.prototype.getCurrentGeoLocationData=function(){if(0!==this.geoLocationDataArray.length)return this.geoLocationDataArray[0]};var F=function(){if(!(this instanceof F))throw new Error(j.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};F.equatorialRadius=function(){return 6378137},F.equatorialRadiusSquared=function(){return 40680631590769},F.polarRadius=function(){return 6356752.3142},F.polarRadiusSquared=function(){return 40408299984087.055},F.radiusAtLatitudeDeg=function(t){var e=t*Math.PI/180,i=F.equatorialRadius(),o=F.polarRadius(),r=F.equatorialRadiusSquared(),n=F.polarRadiusSquared(),a=Math.sin(e),s=Math.cos(e),l=a*a,d=s*s;return i*o/Math.sqrt(r*l+n*d)},F.normalizeCartesian=function(t){if(void 0!==t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return t[0]/=e,t[1]/=e,t[2]/=e,t}},F.normalAtCartesianPointWgs84=function(t,e,i,o){void 0===o&&(o=new Float32Array(3));var r=F.equatorialRadius(),n=F.polarRadius(),a=r*r,s=n*n;return o[0]=t/a,o[1]=e/a,o[2]=i/s,o=F.normalizeCartesian(o)},F.transformMatrixAtCartesianPointWgs84=function(t,e,i,o){var r,n;n=F.normalAtCartesianPointWgs84(t,e,i,n),(r=new Float32Array(3))[0]=-e,r[1]=t,r[2]=0,r=F.normalizeCartesian(r);var a=new Ce(r[0],r[1],r[2]),s=new Ce,l=new Ce(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===o&&(o=new Float32Array(16)),o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=0,o[4]=s.x,o[5]=s.y,o[6]=s.z,o[7]=0,o[8]=l.x,o[9]=l.y,o[10]=l.z,o[11]=0,o[12]=t,o[13]=e,o[14]=i,o[15]=1,o},F.prototype.normalizeCartesian=function(t){return F.normalizeCartesian(t)},F.prototype.transformMatrixAtCartesianPointWgs84=function(t,e,i,o){var r,n;n=this.normalAtCartesianPointWgs84(t,e,i,n),(r=new Float32Array(3))[0]=-e,r[1]=t,r[2]=0,r=this.normalizeCartesian(r);var a=new Ce(r[0],r[1],r[2]),s=new Ce,l=new Ce(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===o&&(o=new Float32Array(16)),o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=0,o[4]=s.x,o[5]=s.y,o[6]=s.z,o[7]=0,o[8]=l.x,o[9]=l.y,o[10]=l.z,o[11]=0,o[12]=t,o[13]=e,o[14]=i,o[15]=1,o},F.prototype.intersectionLineWgs84=function(t,e,i){var o=t.point,r=t.direction,n=new Ce(o.x+1e3*r.x,o.y+1e3*r.y,o.z+1e3*r.z),a=o.x,s=o.y,l=o.z,d=n.x,h=n.y,c=n.z,u=this.equatorialRadius;void 0!==i&&(u=i);var f=d-a,g=h-s,p=c-l,v=f*f+g*g+p*p,y=2*(f*(a-0)+g*(s-0)+p*(l-0)),m=y*y-4*v*(0+a*a+s*s+l*l-2*(0*a+0*s+0*l)-u*u);if(!(m<0)){if(0===m){void 0===e&&(e=[]);var x=new Ce(a+(d-a)*(b=-y/(2*v)),s+(h-s)*b,l+(c-l)*b);e[0]=x.x,e[1]=x.y,e[2]=x.z}else{var b,C=Math.sqrt(m),A=(-y-C)/(2*v),M=(x=new Ce(a+(d-a)*(b=(-y+C)/(2*v)),s+(h-s)*b,l+(c-l)*b),new Ce(a+(d-a)*A,s+(h-s)*A,l+(c-l)*A)),P=o.squareDistToPoint(x),T=o.squareDistToPoint(M);void 0===e&&(e=[]),P<T?(e[0]=x.x,e[1]=x.y,e[2]=x.z):(e[0]=M.x,e[1]=M.y,e[2]=M.z)}return e}},F.prototype.normalAtCartesianPointWgs84=function(t,e,i,o){void 0===o&&(o=new Float32Array(3));var r=this.equatorialRadius*this.equatorialRadius,n=this.polarRadius*this.polarRadius;return o[0]=t/r,o[1]=e/r,o[2]=i/n,o=this.normalizeCartesian(o)},F.atan2Test=function(t,e){var i=Math.PI;return e>0?Math.atan(t/e):e<0?t>=0?Math.atan(t/e)+i:Math.atan(t/e)-i:0===e?t>0?i/2:t<0?-i/2:0:void 0},F.CartesianToGeographicWgs84=function(t,e,i,o,r){var n,a,s,l,d,h,c,u,f,g,p,v,y,m,x,b=t,C=e,A=i,M=b*b+C*C,P=Math.sqrt(M),T=6378137,_=1/(T*T),w=.00669437999014,S=w*w,L=M*_,D=A*A*(1-w)*_,I=(L+D-S)/6,E=8*I*I*I+S*L*D;E>0||0!==D?(E>0?(l=Math.sqrt(E),d=Math.sqrt(S*L*D),s=E>10*w?I+.5*(h=Math.cbrt((l+d)*(l+d)))+2*I*I/h:I+.5*Math.cbrt((l+d)*(l+d))+.5*Math.cbrt((l-d)*(l-d))):(l=Math.sqrt(-E),d=Math.sqrt(-8*I*I*I),h=Math.sqrt(S*L*D),c=2*F.atan2Test(h,l+d)/3,s=-4*I*Math.sin(c)*Math.cos(Math.PI/6+c)),f=w*(s+(u=Math.sqrt(s*s+S*D))-D)/(2*u),p=(g=(s+u)/(Math.sqrt(f*f+s+u)+f))*P/(g+w),n=(g+w-1)*(v=Math.sqrt(p*p+A*A))/g,a=2*F.atan2Test(A,v+p)):(n=-T*(l=Math.sqrt(1-w))*(d=Math.sqrt(w-L))/(y=Math.sqrt(w)),a=d/(y*d+l*Math.sqrt(L))),m=((x=Math.sqrt(2))-1)*C<P+b?2*F.atan2Test(C,P+b):P+C<(x+1)*b?.5*-Math.PI+2*F.atan2Test(b,P-C):.5*Math.PI-2*F.atan2Test(b,P+C),void 0===o&&(o=new R);var O=180/Math.PI;return o.latitude=O*a,o.longitude=O*m,o.altitude=n,void 0!==r&&!0===r&&(void 0===o.absolutePoint?o.absolutePoint=new Ce(t,e,i):o.absolutePoint.set(t,e,i)),o},F.geographicToMercatorProjection=function(t,e,i){var o=Math.PI/180,r=t*o,n=e*o;return F.geographicRadianToMercatorProjection(r,n,i)},F.geographicRadianToMercatorProjection=function(t,e,i){var o=F.equatorialRadius();return void 0===i&&(i=new me),i.set(o*t,o*e),i},F.geographicToCartesianWgs84=function(t,e,i,o){var r=Math.PI/180,n=F.equatorialRadius(),a=t*r,s=e*r,l=Math.cos(a),d=Math.cos(s),h=Math.sin(a),c=Math.sin(s),u=.00669437999014,f=n/Math.sqrt(1-u*c*c),g=i;return void 0===o&&(o=[]),o[0]=(f+g)*d*l,o[1]=(f+g)*d*h,o[2]=(f*(1-u)+g)*c,o},F.geographicRadianArrayToFloat32ArrayWgs84=function(t,e,i,o){var r,n,a,s,l,d,h,c,u=.00669437999014,f=t.length;void 0===o&&(o=new Float32Array(3*f));for(var g=0;g<f;g++)r=t[g],n=e[g],a=Math.cos(r),s=Math.cos(n),l=Math.sin(r),d=Math.sin(n),h=6378137/Math.sqrt(1-u*d*d),c=i[g],o[3*g]=(h+c)*s*a,o[3*g+1]=(h+c)*s*l,o[3*g+2]=(.99330562000986*h+c)*d;return o};var N=function(){if(!(this instanceof N))throw new Error(j.CONSTRUCT_ERROR);this.renderer=new Qe(this),this.selectionManager=new ii,this.postFxShadersManager=new ni,this.readerWriter=new jt,this.magoPolicy=new d,this.animationManager,this.texturesManager=new ot(this),this.smartTileManager=new Q,this.processQueue=new Vt,this.parseQueue=new Nt,this.hierarchyManager=new xt,this.depthFboNeo,this.depthFboAux,this.selectionFbo,this.mouse_x=0,this.mouse_y=0,this.mouseLeftDown=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane,this.objectSelected,this.buildingSelected,this.octreeSelected,this.nodeSelected,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.startMovPoint=new Ce,this.configInformation,this.cameraFPV=new _,this.myCameraSCX;var t=l.getPolicy();void 0!==t&&(this.magoPolicy.setLod0DistInMeters(t.geo_lod0),this.magoPolicy.setLod1DistInMeters(t.geo_lod1),this.magoPolicy.setLod2DistInMeters(t.geo_lod2),this.magoPolicy.setLod3DistInMeters(t.geo_lod3),this.magoPolicy.setLod4DistInMeters(t.geo_lod4),this.magoPolicy.setLod5DistInMeters(t.geo_lod5)),this.kernel=[.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35],this.sphereKernel=[];for(var e=0;e<16;e++)this.sphereKernel.push(2*(Math.random()-.5)),this.sphereKernel.push(2*(Math.random()-.5)),this.sphereKernel.push(2*(Math.random()-.5));this.loadQueue=new Mt(this),this.sceneState=new $e,this.selectionColor=new Y,this.vboMemoryManager=new ct,this.fileRequestControler=new C,this.visibleObjControlerOctrees=new gt,this.visibleObjControlerNodes=new gt,this.visibleObjControlerTerrain=new gt,this.boundingSphere_Aux,this.radiusAprox_aux,this.lastCamPos=new Ce,this.squareDistUmbral=22,this.lowestOctreeArray=[],this.backGround_fileReadings_count=0,this.backGround_imageReadings_count=0,this.isCameraMoving=!1,this.isCameraInsideNeoBuilding=!1,this.renderingFase=0,this.bPicking=!1,this.scene,this.numFrustums,this.isLastFrustum=!1,this.currentFrustumIdx=0,this.highLightColor4=new Float32Array([.2,1,.2,1]),this.thereAreUrgentOctrees=!1,this.hierarchyManager=new xt,this.smallObjectSize=.153,this.sqrtTable=new Float32Array(11);for(e=0;e<11;e++)this.sqrtTable[e]=Math.sqrt(1+.1*e*(.1*e));this.managerUtil=new Ai,this.currentSelectedObj_idx=-1,this.currentByteColorPicked=new Uint8Array(4),this.currentShader,this.pointSC=new Ce,this.pointSC_2=new Ce,this.arrayAuxSC=[],this.currentTimeSC,this.dateSC=new Date,this.startTimeSC,this.maxMilisecondsForRender=10,this.terranTileSC,this.resultRaySC=new Float32Array(3),this.matrix4SC=new B,this.axisXYZ=new qt,this.demoBlocksLoaded=!1,this.objMarkerManager=new k,this.pin=new W,this.tempSettings={},this.tempSettings.renderWithTopology=1,this.tempSettings.renderSpaces=!0,this.tempSettings.spacesAlpha=.6,this._settings=new q,this.tinTerrainManager};N.prototype.init=function(t){this.bInit=!0,void 0===this.sceneState.gl&&(this.sceneState.gl=t),void 0===this.vboMemoryManager.gl&&(this.vboMemoryManager.gl=t)},N.prototype.start=function(t,e,i,o){if(this.magoPolicy.getMagoEnable()){var r=!1;if(this.numFrustums=o,this.currentFrustumIdx=this.numFrustums-i-1,this.currentFrustumIdx===o-1&&(r=!0,this.isLastFrustum=!0),e.pick);else{if(void 0===this.configInformation&&(this.configInformation=l.getPolicy()),t){var n=t.context._gl;if(n.getExtension("EXT_frag_depth"),this.bInit||this.init(n),n.isContextLost())return}this.startRender(r,this.currentFrustumIdx,o)}}},N.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},N.prototype.prepareNeoBuildingsAsimetricVersion=function(t,e){var i,o,r,n=this.readerWriter.geometryDataPath;void 0===this.headersRequestedCounter&&(this.headersRequestedCounter=0);for(var s=[].concat(e.currentVisibles0,e.currentVisibles2,e.currentVisibles3,e.currentVisiblesAux),l=0,d=s.length;l<d;l++){var h=(o=s[l]).data.attributes;if(void 0!==h){if(void 0!==h.projectId&&void 0!==h.isReference&&!0===h.isReference){if(void 0===(i=s[l].data.neoBuilding)){var c=h.buildingFolderName;r=h.projectFolderName;var f=h.projectId,p=this.hierarchyManager.getStaticModelsManager().getStaticModel(f);i=p.neoBuilding,c=p.buildingFolderName,r=p.projectFolderName;var v=new g;v.fisrtName=c,v.name=c,v.buildingId=c,v.buildingFileName=c,v.geographicCoord=new R(h.longitude,h.latitude,h.height),v.rotationsDegree=new Ce(h.pitch,h.roll,h.heading),v.bBox=new u,v.bBox.init(),v.bBox.expand(10),v.geographicCoordOfBBox=new R(h.longitude,h.latitude,h.height),v.smartTileOwner,i.buildingFileName=c,i.nodeOwner=o,o.data.neoBuilding=i,o.data.buildingSeed=v,o.data.projectFolderName=r,void 0===i.metaData&&(i.metaData=new Tt,void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new R),void 0===i.metaData.bbox&&(i.metaData.bbox=new u),i.metaData.geographicCoord.setLonLatAlt(v.geographicCoord.longitude,v.geographicCoord.latitude,v.geographicCoord.altitude),i.metaData.bbox.copyFrom(v.bBox),i.metaData.heading=v.rotationsDegree.z,i.metaData.pitch=v.rotationsDegree.x,i.metaData.roll=v.rotationsDegree.y),i.name="test_"+c,i.buildingId=c,i.buildingType="basicBuilding",void 0===i.bbox&&(i.bbox=new u),i.bbox.copyFrom(v.bBox),i.projectFolderName=o.data.projectFolderName}}else r=o.data.projectFolderName,i=s[l].data.neoBuilding;if(i.metaData.fileLoadState===a.fileLoadState.READY){if(r=i.projectFolderName,this.fileRequestControler.isFullHeaders())return;var y=n+"/"+r+"/"+i.buildingFileName+"/HeaderAsimetric.hed";this.readerWriter.getNeoHeaderAsimetricVersion(t,y,i,this.readerWriter,this)}}}s.length=0},N.prototype.upDateSceneStateMatrices=function(t){if(void 0===this.myCameraSCX&&(this.myCameraSCX=new v),void 0!==this.configInformation){if(this.configInformation.geo_view_library===s.CESIUM){var e=this.scene,i=e._context.uniformState;Cesium.Matrix4.toArray(i._modelViewProjectionRelativeToEye,t.modelViewProjRelToEyeMatrix._floatArrays),Cesium.Matrix4.toArray(i._modelViewProjection,t.modelViewProjMatrix._floatArrays),Cesium.Matrix4.toArray(i._modelViewRelativeToEye,t.modelViewRelToEyeMatrix._floatArrays),t.modelViewRelToEyeMatrixInv._floatArrays=Cesium.Matrix4.inverseTransformation(t.modelViewRelToEyeMatrix._floatArrays,t.modelViewRelToEyeMatrixInv._floatArrays),t.modelViewMatrix._floatArrays=Cesium.Matrix4.clone(i.view,t.modelViewMatrix._floatArrays),Cesium.Matrix4.toArray(i._projection,t.projectionMatrix._floatArrays);var o=e.context._us._cameraPosition;Ai.calculateSplited3fv([o.x,o.y,o.z],t.encodedCamPosHigh,t.encodedCamPosLow),t.modelViewMatrixInv._floatArrays=Cesium.Matrix4.inverseTransformation(t.modelViewMatrix._floatArrays,t.modelViewMatrixInv._floatArrays),t.normalMatrix4._floatArrays=Cesium.Matrix4.transpose(t.modelViewMatrixInv._floatArrays,t.normalMatrix4._floatArrays);var r=this.scene._frustumCommandsList;void 0===r&&(r=this.scene.frustumCommandsList);var n=this.scene.camera.positionWC.x,a=this.scene.camera.positionWC.y,l=this.scene.camera.positionWC.z,d=this.scene.camera.direction.x,h=this.scene.camera.direction.y,c=this.scene.camera.direction.z,u=this.scene.camera.up.x,f=this.scene.camera.up.y,g=this.scene.camera.up.z;t.camera.isCameraMoved(n,a,l,d,h,c,u,f,g)&&(this.isCameraMoved=!0),this.upDateCamera(t.camera),t.drawingBufferWidth[0]=e.drawingBufferWidth,t.drawingBufferHeight[0]=e.drawingBufferHeight}else if(this.configInformation.geo_view_library===s.MAGOWORLD){var p=t.camera,y=p.position,m=p.getFrustum(0);t.camera.frustum.aspectRatio[0]=t.drawingBufferWidth/t.drawingBufferHeight;var x=p.getCameraElevation(),b=F.equatorialRadius();m.far[0]=b+x,m.near[0]=x>1.2*b?.1+x:.1+x/1e7,Ai.calculateSplited3fv([y.x,y.y,y.z],t.encodedCamPosHigh,t.encodedCamPosLow),t.projectionMatrix._floatArrays=glMatrix.mat4.perspective(t.projectionMatrix._floatArrays,m.fovyRad[0],m.aspectRatio[0],0,m.far[0]),t.modelViewMatrixInv._floatArrays=glMatrix.mat4.invert(t.modelViewMatrixInv._floatArrays,t.modelViewMatrix._floatArrays),t.normalMatrix4._floatArrays=glMatrix.mat4.transpose(t.normalMatrix4._floatArrays,t.modelViewMatrixInv._floatArrays),t.modelViewRelToEyeMatrix._floatArrays=glMatrix.mat4.copy(t.modelViewRelToEyeMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewRelToEyeMatrix._floatArrays[12]=0,t.modelViewRelToEyeMatrix._floatArrays[13]=0,t.modelViewRelToEyeMatrix._floatArrays[14]=0,t.modelViewRelToEyeMatrix._floatArrays[15]=1,t.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(t.modelViewRelToEyeMatrixInv._floatArrays,t.modelViewRelToEyeMatrix._floatArrays),t.modelViewProjMatrix._floatArrays=glMatrix.mat4.multiply(t.modelViewProjMatrix._floatArrays,t.projectionMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewProjRelToEyeMatrix.copyFromMatrix4(t.modelViewProjMatrix),t.modelViewProjRelToEyeMatrix._floatArrays[12]=0,t.modelViewProjRelToEyeMatrix._floatArrays[13]=0,t.modelViewProjRelToEyeMatrix._floatArrays[14]=0,t.modelViewProjRelToEyeMatrix._floatArrays[15]=1,m.tangentOfHalfFovy[0]=Math.tan(m.fovyRad[0]/2)}for(var C=0;C<16;C++)t.normalMatrix4._floatArrays[C]=t.modelViewMatrix._floatArrays[C];if(t.normalMatrix4._floatArrays[12]=0,t.normalMatrix4._floatArrays[13]=0,t.normalMatrix4._floatArrays[14]=0,t.normalMatrix4._floatArrays[15]=1,void 0!==this.depthFboNeo){var A=this.texturesManager.getNoiseTexture4x4();t.ssaoNoiseScale2[0]=this.depthFboNeo.width[0]/A.width,t.ssaoNoiseScale2[1]=this.depthFboNeo.height[0]/A.height}this.myCameraSCX.direction.set(t.camera.direction.x,t.camera.direction.y,t.camera.direction.z),this.myCameraSCX.up.set(t.camera.up.x,t.camera.up.y,t.camera.up.z);m=this.myCameraSCX.getFrustum(0);var M=t.camera.getFrustum(0);m.near[0]=M.near[0],m.far[0]=M.far[0],m.fovyRad[0]=M.fovyRad[0],m.tangentOfHalfFovy[0]=M.tangentOfHalfFovy[0],m.fovRad[0]=M.fovRad[0],m.aspectRatio[0]=M.aspectRatio[0]}},N.prototype.upDateCamera=function(t){if(this.configInformation.geo_view_library===s.CESIUM){for(var e=this.scene,i=e.frustumCommandsList,o=this.currentFrustumIdx,r=this.sceneState.camera,n=i[o].far,a=i[o].near,l=e.opaqueFrustumNearOffset,d=i.length,h=[],c=void 0,u=0;u<d;u++){h[2*u]=i[u].near,h[2*u+1]=i[u].far,0!==u&&(h[2*u]*=l),(T=r.getFrustum(u)).far[0]=i[u].far,T.near[0]=i[u].near,T.fovRad[0]=e.camera.frustum._fov,T.fovyRad[0]=e.camera.frustum._fovy,T.aspectRatio[0]=e.camera.frustum._aspectRatio,void 0===c&&(c=Math.tan(T.fovyRad/2)),T.tangentOfHalfFovy[0]=c}var f=this.sceneState.modelViewMatrixInv,g=e.camera.positionWC.x,p=e.camera.positionWC.y,v=e.camera.positionWC.z,y=-f._floatArrays[8],m=-f._floatArrays[9],x=-f._floatArrays[10],b=f._floatArrays[4],C=f._floatArrays[5],A=f._floatArrays[6];t.position.set(g,p,v),t.direction.set(y,m,x),t.up.set(b,C,A);var M=T.aspectRatio[0],P=T.fovyRad;T=t.getFrustum(o),t.frustum.near[0]=a,t.frustum.far[0]=n,t.setFrustumsDistances(d,h),t.setAspectRatioAndFovyRad(M,P),t.calculateFrustumsPlanes()}else if(this.configInformation.geo_view_library===s.MAGOWORLD){var T;r=this.sceneState.camera,o=0,M=(T=(r=this.sceneState.camera).getFrustum(o)).aspectRatio[0],P=T.fovyRad,n=T.far[0],a=T.near[0];this.sceneState.camera.frustum.near[0]=a,this.sceneState.camera.frustum.far[0]=n,this.sceneState.camera.frustum.aspectRatio[0]=M;for(d=1,h=[],u=0;u<d;u++)h[2*u]=T.near,h[2*u+1]=T.far;t.position.set(r.position.x,r.position.y,r.position.z),t.direction.set(r.direction.x,r.direction.y,r.direction.z),t.up.set(r.up.x,r.up.y,r.up.z),(T=t.getFrustum(o)).near[0]=a,T.far[0]=n,t.setFrustumsDistances(d,h),t.setAspectRatioAndFovyRad(M,P),t.calculateFrustumsPlanes()}},N.prototype.load_testTextures=function(){if(void 0===this.pin.texture){var t=this.sceneState.gl;this.pin.texture=new it;var e=this.magoPolicy.imagePath+"/bugger.png";this.pin.texture.texId=t.createTexture(),this.readerWriter.readNeoReferenceTexture(t,e,this.pin.texture,void 0,this),this.pin.texturesArray.push(this.pin.texture);var i=new it;e=this.magoPolicy.imagePath+"/improve.png",i.texId=t.createTexture(),this.readerWriter.readNeoReferenceTexture(t,e,i,void 0,this),this.pin.texturesArray.push(i),i=new it,e=this.magoPolicy.imagePath+"/etc.png",i.texId=t.createTexture(),this.readerWriter.readNeoReferenceTexture(t,e,i,void 0,this),this.pin.texturesArray.push(i),i=new it,e=this.magoPolicy.imagePath+"/new.png",i.texId=t.createTexture(),this.readerWriter.readNeoReferenceTexture(t,e,i,void 0,this),this.pin.texturesArray.push(i),i=new it,e=this.magoPolicy.imagePath+"/funny.jpg",i.texId=t.createTexture(),this.readerWriter.readNeoReferenceTexture(t,e,i,void 0,this),this.pin.texturesArray.push(i)}},N.prototype.getCurrentTime=function(){return void 0===this.currTime&&(this.dateSC=new Date,this.currTime=this.dateSC.getTime()),this.currTime},N.prototype.getGl=function(){if(void 0!==this.sceneState)return this.sceneState.gl},N.prototype.loadAndPrepareData=function(){var t,e=this.getGl();this.visibleObjControlerOctrees.initArrays(),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles0),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles2);for(var i=this.visibleObjControlerNodes.currentVisibles0.length,o=0;o<i;o++)t=this.visibleObjControlerNodes.currentVisibles0[o],this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0.splice(o,1),o--,i=this.visibleObjControlerNodes.currentVisibles0.length);if(this.prepareVisibleOctreesSortedByDistance(e,this.visibleObjControlerOctrees),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles0),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles1),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2),this.readerWriter.referencesList_requested<5){i=this.visibleObjControlerNodes.currentVisibles2.length;for(o=0;o<i;o++)t=this.visibleObjControlerNodes.currentVisibles2[o],this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2.splice(o,1),o--,i=this.visibleObjControlerNodes.currentVisibles2.length);this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2)}this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles3),this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles2),this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles0),this.readerWriter.pCloudPartitionsMother_requested=0,this.isFarestFrustum()&&void 0!==this.tinTerrainManager&&this.tinTerrainManager.prepareVisibleTinTerrains(this),this.manageQueue()},N.prototype.managePickingProcess=function(){var t=this.getGl();if(void 0===this.selectionFbo&&(this.selectionFbo=new b(t,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),(this.isCameraMoved||this.bPicking)&&(this.selectionFbo.bind(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthRange(0,1),t.disable(t.CULL_FACE),this.isLastFrustum&&(t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.selectionManager.clearCandidates()),this.renderer.renderGeometryColorCoding(this.visibleObjControlerNodes),this.swapRenderingFase(),0===this.currentFrustumIdx&&(this.isCameraMoved=!1)),0===this.currentFrustumIdx){if(!0===this.bPicking){var e=this.selectionManager;this.bPicking=!1,this.arrayAuxSC.length=0,e.clearCurrents(),this.objectSelected=this.getSelectedObjects(t,this.mouse_x,this.mouse_y,this.arrayAuxSC),this.buildingSelected=this.arrayAuxSC[0],this.octreeSelected=this.arrayAuxSC[1],this.nodeSelected=this.arrayAuxSC[3],this.nodeSelected?this.rootNodeSelected=this.nodeSelected.getRoot():this.rootNodeSelected=void 0,this.arrayAuxSC.length=0,void 0!==this.buildingSelected&&(this.displayLocationAndRotation(this.buildingSelected),this.selectedObjectNotice(this.buildingSelected)),this.objectSelected;var i=e.getSelectionCandidatesFamily("networkEdges"),o=e.getSelectionCandidatesFamily("networkNodes"),r=!1;if(i){var n=i.currentSelected;if(n&&n.vtxSegment){var a=this.sceneState.camera.position,s=n.vtxSegment,l=new Ce,d=new Ce;l.copyFrom(s.startVertex.point3d),d.copyFrom(s.endVertex.point3d),l.add(0,0,1.7),d.add(0,0,1.7);var h=(p=n.networkOwner.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData()).tMatrix;(v=p.pivotPointTraslationLC)&&(l.add(v.x,v.y,v.z),d.add(v.x,v.y,v.z));var c,u=h.transformPoint3D(l,void 0),f=h.transformPoint3D(d,void 0);c=a.squareDistToPoint(u)<a.squareDistToPoint(f)?f:u,this.flyToTopology(c,2),r=!0}}if(!r&&o){var g=o.currentSelected;if(g){a=this.sceneState.camera.position;(l=new Ce(g.position.x,g.position.y,g.position.z)).add(0,0,1.7);var p,v;h=(p=g.networkOwner.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData()).tMatrix;(v=p.pivotPointTraslationLC)&&l.add(v.x,v.y,v.z);u=h.transformPoint3D(l,void 0);this.flyToTopology(u,2),r=!0}}}this.selectionColor.init()}this.selectionFbo.unbind(),t.enable(t.CULL_FACE)},N.prototype.doRender=function(t){var e=this.getGl(),i=(this.sceneState.camera.position,0);this.renderType=0;(void 0===t.depthFbo&&(t.depthFbo=new b(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===t.depthFbo.width[0]&&this.sceneState.drawingBufferHeight[0]===t.depthFbo.height[0]||(t.depthFbo.deleteObjects(e),t.depthFbo=new b(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight),this.sceneState.camera.frustum.dirty=!0),this.depthFboNeo=t.depthFbo,this.depthFboNeo.bind(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.renderer.renderGeometry(e,i,this.visibleObjControlerNodes),this.renderer.renderMagoGeometries(i),this.depthFboNeo.unbind(),this.swapRenderingFase(),this.configInformation.geo_view_library===s.CESIUM)&&this.scene._context._currentFramebuffer._bind();i=1,this.renderType=1,this.renderer.renderGeometry(e,i,this.visibleObjControlerNodes),this.weatherStation,e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase(),this.renderer.renderMagoGeometries(i)},N.prototype.startRender=function(t,e,i){this.numFrustums=i,this.isLastFrustum=t;var o=this.getGl();this.upDateSceneStateMatrices(this.sceneState),this.isFarestFrustum()&&(this.dateSC=new Date,this.currTime=this.dateSC.getTime(),void 0!==this.animationManager&&this.animationManager.checkAnimation(this),void 0===this.myCameraSCX&&(this.myCameraSCX=new v),this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.upDateCamera(this.myCameraSCX),this.doMultiFrustumCullingSmartTiles(this.myCameraSCX)),o.clearStencil(0),o.clear(o.STENCIL_BUFFER_BIT),this.sceneState.camera.doTrack(this));var r=this.sceneState.camera.position,n=this.frustumVolumeControl.getFrustumVolumeCulling(e);this.myCameraSCX.setCurrentFrustum(e),this.sceneState.camera.setCurrentFrustum(e);var a=n.visibleNodes;if(!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){if(void 0===this.frustumVolumeControl)return;var s=this.myCameraSCX.bigFrustum,l=!1;this.tilesMultiFrustumCullingFinished(n.fullyIntersectedLowestTilesArray,a,r,s,l),l=!0,this.tilesMultiFrustumCullingFinished(n.partiallyIntersectedLowestTilesArray,a,r,s,l),this.prepareNeoBuildingsAsimetricVersion(o,a)}if(this.visibleObjControlerNodes=a,this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.loadAndPrepareData(),this.managePickingProcess()),!0===this.bPicking&&t){var d;if(!0===this.magoPolicy.issueInsertEnable){void 0===this.objMarkerSC&&(this.objMarkerSC=new G),d=new Ce,d=Ai.calculatePixelPositionWorldCoord(o,this.mouse_x,this.mouse_y,d,void 0,void 0,this);var h=this.objMarkerManager.newObjectMarker();Ai.calculateGeoLocationDataByAbsolutePoint(d.x,d.y,d.z,h.geoLocationData,this)}!0===this.magoPolicy.objectInfoViewEnable&&(void 0===this.objMarkerSC&&(this.objMarkerSC=new G),void 0===d&&(d=new Ce,d=Ai.calculatePixelPositionWorldCoord(o,this.mouse_x,this.mouse_y,d,void 0,void 0,this)),Ai.calculateGeoLocationDataByAbsolutePoint(d.x,d.y,d.z,this.objMarkerSC.geoLocationData,this))}this.doRender(n),this.magoPolicy.getShowLabelInfo()&&this.drawBuildingNames(this.visibleObjControlerNodes)},N.prototype.prepareVisibleLowLodNodes=function(t){if(!(this.readerWriter.skinLegos_requested>5))for(var e=t.length,i=0;i<e;i++)if(t[i].data.neoBuilding.prepareSkin(this),this.readerWriter.skinLegos_requested>5)return},N.prototype.drawBuildingNames=function(t){var e=this.getObjectLabel().getContext("2d");this.isFarestFrustum()&&e.clearRect(0,0,e.canvas.width,e.canvas.height);for(var i,o,r,n,a,s=this.getGl(),l={},d=t.currentVisibles1.concat(t.currentVisibles2,t.currentVisibles3),h=d.length,c=0;c<h;c++){if(o=(i=d[c]).getRoot(),void 0!==i.data&&void 0!==i.data.neoBuilding)if(!(i.data.distToCam>1500))l[u=i.data.neoBuilding.buildingId]=o}for(var u in l)Object.prototype.hasOwnProperty.call(l,u)&&(r=(o=l[u]).data.geoLocDataManager.getCurrentGeoLocationData(),n=o.getBBoxCenterPositionWorldCoord(r),(a=Ai.calculateWorldPositionToScreenCoord(s,n.x,n.y,n.z,a,this)).x>=0&&a.y>=0&&(e.font="13px Arial",e.strokeText(o.data.data_name,a.x,a.y),e.fillText(o.data.data_name,a.x,a.y)));l={},e.restore()},N.prototype.cameraMoved=function(){this.sceneState.camera.setDirty(!0),void 0===this.selectionFbo&&(this.selectionFbo=new b(this.sceneState.gl,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.selectionFbo.dirty=!0},N.prototype.getSelectedObjects=function(t,e,i,o){var r=new Uint8Array(324),n=e-Math.floor(4.5),a=this.sceneState.drawingBufferHeight-i-Math.floor(4.5);n<0&&(n=0),a<0&&(a=0),t.readPixels(n,a,9,9,t.RGBA,t.UNSIGNED_BYTE,r),t.bindFramebuffer(t.FRAMEBUFFER,null);var s=Math.floor(40.5),l=this.selectionColor.decodeColor3(r[3*s],r[3*s+1],r[3*s+2]);this.selectionManager.selectObjects(l);var d=this.selectionManager.currentReferenceSelected;o[0]=this.selectionManager.currentBuildingSelected,o[1]=this.selectionManager.currentOctreeSelected,o[2]=this.selectionManager.currentReferenceSelected,o[3]=this.selectionManager.currentNodeSelected;var h=this.selectionManager.getSelectionCandidatesFamily("networkEdges");if(h)for(var c=h.currentSelected,u=0;void 0===c&&u<81;){l=this.selectionColor.decodeColor3(r[3*u],r[3*u+1],r[3*u+2]);c=h.selectObject(l),u++}var f=this.selectionManager.getSelectionCandidatesFamily("general");if(f){var g=f.currentSelected;for(u=0;void 0===g&&u<81;){l=this.selectionColor.decodeColor3(r[3*u],r[3*u+1],r[3*u+2]);g=f.selectObject(l),u++}}return d},N.prototype.calculateSelObjMovePlaneAsimetricMode=function(t,e,i,o){void 0===this.pointSC&&(this.pointSC=new Ce),void 0===this.pointSC2&&(this.pointSC2=new Ce);var r=this.nodeSelected.getNodeGeoLocDataManager();Ai.calculatePixelPositionWorldCoord(t,e,i,this.pointSC2,void 0,void 0,this);var n=r.getCurrentGeoLocationData().getTMatrixInv();return this.pointSC=n.transformPoint3D(this.pointSC2,this.pointSC),void 0===o&&(o=new X),o.setPointAndNormal(this.pointSC.x,this.pointSC.y,this.pointSC.z,0,0,1),o},N.prototype.isDragging=function(){var t=!1,e=this.sceneState.gl;if(this.magoPolicy.objectMoveMode===a.moveMode.ALL){this.arrayAuxSC.length=0,this.selectionFbo.bind();var i,o=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC),r=(this.arrayAuxSC[0],this.arrayAuxSC[3]);r&&(i=r.getRoot()),this.arrayAuxSC.length=0,t=i===this.rootNodeSelected}else if(this.magoPolicy.objectMoveMode===a.moveMode.OBJECT){this.arrayAuxSC.length=0,this.selectionFbo.bind();o=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC);this.arrayAuxSC.length=0,t=o===this.objectSelected}else if(this.magoPolicy.objectMoveMode===a.moveMode.GEOGRAPHICPOINTS){var n=this.selectionManager.getSelectedGeneral();this.arrayAuxSC.length=0,this.selectionFbo.bind(),this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC);var s=this.selectionManager.getSelectedGeneral();if(void 0!==s&&s===n)t="GeographicCoord"===s.constructor.name}else if(this.weatherStation){this.selectionFbo.bind();o=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC);var l=this.selectionManager.getSelectionCandidatesFamily("general");if(l){var d=l.currentSelected;d?d instanceof te&&(t=!0):t=!1}else t=!1}return t||this.selectionManager.clearCandidates(),t},N.prototype.setCameraMotion=function(t){this.configInformation.geo_view_library===s.CESIUM&&(this.scene.screenSpaceCameraController.enableRotate=t,this.scene.screenSpaceCameraController.enableZoom=t,this.scene.screenSpaceCameraController.enableLook=t,this.scene.screenSpaceCameraController.enableTilt=t,this.scene.screenSpaceCameraController.enableTranslate=t)},N.prototype.mouseActionLeftUp=function(t,e){if(this.objectMoved){this.objectMoved=!1;var i=this.selectionManager.currentNodeSelected;if(void 0===i)return;this.saveHistoryObjectMovement(this.objectSelected,i)}this.isCameraMoving=!1,this.mouseLeftDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.dateSC=new Date,this.currentTimeSC=this.dateSC.getTime(),this.currentTimeSC-this.startTimeSC<1500&&this.mouse_x===t&&this.mouse_y===e&&(this.bPicking=!0),this.setCameraMotion(!0),this.sceneState.mouseAction.clearStartPositionsAux()},N.prototype.keyDown=function(t){if(32===t){var e=this._settings.getRenderingSettings(),i=e.getPointsCloudInColorRamp();e.setPointsCloudInColorRamp(!i)}else if(37===t)void 0===this.modeler&&(this.modeler=new ue),this.modeler.mode=a.modelerMode.DRAWING_PIPE;else if(38===t)void 0===this.modeler&&(this.modeler=new ue),this.modeler.mode=a.modelerMode.DRAWING_STATICGEOMETRY;else if(39===t)void 0===this.modeler&&(this.modeler=new ue),this.modeler.mode=a.modelerMode.DRAWING_BSPLINE;else if(40===t)void 0===this.modeler&&(this.modeler=new ue),this.modeler.mode=a.modelerMode.DRAWING_BASICFACTORY;else if(49===t)void 0===this.pointsCloudWhite&&(this.pointsCloudWhite=!0),this.pointsCloudWhite?this.pointsCloudWhite=!1:this.pointsCloudWhite=!0;else if(80===t){var o=this.hierarchyManager.getNodeByDataKey("AutonomousBus","AutonomousBus_0");o.data.isTrailRender=!0;var n=(y=o.getNodeGeoLocDataManager().getCurrentGeoLocationData()).getGeographicCoords(),s=(n.longitude,n.latitude,n.altitude,(u=this.modeler.bSplineCubic3d).geoCoordsList.geographicCoordsArray),l=new ge(s);if(void 0!==u){var d={animationType:a.animationType.PATH,path:l,linearVelocityInMetersSecond:30};this.changeLocationAndRotation("AutonomousBus","AutonomousBus_0",void 0,void 0,void 0,void 0,void 0,void 0,d)}}else if(84===t){var h=this.modeler.getExcavation();void 0!==h&&h.makeExtrudeObject(this);var c=this.modeler.getTunnel();void 0!==c&&(c.getProfileGeographicCoordsList(),c.makeMesh(this));var u,f=new r;if(f.apiName="changeColor",f.setProjectId("AutonomousBus"),f.setDataKey("AutonomousBus_0"),f.setObjectIds("13"),f.setColor("220,150,20"),this.callAPI(f),void 0!==(u=this.modeler.bSplineCubic3d)){void 0===u.geoCoordsList&&(u.geoCoordsList=new D);ge.insertPointsOnLargeSegments(u.geoCoordsList.geographicCoordsArray,.001,this);for(var g=u.geoCoordsList.geographicCoordsArray.length,p=0;p<g;p++){var v=u.geoCoordsList.geographicCoordsArray[p],y=v.getGeoLocationDataManager().newGeoLocationData("noName");y=Ai.calculateGeoLocationData(v.longitude,v.latitude,v.altitude,void 0,void 0,void 0,y,this)}u.getGeographicCoordsList().makeLines(this);u.makeControlPoints(.2,this),u.makeInterpolatedPoints()}}else 89===t&&(void 0===this.magoMode&&(this.magoMode=a.magoMode.NORMAL),this.magoMode===a.magoMode.NORMAL?this.magoMode=a.magoMode.DRAWING:this.magoMode===a.magoMode.DRAWING&&(this.magoMode=a.magoMode.NORMAL,this.modeler.mode=a.modelerMode.INACTIVE))},N.prototype.mouseActionLeftClick=function(t,e){if(this.magoMode===a.magoMode.DRAWING){var i,o;if(void 0===this.modeler&&(this.modeler=new ue),this.configInformation.geo_view_library===s.CESIUM){var r=this.scene.frameState.camera,n=this.scene,l=r.getPickRay(new Cesium.Cartesian2(t,e));o=n.globe.pick(l,n)}else{o=this.sceneState.mouseAction.strWorldPoint}(i=F.CartesianToGeographicWgs84(o.x,o.y,o.z,void 0,!0)).absolutePoint=o;this.modeler.mode;if(this.modeler.mode===a.modelerMode.DRAWING_PLANEGRID&&void 0===this.modeler.planeGrid){this.modeler.createPlaneGrid(),this.modeler.planeGrid.makeVbo(this.vboMemoryManager),void 0===this.modeler.planeGrid.geoLocDataManager&&(this.modeler.planeGrid.geoLocDataManager=new O);var d=(A=this.modeler.planeGrid.geoLocDataManager).newGeoLocationData("noName");return void(d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+1,void 0,void 0,void 0,d,this))}if(this.modeler.mode===a.modelerMode.DRAWING_GEOGRAPHICPOINTS){d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+1,void 0,void 0,void 0,d,this),(h=this.modeler.getGeographicCoordsList()).addGeoCoord(i)}else if(this.modeler.mode===a.modelerMode.DRAWING_EXCAVATIONPOINTS){d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+1,void 0,void 0,void 0,d,this),(h=this.modeler.getExcavation().getGeographicCoordsList()).addGeoCoord(i),h.makeLines(this)}else if(this.modeler.mode===a.modelerMode.DRAWING_TUNNELPOINTS){d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+1,void 0,void 0,void 0,d,this),(h=this.modeler.getTunnel().getPathGeographicCoordsList()).addGeoCoord(i),h.makeLines(this)}else if(this.modeler.mode===a.modelerMode.DRAWING_BSPLINE){var h;d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+1,void 0,void 0,void 0,d,this),void 0===this.modeler.bSplineCubic3d&&(this.modeler.bSplineCubic3d=new Jt),(h=this.modeler.bSplineCubic3d.getGeographicCoordsList()).addGeoCoord(i),h.makeLines(this)}else if(this.modeler.mode===a.modelerMode.DRAWING_STATICGEOMETRY){this.isExistStaticModel("AutonomousBus")||this.addStaticModel({projectId:"AutonomousBus",projectFolderName:"staticModels",buildingFolderName:"F4D_AutonomousBus"});var c=this.hierarchyManager.getNodesMap("AutonomousBus",void 0),u="AutonomousBus_"+Object.keys(c).length.toString();this.instantiateStaticModel({projectId:"AutonomousBus",instanceId:u,longitude:i.longitude,latitude:i.latitude,height:i.altitude+20})}else if(this.modeler.mode===a.modelerMode.DRAWING_BASICFACTORY){var f=20+40*Math.random()+10,g=40+40*Math.random()+10,p=13+6*Math.random()+2,v=new R(127.567,38.123,0),y=new R(128.567,39.123,0),m=new L(v,y),x=180*L.calculateHeadingAngRadToNorthOfSegment(m,this)/Math.PI,b=(L.getLengthInMeters(m,this),[new R(129.3995,35.5076,0),new R(129.3995,35.5073,0),new R(129.3986,35.5075,0),new R(129.3987,35.5077,0)]),C=(Ht.getFactoryDimensionsByGeoCoordsArray(b,0,this),{hasGround:!0,roofMinHeight:.75*p,frontDoorWidth:.8*f,frontDoorHeight:.65*p});d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+10,x,void 0,void 0,d,this),this.modeler.newBasicFactory(f,g,p,C).geoLocDataManager=A}else if(this.modeler.mode===a.modelerMode.DRAWING_PIPE){var A;d=(A=i.getGeoLocationDataManager()).newGeoLocationData("noName");d=Ai.calculateGeoLocationData(i.longitude,i.latitude,i.altitude+10,void 0,void 0,void 0,d,this);C={interiorRadius:10,exteriorRadius:20,height:50,color:{r:.2,g:.8,b:.8,a:.4}};this.modeler.newPipe(C).geoLocDataManager=A}}},N.prototype.mouseActionLeftDown=function(t,e){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseLeftDown=!0,he.updateMouseStartClick(t,e,this)},N.prototype.saveHistoryObjectMovement=function(t,e){var i=new n,o=i.getReferenceObjectAditionalMovement(),r=i.getReferenceObjectAditionalMovementRelToBuilding();if(void 0===t.moveVector&&(t.moveVector=new Ce),void 0===t.moveVectorRelToBuilding&&(t.moveVectorRelToBuilding=new Ce),o.set(t.moveVector.x,t.moveVector.y,t.moveVector.z),r.set(t.moveVectorRelToBuilding.x,t.moveVectorRelToBuilding.y,t.moveVectorRelToBuilding.z),void 0!==e){var a=e.data.projectId,s=e.data.nodeId,d=t._id;i.setProjectId(a),i.setDataKey(s),i.setObjectIndexOrder(d),l.saveMovingHistory(a,s,d,i)}},N.prototype.mouseActionMiddleDown=function(t,e){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseMiddleDown=!0,this.isCameraMoving=!0},N.prototype.mouseActionMiddleUp=function(t,e){this.isCameraMoving=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!1)},N.prototype.mouseActionRightDown=function(t,e){},N.prototype.mouseActionRightUp=function(t,e){},N.prototype.mouseActionMove=function(t,e){this.mouseLeftDown?this.manageMouseDragging(t,e):this.mouseMiddleDown?this.sceneState.camera.setDirty(!0):this.mouseRightDown?this.sceneState.camera.setDirty(!0):(this.mouseDragging=!1,this.setCameraMotion(!1),this.mouseMiddleDown&&(this.isCameraMoving=!0))},N.prototype.manageMouseDragging=function(t,e){if(this.sceneState.camera.setDirty(!0),this.mouse_x=t,this.mouse_y=e,this.magoPolicy.objectMoveMode===a.moveMode.ALL)if(void 0!==this.buildingSelected){this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);var i=this.buildingSelected.nodeOwner;if(void 0===i)return;var o=i.data.geoLocDataManager;if(void 0===o)return;var r=o.getGeoLocationData(0);if(void 0===r)return;var n=r.geographicCoord;if(void 0===n)return;movedDataCallback(l.getPolicy().geo_callback_moveddata,i.data.projectId,i.data.nodeId,null,n.latitude,n.longitude,n.altitude,r.heading,r.pitch,r.roll)}else this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===a.moveMode.OBJECT)void 0!==this.objectSelected?this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1):this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===a.moveMode.GEOGRAPHICPOINTS){var s=this.selectionManager.getSelectedGeneral();if(s)"GeographicCoord"===s.constructor.name&&this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1)}else this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);this.isCameraMoving=!0,this.mouseDragging&&this.moveSelectedObjectAsimetricMode(this.sceneState.gl)},N.prototype.moveSelectedObjectAsimetricMode=function(t){if(this.magoPolicy.objectMoveMode===a.moveMode.ALL){if(void 0===this.selectionManager.currentNodeSelected)return;var e=(y=this.selectionManager.currentNodeSelected.getNodeGeoLocDataManager()).getCurrentGeoLocationData(),i=this.sceneState.mouseAction;if(void 0===this.selObjMovePlane){this.selObjMovePlane=new X;var o=(m=e.getGeoLocationMatrixInv()).transformPoint3D(i.strWorldPoint,o);this.selObjMovePlane.setPointAndNormal(o.x,o.y,o.z,0,0,1)}void 0===this.lineSC&&(this.lineSC=new se),this.lineSC=Ai.getRayWorldSpace(t,this.mouse_x,this.mouse_y,this.lineSC,this);var r=new Ce,n=new Ce,d=e.getGeoLocationMatrixInv();r=d.transformPoint3D(this.lineSC.point,r),this.pointSC=d.rotatePoint3D(this.lineSC.direction,this.pointSC),n.x=this.pointSC.x,n.y=this.pointSC.y,n.z=this.pointSC.z,(x=new se).setPointAndDir(r.x,r.y,r.z,n.x,n.y,n.z);var h=new Ce;(h=this.selObjMovePlane.intersectionLine(x,h)).set(-h.x,-h.y,-h.z);var c=new Ce;if(c=e.geoLocMatrix.transformPoint3D(h,c),this.thereAreStartMovePoint){var u=(v=Ai.pointToGeographicCoord(c,v,this)).longitude-this.startMovPoint.x,f=v.latitude-this.startMovPoint.y,g=e.geographicCoord.longitude-u,p=e.geographicCoord.latitude-f;this.changeLocationAndRotationNode(this.selectionManager.currentNodeSelected,p,g,void 0,void 0,void 0,void 0),this.displayLocationAndRotation(this.buildingSelected),this.startMovPoint.x-=u,this.startMovPoint.y-=f}else{var v=Ai.pointToGeographicCoord(c,v,this);this.startMovPoint.x=v.longitude,this.startMovPoint.y=v.latitude,this.thereAreStartMovePoint=!0}}else if(this.magoPolicy.objectMoveMode===a.moveMode.OBJECT){if(void 0===this.objectSelected)return;void 0===this.selObjMovePlane&&(this.selObjMovePlane=this.calculateSelObjMovePlaneAsimetricMode(t,this.mouse_x,this.mouse_y,this.selObjMovePlane));var y=this.selectionManager.currentNodeSelected.getNodeGeoLocDataManager();void 0===this.lineSC&&(this.lineSC=new se),this.lineSC=Ai.getRayWorldSpace(t,this.mouse_x,this.mouse_y,this.lineSC,this);var m,x,b=y.getCurrentGeoLocationData();r=new Ce,n=new Ce;r=(m=b.getTMatrixInv()).transformPoint3D(this.lineSC.point,r),n=m.rotatePoint3D(this.lineSC.direction,n),(x=new se).setPointAndDir(r.x,r.y,r.z,n.x,n.y,n.z);h=new Ce;if(h=this.selObjMovePlane.intersectionLine(x,h),void 0===this.objectSelected.moveVectorRelToBuilding&&(this.objectSelected.moveVectorRelToBuilding=new Ce),this.thereAreStartMovePoint){u=h.x-this.startMovPoint.x,f=h.y-this.startMovPoint.y;var C=h.z-this.startMovPoint.z;this.objectSelected.moveVectorRelToBuilding.set(u,f,C),this.objectSelected.moveVector=b.tMatrix.rotatePoint3D(this.objectSelected.moveVectorRelToBuilding,this.objectSelected.moveVector)}else this.startMovPoint=h,this.startMovPoint.add(-this.objectSelected.moveVectorRelToBuilding.x,-this.objectSelected.moveVectorRelToBuilding.y,-this.objectSelected.moveVectorRelToBuilding.z),this.thereAreStartMovePoint=!0;var A=this.selectionManager.currentNodeSelected.data.projectId,M=this.selectionManager.currentNodeSelected.data.nodeId,P=this.objectSelected._id;l.deleteMovingHistoryObject(A,M,P),this.objectMoved=!0}else if(this.magoPolicy.objectMoveMode===a.moveMode.GEOGRAPHICPOINTS){var T=this.selectionManager.getSelectedGeneral();if(T)if("GeographicCoord"===T.constructor.name){var _;e=(y=T.getGeoLocationDataManager()).getCurrentGeoLocationData();if(this.configInformation.geo_view_library===s.CESIUM){var w=this.scene.frameState.camera,S=this.scene,L=w.getPickRay(new Cesium.Cartesian2(this.mouse_x,this.mouse_y));V=S.globe.pick(L,S),_=F.CartesianToGeographicWgs84(V.x,V.y,V.z,void 0,!0)}else{V=(i=this.sceneState.mouseAction).strWorldPoint,_=F.CartesianToGeographicWgs84(V.x,V.y,V.z,void 0,!0)}T.setLonLatAlt(_.longitude,_.latitude,void 0);var D=(y=T.getGeoLocationDataManager()).getCurrentGeoLocationData();D=Ai.calculateGeoLocationData(T.longitude,T.latitude,T.altitude,void 0,void 0,void 0,D,this);var I=T.owner;if(I){"GeographicCoordsList"===I.constructor.name&&I.makeLines(this);var E=I.owner;E&&("Excavation"===E.constructor.name?E.remakeExtrudeObject(this):"Tunnel"===E.constructor.name&&E.remakeMesh(this))}}}else if(this.weatherStation){var O=this.selectionManager.getSelectionCandidatesFamily("general");if(O){var N=O.currentSelected;if(N&&N instanceof te){e=(y=N.geoLocDataManager).getCurrentGeoLocationData(),i=this.sceneState.mouseAction;var V,B=Ai.getRayWorldSpace(t,this.mouse_x,this.mouse_y,void 0,this);if(V=i.strWorldPointAux){var j,U=V.getModul();if(j=this.globe.intersectionLineWgs84(B,j,U)){var G=new Ce(j[0],j[1],j[2]),k=Ai.pointToGeographicCoord(G,void 0,this),z=i.strLocationAux,H=e.geographicCoord,W=new R;W.setLonLatAlt(k.longitude-z.longitude,k.latitude-z.latitude,k.altitude-z.altitude);g=H.longitude+W.longitude,p=H.latitude+W.latitude;e=Ai.calculateGeoLocationData(g,p,void 0,void 0,void 0,void 0,e,this),i.strLocationAux.setLonLatAlt(k.longitude,k.latitude,k.altitude)}}}}}},N.prototype.test_renderDepth_objectSelected=function(t){var e=this.sceneState.gl;void 0===this.depthFboAux&&(this.depthFboAux=new b(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===this.depthFboAux.width[0]&&this.sceneState.drawingBufferHeight[0]===this.depthFboAux.height[0]||(this.depthFboAux.deleteObjects(e),this.depthFboAux=new b(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.depthFboAux.bind(),this.isFarestFrustum()&&(e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)),e.disable(e.BLEND),e.frontFace(e.CCW),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE);var i=this.postFxShadersManager.getShader("modelRefDepth");i.useProgram(),i.bindUniformGenerals(),i.enableVertexAttribArray(i.position3_loc);var o=t.geoLocDataManager.getCurrentGeoLocationData(),r=i.uniformsMapGeneral.frustumFar.uniformLocation;e.uniform1f(r,new Float32Array([1e8]));o.bindGeoLocationUniforms(e,i),e.uniform3fv(i.aditionalMov_loc,[0,0,0]),t.render(this,i,0),this.depthFboAux.unbind()},N.prototype.getRenderablesDetailedNeoBuildingAsimetricVersion=function(t,e,i,o){var r=e.data,n=r.neoBuilding;r.currentLod;if(void 0===n||void 0===n.octree)return!1;var a=n.getLodBuildingData(r.currentLod);if(void 0===a)return!1;if(!a.isModelRef)return!0;var s=e.getNodeGeoLocDataManager(),l=(s.getCurrentGeoLocationData(),s.getCurrentGeoLocationData());if(void 0===l)return!1;void 0===r.currentVisibleOctreesControler&&(r.currentVisibleOctreesControler=new gt);var d=this.magoPolicy.getLod0DistInMeters(),h=this.magoPolicy.getLod1DistInMeters(),c=this.magoPolicy.getLod2DistInMeters(),u=(this.magoPolicy.getLod3DistInMeters(),this.magoPolicy.getLod4DistInMeters(),this.magoPolicy.getLod5DistInMeters()),f=!1;if(void 0===r.myCameraRelative&&(r.myCameraRelative=new v),r.myCameraRelative.frustum.copyParametersFrom(this.myCameraSCX.bigFrustum),r.myCameraRelative=l.getTransformedRelativeCamera(this.sceneState.camera,r.myCameraRelative),r.currentVisibleOctreesControler.clear(),2===o)n.octree.extractLowestOctreesByLOD(r.currentVisibleOctreesControler,i,this.boundingSphere_Aux,r.myCameraRelative.position,d,h,u),f=!0;else{r.myCameraRelative.calculateFrustumsPlanes();var g=r.myCameraRelative.bigFrustum;f=n.octree.getFrustumVisibleLowestOctreesByLOD(g,r.currentVisibleOctreesControler,i,this.boundingSphere_Aux,r.myCameraRelative.position,d,h,100*c)}return f?(this.processQueue.eraseNodeToDeleteModelReferences(e),!0):(r.distToCam>100&&this.processQueue.putNodeToDeleteModelReferences(e,1),!1)},N.prototype.manageQueue=function(){var t=this.sceneState.gl;this.processQueue.manageDeleteQueue(this),this.parseQueue.initCounters(),this.parseQueue.parseArrayOctreesLod0References(t,this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0References(t,this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod0Models(t,this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0Models(t,this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod2Legos(t,this.visibleObjControlerOctrees.currentVisibles2,this),this.parseQueue.parseArrayOctreesPCloud(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArrayOctreesPCloudPartition(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles3,this);var e=0;for(var i in this.parseQueue.tinTerrainsToParseMap){var o;if(Object.prototype.hasOwnProperty.call(this.parseQueue.tinTerrainsToParseMap,i))if(void 0!==(o=this.parseQueue.tinTerrainsToParseMap[i])&&this.parseQueue.eraseTinTerrainToParse(o)&&(o.parseData(o.dataArrayBuffer),e++),e>1)break}},N.prototype.prepareVisibleOctreesSortedByDistancePointsCloudType=function(t,e,i){if(!(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)){var o=i,r=e.getAllVisibles();if(void 0!==r)for(var n,s,l,d,h=this.readerWriter.geometryDataPath,c=0,u=r.length;c<u;c++){if(this.fileRequestControler.isFullPlus(o))return;if(void 0!==(d=r[c]).octree_number_name&&(void 0===d.lego&&(d.lego=new Ct,d.lego.fileLoadState=a.fileLoadState.READY,d.lego.legoKey=d.octreeKey+"_lego"),void 0!==(s=d.neoBuildingOwner))){var f=s.metaData.projectDataType;if(void 0!==f&&4===f){if(n=s.projectFolderName,l=s.buildingFileName,d.lego.fileLoadState===a.fileLoadState.READY){var g=h+"/"+n+"/"+l+"/References"+"/"+d.octree_number_name.toString()+"_Ref";this.loadQueue.putLod2PCloudData(d,g,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)return}}}}},N.prototype.prepareVisibleOctreesSortedByDistance=function(t,e){if(!(this.readerWriter.referencesList_requested>5)){var i,o=[].concat(e.currentVisibles0,e.currentVisibles1);this.thereAreUrgentOctrees=!1;for(var r=0,n=o.length;r<n;r++){var a=(i=o[r]).neoBuildingOwner.getHeaderVersion();if(this.readerWriter.octreesSkinLegos_requested<5&&(void 0!==i.lego&&i.lego.isReadyToRender()||i.prepareSkinData(this)),this.readerWriter.referencesList_requested<5)if(void 0!==i.neoReferencesMotherAndIndices&&i.neoReferencesMotherAndIndices.isReadyToRender()){if("0.0.2"===a){var s=i.neoReferencesMotherAndIndices.blocksList;s&&s.prepareData(this,i)}}else i.prepareModelReferencesListData(this);if(this.readerWriter.referencesList_requested>5)return;0}}},N.prototype.prepareVisibleOctreesSortedByDistanceLOD2=function(t,e){if(!(this.readerWriter.octreesSkinLegos_requested>5)&&void 0!==e)for(var i=0,o=e.length;i<o;i++)if(e[i].prepareSkinData(this),this.readerWriter.octreesSkinLegos_requested>5)return},N.prototype.checkChangesHistoryMovements=function(t){for(var e,i,o,r,n,a=t.length,s=0;s<a;s++)void 0!==(i=(e=t[s]).getRoot())&&(i.getNodeGeoLocDataManager().getCurrentGeoLocationData(),o=e.data.projectId,r=e.data.nodeId,(n=l.getMovingHistoryObjects(o,r))&&(e.data.moveHistoryMap=n))},N.prototype.checkPropertyFilters=function(t){if(void 0!==this.propertyFilterSC)for(var e,i=t.length,o=this.propertyFilterSC.propertyKey,r=this.propertyFilterSC.propertyValue,n=this.propertyFilterSC.visible,a=0;a<i;a++)(e=t[a]).data.projectId===this.propertyFilterSC.projectId&&e.data.attributes&&(void 0!==e.data.attributes[o]&&e.data.attributes[o].toString()===r?"true"===n||(t.splice(a,1),a--,i=t.length):"true"===n&&(t.splice(a,1),a--,i=t.length))},N.prototype.checkChangesHistoryColors=function(t){for(var e,i,o=t.length,r=0;r<o;r++){if(void 0!==(e=t[r]).getRoot())if(f=e.data.projectId,i=e.data.nodeId,s=l.getColorHistorys(f,i))(m=e.data).colorChangedHistoryMap=s}var n=l.getAllColorHistory();if(n)for(var a in n)if(Object.prototype.hasOwnProperty.call(n,a)){var s=n[a];for(var d in s)if(Object.prototype.hasOwnProperty.call(s,d)){var h=s[d];for(var c in h)if(Object.prototype.hasOwnProperty.call(h,c)){var u=h[c],f=u.projectId,g=this.hierarchyManager.getNodesMap(f)[u.dataKey];if(g&&void 0!==g.data.attributes.isPhysical&&!1===g.data.attributes.isPhysical)if(null===u.property||void 0===u.property||""===u.property){t=[];g.extractNodes(t);for(o=t.length,r=0;r<o;r++){(m=(y=t[r]).data)&&(m.isColorChanged=!0,void 0===m.aditionalColor&&(m.aditionalColor=new x),m.aditionalColor.setRGB(u.rgbColor[0],u.rgbColor[1],u.rgbColor[2]))}}else{var p=u.propertyKey,v=u.propertyValue;t=[];g.extractNodes(t);for(o=t.length,r=0;r<o;r++){var y,m;(m=(y=t[r]).data)&&void 0!==y.data.attributes[p]&&y.data.attributes[p].toString()===v&&(m.isColorChanged=!0,void 0===m.aditionalColor&&(m.aditionalColor=new x),m.aditionalColor.setRGB(u.rgbColor[0],u.rgbColor[1],u.rgbColor[2]))}}}}}},N.prototype.getObjectLabel=function(){if(void 0===this.canvasObjectLabel){if(this.canvasObjectLabel=document.getElementById("objectLabel"),void 0===this.canvasObjectLabel)return;var t=document.getElementById("magoContainer"),e=t.offsetLeft,i=t.offsetTop;t.offsetWidth,t.offsetHeight;this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight;var o=e.toString()+"px",r=i.toString()+"px";this.canvasObjectLabel.style.left=o,this.canvasObjectLabel.style.top=r,this.canvasObjectLabel.style.position="absolute",this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight;var n=this.canvasObjectLabel.getContext("2d");n.strokeStyle="DarkSlateGray",n.fillStyle="PapayaWhip",n.lineWidth=4,n.font="20px Arial",n.textAlign="center",n.fillRect(0,0,n.canvas.width,n.canvas.height),n.save(),n.clearRect(0,0,n.canvas.width,n.canvas.height);n.measureText("M").width}return this.canvasObjectLabel},N.prototype.drawCCTVNames=function(t){var e=this.getObjectLabel().getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height);for(var i,o,r,n=this.sceneState.gl,a=t.length,s=0;s<a;s++)i=(r=t[s]).geoLocationData.position,(o=Ai.calculateWorldPositionToScreenCoord(n,i.x,i.y,i.z,o,this)).x>=0&&o.y>=0&&(e.font="13px Arial",e.strokeText(r.name,o.x,o.y),e.fillText(r.name,o.x,o.y));e.restore()},N.prototype.createDefaultShaders=function(t){var e="modelRefSsao",i=this.postFxShadersManager.newShader(e),o=ai.ModelRefSsaoVS,r=ai.ModelRefSsaoFS;i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState);e="modelRefDepth",i=this.postFxShadersManager.newShader(e);var n=ai.RenderShowDepthVS,a=ai.RenderShowDepthFS;i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,n,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,a,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState);e="modelRefColorCoding",i=this.postFxShadersManager.newShader(e),n=ai.ColorSelectionSsaoVS,a=ai.ColorSelectionSsaoFS;i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,n,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,a,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),e="tinTerrain",i=this.postFxShadersManager.newShader(e),o=ai.TinTerrainVS,r=ai.TinTerrainFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bIsMakingDepth_loc=t.getUniformLocation(i.program,"bIsMakingDepth"),e="pointsCloud",i=this.postFxShadersManager.newShader(e),o=ai.PointCloudVS,r=ai.PointCloudFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bPositionCompressed_loc=t.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=t.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=t.getUniformLocation(i.program,"bboxSize"),i.maxPointSize_loc=t.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=t.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=t.getUniformLocation(i.program,"pendentPointSize"),e="testQuad",i=this.postFxShadersManager.newShader(e),o=ai.Test_QuadVS,r=ai.Test_QuadFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),e="filterSilhouette",i=this.postFxShadersManager.newShader(e),o=ai.wgs84_volumVS,r=ai.filterSilhouetteFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),e="pointsCloudDepth",i=this.postFxShadersManager.newShader(e),o=ai.PointCloudDepthVS,r=ai.RenderShowDepthFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bPositionCompressed_loc=t.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=t.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=t.getUniformLocation(i.program,"bboxSize"),i.maxPointSize_loc=t.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=t.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=t.getUniformLocation(i.program,"pendentPointSize"),e="pointsCloudSsao",i=this.postFxShadersManager.newShader(e),o=ai.PointCloudVS,r=ai.PointCloudSsaoFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bPositionCompressed_loc=t.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=t.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=t.getUniformLocation(i.program,"bboxSize"),i.maxPointSize_loc=t.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=t.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=t.getUniformLocation(i.program,"pendentPointSize"),e="pointsCloudSsao_rainbow",i=this.postFxShadersManager.newShader(e),o=ai.PointCloudVS_rainbow,r=ai.PointCloudSsaoFS_rainbow,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bPositionCompressed_loc=t.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=t.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=t.getUniformLocation(i.program,"bboxSize"),i.bUseColorCodingByHeight_loc=t.getUniformLocation(i.program,"bUseColorCodingByHeight"),i.minHeight_rainbow_loc=t.getUniformLocation(i.program,"minHeight_rainbow"),i.maxHeight_rainbow_loc=t.getUniformLocation(i.program,"maxHeight_rainbow"),i.maxPointSize_loc=t.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=t.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=t.getUniformLocation(i.program,"pendentPointSize"),e="atmosphere",i=this.postFxShadersManager.newShader(e),o=ai.atmosphereVS,r=ai.atmosphereFS,i.program=t.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(t,o,t.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(i.program,i.shader_vertex),t.attachShader(i.program,i.shader_fragment),i.bindAttribLocations(t,i),t.linkProgram(i.program),i.createUniformGenerals(t,i,this.sceneState),i.createUniformLocals(t,i,this.sceneState),i.bIsMakingDepth_loc=t.getUniformLocation(i.program,"bIsMakingDepth"),i.equatorialRadius_loc=t.getUniformLocation(i.program,"equatorialRadius")},N.prototype.isFarestFrustum=function(){return this.numFrustums-this.currentFrustumIdx-1==0},N.prototype.doMultiFrustumCullingSmartTiles=function(t){var e=this.myCameraSCX.bigFrustum,i=this.smartTileManager.tilesArray[0],o=this.smartTileManager.tilesArray[1];void 0===this.frustumVolumeControl&&(this.frustumVolumeControl=new S),void 0===this.fullyIntersectedLowestTilesArray&&(this.fullyIntersectedLowestTilesArray=[]),void 0===this.partiallyIntersectedLowestTilesArray&&(this.partiallyIntersectedLowestTilesArray=[]),void 0===this.lastIntersectedLowestTilesArray&&(this.lastIntersectedLowestTilesArray=[]),this.lastIntersectedLowestTilesArray.push.apply(this.lastIntersectedLowestTilesArray,this.fullyIntersectedLowestTilesArray),this.lastIntersectedLowestTilesArray.push.apply(this.lastIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray);for(var r=this.lastIntersectedLowestTilesArray.length,n=0;n<r;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible=!1;this.fullyIntersectedLowestTilesArray.length=0,this.partiallyIntersectedLowestTilesArray.length=0,i.getFrustumIntersectedLowestTiles(e,this.fullyIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray),o.getFrustumIntersectedLowestTiles(e,this.fullyIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray),this.frustumVolumeControl.initArrays();var a=this.myCameraSCX.frustumsArray.length,l=this.fullyIntersectedLowestTilesArray.length;for(n=0;n<l;n++)if(void 0!==(h=this.fullyIntersectedLowestTilesArray[n]).sphereExtent){h.isVisible=!0;for(var d=a-1;d>=0;d--){if(this.myCameraSCX.frustumsArray[d].intersectionNearFarSphere(h.sphereExtent)!==s.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(d).fullyIntersectedLowestTilesArray.push(h)}}l=this.partiallyIntersectedLowestTilesArray.length;for(n=0;n<l;n++)if(void 0!==(h=this.partiallyIntersectedLowestTilesArray[n]).sphereExtent){h.isVisible=!0;for(d=a-1;d>=0;d--){if(this.myCameraSCX.frustumsArray[d].intersectionNearFarSphere(h.sphereExtent)!==s.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(d).partiallyIntersectedLowestTilesArray.push(h)}}var h;for(r=this.lastIntersectedLowestTilesArray.length,n=0;n<r;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible||(this.processQueue.putNodesArrayToDelete(h.nodesArray),h.clearNodesArray());this.lastIntersectedLowestTilesArray.length=0,void 0!==this.tinTerrainManager&&this.tinTerrainManager.doFrustumCulling(e,t.position,this)},N.prototype.tilesMultiFrustumCullingFinished=function(t,e,i,o,r){var n=t.length;if(0!==n)for(var a,l,d,h,c,u=this.magoPolicy,f=u.getLod1DistInMeters(),g=u.getLod2DistInMeters(),p=u.getLod5DistInMeters(),v=u.getLod0DistInMeters(),y=u.getLod1DistInMeters(),m=u.getLod2DistInMeters(),x=u.getLod3DistInMeters(),b=u.getLod4DistInMeters(),C=u.getLod5DistInMeters(),A=0;A<n;A++)if(void 0!==(l=t[A]).sphereExtent&&!((a=i.distToSphere(l.sphereExtent))>Number(p)))if(l.nodesArray&&l.nodesArray.length>0){for(var M=l.nodesArray.length,P=0;P<M;P++){if(c=(h=l.nodesArray[P]).getRoot(),"G15_0002"===h.data.nodeId);if(void 0!==c.data.geoLocDataManager)if(void 0!==(d=h.data.neoBuilding)){void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new J),a=h.getDistToCamera(i,this.boundingSphere_Aux);var T=h.data;if(T.currentLod,T.distToCam=a,T.distToCam<v?T.currentLod=0:T.distToCam<y?T.currentLod=1:T.distToCam<m?T.currentLod=2:T.distToCam<x?T.currentLod=3:T.distToCam<b?T.currentLod=4:T.distToCam<C&&(T.currentLod=5),a>u.getFrustumFarDistance())this.processQueue.putNodeToDelete(h,0);else{if("G15_0002"===h.data.nodeId);if(r)if(o.intersectionSphere(this.boundingSphere_Aux)===s.INTERSECTION_OUTSIDE){this.processQueue.putNodeToDeleteLessThanLod3(h,0);continue}if("G15_0002"===h.data.nodeId);var _=d.getHeaderVersion();if(void 0!==_)if("v"===_[0])a<f?e.putNodeToArraySortedByDist(e.currentVisibles0,h):a<1?e.putNodeToArraySortedByDist(e.currentVisibles1,h):a<g?e.putNodeToArraySortedByDist(e.currentVisibles2,h):a<p&&e.putNodeToArraySortedByDist(e.currentVisibles3,h);else{var w=d.metaData.projectDataType;!w||4!==w&&5!==w?a<f?e.putNodeToArraySortedByDist(e.currentVisibles0,h):a<1?e.putNodeToArraySortedByDist(e.currentVisibles1,h):a<g?e.putNodeToArraySortedByDist(e.currentVisibles2,h):a<p&&e.putNodeToArraySortedByDist(e.currentVisibles3,h):e.putNodeToArraySortedByDist(e.currentVisiblesAux,h)}}}else e.currentVisiblesAux.push(h);else h.calculateGeoLocData(this)}l.nodesArray.length!==l.nodeSeedsArray.length&&this.createBuildingsByBuildingSeedsOnLowestTile(l)}else this.createBuildingsByBuildingSeedsOnLowestTile(l)},N.prototype.createBuildingsByBuildingSeedsOnLowestTile=function(t){var e,i,o,r,n=0;t.nodesArray&&(n=t.nodesArray.length),void 0===t.nodesArray&&(t.nodesArray=[]);for(var a=t.nodeSeedsArray.length,s=n;s<a;s++)void 0===(e=t.nodeSeedsArray[s]).data.neoBuilding?((i=new St).nodeOwner=e,e.data.neoBuilding=i,void 0===e.data.bbox&&(e.data.bbox=new u),o=e.data.bbox,r=e.data.buildingSeed,t.nodesArray.push(e),void 0===i.metaData&&(i.metaData=new Tt),void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new R),void 0===i.metaData.bbox&&(i.metaData.bbox=new u),i.name=r.name,i.buildingId=r.buildingId,i.buildingType="basicBuilding",i.buildingFileName=r.buildingFileName,i.metaData.geographicCoord.setLonLatAlt(r.geographicCoord.longitude,r.geographicCoord.latitude,r.geographicCoord.altitude),i.metaData.bbox.copyFrom(r.bBox),o.copyFrom(r.bBox),void 0===i.bbox&&(i.bbox=new u),i.bbox.copyFrom(r.bBox),i.metaData.heading=r.rotationsDegree.z,i.metaData.pitch=r.rotationsDegree.x,i.metaData.roll=r.rotationsDegree.y,i.projectFolderName=e.data.projectFolderName):t.nodesArray.push(e)},N.prototype.flyToTopology=function(t,e){l.getPolicy().geo_view_library===s.CESIUM&&this.scene.camera.flyTo({destination:Cesium.Cartesian3.clone(t),orientation:{direction:new Cesium.Cartesian3(this.scene.camera.direction.x,this.scene.camera.direction.y,this.scene.camera.direction.z),up:new Cesium.Cartesian3(this.scene.camera.up.x,this.scene.camera.up.y,this.scene.camera.up.z)},duration:parseInt(e)})},N.prototype.flyTo=function(t,e,i,o){l.getPolicy().geo_view_library===s.CESIUM?this.scene.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(t),parseFloat(e),parseFloat(i)),duration:parseInt(o)}):l.getPolicy().geo_view_library===s.MAGOWORLD&&this.magoWorld.goto(parseFloat(t),parseFloat(e),parseFloat(i))},N.prototype.flyToBuilding=function(t,e,i){var o=this.hierarchyManager.getNodeByDataName(e,"nodeId",i);if(void 0!==o){var r,n=o.getRoot(),a=n.data.geoLocDataManager;if(void 0!==a||void 0!==(r=o.calculateGeoLocData(this))){r=(a=n.data.geoLocDataManager).getCurrentGeoLocationData();var d=o.getBBoxCenterPositionWorldCoord(r);if(void 0!==d&&n.data.bbox&&(this.radiusAprox_aux=n.data.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new J),this.boundingSphere_Aux.radius=this.radiusAprox_aux,this.configInformation.geo_view_library===s.CESIUM)){this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(d);this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,3)}}else apiResultCallback(l.getPolicy().geo_callback_apiresult,t,"-1")}else apiResultCallback(l.getPolicy().geo_callback_apiresult,t,"-1")},N.prototype.displayLocationAndRotation=function(t){var e=t.nodeOwner.getNodeGeoLocDataManager();if(void 0!==e){var i=e.getCurrentGeoLocationData();i.geographicCoord.latitude,i.geographicCoord.longitude,i.geographicCoord.altitude,i.heading,i.pitch,i.roll,t.buildingId.split("_")}},N.prototype.selectedObjectNotice=function(t){if(void 0!==t){var e=t.nodeOwner,i=e.getNodeGeoLocDataManager();if(void 0!==i){var o=i.getCurrentGeoLocationData(),r=e.data.nodeId,n=e.data.projectId;if("true"===l.getPolicy().geo_callback_enable){var a=null;if(void 0!==this.objectSelected&&(a=this.objectSelected.objectId),this.magoPolicy.getObjectInfoViewEnable()&&selectedObjectCallback(l.getPolicy().geo_callback_selectedobject,n,r,a,o.geographicCoord.latitude,o.geographicCoord.longitude,o.geographicCoord.altitude,o.heading,o.pitch,o.roll),this.magoPolicy.getIssueInsertEnable()){if(void 0===this.objMarkerSC)return;insertIssueCallback(l.getPolicy().geo_callback_insertissue,n,r,a,o.geographicCoord.latitude,o.geographicCoord.longitude,parseFloat(o.geographicCoord.altitude))}}}}},N.prototype.changeLocationAndRotation=function(t,e,i,o,r,n,a,s,l){var d=this.hierarchyManager.getNodeByDataKey(t,e);void 0!==d&&this.changeLocationAndRotationNode(d,i,o,r,n,a,s,l)},N.prototype.changeLocationAndRotationNode=function(t,e,i,o,r,n,a,s){if(void 0!==t){void 0!==s?(void 0===this.animationManager&&(this.animationManager=new c),this.animationManager.putNode(t),t.changeLocationAndRotationAnimated(e,i,o,r,n,a,this,s)):t.changeLocationAndRotation(e,i,o,r,n,a,this);var l=t.data.neoBuilding;this.selectedObjectNotice(l)}},N.prototype.getObjectIndexFile=function(t,e){var i;void 0===this.configInformation&&(this.configInformation=l.getPolicy()),this.buildingSeedList=new p;var o=e;i=this.readerWriter.geometryDataPath+"/"+o+s.OBJECT_INDEX_FILE+s.CACHE_VERSION+l.getPolicy().content_cache_version,this.readerWriter.getObjectIndexFileForSmartTile(i,this,this.buildingSeedList,t)},N.prototype.getObjectIndexFile_xxxx=function(){void 0===this.configInformation&&(this.configInformation=l.getPolicy()),this.buildingSeedList=new p,this.readerWriter.getObjectIndexFileForSmartTile(this.readerWriter.getCurrentDataPath()+s.OBJECT_INDEX_FILE+s.CACHE_VERSION+l.getPolicy().content_cache_version,this,this.buildingSeedList)},N.prototype.makeNode=function(t,e,i,o,r){var n,a,s,l,d,h,c=void 0,f=void 0,g=void 0,p=void 0,v=void 0,y=void 0,m=void 0,x=void 0,b=void 0,C=void 0,A=void 0;if(void 0!==t&&(c=t.attributes,f=t.children,t.data_group_id,t.data_group_name,t.data_id,g=t.data_key,p=t.data_name,v=t.heading,y=t.height,m=t.latitude,x=t.longitude,b=t.pitch,C=t.roll,A=t.mapping_type),void 0===v&&(v=0),void 0===b&&(b=0),void 0===C&&(C=0),void 0!==c&&!c.isReference){var M;if(n=g,(s=this.hierarchyManager.newNode(n,r,c)).data.projectFolderName=o,s.data.projectId=r,s.data.data_name=p,s.data.attributes=c,s.data.mapping_type=A,"G15_0002"===s.data.nodeId);if(c.isPhysical&&(a=i[n])&&(s.data.buildingSeed=a,e.push(s)),x&&m&&(void 0===y&&(y=0),s.data.geographicCoord=new R,s.data.geographicCoord.setLonLatAlt(x,m,y),void 0===s.data.rotationsDegree&&(s.data.rotationsDegree=new Ce),s.data.rotationsDegree.set(b,C,v),void 0!==a)){void 0===a.geographicCoord&&(a.geographicCoord=new R),void 0===a.rotationsDegree&&(a.rotationsDegree=new Ce),a.geographicCoord.setLonLatAlt(x,m,y),a.rotationsDegree.set(b,C,v),void 0===a.geographicCoordOfBBox&&(a.geographicCoordOfBBox=new R);var P,T=Ai.geographicCoordToWorldPoint(x,m,y,T,this);M=Ai.calculateTransformMatrixAtWorldPosition(T,v,b,C,void 0,M,this),P=a.bBox.getCenterPoint(P);var _=M.transformPoint3D(P,_);a.geographicCoordOfBBox=Ai.pointToGeographicCoord(_,a.geographicCoordOfBBox,this),a.geographicCoordOfBBox.altitude=a.geographicCoord.altitude}if(s.data.bbox=new u,s.data.buildingSeed&&s.data.buildingSeed.bBox&&s.data.bbox.copyFrom(a.bBox),s.data.mapping_type&&"boundingboxcenter"===s.data.mapping_type.toLowerCase()&&s.data.bbox.translateToOrigin(),void 0!==M){P=s.data.bbox.getCenterPoint(P);_=M.transformPoint3D(P,_);s.data.bbox.geographicCoord=Ai.pointToGeographicCoord(_,s.data.bbox.geographicCoord,this)}if(void 0!==f){h=f.length;for(var w=0;w<h;w++)l=f[w],void 0===(d=this.makeNode(l,e,i,o,r)).data.geographicCoord&&s.addChildren(d)}}return s},N.prototype.calculateBoundingBoxesNodes=function(){for(var t,e,i,o,r,n,a,s,l,d=this.hierarchyManager.nodesArray.length,h=0;h<d;h++)if(i=(t=this.hierarchyManager.nodesArray[h]).data.buildingSeed){o=(e=t.getClosestParentWithData("geographicCoord")).data.geographicCoord.longitude,r=e.data.geographicCoord.latitude,n=e.data.geographicCoord.altitude,a=e.data.rotationsDegree.z,s=e.data.rotationsDegree.x,l=e.data.rotationsDegree.y,void 0===i.geographicCoord&&(i.geographicCoord=new R),void 0===i.rotationsDegree&&(i.rotationsDegree=new Ce),i.geographicCoord.setLonLatAlt(o,r,n),i.rotationsDegree.set(s,l,a),void 0===i.geographicCoordOfBBox&&(i.geographicCoordOfBBox=new R);var c=Ai.geographicCoordToWorldPoint(o,r,n,c,this),u=Ai.calculateTransformMatrixAtWorldPosition(c,a,s,l,void 0,u,this);if(t.data.attributes.mapping_type&&"boundingboxcenter"===t.data.attributes.mapping_type){var f=i.bBox.getCenterPoint(f),g=u.transformPoint3D(f,g);i.geographicCoordOfBBox=Ai.pointToGeographicCoord(g,i.geographicCoordOfBBox,this)}else i.geographicCoordOfBBox.setLonLatAlt(o,r,n)}var p=[],v=[];this.hierarchyManager.getRootNodes(p);var y=!1,m=p.length;for(h=0;h<m;h++){e=p[h],v.length=0,e.extractNodesByDataName(v,"buildingSeed"),y=!1,d=v.length;for(var x=0;x<d;x++){var b=(t=v[x]).data.bbox;b&&(t.data.attributes?(t.data.attributes.isMain,!1===y?(e.data.bbox.copyFrom(b),y=!0):e.data.bbox.addBox(b)):!1===y?(e.data.bbox.copyFrom(b),y=!0):e.data.bbox.addBox(b))}}},N.prototype.makeSmartTile=function(t,e){for(var i,o=l.getData(a.PROJECT_ID_PREFIX+e),r=[],n={},s=t.buildingSeedArray.length,d=0;d<s;d++)n[(i=t.buildingSeedArray[d]).buildingId]=i;var h=o.data_key;this.makeNode(o,r,n,h,e),this.calculateBoundingBoxesNodes();this.smartTileManager.makeTreeByDepth(17,r,this),this.buildingSeedList.buildingSeedArray.length=0},N.prototype.instantiateStaticModel=function(t){if(!xi(t.projectId))throw new Error("projectId is required.");if(!this.isExistStaticModel(t.projectId))throw new Error("static model is not exist.");if(!xi(t.instanceId))throw new Error("instanceId is required.");if(!xi(t.longitude))throw new Error("longitude is required.");if(!xi(t.latitude))throw new Error("latitude is required.");t.isReference||(t.isReference=!0),t.isPhysical||(t.isPhysical=!0),t.nodeType||(t.nodeType="TEST");var e=t.projectId,i=t.instanceId,o=t.longitude,r=t.latitude,n=parseFloat(mi(t.height,0)),a=parseFloat(mi(t.heading,0)),s=parseFloat(mi(t.pitch,0)),l=parseFloat(mi(t.roll,0)),d=this.hierarchyManager.getNodeByDataKey(e,i);if(void 0===d){d=this.hierarchyManager.newNode(i,e,void 0);var h=new R;h.latitude=parseFloat(r),h.longitude=parseFloat(o),h.altitude=parseFloat(n);var c=h.getGeoLocationDataManager(),u=c.newGeoLocationData("noName");u=Ai.calculateGeoLocationData(h.longitude,h.latitude,h.altitude+1,a,s,l,u,this),d.data.projectId=e,d.data.attributes=t,d.data.geographicCoord=h,d.data.rotationsDegree=new Ce(s,l,a),d.data.geoLocDataManager=c;var f=mi(this.smartTileManager.targetDepth,17);this.smartTileManager.putNode(f,d,this)}else this.changeLocationAndRotation(e,i,r,o,n,a,s,l)},N.prototype.addStaticModel=function(t){if(!xi(t.projectId))throw new Error("projectId is required.");if(!xi(t.projectFolderName))throw new Error("projectFolderName is required.");if(!xi(t.buildingFolderName))throw new Error("buildingFolderName is required.");var e=t.projectId,i=this.hierarchyManager.getStaticModelsManager(),o=new Fe;o.guid=e,o.projectFolderName=t.projectFolderName,o.buildingFolderName=t.buildingFolderName,o.neoBuilding=new St,i.addStaticModel(e,o)},N.prototype.isExistStaticModel=function(t){var e=!1;return this.hierarchyManager.staticModelsManager&&this.hierarchyManager.staticModelsManager.staticModelsMap?(this.hierarchyManager.staticModelsManager.staticModelsMap.hasOwnProperty(t)&&(e=!0),e):e},N.prototype.callAPI=function(r){var n=r.getAPIName();if("changeMagoState"===n)this.magoPolicy.setMagoEnable(r.getMagoEnable());else{if("searchData"===n)return this.flyToBuilding(n,r.getProjectId(),r.getDataKey());if("changeColor"===n)t.changeColor(r,this);else if("show"===n)this.magoPolicy.setHideBuildings.length=0;else if("hide"===n)this.magoPolicy.setHideBuildings(r.gethideBuilds());else if("changeOutFitting"===n)this.magoPolicy.setShowOutFitting(r.getShowOutFitting());else if("changeLabel"===n){this.magoPolicy.setShowLabelInfo(r.getShowLabelInfo());var d=document.getElementById("objectLabel").getContext("2d");d.clearRect(0,0,d.canvas.width,d.canvas.height)}else if("changeOrigin"===n)this.magoPolicy.setShowOrigin(r.getShowOrigin());else if("changeBoundingBox"===n)this.magoPolicy.setShowBoundingBox(r.getShowBoundingBox());else if("changeShadow"===n)this.magoPolicy.setShowShadow(r.getShowShadow());else if("changefrustumFarDistance"===n)this.magoPolicy.setFrustumFarSquaredDistance(r.getFrustumFarDistance()*r.getFrustumFarDistance());else if("changeLocationAndRotation"===n)i.changeLocationAndRotation(r,this);else if("changeObjectMove"===n)this.magoPolicy.setObjectMoveMode(r.getObjectMoveMode());else if("saveObjectMove"===n);else if("deleteAllObjectMove"===n){var h=l.getAllMovingHistory();if(void 0===h)return void l.clearMovingHistory();for(var c in h)if(Object.prototype.hasOwnProperty.call(h,c)){if(void 0===(v=h[E=c]))continue;for(var u in v)if(Object.prototype.hasOwnProperty.call(v,u)){var f=u;if(void 0===(y=v[u]))continue;for(var g in y)if(Object.prototype.hasOwnProperty.call(y,g)){if(void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f))||void 0===nt.data)continue;if(void 0===(M=nt.data.neoBuilding))continue;(A=M.getReferenceObject(g))&&(A.moveVector=void 0,A.moveVectorRelToBuilding=void 0)}}}l.clearMovingHistory()}else if("deleteAllChangeColor"===n){var p=l.getAllColorHistory();if(void 0===p)return void l.clearColorHistory();for(var c in p)if(Object.prototype.hasOwnProperty.call(p,c)){var v;if(void 0===(v=p[E=c]))continue;for(var u in v)if(Object.prototype.hasOwnProperty.call(v,u)){var y;f=u;if(void 0===(y=v[u]))continue;for(var m in y)if(Object.prototype.hasOwnProperty.call(y,m)){if(void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f))||void 0===nt.data)continue;if(nt.data.isColorChanged=!1,void 0===(M=nt.data.neoBuilding))continue;var x=M.getReferenceObjectsArrayByObjectId(m);if(void 0===x)continue;for(var b=x.length,C=0;C<b;C++){var A;(A=x[C])&&(A.aditionalColor=void 0)}}}}l.clearColorHistory()}else if("changeInsertIssueMode"===n)this.magoPolicy.setIssueInsertEnable(r.getIssueInsertEnable());else if("changeObjectInfoViewMode"===n)this.magoPolicy.setObjectInfoViewEnable(r.getObjectInfoViewEnable());else if("changeNearGeoIssueListViewMode"===n)this.magoPolicy.setNearGeoIssueListEnable(r.getNearGeoIssueListEnable()),r.getNearGeoIssueListEnable()||(this.objMarkerManager.objectMarkerArray=[]);else if("changeOcclusionCulling"===n){var M;this.magoPolicy.setOcclusionCullingEnable(r.getOcclusionCullingEnable()),(M=this.selectionManager.currentBuildingSelected)&&M.setRenderSettingApplyOcclusionCulling(this.magoPolicy.getOcclusionCullingEnable())}else if("drawInsertIssueImage"===n)e.drawInsertIssueImage(r,this);else if("changeInsertIssueState"===n)this.sceneState.insertIssueState=0;else if("changeLod"===n)o.changeLod(r,this);else if("changeLighting"===n)this.magoPolicy.setAmbientReflectionCoef(r.getAmbientReflectionCoef()),this.magoPolicy.setDiffuseReflectionCoef(r.getDiffuseReflectionCoef()),this.magoPolicy.setSpecularReflectionCoef(r.getSpecularReflectionCoef()),this.magoPolicy.setSpecularColor(r.getSpecularColor());else if("changeSsaoRadius"===n)this.magoPolicy.setSsaoRadius(r.getSsaoRadius());else if("changeFPVMode"===n)if(r.getFPVMode()){if(void 0!==this.cameraFPV._camera)return;if(this.cameraFPV.init(),this.configInformation.geo_view_library===s.CESIUM){var P=new Cesium.Matrix4,T=new Cesium.Cartesian4,_=this.scene.camera;this.cameraFPV._camera=_,this.cameraFPV._cameraBAK=Cesium.Camera.clone(_,this.cameraFPV._cameraBAK);var w=new Cesium.Cartesian3,S=new Cesium.Cartesian3,R=new Cesium.Cartesian3,L=this.scene.globe.ellipsoid.cartesianToCartographic(_.position);L.height=this.scene.globe.getHeight(L)+1.5,this.scene.globe.ellipsoid.cartographicToCartesian(L,w);var D=Cesium.Transforms.eastNorthUpToFixedFrame(w,Cesium.Ellipsoid.WGS84,P);Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(D,1,T),S),Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(D,2,T),R),_.flyTo({destination:w,orientation:{direction:S,up:R},duration:1})}}else{if(void 0===this.cameraFPV._cameraBAK)return;this.configInformation.geo_view_library===s.CESIUM&&(this.scene.camera=Cesium.Camera.clone(this.cameraFPV._cameraBAK,this.scene.camera)),this.cameraFPV.release()}else if("changePropertyRendering"===n){var I=r.getShowShadow(),E=r.getProjectId(),O=r.getProperty().split("="),F=O[0],N=O[1];void 0===this.propertyFilterSC&&(this.propertyFilterSC={}),this.propertyFilterSC.visible=I,this.propertyFilterSC.projectId=E,this.propertyFilterSC.propertyKey=F,this.propertyFilterSC.propertyValue=N}else if("drawAppendData"===n)e.drawAppendData(r,this);else if("drawDeleteData"===n)this.deleteAll();else if("clearAllData"===n)this.deleteAll();else if("getDataInfoByDataKey"===n){E=r.getProjectId(),f=r.getDataKey();if(void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f)))return void apiResultCallback(l.getPolicy().geo_callback_apiresult,n,"-1");var V=nt.data.data_name,B=nt.data.geoLocDataManager;if(void 0===V||void 0===B)return void apiResultCallback(l.getPolicy().geo_callback_apiresult,n,"-1");if(void 0===(q=B.getCurrentGeoLocationData())||void 0===q.geographicCoord)return void apiResultCallback(l.getPolicy().geo_callback_apiresult,n,"-1");E=nt.data.projectId;var j=q.geographicCoord.latitude,U=q.geographicCoord.longitude,G=q.geographicCoord.altitude,k=q.heading,z=q.pitch,H=q.roll;dataInfoCallback(l.getPolicy().geo_callback_dataInfo,E,f,V,j,U,G,k,z,H)}else if("gotoProject"===n){E=r.getProjectId();var W=this.hierarchyManager.getNodesMap(E);if(0===Object.keys(W).length){var X=r.getProjectDataFolder();this.getObjectIndexFile(E,X)}this.flyTo(r.getLongitude(),r.getLatitude(),r.getElevation(),r.getDuration())}else if("gotoIssue"===n){E=r.getProjectId();if(!this.hierarchyManager.existProject(E)){X=r.getProjectDataFolder();this.getObjectIndexFile(E,X)}this.flyTo(r.getLongitude(),r.getLatitude(),r.getElevation(),r.getDuration()),null!==r.getIssueId()&&void 0!==r.getIssueType()&&e.drawInsertIssueImage(r,this)}else if("gotoFly"===n)this.flyTo(r.getLongitude(),r.getLatitude(),r.getElevation(),r.getDuration());else{if("getCoordinateRelativeToBuilding"===n){E=r.getProjectId(),f=r.getDataKey();var K=r.getInputPoint(),Y=r.getResultPoint();if(void 0===E||void 0===f||void 0===K)return;if(void 0===Y&&(Y=new Ce),void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f)))return;if(void 0===(B=nt.data.geoLocDataManager))return;return Y=(q=B.getCurrentGeoLocationData()).worldCoordToLocalCoord(K,Y)}if("getAbsoluteCoodinateOfBuildingPoint"===n){E=r.getProjectId(),f=r.getDataKey();var q,Z=r.getInputPoint();Y=r.getResultPoint();if(void 0===E||void 0===f||void 0===Z)return;if(void 0===Y&&(Y=new Ce),void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f)))return;if(void 0===(B=nt.data.geoLocDataManager))return;return Y=(q=B.getCurrentGeoLocationData()).localCoordToWorldCoord(Z,Y)}if("changeMagoMode"===n)console.log("changeMagoMode");else if("getCameraCurrentPosition"===n){var Q=r.getUnit();if(this.configInformation.geo_view_library===s.CESIUM){w=this.scene.camera.position;switch(Q){case a.units.METRE:return w;case a.units.RADIAN:return Cesium.Cartographic.fromCartesian(w);case a.units.DEGREE:var J=Cesium.Cartographic.fromCartesian(w);return{lat:Cesium.Math.toDegrees(J.latitude),lon:Cesium.Math.toDegrees(J.longitude),alt:J.height}}}}else if("getCameraCurrentOrientaion"===n){if(l.getPolicy().geo_view_library===s.CESIUM){if(!(_=this.scene.camera))throw new Error("Camera is broken.");return{heading:Cesium.Math.toDegrees(_.heading),pitch:Cesium.Math.toDegrees(_.pitch),roll:Cesium.Math.toDegrees(_.roll)}}}else if("changeCameraOrientation"===n){_=this.scene.camera,k=mi(r.getHeading(),Cesium.Math.toDegrees(_.heading)),z=mi(r.getPitch(),Cesium.Math.toDegrees(_.pitch)),H=mi(r.getRoll(),Cesium.Math.toDegrees(_.roll));var $=mi(r.getDuration(),0);if(l.getPolicy().geo_view_library===s.CESIUM){if(!(_=this.scene.camera))throw new Error("Camera is broken.");_.flyTo({destination:_.positionWC,orientation:{heading:Cesium.Math.toRadians(k),pitch:Cesium.Math.toRadians(z),roll:Cesium.Math.toRadians(H)},duration:parseInt($)})}}else if("instantiateStaticModel"===n){var tt=r.getInstantiateObj();this.instantiateStaticModel(tt)}else if("addStaticModel"===n){var et=r.getStaticModelAttributeObj();this.addStaticModel(et)}else if("setTrackNode"===n){if(!xi(nt=this.hierarchyManager.getNodeByDataKey(r.getProjectId(),r.getDataKey())))throw new Error("This node is not exist.");if(nt.isReadyToRender){var it=(B=nt.getNodeGeoLocDataManager()).getCurrentGeoLocationData().getGeographicCoords(),ot=it.longitude,rt=it.latitude;this.flyTo(ot,rt,100,0),(_=this.sceneState.camera).stopTrack(this),_.setTrack(nt,r.getTrackOption())}}else if("stopTrack"===n)this.sceneState.camera.stopTrack(this);else{if("isExistStaticModel"===n)return this.isExistStaticModel(r.getProjectId());if("isExistData"===n){E=r.getProjectId(),f=r.getDataKey();if(!xi(E))throw new Error("projectId is required.");if(!xi(f))throw new Error("dataKey is required.");return void 0!==(nt=this.hierarchyManager.getNodeByDataKey(E,f))}if("isDataReadyToRender"===n){E=r.getProjectId(),f=r.getDataKey();if(!xi(E))throw new Error("projectId is required.");if(!xi(f))throw new Error("dataKey is required.");return!(void 0===(nt=this.hierarchyManager.getNodeByDataKey(E,f))||!nt.isReadyToRender())}if("setNodeAttribute"===n){var nt;E=r.getProjectId(),f=r.getDataKey(),et=r.getNodeAttribute();if(!xi(E))throw new Error("projectId is required.");if(!xi(f))throw new Error("dataKey is required.");if(void 0!==(nt=this.hierarchyManager.getNodeByDataKey(E,f))&&nt.data){var at=nt.data;at.attributes||(at.attributes={});var st=at.attributes;for(var lt in et)et.hasOwnProperty(lt)&&(st[lt]=et[lt])}return!1}if("togglePointCloudColor"===n){var dt=this._settings.getRenderingSettings(),ht=dt.getPointsCloudInColorRamp();dt.setPointsCloudInColorRamp(!ht)}}}}},N.prototype.deleteAll=function(){this.selectionManager.clearCandidates(),this.selectionManager.clearCurrents(),this.objectSelected=void 0,this.octreeSelected=void 0,this.buildingSelected=void 0,this.nodeSelected=void 0,this.parseQueue.clearAll(),this.processQueue.clearAll(),this.visibleObjControlerBuildings&&this.visibleObjControlerBuildings.clear(),this.visibleObjControlerNodes&&this.visibleObjControlerNodes.clear(),this.visibleObjControlerOctrees&&this.visibleObjControlerOctrees.clear(),this.smartTileManager.resetTiles(),this.hierarchyManager.deleteNodes(this.sceneState.gl,this.vboMemoryManager)},N.prototype.checkCollision=function(t,e){var i=this.sceneState.gl;if(void 0!==i){var o=.5*this.sceneState.drawingBufferWidth,r=.5*this.sceneState.drawingBufferHeight;if(void 0!==this.getSelectedObjects(i,o,r,this.arrayAuxSC)){var n=this.buildingSelected;this.buildingSelected=this.arrayAuxSC[0];var a=new Ce,s=new Ce;Ai.calculatePixelPositionWorldCoord(i,o,r,a,void 0,void 0,this),this.swapRenderingFase(),Ai.calculatePixelPositionWorldCoord(i,o,this.sceneState.drawingBufferHeight,void 0,void 0,this),this.buildingSelected=n;var l=a.squareDistTo(t.x,t.y,t.z);if(this.swapRenderingFase(),l>3.5){var d=this.scene.globe.ellipsoid.cartesianToCartographic(s),h=this.scene.globe.ellipsoid.cartesianToCartographic(t),c=h.height,u=d.height+1.5;u<c&&(c-=.2),(u>c||u<c&&c-u>1.5)&&(c=u);var f=Cesium.Math.toDegrees(h.latitude),g=Cesium.Math.toDegrees(h.longitude);return this.cameraFPV.camera.position=Cesium.Cartesian3.fromDegrees(g,f,c),!1}return!0}}};var V=function(t,e,i,o,n,d,h,c){if(!(this instanceof V))throw new Error(j.CONSTRUCT_ERROR);var u=null,f=null,g=a.magoManagerState.INIT,p=c||{};function v(){u.handler.setInputAction(function(t){u.mouseActionLeftDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),u.handler.setInputAction(function(t){u.mouseActionMiddleDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),u.handler.setInputAction(function(t){u.mouseActionRightDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),u.handler.setInputAction(function(e){var i;u.mouseLeftDown?e.startPosition.x===e.endPosition.x&&e.startPosition.y===e.endPosition.y||(u.manageMouseDragging(e.startPosition.x,e.startPosition.y),u.cameraMoved()):(u.mouseDragging=!1,i=!0,t.scene.screenSpaceCameraController.enableRotate=i,t.scene.screenSpaceCameraController.enableZoom=i,t.scene.screenSpaceCameraController.enableLook=i,t.scene.screenSpaceCameraController.enableTilt=i,t.scene.screenSpaceCameraController.enableTranslate=i,(u.mouseMiddleDown||u.mouseRightDown)&&(u.isCameraMoving=!0,u.cameraMoved()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),u.handler.setInputAction(function(t){u.mouseActionLeftUp(t.position.x,t.position.y);var e={lat:null,lon:null,alt:null},o=u.scene.camera.pickEllipsoid(t.position);if(o){var r=Cesium.Cartographic.fromCartesian(o);e.lat=Cesium.Math.toDegrees(r.latitude),e.lon=Cesium.Math.toDegrees(r.longitude),e.alt=r.height}"true"===l.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,e)},Cesium.ScreenSpaceEventType.LEFT_UP),u.handler.setInputAction(function(t){u.mouseActionMiddleUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),u.handler.setInputAction(function(t){u.mouseActionRightUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP),u.handler.setInputAction(function(t){u.mouseActionLeftClick(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function y(){var e,i;l.getPolicy().geo_view_library===s.CESIUM?function(){var e=t.scene.context._gl;if(t.scene.magoManager.postFxShadersManager.gl=e,t.scene.magoManager.postFxShadersManager.createDefaultShaders(e),t.scene.magoManager.createDefaultShaders(e),t.scene.magoManager.scene=t.scene,u=t.scene.magoManager,f=t.scene,t.scene.globe.depthTestAgainstTerrain=!0,t.scene.logarithmicDepthBuffer=!1,t.scene.highDynamicRange=!1,null!==o&&o.length>0)for(var i=0;i<o.length;i++){var r=d[i],a=n[i];a.data_key===r&&a.attributes.isReference||t.scene.magoManager.getObjectIndexFile(o[i],r)}t.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(f.canvas),v(),t.clock.onTick.addEventListener(function(t){u.cameraFPV.update(u)})}():l.getPolicy().geo_view_library===s.WORLDWIND||l.getPolicy().geo_view_library===s.MAGOWORLD&&(e=t.magoManager.sceneState.gl,(i=t.magoManager).vboMemoryManager.gl=e,i.postFxShadersManager.gl=e,i.postFxShadersManager.createDefaultShaders(e),i.createDefaultShaders(e))}l.init(i,o,n);var m,x,b="ESRI World Imagery",C="WGS84 Ellipsoid";if(null===i.geo_view_library||""===i.geo_view_library||i.geo_view_library===s.CESIUM){if((P=document.getElementById(e)).addEventListener("webglcontextlost",function(t){console.log(t)},!1),P.addEventListener("webglcontextrestored",function(t){console.log(t)},!1),"true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){var A=new Cesium.WebMapServiceImageryProvider({url:i.geo_server_url,layers:i.geo_server_layers,parameters:{service:i.geo_server_parameters_service,version:i.geo_server_parameters_version,request:i.geo_server_parameters_request,transparent:i.geo_server_parameters_transparent,format:i.geo_server_parameters_format}});p.imageryProvider=A,p.baseLayerPicker=!1,null===t&&(t=new Cesium.Viewer(e,p))}else null!==i.geo_cesium_ion_token&&""!==i.geo_cesium_ion_token&&(Cesium.Ion.defaultAccessToken=i.geo_cesium_ion_token,C="Cesium World Terrain"),p.shouldAnimate=!0,null===t&&(t=new Cesium.Viewer(e,p)),function(){if(null!==l.getPolicy().geo_init_default_terrain&&""!==l.getPolicy().geo_init_default_terrain&&(C=l.getPolicy().geo_init_default_terrain),void 0!==t&&void 0!==t.baseLayerPicker){var e=null,i=t.baseLayerPicker.viewModel.imageryProviderViewModels;for(var o in i)if(i.hasOwnProperty(o)&&(a=i[o]).name===b){e=a;break}e&&(t.baseLayerPicker.viewModel.selectedImagery=e);var r=null,n=t.baseLayerPicker.viewModel.terrainProviderViewModels;for(var o in n){var a;if(n.hasOwnProperty(o)&&(a=n[o]).name===C){r=a;break}}r&&(t.baseLayerPicker.viewModel.selectedTerrain=r)}}();t.scene.magoManager=new N,t.scene.magoManager.sceneState.textureFlipYAxis=!1,t.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,l.getPolicy().geo_init_default_fov>0&&(t.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*l.getPolicy().geo_init_default_fov),"true"===i.geo_server_enable&&null!==i.geo_server_add_url&&""!==i.geo_server_add_url&&(x=new Cesium.WebMapServiceImageryProvider({url:l.getPolicy().geo_server_add_url,layers:l.getPolicy().geo_server_add_layers,parameters:{service:l.getPolicy().geo_server_add_parameters_service,version:l.getPolicy().geo_server_add_parameters_version,request:l.getPolicy().geo_server_add_parameters_request,transparent:l.getPolicy().geo_server_add_parameters_transparent,format:l.getPolicy().geo_server_add_parameters_format}}),t.imageryLayers.addImageryProvider(x)),y(),t.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),"true"===i.geo_init_camera_enable&&t.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(l.getPolicy().geo_init_longitude),parseFloat(l.getPolicy().geo_init_latitude),parseFloat(l.getPolicy().geo_init_height)),duration:parseInt(l.getPolicy().geo_init_duration)}),m=new r("renderMode"),u.callAPI(m)}else if(i.geo_view_library===s.WORLDWIND){WorldWind.Logger.setLoggingLevel(WorldWind.Logger.LEVEL_WARNING);var M,P=document.getElementById(e);if("true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){M=new WorldWind.WorldWindow(e,new WorldWind.ZeroElevationModel);var T=i.geo_server_url+"?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0";$.get(T).done(function(t){var e=new WorldWind.WmsCapabilities(t).getNamedLayer("mago3d"),i=WorldWind.WmsLayer.formLayerConfiguration(e);i.title="imageProvider";var o=new WorldWind.WmsLayer(i);M.addLayer(o)}).fail(function(t,e,i){console.log("There was a failure retrieving the capabilities document: "+e+" exception: "+i)})}else{M=new WorldWind.WorldWindow(e);for(var _=[{layer:new WorldWind.BMNGLayer,enabled:!0},{layer:new WorldWind.BMNGLandsatLayer,enabled:!1},{layer:new WorldWind.BingAerialWithLabelsLayer(null),enabled:!0},{layer:new WorldWind.OpenStreetMapImageLayer(null),enabled:!1},{layer:new WorldWind.CompassLayer,enabled:!1},{layer:new WorldWind.CoordinatesDisplayLayer(M),enabled:!0},{layer:new WorldWind.ViewControlsLayer(M),enabled:!0}],w=0;w<_.length;w++)_[w].layer.enabled=_[w].enabled,M.addLayer(_[w].layer)}(u=new N).wwd=M,u.sceneState.textureFlipYAxis=!0;var S=new WorldWind.RenderableLayer;S.displayName="F4D tiles",S.inCurrentFrame=!0,M.addLayer(S),S.addRenderable(u);var R=M.drawContext.currentGlContext;!function(t,e){if(t.postFxShadersManager.gl=e,t.postFxShadersManager.createDefaultShaders(e),t.createDefaultShaders(e),null!==o&&o.length>0)for(var i=0;i<o.length;i++){var r=d[i],a=n[i];a.data_key===r&&a.attributes.isReference||t.getObjectIndexFile(o[i],r)}}(u,R);new WorldWind.ClickRecognizer(M,function(t){}).button=0;M.addEventListener("mousedown",function(t){0===t.button?u.mouseActionLeftDown(t.layerX,t.layerY):1===t.button?u.mouseActionMiddleDown(t.layerX,t.layerY):2===t.button&&u.mouseActionRightDown(t.layerX,t.layerY)},!1);M.addEventListener("mouseup",function(t){var e;0===t.button?u.mouseActionLeftUp(t.layerX,t.layerY):1===t.button?u.mouseActionMiddleUp(t.layerX,t.layerY):2===t.button&&u.mouseActionRightUp(t.layerX,t.layerY);var o={lat:null,lon:null,alt:null},r=M.canvasCoordinates(t.layerX,t.layerY);if(r[0]>=0&&r[0]<M.canvas.width&&r[1]>=0&&r[1]<M.canvas.height){var n=(e=M.pickTerrain(r).terrainObject())?e.position:null;null!==n&&(o.lat=n.latitude,o.lon=n.longitude,o.alt=n.altitude)}"true"===l.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,o)},!1);M.addEventListener("mousemove",function(t){u.mouse_x=t.layerX,u.mouse_y=t.layerY,u.mouseLeftDown?(u.manageMouseDragging(t.layerX,t.layerY),u.cameraMoved()):(u.mouseMiddleDown||u.mouseRightDown)&&u.cameraMoved()},!1),M.goToAnimator.travelTime=1e3*l.getPolicy().geo_init_duration,M.goTo(new WorldWind.Position(l.getPolicy().geo_init_latitude,l.getPolicy().geo_init_longitude,l.getPolicy().geo_init_height))}if(i.geo_view_library===s.MAGOWORLD){var L={antialias:!1,stencil:!0};(R=(P=document.getElementById(e)).getContext("webgl",L))||(R=P.getContext("experimental-webgl",L)),P.width=P.clientWidth,P.height=P.clientHeight;var D=(u=new N).sceneState;D.textureFlipYAxis=!0,D.gl=R,D.drawingBufferWidth[0]=P.clientWidth,D.drawingBufferHeight[0]=P.clientHeight,D.camera.frustum.aspectRatio[0]=P.clientWidth/P.clientHeight,D.camera.frustum.fovRad[0]=Math.PI/3*1.8,D.camera.frustum.fovyRad[0]=D.camera.frustum.fovRad[0]/D.camera.frustum.aspectRatio,D.camera.frustum.tangentOfHalfFovy[0]=Math.tan(D.camera.frustum.fovyRad[0]/2),D.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),D.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),D.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),D.encodedCamPosHigh[0]=-7536640,D.encodedCamPosHigh[1]=10878976,D.encodedCamPosHigh[2]=5636096,D.encodedCamPosLow[0]=-50297.7421875,D.encodedCamPosLow[1]=2883.05419921875,D.encodedCamPosLow[2]=12168.9990234375,t=new he(u),u.magoWorld=t,u.globe=new F,t.updateModelViewMatrixByCamera(D.camera),u.tinTerrainManager=new Gt,P.addEventListener("mousedown",function(e){t.mousedown(e)},!1),P.addEventListener("mouseup",function(e){t.mouseup(e)},!1),P.addEventListener("mousewheel",function(e){t.mousewheel(e)},!1),P.addEventListener("mousemove",function(e){t.mousemove(e)},!1),P.addEventListener("click",function(e){t.mouseclick(e)},!1),P.addEventListener("resize",function(t){console.log("resize")},!1),P.addEventListener("keydown",function(e){t.keydown(e)},!1),y()}return u.magoPolicy.imagePath=h,g=a.magoManagerState.READY,document.addEventListener("keydown",function(t){if(!u.magoPolicy.issueInsertEnable&&(u.keyDown(t.keyCode),void 0!==u.buildingSelected)){var e=u.selectionManager.currentNodeSelected;if(void 0!==e){var i=e.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==i&&u.magoPolicy.objectMoveMode===a.moveMode.ALL){var o=i.heading||0,r=i.pitch||0,n=i.roll||0,s=i.geographicCoord.altitude||0,l=!1;t.keyCode==="Q".charCodeAt(0)?(o+=3,l=!0):t.keyCode==="A".charCodeAt(0)&&(o-=3,l=!0),t.keyCode==="W".charCodeAt(0)?(r+=3,l=!0):t.keyCode==="S".charCodeAt(0)&&(r-=3,l=!0),t.keyCode==="E".charCodeAt(0)?(n+=3,l=!0):t.keyCode==="D".charCodeAt(0)&&(n-=3,l=!0),t.keyCode==="Z".charCodeAt(0)?(s+=.2,l=!0):t.keyCode==="X".charCodeAt(0)&&(s-=.2,l=!0),l&&u.changeLocationAndRotationNode(e,i.geographicCoord.latitude,i.geographicCoord.longitude,s,o,r,n)}}}},!1),{callAPI:function(t){if(t.getReturnable())return u.callAPI(t);u.callAPI(t)},getViewer:function(){return t},getMagoManagerState:function(){return g},getMagoManager:function(){return u}}},B=function(){if(!(this instanceof B))throw new Error(j.CONSTRUCT_ERROR);this._floatArrays=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])};B.prototype.Identity=function(){this._floatArrays[0]=1,this._floatArrays[1]=0,this._floatArrays[2]=0,this._floatArrays[3]=0,this._floatArrays[4]=0,this._floatArrays[5]=1,this._floatArrays[6]=0,this._floatArrays[7]=0,this._floatArrays[8]=0,this._floatArrays[9]=0,this._floatArrays[10]=1,this._floatArrays[11]=0,this._floatArrays[12]=0,this._floatArrays[13]=0,this._floatArrays[14]=0,this._floatArrays[15]=1},B.prototype.deleteObjects=function(){this._floatArrays=void 0},B.prototype.getRowMajorMatrix=function(){var t=new Float32Array(16);return t[0]=this.get(0,0),t[1]=this.get(1,0),t[2]=this.get(2,0),t[3]=this.get(3,0),t[4]=this.get(0,1),t[5]=this.get(1,1),t[6]=this.get(2,1),t[7]=this.get(3,1),t[8]=this.get(0,2),t[9]=this.get(1,2),t[10]=this.get(2,2),t[11]=this.get(3,2),t[12]=this.get(0,3),t[13]=this.get(1,3),t[14]=this.get(2,3),t[15]=this.get(3,3),t},B.getRotationDegZXYMatrix=function(t,e,i,o){void 0===o&&(o=new B);var r,n,a,s=new B,l=new B,d=new B;return void 0!==e&&0!==e&&s.rotationAxisAngDeg(e,1,0,0),void 0!==i&&0!==i&&l.rotationAxisAngDeg(i,0,1,0),void 0!==t&&0!==t&&d.rotationAxisAngDeg(t,0,0,1),r=d,n=s.getMultipliedByMatrix(r,n),o=a=l.getMultipliedByMatrix(n,a)},B.prototype.rotationAxisAngDeg=function(t,e,i,o){var r=new K;r.rotationAngDeg(t,e,i,o),this.rotationByQuaternion(r),r=void 0},B.prototype.rotationAxisAngRad=function(t,e,i,o){var r=new K;r.rotationAngRad(t,e,i,o),this.rotationByQuaternion(r),r=void 0},B.prototype.rotationByQuaternion=function(t){var e=t.x,i=t.y,o=t.z,r=t.w;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*i*i-2*o*o,this._floatArrays[this.getIndexOfArray(0,1)]=2*e*i+2*o*r,this._floatArrays[this.getIndexOfArray(0,2)]=2*e*o-2*i*r,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*e*i-2*o*r,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*e*e-2*o*o,this._floatArrays[this.getIndexOfArray(1,2)]=2*i*o+2*e*r,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*e*o+2*i*r,this._floatArrays[this.getIndexOfArray(2,1)]=2*i*o-2*e*r,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*e*e-2*i*i,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1},B.prototype.setByFloat32Array=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},B.prototype.getIndexOfArray=function(t,e){return 4*(t||0)+(e||0)},B.prototype.get=function(t,e){return this._floatArrays[this.getIndexOfArray(t,e)]},B.prototype.setTranslation=function(t,e,i){this.set(3,0,t),this.set(3,1,e),this.set(3,2,i)},B.prototype.set=function(t,e,i){this._floatArrays[this.getIndexOfArray(t,e)]=i},B.prototype.transformPoint3D=function(t,e){void 0===e&&(e=new Ce);var i=t.x,o=t.y,r=t.z;return e.x=i*this.get(0,0)+o*this.get(1,0)+r*this.get(2,0)+this.get(3,0),e.y=i*this.get(0,1)+o*this.get(1,1)+r*this.get(2,1)+this.get(3,1),e.z=i*this.get(0,2)+o*this.get(1,2)+r*this.get(2,2)+this.get(3,2),e},B.prototype.rotatePoint3D=function(t,e){void 0===e&&(e=new Ce);var i=t.x,o=t.y,r=t.z;return e.x=i*this.get(0,0)+o*this.get(1,0)+r*this.get(2,0),e.y=i*this.get(0,1)+o*this.get(1,1)+r*this.get(2,1),e.z=i*this.get(0,2)+o*this.get(1,2)+r*this.get(2,2),e},B.lookAt=function(t,e,i,o){var r=void 0,n=void 0,a=void 0,s=void 0,l=void 0,d=void 0,h=void 0,c=void 0,u=void 0,f=void 0,g=e[0],p=e[1],v=e[2],y=o[0],m=o[1],x=o[2],b=i[0],C=i[1],A=i[2];return Math.abs(g-b)<glMatrix.EPSILON&&Math.abs(p-C)<glMatrix.EPSILON&&Math.abs(v-A)<glMatrix.EPSILON?glMatrix.mat4.identity(t):(h=g-b,c=p-C,u=v-A,r=m*(u*=f=1/Math.sqrt(h*h+c*c+u*u))-x*(c*=f),n=x*(h*=f)-y*u,a=y*c-m*h,(f=Math.sqrt(r*r+n*n+a*a))?(r*=f=1/f,n*=f,a*=f):(r=0,n=0,a=0),s=c*a-u*n,l=u*r-h*a,d=h*n-c*r,(f=Math.sqrt(s*s+l*l+d*d))?(s*=f=1/f,l*=f,d*=f):(s=0,l=0,d=0),t[0]=r,t[1]=s,t[2]=h,t[3]=0,t[4]=n,t[5]=l,t[6]=c,t[7]=0,t[8]=a,t[9]=d,t[10]=u,t[11]=0,t[12]=-(r*g+n*p+a*v),t[13]=-(s*g+l*p+d*v),t[14]=-(h*g+c*p+u*v),t[15]=1,t)},B.prototype.getMultipliedByMatrix=function(t,e){void 0===e&&(e=new B);for(var i=0;i<4;i++)for(var o=0;o<4;o++){var r=this.getIndexOfArray(i,o);e._floatArrays[r]=0;for(var n=0;n<4;n++)e._floatArrays[r]+=t.get(n,o)*this.get(i,n)}return e},B.prototype.setToPerspectiveProjection=function(t,e,i,o){var r=1/Math.tan(t/2),n=r/e,a=i-o;this.setByFloat32Array([n,0,0,0,0,r,0,0,0,0,(o+i)/a,-1,0,0,2*o*i/a,0])},B.prototype.copyFromMatrix4=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t._floatArrays[e]},B.prototype.copyFromFloatArray=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},B.prototype.computeMatrixType=function(){return this.isRotationIdentity()?this.aproxEqual(this._floatArrays[3],0,1e-7)&&this.aproxEqual(this._floatArrays[7],0,1e-7)&&this.aproxEqual(this._floatArrays[11],0,1e-7)&&this.aproxEqual(this._floatArrays[12],0,1e-7)&&this.aproxEqual(this._floatArrays[13],0,1e-7)&&this.aproxEqual(this._floatArrays[14],0,1e-7)&&this.aproxEqual(this._floatArrays[15],1,1e-7)?0:1:2},B.prototype.aproxEqual=function(t,e,i){return void 0===i&&(i=1e-7),t===e||t>e-i&&t<e+i},B.areEqualArrays=function(t,e){for(var i=!0,o=0;i&&o<16;)t[o]!==e[o]&&(i=!1),o++;return i},B.prototype.isRotationIdentity=function(t){return!!this.aproxEqual(this._floatArrays[0],1,t)&&(!!this.aproxEqual(this._floatArrays[1],0,t)&&(!!this.aproxEqual(this._floatArrays[2],0,t)&&(!!this.aproxEqual(this._floatArrays[4],0,t)&&(!!this.aproxEqual(this._floatArrays[5],1,t)&&(!!this.aproxEqual(this._floatArrays[6],0,t)&&(!!this.aproxEqual(this._floatArrays[8],0,t)&&(!!this.aproxEqual(this._floatArrays[9],0,t)&&!!this.aproxEqual(this._floatArrays[10],1,t))))))))};var j={CONSTRUCT_ERROR:"  new   ."},U=function(){if(!(this instanceof U))throw new Error(j.CONSTRUCT_ERROR);this.strX,this.strY,this.strLinealDepth,this.strCamCoordPoint,this.strWorldPoint,this.strWorldPoint2,this.strModelViewMatrix=new B,this.strModelViewMatrixInv=new B,this.strCamera=new v,this.strCameraTarget=new Float32Array([0,0,0]),this.curX,this.curY,this.camRotPoint=new Ce,this.camRotAxis=new Ce,this.strTime,this.strWorldPointAux,this.strLocationAux};U.prototype.clearStartPositionsAux=function(){this.strWorldPointAux&&this.strWorldPointAux.deleteObjects(),this.strWorldPointAux=void 0,this.strLocationAux&&this.strLocationAux.deleteObjects(),this.strLocationAux=void 0},U.prototype.claculateStartPositionsAux=function(t){var e=1e8*this.strLinealDepth;t.resultRaySC=t.getRayCamSpace(this.strX,this.strY,t.resultRaySC);var i=new Ce;i.set(t.resultRaySC[0]*e,t.resultRaySC[1]*e,t.resultRaySC[2]*e),this.strWorldPointAux=t.cameraCoordPositionToWorldCoord(i,this.strWorldPointAux),this.strLocationAux=Ai.pointToGeographicCoord(this.strWorldPointAux,void 0,t)},U.prototype.saveCurrentToStart=function(){this.strX=this.curX,this.strY=this.curY,void 0===this.strWorldPoint&&(this.strWorldPoint=new Ce),this.curWorldPoint&&this.strWorldPoint.copyFrom(this.curWorldPoint),void 0===this.strCamCoordPoint&&(this.strCamCoordPoint=new Ce),this.curCamCoordPoint&&this.strCamCoordPoint.copyFrom(this.curCamCoordPoint)};var G=function(){if(!(this instanceof G))throw new Error(j.CONSTRUCT_ERROR);this.geoLocationData=new E,this.issue_id=null,this.issue_type=null};G.prototype.copyFrom=function(t){void 0!==t&&(t.geoLocationData&&this.geoLocationData.copyFrom(t.geoLocationData),this.issue_id=t.issue_id,this.issue_type=t.issue_type)};var k=function(){if(!(this instanceof k))throw new Error(j.CONSTRUCT_ERROR);this.objectMarkerArray=[]};k.prototype.newObjectMarker=function(){var t=new G;return this.objectMarkerArray.push(t),t};var z=function(){if(!(this instanceof z))throw new Error(j.CONSTRUCT_ERROR);this._ocCulling_box=new H(null),this._infinite_ocCulling_box=new H(null)},H=function(t){if(!(this instanceof H))throw new Error(j.CONSTRUCT_ERROR);this._ocCulling_Cell_owner=t,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this._indicesArray=[],this._subBoxesArray=[],this.modelReferencedGroupsList};H.prototype.createModelReferencedGroups=function(t){var e=this._subBoxesArray.length;if(0===e){if(0===this._indicesArray.length)return;void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new wt),this.modelReferencedGroupsList.createModelReferencedGroups(this._indicesArray,t)}else for(var i=0;i<e;i++)this._subBoxesArray[i].createModelReferencedGroups(t)},H.prototype.newSubBox=function(){var t=new H(this);return this._subBoxesArray.push(t),t},H.prototype.create8SubBoxes=function(){this._subBoxesArray.length=0;for(var t=0;t<8;t++)this.newSubBox()},H.prototype.setDimensions=function(t,e,i,o,r,n){this.minX=t,this.maxX=e,this.minY=i,this.maxY=o,this.minZ=r,this.maxZ=n},H.prototype.setSizesSubBoxes=function(){if(this._subBoxesArray.length>0){var t=(this.maxX+this.minX)/2,e=(this.maxY+this.minY)/2,i=(this.maxZ+this.minZ)/2;this._subBoxesArray[0].setDimensions(this.minX,t,this.minY,e,this.minZ,i),this._subBoxesArray[1].setDimensions(t,this.maxX,this.minY,e,this.minZ,i),this._subBoxesArray[2].setDimensions(t,this.maxX,e,this.maxY,this.minZ,i),this._subBoxesArray[3].setDimensions(this.minX,t,e,this.maxY,this.minZ,i),this._subBoxesArray[4].setDimensions(this.minX,t,this.minY,e,i,this.maxZ),this._subBoxesArray[5].setDimensions(t,this.maxX,this.minY,e,i,this.maxZ),this._subBoxesArray[6].setDimensions(t,this.maxX,e,this.maxY,i,this.maxZ),this._subBoxesArray[7].setDimensions(this.minX,t,e,this.maxY,i,this.maxZ);for(var o=0;o<this._subBoxesArray.length;o++)this._subBoxesArray[o].setSizesSubBoxes()}},H.prototype.intersectsWithPoint3D=function(t,e,i){var o=!1;return t>this.minX&&t<this.maxX&&e>this.minY&&e<this.maxY&&i>this.minZ&&i<this.maxZ&&(o=!0),o},H.prototype.getIntersectedSubBoxByPoint3D=function(t,e,i){if(void 0!==this._ocCulling_Cell_owner||this.intersectsWithPoint3D(t,e,i)){var o=void 0;if(this._subBoxesArray.length>0){var r,n=(this.minX+this.maxX)/2,a=(this.minY+this.maxY)/2,s=(this.minZ+this.maxZ)/2;r=t<n?e<a?i<s?0:4:i<s?3:7:e<a?i<s?1:5:i<s?2:6,o=this._subBoxesArray[r].getIntersectedSubBoxByPoint3D(t,e,i)}else o=this;return o}},H.prototype.getIndicesVisiblesForEye=function(t,e,i,o,r){var n=this.getIntersectedSubBoxByPoint3D(t,e,i);return void 0!==n&&n._indicesArray.length>0&&(o=n._indicesArray,r&&(r=this.modelReferencedGroupsList)),o},H.prototype.expandBox=function(t){this.minX-=t,this.maxX+=t,this.minY-=t,this.maxY+=t,this.minZ-=t,this.maxZ+=t},H.prototype.parseArrayBuffer=function(t,e,i){var o=i.readInt8(t,e,e+1);if(e+=1,o){var r=i.readFloat32(t,e,e+4);e+=4;var n=i.readFloat32(t,e,e+4);e+=4;var a=i.readFloat32(t,e,e+4);e+=4;var s=i.readFloat32(t,e,e+4);e+=4;var l=i.readFloat32(t,e,e+4);e+=4;var d=i.readFloat32(t,e,e+4);e+=4,this.setDimensions(r,n,a,s,l,d)}var h=i.readUInt32(t,e,e+4);if(e+=4,0===h){var c=i.readUInt32(t,e,e+4);e+=4;for(var u=0;u<c;u++){var f=i.readUInt32(t,e,e+4);e+=4,this._indicesArray.push(f)}}else for(u=0;u<h;u++){e=this.newSubBox().parseArrayBuffer(t,e,i)}return e};var W=function(){if(!(this instanceof W))throw new Error(j.CONSTRUCT_ERROR);this.texture,this.texturesArray=[],this.positionBuffer,this.texcoordBuffer};W.prototype.createPin=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0]),t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW)},W.prototype.createPinCenterBottom=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([-.5,0,0,.5,0,0,-.5,1,0,-.5,1,0,.5,0,0,.5,1,0]),t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW)};var X=function(){if(!(this instanceof X))throw new Error(j.CONSTRUCT_ERROR);this.a=0,this.b=0,this.c=0,this.d=0};X.prototype.setPointAndNormal=function(t,e,i,o,r,n){this.a=o,this.b=r,this.c=n,this.d=-this.a*t-this.b*e-this.c*i},X.prototype.setPoint=function(t,e,i){this.d=-this.a*t-this.b*e-this.c*i},X.prototype.setNormalAndDistance=function(t,e,i,o){this.a=t,this.b=e,this.c=i,this.d=o},X.prototype.getNormal=function(t){return void 0===t&&(t=new Ce),t.set(this.a,this.b,this.c),t},X.prototype.getRotationMatrix=function(t){var e=new Ce(0,0,1),i=this.getNormal(void 0),o=e.getRelativeOrientationToVector(i,1e-9),r=glMatrix.mat4.create();if(0===o);else if(1===o){var n=glMatrix.mat4.create();r=glMatrix.mat4.rotateX(r,n,Math.PI)}else if(2===o){var a=e.crossProduct(i,void 0);a.unitary();var s=e.angleRadToVector(i),l=glMatrix.vec3.fromValues(a.x,a.y,a.z),d=quat.create();d=quat.setAxisAngle(d,l,s);n=glMatrix.mat4.create();r=glMatrix.mat4.fromQuat(n,d)}return void 0===t&&(t=new B),t._floatArrays=r,t},X.prototype.intersectionLine=function(t,e){var i=t.point.x,o=t.point.y,r=t.point.z,n=t.direction.x,a=t.direction.y,s=t.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var d=-(this.a*i+this.b*o+this.c*r+this.d)/l;return void 0===e&&(e=new Ce),e.set(i+d*n,o+d*a,r+d*s),e}},X.prototype.intersectionSphere=function(t){if(void 0===t||void 0===t.centerPoint)return s.INTERSECTION_OUTSIDE;var e=t.centerPoint,i=e.x*this.a+e.y*this.b+e.z*this.c+this.d;return i<-t.r?s.INTERSECTION_OUTSIDE:i<t.r?s.INTERSECTION_INTERSECT:s.INTERSECTION_INSIDE};var K=function(){if(!(this instanceof K))throw new Error(j.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0,this.w=1};K.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},K.prototype.Unitary=function(){var t=this.Modul();this.x/=t,this.y/=t,this.z/=t,this.w/=t},K.prototype.rotationAngDeg=function(t,e,i,o){var r=t*Math.PI/180;this.rotationAngRad(r,e,i,o)},K.prototype.rotationAngRad=function(t,e,i,o){var r=Math.sqrt(e*e+i*i+o*o);if(!r<1e-12){var n=1/r,a=.5*t;r=Math.sin(a),this.x=e*n*r,this.y=i*n*r,this.z=o*n*r,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var Y=function(){if(!(this instanceof Y))throw new Error(j.CONSTRUCT_ERROR);this.color=new x};Y.prototype.init=function(){this.color.r=0,this.color.g=0,this.color.b=0,this.cycle=0},Y.prototype.getAvailableColor=function(t){return void 0===t&&(t=new x),t.setRGB(this.color.r,this.color.g,this.color.b),this.color.b+=1,this.color.b>=254&&(this.color.b=0,this.color.g+=1,this.color.g>=254&&(this.color.g=0,this.color.r+=1,this.color.r>=254&&(this.color.r=0,this.cycle+=1))),t},Y.prototype.decodeColor3=function(t,e,i){return 64516*t+254*e+i};var q=function(){if(!(this instanceof q))throw new Error(j.CONSTRUCT_ERROR);this._renderingSettings=new Je};q.prototype.getRenderingSettings=function(){return this._renderingSettings};var Z=function(t){if(!(this instanceof Z))throw new Error(j.CONSTRUCT_ERROR);this.name,t&&(this.name=t),this.depth,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent,this.subTiles,this.nodeSeedsArray,this.nodesArray,this.isVisible};Z.prototype.deleteObjects=function(){if(this.name=void 0,this.depth=void 0,this.minGeographicCoord&&this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord&&this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.sphereExtent&&this.sphereExtent.deleteObjects(),this.sphereExtent=void 0,this.nodeSeedsArray){for(var t=this.nodeSeedsArray.length,e=0;e<t;e++)this.nodeSeedsArray[e]=void 0;this.nodeSeedsArray=void 0}if(this.nodesArray){var i=this.nodesArray.length;for(e=0;e<i;e++)this.nodesArray[e]=void 0;this.nodesArray=void 0}if(this.isVisible=void 0,this.subTiles){var o=this.subTiles.length;for(e=0;e<o;e++)this.subTiles[e].deleteObjects(),this.subTiles[e]=void 0;this.subTiles=void 0}},Z.prototype.newSubTile=function(t){if(t instanceof Z){void 0===this.subTiles&&(this.subTiles=[]);var e=new Z;return e.depth=t.depth+1,e.targetDepth=t.targetDepth,this.subTiles.push(e),e}},Z.prototype.clearNodesArray=function(){if(void 0!==this.nodesArray){for(var t=0;t<this.nodesArray.length;t++)this.nodesArray[t]=void 0;this.nodesArray=void 0}},Z.prototype.getNeoBuildingById=function(t,e){var i,o=this.getNodeByBuildingId(t,e);return void 0!==o&&(i=o.data.neoBuilding),i},Z.prototype.getBuildingSeedById=function(t,e){var i,o=!0;if(void 0===this.subTiles&&(o=!1),this.subTiles&&0===this.subTiles.length&&(o=!1),o){for(s=0;s<this.subTiles.length;s++)if(i=this.subTiles[s].getBuildingSeedById(t,e))return i}else if(this.nodeSeedsArray)for(var r,n=this.nodeSeedsArray.length,a=!1,s=0;!a&&s<n;){if(r=this.nodeSeedsArray[s].data.buildingSeed,t){if(r.buildingId===e&&r.buildingType===t)return a=!0,i=r}else if(r.buildingId===e)return a=!0,i=r;s++}return i},Z.prototype.TEST__hasLowestTiles_nodesArray=function(){var t=[];this.extractLowestTiles(t);for(var e=t.length,i=0;i<e;){if(t[i].nodesArray&&t[i].nodesArray.length>0)return!0;i++}return!1},Z.prototype.makeSphereExtent=function(t){this.sphereExtent=Z.computeSphereExtent(t,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent)},Z.computeSphereExtent=function(t,e,i,o){if(void 0!==e&&void 0!==i){void 0===o&&(o=new J);var r,n=(i.longitude+e.longitude)/2,a=(i.latitude+e.latitude)/2,s=(i.altitude+e.altitude)/2;return o.centerPoint=Ai.geographicCoordToWorldPoint(n,a,s,o.centerPoint,t),r=Ai.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,r,t),o.r=1.1*o.centerPoint.distTo(r.x,r.y,r.z),o}},Z.prototype.putNode=function(t,e,i){if(void 0===this.sphereExtent&&this.makeSphereExtent(i),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var o=0;o<4;o++)this.newSubTile(this);var r;this.setSizesToSubTiles();var n=!1;for(o=0;!n&&o<4;)(r=this.subTiles[o]).intersectsNode(e)&&(r.putNode(t,e,i),n=!0),o++}else if(this.depth===t)return void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),void 0===this.nodesArray&&(this.nodesArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e),this.nodesArray.push(e),!0},Z.prototype.makeTreeByDepth=function(t,e){if(void 0!==this.nodeSeedsArray&&0!==this.nodeSeedsArray.length&&(this.targetDepth=t,this.makeSphereExtent(e),this.depth<t)){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);this.setSizesToSubTiles();for(i=0;i<4;i++)this.subTiles[i].takeIntersectedBuildingSeeds(this.nodeSeedsArray);for(i=0;i<4;i++)this.subTiles[i].makeTreeByDepth(t,e)}},Z.prototype.intersectsNode=function(t){var e,i,o=!1,r=t.data.buildingSeed,n=t.getRoot();if("G15_0002"===t.data.nodeId);return void 0!==n.data.bbox&&void 0!==n.data.bbox.geographicCoord?(e=n.data.bbox.geographicCoord.longitude,i=n.data.bbox.geographicCoord.latitude):void 0!==r?(e=r.geographicCoordOfBBox.longitude,i=r.geographicCoordOfBBox.latitude):(e=t.data.geographicCoord.longitude,i=t.data.geographicCoord.latitude),this.intersectPoint(e,i)&&(o=!0),o},Z.prototype.takeIntersectedBuildingSeeds=function(t){for(var e,i=t.length,o=0;o<i;o++)if(e=t[o],this.intersectsNode(e)){t.splice(o,1),o--,i=t.length,void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e);var r,n=(r=e.data.buildingSeed).geographicCoordOfBBox.altitude,a=r.bBox.getRadiusAprox();n-a<this.minGeographicCoord.altitude&&(this.minGeographicCoord.altitude=n-a),n+a>this.maxGeographicCoord.altitude&&(this.maxGeographicCoord.altitude=n+a)}},Z.prototype.intersectPoint=function(t,e){return!(t<this.minGeographicCoord.longitude||t>this.maxGeographicCoord.longitude)&&!(e<this.minGeographicCoord.latitude||e>this.maxGeographicCoord.latitude)},Z.prototype.eraseNode=function(t){if(void 0!==this.nodeSeedsArray)for(var e=this.nodeSeedsArray.length,i=!1,o=0;!i&&o<e;)this.nodeSeedsArray[o]===t&&(this.nodeSeedsArray.splice(o,1),i=!0),o++;if(void 0!==this.nodesArray){var r=this.nodesArray.length;for(i=!1,o=0;!i&&o<r;)this.nodesArray[o]===t&&(this.nodesArray.splice(o,1),i=!0),o++}},Z.prototype.extractLowestTiles=function(t){if(void 0!==this.subTiles)for(var e=this.subTiles.length,i=0;i<e;i++)this.subTiles[i].extractLowestTiles(t);else this.nodeSeedsArray&&this.nodeSeedsArray.length>0&&t.push(this)},Z.prototype.getFrustumIntersectedLowestTiles=function(t,e,i){var o=[];this.getFrustumIntersectedTiles(t,o,i);for(var r=o.length,n=0;n<r;n++)o[n].extractLowestTiles(e)},Z.prototype.getFrustumIntersectedTiles=function(t,e,i){if(void 0===this.sphereExtent)return s.INTERSECTION_OUTSIDE;var o=t.intersectionSphere(this.sphereExtent);if(o!==s.INTERSECTION_OUTSIDE)if(o!==s.INTERSECTION_INSIDE){if(o===s.INTERSECTION_INTERSECT)if(this.subTiles&&this.subTiles.length>0)for(var r=0;r<this.subTiles.length;r++)this.subTiles[r].sphereExtent&&this.subTiles[r].getFrustumIntersectedTiles(t,e,i);else this.nodeSeedsArray&&this.nodeSeedsArray.length>0&&i.push(this)}else e.push(this)},Z.selectTileAngleRangeByDepth=function(t){if(!(void 0===t||t<0||t>15))return 0===t?180:1===t?90:2===t?45:3===t?22.5:4===t?11.25:5===t?5.625:6===t?2.8125:7===t?1.40625:8===t?.703125:9===t?.3515625:10===t?.17578125:11===t?.087890625:12===t?.043945313:13===t?.021972656:14===t?.010986328:15===t?.005493164:void 0},Z.selectTileName=function(t,e,i,o){var r=Z.selectTileAngleRangeByDepth(t),n=Math.floor((e- -180)/r),a=Math.floor((90-i)/r);return t.toString()+"\\"+n.toString()+"\\"+a.toString()},Z.getFrustumIntersectedTilesNames=function(t,e,i,o,r){var n=new R,a=new R,s=0;n.setLonLatAlt(-180,-90,0),a.setLonLatAlt(0,90,0),s=0,Z.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,i,n,a,o,o.boundingSphere_Aux,r),n.setLonLatAlt(0,-90,0),a.setLonLatAlt(180,90,0),s=0,Z.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,i,n,a,o,o.boundingSphere_Aux,r)},Z.getFrustumIntersectedTilesNamesForGeographicExtent=function(t,e,i,o,r,n,a,l,d){l=Z.computeSphereExtent(a,r,n,l);var h=t.intersectionSphere(l);if(h!==s.INTERSECTION_OUTSIDE){if(h===s.INTERSECTION_INSIDE){var c=(r.longitude+n.longitude)/2,u=(r.latitude+n.latitude)/2,f=Z.selectTileName(i,c,u,void 0);return(g=new I).minGeographicCoord=new R(r.longitude,r.latitude,r.altitude),g.maxGeographicCoord=new R(n.longitude,n.latitude,n.altitude),void(d[f]=g)}if(h===s.INTERSECTION_INTERSECT){if(o.distToSphere(l)>2e3){c=(r.longitude+n.longitude)/2,u=(r.latitude+n.latitude)/2,f=Z.selectTileName(i,c,u,void 0);return(g=new I).minGeographicCoord=new R(r.longitude,r.latitude,r.altitude),g.maxGeographicCoord=new R(n.longitude,n.latitude,n.altitude),void(d[f]=g)}if(!(i<e)){var g;c=(r.longitude+n.longitude)/2,u=(r.latitude+n.latitude)/2,f=Z.selectTileName(i,c,u,void 0);return(g=new I).minGeographicCoord=new R(r.longitude,r.latitude,r.altitude),g.maxGeographicCoord=new R(n.longitude,n.latitude,n.altitude),void(d[f]=g)}i+=1;var p=r.longitude,v=r.latitude,y=r.altitude,m=n.longitude,x=n.latitude,b=n.altitude,c=(p+m)/2,u=(v+x)/2;n.setLonLatAlt(c,u,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,o,r,n,a,l,d),r.setLonLatAlt(c,v,y),n.setLonLatAlt(m,u,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,o,r,n,a,l,d),r.setLonLatAlt(c,u,y),n.setLonLatAlt(m,x,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,o,r,n,a,l,d),r.setLonLatAlt(p,u,y),n.setLonLatAlt(c,x,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,o,r,n,a,l,d)}}},Z.prototype.getSphereExtent=function(){return this.sphereExtent},Z.prototype.setSize=function(t,e,i,o,r,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new R),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new R),this.minGeographicCoord.setLonLatAlt(t,e,i),this.maxGeographicCoord.setLonLatAlt(o,r,n)},Z.prototype.setSizesToSubTiles=function(){if(this.subTiles.length<4)throw new Error("When subTiles length is 4, setSizesToSubTiles is ok.");var t=this.minGeographicCoord.longitude,e=this.maxGeographicCoord.longitude,i=this.minGeographicCoord.latitude,o=this.maxGeographicCoord.latitude,r=this.minGeographicCoord.altitude,n=this.maxGeographicCoord.altitude,a=(e+t)/2,s=(o+i)/2,l=this.subTiles[0];l.setSize(t,i,r,a,s,n),(l=this.subTiles[1]).setSize(a,i,r,e,s,n),(l=this.subTiles[2]).setSize(a,s,r,e,o,n),(l=this.subTiles[3]).setSize(t,s,r,a,o,n)},Z.prototype.getLongitudeRangeDegree=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},Z.prototype.getLatitudeRangeDegree=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude};var Q=function(){if(!(this instanceof Q))throw new Error(j.CONSTRUCT_ERROR);this.tilesArray=[],this.createMainTiles()};Q.prototype.createMainTiles=function(){var t=this.newSmartTile("AmericaSide");void 0===t.minGeographicCoord&&(t.minGeographicCoord=new R),void 0===t.maxGeographicCoord&&(t.maxGeographicCoord=new R),t.depth=0,t.minGeographicCoord.setLonLatAlt(-180,-90,0),t.maxGeographicCoord.setLonLatAlt(0,90,0);var e=this.newSmartTile("AsiaSide");void 0===e.minGeographicCoord&&(e.minGeographicCoord=new R),void 0===e.maxGeographicCoord&&(e.maxGeographicCoord=new R),e.depth=0,e.minGeographicCoord.setLonLatAlt(0,-90,0),e.maxGeographicCoord.setLonLatAlt(180,90,0)},Q.prototype.makeTreeByDepth=function(t,e,i){void 0===t&&(t=17),this.targetDepth=t;for(var o=this.tilesArray.length,r=0;r<o;r++){var n=this.tilesArray[r];void 0===n.nodeSeedsArray&&(n.nodeSeedsArray=[]),n.nodeSeedsArray=e,n.makeTreeByDepth(t,i)}},Q.prototype.putNode=function(t,e,i){if(t=mi(t,17),void 0!==this.tilesArray)for(var o=this.tilesArray.length,r=0;r<o;r++)this.tilesArray[r].putNode(t,e,i)},Q.prototype.deleteTiles=function(){if(this.tilesArray){for(var t=this.tilesArray.length,e=0;e<t;e++)this.tilesArray[e].deleteObjects(),this.tilesArray[e]=void 0;this.tilesArray.length=0}},Q.prototype.resetTiles=function(){this.deleteTiles(),this.createMainTiles()},Q.prototype.newSmartTile=function(t){void 0===this.tilesArray&&(this.tilesArray=[]);var e=new Z(t);return this.tilesArray.push(e),e},Q.prototype.getNeoBuildingById=function(t,e){for(var i,o=0,r=this.tilesArray.length;void 0===i&&o<r;)i=this.tilesArray[o].getNeoBuildingById(t,e),o++;return i},Q.prototype.getBuildingSeedById=function(t,e){for(var i,o=0,r=this.tilesArray.length;void 0===i&&o<r;)i=this.tilesArray[o].getBuildingSeedById(t,e),o++;return i};var J=function(){if(!(this instanceof J))throw new Error(j.CONSTRUCT_ERROR);this.r=0,this.centerPoint=new Ce,this.vboKeyContainer};J.prototype.setCenterPoint=function(t,e,i){this.centerPoint.set(t,e,i)},J.prototype.setRadius=function(t){this.r=t},J.prototype.deleteObjects=function(){this.r=void 0,this.centerPoint.deleteObjects(),this.centerPoint=void 0},J.prototype.getVbo=function(t,e){var i;void 0===t&&(t=new ft);var o=(i=this.makePMesh(i)).getSurfaceIndependentMesh(void 0,!1,!1),r=new B;return r.rotationAxisAngDeg(90,1,0,0),o.transformByMatrix4(r),o.setColor(0,.5,.9,.3),o.calculateVerticesNormals(),void 0!==e&&!0===e&&o.calculateTexCoordsSpherical(),o.getVbo(t),t},J.prototype.makePMesh=function(t){void 0===t&&(t=new fe),t.profile=new Profile;var e,i,o=t.profile,r=o.newOuterRing();(e=r.newElement("POLYLINE")).newPoint2d(.01*-this.r,-this.r),e.newPoint2d(.01*-this.r,this.r);var n;i=r.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(this.r),i.setStartAngleDegree(95),i.setSweepAngleDegree(170),i.numPointsFor360Deg=48,n=new De;var a=new me(0,-1),s=new me(0,1);return n.setPoints(a,s),48,t.revolve(o,360,48,n),t};var tt=function(){this.high=void 0,this.low=void 0},et=function(){if(!(this instanceof et))throw new Error(j.CONSTRUCT_ERROR);this._depth=0,this._numberName=1,this._terranTile_owner,this.projectsArray=[],this._BR_buildingsArray=[],this._boundingBox,this._pCloudMesh_array=[],this.position,this.radius,this.leftDown_position,this.rightDown_position,this.rightUp_position,this.leftUp_position,this.visibilityType,this.subTiles_array=[],this.terranIndexFile_readed=!1,this.empty_tile=!1,this.fileReading_started=!1,this.fileReading_finished=!1,this.fileArrayBuffer,this.fileBytesReaded=0,this.fileParsingFinished=!1,this.projectsParsed_count=0,this.current_BRProject_parsing,this.current_BRProject_parsing_state=0,this.readWriter};et.prototype.newBRProject=function(){var t=new BRBuildingProject;return this._BR_buildingsArray.push(t),t},et.prototype.newSubTerranTile=function(){var t=this.subTiles_array.length,e=new et;return e._depth=this._depth+1,e._numberName=10*this._numberName+t+1,this.subTiles_array.push(e),e},et.prototype.make4subTiles=function(){for(var t=0;t<4;t++)this.newSubTerranTile()},et.prototype.setDimensions=function(t,e,i,o){this.longitudeMin=t,this.longitudeMax=e,this.latitudeMin=i,this.latitudeMax=o},et.prototype.makeTree=function(t){if(this._depth<t)for(var e=0;e<4;e++)this.newSubTerranTile().makeTree(t)},et.prototype.calculatePositionByLonLat=function(){var t=(this.longitudeMax+this.longitudeMin)/2,e=(this.latitudeMax+this.latitudeMin)/2;this.position=Cesium.Cartesian3.fromDegrees(t,e,0),this.leftDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMin,0),this.rightDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMin,0),this.rightUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMax,0),this.leftUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMax,0),this.radius=Cesium.Cartesian3.distance(this.leftDown_position,this.rightUp_position)/2*.9},et.prototype.calculatePositionByLonLatSubTiles=function(){this.calculatePositionByLonLat();for(var t=this.subTiles_array.length,e=0;e<t;e++)this.subTiles_array[e].calculatePositionByLonLatSubTiles()},et.prototype.parseFileHeader=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){var i,o=t._header,r=this.fileArrayBuffer,n=this.fileBytesReaded;void 0===this.readWriter&&(this.readWriter=new jt);for(var a=0;a<5;a++)o._version+=String.fromCharCode(new Int8Array(r.slice(n,n+1))),n+=1;o._f4d_version=2,i=this.readWriter.readInt32(r,n,n+4),n+=4;for(a=0;a<i;a++)o._global_unique_id+=String.fromCharCode(new Int8Array(r.slice(n,n+1))),n+=1;o._longitude=new Float64Array(r.slice(n,n+8))[0],n+=8,o._latitude=new Float64Array(r.slice(n,n+8))[0],n+=8,o._elevation=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minX=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minY=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minZ=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxX=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxY=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxZ=new Float32Array(r.slice(n,n+4))[0],n+=4;var s=(o._boundingBox.maxZ-o._boundingBox.minZ)/2;o._elevation=45+s-.5;var l=!1;(o._boundingBox.maxX-o._boundingBox.minX>40||o._boundingBox.maxY-o._boundingBox.minY>40)&&(l=!0),!l&&o._boundingBox.maxZ-o._boundingBox.minZ<30&&(o.isSmall=!0);this.readWriter.readUInt8(r,n,n+1);n+=1;var d=Cesium.Cartesian3.fromDegrees(o._longitude,o._latitude,o._elevation),h=Cesium.Ellipsoid.WGS84.cartesianToCartographic(d).height;d=Cesium.Cartesian3.fromDegrees(o._longitude,o._latitude,h),t.buildingPosition=d;Cesium.EncodedCartesian3.encode(d);var c=Cesium.EncodedCartesian3.encode(d.x),u=Cesium.EncodedCartesian3.encode(d.y),f=Cesium.EncodedCartesian3.encode(d.z);t.buildingPositionHIGH=new Float32Array(3),t.buildingPositionHIGH[0]=c.high,t.buildingPositionHIGH[1]=u.high,t.buildingPositionHIGH[2]=f.high,t.buildingPositionLOW=new Float32Array(3),t.buildingPositionLOW[0]=c.low,t.buildingPositionLOW[1]=u.low,t.buildingPositionLOW[2]=f.low,this.fileBytesReaded=n}},et.prototype.parseFileSimpleBuilding=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){void 0===this.readWriter&&(this.readWriter=new jt);var i,o,r=this.fileBytesReaded,n=this.fileArrayBuffer;void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1);var a=t._simpleBuilding_v1,s=this.readWriter.readUInt32(n,r,r+4);r+=4;for(var l=0;l<s;l++){var d=a.newSimpleObject()._vtCacheKeys_container.newVertexTexcoordsArraysCacheKey(),h=this.readWriter.readUInt32(n,r,r+4);i=r+=4,o=r+20*h,d.verticesArrayBuffer=n.slice(i,o),r+=20*h,d._vertices_count=h}this.readWriter.readInt32(n,r,r+4);r+=4,this.fileBytesReaded=r}},et.prototype.parseFileNailImage=function(t,e){void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1),void 0===this.readWriter&&(this.readWriter=new jt);var i=t._simpleBuilding_v1,o=this.fileBytesReaded,r=this.fileArrayBuffer,n=this.readWriter.readUInt32(r,o,o+4),a=o+=4,s=o+n;i.textureArrayBuffer=new Uint8Array(r.slice(a,s)),o+=n,this.fileBytesReaded=o},et.prototype.parseFileAllBuildings=function(t){var e=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=e)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new jt);var i=this.fileArrayBuffer,o=this.readWriter.readInt32(i,0,4);this.fileBytesReaded+=4,0===o&&(this.empty_tile=!0);for(var r=0;r<o;r++){var n=this.fileBytesReaded;this.fileBytesReaded=n,this.current_BRProject_parsing=this.newBRProject(),this.parseFileHeader(this.current_BRProject_parsing),this.parseFileSimpleBuilding(this.current_BRProject_parsing),this.parseFileNailImage(this.current_BRProject_parsing,t)}this.fileParsingFinished=!0,this.fileArrayBuffer=null}},et.prototype.parseFileOneBuilding=function(t,e){var i=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=i)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new jt);var o=this.readWriter.readInt32(this.fileArrayBuffer,0,4);if(this.projectsParsed_count>=o)return this.fileParsingFinished=!0,void(this.fileBytesReaded=null);0===this.current_BRProject_parsing_state&&(0===this.projectsParsed_count&&(this.fileBytesReaded=4),this.current_BRProject_parsing=this.newBRProject());var r=this.current_BRProject_parsing;0===this.current_BRProject_parsing_state?(this.parseFileHeader(r),this.current_BRProject_parsing_state=1):1===this.current_BRProject_parsing_state?e.backGround_imageReadings_count<1&&(this.parseFile_simpleBuilding_old(t,r),this.current_BRProject_parsing_state=2):2===this.current_BRProject_parsing_state&&e.backGround_imageReadings_count<1&&(this.parseFile_nailImage_old(t,r,e),this.current_BRProject_parsing_state=0,this.projectsParsed_count++,e.backGround_imageReadings_count++)}},et.prototype.setDimensionsSubTiles=function(){var t=this.subTiles_array.length;if(4===t){var e=(this.longitudeMax+this.longitudeMin)/2,i=(this.latitudeMax+this.latitudeMin)/2;this.subTiles_array[0].setDimensions(this.longitudeMin,e,this.latitudeMin,i),this.subTiles_array[1].setDimensions(e,this.longitudeMax,this.latitudeMin,i),this.subTiles_array[2].setDimensions(e,this.longitudeMax,i,this.latitudeMax),this.subTiles_array[3].setDimensions(this.longitudeMin,e,i,this.latitudeMax);for(var o=0;o<t;o++)this.subTiles_array[o].setDimensionsSubTiles()}},et.prototype.getSmallestTiles=function(t){if(this.subTiles_array.length>0)for(var e=0;e<this.subTiles_array.length;e++)this.subTiles_array[e].visibilityType=this.visibilityType,this.subTiles_array[e].getSmallestTiles(t);else this.empty_tile.length||t.push(this)},et.prototype.getIntersectedSmallestTiles=function(t,e,i){var o=[];this.getIntersectedTiles(t,o,i);for(var r=o.length,n=0;n<r;n++)o[n].getSmallestTiles(e);o.length=0},et.prototype.getIntersectedTiles=function(t,e,i){if(void 0!==this.position)if(void 0===i&&(i=new Cesium.BoundingSphere),i.radius=this.radius,i.center.x=this.position.x,i.center.y=this.position.y,i.center.z=this.position.z,this.visibilityType=t.computeVisibility(i),this.visibilityType===Cesium.Intersect.OUTSIDE);else if(this.visibilityType===Cesium.Intersect.INSIDE)e.push(this);else if(this.subTiles_array.length>0)for(var o=0;o<this.subTiles_array.length;o++)this.subTiles_array[o].getIntersectedTiles(t,e);else e.push(this)};var it=function(){if(!(this instanceof it))throw new Error(j.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.texId,this.fileLoadState=a.fileLoadState.READY};it.prototype.deleteObjects=function(t){this.textureTypeName=void 0,this.textureImageFileName=void 0,this.texId&&t.deleteTexture(this.texId),this.texId=void 0,this.fileLoadState=void 0},it.createTexture=function(t,e,i,o,r){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),i instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,r,0,t.RGBA,t.UNSIGNED_BYTE,i):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.bindTexture(t.TEXTURE_2D,null),n};var ot=function(t){if(!(this instanceof ot))throw new Error(j.CONSTRUCT_ERROR);this._magoManager=t,this._gl=this._magoManager.getGl(),this._textureAux_1x1,this._noiseTexture_4x4};function rt(t,e,i,o){void 0===o&&(o=!0),t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}ot.prototype.getGl=function(){return void 0===this._gl&&(this._gl=this._magoManager.getGl()),this._gl},ot.prototype.getTextureAux1x1=function(){if(void 0===this._textureAux_1x1){var t=this.getGl();this._textureAux_1x1=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._textureAux_1x1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([150,150,150,255])),t.bindTexture(t.TEXTURE_2D,null)}return this._textureAux_1x1},ot.prototype.getNoiseTexture4x4=function(){if(void 0===this._noiseTexture_4x4){var t=this.getGl();this._noiseTexture_4x4=function(t,e,i,o){var r=t.createTexture();if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r),void 0===o&&(o=new Uint8Array(64)),4===e&&4===i){var n=0;o[n]=50,o[++n]=58,o[++n]=229,o[++n]=120,o[++n]=212,o[++n]=236,o[++n]=251,o[++n]=148,o[++n]=75,o[++n]=92,o[++n]=246,o[++n]=59,o[++n]=197,o[++n]=95,o[++n]=235,o[++n]=216,o[++n]=130,o[++n]=124,o[++n]=215,o[++n]=154,o[++n]=25,o[++n]=41,o[++n]=221,o[++n]=146,o[++n]=187,o[++n]=217,o[++n]=130,o[++n]=199,o[++n]=142,o[++n]=112,o[++n]=61,o[++n]=135,o[++n]=67,o[++n]=125,o[++n]=159,o[++n]=153,o[++n]=215,o[++n]=49,o[++n]=49,o[++n]=69,o[++n]=126,o[++n]=168,o[++n]=61,o[++n]=215,o[++n]=21,o[++n]=93,o[++n]=183,o[++n]=1,o[++n]=125,o[++n]=44,o[++n]=22,o[++n]=130,o[++n]=197,o[++n]=118,o[++n]=109,o[++n]=23,o[++n]=195,o[++n]=4,o[++n]=148,o[++n]=245,o[++n]=124,o[++n]=125,o[++n]=185,o[++n]=28,n++}else for(var a=0;a<i;a++)for(var s=0;s<e;s++)o[4*(a*e+s)+0]=Math.floor(255*Math.random()),o[4*(a*e+s)+1]=Math.floor(255*Math.random()),o[4*(a*e+s)+2]=Math.floor(255*Math.random()),o[4*(a*e+s)+3]=Math.floor(255*Math.random());return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),r.width=e,r.height=i,r}(t,4,4,void 0)}return this._noiseTexture_4x4};var nt=function(){if(!(this instanceof nt))throw new Error(j.CONSTRUCT_ERROR);this.vertexMatrix=new He,this.vertexList=this.vertexMatrix.newVertexList(),this.triSurfacesArray=[]};nt.prototype.newTriSurface=function(){var t=new at;return this.triSurfacesArray.push(t),t},nt.prototype.invertTrianglesSenses=function(){for(var t=this.triSurfacesArray.length,e=0;e<t;e++)this.triSurfacesArray[e].invertTrianglesSenses()},nt.prototype.getVBOArrayModePosNorCol=function(t,e){void 0===t&&(t=new ut),void 0===t.posVboDataArray&&(t.posVboDataArray=[]),void 0===t.norVboDataArray&&(t.norVboDataArray=[]),void 0===t.colVboDataArray&&(t.colVboDataArray=[]);var i,o,r,n,a,s,l=[],d=[],h=[];t.vertexCount=0;for(var c=this.triSurfacesArray.length,u=0;u<c;u++){a=(s=this.triSurfacesArray[u]).trianglesArray.length;for(var f=0;f<a;f++)void 0===(n=s.trianglesArray[f]).normal&&n.calculatePlaneNormal(),i=n.vertex0,o=n.vertex1,r=n.vertex2,l.push(i.point3d.x),l.push(i.point3d.y),l.push(i.point3d.z),l.push(o.point3d.x),l.push(o.point3d.y),l.push(o.point3d.z),l.push(r.point3d.x),l.push(r.point3d.y),l.push(r.point3d.z),d.push(n.normal.x),d.push(n.normal.y),d.push(n.normal.z),d.push(n.normal.x),d.push(n.normal.y),d.push(n.normal.z),d.push(n.normal.x),d.push(n.normal.y),d.push(n.normal.z),void 0===i.color4?(h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200),h.push(200)):(h.push(i.color4.r),h.push(i.color4.g),h.push(i.color4.b),h.push(i.color4.a),h.push(o.color4.r),h.push(o.color4.g),h.push(o.color4.b),h.push(o.color4.a),h.push(r.color4.r),h.push(r.color4.g),h.push(r.color4.b),h.push(r.color4.a)),t.vertexCount+=3}var g=t.vertexCount,p=new Float32Array(3*g);p.set(l);var v=new Int8Array(3*g);v.set(d);var y=new Uint8Array(4*g);return y.set(h),t.setDataArrayPos(p,e),t.setDataArrayNor(v,e),t.setDataArrayCol(y,e),t};var at=function(){if(!(this instanceof at))throw new Error(j.CONSTRUCT_ERROR);this.vertexList,this.trianglesArray,this.trianglesList};at.prototype.newTriangle=function(){void 0===this.trianglesArray&&(this.trianglesArray=[]);var t=new Be;return this.trianglesArray.push(t),t},at.prototype.invertTrianglesSenses=function(){for(var t=this.trianglesArray.length,e=0;e<t;e++)this.trianglesArray[e].invertSense()};var st=function(t){if(!(this instanceof st))throw new Error(j.CONSTRUCT_ERROR);this.dataArray,this.dataLength,this.dataGlType,this.key,this.dataTarget,this.dataTarget=void 0!==t?t:34962};st.prototype.deleteGlObjects=function(t){if(void 0!==this.key){var e=t.gl;this.dataTarget===e.ARRAY_BUFFER?t.storeClassifiedBufferKey(e,this.key,this.dataLength):this.dataTarget===e.ELEMENT_ARRAY_BUFFER&&t.storeClassifiedElementKey(e,this.key,this.dataLength)}this.dataArray=void 0,this.dataLength=void 0,this.dataGlType=void 0,this.key=void 0,this.dataTarget=void 0},st.prototype.setDataArray=function(t,e){if(void 0!==t){this.dataGlType=st.getGlTypeOfArray(t);var i=t.length,o=i;e.enableMemoryManagement?(o=e.getClassifiedBufferSize(i),this.dataArray=st.newTypedArray(o,this.dataGlType),this.dataArray.set(t)):this.dataArray=t,this.dataLength=i}},st.prototype.isReady=function(t,e){return void 0!==this.key||void 0!==this.dataArray&&(void 0===this.dataLength&&(this.dataLength=this.dataArray.length),this.key=e.getClassifiedBufferKey(t,this.dataLength),void 0!==this.key&&(t.bindBuffer(this.dataTarget,this.key),t.bufferData(this.dataTarget,this.dataArray,t.STATIC_DRAW),this.dataArray=void 0,!0))},st.getGlTypeOfArray=function(t){var e=-1;return t.constructor===Float32Array?e=5126:t.constructor===Int16Array?e=5122:t.constructor===Uint16Array?e=5123:t.constructor===Int8Array?e=5120:t.constructor===Uint8Array&&(e=5121),e},st.newTypedArray=function(t,e){var i;return 5126===e?i=new Float32Array(t):5122===e?i=new Int16Array(t):5123===e?i=new Uint16Array(t):5120===e?i=new Int8Array(t):5121===e&&(i=new Uint8Array(t)),i};var lt=function(t,e){if(!(this instanceof lt))throw new Error(j.CONSTRUCT_ERROR);var i;this.vboKeysStoreMap={},this.bufferSizes=t,this.minSize=e,this.maxSize=t[t.length-1],this.totalBytesUsed=0;for(var o=t.length,r=0;r<o;r++)i=new dt(t[r]),this.vboKeysStoreMap[t[r]]=i,t[r]>this.maxSize&&(this.maxSize=t[r])};lt.prototype.getClassifiedBufferKey=function(t,e,i,o){var r=this.getClosestBufferSize(e),n=this.vboKeysStoreMap[r];return n?n.getBufferKey(t,this,i,o):-1},lt.prototype.storeClassifiedBufferKey=function(t,e){var i=this.vboKeysStoreMap[e];i&&i.storeBufferKey(t)},lt.prototype.getClosestBufferSize=function(t){if(!this.isInsideRange(t))return-1;for(var e=this.bufferSizes.length,i=0;i<e;i++)if(t<=this.bufferSizes[i])return this.bufferSizes[i];return-1},lt.prototype.isInsideRange=function(t){return!(t>this.maxSize||t<this.minSize)};var dt=function(t){if(!(this instanceof dt))throw new Error(j.CONSTRUCT_ERROR);this.classifiedSize=t,this.vboKeysArray=[],this.keysCreated=0};dt.prototype.getBufferKey=function(t,e,i,o){if(this.vboKeysArray.length>0)return r=this.vboKeysArray.pop();if(!o){var r=t.createBuffer();return this.keysCreated+=1,e.totalBytesUsed+=this.classifiedSize,i.totalBytesUsed+=this.classifiedSize,r}},dt.prototype.storeBufferKey=function(t){this.vboKeysArray.push(t)};var ht=function(){if(!(this instanceof ht))throw new Error(j.CONSTRUCT_ERROR);this.totalBytesUsed=0,this.bytesLimit=1e3,this.vboKeysNationsArray=[],this.vboKeyNation12to128=new lt(new Uint32Array([12,16,32,48,64,76,92,128]),0),this.vboKeysNationsArray.push(this.vboKeyNation12to128),this.vboKeyNation200to1000=new lt(new Uint32Array([200,300,400,500,600,700,800,900,1e3]),129),this.vboKeysNationsArray.push(this.vboKeyNation200to1000),this.vboKeyNation1500to6000=new lt(new Uint32Array([1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3]),1001),this.vboKeysNationsArray.push(this.vboKeyNation1500to6000),this.vboKeyNation7000to16000=new lt(new Uint32Array([7e3,8e3,9e3,1e4,11e3,12e3,13e3,14e3,15e3,16e3]),6001),this.vboKeysNationsArray.push(this.vboKeyNation7000to16000),this.vboKeyNation20000to56000=new lt(new Uint32Array([2e4,24e3,28e3,32e3,36e3,4e4,44e3,48e3,52e3,56e3]),16001),this.vboKeysNationsArray.push(this.vboKeyNation20000to56000),this.vboKeyNation60000to150000=new lt(new Uint32Array([6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4,15e4]),56001),this.vboKeysNationsArray.push(this.vboKeyNation60000to150000),this.vboKeyNation200000to1100000=new lt(new Uint32Array([2e5,3e5,4e5,5e5,6e5,7e5,8e5,9e5,1e6,11e5]),150001),this.vboKeysNationsArray.push(this.vboKeyNation200000to1100000),this.vboKeyNation1500000to3000000=new lt(new Uint32Array([15e5,2e6,25e5,3e6,6e6,12e6,24e6,36e6,6e7]),1100001),this.vboKeysNationsArray.push(this.vboKeyNation1500000to3000000)};ht.prototype.getClassifiedBufferKey=function(t,e){var i=!1;this.totalBytesUsed>this.bytesLimit&&(i=!0);var o=this.getKeyNationBySize(e),r=void 0;return o&&(r=o.getClassifiedBufferKey(t,e,this,i)),r},ht.prototype.storeClassifiedBufferKey=function(t,e){var i=this.getKeyNationBySize(e);i&&i.storeClassifiedBufferKey(t,e)},ht.prototype.getKeyNationBySize=function(t){for(var e=this.vboKeysNationsArray.length,i=0;i<e;){if(this.vboKeysNationsArray[i].isInsideRange(t))return this.vboKeysNationsArray[i];i++}return-1},ht.prototype.getClassifiedBufferSize=function(t){var e=this.getKeyNationBySize(t),i=-1;return-1!==e&&(i=e.getClosestBufferSize(t)),i};var ct=function(){if(!(this instanceof ct))throw new Error(j.CONSTRUCT_ERROR);this.gl,this.enableMemoryManagement=!1,this.buffersKeyWorld=new ht,this.elementKeyWorld=new ht,this.buffersKeyWorld.bytesLimit=8e8,this.elementKeyWorld.bytesLimit=3e8,this.currentMemoryUsage=0};ct.prototype.isGpuMemFull=function(){return this.buffersKeyWorld.totalBytesUsed>this.buffersKeyWorld.bytesLimit||this.elementKeyWorld.totalBytesUsed>this.elementKeyWorld.bytesLimit},ct.prototype.getClassifiedBufferKey=function(t,e){if(this.enableMemoryManagement){var i=this.buffersKeyWorld.getClassifiedBufferKey(t,e);return void 0!==i&&(this.currentMemoryUsage+=e),i}return this.currentMemoryUsage+=e,t.createBuffer()},ct.prototype.storeClassifiedBufferKey=function(t,e,i){this.enableMemoryManagement?this.buffersKeyWorld.storeClassifiedBufferKey(e,i):t.deleteBuffer(e),this.currentMemoryUsage-=i,this.currentMemoryUsage<0&&(this.currentMemoryUsage=0)},ct.prototype.getClassifiedElementKey=function(t,e){return this.enableMemoryManagement?this.elementKeyWorld.getClassifiedBufferKey(t,e):t.createBuffer()},ct.prototype.storeClassifiedElementKey=function(t,e,i){this.enableMemoryManagement?this.elementKeyWorld.storeClassifiedBufferKey(e,i):t.deleteBuffer(e)},ct.prototype.getClassifiedBufferSize=function(t){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferSize(t):t};var ut=function(){if(!(this instanceof ut))throw new Error(j.CONSTRUCT_ERROR);this.indicesCount=-1,this.vertexCount=-1,this.bigTrianglesIndicesCount=-1,this.vboBufferPos,this.vboBufferNor,this.vboBufferIdx,this.vboBufferCol,this.vboBufferTCoord};ut.prototype.stepOverPosNorIdx=function(t,e,i,o){var r=e.readUInt32(t,o,o+4),n=3*r;o+=4,o+=4*n;var a=3*(r=e.readUInt32(t,o,o+4));o+=4,o+=1*a;var s=e.readUInt32(t,o,o+4);o+=4;var l=e.readUInt8(t,o,o+1);o+=1;for(var d=0;d<l;d++)o+=4;for(d=0;d<l;d++)o+=4;return o,o+2*s,o+=2*s},ut.prototype.readPosNorIdx=function(t,e,i,o){var r,n,a=e.readUInt32(t,o,o+4);this.vertexCount=a;var s=3*a;r=o+=4,n=o+4*s;var l=new Float32Array(t.slice(r,n));this.setDataArrayPos(l,i),o+=4*s;var d=3*(a=e.readUInt32(t,o,o+4));r=o+=4,n=o+1*d;var h=new Int8Array(t.slice(r,n));this.setDataArrayNor(h,i),o+=1*d;var c=e.readUInt32(t,o,o+4);o+=4;var u=e.readUInt8(t,o,o+1);o+=1;for(var f=[],g=0;g<u;g++)f.push(new Float32Array(t.slice(o,o+4))),o+=4;var p=[];for(g=0;g<u;g++)p.push(e.readUInt32(t,o,o+4)),o+=4;var v=p[u-1];this.bigTrianglesIndicesCount=v,r=o,n=o+2*c;var y=new Uint16Array(t.slice(r,n));return this.setDataArrayIdx(y,i),o+=2*c},ut.prototype.bindDataPosition=function(t,e){if(void 0===t)return!1;var i=t.gl,o=this.vboBufferPos;return!!o.isReady(i,e)&&(void 0!==t.position3_loc&&-1!==t.position3_loc?(t.enableVertexAttribArray(t.position3_loc),o.key!==t.last_vboPos_binded&&(i.bindBuffer(o.dataTarget,o.key),i.vertexAttribPointer(t.position3_loc,3,o.dataGlType,!1,0,0),t.last_vboPos_binded=o.key),!0):(t.disableVertexAttribArray(t.position3_loc),!1))},ut.prototype.bindDataNormal=function(t,e){if(void 0===t)return!1;var i=this.vboBufferNor;if(void 0===i)return t.disableVertexAttribArray(t.normal3_loc),!0;var o=t.gl;return!!i.isReady(o,e)&&(void 0!==t.normal3_loc&&-1!==t.normal3_loc?(t.enableVertexAttribArray(t.normal3_loc),i.key!==t.last_vboNor_binded&&(o.bindBuffer(i.dataTarget,i.key),o.vertexAttribPointer(t.normal3_loc,3,i.dataGlType,!0,0,0),t.last_vboNor_binded=i.key),!0):(t.disableVertexAttribArray(t.normal3_loc),!1))},ut.prototype.bindDataTexCoord=function(t,e){if(void 0===t)return!1;var i=this.vboBufferTCoord;if(void 0===i)return t.disableVertexAttribArray(t.texCoord2_loc),!0;var o=t.gl;return!!i.isReady(o,e)&&(void 0!==t.texCoord2_loc&&-1!==t.texCoord2_loc?(t.enableVertexAttribArray(t.texCoord2_loc),i.key!==t.last_vboTexCoord_binded&&(o.bindBuffer(i.dataTarget,i.key),o.vertexAttribPointer(t.texCoord2_loc,2,i.dataGlType,!1,0,0),t.last_vboTexCoord_binded=i.key),!0):void t.disableVertexAttribArray(t.texCoord2_loc))},ut.prototype.bindDataColor=function(t,e){if(void 0===t)return!1;var i=this.vboBufferCol;if(void 0===i)return t.disableVertexAttribArray(t.color4_loc),!0;var o=t.gl;return!!i.isReady(o,e)&&(void 0!==t.color4_loc&&-1!==t.color4_loc?(t.enableVertexAttribArray(t.color4_loc),i.key!==t.last_vboCol_binded&&(o.bindBuffer(i.dataTarget,i.key),o.vertexAttribPointer(t.color4_loc,4,i.dataGlType,!0,0,0),t.last_vboCol_binded=i.key),!0):(t.disableVertexAttribArray(t.color4_loc),!1))},ut.prototype.bindDataIndice=function(t,e){if(void 0===t)return!1;var i=t.gl,o=this.vboBufferIdx;return!!o.isReady(i,e)&&(o.key!==t.last_vboIdx_binded&&(i.bindBuffer(o.dataTarget,o.key),t.last_vboIdx_binded=o.key),!0)},ut.prototype.setDataArrayPos=function(t,e){if(void 0!==t){var i=e.gl;void 0===this.vboBufferPos&&(this.vboBufferPos=new st(i.ARRAY_BUFFER)),this.vboBufferPos.setDataArray(t,e),this.vertexCount=this.vboBufferPos.dataLength/3}},ut.prototype.setDataArrayNor=function(t,e){var i=e.gl;void 0===this.vboBufferNor&&(this.vboBufferNor=new st(i.ARRAY_BUFFER)),this.vboBufferNor.setDataArray(t,e)},ut.prototype.setDataArrayIdx=function(t,e){var i=e.gl;void 0===this.vboBufferIdx&&(this.vboBufferIdx=new st(i.ELEMENT_ARRAY_BUFFER)),this.vboBufferIdx.setDataArray(t,e),this.indicesCount=this.vboBufferIdx.dataLength},ut.prototype.setDataArrayCol=function(t,e){var i=e.gl;void 0===this.vboBufferCol&&(this.vboBufferCol=new st(i.ARRAY_BUFFER)),this.vboBufferCol.setDataArray(t,e)},ut.prototype.setDataArrayTexCoord=function(t,e){var i=e.gl;void 0===this.vboBufferTCoord&&(this.vboBufferTCoord=new st(i.ARRAY_BUFFER)),this.vboBufferTCoord.setDataArray(t,e)},ut.prototype.deleteGlObjects=function(t,e){void 0!==this.vboBufferPos&&(this.vboBufferPos.deleteGlObjects(e),this.vboBufferPos=void 0),void 0!==this.vboBufferNor&&(this.vboBufferNor.deleteGlObjects(e),this.vboBufferNor=void 0),void 0!==this.vboBufferIdx&&(this.vboBufferIdx.deleteGlObjects(e),this.vboBufferIdx=void 0),void 0!==this.vboBufferCol&&(this.vboBufferCol.deleteGlObjects(e),this.vboBufferCol=void 0),void 0!==this.vboBufferTCoord&&(this.vboBufferTCoord.deleteGlObjects(e),this.vboBufferTCoord=void 0)};var ft=function(){if(!(this instanceof ft))throw new Error(j.CONSTRUCT_ERROR);this.vboCacheKeysArray=[]};ft.prototype.newVBOVertexIdxCacheKey=function(){void 0===this.vboCacheKeysArray&&(this.vboCacheKeysArray=[]);var t=new ut;return this.vboCacheKeysArray.push(t),t},ft.prototype.deleteGlObjects=function(t,e){if(void 0!==this.vboCacheKeysArray){for(var i=this.vboCacheKeysArray.length,o=0;o<i;o++)this.vboCacheKeysArray[o].deleteGlObjects(t,e),this.vboCacheKeysArray[o]=void 0;this.vboCacheKeysArray.length=0,this.vboCacheKeysArray=void 0}},ft.prototype.getVbosCount=function(){return void 0===this.vboCacheKeysArray?0:this.vboCacheKeysArray.length},ft.prototype.getVboKey=function(t){if(void 0!==this.vboCacheKeysArray)return this.vboCacheKeysArray[t]};var gt=function(){if(!(this instanceof gt))throw new Error(j.CONSTRUCT_ERROR);this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[]};gt.prototype.initArrays=function(){this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[]},gt.prototype.clear=function(){this.currentVisibles0.length=0,this.currentVisibles1.length=0,this.currentVisibles2.length=0,this.currentVisibles3.length=0,this.currentVisiblesAux.length=0},gt.prototype.getAllVisibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1,this.currentVisibles2,this.currentVisibles3)},gt.prototype.get01Visibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1)},gt.prototype.getObjectIdxSortedByDist=function(t,e,i,o){var r=i-e;if(r<6){for(var n,a=!1,s=e;!a&&s<=i;){var l=t[s];o.distToCamera<l.distToCamera&&(n=s,a=!0),s++}return a?n:i+1}var d,h,c=e+Math.floor(r/2);return t[c].distToCamera>o.distToCamera?(d=e,h=c):(d=c,h=i),this.getObjectIdxSortedByDist(t,d,h,o)},gt.prototype.putObjectToArraySortedByDist=function(t,e){if(t.length>0){var i=t.length-1,o=this.getObjectIdxSortedByDist(t,0,i,e);t.splice(o,0,e)}else t.push(e)},gt.prototype.getNodeIdxSortedByDist=function(t,e,i,o){o.data.neoBuilding;var r=i-e;if(r<6){for(var n,a=!1,s=e;!a&&s<=i;){var l=t[s];o.data.distToCam<l.data.distToCam&&(n=s,a=!0),s++}return a?n:i+1}var d,h,c=e+Math.floor(r/2);return t[c].data.distToCam>o.data.distToCam?(d=e,h=c):(d=c,h=i),this.getNodeIdxSortedByDist(t,d,h,o)},gt.prototype.putNodeToArraySortedByDist=function(t,e){if(t.length>0){var i=t.length-1,o=this.getNodeIdxSortedByDist(t,0,i,e);t.splice(o,0,e)}else t.push(e)};var pt=function(){if(!(this instanceof pt))throw new Error(j.CONSTRUCT_ERROR);this.bufferId,this.accesorType,this.bufferStart,this.stride,this.dataType,this.dimension,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},vt=function(){if(!(this instanceof vt))throw new Error(j.CONSTRUCT_ERROR);this.vBOVertexIdxCacheKeysContainer=new ft,this.mIFCEntityType=-1,this.isSmallObj=!1,this.radius=10,this.vertexCount=0,this.lego};vt.prototype.deleteObjects=function(t,e){this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0,this.mIFCEntityType=void 0,this.isSmallObj=void 0,this.radius=void 0,this.vertexCount=void 0,this.lego&&this.lego.deleteGlObjects(t),this.lego=void 0},vt.prototype.isReadyToRender=function(t,e,i){return!(i&&this.radius<i)&&!(e.isCameraMoving&&this.radius<e.smallObjectSize&&e.objectSelected!==t)};var yt=function(t){if(!(this instanceof yt))throw new Error(j.CONSTRUCT_ERROR);this.fileLoadState=a.fileLoadState.READY,this.dataArraybuffer},mt=function(t){if(!(this instanceof mt))throw new Error(j.CONSTRUCT_ERROR);this.name="",this.version=t||"",this.blocksArray,this.fileLoadState=a.fileLoadState.READY,this.dataArraybuffer,this.xhr,this.blocksArrayPartitionsCount,this.blocksArrayPartitionsArray,this.blocksArrayPartitionsMasterPathName};mt.prototype.newBlock=function(){void 0===this.blocksArray&&(this.blocksArray=[]);var t=new vt;return this.blocksArray.push(t),t},mt.prototype.getBlock=function(t){return void 0===this.blocksArray?null:t>=0&&t<this.blocksArray.length?this.blocksArray[t]:null},mt.prototype.deleteGlObjects=function(t,e){if(void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),void 0!==this.blocksArray){for(var i=0,o=this.blocksArray.length;i<o;i++){var r=this.blocksArray[i];r.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),r.vBOVertexIdxCacheKeysContainer=void 0,r.mIFCEntityType=void 0,r.isSmallObj=void 0,r.radius=void 0,r.vertexCount=void 0,r.lego&&(r.lego.vbo_vicks_container.deleteGlObjects(t,e),r.lego.vbo_vicks_container=void 0),r.lego=void 0,this.blocksArray[i]=void 0}this.blocksArray=void 0,this.name=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0}},mt.prototype.stepOverBlockVersioned=function(t,e,i){var o,r,n,a,s=i.readInt32(t,e,e+4);e+=4;for(var l=0;l<s;l++)o=i.readUInt32(t,e,e+4),e+=4,e+4*(r=3*o),e+=4*r,o=i.readUInt32(t,e,e+4),e+=4,e+=1*(3*o),n=i.readUInt32(t,e,e+4),e+=4,a=i.readUInt8(t,e,e+1),e+=1,e+=4*a,e+=4*a,e+=2*n;return e},mt.prototype.parseBlockVersioned=function(t,e,i,o,r){var n=r.vboMemoryManager,a=o.readInt32(t,e,e+4);e+=4;for(var s=0;s<a;s++){var l=i.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();e=l.readPosNorIdx(t,o,n,e),i.vertexCount=l.vertexCount}return e},mt.prototype.parseBlocksListVersioned_v001=function(t,e,i,o){this.fileLoadState=a.fileLoadState.PARSE_STARTED;var r=0;r+=5;var n=e.readUInt32(t,r,r+4);r+=4;for(var s=0;s<n;s++){var l=e.readInt32(t,r,r+4);if(r+=4,i[l]){r+=24,r=this.stepOverBlockVersioned(t,r,e);var d=e.readUInt8(t,r,r+1);r+=1,d&&(r=this.stepOverBlockVersioned(t,r,e))}else{var h=new vt;h.idx=l,i[l]=h;var c=new u;c.minX=new Float32Array(t.slice(r,r+4)),r+=4,c.minY=new Float32Array(t.slice(r,r+4)),r+=4,c.minZ=new Float32Array(t.slice(r,r+4)),r+=4,c.maxX=new Float32Array(t.slice(r,r+4)),r+=4,c.maxY=new Float32Array(t.slice(r,r+4)),r+=4,c.maxZ=new Float32Array(t.slice(r,r+4)),r+=4;var f=c.getMaxLength();h.isSmallObj=f<.5,h.radius=f/2,r=this.parseBlockVersioned(t,r,h,e,o);d=e.readUInt8(t,r,r+1);r+=1,d&&(void 0===h.lego&&(h.lego=new Ct),r=this.parseBlockVersioned(t,r,h.lego,e,o))}}return this.fileLoadState=a.fileLoadState.PARSE_FINISHED,!0},mt.prototype.parseBlocksListVersioned_v002=function(t,e,i){var o=this.blocksArrayPartitionsArray.length,r=this.blocksArrayPartitionsArray[o-1];if(r.fileLoadState===a.fileLoadState.LOADING_FINISHED){var n=r.dataArraybuffer;r.fileLoadState=a.fileLoadState.PARSE_STARTED;var s=0,l=i.vboMemoryManager,d=t.readUInt32(n,s,s+4);s+=4;for(var h=0;h<d;h++){var c,f=t.readInt32(n,s,s+4);s+=4,e[f]?c=e[f]:((c=new vt).idx=f,e[f]=c);var g=t.readInt32(n,s,s+4);if(s+=4,0===g){var p=new u;p.minX=new Float32Array(n.slice(s,s+4)),s+=4,p.minY=new Float32Array(n.slice(s,s+4)),s+=4,p.minZ=new Float32Array(n.slice(s,s+4)),s+=4,p.maxX=new Float32Array(n.slice(s,s+4)),s+=4,p.maxY=new Float32Array(n.slice(s,s+4)),s+=4,p.maxZ=new Float32Array(n.slice(s,s+4)),s+=4;var v=p.getMaxLength();c.isSmallObj=v<.5,c.radius=v/2}var y=c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[g];void 0===y?(y=new ut,c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[g]=y,s=y.readPosNorIdx(n,t,l,s),c.vertexCount=y.vertexCount):d>1&&(s=y.stepOverPosNorIdx(n,t,l,s))}return r.fileLoadState=a.fileLoadState.PARSE_FINISHED,this.fileLoadState=a.fileLoadState.PARSE_FINISHED,!0}},mt.prototype.parseBlocksList=function(t,e,i,o){this.fileLoadState=a.fileLoadState.PARSE_STARTED;var r=0,n=e.readUInt32(t,r,r+4);r+=4;for(var s=o.vboMemoryManager,l=0;l<n;l++){var d=e.readInt32(t,r,r+4);if(r+=4,i[d]){r+=24;var h=e.readInt32(t,r,r+4);r+=4;for(var c=0;c<h;c++){var f=e.readUInt32(t,r,r+4);r+=4;var g=3*f;startBuff=r,endBuff=r+4*g,r+=4*g,f=e.readUInt32(t,r,r+4),r+=4,r+=1*(3*f);var p=e.readUInt32(t,r,r+4);r+=4;var v=e.readUInt8(t,r,r+1);r+=1,r+=4*v,r+=4*v,r+=2*p}}else{var y=new vt;y.idx=d,i[d]=y;var m=new u;m.minX=new Float32Array(t.slice(r,r+4)),r+=4,m.minY=new Float32Array(t.slice(r,r+4)),r+=4,m.minZ=new Float32Array(t.slice(r,r+4)),r+=4,m.maxX=new Float32Array(t.slice(r,r+4)),r+=4,m.maxY=new Float32Array(t.slice(r,r+4)),r+=4,m.maxZ=new Float32Array(t.slice(r,r+4)),r+=4;var x=m.getMaxLength();y.isSmallObj=x<.5,y.radius=x/2,m.deleteObjects(),m=void 0;h=e.readInt32(t,r,r+4);r+=4;for(c=0;c<h;c++){var b=y.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();r=b.readPosNorIdx(t,e,s,r),y.vertexCount=b.vertexCount}}}return this.fileLoadState=a.fileLoadState.PARSE_FINISHED,!0},mt.prototype.prepareData=function(t,e){if("0.0.1"===this.version);else if("0.0.2"===this.version){void 0===this.blocksArrayPartitionsArray&&(this.blocksArrayPartitionsArray=[]);var i=this.blocksArrayPartitionsArray.length;if(0===i){var o=0,r=this.blocksArrayPartitionsMasterPathName+o.toString(),n=new yt;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(r,e,n,t)}else{if(this.blocksArrayPartitionsArray[i-1].fileLoadState===a.fileLoadState.PARSE_FINISHED&&i<this.blocksArrayPartitionsCount){o=i,r=this.blocksArrayPartitionsMasterPathName+o.toString(),n=new yt;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(r,e,n,t)}}}};var xt=function(){if(!(this instanceof xt))throw new Error(j.CONSTRUCT_ERROR);this.nodesArray=[],this.projectsMap={},this.staticModelsManager};xt.prototype.deleteNodes=function(t,e){this.projectsMap={};for(var i=this.nodesArray.length,o=0;o<i;o++)this.nodesArray[o]&&(this.nodesArray[o].deleteObjects(t,e),this.nodesArray[o]=void 0);this.nodesArray.length=0},xt.prototype.getStaticModelsManager=function(){return void 0===this.staticModelsManager&&(this.staticModelsManager=new Ne),this.staticModelsManager},xt.prototype.getNodeByDataName=function(t,e,i){var o=this.getNodesMap(t);if(void 0!==o){var r;for(var n in o)if(Object.prototype.hasOwnProperty.call(o,n)){var a=o[n];if(void 0!==a.data&&a.data[e]===i){r=a;break}}return r}},xt.prototype.getNodeByDataKey=function(t,e){var i=this.getNodesMap(t);if(void 0!==i)return i[e]},xt.prototype.getRootNodes=function(t){void 0===t&&(t=[]);for(var e,i=this.nodesArray.length,o=0;o<i;o++)void 0===(e=this.nodesArray[o]).parent&&t.push(e);return t},xt.prototype.existProject=function(t){return this.projectsMap.hasOwnProperty(t)},xt.prototype.getNodesMap=function(t,e){var i=this.projectsMap[t];return void 0===i?(i={},void 0!==e&&(i.attributes=e),this.projectsMap[t]=i):void 0!==e&&void 0===i.attributes&&(i.attributes=e),i},xt.prototype.newNode=function(t,e,i){var o=this.getNodesMap(e,i),r=new Ot;return r.data={nodeId:t},this.nodesArray.push(r),o[t]=r,r};var bt=function(){if(!(this instanceof bt))throw new Error(j.CONSTRUCT_ERROR)},Ct=function(){if(!(this instanceof Ct))throw new Error(j.CONSTRUCT_ERROR);this.vbo_vicks_container=new ft,this.fileLoadState=a.fileLoadState.READY,this.bbox,this.dataArrayBuffer,this.selColor4,this.hasTexCoords,this.texture,this.textureName,this.legoKey,this.xhr,this.renderableType,this.hasColors,this.blendAlpha=0,this.birthTime,this.isAdult=!1};Ct.prototype.parseArrayBuffer=function(t,e,i){this.parseLegoData(e,t,i)},Ct.prototype.getBlendAlpha=function(t){return 1},Ct.prototype.isReadyToRender=function(){return this.fileLoadState===a.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&void 0!==this.texture.texId)},Ct.prototype.deleteObjects=function(t,e){void 0!==this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(t,e),this.vbo_vicks_container=void 0),this.fileLoadState=void 0,this.dataArrayBuffer=void 0,void 0!==this.selColor4&&(this.selColor4.deleteObjects(),this.selColor4=void 0),this.textureName=void 0,this.texture&&this.texture.deleteObjects(t),this.texture=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0},Ct.prototype.parsePointsCloudData=function(t,e,i){if(this.fileLoadState===a.fileLoadState.LOADING_FINISHED){var o=new DataStream(t,0,DataStream.LITTLE_ENDIAN),r=o.readInt32(),n=i.vboMemoryManager;this.fileLoadState=a.fileLoadState.PARSE_STARTED,this.bbox=new u;var s=this.bbox,l=this.vbo_vicks_container.newVBOVertexIdxCacheKey();s.minX=o.readFloat32(),s.minY=o.readFloat32(),s.minZ=o.readFloat32(),s.maxX=o.readFloat32(),s.maxY=o.readFloat32(),s.maxZ=o.readFloat32(),this.bPositionsCompressed=o.readInt8();if(this.bPositionsCompressed?l.setDataArrayPos(o.readUint16Array(3*r),n):l.setDataArrayPos(o.readFloat32Array(3*r),n),this.hasNormals=o.readInt8(),this.hasNormals,this.hasColors=o.readInt8(),this.hasColors){var d=r;l.setDataArrayCol(o.readUint8Array(4*d),n)}this.hasTexCoords=o.readInt8(),this.hasTexCoords,this.hasIndices=o.readInt8(),this.hasIndices,this.fileLoadState=a.fileLoadState.PARSE_FINISHED}},Ct.prototype.parseLegoData=function(t,e,i){if(this.fileLoadState===a.fileLoadState.LOADING_FINISHED){var o=i.vboMemoryManager,r=new DataStream(t,0,DataStream.LITTLE_ENDIAN);this.fileLoadState=a.fileLoadState.PARSE_STARTED,this.bbox=new u;var n=this.bbox,s=this.vbo_vicks_container.newVBOVertexIdxCacheKey();n.minX=r.readFloat32(),n.minY=r.readFloat32(),n.minZ=r.readFloat32(),n.maxX=r.readFloat32(),n.maxY=r.readFloat32(),n.maxZ=r.readFloat32();var l=r.readUint32(),d=r.readFloat32Array(3*l);if(s.setDataArrayPos(d,o),r.readUint8()){var h=r.readUint32(),c=r.readInt8Array(3*h);s.setDataArrayNor(c,o)}if(r.readUint8()){var f=r.readUint32(),g=r.readUint8Array(4*f);s.setDataArrayCol(g,o)}if(this.hasTexCoords=r.readUint8(),this.hasTexCoords){r.readUint16();var p=r.readUint32(),v=r.readFloat32Array(2*p);s.setDataArrayTexCoord(v,o)}return this.fileLoadState=a.fileLoadState.PARSE_FINISHED,!0}},Ct.prototype.render=function(t,e,i,o){var r=!1,n=t.sceneState.gl;if(0===this.vbo_vicks_container.vboCacheKeysArray.length)return!1;n.frontFace(n.CCW);var a=this.vbo_vicks_container.vboCacheKeysArray[0],l=a.vertexCount;if(0===l)return!1;if(0===e||2===e){if(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc),!a.bindDataPosition(o,t.vboMemoryManager))return!1;n.drawArrays(n.TRIANGLES,0,l),r=!0}else if(1===e){if(void 0===t.isTrailRender||!1===t.isTrailRender){var d=this.getBlendAlpha(t.currTime);n.uniform1f(o.externalAlpha_loc,d)}if(i){if(!a.bindDataTexCoord(o,t.vboMemoryManager))return!1}else n.uniform1i(o.bUse1Color_loc,!1),o.disableVertexAttribArray(o.texCoord2_loc);if(!a.bindDataPosition(o,t.vboMemoryManager))return!1;if(!a.bindDataNormal(o,t.vboMemoryManager))return!1;if(i&&void 0!==a.vboBufferTCoord&&(t.configInformation.geo_view_library===s.CESIUM?n.uniform1i(o.textureFlipYAxis_loc,!1):n.uniform1i(o.textureFlipYAxis_loc,!0),o.disableVertexAttribArray(o.color4_loc),!a.bindDataTexCoord(o,t.vboMemoryManager)))return!1;n.drawArrays(n.TRIANGLES,0,l),r=!0,o.disableVertexAttribArray(o.color4_loc)}return r};var At=function(){if(!(this instanceof At))throw new Error(j.CONSTRUCT_ERROR);this.dataType,this.distToCam,this.lod,this.filePath,this.texFilePath,this.skinMesh,this.octree,this.texture};At.prototype.deleteObjects=function(){this.dataType=void 0,this.distToCam=void 0,this.lod=void 0,this.filePath=void 0,this.texFilePath=void 0,this.skinMesh=void 0,this.octree=void 0,this.texture=void 0};var Mt=function(t){if(!(this instanceof Mt))throw new Error(j.CONSTRUCT_ERROR);this.magoManager,void 0!==t&&(this.magoManager=t),this.lod2PCloudDataMap={},this.tinTerrainDataMap={}};Mt.prototype.putLod2PCloudData=function(t,e,i,o,r){t.lego.fileLoadState=a.fileLoadState.IN_QUEUE;var n=new At;n.filePath=e,n.octree=t,n.texFilePath=o,n.texture=i,this.lod2PCloudDataMap[e]=n},Mt.prototype.resetQueue=function(){for(var t in this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,t)){var e=this.lod2PCloudDataMap[t];if(void 0===e.octree||void 0===e.octree.lego)continue;e.octree.lego.fileLoadState=a.fileLoadState.READY}this.lod2PCloudDataMap={}},Mt.prototype.manageQueue=function(){var t=this.magoManager.readerWriter,e=(this.magoManager.sceneState.gl,0);if(!this.magoManager.fileRequestControler.isFullPlusLowLodImages()){for(var i in e=0,this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,i)){var o=this.lod2PCloudDataMap[i],r=o.octree,n=o.filePath;if(void 0!==r.lego&&t.getOctreePCloudArraybuffer(n,r,this.magoManager),delete this.lod2PCloudDataMap[i],o.deleteObjects(),o=void 0,++e>4){!0;break}}this.resetQueue()}};var Pt=function(){if(!(this instanceof Pt))throw new Error(j.CONSTRUCT_ERROR);this.lod,this.isModelRef,this.geometryFileName,this.textureFileName},Tt=function(){if(!(this instanceof Tt))throw new Error(j.CONSTRUCT_ERROR);this.guid,this.version="",this.geographicCoord,this.heading,this.pitch,this.roll,this.bbox,this.imageLodCount,this.projectDataType,this.offSetX,this.offSetY,this.offSetZ,this.oct_min_x=0,this.oct_max_x=0,this.oct_min_y=0,this.oct_max_y=0,this.oct_min_z=0,this.oct_max_z=0,this.isSmall=!1,this.fileLoadState=a.fileLoadState.READY};Tt.prototype.deleteObjects=function(){this.guid=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0,this.imageLodCount=void 0,this.oct_min_x=void 0,this.oct_max_x=void 0,this.oct_min_y=void 0,this.oct_max_y=void 0,this.oct_min_z=void 0,this.oct_max_z=void 0,this.isSmall=void 0,this.fileLoadState=void 0},Tt.prototype.parseFileHeaderAsimetricVersion=function(t,e){var i,o=0;void 0===e&&(e=new jt),this.version="";for(var r=0;r<5;r++)this.version+=String.fromCharCode(new Int8Array(t.slice(o,o+1))[0]),o+=1;void 0===this.guid&&(this.guid=""),i=e.readInt32(t,o,o+4),o+=4;for(r=0;r<i;r++)this.guid+=String.fromCharCode(new Int8Array(t.slice(o,o+1))[0]),o+=1;void 0===this.longitude?(this.longitude=new Float64Array(t.slice(o,o+8))[0],o+=8):o+=8,void 0===this.latitude?(this.latitude=new Float64Array(t.slice(o,o+8))[0],o+=8):o+=8,void 0===this.altitude?(this.altitude=new Float32Array(t.slice(o,o+4))[0],o+=4):o+=4,void 0===this.bbox&&(this.bbox=new u),this.bbox.minX=new Float32Array(t.slice(o,o+4))[0],o+=4,this.bbox.minY=new Float32Array(t.slice(o,o+4))[0],o+=4,this.bbox.minZ=new Float32Array(t.slice(o,o+4))[0],o+=4,this.bbox.maxX=new Float32Array(t.slice(o,o+4))[0],o+=4,this.bbox.maxY=new Float32Array(t.slice(o,o+4))[0],o+=4,this.bbox.maxZ=new Float32Array(t.slice(o,o+4))[0],o+=4;var n=!1;return(this.bbox.maxX-this.bbox.minX>40||this.bbox.maxY-this.bbox.minY>40)&&(n=!0),!n&&this.bbox.maxZ-this.bbox.minZ<30&&(this.isSmall=!0),"0.0.2"===this.version&&(this.projectDataType=new Uint16Array(t.slice(o,o+2))[0],o+=2,this.offSetX=new Float64Array(t.slice(o,o+8))[0],o+=8,this.offSetY=new Float64Array(t.slice(o,o+8))[0],o+=8,this.offSetZ=new Float64Array(t.slice(o,o+8))[0],o+=8),o};var _t=function(){if(!(this instanceof _t))throw new Error(j.CONSTRUCT_ERROR);this.modelIdx,this.referencesIdxArray=[]},wt=function(){if(!(this instanceof wt))throw new Error(j.CONSTRUCT_ERROR);this.modelReferencedGroupsMap=[],this.modelReferencedGroupsArray=[]};wt.prototype.getModelReferencedGroup=function(t){var e=this.modelReferencedGroupsMap[t];return void 0===e&&((e=new _t).modelIdx=t,this.modelReferencedGroupsMap[t]=e),e},wt.prototype.makeModelReferencedGroupsArray=function(){this.modelReferencedGroupsArray.length=0;for(var t=this.modelReferencedGroupsMap.length,e=0;e<t;e++)void 0!==this.modelReferencedGroupsMap[e]&&this.modelReferencedGroupsArray.push(this.modelReferencedGroupsMap[e]);this.modelReferencedGroupsMap.length=0},wt.prototype.createModelReferencedGroups=function(t,e){if(void 0!==t&&void 0!==e){for(var i,o,r=t.length,n=0;n<r;n++)o=e[i=t[n]]._block_idx,this.getModelReferencedGroup(o).referencesIdxArray.push(i);this.makeModelReferencedGroupsArray()}};var St=function(){if(!(this instanceof St))throw new Error(j.CONSTRUCT_ERROR);this.name="",this.metaData,this.buildingId,this.buildingType,this.buildingFileName="",this.bbox,this.bboxAbsoluteCenterPos,this.motherNeoReferencesArray=[],this.motherNeoReferencesMap,this.motherBlocksArray=[],this.isHighLighted,this.isColorChanged,this.aditionalColor,this.texturesLoaded,this.octree,this.currentLod,this.currentVisibleOctreesControler,this.myCameraRelative,this.simpleBuilding3x3Texture,this.lodMeshesMap,this.lodBuildingDatasMap,this.applyOcclusionCulling};St.prototype.getImageFileNameForLOD=function(t){var e=this.getLodBuildingData(t);if(void 0!==e)return e.textureFileName},St.prototype.getReferenceObject=function(t){if(void 0!==this.motherNeoReferencesArray)return this.motherNeoReferencesArray[t]},St.prototype.getReferenceObjectsArrayByObjectId=function(t){if(void 0!==this.motherNeoReferencesMap)return this.motherNeoReferencesMap[t]},St.prototype.putReferenceObject=function(t,e){void 0===this.motherNeoReferencesArray&&(this.motherNeoReferencesArray=[]),this.motherNeoReferencesArray[e]=t,void 0===this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={});var i=this.motherNeoReferencesMap[t.objectId];void 0===i&&(i=[]),i.push(t),this.motherNeoReferencesMap[t.objectId]=i},St.prototype.getRenderSettingApplyOcclusionCulling=function(){return this.applyOcclusionCulling},St.prototype.setRenderSettingApplyOcclusionCulling=function(t){this.applyOcclusionCulling=t},St.prototype.deleteObjectsModelReferences=function(t,e){this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={},this.motherNeoReferencesMap=void 0);for(var i=this.motherBlocksArray.length,o=0;o<i;o++)this.motherBlocksArray[o]&&this.motherBlocksArray[o].deleteObjects(t,e),this.motherBlocksArray[o]=void 0;this.motherBlocksArray=[];var r=this.motherNeoReferencesArray.length;for(o=0;o<r;o++)this.motherNeoReferencesArray[o]&&this.motherNeoReferencesArray[o].deleteObjects(t,e),this.motherNeoReferencesArray[o]=void 0;if(this.motherNeoReferencesArray=[],this.texturesLoaded){var n,s=this.texturesLoaded.length;for(o=0;o<s;o++)(n=this.texturesLoaded[o])&&n.texId&&(t.deleteTexture(n.texId),n.texId=void 0,n.fileLoadState=a.fileLoadState.READY)}},St.prototype.deleteObjectsLodMesh=function(t,e,i){if(void 0!==this.lodMeshesMap&&Object.prototype.hasOwnProperty.call(this.lodMeshesMap,i)){var o=this.lodMeshesMap[i];if(void 0===o)return;delete this.lodMeshesMap[i],o.deleteObjects(t,e),o=void 0}},St.prototype.deleteObjectsLod2=function(t,e){void 0!==this.octree&&this.octree.deleteObjectsLego(t,e)},St.prototype.deleteObjects=function(t,e,i){if(i&&this.metaData.deleteObjects(),this.metaData.fileLoadState=a.fileLoadState.READY,this.deleteObjectsModelReferences(t,e),void 0!==this.octree&&this.octree.deleteObjects(t,e),this.octree=void 0,this.allFilesLoaded=!1,this.isReadyToRender=!1,this.texturesLoaded){for(var o=this.texturesLoaded.length,r=0;r<o;r++)this.texturesLoaded[r]&&this.texturesLoaded[r].deleteObjects(t),this.texturesLoaded[r]=void 0;this.texturesLoaded.length=0}if(this.texturesLoaded=void 0,void 0!==this.lodMeshesMap){for(var n in this.lodMeshesMap)if(Object.prototype.hasOwnProperty.call(this.lodMeshesMap,n)){var s=this.lodMeshesMap[n];if(void 0===s)continue;s.deleteObjects(t,e),s=void 0}this.lodMeshesMap=void 0}},St.prototype.deleteLodMesh=function(t,e,i){if(void 0!==this.lodMeshesMap){var o=this.lodMeshesMap[e];void 0!==o&&(o.deleteObjects(t,i),o=void 0)}},St.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(t),this.bboxAbsoluteCenterPos},St.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,i;(e=this.bbox.getCenterPoint(e),this.bboxAbsoluteCenterPos=t.tMatrix.transformPoint3D(e,this.bboxAbsoluteCenterPos),t.pivotPointTraslation)&&(i=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,i),this.bboxAbsoluteCenterPos.add(i.x,i.y,i.z))},St.prototype.getTextureId=function(t){for(var e,i=this.texturesLoaded.length,o=!1,r=0;!o&&r<i;)this.texturesLoaded[r].textureImageFileName===t.textureImageFileName&&(o=!0,e=this.texturesLoaded[r].texId),r++;return e},St.prototype.getSameTexture=function(t){for(var e,i=this.texturesLoaded.length,o=!1,r=0;!o&&r<i;)this.texturesLoaded[r].textureImageFileName===t.textureImageFileName&&(o=!0,e=this.texturesLoaded[r]),r++;return e},St.prototype.updateCurrentVisibleIndicesExterior=function(t,e,i){this._neoRefLists_Container.updateCurrentVisibleIndicesOfLists(t,e,i)},St.prototype.updateCurrentAllIndicesExterior=function(){this._neoRefLists_Container.updateCurrentAllIndicesOfLists()},St.prototype.isCameraInsideOfBuilding=function(t,e,i){return this.metaData.bbox.isPoint3dInside(t,e,i)},St.prototype.getTransformedRelativeEyePositionToBuilding=function(t,e,i,o){var r=this.buildingPosition,n=t-r.x,a=e-r.y,s=i-r.z;void 0===this.buildingPosMatInv&&(this.buildingPosMatInv=new B,this.buildingPosMatInv.setByFloat32Array(this.moveMatrixInv));var l=new Ce;return void 0===o&&(o=new Ce),l.set(n,a,s),o=this.buildingPosMatInv.transformPoint3D(l,o)},St.prototype.getHeaderVersion=function(){return this.metaData?this.metaData.version:void 0},St.prototype.getLodBuildingData=function(t){if(void 0!==this.lodBuildingDatasMap)return this.lodBuildingDatasMap[t]},St.prototype.getCurrentLodString=function(){return this.getLodBuildingData(this.currentLod).geometryFileName},St.prototype.getLowerSkinLodToLoad=function(t){for(var e,i=5;i>=0;i--){var o=this.getLodBuildingData(i);if(void 0!==o&&!o.isModelRef){var r=o.geometryFileName,n=this.lodMeshesMap[r];if(void 0===n||n.fileLoadState===a.fileLoadState.READY){e=i;break}if(void 0===n.vbo_vicks_container.vboCacheKeysArray){e=i;break}if(n.vbo_vicks_container.vboCacheKeysArray[0]&&n.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&void 0===n.texture){e=i;break}}}return e},St.prototype.getCurrentSkin=function(){if(void 0!==this.lodMeshesMap){var t,e=this.getLodBuildingData(this.currentLod);if(void 0!==e){var i=e.geometryFileName;return void 0!==(t=this.lodMeshesMap[i])&&t.isReadyToRender()?t:(0===this.currentLod?void 0!==(t=this.lodMeshesMap.lod0)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):1===this.currentLod?void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):2===this.currentLod?void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):3===this.currentLod?void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):4===this.currentLod?void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod5)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod3):5===this.currentLod&&(void 0!==(t=this.lodMeshesMap.lod5)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod3)),t)}}},St.prototype.manageNeoReferenceTexture=function(t,e){var i=void 0;if("v"===this.metaData.version[0]){if(void 0===t.texture)return;if(void 0===t.texture.texId&&""!==t.texture.textureImageFileName){void 0===this.texturesLoaded&&(this.texturesLoaded=[]);var o=this.getSameTexture(t.texture);if(void 0===o){if(e.backGround_fileReadings_count>10)return;if(t.texture.fileLoadState===a.fileLoadState.READY){var r=e.sceneState.gl;t.texture.texId=r.createTexture();var n=this.projectFolderName,s=e.readerWriter.geometryDataPath+"/"+n+"/"+this.buildingFileName+"/Images_Resized/"+t.texture.textureImageFileName;this.texturesLoaded.push(t.texture),e.readerWriter.readNeoReferenceTexture(r,s,t.texture,this,e),e.backGround_fileReadings_count++}}else o.fileLoadState===a.fileLoadState.LOADING_FINISHED&&(t.texture=o)}return t.texture.fileLoadState}if("0"===this.metaData.version[0]&&"0"===this.metaData.version[2]&&"1"===this.metaData.version[4]){if(void 0===t.texture||t.texture.fileLoadState===a.fileLoadState.READY){var l=t.materialId;if(i=this.texturesLoaded[l],t.texture=i,void 0===i.texId&&""!==i.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(i.fileLoadState===a.fileLoadState.READY){r=e.sceneState.gl;i.texId=r.createTexture();n=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+n+"/"+this.buildingFileName+"/Images_Resized/"+i.textureImageFileName;e.readerWriter.readNeoReferenceTexture(r,s,i,this,e),e.backGround_fileReadings_count++}}}return t.texture.fileLoadState}if("0"===this.metaData.version[0]&&"0"===this.metaData.version[2]&&"2"===this.metaData.version[4]){if(void 0===this.metaData.projectDataType||this.metaData.projectDataType>3)return t.texture.fileLoadState;if(void 0===t.texture||t.texture.fileLoadState===a.fileLoadState.READY){l=t.materialId;if(i=this.texturesLoaded[l],t.texture=i,void 0===i.texId&&""!==i.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(i.fileLoadState===a.fileLoadState.READY){r=e.sceneState.gl;i.texId=r.createTexture();n=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+n+"/"+this.buildingFileName+"/Images_Resized/"+i.textureImageFileName;e.readerWriter.readNeoReferenceTexture(r,s,i,this,e),e.backGround_fileReadings_count++}}}return t.texture.fileLoadState}},St.prototype.getShaderName=function(t,e,i){var o;return 0===i?t<=1&&(o="modelRefDepth"):1===i?t<=2&&(o="modelRefSsao"):2===i&&t<=1&&(o="modelRefSsao"),o},St.prototype.prepareSkin=function(t){var e=this.getHeaderVersion();if(void 0===e)return!1;if("0"!==e[0])return!1;void 0===this.lodMeshesMap&&(this.lodMeshesMap={});var i,o=this.projectFolderName,r=this.buildingFileName,n=t.readerWriter.geometryDataPath;i=this.getLowerSkinLodToLoad(this.currentLod);var l=this.getLodBuildingData(i);if(void 0===l)return!1;if(l.isModelRef)return!1;var d=l.textureFileName,h=l.geometryFileName,c=this.lodMeshesMap[h];if(void 0===c&&((c=new Ct).fileLoadState=a.fileLoadState.READY,c.textureName=d,c.legoKey=this.buildingId+"_"+h,this.lodMeshesMap[h]=c),-1===c.fileLoadState)return!1;if(c.fileLoadState===a.fileLoadState.READY){var u=n+"/"+o+"/"+r+"/"+h;t.readerWriter.getLegoArraybuffer(u,c,t),void 0===c.vbo_vicks_container.vboCacheKeysArray&&(c.vbo_vicks_container.vboCacheKeysArray=[])}if(c.vbo_vicks_container.vboCacheKeysArray[0]&&c.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&void 0===c.texture){c.texture=new it;var f=n+"/"+o+"/"+r+"/"+d,g=t.sceneState.gl,p=!0;t.configInformation.geo_view_library===s.MAGOWORLD&&(p=!1),t.readerWriter.readLegoSimpleBuildingTexture(g,f,c.texture,t,p)}return!0},St.prototype.render=function(t,e,i,o,r,n){t.sceneState.gl;if(void 0!==n&&(this.currentLod=n),5!==this.metaData.projectDataType)if(this.currentLod<=2){var a=this.getLodBuildingData(this.currentLod);if(a&&!a.isModelRef)this.renderSkin(t,e,i);else{var s=this.renderDetailed(t,e,i,o,r);if(void 0===this.currentVisibleOctreesControler)this.renderSkin(t,e,i);else s<.4*(this.currentVisibleOctreesControler.currentVisibles0.length+this.currentVisibleOctreesControler.currentVisibles1.length+this.currentVisibleOctreesControler.currentVisibles2.length)&&this.renderSkin(t,e,i)}}else this.currentLod>2&&this.renderSkin(t,e,i)},St.prototype.renderSkin=function(t,e,i){var o=this.getCurrentSkin();if(void 0!==o&&o.fileLoadState===a.fileLoadState.PARSE_FINISHED){var r=t.sceneState.gl;1===i&&t.magoPolicy.getObjectMoveMode()===a.moveMode.ALL&&t.buildingSelected===this&&t.renderer.enableStencilBuffer(r),t.renderer.currentObjectsRendering.curOctree=this;var n,s=t.renderer.currentObjectsRendering;2===i&&(t.selectionManager,t.selectionColor,l=!1,n=s.curNode,s.curOctree);var l=!0;if(1===i)this.isHighLighted?(r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,this.highLightColor4),l=!1):this.isColorChanged&&(r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a]),l=!1),void 0!==o.texture&&o.texture.texId&&l?(e.enableVertexAttribArray(e.texCoord2_loc),r.uniform1i(e.colorType_loc,2),e.last_tex_id!==o.texture.texId&&(r.bindTexture(r.TEXTURE_2D,o.texture.texId),e.last_tex_id=o.texture.texId)):void 0!==t.textureAux_1x1&&l?(e.enableVertexAttribArray(e.texCoord2_loc),r.uniform1i(e.colorType_loc,2),r.bindTexture(r.TEXTURE_2D,t.textureAux_1x1)):r.uniform1i(e.colorType_loc,0);else if(2===i){var d;d=t.selectionColor.getAvailableColor(d);var h=t.selectionColor.decodeColor3(d.r,d.g,d.b);t.selectionManager.setCandidates(h,void 0,void 0,this,n),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[d.r/255,d.g/255,d.b/255,1])}r.uniform1i(e.refMatrixType_loc,0),o.render(t,i,l,e),1===i&&t.magoPolicy.getObjectMoveMode()===a.moveMode.ALL&&t.buildingSelected===this&&t.renderer.disableStencilBuffer(r)}},St.prototype.renderDetailed=function(t,e,i,o,r){var n=0;if(void 0===this.currentVisibleOctreesControler)return n;var s,l=!1,d=t.sceneState.gl;0===i?l=!1:1===i&&(l=!!(this.texturesLoaded&&this.texturesLoaded.length>0),t.magoPolicy.getObjectMoveMode()===a.moveMode.ALL&&t.buildingSelected===this&&t.renderer.enableStencilBuffer(d)),t.renderer.currentObjectsRendering.curBuilding=this;var h,c,u,f=this.getRenderSettingApplyOcclusionCulling();void 0===f&&(f=!0),f&&(h=this.myCameraRelative.position.x,c=this.myCameraRelative.position.y,u=this.myCameraRelative.position.z);for(var g=0,p=this.currentVisibleOctreesControler.currentVisibles0.length,v=0;v<p;v++)void 0!==(s=this.currentVisibleOctreesControler.currentVisibles0[v]).neoReferencesMotherAndIndices&&(f&&s.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(h,c,u,f),s.lod=0,s.renderContent(t,this,i,l,e,g,0,r)&&n++);g=.45,p=this.currentVisibleOctreesControler.currentVisibles1.length;for(v=0;v<p;v++)void 0!==(s=this.currentVisibleOctreesControler.currentVisibles1[v]).neoReferencesMotherAndIndices&&(f&&s.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(h,c,u,f),s.lod=1,s.renderContent(t,this,i,l,e,g,0,r)&&n++);e.disableVertexAttribArray(e.color4_loc),p=this.currentVisibleOctreesControler.currentVisibles2.length;for(v=0;v<p;v++)void 0!==(s=this.currentVisibleOctreesControler.currentVisibles2[v]).lego&&(s.lod=2,s.renderContent(t,this,i,l,e,g,0,r)&&n++);return 1===i&&t.magoPolicy.getObjectMoveMode()===a.moveMode.ALL&&t.buildingSelected===this&&t.renderer.disableStencilBuffer(d),n};var Rt=function(){if(!(this instanceof Rt))throw new Error(j.CONSTRUCT_ERROR);this.neoBuildingsArray=[]};Rt.prototype.newNeoBuilding=function(){var t=new St;return this.neoBuildingsArray.push(t),t},Rt.prototype.getNeoBuildingByTypeId=function(t,e){for(var i,o=this.neoBuildingsArray.length,r=!1,n=0;!r&&n<o;)this.neoBuildingsArray[n].buildingType===t&&this.neoBuildingsArray[n].buildingId===e&&(r=!0,i=this.neoBuildingsArray[n]),n++;return i},Rt.prototype.get=function(t){return this.neoBuildingsArray[t]},Rt.prototype.add=function(t){void 0!==t&&this.neoBuildingsArray.push(t)};var Lt=function(){if(!(this instanceof Lt))throw new Error(j.CONSTRUCT_ERROR);this._id=0,this.objectId="",this._block_idx=-1,this._originalMatrix4=new B,this._matrix4=new B,this.tMatrixAuxArray,this.refMatrixType=2,this.refTranslationVec,this.vBOVertexIdxCacheKeysContainer,this.materialId,this.hasTexture=!1,this.texture,this.color4,this.aditionalColor,this.moveVectorRelToBuilding,this.moveVector,this.renderingFase=!1,this.blendAlpha=0,this.birthTime,this.isAdult=!1};Lt.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},Lt.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=0);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.isAdult=!0),this.blendAlpha},Lt.prototype.multiplyTransformMatrix=function(t){this._matrix4=this._originalMatrix4.getMultipliedByMatrix(t)},Lt.prototype.multiplyKeyTransformMatrix=function(t,e){void 0===this.tMatrixAuxArray&&(this.tMatrixAuxArray=[]),this.tMatrixAuxArray[t]=this._originalMatrix4.getMultipliedByMatrix(e,this.tMatrixAuxArray[t]),this.moveVectorRelToBuilding&&(this.moveVector=e.rotatePoint3D(this.moveVectorRelToBuilding,this.moveVector))},Lt.prototype.hasKeyMatrix=function(t){return void 0!==this.tMatrixAuxArray&&void 0!==this.tMatrixAuxArray[t]},Lt.prototype.isReadyToRender=function(){return void 0!==this.tMatrixAuxArray},Lt.prototype.solveReferenceColorOrTexture=function(t,e,i,o){var r=t.sceneState.gl,n=!1;t.selectionManager.parentSelected&&t.objectSelected===this&&(n=!0,t.magoPolicy.getObjectMoveMode()===a.moveMode.OBJECT&&t.renderer.enableStencilBuffer(r)),e.isHighLighted?(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,t.highLightColor4)):e.isColorChanged?(r.uniform1i(i.colorType_loc,0),n?r.uniform4fv(i.oneColor4_loc,[1,0,0,1]):r.uniform4fv(i.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a])):this.aditionalColor?(r.uniform1i(i.colorType_loc,0),n?r.uniform4fv(i.oneColor4_loc,[1,0,0,1]):r.uniform4fv(i.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a])):t.magoPolicy.getObjectMoveMode()===a.moveMode.OBJECT&&n?(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,[1,0,0,1])):t.magoPolicy.colorChangedObjectId===this.objectId?(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,[t.magoPolicy.color[0],t.magoPolicy.color[1],t.magoPolicy.color[2],1])):this.hasTexture?void 0!==this.texture&&void 0!==this.texture.texId?(r.uniform1i(i.colorType_loc,2),i.last_tex_id!==this.texture.texId&&(r.bindTexture(r.TEXTURE_2D,this.texture.texId),i.last_tex_id=this.texture.texId)):(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,[.8,0,.8,1])):(r.uniform1i(i.bUse1Color_loc,!0),this.color4?(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,[this.color4.r/255,this.color4.g/255,this.color4.b/255,this.color4.a/255])):(r.uniform1i(i.colorType_loc,0),r.uniform4fv(i.oneColor4_loc,[.8,.8,.8,1])))},Lt.prototype.render=function(t,e,i,o,r,n,s){if(!this.isReadyToRender())return!1;if(this.hasTexture){if(e.manageNeoReferenceTexture(this,t)!==a.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.texture)return!1;if(void 0===this.texture.texId)return!1}var l,d,h,c,u=t.renderer.currentObjectsRendering;2===i&&(l=t.selectionManager,d=t.selectionColor,o=!1,h=u.curNode,c=u.curOctree);var f=t.sceneState.gl,g=this._block_idx,p=e.motherBlocksArray[g];if(void 0===p)return!1;if((t.mouseLeftDown||t.mouseMiddleDown)&&(s=.5),!p.isReadyToRender(this,t,s))return!1;if(1===i)this.solveReferenceColorOrTexture(t,e,r,u);else if(2===i){this.selColor4=d.getAvailableColor(this.selColor4);var v=d.decodeColor3(this.selColor4.r,this.selColor4.g,this.selColor4.b);l.setCandidates(v,this,c,e,h),this.selColor4&&f.uniform4fv(r.oneColor4_loc,[this.selColor4.r/255,this.selColor4.g/255,this.selColor4.b/255,1])}if(this.aditionalColor=void 0,void 0===t.isTrailRender||!1===t.isTrailRender){var y=this.getBlendAlpha(t.currTime);f.uniform1f(r.externalAlpha_loc,y)}var m,x=p.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length;f.uniform1i(r.refMatrixType_loc,this.refMatrixType),1===this.refMatrixType?f.uniform3fv(r.refTranslationVec_loc,this.refTranslationVec):2===this.refMatrixType&&f.uniformMatrix4fv(r.refMatrix_loc,!1,this.tMatrixAuxArray[n]._floatArrays),void 0!==this.moveVector?(f.uniform1i(r.hasAditionalMov_loc,!0),f.uniform3fv(r.aditionalMov_loc,[this.moveVector.x,this.moveVector.y,this.moveVector.z]),r.last_isAditionalMovedZero=!1):r.last_isAditionalMovedZero||(f.uniform1i(r.hasAditionalMov_loc,!1),f.uniform3fv(r.aditionalMov_loc,[0,0,0]),r.last_isAditionalMovedZero=!0);for(var b=0;b<x;b++){if(!(m=p.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[b]).bindDataPosition(r,t.vboMemoryManager))return!1;if(1===i){if(!m.bindDataNormal(r,t.vboMemoryManager))return!1;if(o&&this.hasTexture)if(p.vertexCount<=this.vertexCount){if(!this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[b].bindDataTexCoord(r,t.vboMemoryManager))return!1}else r.disableVertexAttribArray(r.texCoord2_loc);else r.disableVertexAttribArray(r.texCoord2_loc)}var C;if(t.isCameraMoving?C=m.indicesCount:t.thereAreUrgentOctrees?(C=m.bigTrianglesIndicesCount)>m.indicesCount&&(C=m.indicesCount):C=m.indicesCount,!m.bindDataIndice(r,t.vboMemoryManager))return!1;f.drawElements(f.TRIANGLES,C,f.UNSIGNED_SHORT,0)}return!0},Lt.prototype.deleteObjects=function(t,e){this._id=void 0,this._block_idx=void 0,this._matrix4._floatArrays=void 0,this._matrix4=void 0,this._originalMatrix4._floatArrays=void 0,this._originalMatrix4=void 0,this.hasTexture=void 0,this.texture=void 0,this.color4&&this.color4.deleteObjects(),this.color4=void 0,this.selColor4&&this.selColor4.deleteObjects(),this.selColor4=void 0,this.moveVector&&this.moveVector.deleteObjects(),this.moveVector=void 0,this.bRendered=void 0,void 0!==this.vBOVertexIdxCacheKeysContainer&&(this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0)};var Dt=function(){if(!(this instanceof Dt))throw new Error(j.CONSTRUCT_ERROR);this.motherNeoRefsList,this.neoRefsIndices=[],this.modelReferencedGroupsList,this.blocksList,this.fileLoadState=0,this.dataArraybuffer,this.succesfullyGpuDataBinded,this.exterior_ocCullOctree,this.interior_ocCullOctree,this.currentVisibleIndices=[],this.currentVisibleMRG,this.xhr};Dt.prototype.multiplyKeyTransformMatrix=function(t,e){for(var i=this.neoRefsIndices.length,o=0;o<i;o++)this.motherNeoRefsList[this.neoRefsIndices[o]].multiplyKeyTransformMatrix(t,e)},Dt.prototype.updateCurrentVisibleIndices=function(t,e,i,o){void 0===o&&(o=!0);var r=!1;if(void 0!==this.interior_ocCullOctree){var n=!1;if(this.interior_ocCullOctree._subBoxesArray&&this.interior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&o){var a=this.interior_ocCullOctree.getIntersectedSubBoxByPoint3D(t,e,i);void 0!==a&&a._indicesArray.length>0?(this.currentVisibleIndices=a._indicesArray,r=!1):r=!0}else this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList}if(r&&void 0!==this.exterior_ocCullOctree){n=!1;this.exterior_ocCullOctree._subBoxesArray&&this.exterior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&o?(void 0===this.currentVisibleMRG&&(this.currentVisibleMRG=new wt),this.currentVisibleIndices=this.exterior_ocCullOctree.getIndicesVisiblesForEye(t,e,i,this.currentVisibleIndices,this.currentVisibleMRG)):(this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList)}},Dt.prototype.getNeoReference=function(t){return this.motherNeoRefsList[this.neoRefsIndices[t]]},Dt.prototype.deleteObjects=function(t,e){void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),this.motherNeoRefsList=void 0,this.neoRefsIndices=void 0,void 0!==this.blocksList&&void 0!==this.blocksList.xhr&&this.fileLoadState!==a.fileLoadState.READY&&(this.blocksList.xhr.abort(),this.blocksList.xhr=void 0),this.blocksList=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0,this.exterior_ocCullOctree=void 0,this.interior_ocCullOctree=void 0},Dt.prototype.isReadyToRender=function(){return void 0!==this.neoRefsIndices&&0!==this.neoRefsIndices.length&&(void 0!==this.blocksList&&this.blocksList.fileLoadState===a.fileLoadState.PARSE_FINISHED)},Dt.prototype.setRenderedFalseToAllReferences=function(){for(var t=this.neoRefsIndices.length,e=0;e<t;e++)this.motherNeoRefsList[this.neoRefsIndices[e]].bRendered=!1},Dt.prototype.createModelReferencedGroups=function(){void 0!==this.neoRefsIndices&&(void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new wt),this.modelReferencedGroupsList.createModelReferencedGroups(this.neoRefsIndices,this.motherNeoRefsList))},Dt.prototype.parseArrayBufferReferencesVersioned=function(t,e,i,o,r,n){var s,l;this.fileLoadState=a.fileLoadState.PARSE_STARTED;var d,h,c,u,f=0,g=n.vboMemoryManager;this.succesfullyGpuDataBinded=!0;String.fromCharCode.apply(null,new Int8Array(e.slice(f,f+5)));f+=5;var p=i.readUInt32(e,f,f+4);f+=4;for(var v=0;v<p;v++){var y=new Lt,m=i.readUInt32(e,f,f+4);if(f+=4,y._id=m,this.motherNeoRefsList=o.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[y._id]){y=this.motherNeoRefsList[y._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);var b=i.readUInt8(e,f,f+1);f+=1;var C=String.fromCharCode.apply(null,new Int8Array(e.slice(f,f+b)));f+=b;var A=i.readUInt32(e,f,f+4);f+=4;var M=i.readUInt8(e,f,f+1);f+=1,0===M||(1===M?f+=12:2===M&&(f+=64));var P=i.readUInt8(e,f,f+1);if(f+=1,P){var T=i.readUInt16(e,f,f+2);f+=2;var _=i.readUInt8(e,f,f+1);f+=1,5121===T&&(B=1);var w=i.readUInt8(e,f,f+B);f+=B;var S=i.readUInt8(e,f,f+B);f+=B;var R=i.readUInt8(e,f,f+B);f+=B;var L=255;4===_&&(L=i.readUInt8(e,f,f+B),f+=B)}var D=i.readUInt8(e,f,f+1);f+=1;var I=i.readUInt8(e,f,f+1);if(f+=1,D||I){var E=i.readInt32(e,f,f+4);f+=4;for(var O=0;O<E;O++){if(D){T=i.readUInt16(e,f,f+2);f+=2;_=i.readUInt8(e,f,f+1);f+=1,5120===T||5121===T?B=1:5122===T||5123===T?B=2:5126===T&&(B=4);var F=i.readUInt32(e,f,f+4);s=f+=4,l=f+B*(j=F*_),f+=B*j}if(I){T=i.readUInt16(e,f,f+2);f+=2,5120===T||5121===T?B=1:5122===T||5123===T?B=2:5126===T&&(B=4);F=i.readUInt32(e,f,f+4);s=f+=4,l=f+B*(j=2*F),f+=B*j}}}i.readInt32(e,f,f+4);f+=4,0===y.refMatrixType&&1,1===y.refMatrixType&&1,2===y.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);b=i.readUInt8(e,f,f+1);f+=1,"noObjectId"!==(C=String.fromCharCode.apply(null,new Int8Array(e.slice(f,f+b))))&&0!==C.length||(C=y._id.toString()),y.objectId=C,f+=b,o.putReferenceObject(y,y._id);A=i.readUInt32(e,f,f+4);f+=4,y._block_idx=A,y.refMatrixType=i.readUInt8(e,f,f+1),f+=1,0===y.refMatrixType?1:1===y.refMatrixType?(h=i.readFloat32(e,f,f+4),f+=4,c=i.readFloat32(e,f,f+4),f+=4,u=i.readFloat32(e,f,f+4),f+=4,y.refTranslationVec=new Float32Array([h,c,u]),1):2===y.refMatrixType&&(y._originalMatrix4._floatArrays[0]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[1]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[2]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[3]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[4]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[5]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[6]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[7]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[8]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[9]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[10]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[11]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[12]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[13]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[14]=i.readFloat32(e,f,f+4),f+=4,y._originalMatrix4._floatArrays[15]=i.readFloat32(e,f,f+4),f+=4,1);P=i.readUInt8(e,f,f+1);if(f+=1,P){T=i.readUInt16(e,f,f+2);f+=2;_=i.readUInt8(e,f,f+1);f+=1,5121===T&&(B=1);w=i.readUInt8(e,f,f+B);f+=B;S=i.readUInt8(e,f,f+B);f+=B;R=i.readUInt8(e,f,f+B);f+=B;L=255;4===_&&(L=i.readUInt8(e,f,f+B),f+=B),y.color4=new x,y.color4.set(w,S,R,L)}D=i.readUInt8(e,f,f+1);f+=1;I=i.readUInt8(e,f,f+1);if(f+=1,D||I){E=i.readInt32(e,f,f+4);f+=4,E>0&&void 0===y.vBOVertexIdxCacheKeysContainer&&(y.vBOVertexIdxCacheKeysContainer=new ft);for(O=0;O<E;O++){var N=y.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(D){T=i.readUInt16(e,f,f+2);f+=2;_=i.readUInt8(e,f,f+1);f+=1,5120===T||5121===T?B=1:5122===T||5123===T?B=2:5126===T&&(B=4);F=i.readUInt32(e,f,f+4);f+=4,d=j=F*_,g.getClassifiedBufferSize(d),y.vertexCount=F,s=f,l=f+B*j;var V=new Float32Array(e.slice(s,l));N.setDataArrayColor(V,g),f+=B*j,N.isReadyColors(t,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(I){var B;T=i.readUInt16(e,f,f+2);f+=2,5120===T||5121===T?B=1:5122===T||5123===T?B=2:5126===T&&(B=4);F=i.readUInt32(e,f,f+4);f+=4;var j=2*F;y.vertexCount=F,s=f,l=f+B*j;var U=new Float32Array(e.slice(s,l));N.setDataArrayTexCoord(U,g),f+=B*j}}}y.materialId=i.readInt32(e,f,f+4),f+=4,-1===y.materialId?y.hasTexture=!1:y.hasTexture=!0,r&&y.multiplyTransformMatrix(r)}}i.readUInt32(e,f,f+4);f+=4,void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new H);var G=this.exterior_ocCullOctree;f=this.exterior_ocCullOctree.parseArrayBuffer(e,f,i),G.expandBox(1e3),G.setSizesSubBoxes(),G.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new H);var k=this.interior_ocCullOctree;return f=this.interior_ocCullOctree.parseArrayBuffer(e,f,i),k.setSizesSubBoxes(),k.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=a.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},Dt.prototype.parseArrayBufferReferences=function(t,e,i,o,r,n){var s,l;this.fileLoadState=a.fileLoadState.PARSE_STARTED;var d=0,h=i.readUInt32(e,d,d+4);d+=4;var c,u,f=n.vboMemoryManager,g=0,p=0;this.succesfullyGpuDataBinded=!0;for(var v=0;v<h;v++){var y=new Lt,m=i.readUInt32(e,d,d+4);if(d+=4,y._id=m,this.motherNeoRefsList=o.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[y._id]){y=this.motherNeoRefsList[y._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);var b=i.readUInt8(e,d,d+1);d+=1;var C=String.fromCharCode.apply(null,new Int8Array(e.slice(d,d+b)));d+=b;var A=i.readUInt32(e,d,d+4);d+=4,y._block_idx=A,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4,i.readFloat32(e,d,d+4),d+=4;var M=i.readUInt8(e,d,d+1);if(d+=1,M){var P=i.readUInt16(e,d,d+2);d+=2;var T=i.readUInt8(e,d,d+1);d+=1,5121===P&&(j=1);var _=i.readUInt8(e,d,d+j);d+=j;var w=i.readUInt8(e,d,d+j);d+=j;var S=i.readUInt8(e,d,d+j);d+=j;var R=255;4===T&&(R=i.readUInt8(e,d,d+j),d+=j)}var L=i.readUInt8(e,d,d+1);d+=1;var D=i.readUInt8(e,d,d+1);if(d+=1,L||D){var I=i.readInt32(e,d,d+4);d+=4;for(var E=0;E<I;E++){if(L){P=i.readUInt16(e,d,d+2);d+=2;T=i.readUInt8(e,d,d+1);d+=1,5120===P||5121===P?j=1:5122===P||5123===P?j=2:5126===P&&(j=4);var O=i.readUInt32(e,d,d+4);s=d+=4,l=d+j*(U=O*T),d+=j*U}if(D){P=i.readUInt16(e,d,d+2);d+=2,5120===P||5121===P?j=1:5122===P||5123===P?j=2:5126===P&&(j=4);O=i.readUInt32(e,d,d+4);s=d+=4,l=d+j*(U=2*O),d+=j*U}}}var F=i.readUInt32(e,d,d+4);if(d+=4,F>0){var N=i.readUInt32(e,d,d+4);d+=4;for(E=0;E<N;E++)d+=1;var V=i.readUInt32(e,d,d+4);d+=4;for(E=0;E<V;E++)d+=1}0===y.refMatrixType&&1,1===y.refMatrixType&&1,2===y.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);b=i.readUInt8(e,d,d+1);d+=1,"noObjectId"!==(C=String.fromCharCode.apply(null,new Int8Array(e.slice(d,d+b))))&&""!==C||(C=y._id),y.objectId=C,d+=b,o.putReferenceObject(y,y._id);A=i.readUInt32(e,d,d+4);d+=4,y._block_idx=A,y._originalMatrix4._floatArrays[0]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[1]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[2]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[3]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[4]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[5]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[6]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[7]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[8]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[9]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[10]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[11]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[12]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[13]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[14]=i.readFloat32(e,d,d+4),d+=4,y._originalMatrix4._floatArrays[15]=i.readFloat32(e,d,d+4),d+=4,y.refMatrixType=y._originalMatrix4.computeMatrixType(),0===y.refMatrixType&&1,1===y.refMatrixType&&(y.refTranslationVec=new Float32Array([y._originalMatrix4._floatArrays[12],y._originalMatrix4._floatArrays[13],y._originalMatrix4._floatArrays[14]]),1),2===y.refMatrixType&&1;M=i.readUInt8(e,d,d+1);if(d+=1,M){P=i.readUInt16(e,d,d+2);d+=2;T=i.readUInt8(e,d,d+1);d+=1,5121===P&&(j=1);_=i.readUInt8(e,d,d+j);d+=j;w=i.readUInt8(e,d,d+j);d+=j;S=i.readUInt8(e,d,d+j);d+=j;R=255;4===T&&(R=i.readUInt8(e,d,d+j),d+=j),y.color4=new x,y.color4.set(_,w,S,R)}L=i.readUInt8(e,d,d+1);d+=1;D=i.readUInt8(e,d,d+1);if(d+=1,L||D){I=i.readInt32(e,d,d+4);d+=4,I>0&&void 0===y.vBOVertexIdxCacheKeysContainer&&(y.vBOVertexIdxCacheKeysContainer=new ft);for(E=0;E<I;E++){var B=y.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(L){P=i.readUInt16(e,d,d+2);d+=2;T=i.readUInt8(e,d,d+1);d+=1,5120===P||5121===P?j=1:5122===P||5123===P?j=2:5126===P&&(j=4);O=i.readUInt32(e,d,d+4);d+=4,c=j*(U=O*T),p=f.getClassifiedBufferSize(c),y.vertexCount=O,s=d,l=d+j*U,B.colVboDataArray=new Float32Array(p),B.colVboDataArray.set(new Float32Array(e.slice(s,l))),B.colArrayByteSize=p,d+=j*U,B.isReadyColors(t,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(D){var j;P=i.readUInt16(e,d,d+2);d+=2,5120===P||5121===P?j=1:5122===P||5123===P?j=2:5126===P&&(j=4);var U;O=i.readUInt32(e,d,d+4);d+=4,u=j*(U=2*O),g=f.getClassifiedBufferSize(u),y.vertexCount=O,s=d,l=d+j*U,B.tcoordVboDataArray=new Float32Array(g),B.tcoordVboDataArray.set(new Float32Array(e.slice(s,l))),B.tcoordArrayByteSize=g,d+=j*U}}}F=i.readUInt32(e,d,d+4);if(d+=4,F>0){var G,k="";N=i.readUInt32(e,d,d+4);d+=4;for(E=0;E<N;E++)k+=String.fromCharCode(new Int8Array(e.slice(d,d+1))),d+=1;V=i.readUInt32(e,d,d+4);d+=4;var z=new Uint8Array(e.slice(d,d+V));d+=V,G=new TextDecoder("utf-8").decode(z),V>0&&(y.texture=new it,y.hasTexture=!0,y.texture.textureTypeName=k,y.texture.textureImageFileName=G)}else y.hasTexture=!1;r&&y.multiplyTransformMatrix(r)}}void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new H);var W=this.exterior_ocCullOctree;d=this.exterior_ocCullOctree.parseArrayBuffer(e,d,i),W.expandBox(1e3),W.setSizesSubBoxes(),W.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new H);var X=this.interior_ocCullOctree;return d=this.interior_ocCullOctree.parseArrayBuffer(e,d,i),X.setSizesSubBoxes(),X.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=a.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},Dt.prototype.render=function(t,e,i,o,r,n,s){var l=!0;if(!this.isReadyToRender())return!1;2===i&&(o=!1);var d=t.sceneState.gl;2===i&&(r.disableVertexAttribArray(r.texCoord2_loc),r.disableVertexAttribArray(r.normal3_loc)),0===i&&(r.disableVertexAttribArray(r.texCoord2_loc),r.disableVertexAttribArray(r.normal3_loc),r.disableVertexAttribArray(r.color4_loc)),o&&(d.activeTexture(d.TEXTURE2),1===i&&d.uniform1i(r.colorType_loc,2));var h=t.texturesManager.getTextureAux1x1();d.bindTexture(d.TEXTURE_2D,h),r.last_tex_id=h;for(var c=this.currentVisibleIndices.length,u=0,f=0;f<c;f++){var g=this.motherNeoRefsList[this.currentVisibleIndices[f]];void 0!==g&&(g.renderingFase!==t.renderingFase&&(g.render(t,e,i,o,r,s,n)||u++,g.swapRenderingFase(),1===i&&t.magoPolicy.getObjectMoveMode()===a.moveMode.OBJECT&&t.objectSelected===g&&(t.renderer.disableStencilBuffer(d),d.disable(d.POLYGON_OFFSET_FILL))))}return(c-u)/c<.4&&(l=!1),l};var It=function(){if(!(this instanceof It))throw new Error(j.CONSTRUCT_ERROR);this.accesorsArray=[],this.vbo_vicks_container=new ft,this.texturesArray=[]};It.prototype.newAccesor=function(){var t=new pt;return this.accesorsArray.push(t),t},It.prototype.newTexture=function(){var t=new Et;return this.texturesArray.push(t),t};var Et=function(){if(!(this instanceof Et))throw new Error(j.CONSTRUCT_ERROR);this.lod,this.textureId,this.texImage,this.loadStarted=!1,this.loadFinished=!1},Ot=function(){if(!(this instanceof Ot))throw new Error(j.CONSTRUCT_ERROR);this.parent,this.children=[],this.data};Ot.prototype.isReferenceNode=function(){var t=!1;if(void 0!==this.data){var e=this.data.attributes;void 0!==e&&void 0!==e.isReference&&(t=e.isReference)}return t},Ot.prototype.isReadyToRender=function(){var t=this.getNodeGeoLocDataManager();if(void 0===t)return!1;var e=t.getCurrentGeoLocationData();if(void 0===e)return!1;var i=e.getGeographicCoords();return void 0!==i&&(void 0!==i.longitude&&void 0!==i.latitude&&void 0!==i.altitude)},Ot.prototype.deleteObjects=function(t,e){this.parent=void 0;var i=this.data;if(void 0!==i){if(this.isReferenceNode())return;i.neoBuilding&&(i.neoBuilding.deleteObjects(t,e),i.neoBuilding=void 0),i.geographicCoord&&(i.geographicCoord.deleteObjects(),i.geographicCoord=void 0),i.rotationsDegree&&(i.rotationsDegree.deleteObjects(),i.rotationsDegree=void 0),i.bbox&&(i.bbox.deleteObjects(),i.bbox=void 0),this.data=void 0}if(this.children){for(var o=this.children.length,r=0;r<o;r++)this.children[r].deleteObjects(t,e),this.children[r]=void 0;this.children=void 0}},Ot.prototype.calculateGeoLocData=function(t){var e=this.getRoot();void 0===e.data.geoLocDataManager&&(e.data.geoLocDataManager=new O);var i=e.data.geoLocDataManager,o=i.getCurrentGeoLocationData();if(void 0===o||void 0===o.pivotPoint){var r,n;if(o=i.newGeoLocationData("deploymentLoc"),void 0===this.data.geographicCoord)r=(u=this.data.buildingSeed).geographicCoord,n=u.rotationsDegree;else r=this.data.geographicCoord,n=this.data.rotationsDegree;var a=r.longitude,s=r.latitude,l=r.altitude,d=n.z,h=n.x,c=n.y;if(Ai.calculateGeoLocationData(a,s,l,d,h,c,o,t),this.pointSC=this.data.bbox.getCenterPoint(this.pointSC),void 0!==this.data.mapping_type&&"boundingboxcenter"===this.data.mapping_type.toLowerCase())if(this.getRoot()){if("G15_0002"===this.data.nodeId);var u,f=(u=this.data.buildingSeed).bBox;this.pointSC=f.getCenterPoint(this.pointSC),Ai.translatePivotPointGeoLocationData(o,this.pointSC)}}return o},Ot.prototype.checkChangesHistoryMovements=function(){var t=this.data.moveHistoryMap;if(void 0!==t){var e=this.data.neoBuilding;for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var o=t[i],r=o.getObjectIndexOrder(),n=e.getReferenceObject(r);if(void 0===n)continue;void 0===n.moveVector&&(n.moveVector=new Ce),void 0===n.moveVectorRelToBuilding&&(n.moveVectorRelToBuilding=new Ce);var a=o.getReferenceObjectAditionalMovement(),s=o.getReferenceObjectAditionalMovementRelToBuilding();n.moveVectorRelToBuilding.set(s.x,s.y,s.z),n.moveVector.set(a.x,a.y,a.z);var l=this.getRoot();if(void 0===l)continue;var d=l.getNodeGeoLocDataManager().getCurrentGeoLocationData();n.moveVector=d.tMatrix.rotatePoint3D(n.moveVectorRelToBuilding,n.moveVector)}}},Ot.prototype.checkChangesHistoryColors=function(){var t=this.data;if(void 0!==t){var e=t.colorChangedHistoryMap;if(void 0!==e){for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i)){var o=e[i];if(null===o.objectId||void 0===o.objectId||""===o.objectId)if(null===o.property||void 0===o.property||""===o.property)t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new x),t.aditionalColor.setRGB(o.rgbColor[0],o.rgbColor[1],o.rgbColor[2]);else{var r=[];this.extractNodes(r);for(var n,a=r.length,s=0;s<a;s++){n=r[s];var l=o.propertyKey,d=o.propertyValue;void 0!==n.data.attributes[l]&&n.data.attributes[l].toString()===d&&(t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new x),t.aditionalColor.setRGB(o.rgbColor[0],o.rgbColor[1],o.rgbColor[2]))}}else{var h=this.data.neoBuilding;if(void 0===h)return;var c=o.objectId,u=h.getReferenceObjectsArrayByObjectId(c);if(u)for(var f=u.length,g=0;g<f;g++){var p=u[g];void 0===p.aditionalColor&&(p.aditionalColor=new x),p.aditionalColor.setRGB(o.rgbColor[0],o.rgbColor[1],o.rgbColor[2])}}}}}},Ot.prototype.renderContent=function(t,e,i,o){var r=this.data;if(void 0!==r){var n=r.renderable;if(n)n.render(t,e,i);else{var a=r.neoBuilding;if(void 0!==a&&(!r.attributes||void 0===r.attributes.isVisible||!1!==r.attributes.isVisible)){var s=t.selectionManager;t.nodeSelected===this?s.parentSelected=!0:s.parentSelected=!1,a.currentVisibleOctreesControler=r.currentVisibleOctreesControler,a.myCameraRelative=r.myCameraRelative,a.isColorChanged=r.isColorChanged,a.aditionalColor=r.aditionalColor,this.checkChangesHistoryColors(),this.checkChangesHistoryMovements();a.metaData.projectDataType;var l=this.getRoot().data.geoLocDataManager,d=t.sceneState.gl,h=t.hierarchyManager.getNodesMap(r.projectId);if(void 0!==h.attributes&&void 0!==h.attributes.specularLighting&&void 0!==e.bApplySpecularLighting_loc)h.attributes.specularLighting?d.uniform1i(e.bApplySpecularLighting_loc,!0):d.uniform1i(e.bApplySpecularLighting_loc,!1);t.renderer.currentObjectsRendering.curNode=this;var c=!1;void 0!==r.attributes.flipYTexCoords&&(c=r.attributes.flipYTexCoords),d.uniform1i(e.textureFlipYAxis_loc,c);var u=t.renderingFase;this.isReferenceNode()&&(t.renderingFase=-10);var f,g=this.data.isTrailRender;if(void 0!==g&&!0===g){t.isTrailRender=!0,d.depthRange(.1,1);for(var p=l.getGeoLocationDatasCount(),v=1;v<p;v++){l.getGeoLocationData(v).bindGeoLocationUniforms(d,e);var y=(p-v)/(7*p);d.uniform1f(e.externalAlpha_loc,y),a.currentLod=r.currentLod,a.render(t,e,i,o,c,r.currentLod)}d.depthRange(0,1),t.isTrailRender=!1}f=l.getGeoLocationDatasCount()>1?1:0,l.getGeoLocationData(f).bindGeoLocationUniforms(d,e),d.uniform1f(e.externalAlpha_loc,1),a.currentLod=r.currentLod,a.render(t,e,i,o,c,r.currentLod),t.renderingFase=u,void 0!==this.data.animationData&&!0===this.data.animationData.finished&&(l.getGeoLocationDatasCount()>1?l.popGeoLocationData():this.data.animationData=void 0)}}}},Ot.prototype.addChildren=function(t){t.setParent(this),this.children.push(t)},Ot.prototype.setParent=function(t){this.parent=t},Ot.prototype.getRoot=function(){return void 0===this.parent?this:this.parent.getRoot()},Ot.prototype.getClosestParentWithData=function(t){return this.data&&this.data[t]?this:this.parent?this.parent.getClosestParentWithData(t):void 0},Ot.prototype.extractNodesByDataName=function(t,e){this.data[e]&&t.push(this);for(var i=this.children.length,o=0;o<i;o++)this.children[o].extractNodesByDataName(t,e)},Ot.prototype.extractNodes=function(t){t.push(this);for(var e=this.children.length,i=0;i<e;i++)this.children[i].extractNodes(t)},Ot.prototype.getBBox=function(){var t,e=this.data;if(void 0===e.bbox){var i=e.neoBuilding;if(void 0!==i&&void 0!==i.metaData){var o=i.metaData;e.bbox=new u,e.bbox.copyFrom(o.bbox),t=e.bbox}else if(void 0!==e.buildingSeed){t=e.buildingSeed.bbox}}else t=e.bbox;return t},Ot.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos?this.calculateBBoxCenterPositionWorldCoord(t):this.bboxAbsoluteCenterPos},Ot.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,i,o;(e=void 0!==this.data.bbox?this.data.bbox.getCenterPoint(e):void 0!==this.data.neoBuilding?this.data.neoBuilding.bbox.getCenterPoint(e):new Ce,i=t.tMatrix.transformPoint3D(e,i),t.pivotPointTraslation)&&(o=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,o),i.add(o.x,o.y,o.z));return i},Ot.prototype.getDistToCamera=function(t,e){var i=this.data,o=i.neoBuilding,r=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0===this.bboxAbsoluteCenterPos&&void 0!==this.data.bbox){var n=this.data.bbox.getCenterPoint(n);this.bboxAbsoluteCenterPos=r.tMatrix.transformPoint3D(n,this.bboxAbsoluteCenterPos)}var a,s=this.getBBoxCenterPositionWorldCoord(r);a=this.getBBox().getRadiusAprox(),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(a);var l=o.metaData.projectDataType;if(!l||4!==l&&5!==l)i.distToCam=t.distToSphere(e);else{var d,h=o.octree;if(void 0===h)return;d=r.getTransformedRelativePosition(t,d);i.distToCam=h.getMinDistToCameraInTree(d,e,120),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(o.bbox.getRadiusAprox())}return i.distToCam},Ot.prototype.getNodeGeoLocDataManager=function(){var t=this.getClosestParentWithData("geoLocDataManager");if(void 0!==t&&void 0!==t.data)return t.data.geoLocDataManager},Ot.prototype.finishedAnimation=function(t){var e=!1,i=this.data.animationData;if(void 0===i)return!0;var o,r,n,s,l,d,h=t.getCurrentTime();if(i.animationType===a.animationType.PATH){var u=c.getNextPosition(i,h,t);if(void 0===u)return i.finished=!0,!0;var f=i.path.getGeoLocationDataManager().getCurrentGeoLocationData(),g=u.point,p=u.direction,v=f.tMatrix.transformPoint3D(g,void 0),y=F.CartesianToGeographicWgs84(v.x,v.y,v.z,void 0);r=y.latitude,o=y.longitude,n=y.altitude;var m=new me(0,1),x=new me(p.x,p.y);x.unitary();var b=m.angleDegToVector(x);return x.x>0&&(b*=-1),this.changeLocationAndRotation(r,o,n,b,void 0,void 0,t),i.lastTime=h,e}if(i.finished)return!0;if(void 0===i.startLongitude||void 0===i.startLatitude||void 0===i.startAltitude)return!0;void 0===i.lastTime&&(i.lastTime=i.birthTime);var C=(h-i.birthTime)/1e3,A=(i.targetLongitude-i.startLongitude)/i.durationInSeconds,M=(i.targetLatitude-i.startLatitude)/i.durationInSeconds,P=(i.targetAltitude-i.startAltitude)/i.durationInSeconds,T=this.getNodeGeoLocDataManager();if(void 0===T)return!0;var _=T.getCurrentGeoLocationData();if(void 0===_)return!0;_.geographicCoord;if(C>i.durationInSeconds)o=i.targetLongitude,r=i.targetLatitude,n=i.targetAltitude,s=i.targetHeading,l=i.targetPitch,d=i.targetRoll,e=!0,this.data.animationData.finished=!0;else{var w=C/i.durationInSeconds;if(w>.3)s=i.targetHeading,l=i.targetPitch,d=i.targetRoll;else{var S=i.targetHeading-i.startHeading;s=i.startHeading+S*w/.3,l=i.startPitch,d=i.startRoll}i.targetLongitude,i.targetLatitude,i.targetAltitude;o=i.startLongitude+A*C,r=i.startLatitude+M*C,n=i.startAltitude+P*C,i.lastTime=h,e=!1}return this.changeLocationAndRotation(r,o,n,s,l,d,t),e},Ot.prototype.changeLocationAndRotationAnimated=function(t,e,i,o,r,n,a,s){void 0===this.data.animationData&&(this.data.animationData=new h);var l=this.data.animationData;l.finished=!1,l.animationType=s.animationType,l.path=s.path,l.linearVelocityInMetersSecond=s.linearVelocityInMetersSecond;var d=this.getNodeGeoLocDataManager();if(void 0!==d){var c=d.getCurrentGeoLocationData();if(void 0!==c){var u=d.getGeoLocationData(1);void 0===u&&(u=d.getCurrentGeoLocationData());var f=c.getGeographicCoords();if(void 0!==f&&void 0!==f.longitude&&void 0!==f.latitude&&void 0!==f.altitude){var g=f.longitude-e,p=f.latitude-t,v=(f.altitude,Math.sqrt(g*g+p*p));if(v<65e-6)l.finished=!0;else{for(l.birthTime=a.getCurrentTime(),l.startLongitude=f.longitude,l.startLatitude=f.latitude,l.startAltitude=f.altitude;c.heading>360;)c.heading-=360;for(;c.heading<-360;)c.heading+=360;l.startHeading=c.heading,l.startPitch=c.pitch,l.startRoll=c.roll,l.targetLongitude=e,l.targetLatitude=t,l.targetAltitude=i;f.longitude,f.latitude,f.altitude;l.targetHeading=1*o,l.targetPitch=r,l.targetRoll=n;var y=3;if("object"==typeof s&&isNaN(s))if(s.duration&&(y=s.duration),s.autoChangeRotation){var m,x=F.geographicToCartesianWgs84(l.targetLongitude,l.targetLatitude,l.targetAltitude,void 0),b=new Ce(x[0],x[1],x[2]);(m=u.getTransformedRelativePositionNoApplyHeadingPitchRoll(b,m)).unitary();var C=new me(0,1),A=new me(m.x,m.y);A.unitary();var M=C.angleDegToVector(A);m.x>0&&(M*=-1),M>180?M-=360:M<180&&(M+=360);var P=M;for(Math.sqrt(m.x*m.x+m.y*m.y);P>360;)P-=360;for(;P<-360;)P+=360;(T=P-l.startHeading)>180?P-=360:T<-180&&(P+=360),v<65e-6*1.5&&A.y<.1&&(P=l.startHeading),l.targetHeading=P,l.targetPitch=0,l.targetRoll=n}else{for(;o>360;)o-=360;for(;o<-360;)o+=360;var T;(T=o-l.startHeading)>180?o-=360:T<-180&&(o+=360),l.targetHeading=1*o}else y=s;l.durationInSeconds=y}}}}},Ot.prototype.nodeMoved=function(t){if(void 0!==t){var e=t.data.smartTileOwner;if(!e.intersectsNode(t)){e.eraseNode(t);var i=e.targetDepth;magoManager.smartTileManager.putNode(i,t,magoManager)}}},Ot.prototype.changeLocationAndRotation=function(t,e,i,o,r,n,a){var s;if(void 0!==(s=this.getClosestParentWithData("geoLocDataManager"))&&s.data.bbox){var l,d=[];s.extractNodesByDataName(d,"neoBuilding"),s.data.geographicCoord.longitude=e,s.data.geographicCoord.latitude=t,s.data.geographicCoord.altitude=i;for(var h=d.length,c=0;c<h;c++){var u,f=(l=d[c]).getNodeGeoLocDataManager();if(void 0!==f)if(void 0!==(u=void 0!==this.data.animationData?f.newGeoLocationData():f.getCurrentGeoLocationData())&&void 0!==(u=Ai.calculateGeoLocationData(e,t,i,o,r,n,u,a))&&void 0!==u.geographicCoord){var g=l.data.buildingSeed;g.geographicCoordOfBBox.longitude=e,g.geographicCoordOfBBox.latitude=t;var p=l.data.neoBuilding;p.octree&&p.octree.multiplyKeyTransformMatrix(0,u.rotMatrix),p.calculateBBoxCenterPositionWorldCoord(u),s.bboxAbsoluteCenterPos=void 0,s.calculateBBoxCenterPositionWorldCoord(u),l.bboxAbsoluteCenterPos=void 0,l.calculateBBoxCenterPositionWorldCoord(u),void 0===s.data.bbox.geographicCoord&&(s.data.bbox.geographicCoord=new R),s.data.bbox.geographicCoord.setLonLatAlt(e,t,i);var v=l.data.smartTileOwner;if(!v.intersectsNode(l)){v.eraseNode(l);var y=v.targetDepth;a.smartTileManager.putNode(y,l,a)}}}}};var Ft=function(t){if(!(this instanceof Ft))throw new Error(j.CONSTRUCT_ERROR);this.centerPos=new Ce,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,t&&(this.octree_owner=t,this.octree_level=t.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.distToCamera,this.triPolyhedronsCount=0,this.fileLoadState=a.fileLoadState.READY,this.subOctrees_array=[],this.neoReferencesMotherAndIndices,this.lowestOctrees_array,this.lego,this.pCloudPartitionsCount,this.pCloudPartitionsArray};Ft.prototype.new_subOctree=function(){var t=new Ft(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},Ft.prototype.deleteObjectsModelReferences=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteObjectsModelReferences(t,e)},Ft.prototype.deleteObjectsLego=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteObjectsLego(t,e)},Ft.prototype.deleteObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.legoDataArrayBuffer=void 0,this.centerPos&&this.centerPos.deleteObjects(),this.centerPos=void 0,this.half_dx=void 0,this.half_dy=void 0,this.half_dz=void 0,this.octree_owner=void 0,this.octree_level=void 0,this.octree_number_name=void 0,this.distToCamera=void 0,this.triPolyhedronsCount=void 0,this.fileLoadState=void 0,this.neoBuildingOwner=void 0,this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,this.deletePCloudObjects(t,e),void 0!==this.subOctrees_array){for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteObjects(t,e),this.subOctrees_array[i]=void 0;this.subOctrees_array=void 0}},Ft.prototype.deletePCloudObjects=function(t,e){if(void 0!==this.pCloudPartitionsArray){for(var i=this.pCloudPartitionsArray.length,o=0;o<i;o++){this.pCloudPartitionsArray[o].deleteObjects(t,e)}this.pCloudPartitionsArray=void 0}if(void 0!==this.subOctrees_array){var r=this.subOctrees_array.length;for(o=0;o<r;o++){this.subOctrees_array[o].deletePCloudObjects(t,e)}}},Ft.prototype.deleteLod0GlObjects=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteLod0GlObjects(t,e)},Ft.prototype.deleteLod2GlObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteLod2GlObjects(t,e)},Ft.prototype.makeTree=function(t){if(this.octree_level<t){for(var e=0;e<8;e++){var i=this.new_subOctree();i.octree_number_name=10*this.octree_number_name+(e+1),i.neoBuildingOwnerId=this.neoBuildingOwnerId,i.octreeKey=this.neoBuildingOwnerId+"_"+i.octree_number_name}this.setSizesSubBoxes();for(e=0;e<8;e++)this.subOctrees_array[e].makeTree(t)}},Ft.prototype.prepareData=function(t){this.lod<2?this.prepareModelReferencesListData(t):this.lod>=2&&this.prepareSkinData(t)},Ft.prototype.prepareSkinData=function(t){if(void 0!==this.octree_number_name){void 0===this.lego&&(this.lego=new Ct,this.lego.birthTime=t.currTime,this.lego.fileLoadState=a.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego");var e=this.neoBuildingOwner;if(void 0!==e){var i=t.sceneState.gl,o=t.readerWriter.geometryDataPath,r=e.projectFolderName,n=e.buildingFileName,l=e.getHeaderVersion();if(this.lego.fileLoadState===a.fileLoadState.READY){var d=o+"/"+r+"/"+n+"/Bricks"+"/"+this.octree_number_name.toString()+"_Brick";if("v"===l[0])if(this.lego.vbo_vicks_container.vboCacheKeysArray[0]&&this.lego.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey){if(void 0===e.simpleBuilding3x3Texture){e.simpleBuilding3x3Texture=new it;var h=o+"/"+r+"/"+(n=e.buildingFileName)+"/SimpleBuildingTexture3x3.png"}void 0!==e.simpleBuilding3x3Texture&&e.simpleBuilding3x3Texture.fileLoadState===a.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(i,h,e.simpleBuilding3x3Texture,t),t.readerWriter.getOctreeLegoArraybuffer(d,this,t)}else t.readerWriter.getOctreeLegoArraybuffer(d,this,t);else{var c=!0;t.configInformation.geo_view_library===s.MAGOWORLD&&(c=!1),void 0===e.simpleBuilding3x3Texture&&(e.simpleBuilding3x3Texture=new it);h=o+"/"+r+"/"+n+"/"+e.getImageFileNameForLOD(2);void 0!==e.simpleBuilding3x3Texture&&e.simpleBuilding3x3Texture.fileLoadState===a.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(i,h,e.simpleBuilding3x3Texture,t,c),t.readerWriter.getOctreeLegoArraybuffer(d,this,t)}}}}},Ft.prototype.prepareModelReferencesListData=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){e.getHeaderVersion();var i=t.readerWriter.geometryDataPath,o=e.buildingFileName,r=e.projectFolderName;if(void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new Dt,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===a.fileLoadState.READY){void 0===this.neoReferencesMotherAndIndices.blocksList&&(this.neoReferencesMotherAndIndices.blocksList=new mt("0.0.1"));var n=i+"/"+r+"/"+o+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(n,this,t)}var s=this.neoReferencesMotherAndIndices.blocksList;if(void 0!==s&&s.fileLoadState===a.fileLoadState.READY){var l=i+"/"+r+"/"+o+"/Models"+"/"+this.octree_number_name.toString()+"_Model";t.readerWriter.getNeoBlocksArraybuffer(l,this,t)}}},Ft.prototype.prepareModelReferencesListData_v002=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){var i=t.readerWriter.geometryDataPath,o=e.buildingFileName,r=e.projectFolderName;if(void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new Dt,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===a.fileLoadState.READY){if(void 0===this.neoReferencesMotherAndIndices.blocksList){var n=new mt("0.0.2");this.neoReferencesMotherAndIndices.blocksList=n,n.blocksArrayPartitionsCount=this.blocksListsPartitionsCount;var s=i+"/"+r+"/"+o+"/Models"+"/"+this.octree_number_name.toString()+"_Model_";n.blocksArrayPartitionsMasterPathName=s}var l=i+"/"+r+"/"+o+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(l,this,t)}void 0!==(n=this.neoReferencesMotherAndIndices.blocksList)&&n.prepareData(t,this)}},Ft.prototype.renderSkin=function(t,e,i,o,r){var n=t.sceneState.gl;if(void 0===this.lego)return this.lego=new Ct,this.lego.fileLoadState=a.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego",!1;if(this.lego.fileLoadState!==a.fileLoadState.PARSE_FINISHED)return!1;if(o=!0,n.uniform1i(r.refMatrixType_loc,0),1===i){if(e.isHighLighted?(n.uniform1i(r.colorType_loc,0),n.uniform4fv(r.oneColor4_loc,this.highLightColor4),o=!1):e.isColorChanged&&(n.uniform1i(r.colorType_loc,0),n.uniform4fv(r.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a]),o=!1),void 0===e.simpleBuilding3x3Texture||!e.simpleBuilding3x3Texture.texId||!o)return!1;n.uniform1i(r.textureFlipYAxis_loc,!1),n.uniform1i(r.colorType_loc,2),r.last_tex_id!==e.simpleBuilding3x3Texture.texId&&(n.bindTexture(n.TEXTURE_2D,e.simpleBuilding3x3Texture.texId),r.last_tex_id=e.simpleBuilding3x3Texture.texId)}else if(2===i){var s;s=t.selectionColor.getAvailableColor(s);var l=t.selectionColor.decodeColor3(s.r,s.g,s.b),d=t.renderer.currentObjectsRendering.curNode;t.selectionManager.setCandidates(l,void 0,this,e,d),n.uniform1i(r.colorType_loc,0),n.uniform4fv(r.oneColor4_loc,[s.r/255,s.g/255,s.b/255,1])}return this.lego.render(t,i,o,r)},Ft.prototype.renderContent=function(t,e,i,o,r,n,a,s){var l=!1,d=t.sceneState.gl;if(this.lod<2){if(void 0===this.neoReferencesMotherAndIndices)return;d.uniform1i(r.textureFlipYAxis_loc,s),(l=this.neoReferencesMotherAndIndices.render(t,e,i,o,r,n,a))||(l=this.renderSkin(t,e,i,o,r))}else 2===this.lod&&(l=this.renderSkin(t,e,i,o,r));return l},Ft.prototype.getPartitionsCountsForLod=function(t,e,i){var o=1;if(0===t)(o=e)>(r=i.magoPolicy.getPointsCloudSettings()).maxPartitionsLod0&&(o=r.maxPartitionsLod0);else if(1===t){var r=i.magoPolicy.getPointsCloudSettings();(o=Math.ceil(e/4))>r.maxPartitionsLod1&&(o=r.maxPartitionsLod1)}else t>1&&(o=1);return o},Ft.prototype.preparePCloudData=function(t){if(void 0===this.pCloudPartitionsCount&&0===this.pCloudPartitionsCount)return!1;var e=this.neoBuildingOwner;if(void 0===e)return!1;if(t.processQueue.existOctreeToDeletePCloud(this))return!1;void 0===this.pCloudPartitionsArray&&(this.pCloudPartitionsArray=[]);for(var i=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),o=0;o<i;o++){var r=this.pCloudPartitionsArray[o];if(o<this.pCloudPartitionsArray.length){if(void 0!==r&&r.fileLoadState===a.fileLoadState.LOADING_FINISHED&&t.parseQueue.pCloudPartitionsParsed<4){var n=t.sceneState.gl;r.parsePointsCloudData(r.dataArrayBuffer,n,t),r.dataArrayBuffer=void 0,t.parseQueue.pCloudPartitionsParsed++}}else if(void 0===r){var s=t.readerWriter;if((0===this.octree_level?s.pCloudPartitionsMother_requested:s.pCloudPartitions_requested)<3&&t.vboMemoryManager.currentMemoryUsage<t.vboMemoryManager.buffersKeyWorld.bytesLimit/1.5){var l=new Ct;this.pCloudPartitionsArray.push(l),l.legoKey=this.octreeKey+"_"+o.toString();var d=e.projectFolderName,h=e.buildingFileName,c=t.readerWriter.geometryDataPath+"/"+d+"/"+h+"/References"+"/"+this.octree_number_name.toString()+"_Ref_"+o.toString();return s.getOctreePCloudPartitionArraybuffer(c,this,l,t),!0}}}return!1},Ft.prototype.test__renderPCloud=function(t,e,i,o,r,n){var l=this.pCloudPartitionsCount;if(void 0!==l&&0!==l){var d=t.magoPolicy,h=(t.sceneState.camera,r.bigFrustum),c=r.position,u=this.centerPos.distToPoint(c)-this.getRadiusAprox();if(this.distToCamera=u,0===i){var f=t.visibleObjControlerPCloudOctrees;f.putObjectToArraySortedByDist(f.currentVisibles0,this)}this.lod=d.getLod(u);var g=t.sceneState.gl;if(this.intersectionFrustum(h,t.boundingSphere_Aux)!==s.INTERSECTION_OUTSIDE){t.processQueue.eraseOctreeToDeletePCloud(this);if(void 0===this.pCloudPartitionsArray)return;for(var p=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),v=!0,y=0;y<p;y++){if(void 0===(C=this.pCloudPartitionsArray[y])||C.fileLoadState!==a.fileLoadState.PARSE_FINISHED){v=!1;break}var m=C.bPositionsCompressed;g.uniform1i(o.bPositionCompressed_loc,m);var x=C.bbox;g.uniform3fv(o.bboxSize_loc,[x.getXLength(),x.getYLength(),x.getZLength()]),g.uniform3fv(o.minPosition_loc,[x.minX,x.minY,x.minZ]),t.renderer.renderPCloud(g,C,t,o,i,u,this.lod)}if(v){y=0;for(var b=this.subOctrees_array.length;y<b;y++){this.subOctrees_array[y].test__renderPCloud(t,e,i,o,r,n)}}t.processQueue.eraseOctreeToDeletePCloud(this)}else if(u>50){if(void 0!==this.pCloudPartitionsArray)for(p=this.pCloudPartitionsArray.length,y=0;y<p;y++){var C=this.pCloudPartitionsArray[y];t.parseQueue.eraseOctreePCloudPartitionToParse(C)}t.processQueue.putOctreeToDeletePCloud(this)}}},Ft.prototype.getNumberOfDigits=function(t){return t>0?Math.floor(Math.log10(t)+1):1},Ft.prototype.getMotherOctree=function(){return void 0===this.octree_owner?this:this.octree_owner.getMotherOctree()},Ft.prototype.getOctree=function(t,e){if(1===e)return 0===t?this.getMotherOctree():this.subOctrees_array[t-1];var i=e-1,o=Math.pow(10,i),r=Math.floor(t/o)%10,n=t-r*o;return this.subOctrees_array[r-1].getOctree(n,e-1)},Ft.prototype.getOctreeByNumberName=function(t){var e=this.getMotherOctree(),i=this.getNumberOfDigits(t);if(1===i)return 0===t?e:e.subOctrees_array[t-1];if(0!==e.subOctrees_array.length){var o=i-1,r=Math.pow(10,o),n=Math.floor(t/r)%10,a=t-n*r;return e.subOctrees_array[n-1].getOctree(a,i-1)}},Ft.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>0){var t=this.centerPos.x,e=this.centerPos.y,i=this.centerPos.z,o=this.centerPos.x-this.half_dx,r=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(o,t,r,e,n,i),this.subOctrees_array[1].setBoxSize(t,a,r,e,n,i),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,i),this.subOctrees_array[3].setBoxSize(o,t,e,s,n,i),this.subOctrees_array[4].setBoxSize(o,t,r,e,i,l),this.subOctrees_array[5].setBoxSize(t,a,r,e,i,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,i,l),this.subOctrees_array[7].setBoxSize(o,t,e,s,i,l);for(var d=0;d<8;d++)this.subOctrees_array[d].setSizesSubBoxes()}},Ft.prototype.setBoxSize=function(t,e,i,o,r,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(o+i)/2,this.centerPos.z=(n+r)/2,this.half_dx=(e-t)/2,this.half_dy=(o-i)/2,this.half_dz=(n-r)/2},Ft.prototype.getCenterPos=function(){return this.centerPos},Ft.prototype.getRadiusAprox=function(){return 1.7*this.half_dx},Ft.prototype.getFrustumVisibleLowestOctreesByLOD=function(t,e,i,o,r,n,a,s){for(var l=[],d=!1,h=(l=this.getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,l,o)).length,c=0;c<h;c++)l[c].setDistToCamera(r);for(c=0;c<h;c++)l[c].distToCamera<n?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles0,l[c]),e.currentVisibles0.push(l[c]),l[c].lod=0,d=!0):l[c].distToCamera<a?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles1,l[c]),e.currentVisibles1.push(l[c]),l[c].lod=1,d=!0):l[c].distToCamera<s?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles2,l[c]),e.currentVisibles2.push(l[c]),l[c].lod=2,d=!0):l[c].triPolyhedronsCount>0&&(i&&i.currentVisibles3.push(l[c]),e.currentVisibles3.push(l[c]),l[c].lod=3,d=!0);return l=void 0,d},Ft.prototype.intersectsWithPoint3D=function(t,e,i){var o=this.centerPos.x-this.half_dx,r=this.centerPos.y-this.half_dz,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dz,l=this.centerPos.z+this.half_dz,d=!1;return t>o&&t<a&&e>r&&e<s&&i>n&&i<l&&(d=!0),d},Ft.prototype.getIntersectedSubBoxByPoint3D=function(t,e,i){if(void 0===this.octree_owner&&!this.intersectsWithPoint3D(t,e,i))return!1;var o=void 0;if(this.subOctrees_array.length>0){var r,n=this.centerPos.x,a=this.centerPos.y,s=this.centerPos.z;r=t<n?e<a?i<s?0:4:i<s?3:7:e<a?i<s?1:5:i<s?2:6,o=this.subOctrees_array[r].getIntersectedSubBoxByPoint3D(t,e,i)}else o=this;return o},Ft.prototype.getMinDistToCamera=function(t){var e,i=1e6;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var o=this.lowestOctrees_array.length,r=0;r<o;r++)(e=this.lowestOctrees_array[r].centerPos.distToPoint(t)-this.getRadiusAprox())<i&&(i=e);return i},Ft.prototype.extractLowestOctreesByLOD=function(t,e,i,o,r,n,a){var s=!1;o.x,o.y,o.z;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var l=this.lowestOctrees_array.length,d=0;d<l;d++)this.lowestOctrees_array[d].setDistToCamera(o);for(d=0;d<l;d++)this.lowestOctrees_array[d].distToCamera<r?this.lowestOctrees_array[d].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles0,this.lowestOctrees_array[d]),t.currentVisibles0.push(this.lowestOctrees_array[d]),this.lowestOctrees_array[d].lod=0,s=!0):this.lowestOctrees_array[d].distToCamera<n?this.lowestOctrees_array[d].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles1,this.lowestOctrees_array[d]),t.currentVisibles1.push(this.lowestOctrees_array[d]),this.lowestOctrees_array[d].lod=1,s=!0):this.lowestOctrees_array[d].distToCamera<a?this.lowestOctrees_array[d].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles2,this.lowestOctrees_array[d]),t.currentVisibles2.push(this.lowestOctrees_array[d]),this.lowestOctrees_array[d].lod=2,s=!0):this.lowestOctrees_array[d].triPolyhedronsCount>0&&(e&&e.currentVisibles3.push(this.lowestOctrees_array[d]),t.currentVisibles3.push(this.lowestOctrees_array[d]),this.lowestOctrees_array[d].lod=3,s=!0);return s},Ft.prototype.intersectionFrustum=function(t,e){return void 0===e&&(e=new J),e.centerPoint.x=this.centerPos.x,e.centerPoint.y=this.centerPos.y,e.centerPoint.z=this.centerPos.z,e.r=this.getRadiusAprox(),t.intersectionSphere(e)},Ft.prototype.getFrustumVisibleOctreesNeoBuildingAsimetricVersion=function(t,e,i){if(void 0!==this.subOctrees_array&&(0!==this.subOctrees_array.length||0!==this.triPolyhedronsCount)){void 0===e&&(e=[]);var o=this.intersectionFrustum(t,i);if(o===s.INTERSECTION_INSIDE)this.getAllSubOctreesIfHasRefLists(e);else if(o===s.INTERSECTION_INTERSECT)if(0===this.subOctrees_array.length)e.push(this);else for(var r=0,n=this.subOctrees_array.length;r<n;r++)this.subOctrees_array[r].getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,e,i);return e}},Ft.prototype.getBBoxIntersectedOctreesNeoBuildingAsimetricVersion=function(t,e,i){void 0!==this.subOctrees_array&&(0===this.subOctrees_array.length&&0===this.triPolyhedronsCount||(void 0===e&&(e=[]),void 0===i&&(i=new u),i.minX=this.centerPos.x-this.half_dx,i.maxX=this.centerPos.x+this.half_dx,i.minY=this.centerPos.y-this.half_dy,i.maxY=this.centerPos.y+this.half_dy,i.minZ=this.centerPos.z-this.half_dz,i.maxZ=this.centerPos.z+this.half_dz,t.intersectsWithBBox(i)&&this.getAllSubOctreesIfHasRefLists(e)))},Ft.prototype.setDistToCamera=function(t){var e=this.centerPos.distToPoint(t)-this.getRadiusAprox();return this.distToCamera=e,e},Ft.prototype.getIndexToInsertBySquaredDistToEye=function(t,e,i,o){void 0===i&&(i=0),void 0===o&&(o=t.length-1);var r=o-i;if(r<=0)return 0;if(r<6){var n,a=!1,s=i;for(t.length;!a&&s<=o;)e.distToCamera<t[s].distToCamera&&(n=s,a=!0),s++;return a?n:o+1}var l,d,h=i+Math.floor(r/2);return t[h].distToCamera>e.distToCamera?(l=i,d=h):(l=h,d=o),this.getIndexToInsertBySquaredDistToEye(t,e,l,d)},Ft.prototype.putOctreeInEyeDistanceSortedArray=function(t,e){if(t.length>0){var i=t.length-1,o=this.getIndexToInsertBySquaredDistToEye(t,e,0,i);t.splice(o,0,e)}else t.push(e)},Ft.prototype.getAllSubOctreesIfHasRefLists=function(t){if(void 0!==this.subOctrees_array)if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,i=this.subOctrees_array.length;e<i;e++)this.subOctrees_array[e].getAllSubOctreesIfHasRefLists(t);else this.triPolyhedronsCount>0&&t.push(this)},Ft.prototype.getAllSubOctrees=function(t){if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,i=this.subOctrees_array.length;e<i;e++)this.subOctrees_array[e].getAllSubOctrees(t);else t.push(this)},Ft.prototype.extractLowestOctreesIfHasTriPolyhedrons=function(t){if(void 0!==this.subOctrees_array){var e=this.subOctrees_array.length;if(0===e&&this.triPolyhedronsCount>0)t.push(this);else for(var i=0;i<e;i++)this.subOctrees_array[i].extractLowestOctreesIfHasTriPolyhedrons(t)}},Ft.prototype.multiplyKeyTransformMatrix=function(t,e){var i=this.subOctrees_array.length;if(0===i&&this.triPolyhedronsCount>0)this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(t,e);else for(var o=0;o<i;o++)this.subOctrees_array[o].multiplyKeyTransformMatrix(t,e)},Ft.prototype.parseAsimetricVersion=function(t,e,i,o){o.getHeaderVersion();var r=e.readInt32(t,i,i+4);if(i+=4,0===r){var n=e.readFloat32(t,i,i+4);i+=4;var a=e.readFloat32(t,i,i+4);i+=4;var s=e.readFloat32(t,i,i+4);i+=4;var l=e.readFloat32(t,i,i+4);i+=4;var d=e.readFloat32(t,i,i+4);i+=4;var h=e.readFloat32(t,i,i+4);i+=4,this.setBoxSize(n,a,s,l,d,h),this.octree_number_name=0}var c=e.readUInt8(t,i,i+1);i+=1,this.triPolyhedronsCount=e.readInt32(t,i,i+4),i+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=o);for(var u=0;u<c;u++){(f=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(u+1),f.neoBuildingOwnerId=this.neoBuildingOwnerId,f.octreeKey=this.neoBuildingOwnerId+"_"+f.octree_number_name}this.setSizesSubBoxes();for(u=0;u<c;u++){var f;i=(f=this.subOctrees_array[u]).parseAsimetricVersion(t,e,i,o)}return i},Ft.prototype.parsePyramidVersion=function(t,e,i,o){var r=e.readInt32(t,i,i+4);if(i+=4,0===r){var n=e.readFloat32(t,i,i+4);i+=4;var a=e.readFloat32(t,i,i+4);i+=4;var s=e.readFloat32(t,i,i+4);i+=4;var l=e.readFloat32(t,i,i+4);i+=4;var d=e.readFloat32(t,i,i+4);i+=4;var h=e.readFloat32(t,i,i+4);i+=4,this.setBoxSize(n,a,s,l,d,h),this.octree_number_name=0}var c=e.readUInt8(t,i,i+1);i+=1,this.triPolyhedronsCount=e.readInt32(t,i,i+4),i+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=o),this.pCloudPartitionsCount=e.readInt32(t,i,i+4),i+=4;for(var u=0;u<c;u++){(f=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(u+1),f.neoBuildingOwnerId=this.neoBuildingOwnerId,f.octreeKey=this.neoBuildingOwnerId+"_"+f.octree_number_name}this.setSizesSubBoxes();for(u=0;u<c;u++){var f;i=(f=this.subOctrees_array[u]).parsePyramidVersion(t,e,i,o)}return i},Ft.prototype.getDistToCamera=function(t,e){return e.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z),e.setRadius(this.getRadiusAprox()),t.distToSphere(e)},Ft.prototype.getMinDistToCameraInTree=function(t,e,i){var o,r=this.getRadiusAprox(),n=this.subOctrees_array.length;if(r>i&&n>0){for(var a,s,l,d=0;d<n;d++){var h=!1,c=this.subOctrees_array[d];c.pCloudPartitionsCount&&c.pCloudPartitionsCount>0&&(h=!0),c.triPolyhedronsCount&&c.triPolyhedronsCount>0&&(h=!0),h&&(a=c.centerPos.squareDistToPoint(t),void 0===s?(s=a,l=c):a<s&&(s=a,l=c))}if(l)return l.getMinDistToCameraInTree(t,e,i)}else o=this.centerPos.distToPoint(t);return o};var Nt=function(){if(!(this instanceof Nt))throw new Error(j.CONSTRUCT_ERROR);this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={},this.octreesPCloudToParseMap={},this.octreesPCloudPartitionToParseMap={},this.skinLegosToParseMap={},this.tinTerrainsToParseMap={},this.maxNumParses=1,this.pCloudPartitionsParsed=0};Nt.prototype.putTinTerrainToParse=function(t,e){void 0===e&&(e=0),this.tinTerrainsToParseMap[t.getPathName()]=t},Nt.prototype.eraseTinTerrainToParse=function(t){if(void 0!==t){var e=t.getPathName();return!!this.tinTerrainsToParseMap.hasOwnProperty(e)&&(delete this.tinTerrainsToParseMap[e],!0)}},Nt.prototype.parseArraySkins=function(t,e,i){if(Object.keys(this.skinLegosToParseMap).length>0)for(var o,r,n=0,a=this.maxNumParses,s=e.length,l=0;l<s;l++)if(void 0!==(r=e[l].data.neoBuilding)&&void 0!==r.lodMeshesMap){var d=r.currentLod;if(!(d<0)){var h=void 0;if(0===d?h="lod0":1===d?h="lod1":2===d?h="lod2":3===d?h="lod3":4===d?h="lod4":5===d&&(h="lod5"),void 0!==h&&void 0!==(o=r.lodMeshesMap[h])&&(this.eraseSkinLegosToParse(o)&&(o.parseArrayBuffer(t,o.dataArrayBuffer,i),o.dataArrayBuffer=void 0,n++),n>a))break}}},Nt.prototype.parseArrayOctreesPCloud=function(t,e,i){if(Object.keys(this.octreesPCloudToParseMap).length>0){for(var o,r=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++){if(o=e[s],this.eraseOctreePCloudToParse(o)){if(void 0===o.lego)continue;o.lego.parsePointsCloudData(t,o.lego.dataArrayBuffer,i),o.lego.dataArrayBuffer=void 0,n++}if(n>r)break}if(0===n)for(var l in this.octreesPCloudToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudToParseMap,l)){if(o=this.octreesPCloudToParseMap[l],this.eraseOctreePCloudToParse(o)){if(void 0===o.lego)continue;o.lego.parsePointsCloudData(o.lego.dataArrayBuffer,t,i),o.lego.dataArrayBuffer=void 0,n++}if(n>r)break}n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},Nt.prototype.parseArrayOctreesPCloudPartition=function(t,e,i){if(Object.keys(this.octreesPCloudPartitionToParseMap).length>0){for(var o,r=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++)if(void 0!==(o=e[s]).pCloudPartitionsArray){for(var l=o.pCloudPartitionsArray.length,d=0;d<l;d++){var h=o.pCloudPartitionsArray[d];this.eraseOctreePCloudPartitionToParse(h)&&(h.parsePointsCloudData(t,h.dataArrayBuffer,i),h.dataArrayBuffer=void 0,n++)}if(n>r)break}if(0===n)for(var c in this.octreesPCloudPartitionToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudPartitionToParseMap,c)&&(o=this.octreesPCloudPartitionToParseMap[c],this.eraseOctreePCloudPartitionToParse(o)&&(h.parsePointsCloudData(t,h.dataArrayBuffer,i),h.dataArrayBuffer=void 0,n++),n>r))break;n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},Nt.prototype.parseArrayOctreesLod2Legos=function(t,e,i){if(Object.keys(this.octreesLod2LegosToParseMap).length>0){for(var o,r=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++){if(o=e[s],this.eraseOctreeLod2LegosToParse(o)){if(void 0===o.lego)continue;o.lego.parseArrayBuffer(t,o.lego.dataArrayBuffer,i),o.lego.dataArrayBuffer=void 0,n++}if(n>r)break}n>0&&i.selectionFbo&&(i.selectionFbo.dirty=!0)}},Nt.prototype.parseArrayOctreesLod0Models=function(t,e,i){if(Object.keys(this.octreesLod0ModelsToParseMap).length>0){for(var o,r,n,s=this.maxNumParses,l=0,d=e.length,h=0;h<d;h++){if(r=(o=(n=e[h]).neoBuildingOwner).getHeaderVersion(),this.eraseOctreeLod0ModelsToParse(n)){if(void 0===n.neoReferencesMotherAndIndices)continue;var c=n.neoReferencesMotherAndIndices.blocksList;if(void 0===c)continue;if(r=(o=n.neoBuildingOwner).getHeaderVersion(),"AutonomousBus_0"===o.buildingId);if("v"===r[0]){if(void 0===c.dataArraybuffer)continue;if(c.fileLoadState!==a.fileLoadState.LOADING_FINISHED)continue;c.parseBlocksList(c.dataArraybuffer,i.readerWriter,o.motherBlocksArray,i)}else if("0.0.1"===r||"0.0.2"===r){if(void 0===c.dataArraybuffer)continue;if(c.fileLoadState!==a.fileLoadState.LOADING_FINISHED)continue;c.parseBlocksListVersioned_v001(c.dataArraybuffer,i.readerWriter,o.motherBlocksArray,i)}c.dataArraybuffer=void 0,l++}if(l>s)break}l>0&&i.selectionFbo&&(i.selectionFbo.dirty=!0)}},Nt.prototype.parseArrayOctreesLod0References=function(t,e,i){if(Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var o,r=this.maxNumParses,n=0,a=e.length,s=0;s<a&&(o=e[s],this.parseOctreesLod0References(t,o,i)&&n++,!(n>r));s++);n>0&&i.selectionFbo&&(i.selectionFbo.dirty=!0)}},Nt.prototype.parseOctreesLod0References=function(t,e,i){var o=!1;if(this.eraseOctreeLod0ReferencesToParse(e)){if(void 0===e.neoReferencesMotherAndIndices)return!1;if(void 0===e.neoReferencesMotherAndIndices.dataArraybuffer)return!1;if(e.neoReferencesMotherAndIndices.fileLoadState!==a.fileLoadState.LOADING_FINISHED)return!1;var r,n=e.neoBuildingOwner,s=n.nodeOwner;if(void 0===(r=s?s.getRoot():void 0))return!1;if(void 0===r.data)return!1;var l=r.data.geoLocDataManager;if(void 0===l)return!1;void 0===this.matrix4SC&&(this.matrix4SC=new B);var d=l.getCurrentGeoLocationData(),h=n.getHeaderVersion();this.matrix4SC.setByFloat32Array(d.rotMatrix._floatArrays),"v"===h[0]?e.neoReferencesMotherAndIndices.parseArrayBufferReferences(t,e.neoReferencesMotherAndIndices.dataArraybuffer,i.readerWriter,n,this.matrix4SC,i):e.neoReferencesMotherAndIndices.parseArrayBufferReferencesVersioned(t,e.neoReferencesMotherAndIndices.dataArraybuffer,i.readerWriter,n,this.matrix4SC,i),e.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(0,d.rotMatrix),e.neoReferencesMotherAndIndices.dataArraybuffer=void 0,o=!0}return o},Nt.prototype.putOctreeLod0ReferencesToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ReferencesToParseMap[t.octreeKey]=t},Nt.prototype.eraseOctreeLod0ReferencesToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ReferencesToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ReferencesToParseMap[e],!0)},Nt.prototype.putOctreeLod0ModelsToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ModelsToParseMap[t.octreeKey]=t},Nt.prototype.eraseOctreeLod0ModelsToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ModelsToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ModelsToParseMap[e],!0)},Nt.prototype.putOctreeLod2LegosToParse=function(t,e){void 0===e&&(e=0),this.octreesLod2LegosToParseMap[t.octreeKey]=t},Nt.prototype.eraseOctreeLod2LegosToParse=function(t){var e=t.octreeKey;return!!this.octreesLod2LegosToParseMap.hasOwnProperty(e)&&(delete this.octreesLod2LegosToParseMap[e],!0)},Nt.prototype.putOctreePCloudToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudToParseMap[t.octreeKey]=t},Nt.prototype.eraseOctreePCloudToParse=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreesPCloudToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudToParseMap[e],!0)},Nt.prototype.putOctreePCloudPartitionToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudPartitionToParseMap[t.legoKey]=t},Nt.prototype.eraseOctreePCloudPartitionToParse=function(t){if(void 0===t)return!1;var e=t.legoKey;return!!this.octreesPCloudPartitionToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudPartitionToParseMap[e],!0)},Nt.prototype.putSkinLegosToParse=function(t,e){void 0===e&&(e=0),this.skinLegosToParseMap[t.legoKey]=t},Nt.prototype.eraseSkinLegosToParse=function(t){var e=t.legoKey;return!!this.skinLegosToParseMap.hasOwnProperty(e)&&(delete this.skinLegosToParseMap[e],!0)},Nt.prototype.clearAll=function(){this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={}},Nt.prototype.eraseAny=function(t){this.eraseOctreeLod0ReferencesToParse(t),this.eraseOctreeLod0ModelsToParse(t),this.eraseOctreeLod2LegosToParse(t)},Nt.prototype.initCounters=function(){this.pCloudPartitionsParsed=0};var Vt=function(){if(!(this instanceof Vt))throw new Error(j.CONSTRUCT_ERROR);this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={},this.nodesToDeleteLessThanLod3Map={},this.nodesToDeleteLessThanLod4Map={},this.nodesToDeleteLessThanLod5Map={},this.nodesToDeleteLodMeshMap={},this.tinTerrainsToDeleteMap={},this.octreeToDeletePCloudsMap={}};Vt.prototype.putOctreeToDeletePCloud=function(t,e){if(void 0===e&&(e=0),void 0!==t){var i=t.octreeKey;this.octreeToDeletePCloudsMap[i]=t}},Vt.prototype.existOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)},Vt.prototype.eraseOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)&&(delete this.octreeToDeletePCloudsMap[e],!0)},Vt.prototype.putNodeToDeleteLodMesh=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLodMeshMap[i]=t}},Vt.prototype.eraseNodeToDeleteLodMesh=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLodMeshMap.hasOwnProperty(e)&&(delete this.nodesToDeleteLodMeshMap[e],!0)}},Vt.prototype.putTinTerrainToDelete=function(t,e){if(void 0===e&&(e=0),void 0!==t){var i=t.pathName;this.tinTerrainsToDeleteMap[i]=t}},Vt.prototype.eraseTinTerrainToDelete=function(t){if(void 0===t)return!1;var e=t.pathName;return!!this.tinTerrainsToDeleteMap.hasOwnProperty(e)&&(delete this.tinTerrainsToDeleteMap[e],!0)},Vt.prototype.putNodeToDeleteLessThanLod3=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod3Map[i]=t}},Vt.prototype.eraseNodeToDeleteLessThanLod3=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod3Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod3Map[e],!0)}},Vt.prototype.putNodeToDeleteLessThanLod4=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod4Map[i]=t}},Vt.prototype.eraseNodeToDeleteLessThanLod4=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod4Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod4Map[e],!0)}},Vt.prototype.putNodeToDeleteLessThanLod5=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod5Map[i]=t}},Vt.prototype.eraseNodeToDeleteLessThanLod5=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod5Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod5Map[e],!0)}},Vt.prototype.putNodeToDeleteModelReferences=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteModelReferencesMap[i]=t}},Vt.prototype.eraseNodeToDeleteModelReferences=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteModelReferencesMap.hasOwnProperty(e)&&(delete this.nodesToDeleteModelReferencesMap[e],!0)}},Vt.prototype.putNodeToDelete=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteMap[i]=t}},Vt.prototype.putNodesArrayToDelete=function(t,e){if(void 0!==t){void 0===e&&(e=0);for(var i=t.length,o=0;o<i;o++)this.putNodeToDelete(t[o],e)}},Vt.prototype.eraseNodeToDelete=function(t){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteMap.hasOwnProperty(e)&&(delete this.nodesToDeleteMap[e],!0)},Vt.prototype.eraseNodesArrayToDelete=function(t){for(var e,i=t.length,o=0;o<i;o++)e=t[o].data.neoBuilding.buildingId,delete this.nodesToDeleteMap[e]},Vt.prototype.clearAll=function(){this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={}},Vt.prototype.deleteNeoBuilding=function(t,e,i){var o=i.vboMemoryManager;e===i.buildingSelected&&(i.buildingSelected=void 0,i.octreeSelected=void 0,i.objectSelected=void 0),e.deleteObjects(t,o)},Vt.prototype.manageDeleteQueue=function(t){var e,i,o=t.sceneState.gl,r=8,n=Object.keys(this.nodesToDeleteMap).length;for(var a in n<r&&(r=n),this.nodesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteMap,a)){if(void 0===(i=this.nodesToDeleteMap[a]))continue;if(e=i.data.neoBuilding,this.eraseNodeToDelete(i),void 0===e)continue;1===a&&!1,this.deleteNeoBuilding(o,e,t)}var s=0;for(var a in this.nodesToDeleteModelReferencesMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteModelReferencesMap,a)){if(void 0===(i=this.nodesToDeleteModelReferencesMap[a]).data)continue;if(e=i.data.neoBuilding,this.eraseNodeToDeleteModelReferences(e),void 0===e)continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(o,t.vboMemoryManager),e.octree.deletePCloudObjects(o,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&s++,e.deleteObjectsModelReferences(o,t.vboMemoryManager),s>10)break}var l=0;for(var a in this.nodesToDeleteLessThanLod3Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod3Map,a)){if(void 0===(i=this.nodesToDeleteLessThanLod3Map[a]).data)continue;if(this.eraseNodeToDeleteLessThanLod3(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(o,t.vboMemoryManager),e.octree.deletePCloudObjects(o,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&s++,e.deleteObjectsModelReferences(o,t.vboMemoryManager),e.deleteObjectsLod2(o,t.vboMemoryManager),++l>10)break}}for(var a in l=0,this.nodesToDeleteLessThanLod4Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod4Map,a)){if(void 0===(i=this.nodesToDeleteLessThanLod4Map[a]).data)continue;if(this.eraseNodeToDeleteLessThanLod4(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(o,t.vboMemoryManager),e.deleteObjectsLod2(o,t.vboMemoryManager),e.deleteObjectsLodMesh(o,t.vboMemoryManager,"lod3"),++l>10)break}}for(var a in l=0,this.nodesToDeleteLessThanLod5Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod5Map,a)){if(void 0===(i=this.nodesToDeleteLessThanLod5Map[a]).data)continue;if(this.eraseNodeToDeleteLessThanLod5(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(o,t.vboMemoryManager),e.deleteObjectsLod2(o,t.vboMemoryManager),e.deleteObjectsLodMesh(o,t.vboMemoryManager,"lod3"),e.deleteObjectsLodMesh(o,t.vboMemoryManager,"lod4"),++l>10)break}}l=0;for(var a in this.tinTerrainsToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.tinTerrainsToDeleteMap,a)){var d=this.tinTerrainsToDeleteMap[a];if(void 0===d)continue;if(this.eraseTinTerrainToDelete(d)&&(d.deleteObjects(t),d=void 0,l++),l>10)break}l=0;for(var a in this.octreeToDeletePCloudsMap)if(Object.prototype.hasOwnProperty.call(this.octreeToDeletePCloudsMap,a)){var h=this.octreeToDeletePCloudsMap[a];if(void 0===h)continue;if(this.eraseOctreeToDeletePCloud(h)&&(h.deletePCloudObjects(o,t.vboMemoryManager),h=void 0,l++),l>1e4)break}};var Bt=function(){if(!(this instanceof Bt))throw new Error(j.CONSTRUCT_ERROR);this.root,this.nodesArray=[]},jt=function(){if(!(this instanceof jt))throw new Error(j.CONSTRUCT_ERROR);var t=l.getPolicy();void 0!==t&&(this.geometryDataPath=t.geo_data_path),this.geometrySubDataPath,this.j_counter,this.k_counter,this.referencesList_requested=0,this.blocksList_requested=0,this.blocksListPartitioned_requested=0,this.octreesSkinLegos_requested=0,this.skinLegos_requested=0,this.pCloudPartitionsMother_requested=0,this.pCloudPartitions_requested=0,this.gl,this.incre_latAng=.001,this.incre_longAng=.001,this.GAIA3D__offset_latitude=-.001,this.GAIA3D__offset_longitude=-.001,this.GAIA3D__counter=0,this.uint32,this.uint16,this.int16,this.float32,this.float16,this.int8,this.int8_value,this.max_color_value=126,this.startBuff,this.endBuff,this.filesReadings_count=0,this.temp_var_to_waste,this.countSC,this.xSC,this.ySC,this.zSC,this.point3dSC=new Ce,this.bboxSC=new u};jt.prototype.getCurrentDataPath=function(){return void 0!==this.geometrySubDataPath&&""!==this.geometrySubDataPath?this.geometryDataPath+"/"+this.geometrySubDataPath:this.geometryDataPath},jt.prototype.readUInt32=function(t,e,i){return new Uint32Array(t.slice(e,i))[0]},jt.prototype.readInt32=function(t,e,i){return new Int32Array(t.slice(e,i))[0]},jt.prototype.readUInt16=function(t,e,i){return new Uint16Array(t.slice(e,i))[0]},jt.prototype.readInt16=function(t,e,i){return new Int16Array(t.slice(e,i))[0]},jt.prototype.readFloat64=function(t,e,i){return new Float64Array(t.slice(e,i))[0]},jt.prototype.readFloat32=function(t,e,i){return new Float32Array(t.slice(e,i))[0]},jt.prototype.readFloat16=function(t,e,i){return new Float32Array(t.slice(e,i))[0]},jt.prototype.readInt8=function(t,e,i){return new Int8Array(t.slice(e,i))[0]},jt.prototype.readUInt8=function(t,e,i){return new Uint8Array(t.slice(e,i))[0]},jt.prototype.readInt8ByteColor=function(t,e,i){var o=new Int8Array(t.slice(e,i))[0];return o>max_color_value&&(o=max_color_value),o<0&&(o+=256),o},jt.prototype.getNeoBlocksArraybuffer=function(t,e,i){i.fileRequestControler.modelRefFilesRequestedCount+=1;var o=e.neoReferencesMotherAndIndices.blocksList;o.fileLoadState=a.fileLoadState.LOADING_STARTED,o.xhr=void 0,this.blocksList_requested++,Ci(t,void 0).then(function(t){var r=t;r?(o.dataArraybuffer=r,o.fileLoadState=a.fileLoadState.LOADING_FINISHED,r=null,i.parseQueue.putOctreeLod0ModelsToParse(e)):o.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),o.fileLoadState=0===t?500:-1===t?a.fileLoadState.READY:t}).finally(function(){i.readerWriter.blocksList_requested--,i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)})},jt.prototype.getNeoBlocksArraybuffer_partition=function(t,e,i,o){o.fileRequestControler.modelRefFilesRequestedCount+=1,i.fileLoadState=a.fileLoadState.LOADING_STARTED,this.blocksListPartitioned_requested++,Ci(t,void 0).then(function(t){var r=t;r?(i.dataArraybuffer=r,i.fileLoadState=a.fileLoadState.LOADING_FINISHED,r=null,o.parseQueue.putOctreeLod0ModelsToParse(e)):i.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),i.fileLoadState=0===t?500:-1===t?a.fileLoadState.READY:t}).finally(function(){o.readerWriter.blocksListPartitioned_requested--,o.fileRequestControler.blocksListPartitioned_requested<0&&(o.fileRequestControler.blocksListPartitioned_requested=0)})},jt.prototype.getNeoReferencesArraybuffer=function(t,e,i){void 0!==e.neoReferencesMotherAndIndices&&(i.fileRequestControler.modelRefFilesRequestedCount+=1,e.neoReferencesMotherAndIndices.fileLoadState=a.fileLoadState.LOADING_STARTED,e.neoReferencesMotherAndIndices.xhr=void 0,this.referencesList_requested++,Ci(t,void 0).then(function(t){var o=t;if(o){var r=e.neoReferencesMotherAndIndices;r&&(r.dataArraybuffer=o,r.fileLoadState=a.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreeLod0ReferencesToParse(e)),o=null}else e.neoReferencesMotherAndIndices.fileLoadState=a.fileLoadState.LOAD_FAILED},function(t){console.log("xhr status = "+t),e.neoReferencesMotherAndIndices.fileLoadState=0===t?a.fileLoadState.LOAD_FAILED:-1===t?a.fileLoadState.READY:t}).finally(function(){i.readerWriter.referencesList_requested--,i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)}))},jt.prototype.getOctreeLegoArraybuffer=function(t,e,i){if(void 0!==e.lego){this.octreesSkinLegos_requested++,i.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=a.fileLoadState.LOADING_STARTED;var o=new XMLHttpRequest;e.lego.xhr=o,Ci(t,o).then(function(t){var o=t;o?(e.lego?(e.lego.dataArrayBuffer=o,e.lego.fileLoadState=a.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreeLod2LegosToParse(e)):e=void 0,o=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){i.readerWriter.octreesSkinLegos_requested--,i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)})}},jt.prototype.getOctreePCloudArraybuffer=function(t,e,i){void 0!==e.lego&&(i.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=a.fileLoadState.LOADING_STARTED,Ci(t).then(function(t){var o=t;o?(e.lego?(e.lego.dataArrayBuffer=o,e.lego.fileLoadState=a.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreePCloudToParse(e)):e=void 0,o=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)}))},jt.prototype.getOctreePCloudPartitionArraybuffer=function(t,e,i,o){i.fileLoadState=a.fileLoadState.LOADING_STARTED;var r=e.octree_level;0===r?o.readerWriter.pCloudPartitionsMother_requested++:o.readerWriter.pCloudPartitions_requested++,Ci(t).then(function(t){var o=t;o?(e&&i&&(i.dataArrayBuffer=o,i.fileLoadState=a.fileLoadState.LOADING_FINISHED),o=null):i.fileLoadState=500},function(t){console.log("xhr status = "+t),i.fileLoadState=0===t?500:t}).finally(function(){0===r?(o.readerWriter.pCloudPartitionsMother_requested--,o.readerWriter.pCloudPartitionsMother_requested<0&&(o.readerWriter.pCloudPartitionsMother_requested=0)):(o.readerWriter.pCloudPartitions_requested--,o.readerWriter.pCloudPartitions_requested<0&&(o.readerWriter.pCloudPartitions_requested=0))})},jt.prototype.getLegoArraybuffer=function(t,e,i){this.skinLegos_requested++,i.fileRequestControler.lowLodDataRequestedCount+=1,e.fileLoadState=a.fileLoadState.LOADING_STARTED,e.xhr=void 0,Ci(t,void 0).then(function(t){var o=t;o?(e&&(e.dataArrayBuffer=o,e.fileLoadState=a.fileLoadState.LOADING_FINISHED,i.parseQueue.putSkinLegosToParse(e)),o=null):e.fileLoadState=500},function(t){console.log("xhr status = "+t),e.fileLoadState=0===t?500:-1}).finally(function(){i.readerWriter.skinLegos_requested--,i.fileRequestControler.lowLodDataRequestedCount-=1,i.fileRequestControler.lowLodDataRequestedCount<0&&(i.fileRequestControler.lowLodDataRequestedCount=0)})},jt.prototype.getObjectIndexFileForSmartTile=function(t,e,i,o){Ci(t).then(function(t){var r=t;r&&(i.dataArrayBuffer=r,i.parseBuildingSeedArrayBuffer(),e.makeSmartTile(i,o),r=null)},function(t){console.log("xhr status = "+t)}).finally(function(){})},jt.prototype.getObjectIndexFile=function(t,e,i,o){Ci(t).then(function(t){var r=t;r&&(e.parseObjectIndexFile(r,i),r=null,o.createDeploymentGeoLocationsForHeavyIndustries())},function(t){console.log("xhr status = "+t)}).finally(function(){})},jt.prototype.parseObjectIndexFile=function(t,e){var i,o,r,n,a=0,s=this.readInt32(t,a,a+4);a+=4;for(var l=0;l<s;l++){var d=e.newNeoBuilding();void 0===d.metaData&&(d.metaData=new Tt),void 0===d.metaData.geographicCoord&&(d.metaData.geographicCoord=new R),void 0===d.metaData.bbox&&(d.metaData.bbox=new u),i=this.readInt32(t,a,a+4),a+=4;var h=String.fromCharCode.apply(null,new Int8Array(t.slice(a,a+i)));a+=i,o=this.readFloat64(t,a,a+8),a+=8,r=this.readFloat64(t,a,a+8),a+=8,n=this.readFloat32(t,a,a+4),a+=4,d.bbox=new u,d.bbox.minX=this.readFloat32(t,a,a+4),a+=4,d.bbox.minY=this.readFloat32(t,a,a+4),a+=4,d.bbox.minZ=this.readFloat32(t,a,a+4),a+=4,d.bbox.maxX=this.readFloat32(t,a,a+4),a+=4,d.bbox.maxY=this.readFloat32(t,a,a+4),a+=4,d.bbox.maxZ=this.readFloat32(t,a,a+4),a+=4,d.buildingId=h.substr(4,i-4),d.buildingType="basicBuilding",d.buildingFileName=h,d.metaData.geographicCoord.setLonLatAlt(o,r,n)}e.neoBuildingsArray.reverse()},jt.prototype.getNeoHeaderAsimetricVersion=function(t,e,i,o,r){r.fileRequestControler.headerFilesRequestedCount+=1,i.metaData.fileLoadState=a.fileLoadState.LOADING_STARTED,Ci(e).then(function(t){var e=t;if(e){void 0===i.metaData&&(i.metaData=new Tt);var r=i.metaData,n=r.parseFileHeaderAsimetricVersion(e,o);if(void 0===i.octree&&(i.octree=new Ft(void 0)),i.octree.neoBuildingOwnerId=i.buildingId,i.octree.octreeKey=i.buildingId+"_"+i.octree.octree_number_name,n=5===r.projectDataType?i.octree.parsePyramidVersion(e,o,n,i):i.octree.parseAsimetricVersion(e,o,n,i),r.oct_min_x=i.octree.centerPos.x-i.octree.half_dx,r.oct_max_x=i.octree.centerPos.x+i.octree.half_dx,r.oct_min_y=i.octree.centerPos.y-i.octree.half_dy,r.oct_max_y=i.octree.centerPos.y+i.octree.half_dy,r.oct_min_z=i.octree.centerPos.z-i.octree.half_dz,r.oct_max_z=i.octree.centerPos.z+i.octree.half_dz,"0.0.1"===r.version||"0.0.2"===r.version){var s,l=o.readInt32(e,n,n+4);n+=4;for(var d=0;d<l;d++){var h,c="",u=o.readUInt32(e,n,n+4);n+=4;for(var f=0;f<u;f++)c+=String.fromCharCode(new Int8Array(e.slice(n,n+1))[0]),n+=1;var g=o.readUInt32(e,n,n+4);n+=4;var p=new Uint8Array(e.slice(n,n+g));if(n+=g,h=new TextDecoder("utf-8").decode(p),g>0){var v=new it;v.textureTypeName=c,v.textureImageFileName=h,void 0===i.texturesLoaded&&(i.texturesLoaded=[]),i.texturesLoaded.push(v)}}var y=new Uint8Array(e.slice(n,n+1))[0];if(n+=1,void 0!==y){i.lodBuildingDatasMap={};for(d=0;d<y;d++){var m=new Pt;if(m.lod=new Uint8Array(e.slice(n,n+1))[0],n+=1,m.isModelRef=new Uint8Array(e.slice(n,n+1))[0],n+=1,2===m.lod){s=new Int8Array(e.slice(n,n+1))[0],n+=1,m.textureFileName="";for(f=0;f<s;f++)m.textureFileName+=String.fromCharCode(new Int8Array(e.slice(n,n+1))[0]),n+=1}if(!m.isModelRef){s=new Int8Array(e.slice(n,n+1))[0],n+=1,m.geometryFileName="";for(f=0;f<s;f++)m.geometryFileName+=String.fromCharCode(new Int8Array(e.slice(n,n+1))[0]),n+=1;s=new Int8Array(e.slice(n,n+1))[0],n+=1,m.textureFileName="";for(f=0;f<s;f++)m.textureFileName+=String.fromCharCode(new Int8Array(e.slice(n,n+1))[0]),n+=1}i.lodBuildingDatasMap[m.lod]=m}}}r.fileLoadState=a.fileLoadState.LOADING_FINISHED,e=void 0}else i.metaData.fileLoadState=500,e=void 0},function(t){console.log("xhr status = "+t),i.metaData.fileLoadState=0===t?500:t}).finally(function(){r.fileRequestControler.headerFilesRequestedCount-=1,r.fileRequestControler.headerFilesRequestedCount<0&&(r.fileRequestControler.headerFilesRequestedCount=0)})},jt.prototype.readTexture=function(t,e,i,o){i.loadStarted=!0,i.texImage=new Image,i.texImage.onload=function(){i.loadFinished=!0,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},i.texImage.onerror=function(){i.loadStarted=!1,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},i.texImage.src=e},jt.prototype.decodeTGA=function(t){var e,i,o,r,n,a=new Uint8Array(t),s=18+a[0],l=a[2],d=a[12]+(a[13]<<8),h=a[14]+(a[15]<<8),c=a[16],u=c/8,f=4*d;if(!d||!h)return console.error("Invalid dimensions"),null;if(2!==l)return console.error("Unsupported TGA format:",l),null;for(e=new Uint8Array(d*h*4),i=s,n=h-1;n>=0;--n)for(r=0;r<d;++r,i+=u)e[o=4*r+n*f]=a[i+2],e[o+1]=a[i+1],e[o+2]=a[i+0],e[o+3]=32===c?a[i+3]:255;return{width:d,height:h,data:e}},jt.prototype.readNeoReferenceTexture=function(t,e,i,o,r){var n=e.split(".").pop();if("tga"===n||"TGA"===n||"Tga"===n)i.fileLoadState=a.fileLoadState.LOADING_STARTED,Ci(e).then(function(e){var o=e;if(o){var r=new TGA;if(r.load(o),r){var n;if(3===r.header.bytePerPixel)n=t.RGB;else if(4===r.header.bytePerPixel){n=t.RGBA;for(var s,l,d,h,c=r.imageData.length/4,u=0;u<c;u++)s=r.imageData[4*u],l=r.imageData[4*u+1],d=r.imageData[4*u+2],h=r.imageData[4*u+3],r.imageData[4*u]=d,r.imageData[4*u+1]=l,r.imageData[4*u+2]=s,r.imageData[4*u+3]=h}void 0!==r.imageData&&r.imageData.length>0&&void 0!==i.texId&&(t.bindTexture(t.TEXTURE_2D,i.texId),t.texImage2D(t.TEXTURE_2D,0,n,r.header.width,r.header.height,0,n,t.UNSIGNED_BYTE,r.imageData),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),i.fileLoadState=a.fileLoadState.LOADING_FINISHED,t.bindTexture(t.TEXTURE_2D,null))}}},function(t){o&&(console.log("xhr status = "+t),o.metaData.fileLoadState=0===t?500:t)}).finally(function(){r.backGround_fileReadings_count-=1,r.backGround_fileReadings_count<0&&(r.backGround_fileReadings_count=0)});else{var s=new Image;i.fileLoadState=a.fileLoadState.LOADING_STARTED,s.onload=function(){void 0!==i.texId&&(rt(t,s,i.texId),i.fileLoadState=a.fileLoadState.LOADING_FINISHED,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1))},s.onerror=function(){},s.src=e}},jt.loadBinaryData=function(t,e,i){e.fileLoadState=a.fileLoadState.LOADING_STARTED,Ci(t).then(function(t){var o=t;o?(e.dataArraybuffer=o,e.fileLoadState=a.fileLoadState.LOADING_FINISHED,o=null,i.parseData(e)):e.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),e.fileLoadState=0===t?500:t}).finally(function(){})},jt.loadImage=function(t,e,i){var o=new Image;i.fileLoadState=a.fileLoadState.LOADING_STARTED,o.onload=function(){var e,r,n,s,l,d;void 0!==i.texId&&(i.texId=(e=t,r=t.LINEAR,n=o,d=e.createTexture(),e.bindTexture(e.TEXTURE_2D,d),e.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),n instanceof Uint8Array?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s,l,0,e.RGBA,e.UNSIGNED_BYTE,n):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),d),i.fileLoadState=a.fileLoadState.LOADING_FINISHED)},o.onerror=function(){},o.src=e},jt.prototype.readLegoSimpleBuildingTexture=function(t,e,i,o,r){var n=new Image;i.fileLoadState=a.fileLoadState.LOADING_STARTED,o.fileRequestControler.lowLodImagesRequestedCount+=1,n.onload=function(){void 0===i.texId&&(i.texId=t.createTexture()),void 0===r&&(r=!0),rt(t,n,i.texId,r),i.fileLoadState=a.fileLoadState.LOADING_FINISHED,o.fileRequestControler.lowLodImagesRequestedCount-=1,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1),o.fileRequestControler.lowLodImagesRequestedCount<0&&(o.fileRequestControler.lowLodImagesRequestedCount=0)},n.onerror=function(){void 0===i.texId&&(i.texId=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i.texId),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),t.bindTexture(t.TEXTURE_2D,null)),i.fileLoadState=a.fileLoadState.READY,o.fileRequestControler.lowLodImagesRequestedCount-=1,o.fileRequestControler.lowLodImagesRequestedCount<0&&(o.fileRequestControler.lowLodImagesRequestedCount=0)},n.src=e},jt.prototype.getTileArrayBuffer=function(t,e,i,o,r){i.fileReading_started=!0,Ci(e).then(function(t){var e=t;e&&(i.fileArrayBuffer=e,i.fileReading_finished=!0,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1),e=null)},function(t){console.log("xhr status = "+t)}).finally(function(){})},jt.prototype.loadTINTerrain=function(t,e,i){e.fileLoadState=a.fileLoadState.LOADING_STARTED,Ci(t).then(function(t){var i=t;i?(e.dataArrayBuffer=i,e.fileLoadState=a.fileLoadState.LOADING_FINISHED,i=void 0):e.fileLoadState=500},function(t){e.fileLoadState=a.fileLoadState.LOAD_FAILED}).finally(function(){})},jt.prototype.imageFromArrayBuffer=function(t,e,i,o,r){var n=new Blob([e],{type:"image/png"}),s=(window.URL||window.webkitURL).createObjectURL(n),l=new Image;l.onload=function(){void 0===r&&(r=!1),void 0===i.texId&&(i.texId=t.createTexture()),rt(t,l,i.texId,r),i.fileLoadState=a.fileLoadState.LOADING_FINISHED,e=null},l.onerror=function(){},l.src=s},jt.prototype.loadWMSImage=function(t,e,i,o,r){i.fileLoadState=a.fileLoadState.LOADING_STARTED;var n=this;Ci(e).then(function(e){var s=e;s&&(void 0===r&&(r=!1),n.imageFromArrayBuffer(t,s,i,o,r),i.fileLoadState=a.fileLoadState.LOADING_FINISHED)},function(t){console.log(t)}).finally(function(){o.backGround_fileReadings_count-=1,o.backGround_fileReadings_count<0&&(o.backGround_fileReadings_count=0)})},jt.prototype.handleTextureLoaded=function(t,e,i,o){void 0===o&&(o=!0),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)};var Ut=function(t){if(!(this instanceof Ut))throw new Error(j.CONSTRUCT_ERROR);this.owner,this.depth,t?(this.owner=t,this.depth=t.depth+1):this.depth=0,this.childArray,this.childMap,this.X,this.Y,this.centerX,this.centerY,this.centerZ,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.geographicExtent,this.sphereExtent,this.webMercatorExtent,this.fileLoadState=0,this.dataArrayBuffer,this.vboKeyContainer,this.terrainPositionHIGH,this.terrainPositionLOW,this.indexName,this.pathName,this.texture,this.visible,this.tinTerrainManager,this.imageryGeoExtent,this.isAdult=!1,this.birthTime,this.renderingFase=!1};Ut.prototype.deleteObjects=function(t){var e=t.sceneState.gl;if(void 0!==this.childMap){var i=this.childMap.LU;void 0!==i&&(i.deleteObjects(t),delete this.childMap.LU);var o=this.childMap.LD;void 0!==o&&(o.deleteObjects(t),delete this.childMap.LD);var r=this.childMap.RU;void 0!==r&&(r.deleteObjects(t),delete this.childMap.RU);var n=this.childMap.RD;void 0!==n&&(n.deleteObjects(t),delete this.childMap.RD),this.childMap=void 0}this.depth<2||(this.owner=void 0,this.depth=void 0,this.childArray=void 0,this.childMap=void 0,this.X=void 0,this.Y=void 0,void 0!==this.geographicExtent&&(this.geographicExtent.deleteObjects(),this.geographicExtent=void 0),void 0!==this.sphereExtent&&(this.sphereExtent.deleteObjects(),this.sphereExtent=void 0),this.fileLoadState=0,this.dataArrayBuffer=void 0,void 0!==this.vboKeyContainer&&(this.vboKeyContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeyContainer=void 0),this.terrainPositionHIGH=void 0,this.terrainPositionLOW=void 0,this.indexName=void 0,this.pathName=void 0,void 0!==this.texture&&(this.texture.deleteObjects(e),this.texture=void 0),this.visible=void 0)},Ut.prototype.getPathName=function(){return this.depth.toString()+"\\"+this.X.toString()+"\\"+this.Y.toString()},Ut.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=.1);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.blendAlpha=1,this.isAdult=!0),this.blendAlpha},Ut.prototype.setWebMercatorExtent=function(t,e,i,o){void 0===this.webMercatorExtent&&(this.webMercatorExtent=new Se),this.webMercatorExtent.setExtension(t,e,i,o)},Ut.prototype.setGeographicExtent=function(t,e,i,o,r,n){void 0===this.geographicExtent&&(this.geographicExtent=new I);var a=this.geographicExtent;void 0===a.minGeographicCoord&&(a.minGeographicCoord=new R),void 0===a.maxGeographicCoord&&(a.maxGeographicCoord=new R),a.minGeographicCoord.setLonLatAlt(t,e,i),a.maxGeographicCoord.setLonLatAlt(o,r,n)},Ut.prototype.isPrepared=function(){return this.fileLoadState===a.fileLoadState.LOAD_FAILED||this.fileLoadState===a.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&this.texture.fileLoadState===a.fileLoadState.LOADING_FINISHED&&(void 0!==this.vboKeyContainer&&void 0!==this.vboKeyContainer.vboCacheKeysArray&&0!==this.vboKeyContainer.vboCacheKeysArray.length))},Ut.prototype.prepareTexture=function(t,e){var i=t.sceneState.gl;this.texture=new it;e.geoServURL;var o,r=this.depth.toString(),n=(this.X.toString(),this.Y.toString());Math.floor(this.X/2).toString();(o=Math.floor(this.X/2))<0&&(o=0);var a="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/"+r+"/"+n+"/"+o+".png";this.texFilePath__TEST=a;t.readerWriter.loadWMSImage(i,a,this.texture,t,!1)},Ut.prototype.prepareTinTerrainPlain=function(t,e){return void 0===this.owner||this.owner.isPrepared()?(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState=a.fileLoadState.PARSE_FINISHED,void(this.fileLoadState===a.fileLoadState.READY||this.fileLoadState===a.fileLoadState.LOADING_FINISHED||(this.fileLoadState===a.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.calculateCenterPosition(),this.makeMeshVirtually(20,20,void 0,void 0),this.makeVbo(t.vboMemoryManager)):void 0===this.texture&&this.prepareTexture(t,e)))):void this.owner.prepareTinTerrainPlain(t,e)},Ut.prototype.prepareTinTerrain=function(t,e){if(void 0===this.owner||this.owner.isPrepared())if(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===a.fileLoadState.READY){var i="CesiumTerrain/"+this.getPathName()+".terrain";t.readerWriter.loadTINTerrain(i,this,t)}else this.fileLoadState===a.fileLoadState.LOADING_FINISHED?t.parseQueue.putTinTerrainToParse(this,0):this.fileLoadState===a.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.decodeData(),this.makeVbo(t.vboMemoryManager)):void 0===this.texture&&this.prepareTexture(t,e);else this.owner.prepareTinTerrain(t,e)},Ut.prototype.hasChildren=function(){return void 0!==this.childMap&&this.childMap.length>0},Ut.prototype.deleteTinTerrain=function(t){if(this.hasChildren()){for(var e in this.childMap){if(Object.prototype.hasOwnProperty.call(this.childMap,e))this.childMap[e].deleteTinTerrain(t)}return!1}return t.parseQueue.eraseTinTerrainToParse(this),t.processQueue.putTinTerrainToDelete(this,0),delete this.owner.childMap[this.indexName],0===this.owner.childMap.length&&(this.owner.childMap=void 0),!0},Ut.prototype.renderBorder=function(t,e){},Ut.prototype.render=function(t,e,i,o){if(void 0===this.owner||this.owner.isPrepared())if(this.isPrepared()){if(this.fileLoadState===a.fileLoadState.LOAD_FAILED)return;if(void 0===this.texture.texId)return;var r=e.getGl();if(2===o){var n;n=e.selectionColor.getAvailableColor(n);var s=e.selectionColor.decodeColor3(n.r,n.g,n.b);e.selectionManager.setCandidateGeneral(s,this),r.uniform1i(t.colorType_loc,0),r.uniform4fv(t.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1])}if(1===o)r.uniform1i(t.colorType_loc,2),r.uniform1f(t.externalAlpha_loc,this.getBlendAlpha(e.getCurrentTime())),e.selectionManager.getSelectedGeneral()===this&&(r.uniform1i(t.colorType_loc,0),r.uniform4fv(t.oneColor4_loc,[.8,.3,.1,1]));this.isAdult||void 0!==this.owner&&this.owner.render(t,e,i);r.bindTexture(r.TEXTURE_2D,this.texture.texId),r.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),r.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW);var l=this.vboKeyContainer.vboCacheKeysArray[0];if(!l.bindDataPosition(t,e.vboMemoryManager))return!1;if(!i&&!l.bindDataTexCoord(t,e.vboMemoryManager))return!1;if(!l.bindDataIndice(t,e.vboMemoryManager))return!1;var d=l.indicesCount;if(r.drawElements(r.TRIANGLES,d,r.UNSIGNED_SHORT,0),1===o)r.uniform1i(t.colorType_loc,2),e.selectionManager.getSelectedGeneral()===this&&(r.uniform1i(t.colorType_loc,0),r.uniform4fv(t.oneColor4_loc,[0,.9,.9,1]),r.drawElements(r.LINE_LOOP,d,r.UNSIGNED_SHORT,0))}else void 0!==this.owner&&this.owner.render(t,e,i);else this.owner.render(t,e,i)},Ut.prototype.getFrustumIntersectedTinTerrainsQuadTree=function(t,e,i,o,r,n){if(void 0!==this.geographicExtent&&void 0!==this.geographicExtent.minGeographicCoord&&void 0!==this.geographicExtent.maxGeographicCoord){var l=this.geographicExtent.minGeographicCoord,d=this.geographicExtent.maxGeographicCoord;void 0===this.sphereExtent&&(this.sphereExtent=Z.computeSphereExtent(o,l,d,this.sphereExtent));var h=this.sphereExtent,c=t.intersectionSphere(h);if(c===s.INTERSECTION_OUTSIDE)return this.visible=!1,void n.push(this);if(c===s.INTERSECTION_INTERSECT||c===s.INTERSECTION_INSIDE){var u=this.depth,f=i.distToSphere(h),g=1e4;if(0===u?g=5e7:1===u?g=1e7:2===u?g=5e6:3===u?g=2e6:4===u?g=1e6:5===u?g=5e5:6===u?g=1e5:7===u?g=5e4:8===u?g=2e4:9===u?g=9e3:10===u?g=5e3:11===u?g=4e3:12===u?g=3e3:13===u?g=2e3:14===u?g=1e3:15===u?g=900:16===u?g=800:17===u&&(g=700),f>g)return this.visible=!0,void r.push(this);if(!(u<e))return this.visible=!0,void r.push(this);var p=this.X,v=this.Y,y=l.longitude,m=l.latitude,x=l.altitude,b=d.longitude,C=d.latitude,A=d.altitude,M=(y+b)/2,P=(m+C)/2;this.tinTerrainManager.imageryType===a.imageryType.WEB_MERCATOR&&(P=180*this.getMidLatitudeRadWebMercator()/Math.PI);var T=this.imageryGeoExtent.minGeographicCoord.longitude,_=this.imageryGeoExtent.minGeographicCoord.latitude,w=this.imageryGeoExtent.maxGeographicCoord.longitude,S=this.imageryGeoExtent.maxGeographicCoord.latitude,R=(T+w)/2,L=(_+S)/2,D=this.webMercatorExtent.minX,E=this.webMercatorExtent.minY,O=this.webMercatorExtent.maxX,F=this.webMercatorExtent.maxY,N=(O+D)/2,V=(F+E)/2;void 0===this.childMap&&(this.childMap={});var B=this.childMap.LU;void 0===B&&((B=new Ut(this)).X=2*p,B.Y=2*v,B.setGeographicExtent(y,P,x,M,C,A),B.indexName="LU",B.tinTerrainManager=this.tinTerrainManager,this.childMap.LU=B,void 0===B.imageryGeoExtent&&(B.imageryGeoExtent=new I),B.imageryGeoExtent.setExtent(T,L,0,R,S,0),B.setWebMercatorExtent(D,V,N,F));var j=this.childMap.LD;void 0===j&&((j=new Ut(this)).X=2*p,j.Y=2*v+1,j.setGeographicExtent(y,m,x,M,P,A),j.indexName="LD",j.tinTerrainManager=this.tinTerrainManager,this.childMap.LD=j,void 0===j.imageryGeoExtent&&(j.imageryGeoExtent=new I),j.imageryGeoExtent.setExtent(T,_,0,R,L,0),j.setWebMercatorExtent(D,E,N,V));var U=this.childMap.RU;void 0===U&&((U=new Ut(this)).X=2*p+1,U.Y=2*v,U.setGeographicExtent(M,P,x,b,C,A),U.indexName="RU",U.tinTerrainManager=this.tinTerrainManager,this.childMap.RU=U,void 0===U.imageryGeoExtent&&(U.imageryGeoExtent=new I),U.imageryGeoExtent.setExtent(R,L,0,w,S,0),U.setWebMercatorExtent(N,V,O,F));var G=this.childMap.RD;void 0===G&&((G=new Ut(this)).X=2*p+1,G.Y=2*v+1,G.setGeographicExtent(M,m,x,b,P,A),G.indexName="RD",G.tinTerrainManager=this.tinTerrainManager,this.childMap.RD=G,void 0===G.imageryGeoExtent&&(G.imageryGeoExtent=new I),G.imageryGeoExtent.setExtent(R,_,0,w,L,0),G.setWebMercatorExtent(N,E,O,V)),B.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,o,r,n),j.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,o,r,n),U.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,o,r,n),G.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,o,r,n)}}},Ut.prototype.calculateCenterPosition=function(){var t,e,i=(t=this.geographicExtent.getMidPoint(t)).longitude,o=t.latitude;e=F.geographicToCartesianWgs84(i,o,0,e),this.centerX=new Float64Array([e[0]]),this.centerY=new Float64Array([e[1]]),this.centerZ=new Float64Array([e[2]])},Ut.prototype.calculateTextureCoordinateTranslationAndScale_original=function(){var t,e,i,o;t=this.geographicExtent.minGeographicCoord.getMercatorProjection(t),e=this.geographicExtent.maxGeographicCoord.getMercatorProjection(e),i=new me(this.imageryGeoExtent.minGeographicCoord.longitude,this.imageryGeoExtent.minGeographicCoord.latitude),o=new me(this.imageryGeoExtent.maxGeographicCoord.longitude,this.imageryGeoExtent.maxGeographicCoord.latitude);var r=e.x-t.x,n=e.y-t.y,a=r/(o.x-i.x),s=n/(o.y-i.y),l=a*(t.x-i.x)/r,d=s*(t.y-i.y)/n;this.X%2!=0&&(l-=.5),this.textureTranslateAndScale=new Ae(l,d,a,s)},Ut.prototype.calculateTextureCoordinateTranslationAndScale=function(){var t,e;t=this.geographicExtent.minGeographicCoord.getMercatorProjection(t),e=this.geographicExtent.maxGeographicCoord.getMercatorProjection(e);var i,o;F.equatorialRadius();i=new me(this.imageryGeoExtent.minGeographicCoord.longitude,this.imageryGeoExtent.minGeographicCoord.latitude),o=new me(this.imageryGeoExtent.maxGeographicCoord.longitude,this.imageryGeoExtent.maxGeographicCoord.latitude);var r=e.x-t.x,n=e.y-t.y,a=r/(o.x-i.x),s=n/(o.y-i.y),l=a*(t.x-i.x)/r,d=s*(t.y-i.y)/n;this.X%2!=0&&(l-=.5),this.textureTranslateAndScale=new Ae(l,d,a,s)},Ut.prototype.getMidLatitudeRadWebMercator=function(){if(void 0!==this.webMercatorExtent){var t=(this.webMercatorExtent.maxY+this.webMercatorExtent.minY)/2,e=2*Math.atan(Math.pow(Math.E,t))-Math.PI/2;if(isNaN(e));return e}},Ut.prototype.makeMeshVirtually=function(t,e,i,o){var r=Math.PI/180,n=this.geographicExtent.minGeographicCoord.longitude*r,a=this.geographicExtent.minGeographicCoord.latitude*r,s=this.geographicExtent.maxGeographicCoord.longitude*r,l=this.geographicExtent.maxGeographicCoord.latitude*r,d=s-n,h=l-a,c=this.depth,u=d/t,f=h/e,g=(t+1)*(e+1),p=new Float32Array(g),v=new Float32Array(g),y=new Float32Array(g);this.texCoordsArray=new Float32Array(2*g);var m,x,b=n,C=a,A=0,M=Math.PI,P=1/(2*M)*Math.pow(2,c),T=0;i&&(T=i);var _=M/4,w=P*(M-Math.log(Math.tan(_+a/2))),S=P*(M-Math.log(Math.tan(_+l/2))),R=P*(n+M),L=Math.floor(R);w=1-w,S=1-S;for(var D=.003+1e-7*c,I=0;I<e+1;I++){(C=a+f*I)>l&&(C=l);x=1-(x=P*(M-Math.log(Math.tan(_+C/2)))),x-=w,0===I?x=D:I===e&&(x=1-D);for(var E=0;E<t+1;E++)(b=n+u*E)>s&&(b=s),p[A]=b,v[A]=C,y[A]=o?o.getValue(E,I):T,m=P*(b+M),m-=L,0===E?m+=D/2:E===t&&(m+=-D/2),this.texCoordsArray[2*A]=m,this.texCoordsArray[2*A+1]=x,A++}this.cartesiansArray=F.geographicRadianArrayToFloat32ArrayWgs84(p,v,y,this.cartesiansArray),this.normalsArray=new Int8Array(3*g);for(var O=new Ce,N=0;N<g;N++)O.set(this.cartesiansArray[3*N],this.cartesiansArray[3*N+1],this.cartesiansArray[3*N+2]),O.unitary(),this.normalsArray[3*N]=255*O.x,this.normalsArray[3*N+1]=255*O.y,this.normalsArray[3*N+2]=255*O.z;var V=t+1,B=e+1;this.indices=bi.getIndicesTrianglesRegularNet(V,B,void 0),this.calculateCenterPosition()},Ut.prototype.zigZagDecode=function(t){return t>>1^-(1&t)},Ut.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){for(var e=this.cartesiansArray.length/3,i=0;i<e;i++)this.cartesiansArray[3*i]-=this.centerX,this.cartesiansArray[3*i+1]-=this.centerY,this.cartesiansArray[3*i+2]-=this.centerZ;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),Ai.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),void 0===this.vboKeyContainer&&(this.vboKeyContainer=new ft);var o=this.vboKeyContainer.newVBOVertexIdxCacheKey();o.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&o.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&o.setDataArrayTexCoord(this.texCoordsArray,t),o.setDataArrayIdx(this.indices,t)}},Ut.prototype.decodeData=function(){if(void 0!==this.geographicExtent){void 0===this.vertexArray&&(this.vertexArray=[]);var t=Math.PI/180,e=this.geographicExtent.minGeographicCoord.longitude*t,i=this.geographicExtent.minGeographicCoord.latitude*t,o=this.geographicExtent.maxGeographicCoord.longitude*t-e,r=this.geographicExtent.maxGeographicCoord.latitude*t-i,n=this.minHeight[0],a=this.maxHeight[0]-n,s=this.vertexCount[0];this.texCoordsArray=new Float32Array(2*s);for(var l=new Float32Array(s),d=new Float32Array(s),h=new Float32Array(s),c=o/32767,u=r/32767,f=a/32767,g=this.uValues,p=this.vValues,v=this.hValues,y=0;y<s;y++)l[y]=e+g[y]*c,d[y]=i+p[y]*u,h[y]=n+v[y]*f,this.texCoordsArray[2*y]=g[y]/32767,this.texCoordsArray[2*y+1]=p[y]/32767;this.cartesiansArray=F.geographicRadianArrayToFloat32ArrayWgs84(l,d,h,this.cartesiansArray),this.uValues=void 0,this.vValues=void 0,this.hValues=void 0,l=void 0,d=void 0,h=void 0}},Ut.prototype.parseData=function(t){this.fileLoadState=a.fileLoadState.PARSE_STARTED;var e=0;this.centerX=new Float64Array(t.slice(e,e+8)),e+=8,this.centerY=new Float64Array(t.slice(e,e+8)),e+=8,this.centerZ=new Float64Array(t.slice(e,e+8)),e+=8,this.minHeight=new Float32Array(t.slice(e,e+4)),e+=4,this.maxHeight=new Float32Array(t.slice(e,e+4)),e+=4,this.boundingSphereCenterX=new Float64Array(t.slice(e,e+8)),e+=8,this.boundingSphereCenterY=new Float64Array(t.slice(e,e+8)),e+=8,this.boundingSphereCenterZ=new Float64Array(t.slice(e,e+8)),e+=8,this.boundingSphereRadius=new Float64Array(t.slice(e,e+8)),e+=8,this.horizonOcclusionPointX=new Float64Array(t.slice(e,e+8)),e+=8,this.horizonOcclusionPointY=new Float64Array(t.slice(e,e+8)),e+=8,this.horizonOcclusionPointZ=new Float64Array(t.slice(e,e+8)),e+=8,this.vertexCount=new Uint32Array(t.slice(e,e+4)),e+=4;var i=this.vertexCount[0];this.uValues=new Uint16Array(t.slice(e,e+2*i)),e+=2*i,this.vValues=new Uint16Array(t.slice(e,e+2*i)),e+=2*i,this.hValues=new Uint16Array(t.slice(e,e+2*i)),e+=2*i;for(var o=0,r=0,n=0,s=0;s<i;s++)o+=this.zigZagDecode(this.uValues[s]),r+=this.zigZagDecode(this.vValues[s]),n+=this.zigZagDecode(this.hValues[s]),this.uValues[s]=o,this.vValues[s]=r,this.hValues[s]=n;this.trianglesCount=new Uint32Array(t.slice(e,e+4)),e+=4;var l,d=this.trianglesCount;i>65536?(this.indices=new Uint32Array(t.slice(e,e+4*d*3)),e+=4*d*3):(this.indices=new Uint16Array(t.slice(e,e+2*d*3)),e+=2*d*3);var h=0,c=this.indices.length;for(s=0;s<c;s++)l=this.indices[s],this.indices[s]=h-l,0===l&&++h;i>65536?(this.westVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.westIndices=new Uint32Array(t.slice(e,e+4*this.westVertexCount)),e+=4*this.westVertexCount,this.southVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.southIndices=new Uint32Array(t.slice(e,e+4*this.southVertexCount)),e+=4*this.southVertexCount,this.eastVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.eastIndices=new Uint32Array(t.slice(e,e+4*this.eastVertexCount)),e+=4*this.eastVertexCount,this.northVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.northIndices=new Uint32Array(t.slice(e,e+4*this.northVertexCount)),e+=4*this.northVertexCount):(this.westVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.westIndices=new Uint16Array(t.slice(e,e+2*this.westVertexCount)),e+=2*this.westVertexCount,this.southVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.southIndices=new Uint16Array(t.slice(e,e+2*this.southVertexCount)),e+=2*this.southVertexCount,this.eastVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.eastIndices=new Uint16Array(t.slice(e,e+2*this.eastVertexCount)),e+=2*this.eastVertexCount,this.northVertexCount=new Uint32Array(t.slice(e,e+4)),e+=4,this.northIndices=new Uint16Array(t.slice(e,e+2*this.northVertexCount)),e+=2*this.northVertexCount),this.extensionId=new Uint8Array(t.slice(e,e+1)),e+=1,this.extensionLength=new Uint32Array(t.slice(e,e+4)),e+=4,this.fileLoadState=a.fileLoadState.PARSE_FINISHED,t=void this.extensionId.length};var Gt=function(){if(!(this instanceof Gt))throw new Error(j.CONSTRUCT_ERROR);this.maxDepth=17,this.currentVisibles_terrName_geoCoords_map={},this.currentTerrainsMap={},this.visibleTilesArray=[],this.noVisibleTilesArray=[],this.tinTerrainsQuadTreeAsia,this.tinTerrainsQuadTreeAmerica,this.geoServURL="http://192.168.10.57:9090/geoserver/gwc/service/wmts",this.terrainType=0,this.imageryType=a.imageryType.WEB_MERCATOR,this.init()};Gt.prototype.init=function(){this.tinTerrainsQuadTreeAsia=new Ut(void 0),this.tinTerrainsQuadTreeAmerica=new Ut(void 0);var t=2*Math.atan(Math.pow(Math.E,Math.PI))-Math.PI/2,e=180*t/Math.PI,i=0,o=-90,r=0,n=180,s=90,l=0;this.imageryType===a.imageryType.WEB_MERCATOR&&(o=-e,s=e),this.tinTerrainsQuadTreeAsia.setGeographicExtent(i,o,r,n,s,l),this.tinTerrainsQuadTreeAsia.setWebMercatorExtent(0,-Math.PI,1,Math.PI),this.tinTerrainsQuadTreeAsia.X=1,this.tinTerrainsQuadTreeAsia.Y=0,this.tinTerrainsQuadTreeAsia.indexName="RU",this.tinTerrainsQuadTreeAsia.tinTerrainManager=this,i=-180,o=-90,r=0,n=0,s=90,l=0,this.imageryType===a.imageryType.WEB_MERCATOR&&(o=-e,s=e),this.tinTerrainsQuadTreeAmerica.setGeographicExtent(i,o,r,n,s,l),this.tinTerrainsQuadTreeAmerica.setWebMercatorExtent(-1,-Math.PI,0,Math.PI),this.tinTerrainsQuadTreeAmerica.X=0,this.tinTerrainsQuadTreeAmerica.Y=0,this.tinTerrainsQuadTreeAmerica.indexName="LU",this.tinTerrainsQuadTreeAmerica.tinTerrainManager=this;this.tinTerrainsQuadTreeAsia.imageryGeoExtent=new I,this.tinTerrainsQuadTreeAsia.imageryGeoExtent.setExtent(-20037507.22959434,-19971868.88040859,0,20037507.22959434,19971868.880408563,0),this.tinTerrainsQuadTreeAmerica.imageryGeoExtent=new I,this.tinTerrainsQuadTreeAmerica.imageryGeoExtent.setExtent(-20037507.22959434,-19971868.88040859,0,20037507.22959434,19971868.880408563,0);var d=Math.PI,h=-t;Math.log(Math.tan(d/4+h/2));h=-45*d/180;Math.log(Math.tan(d/4+h/2));h=0;Math.log(Math.tan(d/4+h/2));h=45*d/180;Math.log(Math.tan(d/4+h/2));h=t;Math.log(Math.tan(d/4+h/2));var c=0,u=1/(2*d)*Math.pow(2,c);h=-t;Math.log(Math.tan(d/4+h/2));h=-45*d/180;Math.log(Math.tan(d/4+h/2));h=0;Math.log(Math.tan(d/4+h/2));h=45*d/180;Math.log(Math.tan(d/4+h/2));h=t;Math.log(Math.tan(d/4+h/2));c=1,h=-t;u=1/(2*d)*Math.pow(2,c),Math.log(Math.tan(d/4+h/2));h=-45*d/180;Math.log(Math.tan(d/4+h/2));h=0;Math.log(Math.tan(d/4+h/2));h=45*d/180;Math.log(Math.tan(d/4+h/2));h=t;Math.log(Math.tan(d/4+h/2));c=2,h=-t;u=1/(2*d)*Math.pow(2,c),Math.log(Math.tan(d/4+h/2));h=-45*d/180;Math.log(Math.tan(d/4+h/2));h=0;Math.log(Math.tan(d/4+h/2));h=45*d/180;Math.log(Math.tan(d/4+h/2));h=t;Math.log(Math.tan(d/4+h/2))},Gt.prototype.doFrustumCulling=function(t,e,i,o){void 0===o&&(o=this.maxDepth),this.visibleTilesArray.length=0,this.noVisibleTilesArray.length=0,this.tinTerrainsQuadTreeAsia.getFrustumIntersectedTinTerrainsQuadTree(t,o,e,i,this.visibleTilesArray,this.noVisibleTilesArray),this.tinTerrainsQuadTreeAmerica.getFrustumIntersectedTinTerrainsQuadTree(t,o,e,i,this.visibleTilesArray,this.noVisibleTilesArray)},Gt.prototype.prepareVisibleTinTerrains=function(t){var e,i=this.visibleTilesArray.length;if(0===this.terrainType)for(var o=0;o<i;o++)(e=this.visibleTilesArray[o]).prepareTinTerrainPlain(t,this);else if(1===this.terrainType)for(o=0;o<i;o++)(e=this.visibleTilesArray[o]).prepareTinTerrain(t,this);var r=0;for(this.noVisibleTilesArray.length,o=0;o<i&&(void 0!==(e=this.noVisibleTilesArray[o])&&e.depth>2&&(e.deleteTinTerrain(t),r++),!(r>5));o++);},Gt.prototype.render=function(t,e,i){var o=t.sceneState.gl,r=t.postFxShadersManager.getShader("tinTerrain"),n=r.program;o.useProgram(n),o.enableVertexAttribArray(r.position3_loc),e?o.disableVertexAttribArray(r.texCoord2_loc):o.enableVertexAttribArray(r.texCoord2_loc),r.bindUniformGenerals();var a=t.texturesManager.getTextureAux1x1();o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,a.texId),o.uniform1i(r.bIsMakingDepth_loc,e),o.uniform1i(r.colorType_loc,2),o.uniform4fv(r.oneColor4_loc,[.5,.5,.5,1]);var l=!0;t.configInformation.geo_view_library===s.CESIUM&&(l=!1),o.uniform1i(r.textureFlipYAxis_loc,l),o.uniform1f(r.externalAlpha_loc,1);for(var d,h=this.visibleTilesArray.length,c=0;c<h;c++)void 0!==(d=this.visibleTilesArray[c])&&d.render(r,t,e,i);r.disableVertexAttribArray(r.texCoord2_loc),r.disableVertexAttribArray(r.position3_loc),r.disableVertexAttribArray(r.normal3_loc),r.disableVertexAttribArray(r.color4_loc),o.useProgram(null)};var kt=function(t,e){this.handle=t,this.message=e||zt};kt.prototype.init=function(t){var e=this.handle;this.handle.use(i18nextXHRBackend).use(i18nextBrowserLanguageDetector).init({debug:!1,detection:{lookupQuerystring:"lang",lookupCookie:"i18nextLang",lookupLocalStorage:"i18nextLang"},fallbackLng:"en",resources:this.message,load:"languageOnly",ns:["common"],defaultNS:"common",keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_"},function(i,o){console.log("detected user language: "+e.language),console.log("loaded languages: "+e.languages.join(", ")),e.changeLanguage(e.languages[0]),t(i,o)})},kt.prototype.getHandle=function(){return this.handle},kt.prototype.getMessage=function(){return this.message};var zt={en:{common:{welcome:"Welcome",error:{title:"Error",construct:{create:"This object should be created using new."}}}},ko:{common:{welcome:".",error:{title:"",construct:{create:"  new    ."}}}}},Ht=function(t,e,i,o){if(!(this instanceof Ht))throw new Error(j.CONSTRUCT_ERROR);this.name,this.width=t,this.length=e,this.height=i,this.bHasGround=!1,this.roofMinHeight,this.frontDoorWidth,this.frontDoorHeight,this.geoLocDataManager,this.objectsArray,this.bbox,this.dirty=!0,o&&(o.hasGround&&(this.bHasGround=o.hasGround),o.roofMinHeight&&(this.roofMinHeight=o.roofMinHeight),o.frontDoorWidth&&(this.frontDoorWidth=o.frontDoorWidth),o.frontDoorHeight&&(this.frontDoorHeight=o.frontDoorHeight)),this.bbox=new u,this.bbox.set(-this.width/2,-this.length/2,0,this.width/2,this.length/2,this.height)};Ht.prototype.getBoundingBox=function(){return this.bbox},Ht.getFactoryDimensionsByGeoCoordsArray=function(t,e,i){if(!(void 0===t||t.length<4)){var o=t[0],r=t[1],n=t[2],a=t[3];if(0===e)var s=new L(o,r),l=new L(r,n);else if(1===e)s=new L(r,n),l=new L(n,a);else if(2===e)s=new L(n,a),l=new L(a,o);else if(3===e)s=new L(a,o),l=new L(o,r);return{factoryWidth:L.getLengthInMeters(s,i),factoryLength:L.getLengthInMeters(l,i),headingDeg:180*L.calculateHeadingAngRadToNorthOfSegment(l,i)/Math.PI,longitude:(o.longitude+o.longitude+o.longitude+o.longitude)/4,latitude:(o.latitude+o.latitude+o.latitude+o.latitude)/4}}},Ht.prototype.makeMesh=function(){if(void 0!==this.width&&void 0!==this.length&&void 0!==this.height){if(void 0===this.objectsArray&&(this.objectsArray=[]),this.bHasGround){var t=this.width,e=this.length,i=.02*this.height,o=new Wt(t,e,i);o.setOneColor(.4,.4,.4,1),this.objectsArray.push(o)}var r=.75*this.height;this.roofMinHeight&&(r=this.roofMinHeight);var n=.6*this.height;this.frontDoorHeight&&(n=this.frontDoorHeight);var a=.5*this.width*.8,s=.5*this.width*.8;this.frontDoorWidth&&(a=.5*this.frontDoorWidth,s=.5*this.frontDoorWidth);var l=.5*this.width,d=new _e;(m=d.newOuterRing().newElement("POLYLINE")).newPoint2d(-l,0),m.newPoint2d(-a,0),m.newPoint2d(-a,n),m.newPoint2d(s,n),m.newPoint2d(s,0),m.newPoint2d(l,0),m.newPoint2d(l,r),m.newPoint2d(0,this.height),m.newPoint2d(-l,r);var h=.4,c=ue.getExtrudedMesh(d,h,1,void 0,!0,!0,void 0);this.objectsArray.push(c),c.rotate(90,1,0,0),c.translate(0,.5*-this.length+.4,0),c.setOneColor(.9,.9,.9,1),(m=(d=new _e).newOuterRing().newElement("POLYLINE")).newPoint2d(-l,0),m.newPoint2d(l,0),m.newPoint2d(l,r),m.newPoint2d(0,this.height),m.newPoint2d(-l,r);c=ue.getExtrudedMesh(d,h,1,void 0,!0,!0,void 0);this.objectsArray.push(c),c.rotate(90,1,0,0),c.translate(0,.5*this.length,0),c.setOneColor(.9,.9,.9,1);var u=this.length-.8,f=r,g=new Wt(.4,u,f);this.objectsArray.push(g);var p=g.getMesh();p.translate(.2-l,0,0),p.setOneColor(.9,.9,.9,1);g=new Wt(.4,u,f);this.objectsArray.push(g);var v=g.getMesh();v.translate(l-.2,0,0),v.setOneColor(.9,.9,.9,1);var y=new Pe;y.newPoint2d(l,r),y.newPoint2d(0,this.height),y.newPoint2d(-l,r);var m;(m=new Pe).point2dArray=xe.getExpandedPoints(y.point2dArray,m.point2dArray,0,.2),(d=new _e).newOuterRing().addElement(m),h=this.length;c=ue.getExtrudedMesh(d,h,1,void 0,!0,!0,void 0);this.objectsArray.push(c),c.rotate(90,1,0,0),c.translate(0,.5*this.length,0),c.setOneColor(98/256,233/256,134/256,.3),this.dirty=!1}},Ht.prototype.render=function(t,e,i,o){if(this.dirty&&this.makeMesh(),void 0===this.objectsArray)return!1;var r=t.getGl();this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,e),r.uniform1i(e.bApplySsao_loc,!0),r.uniform1i(e.refMatrixType_loc,0),r.uniform1i(e.colorType_loc,0),r.enable(r.BLEND);for(var n=this.objectsArray.length,a=0;a<n;a++)this.objectsArray[a].render(t,e,i,o);r.disable(r.BLEND)};var Wt=function(t,e,i){if(!(this instanceof Wt))throw new Error(j.CONSTRUCT_ERROR);this.mesh,this.centerPoint,this.width,this.length,this.height,this.owner,this.geoLocDataManager,this.color4,void 0!==t&&(this.width=t),void 0!==e&&(this.length=e),void 0!==i&&(this.height=i)};Wt.prototype.setOneColor=function(t,e,i,o){void 0===this.color4&&(this.color4=new x),this.color4.setRGBA(t,e,i,o)},Wt.prototype.render=function(t,e,i,o){if(void 0!==this.mesh){if(this.color4)t.getGl().uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]);this.mesh.render(t,e,i)}else this.mesh=this.makeMesh(this.width,this.length,this.height)},Wt.prototype.getMesh=function(){return void 0===this.mesh&&(this.mesh=this.makeMesh(this.width,this.length,this.height)),this.mesh},Wt.prototype.makeMesh=function(t,e,i){void 0!==t&&(this.width=t),void 0!==e&&(this.length=e),void 0!==i&&(this.height=i),void 0===this.width&&(this.width=1),void 0===this.length&&(this.length=1),void 0===this.height&&(this.height=1),void 0===this.centerPoint&&(this.centerPoint=new Ce(0,0,0));var o=new _e,r=o.newOuterRing().newElement("RECTANGLE");r.setCenterPosition(this.centerPoint.x,this.centerPoint.y),r.setDimensions(this.width,this.length);var n=this.height;return ue.getExtrudedMesh(o,n,1,void 0,!0,!0,void 0)};var Xt=function(t,e,i){if(!(this instanceof Xt))throw new Error(j.CONSTRUCT_ERROR);this.radiusX,this.radiusY,this.radiusZ,this.centerPosition,this.strLonRad,this.endLonRad,this.strLatRad,this.endLatRad,this.lonSegments=120,this.latSegments=60,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.mesh,void 0!==t&&(this.radiusX=t),void 0!==e&&(this.radiusY=e),void 0!==i&&(this.radiusZ=i),void 0===this.strLonRad&&(this.strLonRad=0),void 0===this.endLonRad&&(this.endLonRad=2*Math.PI),void 0===this.strLatRad&&(this.strLatRad=-Math.PI/2),void 0===this.endLatRad&&(this.endLatRad=Math.PI/2)};Xt.prototype.render=function(t,e,i,o){var r=t.getGl();if(2===i){var n;n=t.selectionColor.getAvailableColor(n);var a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1])}var s=this.vboKeyContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==s.vboBufferNor&&!s.bindDataNormal(e,t.vboMemoryManager))return!1;if(!s.bindDataIndice(e,t.vboMemoryManager))return!1;var l=s.indicesCount;r.drawElements(r.TRIANGLES,l,r.UNSIGNED_SHORT,0)},Xt.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){void 0===this.vboKeyContainer&&(this.vboKeyContainer=new ft);var e=this.vboKeyContainer.newVBOVertexIdxCacheKey();e.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&e.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&e.setDataArrayTexCoord(this.texCoordsArray,t),e.setDataArrayIdx(this.indices,t)}},Xt.prototype.makeMesh=function(t){var e=!0;void 0!==t&&void 0!==t.bTrianglesSenseCCW&&(e=t.bTrianglesSenseCCW),this.strLonRad>this.endLonRad&&(this.strLonRad-=2*Math.PI);var i=(this.endLonRad-this.strLonRad)/this.lonSegments,o=(this.endLatRad-this.strLatRad)/this.latSegments,r=this.strLonRad,n=this.strLatRad,a=this.radiusX,s=this.radiusY,l=this.radiusZ,d=a*a,h=s*s,c=l*l,f=(this.lonSegments+1)*(this.latSegments+1);this.cartesiansArray=new Float32Array(3*f),this.normalsArray=new Int8Array(3*f);for(var g=0,p=new u,v=0;v<this.latSegments+1;v++){n=this.strLatRad+v*o;for(var y=Math.sin(n),m=Math.cos(n),x=0;x<this.lonSegments+1;x++){r=this.strLonRad+x*i;var b=Math.sin(r),C=a*m*Math.cos(r),A=s*m*b,M=l*y;this.cartesiansArray[3*g]=C,this.cartesiansArray[3*g+1]=A,this.cartesiansArray[3*g+2]=M;var P=new Ce(C,A,M);0===g?p.init(P):p.addPoint(P),P.set(C/d,A/h,M/c),P.unitary(),e?(this.normalsArray[3*g]=127*P.x,this.normalsArray[3*g+1]=127*P.y,this.normalsArray[3*g+2]=127*P.z):(this.normalsArray[3*g]=127*-P.x,this.normalsArray[3*g+1]=127*-P.y,this.normalsArray[3*g+2]=127*-P.z),g+=1}}this.centerPosition=p.getCenterPoint();for(x=0;x<f;x++)this.cartesiansArray[3*x]-=this.centerPosition.x,this.cartesiansArray[3*x+1]-=this.centerPosition.y,this.cartesiansArray[3*x+2]-=this.centerPosition.z;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),Ai.calculateSplited3fv([this.centerPosition.x,this.centerPosition.y,this.centerPosition.z],this.terrainPositionHIGH,this.terrainPositionLOW);var T=this.lonSegments+1,_=this.latSegments+1;this.indices=bi.getIndicesTrianglesRegularNet(T,_,void 0,t)};var Kt=function(t,e,i,o){if(!(this instanceof Kt))throw new Error(j.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==t&&(this.intRadius=t),void 0!==e&&(this.extRadius=e),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.geoLocDataManager,this.color4,void 0!==o){var r=o.color;r&&(this.color4=new x,this.color4.setRGBA(r.r,r.g,r.b,r.a))}};Kt.prototype.makeMesh=function(){var t,e=new _e;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.extRadius),(t=e.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.intRadius);var i=this.height;this.mesh=ue.getExtrudedMesh(e,i,1,void 0,!0,!0,void 0),this.dirty=!1},Kt.prototype.render=function(t,e,i,o){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var r=t.getGl();this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,e),r.uniform1i(e.refMatrixType_loc,0),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),r.enable(r.BLEND),this.mesh.render(t,e,i,o),r.disable(r.BLEND)};var Yt=function(){if(!(this instanceof Yt))throw new Error(j.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};Yt.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},Yt.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new me),this.centerPoint.set(t,e)},Yt.prototype.setRadius=function(t){this.radius=t},Yt.prototype.setStartAngleDegree=function(t){this.startAngleDeg=t},Yt.prototype.setStartPoint=function(t,e){void 0===this.startPoint&&(this.startPoint=new me),this.startPoint.set(t,e)},Yt.prototype.setEndPoint=function(t,e){void 0===this.endPoint&&(this.endPoint=new me),this.endPoint.set(t,e)},Yt.prototype.setSense=function(t){this.sweepSense=t},Yt.prototype.setSweepAngleDegree=function(t){this.sweepAngleDeg=t},Yt.prototype.getPoints=function(t,e){if(void 0===this.centerPoint)return t;var i,o;if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.startAngleDeg){if(void 0===this.startPoint)return t;(i=new me).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=i.getModul();var r=Math.acos(n/o);this.startPoint.y<0&&(r*=-1),this.startAngleDeg=180*r/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return t;void 0===o&&(void 0===i&&(i=new me).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=i.getModul()),this.radius=o}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return t;(new me).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);endPoint.getModul(),r=Math.acos(n/o);this.endPoint.y<0&&(r*=-1),this.sweepAngleDeg=180*r/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===t&&(t=[]);var n,a,s,l=[],d=2*Math.PI/this.numPointsFor360Deg,h=this.centerPoint.x,c=this.centerPoint.y,u=Math.PI/180*this.startAngleDeg,f=Math.PI/180*this.sweepAngleDeg;if(f>=0)for(var g=0;g<f;g+=d)n=h+this.radius*Math.cos(g+u),a=c+this.radius*Math.sin(g+u),s=new me(n,a),l.push(s);else for(g=0;g>f;g-=d)n=h+this.radius*Math.cos(g+u),a=c+this.radius*Math.sin(g+u),s=new me(n,a),l.push(s);var p=l.length;p>0&&(l[0].pointType=1,l[p-1].pointType=1);for(var v=t.length,y=0;y<p;y++)if(0===y)if(v>0){var m=t[v-1];s=l[y],m.isCoincidentToPoint(s,1e-4)||t.push(s)}else t.push(l[y]);else t.push(l[y]);if((v=t.length)>0){var x=t[v-1],b=t[0];x.isCoincidentToPoint(b,1e-4)&&(t.pop(),x.deleteObjects())}return t};var qt=function(t){if(!(this instanceof qt))throw new Error(j.CONSTRUCT_ERROR);this.length=void 0===t?60:t,this.vbo_vicks_container=new ft};qt.prototype.setDimension=function(t){this.length=t},qt.prototype.makeMesh=function(t){void 0!==t&&(this.length=t);var e=new fe;e.profile=new _e;var i,o=e.profile,r=o.newOuterRing(),n=this.length,a=.1*this.length,s=r.newElement("POLYLINE");s.newPoint2d(0,0);s.newPoint2d(.25*a,.25*n),s.newPoint2d(.25*a,.75*n),s.newPoint2d(.5*a,.75*n),s.newPoint2d(0,n),i=new De;var l=new me(0,-10),d=new me(0,10);i.setPoints(l,d),e.revolve(o,360,8,i);var h=e.getSurfaceIndependentMesh(void 0,!1,!1);h.setColor(.1,1,.1,1),h.reverseSense();var c=new B,u=h.getCopy(void 0);c.rotationAxisAngDeg(-90,0,0,1),u.transformByMatrix4(c),u.setColor(1,.1,.1,1);var f=h.getCopy(void 0);return c.rotationAxisAngDeg(90,1,0,0),f.transformByMatrix4(c),f.setColor(.1,.1,1,1),h.mergeMesh(u),h.mergeMesh(f),h},qt.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container};var Zt=function(t,e){if(!(this instanceof Zt))throw new Error(j.CONSTRUCT_ERROR);this.minX=Number.MAX_VALUE,this.maxX=Number.MIN_VALUE,this.minY=Number.MAX_VALUE,this.maxY=Number.MIN_VALUE};Zt.prototype.setInit=function(t){void 0!==t&&(this.minX=t.x,this.minY=t.y,this.maxX=t.x,this.maxY=t.y)},Zt.prototype.setInitByRectangle=function(t){void 0!==t&&(this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY)},Zt.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y))},Zt.prototype.addRectangle=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY))},Zt.prototype.intersectsWithRectangle=function(t){return void 0!==t&&(!(t.minX>this.maxX)&&(!(t.maxX<this.minX)&&(!(t.minY>this.maxY)&&!(t.maxY<this.minY))))};var Qt=function(){if(!(this instanceof Qt))throw new Error(j.CONSTRUCT_ERROR);this.triPolyhedron=new nt,this.vbo_vicks_container=new ft,this.vBOVertexIdxCacheKey=this.vbo_vicks_container.newVBOVertexIdxCacheKey()};Qt.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},Qt.prototype.makeAABB=function(t,e,i){var o,r=-t/2,n=-e/2,a=-i/2,s=t/2,l=e/2,d=i/2,h=this.triPolyhedron.vertexList,c=h.newVertex();c.setPosition(r,n,a),(c=h.newVertex()).setPosition(s,n,a),(c=h.newVertex()).setPosition(s,l,a),(c=h.newVertex()).setPosition(r,l,a),(c=h.newVertex()).setPosition(r,n,d),(c=h.newVertex()).setPosition(s,n,d),(c=h.newVertex()).setPosition(s,l,d),(c=h.newVertex()).setPosition(r,l,d),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(0),h.getVertex(2),h.getVertex(1)),o.newTriangle().setVertices(h.getVertex(0),h.getVertex(3),h.getVertex(2)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(4),h.getVertex(5),h.getVertex(6)),o.newTriangle().setVertices(h.getVertex(4),h.getVertex(6),h.getVertex(7)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(0),h.getVertex(1),h.getVertex(5)),o.newTriangle().setVertices(h.getVertex(0),h.getVertex(5),h.getVertex(4)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(1),h.getVertex(2),h.getVertex(6)),o.newTriangle().setVertices(h.getVertex(1),h.getVertex(6),h.getVertex(5)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(2),h.getVertex(3),h.getVertex(7)),o.newTriangle().setVertices(h.getVertex(2),h.getVertex(7),h.getVertex(6)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(3),h.getVertex(0),h.getVertex(4)),o.newTriangle().setVertices(h.getVertex(3),h.getVertex(4),h.getVertex(7))};var Jt=function(){if(!(this instanceof Jt))throw new Error(j.CONSTRUCT_ERROR);this.geoCoordsList,this.geoLocDataManager,this.knotPoints3dList,this.interpolatedPoints3dList,this.controlPoints3dMap,this.segmentLengthArray,this.dirty=!0,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};Jt.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new D,this.geoCoordsList.owner=this),this.geoCoordsList},Jt.prototype.renderPoints=function(t,e,i){if(void 0===this.geoCoordsList)return!1;this.geoCoordsList.renderPoints(t,e,i,!1),this.geoCoordsList.renderLines(t,e,i,!1,!1);var o=t.sceneState.gl;void 0!==this.interpolatedPoints3dList&&((e=t.postFxShadersManager.getShader("pointsCloud")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),o.uniform1i(e.bPositionCompressed_loc,!1),1===i&&(o.uniform1i(e.bUse1Color_loc,!0),void 0!==e.oneColor4_loc&&null!==e.oneColor4_loc&&o.uniform4fv(e.oneColor4_loc,[1,0,0,1])),o.uniform1f(e.fixPointSize_loc,5),o.uniform1i(e.bUseFixPointSize_loc,!0),this.interpolatedPoints3dList.renderLines(t,e,i,!1,!1));this.controlPoints3dMap},Jt.prototype.makeControlPoints=function(t,e){if(void 0===this.knotPoints3dList&&(void 0===this.geoCoordsList.points3dList&&this.geoCoordsList.makeLines(e),this.knotPoints3dList=new be,this.knotPoints3dList.pointsArray=this.geoCoordsList.points3dList.pointsArray,this.knotPoints3dList.geoLocDataManager=this.geoCoordsList.points3dList.geoLocDataManager),void 0!==this.knotPoints3dList.pointsArray){this.controlPoints3dMap={};var i,o,r,n,a;void 0===t&&(t=.1);for(var s=this.knotPoints3dList.getPointsCount(),l=0;l<s;l++){if(i=this.knotPoints3dList.getPoint(l),0===l)r=this.knotPoints3dList.getPoint(l+1),a=t,(h=new Ce).set(i.x*(1-a)+r.x*a,i.y*(1-a)+r.y*a,i.z*(1-a)+r.z*a),this.controlPoints3dMap[l]={inningControlPoint:void 0,outingControlPoint:h};else if(l===s-1){o=this.knotPoints3dList.getPoint(l-1),n=t,(d=new Ce).set(i.x*(1-n)+o.x*n,i.y*(1-n)+o.y*n,i.z*(1-n)+o.z*n),this.controlPoints3dMap[l]={inningControlPoint:d,outingControlPoint:void 0}}else{o=this.knotPoints3dList.getPoint(l-1),r=this.knotPoints3dList.getPoint(l+1);var d,h,c=this.knotPoints3dList.getTangentLine3D(l,void 0,!1).direction;n=i.distToPoint(o)*t,(d=new Ce).set(i.x-c.x*n,i.y-c.y*n,i.z-c.z*n),a=i.distToPoint(r)*t,(h=new Ce).set(i.x+c.x*a,i.y+c.y*a,i.z+c.z*a),this.controlPoints3dMap[l]={inningControlPoint:d,outingControlPoint:h}}}}},Jt.prototype.makeInterpolatedPoints=function(){if(void 0!==this.knotPoints3dList){void 0===this.controlPoints3dMap&&this.makeControlPoints(),void 0===this.interpolatedPoints3dList&&(this.interpolatedPoints3dList=new be);for(var t=[],e=this.knotPoints3dList.getPointsCount(),i=0;i<e-1;i++){var o=this.knotPoints3dList.getSegment3D(i,void 0,!1),r=o.startPoint3d,n=o.endPoint3d,a=this.controlPoints3dMap[i].outingControlPoint,s=this.controlPoints3dMap[i+1].inningControlPoint;Jt.makeForSegment(r,a,s,n,10,t)}this.interpolatedPoints3dList.pointsArray=t,this.interpolatedPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}},Jt.getLengthForSegment=function(t,e,i,o,r,n){void 0===r&&(r=1),void 0===n&&(n=10);for(var a,s,l=Jt.makeForSegmentPartial(t,e,i,o,r,n,void 0),d=0,h=l.length,c=0;c<h-1;c++)a=l[c],s=l[c+1],d+=a.distToPoint(s);return d},Jt.getUnitaryPositionForSegmentAtLinearPosition=function(t,e,i,o,r,n){for(var a,s=1/n,l=s,d=t.x,h=t.y,c=t.z,u=e.x,f=e.y,g=e.z,p=i.x,v=i.y,y=i.z,m=o.x,x=o.y,b=o.z,C=new Ce(0,0,0),A=new Ce(0,0,0),M=0,P=0;P<n+1;P++){var T=1-(l=P*s),_=Math.pow(T,2),w=Math.pow(T,3),S=l*l,R=S*l,L=3*_*l,D=3*T*S,I=w*d+L*u+D*p+R*m,E=w*h+L*f+D*v+R*x,O=w*c+L*g+D*y+R*b;if(C.set(I,E,O),P>0){var F=A.distToPoint(C);if((M+=F)>r){var N=(F-(M-r))/F;return a=(P-1)*s+(N/=n)}}A.set(I,E,O)}return a},Jt.getTangent=function(t,e,i){var o=t.knotPoints3dList.getPointsCount();if(void 0===t.segmentLengthArray){t.segmentLengthArray=[];for(var r,n=20,a=1,s=0;s<o-1;s++){var l=(y=t.knotPoints3dList.getSegment3D(s,void 0,r)).startPoint3d,d=y.endPoint3d,h=t.controlPoints3dMap[s].outingControlPoint,c=t.controlPoints3dMap[s+1].inningControlPoint,u=Jt.getLengthForSegment(l,h,c,d,a,n);t.segmentLengthArray[s]=u}}for(var f=!1,g=(s=0,0),p=0,v=-1;!f&&s<o;){if((g+=t.segmentLengthArray[s])>=e){f=!0,v=s;var y,m=e-p,x=(a=m/t.segmentLengthArray[v],l=(y=t.knotPoints3dList.getSegment3D(v,void 0,r)).startPoint3d,d=y.endPoint3d,h=t.controlPoints3dMap[v].outingControlPoint,c=t.controlPoints3dMap[v+1].inningControlPoint,n=20,Jt.getUnitaryPositionForSegmentAtLinearPosition(l,h,c,d,m,n));i=Jt.getTangentForSegment(l,h,c,d,x,i)}p=g,s++}return i},Jt.getTangentForSegment=function(t,e,i,o,r,n){var a=r,s=1-a,l=s*s,d=a*a,h=2*s*a,c=t.x,u=t.y,f=t.z,g=e.x,p=e.y,v=e.z,y=i.x,m=i.y,x=i.z,b=l*c+h*g+d*y,C=l*u+h*p+d*m,A=l*f+h*v+d*x,M=l*g+h*y+d*o.x,P=l*p+h*m+d*o.y,T=l*v+h*x+d*o.z,_=new Ce(b,C,A),w=new Ce(M,P,T);void 0===n&&(n=new se);var S=_.getVectorToPoint(w,void 0);return S.unitary(),n.setPointAndDir(s*b+a*M,s*C+a*P,s*A+a*T,S.x,S.y,S.z),n},Jt.makeForSegment=function(t,e,i,o,r,n){return Jt.makeForSegmentPartial(t,e,i,o,1,r,n)},Jt.makeForSegmentPartial=function(t,e,i,o,r,n,a){void 0===a&&(a=[]);for(var s=r/n,l=s,d=t.x,h=t.y,c=t.z,u=e.x,f=e.y,g=e.z,p=i.x,v=i.y,y=i.z,m=o.x,x=o.y,b=o.z,C=0;C<n+1;C++){var A=1-(l=C*s),M=Math.pow(A,2),P=Math.pow(A,3),T=l*l,_=T*l,w=3*M*l,S=3*A*T,R=new Ce(P*d+w*u+S*p+_*m,P*h+w*f+S*v+_*x,P*c+w*g+S*y+_*b);a.push(R)}return a};var $t=function(){if(!(this instanceof $t))throw new Error(j.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.numPointsFor360Deg};$t.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new me),this.centerPoint.set(t,e)},$t.prototype.setRadius=function(t){this.radius=t},$t.prototype.getPoints=function(t,e){if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return t;var i=new Yt;return i.setCenterPosition(this.centerPoint.x,this.centerPoint.y),i.setRadius(this.radius),i.setStartAngleDegree(0),i.setSweepAngleDegree(360),i.setSense(1),void 0===t&&(t=[]),t=i.getPoints(t,this.numPointsFor360Deg)};var te=function(){if(!(this instanceof te))throw new Error(j.CONSTRUCT_ERROR);this.plane,this.geoLocDataManager,this.mesh};te.prototype.getPlane=function(){void 0===this.plane&&(this.plane=new X);var t=this.geoLocDataManager.getCurrentGeoLocationData(),e=t.tMatrix,i=t.position;return this.plane.setPointAndNormal(i.x,i.y,i.z,e._floatArrays[8],e._floatArrays[9],e._floatArrays[10]),this.plane},te.prototype.makeRectangle=function(t,e){void 0===this.mesh&&(this.mesh=new ce);var i=this.mesh.getVertexList(),o=t/2,r=e/2,n=i.newVertex();n.setPosition(-o,-r,100);var a=i.newVertex();a.setPosition(o,-r,100);var s=i.newVertex();s.setPosition(o,r,100);var l=i.newVertex();l.setPosition(-o,r,100),this.mesh.newSurface().newFace().addVerticesArray([n,a,s,l])},te.prototype.render=function(t,e,i){var o,r=t.sceneState.gl;if(2===i){var n=t.selectionColor,a=t.selectionManager,s=a.getSelectionCandidatesFamily("general");void 0===s&&(s=a.newCandidatesFamily("general"));var l=n.getAvailableColor(void 0),d=n.decodeColor3(l.r,l.g,l.b);a.setCandidateCustom(d,"general",this),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}else if(1===i){r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[1,1,0,1]);var h=0;r.uniform1i(e.refMatrixType_loc,h),o=r.LINE_LOOP}else if(0===i){h=0;r.uniform1i(e.refMatrixType_loc,h)}this.mesh.render(t,e,i,o)};var ee=function(){if(!(this instanceof ee))throw new Error(j.CONSTRUCT_ERROR);this.geoCoordsList,this.geoLocDataManager,this.excavationDepthInMeters,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};ee.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new D,this.geoCoordsList.owner=this),this.geoCoordsList},ee.prototype.renderPoints=function(t,e,i){if(void 0===this.geoCoordsList)return!1;void 0!==this.meshPositive&&this.renderExcavation(t,e,i),this.geoCoordsList.renderPoints(t,e,i,!1),this.geoCoordsList.renderLines(t,e,i,!1,!1)},ee.prototype.renderExcavation=function(t,e,i){if(void 0!==this.meshPositive){var o=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),o.uniform1i(e.bApplySsao_loc,!1),o.uniform1i(e.refMatrixType_loc,0),o.uniform1i(e.colorType_loc,1),o.uniform1i(e.bApplySpecularLighting_loc,!0),o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),o.depthRange(0,1),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.colorMask(!1,!1,!1,!1),o.depthMask(!1),o.enable(o.CULL_FACE),o.enable(o.STENCIL_TEST),o.clearStencil(0);o.cullFace(o.FRONT),o.stencilFunc(o.ALWAYS,0,255),o.stencilOp(o.KEEP,o.INCR,o.KEEP),this.meshPositive.render(t,e,i,void 0),o.cullFace(o.BACK),o.stencilFunc(o.ALWAYS,0,255),o.stencilOp(o.KEEP,o.DECR,o.KEEP),this.meshPositive.render(t,e,i,void 0),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[222/255,184/255,135/255,1]),o.colorMask(!0,!0,!0,!0),o.depthMask(!0),o.stencilMask(0),o.stencilFunc(o.LEQUAL,1,255),o.stencilOp(o.REPLACE,o.REPLACE,o.REPLACE),o.cullFace(o.BACK),o.depthFunc(o.ALWAYS),this.meshNegative.render(t,e,i,void 0),o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),o.disable(o.STENCIL_TEST),o.stencilOp(o.KEEP,o.KEEP,o.KEEP),o.disable(o.POLYGON_OFFSET_FILL),o.depthRange(0,1),o.useProgram(null),o.depthMask(!0),o.stencilMask(255)}},ee.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new O);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},ee.prototype.makeExtrudeObject=function(t){if(void 0===this.geoCoordsList)return!1;var e=this.getGeoLocationData(),i=(r=this.geoCoordsList.getGeoCoord(0)).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Xe);var o,r,n=[],a=[];void 0===this.excavationDepthInMeters&&(this.excavationDepthInMeters=80);for(var s=this.geoCoordsList.getGeoCoordsCount(),l=0;l<s;l++){r=this.geoCoordsList.getGeoCoord(l);var d=new Ce,h=new Ce;o=F.geographicToCartesianWgs84(r.longitude,r.latitude,r.altitude-this.excavationDepthInMeters,o),d.set(o[0],o[1],o[2]),o=F.geographicToCartesianWgs84(r.longitude,r.latitude,r.altitude+100,o),h.set(o[0],o[1],o[2]);var c=new Ce,u=new Ce;c=e.getTransformedRelativePosition(d,c),u=e.getTransformedRelativePosition(h,u),c.pointType=1,u.pointType=1,n[l]=c,a[l]=u}var f=this.vtxProfilesList.newVtxProfile(),g=this.vtxProfilesList.newVtxProfile();if(f.makeByPoints3DArray(n,void 0),g.makeByPoints3DArray(a,void 0),void 0===this.meshPositive){this.mesh=this.vtxProfilesList.getMesh(void 0,!0,!0),this.meshPositive=this.mesh.getCopySurfaceIndependentMesh(this.meshPositive),this.meshPositive.calculateVerticesNormals(),this.meshPositive.setColor(.1,.5,.5,1),this.meshPositive.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshPositive.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager),this.meshNegative=this.mesh.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}},ee.prototype.remakeExtrudeObject=function(t){if(void 0===this.vtxProfilesList)return!1;var e=this.getGeoLocationData(),i=(r=this.geoCoordsList.getGeoCoord(0)).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i);var o,r,n=[],a=[];void 0===this.excavationDepthInMeters&&(this.excavationDepthInMeters=80);for(var s=this.geoCoordsList.getGeoCoordsCount(),l=0;l<s;l++){r=this.geoCoordsList.getGeoCoord(l);var d=new Ce,h=new Ce;o=F.geographicToCartesianWgs84(r.longitude,r.latitude,r.altitude-this.excavationDepthInMeters,o),d.set(o[0],o[1],o[2]),o=F.geographicToCartesianWgs84(r.longitude,r.latitude,r.altitude+100,o),h.set(o[0],o[1],o[2]);var c=new Ce,u=new Ce;c=e.getTransformedRelativePosition(d,c),u=e.getTransformedRelativePosition(h,u),c.pointType=1,u.pointType=1,n[l]=c,a[l]=u}var f=this.vtxProfilesList.getVtxProfile(0),g=this.vtxProfilesList.getVtxProfile(1);f.updateByPoints3DArray(n,void 0),g.updateByPoints3DArray(a,void 0);var p=t.vboMemoryManager;if(void 0!==this.meshPositive&&this.meshPositive.deleteObjects(p),void 0!==this.meshNegative&&this.meshNegative.deleteObjects(p),this.meshPositive=void 0,this.meshNegative=void 0,void 0===this.meshPositive){this.mesh=this.vtxProfilesList.getMesh(void 0,!0,!0),this.meshPositive=this.mesh.getCopySurfaceIndependentMesh(this.meshPositive),this.meshPositive.calculateVerticesNormals(),this.meshPositive.setColor(.1,.5,.5,1),this.meshPositive.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshPositive.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager),this.meshNegative=this.mesh.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}};var ie=function(){if(!(this instanceof ie))throw new Error(j.CONSTRUCT_ERROR);this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner};ie.prototype.deleteObjects=function(){this.vertexArray=void 0,this.hEdge=void 0,void 0!==this.planeNormal&&(this.planeNormal.deleteObjects(),this.planeNormal=void 0),this.surfaceOwner=void 0},ie.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},ie.prototype.addVertex=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),this.vertexArray.push(t)},ie.prototype.addVerticesArray=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),Array.prototype.push.apply(this.vertexArray,t)},ie.prototype.getVertex=function(t){if(void 0!==this.vertexArray)return this.vertexArray[t]},ie.prototype.reverseSense=function(){this.vertexArray.reverse()},ie.prototype.setColor=function(t,e,i,o){for(var r=this.getVerticesCount(),n=0;n<r;n++)this.getVertex(n).setColorRGBA(t,e,i,o)},ie.prototype.getPlaneNormal=function(){return(void 0===this.planeNormal||this.planeNormal.isNAN())&&this.calculatePlaneNormal(),this.planeNormal},ie.calculatePlaneNormal=function(t,e){void 0===e&&(e=new Ce),e.set(0,0,0);for(var i=t.length,o=0;o<i;o++){var r=ze.getPrevIdx(o,t),n=ze.getVector(r,t,void 0),a=ze.getVector(o,t,void 0);if(n.unitary(),a.unitary(),!n.isNAN()&&!a.isNAN()){var s=n.crossProduct(a,void 0);if(s.unitary(),!s.isNAN()){var l=n.scalarProduct(a);l>1?l=1:l<-1&&(l=-1);var d=Math.acos(l);e.add(s.x*d,s.y*d,s.z*d)}}}return e.unitary(),e},ie.prototype.calculatePlaneNormal=function(){return this.planeNormal=ie.calculatePlaneNormal(this.vertexArray,this.planeNormal),this.planeNormal},ie.prototype.calculateVerticesNormals=function(t){var e=this.vertexArray.length;void 0!==t&&t&&this.calculatePlaneNormal(),void 0===this.planeNormal&&this.calculatePlaneNormal();e=this.getVerticesCount();for(var i=0;i<e;i++)this.vertexArray[i].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},ie.prototype.solveUroborus=function(){var t=this.getVerticesCount();if(!(t<3)){var e=this.getVertex(0),i=this.getVertex(t-1),o=e.point3d,r=i.point3d;o.isCoincidentToPoint(r,1e-4)&&this.vertexArray.pop()}},ie.getBestFacePlaneToProject=function(t){var e=-1,i=Math.abs(t.x),o=Math.abs(t.y),r=Math.abs(t.z);return r>i&&r>=o?e=0:i>=o&&i>=r?e=1:o>i&&o>=r&&(e=2),e},ie.getProjectedPolygon2D=function(t,e,i){void 0===i&&(i=new Me),void 0===i.point2dList&&(i.point2dList=new xe);var o=i.point2dList;return o.pointsArray=ze.getProjectedPoints2DArray(t,e,o.pointsArray),i},ie.prototype.getTessellatedTriangles=function(t){if(void 0===t&&(t=[]),this.getVerticesCount()<=3)return t=this.getTrianglesConvex(t);var e,i=this.getPlaneNormal(),o=ie.getProjectedPolygon2D(this.vertexArray,i,void 0);e=o.calculateNormal(e);var r=[];o.tessellate(e,r),this.calculateVerticesNormals();for(var n=r.length,a=0;a<n;a++){var s=r[a];if(0!==s.point2dList.getPointsCount()){var l,d,h,c,u,f;l=s.point2dList.getPoint(0).ownerVertex3d;for(var g=s.point2dList.getPointsCount(),p=1;p<g-1;p++)u=s.point2dList.getPoint(p),f=s.point2dList.getPoint(p+1),d=u.ownerVertex3d,h=f.ownerVertex3d,c=new Be(l,d,h),t.push(c)}}return t},ie.prototype.getTrianglesConvex=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,i,o,r;void 0===t&&(t=[]),e=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)i=this.getVertex(a),o=this.getVertex(a+1),r=new Be(e,i,o),t.push(r);return t},ie.prototype.setTwinHalfEdge=function(t){for(var e=!1,i=this.hEdge,o=this.hEdge;!e;){if(o.setTwin(t))return!0;(o=o.next)===i&&(e=!0)}return!1},ie.prototype.getFrontierHalfEdges=function(t){var e=this.getHalfEdgesLoop(void 0);if(void 0===e)return t;void 0===t&&(t=[]);for(var i,o=e.length,r=0;r<o;r++)(i=e[r]).isFrontier()&&t.push(i);return t},ie.prototype.getHalfEdgesLoop=function(t){return void 0===this.hEdge?t:t=oe.getHalfEdgesLoop(this.hEdge,t)},ie.prototype.setTwinFace=function(t){if(void 0===t)return!1;if(void 0===this.hEdge||void 0===t.hEdge)return!1;for(var e,i=t.getHalfEdgesLoop(void 0),o=i.length,r=!1,n=0;n<o;n++)e=i[n],this.setTwinHalfEdge(e)&&(r=!0);return r},ie.prototype.createHalfEdges=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,i;void 0===t&&(t=[]);for(var o,r=this.getVerticesCount(),n=0;n<r;n++)e=this.getVertex(n),(i=new oe).setStartVertex(e),i.setFace(this),t.push(i);for(n=0;n<r;n++)i=t[n],o=t[ze.getNextIdx(n,this.vertexArray)],i.setNext(o);return this.hEdge=t[0],t};var oe=function(){if(!(this instanceof oe))throw new Error(j.CONSTRUCT_ERROR);this.startVertex,this.next,this.twin,this.face};oe.prototype.deleteObjects=function(){this.startVertex=void 0,this.next=void 0,this.twin=void 0,this.face=void 0},oe.prototype.setStartVertex=function(t){this.startVertex=t,t.outingHedge=this},oe.prototype.setNext=function(t){this.next=t},oe.prototype.setTwin=function(t){var e=oe.areTwinables(t,this);return e&&(this.twin=t,t.twin=this),e},oe.prototype.setFace=function(t){this.face=t},oe.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},oe.prototype.isFrontier=function(){return void 0===this.twin||null===this.twin},oe.prototype.getPrev=function(){for(var t=this;;){if(t.next===this)return t;if(void 0===t.next)return;t=t.next}},oe.areTwinables=function(t,e){return t.startVertex===e.getEndVertex()&&t.getEndVertex()===e.startVertex},oe.getHalfEdgesLoop=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]),e.length=0;for(var i=t,o=t,r=!1;!r;)e.push(o),(o=o.next)!==i&&void 0!==o||(r=!0);return e};var re=function(){if(!(this instanceof re))throw new Error(j.CONSTRUCT_ERROR);this.hEdgesArray};re.prototype.deleteObjects=function(){if(void 0!==this.hEdgesArray){for(var t=this.hEdgesArray.length,e=0;e<t;e++)this.hEdgesArray[e].deleteObjects(),this.hEdgesArray[e]=void 0;this.hEdgesArray=void 0}},re.prototype.newHalfEdge=function(){void 0===this.hEdgesArray&&(this.hEdgesArray=[]);var t=new oe;return this.hEdgesArray.push(t),t},re.prototype.addHalfEdgesArray=function(t){void 0!==t&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,t))};var ne=function(){if(!(this instanceof ne))throw new Error(j.CONSTRUCT_ERROR);this.owner,this.idx};ne.prototype.deleteObjects=function(){this.owner=void 0,this.idx=void 0};var ae=function(){if(!(this instanceof ae))throw new Error(j.CONSTRUCT_ERROR);this.strIdx,this.endIdx};ae.prototype.copyFrom=function(t){void 0!==t&&(this.strIdx=t.strIdx,this.endIdx=t.endIdx)},ae.prototype.deleteObjects=function(){this.strIdx=void 0,this.endIdx=void 0};var se=function(t,e){if(!(this instanceof se))throw new Error(j.CONSTRUCT_ERROR);this.point=void 0!==t?t:new Ce,this.direction=void 0!==e?e:new Ce};se.prototype.setPointAndDir=function(t,e,i,o,r,n){this.point.set(t,e,i),this.direction.set(o,r,n),this.direction.unitary()},se.prototype.getProjectedPoint=function(t,e){void 0===e&&(e=new Ce);var i=new X;return i.setPointAndNormal(t.x,t.y,t.z,this.direction.x,this.direction.y,this.direction.z),e=i.intersectionLine(this,e)},se.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;var i=this.getProjectedPoint(t);return void 0!==i&&(void 0===e&&(e=1e-7),i.squareDistToPoint(t)<e*e)};var le=function(){if(!(this instanceof le))throw new Error(j.CONSTRUCT_ERROR);this.point=new me,this.direction=new me};le.prototype.setPointAndDir=function(t,e,i,o){this.point.set(t,e),this.direction.set(i,o),this.direction.unitary()},le.prototype.getPerpendicularRight=function(t){var e=new le;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(this.direction.y,-this.direction.x),e},le.prototype.getParallelRight=function(t){var e=this.getPerpendicularRight().direction,i=new le;return i.point.set(this.point.x+e.x*t,this.point.y+e.y*t),i.direction.copyFrom(this.direction),i},le.prototype.getParallelLeft=function(t){var e=this.getPerpendicularLeft().direction,i=new le;return i.point.set(this.point.x+e.x*t,this.point.y+e.y*t),i.direction.copyFrom(this.direction),i},le.prototype.getPerpendicularLeft=function(t){var e=new le;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(-this.direction.y,this.direction.x),e},le.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new me);var i=this.getPerpendicularLeft(t);return e=this.intersectionWithLine(i,e)}},le.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var i=this.getProjectedPoint(t,i);return t.squareDistToPoint(i)<e*e},le.prototype.isParallelToLine=function(t){if(void 0===t)return!1;var e=this.direction.angleRadToVector(t.direction);return e<1e-9||Math.abs(e-Math.PI)<1e-9},le.prototype.intersectionWithLine=function(t,e){if(void 0!==t&&!this.isParallelToLine(t)){var i,o;if(Math.abs(this.direction.x)<1e-9){var r=t.direction.y/t.direction.x,n=t.point.y-r*t.point.x;i=this.point.x,o=r*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(t.direction.x)<1e-9)i=t.point.x,o=this.point.y;else{r=t.direction.y/t.direction.x,n=t.point.y-r*t.point.x;i=(this.point.y-n)/r,o=this.point.y}else if(Math.abs(t.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;o=(i=t.point.x)*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;o=(r=t.direction.y/t.direction.x)*(i=(s-(n=t.point.y-r*t.point.x))/(r-a))+n}return void 0===e&&(e=new me),e.set(i,o),e}};var de=function(){if(!(this instanceof de))throw new Error(j.CONSTRUCT_ERROR);this.meshesArray,this.geoLocDataManager,this.vboKeysContainer};de.prototype.newParametricMesh=function(){void 0===this.meshesArray&&(this.meshesArray=[]);var t=new fe;return this.meshesArray.push(t),t},de.prototype.deleteObjects=function(){if(void 0!==this.meshesArray){for(var t=this.meshesArray.length,e=0;e<t;e++)this.meshesArray[e].deleteObjects(),this.meshesArray[e]=void 0;this.meshesArray=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0}},de.prototype.getMeshesCount=function(){return void 0===this.meshesArray?0:this.meshesArray.length},de.prototype.getMesh=function(t){if(void 0!==this.meshesArray)return this.meshesArray[t]};var he=function(t){if(!(this instanceof he))throw new Error(j.CONSTRUCT_ERROR);this.magoManager=t};he.prototype.prepareVisibles=function(){},he.prototype.renderScene=function(){var t=this.magoManager.sceneState.gl;t.enable(t.DEPTH_TEST),t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.magoManager.start(void 0,!0,0,1)},he.prototype.renderTest=function(){var t=this.magoManager.sceneState.gl;t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.magoManager.start(void 0,!0,0,1)},he.prototype.goto=function(t,e,i){var o;o=F.geographicToCartesianWgs84(t,e,i,o);var r,n=this.magoManager.sceneState.camera,a=n.position,s=n.direction,l=n.up;r=this.magoManager.globe.transformMatrixAtCartesianPointWgs84(o[0],o[1],o[2],r),a.set(o[0],o[1],o[2]),s.set(-r[8],-r[9],-r[10]),l.set(r[4],r[5],r[6]),this.updateModelViewMatrixByCamera(n)},he.prototype.mousedown=function(t){this.magoManager.sceneState.mouseButton=t.button,he.updateMouseStartClick(t.clientX,t.clientY,this.magoManager),this.magoManager.isCameraMoving=!0,this.magoManager.mouse_x=t.clientX,this.magoManager.mouse_y=t.clientY},he.updateMouseClick=function(t,e,i){var o=i.sceneState.mouseAction;o.curX=t,o.curY=e},he.updateMouseStartClick=function(t,e,i){var o=i.sceneState.gl,r=i.sceneState.mouseAction;he.updateMouseClick(t,e,i);var n=new Date;r.strTime=n.getTime(),r.strX=t,r.strY=e,0===i.sceneState.mouseButton&&(i.bPicking=!0),r.strLinealDepth=Ai.calculatePixelLinearDepth(o,r.strX,r.strY,i.depthFboAux,i),r.strCamCoordPoint=Ai.calculatePixelPositionCamCoord(o,r.strX,r.strY,r.strCamCoordPoint,i.depthFboAux,void 0,i),r.strWorldPoint=Ai.cameraCoordPositionToWorldCoord(r.strCamCoordPoint,r.strWorldPoint,i);var a=i.sceneState.camera;r.strCamera.copyPosDirUpFrom(a);var s,l=i.sceneState.modelViewMatrix,d=i.sceneState.modelViewMatrixInv;(r.strModelViewMatrix._floatArrays=glMatrix.mat4.copy(r.strModelViewMatrix._floatArrays,l._floatArrays),r.strModelViewMatrixInv._floatArrays=glMatrix.mat4.copy(r.strModelViewMatrixInv._floatArrays,d._floatArrays),void 0!==i.globe)&&(s=Ai.getRayWorldSpace(o,t,e,s,i),r.strWorldPoint2=i.globe.intersectionLineWgs84(s,r.strWorldPoint2))},he.prototype.updateModelViewMatrixByCamera=function(t){var e=(t=this.magoManager.sceneState.camera).position,i=t.direction,o=t.up,r=t.frustum.far[0],n=e.x+i.x*r,a=e.y+i.y*r,s=e.z+i.z*r,l=this.magoManager.sceneState.modelViewMatrix;l._floatArrays=B.lookAt(l._floatArrays,[e.x,e.y,e.z],[n,a,s],[o.x,o.y,o.z])},he.prototype.mouseup=function(t){var e=this.magoManager;e.sceneState.mouseButton=-1,e.bPicking=!1,e.isCameraMoving=!1},he.prototype.mouseclick=function(t){if(0===t.button){var e=t.clientX,i=t.clientY;this.magoManager.mouseActionLeftClick(e,i)}},he.prototype.mousewheel=function(t){var e=t.wheelDelta/10,i=(this.magoManager.sceneState.mouseAction,this.magoManager.sceneState.camera),o=i.position,r=i.direction,n=(i.up,i.getCameraElevation());if(!isNaN(n)){e*=n*n*1e-5+.001*n,e+=1;var a=.5*n;a>2e5&&(a=2e5),e<-a&&(e=-a),e>a&&(e=a),o.add(r.x*e,r.y*e,r.z*e),this.updateModelViewMatrixByCamera(i)}},he.prototype.mousemove=function(t){var e=this.magoManager.sceneState.mouseAction;if(0===this.magoManager.sceneState.mouseButton){this.magoManager.sceneState.gl,this.magoManager.sceneState;var i,o,r=e.strCamera,n=this.magoManager.sceneState.camera,a=e.strWorldPoint,s=a.getModul(),l=t.clientX,d=t.clientY;if(l===e.strX&&d===e.strY)return;o=Ai.getRayCamSpace(l,d,o,this.magoManager),void 0===this.pointSC&&(this.pointSC=new Ce),this.pointSC.set(o[0],o[1],o[2]);var h,c=e.strModelViewMatrixInv;if(this.pointSC2=c.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),(i=new se).setPointAndDir(r.position.x,r.position.y,r.position.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),void 0===(h=this.magoManager.globe.intersectionLineWgs84(i,h,s)))return;var u,f=new Ce(a.x,a.y,a.z),g=new Ce(h[0],h[1],h[2]);if((u=f.crossProduct(g,u)).unitary(),u.isNAN())return;var p=f.angleRadToVector(g);if(0===p||isNaN(p))return;n.copyPosDirUpFrom(r);var v=new B;v.rotationAxisAngRad(-p,u.x,u.y,u.z),n.transformByMatrix4(v),this.updateModelViewMatrixByCamera(n)}else if(1===this.magoManager.sceneState.mouseButton){r=e.strCamera;(n=this.magoManager.sceneState.camera).copyPosDirUpFrom(r);n.position,n.direction,n.up;var y,m=e.strWorldPoint;void 0===this.magoManager.globe&&(this.magoManager.globe=new F),y=this.magoManager.globe.normalAtCartesianPointWgs84(m.x,m.y,m.z,y);var x=n.getCameraRight(),b=(l=t.clientX,d=t.clientY,.003*(l-e.strX)),C=.003*(d-e.strY);if(0===b&&0===C)return;void 0===this.rotMatX&&(this.rotMatX=new B),void 0===this.rotMatZ&&(this.rotMatZ=new B),void 0===this.rotMat&&(this.rotMat=new B),this.rotMatX.rotationAxisAngRad(-C,x.x,x.y,x.z),this.rotMatZ.rotationAxisAngRad(-b,y[0],y[1],y[2]),this.rotMat=this.rotMatX.getMultipliedByMatrix(this.rotMatZ,this.rotMat);var A=new Ce(-m.x,-m.y,-m.z),M=new Ce(m.x,m.y,m.z);n.translate(A),n.transformByMatrix4(this.rotMat),n.translate(M),this.updateModelViewMatrixByCamera(n)}},he.prototype.keydown=function(t){console.log("keydown")};var ce=function(){if(!(this instanceof ce))throw new Error(j.CONSTRUCT_ERROR);this.vertexList,this.surfacesArray,this.color4,this.hedgesList,this.vboKeysContainer};ce.prototype.deleteObjects=function(t){if(void 0!==this.vertexList&&this.vertexList.deleteObjects(),void 0!==this.surfacesArray){for(var e=this.surfacesArray.length,i=0;i<e;i++)this.surfacesArray[i].deleteObjects(),this.surfacesArray[i]=void 0;this.surfacesArray=void 0}void 0!==this.hedgesList&&(this.hedgesList.deleteGlObjects(),this.hedgesList=void 0),void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},ce.prototype.deleteVbos=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},ce.prototype.newSurface=function(){void 0===this.surfacesArray&&(this.surfacesArray=[]);var t=new Ve;return this.surfacesArray.push(t),t},ce.prototype.getHalfEdgesList=function(){return void 0===this.hedgesList&&(this.hedgesList=new re),this.hedgesList},ce.prototype.getSurface=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray[t]},ce.prototype.addSurface=function(t){void 0!==t&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(t))},ce.prototype.mergeMesh=function(t){if(void 0!==t){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var e=t.getSurfacesCount(),i=0;i<e;i++)this.addSurface(t.getSurface(i));t.surfacesArray=void 0}},ce.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},ce.prototype.getCopySurfaceIndependentMesh=function(t){var e,i;void 0===t&&(t=new ce);for(var o=this.getSurfacesCount(),r=0;r<o;r++)e=this.getSurface(r),i=t.newSurface(),i=e.getCopyIndependentSurface(i);return t},ce.prototype.getTriangles=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getTriangles(t);return t},ce.prototype.getTrianglesConvex=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getTrianglesConvex(t);return t},ce.prototype.getNoRepeatedVerticesArray=function(t){var e,i,o;void 0===t&&(t=[]);for(var r,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){e=(o=this.getSurface(l)).getFacesCount();for(var d=0;d<e;d++){n=(i=o.getFace(d)).getVerticesCount();for(var h=0;h<n;h++)(r=i.getVertex(h)).setIdxInList(a),a++}}var c,u={};for(s=this.getSurfacesCount(),l=0;l<s;l++){e=(o=this.getSurface(l)).getFacesCount();for(d=0;d<e;d++){n=(i=o.getFace(d)).getVerticesCount();for(h=0;h<n;h++)u[(r=i.getVertex(h)).getIdxInList().toString()]=r}}for(var f in u)Object.prototype.hasOwnProperty.call(u,f)&&(c=u[f],t.push(c));return t},ce.prototype.getVertexList=function(){return void 0===this.vertexList&&(this.vertexList=new ze),this.vertexList},ce.prototype.rotate=function(t,e,i,o){var r=new B,n=new K,a=new Ce(e,i,o);a.unitary(),n.rotationAngDeg(t,a.x,a.y,a.z),r.rotationByQuaternion(n),this.transformByMatrix4(r)},ce.prototype.transformByMatrix4=function(t){void 0===this.vertexList&&(this.vertexList=new ze,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.transformPointsByMatrix4(t);this.calculateVerticesNormals(!0)},ce.prototype.translate=function(t,e,i){void 0===this.vertexList&&(this.vertexList=new ze,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.translateVertices(t,e,i)},ce.prototype.calculateVerticesNormals=function(t){for(var e=this.getSurfacesCount(),i=0;i<e;i++)this.getSurface(i).calculateVerticesNormals(t)},ce.prototype.calculateTexCoordsSpherical=function(){for(var t=new R,e=this.vertexList.getVertexCount(),i=0;i<e;i++){var o,r=this.vertexList.getVertex(i),n=(t=r.point3d.getSphericalCoords(t)).longitude/360;o=.5*(90+t.latitude)/90,void 0===r.texCoord&&(r.texCoord=new me(n,o))}},ce.prototype.setColor=function(t,e,i,o){for(var r=this.getSurfacesCount(),n=0;n<r;n++)this.getSurface(n).setColor(t,e,i,o)},ce.prototype.setOneColor=function(t,e,i,o){void 0===this.color4&&(this.color4=new x),this.color4.setRGBA(t,e,i,o)},ce.prototype.reverseSense=function(){for(var t=this.getSurfacesCount(),e=0;e<t;e++)this.getSurface(e).reverseSense();this.calculateVerticesNormals()},ce.prototype.getFrontierHalfEdges=function(t){for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getFrontierHalfEdges(t);return t},ce.prototype.getCopy=function(t){var e,i,o,r,n,a,s,l;void 0===this.vertexList&&(this.vertexList=new ze),void 0!==this.vertexList.vertexArray&&0!==this.vertexList.vertexArray.length||(this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),void 0===t&&(t=new ce),void 0===t.vertexList&&(t.vertexList=new ze),t.vertexList.copyFrom(this.vertexList),this.vertexList.setIdxInList(),t.vertexList.setIdxInList();for(var d=this.getSurfacesCount(),h=0;h<d;h++){e=this.getSurface(h),a=t.newSurface(),i=e.getFacesCount();for(var c=0;c<i;c++){o=e.getFace(c),s=a.newFace(),r=o.getVerticesCount();for(var u=0;u<r;u++)n=o.getVertex(u).getIdxInList(),l=t.vertexList.getVertex(n),s.addVertex(l)}}return t.calculateVerticesNormals(),t},ce.prototype.getTrianglesListsArrayBy2ByteSize=function(t,e){void 0===e&&(e=[]);var i=new je;if(e.push(i),3*(a=t.length)<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,t),e;var o=je.getNoRepeatedVerticesArray(t,void 0);if(o.length<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,t),e;ze.setIdxInList(o);for(var r,n=[],a=t.length,s=0;s<a;s++)(r=t[s]).vertex0.idxInList<65535&&r.vertex1.idxInList<65535&&r.vertex2.idxInList<65535?i.addTriangle(r):n.push(r);return n.length>0&&(e=this.getTrianglesListsArrayBy2ByteSize(n,e)),e},ce.prototype.render=function(t,e,i,o){var r=t.vboMemoryManager;if(void 0!==this.vboKeysContainer){var n,a=t.sceneState.gl;this.color4&&a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]);for(var s=this.vboKeysContainer.vboCacheKeysArray.length,l=0;l<s;l++){var d=this.vboKeysContainer.vboCacheKeysArray[l];if(!d.bindDataPosition(e,t.vboMemoryManager))return!1;if(d.vboBufferNor){if(!d.bindDataNormal(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(d.vboBufferCol){if(!d.bindDataColor(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.color4_loc);if(d.vboBufferTCoord){if(!d.bindDataTexCoord(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);if(!d.bindDataIndice(e,t.vboMemoryManager))return!1;n=o||a.TRIANGLES,a.drawElements(n,d.indicesCount,a.UNSIGNED_SHORT,0)}}else this.vboKeysContainer=this.getVbo(this.vboKeysContainer,r)},ce.prototype.getVbo=function(t,e){void 0===t&&(t=new ft);for(var i,o,r=this.getTriangles(void 0),n=(r.length,this.getTrianglesListsArrayBy2ByteSize(r,void 0)),a=n.length,s=0;s<a;s++){o=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();ze.setIdxInList(o),ze.getVboDataArrays(o,l,e),i.assignVerticesIdx(),je.getVboFaceDataArray(i.trianglesArray,l,e)}return t},ce.prototype.getVboTrianglesConvex=function(t,e){void 0===t&&(t=new ft);for(var i,o,r=this.getTrianglesConvex(void 0),n=(r.length,this.getTrianglesListsArrayBy2ByteSize(r,void 0)),a=n.length,s=0;s<a;s++){o=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();ze.setIdxInList(o),ze.getVboDataArrays(o,l,e),i.assignVerticesIdx(),je.getVboFaceDataArray(i.trianglesArray,l,e)}return t},ce.prototype.getVboEdges=function(t,e){if(void 0!==t){for(var i,o,r,n=this.getFrontierHalfEdges(void 0),a=n.length,s=2*a,l=new Float32Array(3*s),d=new Uint16Array(s),h=0,c=0;c<a;c++)o=(i=n[c]).startVertex,r=i.getEndVertex(),l[6*c]=o.point3d.x,l[6*c+1]=o.point3d.y,l[6*c+2]=o.point3d.z,l[6*c+3]=r.point3d.x,l[6*c+4]=r.point3d.y,l[6*c+5]=r.point3d.z,d[2*c]=h,h++,d[2*c+1]=h,h++;var u=t.newVBOVertexIdxCacheKey();u.setDataArrayPos(l,e),u.setDataArrayIdx(d,e)}};var ue=function(){if(!(this instanceof ue))throw new Error(j.CONSTRUCT_ERROR);this.mode=a.modelerMode.INACTIVE,this.drawingState=a.modelerDrawingState.NO_STARTED,this.drawingElement=a.modelerDrawingElement.NOTHING,this.planeGrid,this.polyLine2d,this.geoCoordsList,this.excavation,this.tunnel,this.basicFactorysArray,this.bSplineCubic3d,this.objectsArray};ue.prototype.newPipe=function(t){var e=t.interiorRadius,i=t.exteriorRadius,o=t.height,r=new Kt(e,i,o,t);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(r),r},ue.prototype.newBasicFactory=function(t,e,i,o){var r=new Ht(t,e,i,o);return r.bHasGround=!0,void 0===this.basicFactorysArray&&(this.basicFactorysArray=[]),this.basicFactorysArray.push(r),r},ue.getExtrudedSolidMesh=function(t,e,i,o,r,n,a){if(void 0!==t&&void 0!==e){var s=new Xe;s.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(t),void 0===o&&(o=new Ce(0,0,1));for(var d=e/i,h=0;h<i;h++){var c=s.newVtxProfile();c.copyFrom(l),c.translate(0,0,d*(h+1))}return(a=s.getMesh(a,r,n)).calculateVerticesNormals(),a}},ue.getExtrudedMesh=function(t,e,i,o,r,n,a){if(void 0!==t&&void 0!==e)return(a=ue.getExtrudedSolidMesh(t,e,i,o,void 0).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a},ue.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new D),this.geoCoordsList},ue.prototype.getExcavation=function(){return void 0===this.excavation&&(this.excavation=new ee),this.excavation},ue.prototype.getTunnel=function(){return void 0===this.tunnel&&(this.tunnel=new Ge),this.tunnel},ue.prototype.addPointToPolyline=function(t){void 0===this.polyLine2d&&(this.polyLine2d=new Pe),this.polyLine2d.newPoint2d(t.x,t.y)},ue.prototype.render=function(t,e,i,o){if(void 0!==this.objectsArray)for(var r=this.objectsArray.length,n=0;n<r;n++)this.objectsArray[n].render(t,e,i,o);if(void 0!==this.planeGrid&&this.planeGrid.render(t,e),void 0!==this.polyLine2d)this.polyLine2d.getPointsCount();if(void 0!==this.geoCoordsList&&this.geoCoordsList.renderPoints(t,e,i),void 0!==this.excavation&&this.excavation.renderPoints(t,e,i),void 0!==this.tunnel&&this.tunnel.renderPoints(t,e,i),void 0!==this.basicFactorysArray){var a=this.basicFactorysArray.length;for(n=0;n<a;n++)this.basicFactorysArray[n].render(t,e,i,o)}void 0!==this.bSplineCubic3d&&this.bSplineCubic3d.renderPoints(t,e,i)},ue.prototype.createPlaneGrid=function(t,e,i,o){void 0===t&&(t=500),void 0===e&&(e=500),void 0===i&&(i=50),void 0===o&&(o=50),void 0===this.planeGrid&&(this.planeGrid=new ye(t,e,i,o))};var fe=function(){if(!(this instanceof fe))throw new Error(j.CONSTRUCT_ERROR);this.vtxProfilesList,this.profile,this.vboKeyContainer,this.vboKeyContainerEdges};fe.prototype.deleteObjects=function(){this.profile&&this.profile.deleteObjects(),this.profile=void 0},fe.prototype.getVboKeysContainer=function(){return this.vboKeyContainer},fe.prototype.getMesh=function(t,e,i){return void 0===t&&(t=new ce),(t=this.vtxProfilesList.getMesh(t,e,i)).calculateVerticesNormals(),t},fe.prototype.getSurfaceIndependentMesh=function(t,e,i){return void 0===t&&(t=new ce),this.mesh=this.vtxProfilesList.getMesh(void 0,e,i),(t=this.mesh.getCopySurfaceIndependentMesh(t)).calculateVerticesNormals(),t},fe.prototype.revolve=function(t,e,i,o){if(void 0!==t){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Xe),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var r=this.vtxProfilesList.newVtxProfile();r.makeByProfile2D(t);var n=e/i,a=o.getLine(),s=new me(0,0),l=a.getProjectedPoint(s);l.inverse();var d=new B,h=new K,c=o.getDirection(),u=new Ce(c.x,c.y,0);u.unitary();for(var f=0;f<i;f++){h.rotationAngDeg(n*(f+1),u.x,u.y,u.z),d.rotationByQuaternion(h);var g=this.vtxProfilesList.newVtxProfile();g.copyFrom(r),g.translate(l.x,l.y,0),g.transformPointsByMatrix4(d),g.translate(-l.x,-l.y,0)}}},fe.prototype.extrude=function(t,e,i,o){if(void 0!==t&&void 0!==e){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Xe),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var r=this.vtxProfilesList.newVtxProfile();r.makeByProfile2D(t),void 0===o&&(o=new Ce(0,0,1));for(var n=e/i,a=0;a<i;a++){var s=this.vtxProfilesList.newVtxProfile();s.copyFrom(r),s.translate(0,0,n*(a+1))}}};var ge=function(t){if(!(this instanceof ge))throw new Error(j.CONSTRUCT_ERROR);this.geoCoordsList,void 0!==t&&(this.geoCoordsList=new D(t)),this.controlPointArmLength=.2,this.curvesArray,this.dirty=!0};ge.prototype.getTangent=function(t,e,i){if(this.dirty){void 0===this.curvesArray&&(this.curvesArray=[]);ge.insertPointsOnLargeSegments(this.geoCoordsList.geographicCoordsArray,.001,i);for(var o=this.geoCoordsList.geographicCoordsArray.length,r=0;r<o;r++){var n=this.geoCoordsList.geographicCoordsArray[r],a=n.getGeoLocationDataManager().newGeoLocationData("noName");a=Ai.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,void 0,void 0,void 0,a,i)}var s=new Jt;this.curvesArray.push(s),s.geoCoordsList=this.geoCoordsList,s.geoCoordsList.makeLines(i);var l=this.controlPointArmLength;s.makeControlPoints(l,i),this.dirty=!1}s=this.curvesArray[0];return e=Jt.getTangent(s,t,e)},ge.prototype.getGeoLocationDataManager=function(){if(void 0!==this.curvesArray&&0!==this.curvesArray.length){var t=this.curvesArray[0];if(void 0!==t)return t.knotPoints3dList.geoLocDataManager}},ge.insertPointsOnLargeSegments=function(t,e,i){if(void 0!==t)for(var o=t.length,r=0;r<o-1;r++){var n=t[r],a=t[r+1];if(R.getAngleBetweenCoords(n,a)>e){var s=R.getMidPoint(n,a,void 0);t.splice(r+1,0,s),o=t.length,r--}}};var pe=function(){if(!(this instanceof pe))throw new Error(j.CONSTRUCT_ERROR);this.position,this.radius},ve=function(t){if(!(this instanceof ve))throw new Error(j.CONSTRUCT_ERROR);this.pipeKnotsArray,this.dirty=!0};ve.make=function(){};var ye=function(t,e,i,o){if(!(this instanceof ye))throw new Error(j.CONSTRUCT_ERROR);this.geoLocDataManager,this.width,this.height,this.altitude=0,this.numCols,this.numRows,this.vboKeysContainer,this.setSize(t,e,i,o)};ye.prototype.setSize=function(t,e,i,o){void 0!==t&&(this.width=t),void 0!==e&&(this.height=e),void 0!==i&&(this.numCols=i),void 0!==o&&(this.numRows=o)},ye.prototype.render=function(t,e){if(void 0!==this.vboKeysContainer){var i=t.sceneState.gl,o=(t.vboMemoryManager,this.geoLocDataManager.getCurrentGeoLocationData());i.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,o.rotMatrix._floatArrays),i.uniform3fv(e.buildingPosHIGH_loc,o.positionHIGH),i.uniform3fv(e.buildingPosLOW_loc,o.positionLOW),i.uniform1i(e.refMatrixType_loc,0),i.uniform1i(e.hasAditionalMov_loc,!1),e.disableVertexAttribArray(e.texCoord2_loc),i.uniform1i(e.colorType_loc,0),i.uniform4fv(e.oneColor4_loc,[1,1,1,1]),i.uniform1i(e.bApplySpecularLighting_loc,!1),e.disableVertexAttribArrayAll();for(var r=this.vboKeysContainer.vboCacheKeysArray.length,n=0;n<r;n++){var a=this.vboKeysContainer.vboCacheKeysArray[n];if(void 0!==a.vboBufferPos&&!a.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==a.vboBufferNor){if(!vbo_vicky.bindDataNormal(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(void 0!==a.vboBufferCol){if(!vbo_vicky.bindDataColor(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.color4_loc);if(void 0!==a.vboBufferTCoord){if(!vbo_vicky.bindDataTexCoord(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);i.drawArrays(i.LINES,0,a.vertexCount)}}},ye.prototype.makeVbo=function(t){var e,i,o,r,n=this.width/2,a=this.height/2,s=this.altitude,l=new Ce(-n,-a,s),d=new Ce(n,-a,s),h=(new Ce(n,a,s),new Ce(-n,a,s)),c=this.width/(this.numCols-1),u=this.height/(this.numRows-1),f=2*this.numCols+2*this.numRows,g=new Float32Array(3*f),p=0;i=l.y,r=h.y;for(var v=0;v<this.numCols;v++)o=e=l.x+v*c,g[p]=e,g[++p]=i,g[++p]=s,g[++p]=o,g[++p]=r,g[++p]=s,p++;e=l.x,o=d.x;for(var y=0;y<this.numRows;y++)r=i=l.y+y*u,g[p]=e,g[++p]=i,g[++p]=s,g[++p]=o,g[++p]=r,g[++p]=s,p++;void 0===this.vboKeysContainer&&(this.vboKeysContainer=new ft),this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(g,t)};var me=function(t,e){if(!(this instanceof me))throw new Error(j.CONSTRUCT_ERROR);this.x=t||0,this.y=e||0,this.ownerVertex3d,this.associated};me.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},me.prototype.setAssociated=function(t){this.associated.x=t.x,this.associated.y=t.y},me.prototype.getAssociated=function(){return this.associated},me.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},me.prototype.inverse=function(){this.x=-this.x,this.y=-this.y},me.prototype.set=function(t,e){this.x=t,this.y=e},me.prototype.getX=function(){return this.x},me.prototype.getY=function(){return this.y},me.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},me.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},me.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t},me.prototype.squareDistToPoint=function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i},me.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},me.prototype.isCoincidentToPoint=function(t,e){var i=!1;return this.distToPoint(t)<e*e&&(i=!0),i},me.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new me),e.set(t.x-this.x,t.y-this.y),e},me.prototype.crossProduct=function(t){return this.x*t.y-t.x*this.y},me.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y},me.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),i=t.getModul();if(!(e<1e-9||i<1e-9))return Math.acos(this.scalarProduct(t)/(e*i))}},me.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}};var xe=function(){if(!(this instanceof xe))throw new Error(j.CONSTRUCT_ERROR);this.pointsArray};xe.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},xe.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},xe.prototype.newPoint=function(t,e){void 0===this.pointsArray&&(this.pointsArray=[]);var i=new me(t,e);return this.pointsArray.push(i),i},xe.prototype.getPoint=function(t){return this.pointsArray[t]},xe.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},xe.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},xe.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},xe.prototype.getIdxOfPoint=function(t){for(var e=this.pointsArray.length,i=0,o=-1,r=!1;!r&&i<e;)this.pointsArray[i]===t&&(r=!0,o=i),i++;return o},xe.prototype.getSegment=function(t,e){var i=this.getPoint(t),o=this.getNextIdx(t),r=this.getPoint(o);return void 0===e?e=new De(i,r):e.setPoints(i,r),e},xe.prototype.setIdxInList=function(){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].idxInList=e},xe.prototype.getCopy=function(t){var e;void 0===t?t=new xe:t.deleteObjects();for(var i=this.getPointsCount(),o=0;o<i;o++)e=this.getPoint(o),t.newPoint(e.x,e.y);return t},xe.prototype.getBoundingRectangle=function(t){var e=this.getPointsCount();if(0===e)return t;void 0===t&&(t=new Zt);for(var i=0;i<e;i++)0===i?t.setInit(this.getPoint(i)):t.addPoint(this.getPoint(i));return t},xe.prototype.getNearestPointIdxToPoint=function(t){if(void 0!==t){for(var e,i,o,r=this.getPointsCount(),n=0;n<r;n++)i=this.getPoint(n).squareDistToPoint(t),void 0===e?(e=n,o=i):i<o&&(e=n,o=i);return e}},xe.prototype.reverse=function(){void 0!==this.pointsArray&&this.pointsArray.reverse()},xe.prototype.getPointsIdxSortedByDistToPoint=function(t,e){if(void 0===this.pointsArray)return e;void 0===e&&(e=[]);for(var i,o,r,n,a,s,l=this.pointsArray,d=[],h=l.length,c=0;c<h;c++)(o=l[c])!==t&&(r=t.squareDistToPoint(o),(i={}).pointIdx=c,i.squaredDist=r,n=0,a=d.length-1,s=this.getIndexToInsertBySquaredDist(d,i,n,a),d.splice(s,0,i));e.length=0;var u=d.length;for(c=0;c<u;c++)e.push(d[c].pointIdx);return e},xe.prototype.getIndexToInsertBySquaredDist=function(t,e,i,o){var r=o-i;if(0===t.length)return 0;if(r<6){for(var n,a=!1,s=i;!a&&s<=o;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:o+1}var l,d,h=i+Math.floor(r/2);return t[h].squaredDist>e.squaredDist?(l=i,d=h):(l=h,d=o),this.getIndexToInsertBySquaredDist(t,e,l,d)},xe.getExpandedPoints=function(t,e,i,o,r){if(void 0!==t){void 0===e&&(e=[]);var n,a,s,l,d,h,c,u,f,g,p,v,y,m=[],x=[],b=t.length,C=new De(void 0,void 0),A=new De(void 0,void 0);if(void 0===r&&(r=!1),r)for(var M=0;M<b;M++);else{for(M=0;M<b;M++)if(l=t[M],0===(n=M)){d=t[a=bi.getNextIdx(n,b)],A.setPoints(l,d),y=(c=A.getLine(c)).getPerpendicularLeft();var P=new me(l.x+y.direction.x*i,l.y+y.direction.y*i);m.push(P);var T=new me(l.x-y.direction.x*o,l.y-y.direction.y*o);x.push(T)}else if(n===b-1){h=t[s=bi.getPrevIdx(n,b)],A.setPoints(h,l),y=(c=A.getLine(c)).getPerpendicularLeft();P=new me(l.x+y.direction.x*i,l.y+y.direction.y*i);m.push(P);T=new me(l.x-y.direction.x*o,l.y-y.direction.y*o);x.push(T)}else{a=bi.getNextIdx(n,b),s=bi.getPrevIdx(n,b),d=t[a],h=t[s],C.setPoints(h,l),A.setPoints(l,d),u=C.getLine(u),c=A.getLine(c),g=u.getParallelLeft(i),f=c.getParallelLeft(i);P=g.intersectionWithLine(f,void 0);m.push(P),v=u.getParallelRight(o),p=c.getParallelRight(o);T=v.intersectionWithLine(p,void 0);x.push(T)}m.reverse(),e=m.concat(x)}return e}};var be,Ce=function(t,e,i){if(!(this instanceof Ce))throw new Error(i18next.t("error.construct.create"));this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.pointType};Ce.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},Ce.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z},Ce.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Ce.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Ce.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t,this.z/=t},Ce.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},Ce.prototype.crossProduct=function(t,e){return void 0===e&&(e=new Ce),e.x=this.y*t.z-t.y*this.z,e.y=t.x*this.z-this.x*t.z,e.z=this.x*t.y-t.x*this.y,e},Ce.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},Ce.prototype.getSphericalCoords=function(t){void 0===t&&(t=new R);var e=new me(this.x,this.y),i=new me(1,0),o=e.angleDegToVector(i);this.y<0&&(o=360-o);var r=e.getModul(),n=180*Math.atan(this.z/r)/Math.PI;return this.z<0&&(n*=-1),t.longitude=o,t.latitude=n,t},Ce.prototype.getRelativeOrientationToVector=function(t,e){var i=this.angleRadToVector(t);return i<e?0:Math.abs(Math.PI-i)<e?1:2},Ce.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),i=t.getModul();if(!(e<1e-9||i<1e-9))return Math.acos(this.scalarProduct(t)/(e*i))}},Ce.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}},Ce.prototype.squareDistToPoint=function(t){var e=this.x-t.x,i=this.y-t.y,o=this.z-t.z;return e*e+i*i+o*o},Ce.prototype.isCoincidentToPoint=function(t,e){var i=!1;return this.distToPoint(t)<e*e&&(i=!0),i},Ce.prototype.squareDistTo=function(t,e,i){var o=this.x-t,r=this.y-e,n=this.z-i;return o*o+r*r+n*n},Ce.prototype.distTo=function(t,e,i){return Math.sqrt(this.squareDistTo(t,e,i))},Ce.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},Ce.prototype.distToSphere=function(t){return Math.sqrt(this.squareDistToPoint(t.centerPoint))-t.r},Ce.prototype.aproxDistTo=function(t,e){var i,o,r,n,a=Math.abs(this.x-t.x),s=Math.abs(this.y-t.y),l=Math.abs(this.z-t.z);return a>s?a>l?(o=s/(i=a),r=l/(n=i*e[Math.floor(10*o)]),n*e[Math.floor(10*r)]):(o=a/(i=l),r=s/(n=i*e[Math.floor(10*o)]),n*e[Math.floor(10*r)]):s>l?(o=a/(i=s),r=l/(n=i*e[Math.floor(10*o)]),n*e[Math.floor(10*r)]):(o=a/(i=l),r=s/(n=i*e[Math.floor(10*o)]),n*e[Math.floor(10*r)])},Ce.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new Ce),e.set(t.x-this.x,t.y-this.y,t.z-this.z),e},Ce.prototype.set=function(t,e,i){this.x=t,this.y=e,this.z=i},Ce.prototype.add=function(t,e,i){this.x+=t,this.y+=e,this.z+=i},Ce.prototype.addPoint=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},Ce.prototype.scale=function(t){this.x*=t,this.y*=t,this.z*=t},(be=function(){if(!(this instanceof be))throw new Error(j.CONSTRUCT_ERROR);this.points3dArray}).prototype.newPoint3D=function(t,e,i){void 0===this.points3dArray&&(this.points3dArray=[]);var o=new Ce(t,e,i);return this.points3dArray.push(o),o},be.prototype.addPoint3D=function(t){void 0===this.points3dArray&&(this.points3dArray=[]),this.points3dArray.push(t)},be.calculateBBox=function(t,e){if(void 0!==t){var i=t.length;if(0!==i){void 0===e&&(e=new u),e.init(t[0]);for(var o=1;o<i;o++)e.addPoint(t[o]);return e}}},(be=function(t){if(!(this instanceof be))throw new Error(j.CONSTRUCT_ERROR);this.pointsArray,void 0!==t&&(this.pointsArray=t),this.bLoop,this.geoLocDataManager,this.vboKeysContainer}).prototype.deleteObjects=function(t){this.deletePoints3d(),this.deleteVboKeysContainer(t),void 0!==this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0)},be.prototype.deleteVboKeysContainer=function(t){if(void 0!==this.vboKeysContainer){var e=t.sceneState.gl;this.vboKeysContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeysContainer=void 0}},be.prototype.deletePoints3d=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},be.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},be.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new O);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},be.prototype.addPoint3dArray=function(t){void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push.apply(this.pointsArray,t)},be.prototype.newPoint=function(t,e,i){void 0===this.pointsArray&&(this.pointsArray=[]);var o=new Ce(t,e,i);return this.pointsArray.push(o),o},be.prototype.getPoint=function(t){return this.pointsArray[t]},be.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},be.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},be.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},be.prototype.getSegment3D=function(t,e,i){void 0===i&&(i=!1);var o=this.getPointsCount();if(i||t!==o-1){var r=this.getPoint(t),n=this.getNextIdx(t),a=this.getPoint(n);return void 0===e?e=new Ie(r,a):e.setPoints(r,a),e}},be.prototype.getTangentLine3D=function(t,e,i){void 0===e&&(e=new se);var o=this.getPoint(t),r=this.getBisectionPlane(t,void 0,i).getNormal();return e.setPointAndDir(o.x,o.y,o.z,r.x,r.y,r.z),e},be.prototype.getBisectionPlane=function(t,e,i){void 0===i&&(i=!1);var o=this.getPointsCount();if(o<1)return e;void 0===e&&(e=new X);var r,n,a=this.getPoint(t);if(i){s=this.getPrevIdx(t);r=this.getSegment3D(t,void 0,i),n=this.getSegment3D(s,void 0,i)}else if(t===o-1){var s=t-1;r=this.getSegment3D(s,void 0,i),n=this.getSegment3D(s,void 0,i)}else if(0===t)r=this.getSegment3D(t,void 0,i),n=this.getSegment3D(t,void 0,i);else{var s=t-1;r=this.getSegment3D(t,void 0,i),n=this.getSegment3D(s,void 0,i)}var l=r.getDirection(),d=n.getDirection();return l.addPoint(d),l.unitary,e.setPointAndNormal(a.x,a.y,a.z,l.x,l.y,l.z),e},be.prototype.makeVbo=function(t){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new ft);for(var e,i=this.pointsArray.length,o=new Float32Array(3*i),r=0;r<i;r++)e=this.pointsArray[r],o[3*r]=e.x,o[3*r+1]=e.y,o[3*r+2]=e.z;this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(o,t.vboMemoryManager)},be.prototype.renderLines=function(t,e,i,o,r){if(void 0===this.pointsArray)return!1;var n=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()){if(e.enableVertexAttribArray(e.position3_loc),void 0===r&&(r=!0),r?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),2===i){var a=t.selectionManager,s=t.selectionColor,l=s.getAvailableColor(void 0),d=s.decodeColor3(l.r,l.g,l.b);a.setCandidateGeneral(d,this),n.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}var h=this.vboKeysContainer.vboCacheKeysArray[0];if(!h.bindDataPosition(e,t.vboMemoryManager))return!1;n.drawArrays(n.LINE_STRIP,0,h.vertexCount),n.enable(n.DEPTH_TEST)}else this.makeVbo(t)},be.prototype.renderPoints=function(t){};var Ae=function(t,e,i,o){if(!(this instanceof Ae))throw new Error(j.CONSTRUCT_ERROR);this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==o?o:0,this.pointType},Me=function(){if(!(this instanceof Me))throw new Error(j.CONSTRUCT_ERROR);this.point2dList,this.normal,this.convexPolygonsArray,this.bRect};Me.prototype.deleteObjects=function(){void 0!==this.point2dList&&(this.point2dList.deleteObjects(),this.point2dList=void 0),this.normal=void 0},Me.prototype.getBoundingRectangle=function(t){return void 0===this.point2dList?t:t=this.point2dList.getBoundingRectangle(t)},Me.prototype.getEdgeDirection=function(t){return this.point2dList.getSegment(t).getDirection(void 0)},Me.prototype.getEdgeVector=function(t){return this.point2dList.getSegment(t).getVector(void 0)},Me.prototype.reverseSense=function(){void 0!==this.point2dList&&this.point2dList.reverse()},Me.prototype.getCopy=function(t){return void 0===this.point2dList?t:(void 0===t&&(t=new Me),void 0===t.point2dList&&(t.point2dList=new xe),t.point2dList=this.point2dList.getCopy(t.point2dList),this.normal&&(t.normal=this.normal),t)},Me.prototype.calculateNormal=function(t){void 0===t&&(t=[]),this.normal=0;for(var e=this.point2dList.getPointsCount(),i=0;i<e;i++){this.point2dList.getPoint(i);var o=this.point2dList.getPrevIdx(i),r=this.getEdgeDirection(o),n=this.getEdgeDirection(i),a=r.crossProduct(n,a),s=r.scalarProduct(n);if(a<0)a=-1,t.push(i);else{if(!(a>0))continue;a=1}var l=s,d=Math.acos(l);this.normal+=a*d}return this.normal>0?this.normal=1:this.normal=-1,t},Me.prototype.tessellate=function(t,e){var i=t.length;if(0===i)return e.push(this),e;for(var o,r=!1,n=0;!r&&n<i;){var a=t[n],s=this.point2dList.getPoint(a),l=[];this.getPointsIdxSortedByDistToPoint(s,l);for(var d=l.length,h=0;!r&&h<d;)if(o=l[h],this.point2dList.getPrevIdx(a)!==o&&this.point2dList.getNextIdx(a)!==o){var c=new De(this.point2dList.getPoint(a),this.point2dList.getPoint(o));if(this.intersectionWithSegment(c))h++;else{var u=this.splitPolygon(a,o);if(u.length<2)h++;else{var f=u[0],g=u[1],p=f.calculateNormal(),v=g.calculateNormal(),y=f.normal,m=g.normal;y===this.normal&&m===this.normal&&(r=!0,p.length>0?e=f.tessellate(p,e):(void 0===e&&(e=[]),e.push(f)),v.length>0?e=g.tessellate(v,e):(void 0===e&&(e=[]),e.push(g))),h++}}}else h++;n++}return e},Me.prototype.intersectionWithSegment=function(t){if(void 0!==this.bRect){var e=t.getBoundaryRectangle(e);if(!this.bRect.intersectsWithRectangle(e))return!1}for(var i,o=this.point2dList.getPointsCount(),r=0;r<o;r++){if(i=this.point2dList.getSegment(r,i),!t.sharesPointsWithSegment(i))if(t.intersectionWithSegment(i,1e-7)===s.INTERSECTION_INTERSECT)return!0}return!1},Me.prototype.splitPolygon=function(t,e,i){void 0===i&&(i=[]);var o=new Me;o.point2dList=new xe,o.point2dList.pointsArray=[],o.point2dList.pointsArray.push(this.point2dList.getPoint(t)),o.point2dList.pointsArray.push(this.point2dList.getPoint(e));for(var r=!1,n=e,a=t,s=0,l=this.point2dList.getPointsCount();!r&&s<l;){(h=this.point2dList.getNextIdx(n))===a?r=!0:(o.point2dList.pointsArray.push(this.point2dList.getPoint(h)),n=h),s++}i.push(o);var d=new Me;for(d.point2dList=new xe,d.point2dList.pointsArray=[],d.point2dList.pointsArray.push(this.point2dList.getPoint(e)),d.point2dList.pointsArray.push(this.point2dList.getPoint(t)),r=!1,n=t,a=e,s=0;!r&&s<l;){var h;(h=this.point2dList.getNextIdx(n))===a?r=!0:(d.point2dList.pointsArray.push(this.point2dList.getPoint(h)),n=h),s++}return i.push(d),i},Me.prototype.getPointsIdxSortedByDistToPoint=function(t,e){return void 0===e&&(e=[]),e=this.point2dList.getPointsIdxSortedByDistToPoint(t,e)},Me.prototype.getTrianglesConvexPolygon=function(t){void 0===t&&(t=[]);var e,i=this.point2dList.getPointsCount();if(i<3)return t;for(var o=1;o<i-1;o++){e=new Be;var r=this.point2dList.getPoint(0).idxInList,n=this.point2dList.getPoint(o).idxInList,a=this.point2dList.getPoint(o+1).idxInList;e.vtxIdx0=r,e.vtxIdx1=n,e.vtxIdx2=a,t.push(e)}return t},Me.prototype.getVbo=function(t){void 0===t&&(t=new ut);var e,i,o=[],r=[];i=this.normal>0?1:-1;for(var n=this.point2dList.getPointsCount(),a=0;a<n;a++)e=this.point2dList.getPoint(a),o.push(e.x),o.push(e.y),o.push(0),r.push(0),r.push(0),r.push(255*i);t.posVboDataArray=Float32Array.from(o),t.norVboDataArray=Int8Array.from(r),this.point2dList.setIdxInList();var s=[],l=this.convexPolygonsArray.length;for(a=0;a<l;a++){s=this.convexPolygonsArray[a].getTrianglesConvexPolygon(s)}return je.getVboFaceDataArray(s,t),t},Me.getVbo=function(t,e,i){void 0===i&&(i=new ut);var o,r,n=[],a=[];r=t.normal>0?1:-1;for(var s=t.point2dList.getPointsCount(),l=0;l<s;l++)o=t.point2dList.getPoint(l),n.push(o.x),n.push(o.y),n.push(0),a.push(0),a.push(0),a.push(255*r);i.posVboDataArray=Float32Array.from(n),i.norVboDataArray=Int8Array.from(a),t.point2dList.setIdxInList();var d=[],h=e.length;for(l=0;l<h;l++){d=e[l].getTrianglesConvexPolygon(d)}return je.getVboFaceDataArray(d,i),i};var Pe=function(){if(!(this instanceof Pe))throw new Error(j.CONSTRUCT_ERROR);this.point2dArray};Pe.prototype.newPoint2d=function(t,e){void 0===this.point2dArray&&(this.point2dArray=[]);var i=new me(t,e);return this.point2dArray.push(i),i},Pe.prototype.getPointsCount=function(){return void 0===this.point2dArray?0:this.point2dArray.length},Pe.prototype.deleteObjects=function(){for(var t=this.point2dArray.length,e=0;e<t;e++)this.point2dArray[e].deleteObjects(),this.point2dArray[e]=void 0;this.point2dArray=void 0},Pe.prototype.getPoints=function(t){var e;void 0===t&&(t=[]);for(var i=t.length,o=this.point2dArray.length,r=0;r<o;r++)if(0===r)if(i>0){var n=t[i-1],a=this.point2dArray[r];n.isCoincidentToPoint(a,1e-7)||((e=new me).copyFrom(this.point2dArray[r]),e.pointType=1,t.push(e))}else(e=new me).copyFrom(this.point2dArray[r]),e.pointType=1,t.push(e);else(e=new me).copyFrom(this.point2dArray[r]),e.pointType=1,t.push(e);return t};var Te=function(){if(!(this instanceof Te))throw new Error(j.CONSTRUCT_ERROR);this.point3dArray,this.geoLocDataManager,this.vboKeysContainer};Te.prototype.newPoint3d=function(t,e,i){void 0===this.point3dArray&&(this.point3dArray=[]);var o=new Ce(t,e,i);return this.point3dArray.push(o),o},Te.prototype.addPoint3dArray=function(t){void 0!==t&&(void 0===this.point3dArray&&(this.point3dArray=[]),this.point3dArray.push.apply(this.point3dArray,t))},Te.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new O);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},Te.prototype.makeVbo=function(t){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new ft);for(var e,i=this.point3dArray.length,o=new Float32Array(3*i),r=0;r<i;r++)e=this.point3dArray[r],o[3*r]=e.x,o[3*r+1]=e.y,o[3*r+2]=e.z;this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(o,t.vboMemoryManager)},Te.prototype.renderLines=function(t,e,i,o,r){if(void 0===this.point3dArray)return!1;var n=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()||this.makeVbo(t),e.enableVertexAttribArray(e.position3_loc),n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),void 0===r&&(r=!0),r?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),2===i){var a=t.selectionManager,s=t.selectionColor,l=s.getAvailableColor(void 0),d=s.decodeColor3(l.r,l.g,l.b);a.setCandidateGeneral(d,this),n.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}var h=this.vboKeysContainer.vboCacheKeysArray[0];if(!h.bindDataPosition(e,t.vboMemoryManager))return!1;n.drawArrays(n.LINE_STRIP,0,h.vertexCount),n.enable(n.DEPTH_TEST)},Te.prototype.renderPoints=function(t){};var _e=function(){if(!(this instanceof _e))throw new Error(j.CONSTRUCT_ERROR);this.outerRing,this.innerRingsList};_e.prototype.newOuterRing=function(){return void 0===this.outerRing?this.outerRing=new Re:this.outerRing.deleteObjects(),this.outerRing},_e.prototype.newInnerRing=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new Le),this.innerRingsList.newRing()},_e.prototype.getInnerRingsList=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new Le),this.innerRingsList},_e.prototype.deleteObjects=function(){this.outerRing&&(this.outerRing.deleteObjects(),this.outerRing=void 0),this.innerRingsList&&(this.innerRingsList.deleteObjects(),this.innerRingsList=void 0)},_e.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},_e.prototype.getVBO=function(t){if(void 0===this.outerRing)return t;this.getGeneralPolygon(void 0).getVbo(t)},_e.prototype.getConvexFacesIndicesData=function(t){if(void 0===this.outerRing)return resultVbo;var e,i,o,r,n,a,s=this.getGeneralPolygon(void 0);if(void 0===t&&(t=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),d=0;d<l;d++){this.innerRingsList.getRing(d).polygon.point2dList.setIdxInList()}var h=s.convexPolygonsArray.length;for(d=0;d<h;d++){e=[];for(var c=(i=s.convexPolygonsArray[d]).point2dList.getPointsCount(),u=0;u<c;u++)r=(o=(a=i.point2dList.getPoint(u)).indexData).owner,o.idxInList=a.idxInList,n=r===this.outerRing?-1:this.innerRingsList.getRingIndex(r),o.ownerIdx=n,e.push(o);t.push(e)}return t},_e.prototype.getGeneralPolygon=function(t){if(this.checkNormals(),this.hasHoles())t=this.tessellateHoles(t);else{void 0===t&&(t=new Me),void 0===t.point2dList&&(t.point2dList=new xe);for(var e=this.outerRing.polygon,i=e.point2dList.getPointsCount(),o=0;o<i;o++)e.point2dList.getPoint(o),t.point2dList.addPoint(e.point2dList.getPoint(o))}t.convexPolygonsArray=[];var r=t.calculateNormal(r);return t.convexPolygonsArray=t.tessellate(r,t.convexPolygonsArray),t},_e.prototype.eliminateHolePolygonBySplitPoints=function(t,e,i,o,r){void 0===r&&(r=new Me),void 0===r.point2dList&&(r.point2dList=new xe);for(var n,a=t.point2dList.getPointsCount(),s=!1,l=0,d=i;!s&&l<a;)n=t.point2dList.getPoint(d),r.point2dList.addPoint(n),(d=t.point2dList.getNextIdx(d))===i&&(s=!0,n=t.point2dList.getPoint(d),r.point2dList.addPoint(n)),l++;var h,c=e.point2dList.getPointsCount();for(s=!1,l=0,d=o;!s&&l<c;)h=e.point2dList.getPoint(d),r.point2dList.addPoint(h),(d=e.point2dList.getNextIdx(d))===o&&(s=!0,h=e.point2dList.getPoint(d),r.point2dList.addPoint(h)),l++;return r},_e.prototype.eliminateHolePolygon=function(t,e,i,o){for(var r,n,a=[],s=e.polygon,l=s.point2dList.getPoint(i),d=(a=t.getPointsIdxSortedByDistToPoint(l,a)).length,h=new De,c=!1,u=0;!c&&u<d;)r=a[u],n=t.point2dList.getPoint(r),h.setPoints(n,l),t.intersectionWithSegment(h)||s.intersectionWithSegment(h)?u++:(o=this.eliminateHolePolygonBySplitPoints(t,s,r,i,o),c=!0,u++);return!!c},_e.prototype.tessellateHoles=function(t){if(void 0===this.outerRing)return t;if(!this.hasHoles())return t;var e,i,o,r,n,a;void 0===t&&(t=new Me);var s=this.outerRing;void 0===s.polygon&&s.makePolygon();for(var l=s.polygon,d=l.calculateNormal(d),h=[],c=this.innerRingsList.getRingsCount(),u=0;u<c;u++)h.push(this.innerRingsList.getRing(u));var f=new Me,g=new Me;g.point2dList=new xe;var p=l.point2dList.getPointsCount();for(u=0;u<p;u++)l.point2dList.getPoint(u),g.point2dList.addPoint(l.point2dList.getPoint(u));for(var v=new me,y=[],m=(c=h.length,u=0,!1);!m&&u<c;){if(a=Le.getBoundingRectangle(h,a),v.set(a.minX,a.minY),y.length=0,e=(r=(y=Le.getSortedRingsByDistToPoint(v,h,y))[0]).ring,i=r.ringIdx,o=e.polygon,n=r.pointIdx,o.calculateNormal(),this.eliminateHolePolygon(g,e,n,f)){if(g=f,1===h.length){m=!0;break}h.splice(i,1),f=new Me}u++}return t=g},_e.prototype.checkNormals=function(){if(void 0!==this.outerRing){var t=this.outerRing;void 0===t.polygon&&t.makePolygon();var e=t.polygon,i=e.calculateNormal(i),o=e.normal;if(void 0!==this.innerRingsList)for(var r,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(r=this.innerRingsList.getRing(a)).polygon&&r.makePolygon(),(s=r.polygon).calculateNormal(),(l=s.normal)===o&&(s.reverseSense(),s.normal=-l)}}},_e.prototype.TEST__setFigure_1=function(){var t,e,i,o=this.newOuterRing();(t=o.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=o.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(i=this.newInnerRing().newElement("RECTANGLE")).setCenterPosition(3,3),i.setDimensions(2,2)},_e.prototype.TEST__setFigure_2holes=function(){var t,e,i,o,r=this.newOuterRing();(t=r.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=r.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24;var n=this.newInnerRing();(o=n.newElement("RECTANGLE")).setCenterPosition(3,3),o.setDimensions(2,2),(i=(n=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(7,3),i.setRadius(1)},_e.prototype.TEST__setFigureHole_2=function(){var t,e,i,o,r,n=this.newOuterRing();(t=n.newElement("POLYLINE")).newPoint2d(-13,3),t.newPoint2d(-13,-11),(e=n.newElement("ARC")).setCenterPosition(-8,-11),e.setRadius(5),e.setStartAngleDegree(180),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-8,-16),t.newPoint2d(-5,-16),t.newPoint2d(-3,-15),t.newPoint2d(-3,-14),t.newPoint2d(-5,-12),t.newPoint2d(-3,-11),t.newPoint2d(-2,-9),t.newPoint2d(3,-9),(e=n.newElement("ARC")).setCenterPosition(9,-9),e.setRadius(6),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(15,-9),t.newPoint2d(16,-9),t.newPoint2d(16,4),(e=n.newElement("ARC")).setCenterPosition(11,4),e.setRadius(5),e.setStartAngleDegree(0),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(11,9),t.newPoint2d(4,9),(e=n.newElement("ARC")).setCenterPosition(4,11),e.setRadius(2),e.setStartAngleDegree(-90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(4,13),t.newPoint2d(9,13),(e=n.newElement("ARC")).setCenterPosition(9,14.5),e.setRadius(1.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(9,16),t.newPoint2d(2,16),t.newPoint2d(0,14),t.newPoint2d(-4,16),t.newPoint2d(-9,16),(e=n.newElement("ARC")).setCenterPosition(-9,14),e.setRadius(2),e.setStartAngleDegree(90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-9,12),t.newPoint2d(-6,12),(e=n.newElement("ARC")).setCenterPosition(-6,10.5),e.setRadius(1.5),e.setStartAngleDegree(90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-6,9),t.newPoint2d(-7,9),(e=n.newElement("ARC")).setCenterPosition(-7,3),e.setRadius(6),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24;var a=this.newInnerRing();(t=a.newElement("POLYLINE")).newPoint2d(-9,3),t.newPoint2d(-10,-4),t.newPoint2d(-10,-8),t.newPoint2d(-8,-11),t.newPoint2d(-3,-7),t.newPoint2d(4,-7),(e=a.newElement("ARC")).setCenterPosition(8,-7),e.setRadius(4),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=a.newElement("POLYLINE")).newPoint2d(12,-7),t.newPoint2d(12,-4),t.newPoint2d(8,-10),t.newPoint2d(4,-5),t.newPoint2d(-8,-5),t.newPoint2d(-7,4),t.newPoint2d(9,4),t.newPoint2d(9,-5),t.newPoint2d(14,2),t.newPoint2d(13,2),t.newPoint2d(11,0),t.newPoint2d(11,7),t.newPoint2d(13,8),t.newPoint2d(5,8),t.newPoint2d(9,6),t.newPoint2d(-6,6),(e=a.newElement("ARC")).setCenterPosition(-6,3),e.setRadius(3),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-10,-13),i.setRadius(1),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-6.5,-14),r.setRadiusCount(5),r.setInteriorRadius(.6),r.setExteriorRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-9,14),r.setRadiusCount(6),r.setInteriorRadius(.5),r.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("RECTANGLE")).setCenterPosition(-4.5,1.5),o.setDimensions(3,3),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-4.5,-2.5),i.setRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(0,0),r.setRadiusCount(5),r.setInteriorRadius(1),r.setExteriorRadius(2.5),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-6,14),i.setRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-1.5,11),r.setRadiusCount(12),r.setInteriorRadius(.6),r.setExteriorRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(13.5,5),r.setRadiusCount(25),r.setInteriorRadius(.4),r.setExteriorRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(9,-13),r.setRadiusCount(10),r.setInteriorRadius(.4),r.setExteriorRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(5.5,1.5),r.setRadiusCount(7),r.setInteriorRadius(.7),r.setExteriorRadius(2)};var we=function(){if(!(this instanceof we))throw new Error(j.CONSTRUCT_ERROR);this.profilesArray,this.auxiliarAxis};we.prototype.newProfile=function(){void 0===this.profilesArray&&(this.profilesArray=[]);var t=new _e;return this.profilesArray.push(t),t},we.prototype.deleteObjects=function(){if(this.profilesArray){for(var t=this.profilesArray.length,e=0;e<t;e++)this.profilesArray[e].deleteObjects(),this.profilesArray=void 0;this.profilesArray=void 0}};var Se=function(){if(!(this instanceof Se))throw new Error(j.CONSTRUCT_ERROR);this.centerPoint,this.width,this.height,this.minX,this.minY,this.maxX,this.maxY};Se.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new me),this.centerPoint.set(t,e)},Se.prototype.setExtension=function(t,e,i,o){this.minX=t,this.minY=e,this.maxX=i,this.maxY=o},Se.prototype.setDimensions=function(t,e){this.width=t,this.height=e},Se.prototype.getCenterPosition=function(){return this.centerPoint},Se.prototype.getWidth=function(){return this.width},Se.prototype.getHeight=function(){return this.height},Se.prototype.getMaxPoint=function(t){return void 0===t&&(t=new me),t.set(this.maxX,this.maxY),t},Se.prototype.getMinPoint=function(t){return void 0===t&&(t=new me),t.set(this.minX,this.minY),t},Se.prototype.getPoints=function(t){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return t;var e;void 0===t&&(t=[]);var i=this.width/2,o=this.height/2;return(e=new me(this.centerPoint.x-i,this.centerPoint.y-o)).pointType=1,t.push(e),(e=new me(this.centerPoint.x+i,this.centerPoint.y-o)).pointType=1,t.push(e),(e=new me(this.centerPoint.x+i,this.centerPoint.y+o)).pointType=1,t.push(e),(e=new me(this.centerPoint.x-i,this.centerPoint.y+o)).pointType=1,t.push(e),t};var Re=function(){if(!(this instanceof Re))throw new Error(j.CONSTRUCT_ERROR);this.elemsArray=[],this.polygon=void 0};Re.prototype.getElement=function(t){return 0===this.elemsArray.length?null:this.elemsArray[t]},Re.prototype.deleteObjects=function(){for(var t=0,e=this.elemsArray.length;t<e;t++)this.elemsArray[t].deleteObjects();this.elemsArray=[],void 0!==this.polygon&&this.polygon.deleteObjects(),this.polygon=void 0},Re.prototype.addElement=function(t){this.elemsArray.push(t)},Re.prototype.newElement=function(t){var e=void 0;return"ARC"===t?e=new Yt:"CIRCLE"===t?e=new $t:"POLYLINE"===t?e=new Pe:"RECTANGLE"===t?e=new Se:"STAR"===t&&(e=new Oe),this.elemsArray.push(e),e},Re.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},Re.prototype.getPolygon=function(t){var e;void 0===t&&(t=new Me),void 0===t.point2dList&&(t.point2dList=new xe),t.point2dList.deleteObjects(),t.point2dList.pointsArray=this.getPoints(t.point2dList.pointsArray);for(var i=t.point2dList.getPointsCount(),o=0;o<i;o++)(e=t.point2dList.getPoint(o)).indexData=new ne,e.indexData.owner=this;return t},Re.prototype.getPoints=function(t){void 0===t&&(t=[]);for(var e=0,i=this.elemsArray.length;e<i;e++)this.elemsArray[e].getPoints(t);var o=t.length;if(o>1){var r=t[0],n=t[o-1];n.pointType=1,r.isCoincidentToPoint(n,1e-7)&&((n=t.pop()).deleteObjects(),n=void 0)}return t};var Le=function(){if(!(this instanceof Le))throw new Error(j.CONSTRUCT_ERROR);this.ringsArray=[],this.idxInList};Le.prototype.newRing=function(){var t=new Re;return this.ringsArray.push(t),t},Le.prototype.addRing=function(t){this.ringsArray.push(t)},Le.prototype.deleteObjects=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].deleteObjects(),this.ringsArray[t]=void 0;this.ringsArray=[]},Le.prototype.getRingsCount=function(){return this.ringsArray.length},Le.prototype.getRingIndex=function(t){return this.ringsArray.indexOf(t)},Le.prototype.getRing=function(t){return this.ringsArray[t]},Le.getBoundingRectangle=function(t,e){var i,o;void 0===e&&(e=new Zt);for(var r=0,n=t.length;r<n;r++)void 0!==(i=t[r]).polygon&&(o=i.polygon.getBoundingRectangle(o),e.addRectangle(o));return e},Le.prototype.setIdxInList=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].idxInList=t},Le.prototype.intersectionWithSegment=function(t){if(void 0===t)return!1;for(var e=0,i=!1,o=this.getRingsCount();!i&&e<o;)this.ringsArray[e].intersectionWithSegment(t)&&(i=!0),e++;return i},Le.getSortedRingsByDistToPoint=function(t,e,i){if(void 0===t)return i;void 0===i&&(i=[]);for(var o,r,n,a,s,l,d,h=[],c=0,u=e.length;c<u;c++)r=(o=e[c]).polygon.point2dList.getNearestPointIdxToPoint(t),n=o.polygon.point2dList.getPoint(r).squareDistToPoint(t),(a={}).ring=o,a.ringIdx=c,a.pointIdx=r,a.squaredDist=n,s=0,l=h.length-1,d=Le.getIndexToInsertBySquaredDist(h,a,s,l),h.splice(d,0,a);for(c=0,u=h.length;c<u;c++)i.push(h[c]);return i},Le.getIndexToInsertBySquaredDist=function(t,e,i,o){var r=o-i;if(0===t.length)return 0;if(r<6){for(var n,a=!1,s=i;!a&&s<=o;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:o+1}var l,d,h=i+Math.floor(r/2);return t[h].squaredDist>e.squaredDist?(l=i,d=h):(l=h,d=o),this.getIndexToInsertBySquaredDist(t,e,l,d)},Le.getBinarySearchIndex=function(t,e,i){var o=0,r=t.length-1;for(i=i||function(t){return t};o<=r;){var n=Math.floor((o+r)/2);i(t[n])<i(e)?o=n+1:r=n-1}return o};var De=function(t,e){if(!(this instanceof De))throw new Error(j.CONSTRUCT_ERROR);this.startPoint2d,this.endPoint2d,t&&(this.startPoint2d=t),e&&(this.endPoint2d=e)};De.prototype.setPoints=function(t,e){void 0!==t&&(this.startPoint2d=t),void 0!==e&&(this.endPoint2d=e)},De.prototype.getVector=function(t){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===t&&(t=new me),t=this.startPoint2d.getVectorToPoint(this.endPoint2d,t)},De.prototype.getDirection=function(t){return void 0===t&&(t=new me),(t=this.getVector(t)).unitary(),t},De.prototype.getBoundaryRectangle=function(t){return void 0===t&&(t=new BoundaryRectangle),t.setInit(this.startPoint2d),t.addPoint(this.endPoint2d),t},De.prototype.getLine=function(t){void 0===t&&(t=new le);var e=this.getDirection(),i=this.startPoint2d;return t.setPointAndDir(i.x,i.y,e.x,e.y),t},De.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},De.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},De.prototype.intersectionWithPointByDistances=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.startPoint2d.distToPoint(t),o=this.endPoint2d.distToPoint(t),r=this.getLength();return i<e?s.INTERSECTION_POINT_A:o<e?s.INTERSECTION_POINT_B:i>r||o>r?s.INTERSECTION_OUTSIDE:Math.abs(i+o-r)<e?s.INTERSECTION_INSIDE:void 0}},De.prototype.intersectionWithPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=1e-7),this.getLine().isCoincidentPoint(t,e)?this.intersectionWithPointByDistances(t,e):s.INTERSECTION_OUTSIDE},De.prototype.intersectionWithSegment=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.getLine(),o=t.getLine(),r=i.intersectionWithLine(o);if(void 0!==r){var n=this.intersectionWithPointByDistances(r),a=t.intersectionWithPointByDistances(r);return n===s.INTERSECTION_OUTSIDE?s.INTERSECTION_OUTSIDE:a===s.INTERSECTION_OUTSIDE?s.INTERSECTION_OUTSIDE:s.INTERSECTION_INTERSECT}}},De.prototype.hasPoint=function(t){return void 0!==t&&(t===this.startPoint2d||t===this.endPoint2d)},De.prototype.sharesPointsWithSegment=function(t){return void 0!==t&&!(!this.hasPoint(t.startPoint2d)&&!this.hasPoint(t.endPoint2d))};var Ie=function(t,e){if(!(this instanceof Ie))throw new Error(j.CONSTRUCT_ERROR);this.startPoint3d,this.endPoint3d,t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)};Ie.prototype.setPoints=function(t,e){t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)},Ie.prototype.getVector=function(t){if(void 0!==this.startPoint3d&&void 0!==this.endPoint3d)return void 0===t&&(t=new Ce),t=this.startPoint3d.getVectorToPoint(this.endPoint3d,t)},Ie.prototype.getDirection=function(t){return void 0===t&&(t=new Ce),(t=this.getVector(t)).unitary(),t},Ie.prototype.invertSense=function(){var t=this.startPoint3d;this.startPoint3d=this.endPoint3d,this.endPoint3d=t};var Ee=function(){if(!(this instanceof Ee))throw new Error(j.CONSTRUCT_ERROR);this.ellipsoid};Ee.prototype.render=function(t,e,i,o){if(void 0!==this.ellipsoid){var r=t.getGl();r.uniform3fv(e.buildingPosHIGH_loc,this.ellipsoid.terrainPositionHIGH),r.uniform3fv(e.buildingPosLOW_loc,this.ellipsoid.terrainPositionLOW);a=F.equatorialRadius(),s=F.polarRadius()+n;r.uniform1f(e.equatorialRadius_loc,a),r.depthRange(1,1),this.ellipsoid.render(t,e,i,o),r.depthRange(0,1)}else{var n=2e5,a=F.equatorialRadius()+n,s=F.polarRadius()+n;this.ellipsoid=new Xt(a,a,s);this.ellipsoid.makeMesh({bLoopColumns:!1,bTrianglesSenseCCW:!1});var l=t.vboMemoryManager;this.ellipsoid.makeVbo(l)}};var Oe=function(){if(!(this instanceof Oe))throw new Error(j.CONSTRUCT_ERROR);this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};Oe.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new me),this.centerPoint.set(t,e)},Oe.prototype.setInteriorRadius=function(t){this.interiorRadius=t},Oe.prototype.setExteriorRadius=function(t){this.exteriorRadius=t},Oe.prototype.setRadiusCount=function(t){this.radiusCount=t},Oe.prototype.getPoints=function(t){var e,i,o,r=360/this.radiusCount*Math.PI/180,n=r/2,a=90*Math.PI/180;void 0===t&&(t=[]);for(var s=0;s<this.radiusCount;s++)i=this.centerPoint.x+this.exteriorRadius*Math.cos(a),o=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(e=new me(i,o)).pointType=1,t.push(e),i=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),o=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(e=new me(i,o)).pointType=1,t.push(e),a+=r;return t};var Fe=function(){if(!(this instanceof Fe))throw new Error(j.CONSTRUCT_ERROR);this.guid="",this.buildingFolderName="",this.projectFolderName="",this.neoBuilding=void 0},Ne=function(){if(!(this instanceof Ne))throw new Error(j.CONSTRUCT_ERROR);this.staticModelsMap={}};Ne.prototype.addStaticModel=function(t,e){this.staticModelsMap[t]=e},Ne.prototype.getStaticModel=function(t){var e=this.staticModelsMap[t];if(void 0===e)throw new Error("StaticModel is not exist.");return e};var Ve=function(){if(!(this instanceof Ve))throw new Error(j.CONSTRUCT_ERROR);this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0};Ve.prototype.deleteObjects=function(){for(var t=0,e=this.facesArray.length;t<e;t++)this.facesArray[t].deleteObjects(),this.facesArray[t]=void 0;this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0},Ve.prototype.newFace=function(){var t=new ie;return this.facesArray.push(t),t},Ve.prototype.getFacesCount=function(){return this.facesArray.length},Ve.prototype.getFace=function(t){return this.facesArray[t]},Ve.prototype.setColor=function(t,e,i,o){for(var r=0,n=this.getFacesCount();r<n;r++)this.getFace(r).setColor(t,e,i,o)},Ve.prototype.addFacesArray=function(t){void 0!==t&&Array.prototype.push.apply(this.facesArray,t)},Ve.prototype.getFrontierHalfEdges=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getFrontierHalfEdges(t);return t},Ve.prototype.getHalfEdges=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getHalfEdgesLoop(t);return t},Ve.prototype.getCopyIndependentSurface=function(t){void 0===t&&(t=new Ve),void 0===t.localVertexList&&(t.localVertexList=new ze);for(var e,i,o,r,n=t.localVertexList,a=this.getNoRepeatedVerticesArray(),s=a.length,l=0;l<s;l++)(e=a[l]).setIdxInList(l),n.newVertex().copyFrom(e);var d=this.getFacesCount();for(l=0;l<d;l++){i=this.getFace(l),(o=t.newFace()).vertexArray=[],s=i.getVerticesCount();for(var h=0;h<s;h++)r=(e=i.getVertex(h)).getIdxInList(),o.vertexArray.push(n.getVertex(r));o.createHalfEdges([])}return t.setTwinsFaces(),t},Ve.setTwinsFacesBetweenFaceAndFacesArrays=function(t,e,i){if(void 0===e)return!1;for(var o=!1,r=0,n=e.length;r<n;r++)if(e[r].setTwinFace(t)&&(o=!0,i))return!0;return o},Ve.setTwinsFacesBetweenFacesArrays_regularQuadGrid=function(t,e){if(void 0===t||void 0===e)return!1;for(var i,o,r=0,n=t.length-1;r<n;r++)i=t[r],o=e[r+1],i.setTwinFace(o)||(i=t[r+1],o=e[r],i.setTwinFace(o)||(i=t[r],o=e[r],i.setTwinFace(o)||(i=t[r+1],o=e[r+1],i.setTwinFace(o))))},Ve.prototype.setTwinsFaces=function(){for(var t,e,i=this.facesArray.length,o=0;o<i;o++){t=this.getFace(o);for(var r=0;r<i;r++)o!==r&&(e=this.getFace(r),t.setTwinFace(e))}},Ve.prototype.getNoRepeatedVerticesArray=function(t){var e,i;t=t||[];for(var o=0,r=this.getFacesCount(),n=0;n<r;n++)for(var a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)(i=e.getVertex(a)).setIdxInList(o),o++;var l,d={};for(n=0;n<r;n++)for(a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)d[(i=e.getVertex(a)).getIdxInList().toString()]=i;for(var h in d)Object.prototype.hasOwnProperty.call(d,h)&&(l=d[h],t.push(l));return t},Ve.prototype.getTrianglesConvex=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getTrianglesConvex(t);return t},Ve.prototype.getTriangles=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getTessellatedTriangles(t);return t},Ve.prototype.calculateVerticesNormals=function(t){for(var e=this.getFacesCount(),i=0;i<e;i++)this.getFace(i).calculateVerticesNormals(t)},Ve.prototype.reverseSense=function(){for(var t=this.getFacesCount(),e=0;e<t;e++)this.getFace(e).reverseSense()};var Be=function(t,e,i){if(!(this instanceof Be))throw new Error(j.CONSTRUCT_ERROR);this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==t&&(this.vertex0=t),void 0!==e&&(this.vertex1=e),void 0!==i&&(this.vertex2=i),this.hEdge};Be.prototype.deleteObjects=function(){this.vertex0&&(this.vertex0=void 0),this.vertex1&&(this.vertex1=void 0),this.vertex2&&(this.vertex2=void 0),this.normal&&(this.normal.deleteObjects(),this.normal=void 0),this.vtxIdx0=void 0,this.vtxIdx1=void 0,this.vtxIdx2=void 0},Be.prototype.setVertices=function(t,e,i){this.vertex0=t,this.vertex1=e,this.vertex2=i},Be.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},Be.prototype.getIndicesArray=function(t){return void 0===t&&(t=[]),void 0!==this.vtxIdx0&&void 0!==this.vtxIdx1&&void 0!==this.vtxIdx2&&(t.push(this.vtxIdx0),t.push(this.vtxIdx1),t.push(this.vtxIdx2)),t},Be.prototype.invertSense=function(){var t=this.vertex1;this.vertex1=this.vertex2,this.vertex2=t,this.calculatePlaneNormal()},Be.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new Ce),this.getCrossProduct(0,this.normal),this.normal.unitary()},Be.prototype.getCrossProduct=function(t,e){var i,o,r;void 0===e&&(e=new Ce),0===t?(i=this.vertex0.point3d,o=this.vertex2.point3d,r=this.vertex1.point3d):1===t?(i=this.vertex1.point3d,o=this.vertex0.point3d,r=this.vertex2.point3d):2===t&&(i=this.vertex2.point3d,o=this.vertex1.point3d,r=this.vertex0.point3d);var n=new Ce,a=new Ce;return n.set(i.x-o.x,i.y-o.y,i.z-o.z),a.set(r.x-i.x,r.y-i.y,r.z-i.z),n.unitary(),a.unitary(),e=n.crossProduct(a,e)};var je=function(){if(!(this instanceof je))throw new Error(j.CONSTRUCT_ERROR);this.trianglesArray=[]};je.prototype.newTriangle=function(t,e,i){var o=new Be(t,e,i);return this.trianglesArray.push(o),o},je.prototype.addTriangle=function(t){this.trianglesArray.push(t)},je.prototype.deleteObjects=function(){for(var t=this.getTrianglesCount(),e=0;e<t;e++)this.trianglesArray[e].deleteObjects(),this.trianglesArray[e]=void 0;this.trianglesArray=[]},je.prototype.getTrianglesCount=function(){return this.trianglesArray.length},je.prototype.getTriangle=function(t){return this.trianglesArray[t]},je.prototype.assignVerticesIdx=function(){je.assignVerticesIdx(this.trianglesArray)},je.assignVerticesIdx=function(t){if(void 0!==t)for(var e=t.length,i=(t=t,0);i<e;i++)t[i].assignVerticesIdx()},je.getTrianglesIndicesArray=function(t,e){var i=t.length;void 0===e&&(e=new Uint16Array(3*i));for(var o=0;o<i;o++)e[3*o]=t[o].vtxIdx0,e[3*o+1]=t[o].vtxIdx1,e[3*o+2]=t[o].vtxIdx2;return e},je.prototype.getNoRepeatedVerticesArray=function(t){return t=je.getNoRepeatedVerticesArray(this.trianglesArray,t)},je.getNoRepeatedVerticesArray=function(t,e){var i;void 0===e&&(e=[]);for(var o,r,n,a=0,s=t.length,l=0;l<s;l++)o=(i=t[l]).vertex0,r=i.vertex1,n=i.vertex2,o.setIdxInList(a),a++,r.setIdxInList(a),a++,n.setIdxInList(a),a++;var d,h={};for(l=0;l<s;l++)o=(i=t[l]).vertex0,r=i.vertex1,n=i.vertex2,h[o.getIdxInList().toString()]=o,h[r.getIdxInList().toString()]=r,h[n.getIdxInList().toString()]=n;for(var c in h)Object.prototype.hasOwnProperty.call(h,c)&&(d=h[c],e.push(d));return e},je.getVboFaceDataArray=function(t,e,i){if(void 0===e&&(e=new ut),void 0===t)return e;if(0===t.length)return e;var o=je.getTrianglesIndicesArray(t,void 0);return e.setDataArrayIdx(o,i),e};var Ue=function(){if(!(this instanceof Ue))throw new Error(j.CONSTRUCT_ERROR);this.trianglesListsArray=[]};Ue.prototype.deleteObjects=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].deleteObjects(),this.trianglesListsArray[e]=void 0;this.trianglesListsArray=[]},Ue.prototype.getTrianglesList=function(t){return this.trianglesListsArray[t]},Ue.prototype.getTrianglesListsCount=function(){return this.trianglesListsArray.length},Ue.prototype.newTrianglesList=function(){var t=new je;return this.trianglesListsArray.push(t),t},Ue.prototype.assignVerticesIdx=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].assignVerticesIdx()},Ue.prototype.getVboFaceDataArray=function(t){for(var e=[],i=this.trianglesListsArray.length,o=0;o<i;o++)e=this.trianglesListsArray[o].getTrianglesIndicesArray(e);return t.idxVboDataArray=Int16Array.from(e),t.indicesCount=t.idxVboDataArray.length,t};var Ge=function(){if(!(this instanceof Ge))throw new Error(j.CONSTRUCT_ERROR);this.geoCoordsListPath,this.geoCoordsListProfile,this.geoLocDataManager,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};Ge.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new O);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},Ge.prototype.getPathGeographicCoordsList=function(){return void 0===this.geoCoordsListPath&&(this.geoCoordsListPath=new D,this.geoCoordsListPath.owner=this),this.geoCoordsListPath},Ge.prototype.getProfileGeographicCoordsList=function(){return void 0===this.geoCoordsListProfile&&(this.geoCoordsListProfile=new D,this.geoCoordsListProfile.owner=this),this.geoCoordsListProfile},Ge.prototype.renderPoints=function(t,e,i){if(void 0===this.geoCoordsListPath)return!1;this.renderTunnel(t,e,i),this.geoCoordsListPath.renderPoints(t,e,i,!1),this.geoCoordsListPath.renderLines(t,e,i,!1,!1)},Ge.prototype.renderMesh=function(t,e,i){if(void 0!==this.meshPositive){var o=t.sceneState.gl;this.getGeoLocationData().bindGeoLocationUniforms(o,e),this.meshPositive.render(t,e,i)}},Ge.prototype.renderTunnel=function(t,e,i){if(void 0!==this.meshPositive){var o=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),o.uniform1i(e.bApplySsao_loc,!1),o.uniform1i(e.refMatrixType_loc,0),o.uniform1i(e.colorType_loc,1),o.uniform1i(e.bApplySpecularLighting_loc,!0),o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),o.depthRange(0,1),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.colorMask(!1,!1,!1,!1),o.depthMask(!1),o.enable(o.CULL_FACE),o.enable(o.STENCIL_TEST),o.clearStencil(0);o.cullFace(o.FRONT),o.stencilFunc(o.ALWAYS,0,255),o.stencilOp(o.KEEP,o.INCR,o.KEEP),this.meshPositive.render(t,e,i,void 0),o.cullFace(o.BACK),o.stencilFunc(o.ALWAYS,0,255),o.stencilOp(o.KEEP,o.DECR,o.KEEP),this.meshPositive.render(t,e,i,void 0),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[222/255,184/255,135/255,1]),o.colorMask(!0,!0,!0,!0),o.depthMask(!0),o.stencilMask(0),o.stencilFunc(o.LEQUAL,1,255),o.stencilOp(o.REPLACE,o.REPLACE,o.REPLACE),o.cullFace(o.BACK),o.depthFunc(o.ALWAYS),this.meshNegative.render(t,e,i,void 0),o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),o.disable(o.STENCIL_TEST),o.stencilOp(o.KEEP,o.KEEP,o.KEEP),o.disable(o.POLYGON_OFFSET_FILL),o.depthRange(0,1),o.useProgram(null),o.depthMask(!0),o.stencilMask(255)}},Ge.prototype.makeMesh=function(t){if(void 0===this.geoCoordsListPath||void 0===this.geoCoordsListProfile)return!1;var e=this.getGeoLocationData(),i=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Xe);var o=this.geoCoordsListPath.getWgs84Points3D(void 0),r=e.getTransformedRelativePositionsArray(o,void 0),n=new be(r),a=n.getBisectionPlane(0,void 0,!1),s=new _e,l=s.newOuterRing(),d=l.newElement("CIRCLE");d.setCenterPosition(0,0),d.setRadius(15);l.getPoints([],24);var h=a.getRotationMatrix(void 0),c=n.getPoint(0);if(h.setTranslation(c.x,c.y,c.z),void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var u=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=u.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=u.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}},Ge.prototype.remakeMesh=function(t){if(void 0===this.vtxProfilesList)return!1;var e=this.getGeoLocationData(),i=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i);var o=this.geoCoordsListPath.getWgs84Points3D(void 0),r=e.getTransformedRelativePositionsArray(o,void 0),n=new be(r),a=n.getBisectionPlane(0,void 0,!1),s=new _e,l=s.newOuterRing(),d=l.newElement("CIRCLE");d.setCenterPosition(0,0),d.setRadius(15);l.getPoints([],24);var h=a.getRotationMatrix(void 0),c=n.getPoint(0);if(h.setTranslation(c.x,c.y,c.z),this.meshPositive=void 0,this.meshNegative=void 0,this.vtxProfilesList.deleteObjects(),this.vtxProfilesList=new Xe,void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var u=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=u.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=u.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}};var ke=function(t){if(!(this instanceof ke))throw new Error(j.CONSTRUCT_ERROR);this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=t||new Ce};ke.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},ke.prototype.getIdxInList=function(){return this.idxInList},ke.prototype.setIdxInList=function(t){this.idxInList=t},ke.prototype.copyFrom=function(t){t.point3d&&(void 0===this.point3d&&(this.point3d=new Ce),this.point3d.copyFrom(t.point3d)),t.normal&&(void 0===this.normal&&(this.normal=new Ce),this.normal.copyFrom(t.normal)),t.texCoord&&(void 0===this.texCoord&&(this.texCoord=new me),this.texCoord.copyFrom(t.texCoord)),t.color4&&(void 0===this.color4&&(this.color4=new x),this.color4.copyFrom(t.color4)),this.vertexType=t.vertexType},ke.prototype.getPosition=function(){return this.point3d},ke.prototype.setPosition=function(t,e,i){void 0===this.point3d&&(this.point3d=new Ce),this.point3d.set(t,e,i)},ke.prototype.setTexCoord=function(t,e){void 0===this.texCoord&&(this.texCoord=new me),this.texCoord.set(t,e)},ke.prototype.setColorRGB=function(t,e,i){void 0===this.color4&&(this.color4=new x),this.color4.setRGB(t,e,i)},ke.prototype.setColorRGBA=function(t,e,i,o){void 0===this.color4&&(this.color4=new x),this.color4.setRGBA(t,e,i,o)},ke.prototype.setNormal=function(t,e,i){void 0===this.normal&&(this.normal=new Ce),this.normal.set(t,e,i)},ke.prototype.getNormal=function(){return void 0===this.normal&&(this.normal=new Ce),this.normal},ke.prototype.translate=function(t,e,i){this.point3d.add(t,e,i)},ke.prototype.getOutingHEdges=function(t){return void 0===t&&(t=[]),t},ke.getProjectedOntoPlane=function(t,e,i,o){if(void 0===t)return o;var r,n=t.getPosition(),a=new se(n,i);return r=e.intersectionLine(a,r),void 0===o&&(o=new ke),o.copyFrom(t),o.setPosition(r.x,r.y,r.z),o};var ze=function(){if(!(this instanceof ze))throw new Error(j.CONSTRUCT_ERROR);this.vertexArray=[]};ze.getPrevIdx=function(t,e){var i=e.length;if(!(t<0||t>i-1))return 0===t?i-1:t-1},ze.getNextIdx=function(t,e){var i=e.length;if(!(t<0||t>i-1))return t===i-1?0:t+1},ze.getVtxSegment=function(t,e,i){var o=e[t],r=e[ze.getNextIdx(t,e)];return void 0===i?i=new qe(o,r):i.setVertices(o,r),i},ze.getVector=function(t,e,i){var o=e[t],r=e[ze.getNextIdx(t,e)],n=o.point3d,a=r.point3d;return void 0===i?i=new Ce(a.x-n.x,a.y-n.y,a.z-n.z):i.set(a.x-n.x,a.y-n.y,a.z-n.z),i},ze.getDirection=function(t,e,i){return(i=ze.getVector(t,e,i)).unitary(),i},ze.getCrossProduct=function(t,e,i){var o=ze.getVector(t,e,void 0),r=ze.getPrevIdx(t,e);return i=ze.getVector(r,e,void 0).crossProduct(o,i)},ze.getProjectedOntoPlane=function(t,e,i,o){if(void 0===t)return o;var r,n;void 0===o&&(o=new ze);for(var a=t.getVertexCount(),s=0;s<a;s++)r=t.getVertex(s),n=o.newVertex(),n=ke.getProjectedOntoPlane(r,e,i,n);return o},ze.getProjectedPoints2DArray=function(t,e,i){if(void 0===t)return i;void 0===i&&(i=[]);var o,r=ie.getBestFacePlaneToProject(e),n=t.length;if(0===r)for(var a=0;a<n;a++){var s=(l=t[a]).point3d;(o=e.z>0?new me(s.x,s.y):new me(s.x,-s.y)).ownerVertex3d=l,i.push(o)}else if(1===r)for(a=0;a<n;a++){s=(l=t[a]).point3d;(o=e.x>0?new me(s.y,s.z):new me(-s.y,s.z)).ownerVertex3d=l,i.push(o)}else if(2===r)for(a=0;a<n;a++){var l;s=(l=t[a]).point3d;(o=e.y>0?new me(-s.x,s.z):new me(s.x,s.z)).ownerVertex3d=l,i.push(o)}return i},ze.prototype.deleteObjects=function(){for(var t=0,e=this.vertexArray.length;t<e;t++)this.vertexArray[t].deleteObjects(),this.vertexArray[t]=void 0;this.vertexArray=void 0},ze.prototype.copyFrom=function(t){var e;this.deleteObjects(),this.vertexArray=[];for(var i=t.getVertexCount(),o=0;o<i;o++)e=t.getVertex(o),this.newVertex().copyFrom(e)},ze.prototype.copyFromPoint3DArray=function(t){if(void 0!==t){var e,i;this.deleteObjects(),this.vertexArray=[];for(var o=t.length,r=0;r<o;r++)e=t[r],(i=this.newVertex()).point3d=new Ce,i.point3d.set(e.x,e.y,e.z),i.point3d.pointType=e.pointType,i.vertexType=e.pointType}},ze.prototype.copyFromPoint2DList=function(t,e){var i,o;this.deleteObjects(),this.vertexArray=[],void 0===e&&(e=0);for(var r=t.getPointsCount(),n=0;n<r;n++)i=t.getPoint(n),(o=this.newVertex()).point3d=new Ce,o.point3d.set(i.x,i.y,e),o.point3d.pointType=i.pointType,o.vertexType=i.pointType},ze.prototype.setNormal=function(t,e,i){for(var o=this.getVertexCount(),r=0;r<o;r++)this.getVertex(r).setNormal(t,e,i)},ze.prototype.newVertex=function(){var t=new ke;return this.vertexArray.push(t),t},ze.prototype.getVertex=function(t){return this.vertexArray[t]},ze.prototype.getVertexCount=function(){return this.vertexArray.length},ze.prototype.getPrevIdx=function(t){return ze.getPrevIdx(t,this.vertexArray)},ze.prototype.getNextIdx=function(t){return ze.getNextIdx(t,this.vertexArray)},ze.prototype.getIdxOfVertex=function(t){for(var e=this.vertexArray.length,i=0,o=-1,r=!1;!r&&i<e;)this.vertexArray[i]===t&&(r=!0,o=i),i++;return o},ze.prototype.getVtxSegment=function(t,e){return ze.getVtxSegment(t,this.vertexArray,e)},ze.prototype.translateVertices=function(t,e,i){for(var o=0,r=this.vertexArray.length;o<r;o++)this.vertexArray[o].translate(t,e,i)},ze.prototype.getBoundingBox=function(t){void 0===t&&(t=new u);for(var e=0,i=this.vertexArray.length;e<i;e++)0===e?t.init(this.vertexArray[e].point3d):t.addPoint(this.vertexArray[e].point3d);return t},ze.prototype.transformPointsByMatrix4=function(t){for(var e=0,i=this.vertexArray.length;e<i;e++){var o=this.vertexArray[e];t.transformPoint3D(o.point3d,o.point3d)}},ze.prototype.setIdxInList=function(){ze.setIdxInList(this.vertexArray)},ze.setIdxInList=function(t){if(void 0!==t)for(var e=0,i=t.length;e<i;e++)t[e].idxInList=e},ze.prototype.getVboDataArrays=function(t,e){return ze.getVboDataArrays(this.vertexArray,t,e),t},ze.getVboDataArrays=function(t,e,i){var o,r,n,a,s,l=t.length;if(0===l)return e;void 0===e&&(e=new ut);var d,h,c,u,f=!1,g=!1,p=!1;if(void 0===(o=t[0]).point3d)return e;(void 0!==o.normal&&(f=!0),void 0!==o.color4&&(g=!0),void 0!==o.texCoord&&(p=!0),d=new Float32Array(3*l),f)&&(h=new Int8Array(3*l));g&&(c=new Uint8Array(4*l));p&&(u=new Float32Array(2*l));for(var v=0;v<l;v++)void 0!==(o=t[v]).point3d&&(r=o.point3d,d[3*v]=r.x,d[3*v+1]=r.y,d[3*v+2]=r.z,f&&(n=o.normal,h[3*v]=127*n.x,h[3*v+1]=127*n.y,h[3*v+2]=127*n.z),g&&(a=o.color4,c[4*v]=255*a.r,c[4*v+1]=255*a.g,c[4*v+2]=255*a.b,c[4*v+3]=255*a.a),p&&(s=o.texCoord,u[2*v]=s.x,u[2*v+1]=s.y));return e.setDataArrayPos(d,i),f&&e.setDataArrayNor(h,i),g&&e.setDataArrayCol(c,i),p&&e.setDataArrayTexCoord(u,i),e};var He=function(){if(!(this instanceof He))throw new Error(j.CONSTRUCT_ERROR);this.vertexListsArray=[],this.totalVertexArraySC=[]};He.prototype.deleteObjects=function(){for(var t=0,e=this.vertexListsArray.length;t<e;t++)this.vertexListsArray[t].deleteObjects(),this.vertexListsArray[t]=void 0;this.vertexListsArray=void 0},He.prototype.newVertexList=function(){var t=new ze;return this.vertexListsArray.push(t),t},He.prototype.getVertexList=function(t){return t>=0&&t<this.vertexListsArray.length?this.vertexListsArray[t]:void 0},He.prototype.copyFrom=function(t){if(void 0!==t)for(var e,i=t.vertexListsArray.length,o=0;o<i;o++)e=t.getVertexList(o),this.newVertexList().copyFrom(e)},He.prototype.getBoundingBox=function(t){void 0===t&&(t=new u),this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);for(var e=0,i=this.totalVertexArraySC.length;e<i;e++)0===e?t.init(this.totalVertexArraySC[e].point3d):t.addPoint(this.totalVertexArraySC[e].point3d);return t},He.prototype.setVertexIdxInList=function(){for(var t=0,e=0,i=this.vertexListsArray.length;e<i;e++)for(var o=this.vertexListsArray[e],r=0,n=o.vertexArray.length;r<n;r++){o.getVertex(r).mIdxInList=t,t++}},He.prototype.getVertexCount=function(){for(var t=0,e=0,i=this.vertexListsArray.length;e<i;e++)t+=this.vertexListsArray[e].getVertexCount();return t},He.prototype.getTotalVertexArray=function(t){for(var e=0,i=this.vertexListsArray.length;e<i;e++)for(var o=this.vertexListsArray[e],r=0,n=o.vertexArray.length;r<n;r++){var a=o.getVertex(r);t.push(a)}return t},He.prototype.getVBOVertexColorFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(6*e));for(var i=0;i<e;i++){var o=this.totalVertexArraySC[i];t[6*i]=o.point3d.x,t[6*i+1]=o.point3d.y,t[6*i+2]=o.point3d.z,t[6*i+3]=o.color4.r,t[6*i+4]=o.color4.g,t[6*i+5]=o.color4.b}return t},He.prototype.getVBOVertexColorRGBAFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(7*e));for(var i=0;i<e;i++){var o=this.totalVertexArraySC[i];t[7*i]=o.point3d.x,t[7*i+1]=o.point3d.y,t[7*i+2]=o.point3d.z,t[7*i+3]=o.color4.r,t[7*i+4]=o.color4.g,t[7*i+5]=o.color4.b,t[7*i+6]=o.color4.a}return t},He.prototype.getVBOVertexFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(3*e));for(var i=0;i<e;i++){var o=this.totalVertexArraySC[i];t[3*i]=o.point3d.x,t[3*i+1]=o.point3d.y,t[3*i+2]=o.point3d.z}return t},He.prototype.translateVertices=function(t,e,i){for(var o=0,r=this.vertexListsArray.length;o<r;o++)this.vertexListsArray[o].translateVertices(t,e,i)},He.prototype.makeTTrianglesLateralSidesLOOP=function(t){for(var e,i,o,r,n,a=0,s=0,l=this.vertexListsArray.length;s<l-1;s++){e=this.vertexListsArray[s],i=this.vertexListsArray[s+1],o=t.newTTrianglesList(),a=e.vertexArray.length;for(var d=0;d<a;d++)r=o.newTTriangle(),n=o.newTTriangle(),d===a-1?(r.setVertices(e.getVertex(d),i.getVertex(d),i.getVertex(0)),n.setVertices(e.getVertex(d),i.getVertex(0),e.getVertex(0))):(r.setVertices(e.getVertex(d),i.getVertex(d),i.getVertex(d+1)),n.setVertices(e.getVertex(d),i.getVertex(d+1),e.getVertex(d+1)))}},He.makeMatrixByDataArray=function(t,e,i,o,r,n,a){if(void 0!==t){var s,l,d,h,c,u,f,g,p,v,y,m,x;void 0===a&&(a=new He);for(var b=0;b<n;b++){s=a.newVertexList();for(var C=0;C<r;C++)l=s.newVertex(),d=t[3*C],h=t[3*C+1],c=t[3*C+2],l.setPosition(d,h,c),e&&(u=e[3*C],f=e[3*C+1],g=e[3*C+2],l.setNormal(u,f,g)),i&&(p=i[2*C],v=i[2*C+1],l.setTexCoord(p,v)),o&&(b=o[4*C],y=o[4*C+1],m=o[4*C+2],x=o[4*C+3],l.setColorRGBA(b,y,m,x))}return a}},He.makeFacesBetweenVertexLists=function(t,e,i,o,r){var n,a;void 0===i&&(i=[]);var s,l,d,h,c=t.vertexArray.length;void 0===r&&(r=!1);var u=[],f=[];if(r)for(var g=0;g<c;g++)u.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),d=e.getVertex(g+1),h=e.getVertex(g),n=new ie,a=new ie,n.addVerticesArray([s,h,l]),a.addVerticesArray([l,h,d]),i.push(n),i.push(a)):void 0!==o&&!0===o&&(s=t.getVertex(g),l=t.getVertex(0),d=e.getVertex(0),h=e.getVertex(g),n=new ie,a=new ie,n.addVerticesArray([s,h,l]),a.addVerticesArray([l,h,d]),i.push(n),i.push(a)),a;else for(g=0;g<c;g++)u.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),d=e.getVertex(g+1),h=e.getVertex(g),n=new ie,a=new ie,n.addVerticesArray([s,l,h]),a.addVerticesArray([l,d,h]),i.push(n),i.push(a)):void 0!==o&&!0===o&&(s=t.getVertex(g),l=t.getVertex(0),d=e.getVertex(0),h=e.getVertex(g),n=new ie,a=new ie,n.addVerticesArray([s,l,h]),a.addVerticesArray([l,d,h]),i.push(n),i.push(a)),a;return i},He.makeSurface=function(t,e,i,o){var r,n;void 0===e&&(e=new Ve);for(var a=[],s=t.vertexListsArray.length,l=0;l<s-1;l++)r=t.vertexListsArray[l],n=t.vertexListsArray[l+1],a=He.makeFacesBetweenVertexLists(r,n,a,i,o),e.addFacesArray(a),a.length=0;return e},He.prototype.makeTrianglesLateralSides=function(t,e){for(var i,o,r,n,a,s=0,l=0,d=this.vertexListsArray.length;l<d-1;l++){i=this.vertexListsArray[l],o=this.vertexListsArray[l+1],r=t.newTrianglesList(),s=i.vertexArray.length;for(var h=0;h<s;h++)h===s-1?void 0!==e&&!0===e&&(n=r.newTriangle(),a=r.newTriangle(),n.setVertices(i.getVertex(h),o.getVertex(h),o.getVertex(0)),a.setVertices(i.getVertex(h),o.getVertex(0),i.getVertex(0))):(n=r.newTriangle(),a=r.newTriangle(),n.setVertices(i.getVertex(h),o.getVertex(h),o.getVertex(h+1)),a.setVertices(i.getVertex(h),o.getVertex(h+1),i.getVertex(h+1)))}},He.getIndexOfArray=function(t,e,i,o){return i+o*t},He.prototype.transformPointsByMatrix4=function(t){for(var e=0,i=this.vertexListsArray.length;e<i;e++){this.vertexListsArray[e].transformPointsByMatrix4(t)}};var We=function(){if(!(this instanceof We))throw new Error(j.CONSTRUCT_ERROR);this.outerVtxRing,this.innerVtxRingsList};We.prototype.deleteObjects=function(){void 0!==this.outerVtxRing&&(this.outerVtxRing.deleteObjects(),this.outerVtxRing=void 0),void 0!==this.innerVtxRingsList&&(this.innerVtxRingsList.deleteObjects(),this.innerVtxRingsList=void 0)},We.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},We.prototype.getInnerVtxRing=function(t){if(void 0!==this.innerVtxRingsList&&0!==this.innerVtxRingsList.getRingsCount)return this.innerVtxRingsList.getVtxRing(t)},We.prototype.setVerticesIdxInList=function(){this.outerVtxRing&&this.outerVtxRing.vertexList&&this.outerVtxRing.vertexList.setIdxInList(),this.innerVtxRingsList&&this.innerVtxRingsList.setVerticesIdxInList()},We.prototype.copyFrom=function(t){t.outerVtxRing&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Ke),this.outerVtxRing.copyFrom(t.outerVtxRing)),t.innerVtxRingsList&&(void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Ye),this.innerVtxRingsList.copyFrom(t.innerVtxRingsList))},We.prototype.translate=function(t,e,i){void 0!==this.outerVtxRing&&this.outerVtxRing.translate(t,e,i),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.translate(t,e,i)},We.prototype.transformPointsByMatrix4=function(t){void 0!==this.outerVtxRing&&this.outerVtxRing.transformPointsByMatrix4(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.transformPointsByMatrix4(t)},We.prototype.getProjectedProfile2D=function(t){if(void 0===this.outerVtxRing)return t;var e=this.outerVtxRing.calculatePlaneNormal(void 0);if(void 0===e)return t;if(void 0===t&&(t=new _e),t.outerRing=this.outerVtxRing.getProjectedPolyLineBasedRing2D(t.outerRing,e),void 0!==this.innerVtxRingsList){var i,o=this.innerVtxRingsList.getVtxRingsCount();o>0&&(i=t.getInnerRingsList());for(var r=0;r<o;r++){var n=this.innerVtxRingsList.getVtxRing(r).getProjectedPolyLineBasedRing2D(void 0,e);i.addRing(n)}}return t},We.prototype.makeByPoints3DArray=function(t,e){void 0!==t&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Ke),this.outerVtxRing.makeByPoints3DArray(t))},We.prototype.updateByPoints3DArray=function(t,e){void 0!==t&&void 0!==this.outerVtxRing&&this.outerVtxRing.updateByPoints3DArray(t)},We.prototype.makeByProfile2D=function(t){if(void 0!==t&&void 0!==t.outerRing){var e=t.outerRing;void 0===e.polygon&&e.makePolygon(),void 0===this.outerVtxRing&&(this.outerVtxRing=new Ke);var i=e.polygon.point2dList;if(this.outerVtxRing.makeByPoint2DList(i,0),void 0!==t.innerRingsList){var o=t.innerRingsList,r=o.getRingsCount();if(0!==r){var n;void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Ye);for(var a=0;a<r;a++)void 0===(n=o.getRing(a)).polygon&&n.makePolygon(),i=n.polygon.point2dList,this.innerVtxRingsList.newVtxRing().makeByPoint2DList(i,0)}}}},We.prototype.getAllVertices=function(t){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(t),t},We.getProjectedOntoPlane=function(t,e,i,o){return void 0===t.outerVtxRing?o:(void 0===o&&(o=new We),o.outerVtxRing=Ke.getProjectedOntoPlane(t.outerVtxRing,e,i,o.outerVtxRing),void 0!==t.innerVtxRingsList&&(o.innerVtxRingsList=Ye.getProjectedOntoPlane(t.innerVtxRingsList,e,i,o.innerVtxRingsList)),o)};var Xe=function(t,e){if(!(this instanceof Xe))throw new Error(j.CONSTRUCT_ERROR);this.vtxProfilesArray,this.convexFacesIndicesData};Xe.prototype.deleteObjects=function(){if(void 0!==this.vtxProfilesArray){for(var t=this.vtxProfilesArray.length,e=0;e<t;e++)this.vtxProfilesArray[e].deleteObjects(),this.vtxProfilesArray[e]=void 0;this.vtxProfilesArray=void 0}void 0!==this.convexFacesIndicesData&&(this.convexFacesIndicesData=void 0)},Xe.getLateralFaces=function(t,e,i,o,r){void 0===i&&(i=[]);var n,a,s,l,d,h,c,u,f=o.getHalfEdgesList(),g=[];for(n=r.strIdx;n!==r.endIdx;)a=t.vertexList.getNextIdx(n),c=new ie,i.push(c),c.vertexArray=[],s=t.vertexList.getVertex(n),l=t.vertexList.getVertex(a),d=e.vertexList.getVertex(a),h=e.vertexList.getVertex(n),Array.prototype.push.apply(c.vertexArray,[s,l,d,h]),g.length=0,g=c.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==u&&c.setTwinFace(u),u=c,n=a;return i},Xe.prototype.addVtxProfile=function(t){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]),this.vtxProfilesArray.push(t)},Xe.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var t=new We;return this.vtxProfilesArray.push(t),t},Xe.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},Xe.prototype.getVtxProfile=function(t){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[t]},Xe.prototype.getAllVertices=function(t){void 0===t&&(t=[]);for(var e=this.getVtxProfilesCount(),i=0;i<e;i++)t=this.getVtxProfile(i).getAllVertices(t);return t},Xe.prototype.getMesh=function(t,e,i,o){if(void 0===this.vtxProfilesArray)return resultTriangleMatrix;void 0===o&&(o=!1),!0===o&&(e=!1,i=!1);var r,n,a=this.getVtxProfilesCount();if(a<2)return resultTriangleMatrix;void 0===t&&(t=new ce),void 0===t.vertexList&&(t.vertexList=new ze),t.vertexList.vertexArray=this.getAllVertices(t.vertexList.vertexArray);for(var s,l,d,h,c,u,f=(r=this.getVtxProfile(0)).outerVtxRing,g=[],p=f.elemsIndexRangesArray.length,v=0;v<p;v++){h=t.newSurface(),c=void 0,s=f.getElementIndexRange(v);for(var y=0;y<a;y++){if(y===a-1){if(!o)break;r=this.getVtxProfile(y),n=this.getVtxProfile(0)}else r=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(l=r.outerVtxRing,d=n.outerVtxRing,g.length=0,g=Xe.getLateralFaces(l,d,g,t,s),h.addFacesArray(g),void 0!==c&&c.length>0)for(var m=g.length,x=0;x<m;x++)A=g[x],M=c[x],A.setTwinFace(M);c=[],Array.prototype.push.apply(c,g)}}var b,C=r.getInnerVtxRingsCount();for(x=0;x<C;x++){p=(u=r.getInnerVtxRing(x)).elemsIndexRangesArray.length;for(v=0;v<p;v++){h=t.newSurface(),c=void 0,s=u.getElementIndexRange(v);for(y=0;y<a;y++){if(y===a-1){if(!o)break;r=this.getVtxProfile(y),n=this.getVtxProfile(0)}else r=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(l=r.getInnerVtxRing(x),d=n.getInnerVtxRing(x),g.length=0,g=Xe.getLateralFaces(l,d,g,t,s),h.addFacesArray(g),void 0!==c&&c.length>0){m=g.length;for(var A,M,P=0;P<m;P++)A=g[P],M=c[P],A.setTwinFace(M)}c=[],Array.prototype.push.apply(c,g)}}}if(void 0===this.convexFacesIndicesData){var T=this.getVtxProfile(0).getProjectedProfile2D(T);this.convexFacesIndicesData=T.getConvexFacesIndicesData(this.convexFacesIndicesData)}return void 0!==i&&!0!==i||(n=this.getVtxProfile(a-1),b=t.newSurface(),b=Xe.getTransversalSurface(n,this.convexFacesIndicesData,b)),void 0!==e&&!0!==e||(r=this.getVtxProfile(0),b=t.newSurface(),(b=Xe.getTransversalSurface(r,this.convexFacesIndicesData,b)).reverseSense()),t},Xe.getTransversalSurface=function(t,e,i){var o,r,n,a,s,l,d;void 0===i&&(i=new Ve);for(var h=e.length,c=0;c<h;c++){(l=i.newFace()).vertexArray=[],s=(o=e[c]).length;for(var u=0;u<s;u++)n=(r=o[u]).ownerIdx,a=r.idxInList,d=(-1===n?t.outerVtxRing:t.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(d)}return i},Xe.prototype.makeLoft=function(t,e,i){this.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var o=new We;o.makeByProfile2D(t),void 0===i&&(i=!1);var r,n,a=e.getBisectionPlane(0,void 0,i),s=e.getPoint(0),l=a.getRotationMatrix(void 0);l.setTranslation(s.x,s.y,s.z),o.transformPointsByMatrix4(l);for(var d=e.getPointsCount(),h=0;h<d;h++){e.getPoint(h),r=e.getBisectionPlane(h,void 0,i),n=(0===h?e.getSegment3D(h,void 0,i):e.getSegment3D(h-1,void 0,i)).getDirection(void 0);var c=We.getProjectedOntoPlane(o,r,n,void 0);this.addVtxProfile(c),o=c}};var Ke=function(){if(!(this instanceof Ke))throw new Error(j.CONSTRUCT_ERROR);this.vertexList,this.elemsIndexRangesArray};Ke.prototype.deleteObjects=function(){void 0!==this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0),void 0!==this.elemsIndexRangesArray&&this.deleteElementIndexRanges()},Ke.prototype.deleteElementIndexRanges=function(){if(void 0!==this.elemsIndexRangesArray){for(var t=this.elemsIndexRangesArray.length,e=0;e<t;e++)this.elemsIndexRangesArray[e].deleteObjects(),this.elemsIndexRangesArray[e]=void 0;this.elemsIndexRangesArray=void 0}},Ke.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var t=new ae;return this.elemsIndexRangesArray.push(t),t},Ke.prototype.getElementIndexRange=function(t){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[t]},Ke.prototype.getAllVertices=function(t){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?t:(void 0===t&&(t=[]),t.push.apply(t,this.vertexList.vertexArray),t)},Ke.prototype.copyFrom=function(t){if(void 0!==t.vertexList&&(void 0===this.vertexList&&(this.vertexList=new ze),this.vertexList.copyFrom(t.vertexList)),void 0!==t.elemsIndexRangesArray){var e;void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);for(var i=t.elemsIndexRangesArray.length,o=0;o<i;o++)e=t.elemsIndexRangesArray[o],this.newElementIndexRange().copyFrom(e)}},Ke.prototype.translate=function(t,e,i){void 0!==this.vertexList&&this.vertexList.translateVertices(t,e,i)},Ke.prototype.transformPointsByMatrix4=function(t){void 0!==this.vertexList&&this.vertexList.transformPointsByMatrix4(t)},Ke.prototype.getProjectedPolyLineBasedRing2D=function(t,e){if(void 0===this.vertexList)return t;void 0===t&&(t=new Re);var i=[];return i=ze.getProjectedPoints2DArray(this.vertexList.vertexArray,e,i),t.newElement("POLYLINE").point2dArray=i,t},Ke.prototype.makeByPoints3DArray=function(t){void 0!==t&&(void 0===this.vertexList&&(this.vertexList=new ze),this.vertexList.copyFromPoint3DArray(t),this.calculateElementsIndicesRange())},Ke.prototype.updateByPoints3DArray=function(t){if(void 0!==t){var e,i;void 0===this.vertexList&&(this.vertexList=new ze);for(var o=t.length,r=0;r<o;r++)i=t[r],void 0===(e=this.vertexList.getVertex(r))&&(e=this.vertexList.newVertex()),void 0===e.point3d&&(e.point3d=new Ce),e.point3d.set(i.x,i.y,i.z);this.vertexList.copyFromPoint3DArray(t)}},Ke.prototype.makeByPoint2DList=function(t,e){void 0!==t&&(void 0===e&&(e=0),void 0===this.vertexList&&(this.vertexList=new ze),this.vertexList.copyFromPoint2DList(t,e),this.calculateElementsIndicesRange())},Ke.prototype.calculatePlaneNormal=function(t){return ie.calculatePlaneNormal(this.vertexList.vertexArray,void 0)},Ke.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;this.deleteElementIndexRanges(),this.elemsIndexRangesArray=[];for(var t,e=void 0,i=this.vertexList.getVertexCount(),o=0;o<i;o++)(t=this.vertexList.getVertex(o).vertexType)&&1===t&&(void 0!==e&&(e.endIdx=o),o!==i&&((e=this.newElementIndexRange()).strIdx=o));void 0!==e&&(e.endIdx=0)},Ke.getProjectedOntoPlane=function(t,e,i,o){return void 0===t.vertexList?resultRing2d:(void 0===o&&(o=new Ke),o.vertexList=ze.getProjectedOntoPlane(t.vertexList,e,i,o.vertexList),o.calculateElementsIndicesRange(),o)};var Ye=function(){if(!(this instanceof Ye))throw new Error(j.CONSTRUCT_ERROR);this.vtxRingsArray};Ye.prototype.deleteObjects=function(){if(void 0!==this.vtxRingsArray){for(var t=this.vtxRingsArray.length,e=0;e<t;e++)this.vtxRingsArray[e].deleteObjects(),this.vtxRingsArray[e]=void 0;this.vtxRingsArray=void 0}},Ye.prototype.getVtxRingsCount=function(){return void 0===this.vtxRingsArray?0:this.vtxRingsArray.length},Ye.prototype.getVtxRing=function(t){if(void 0!==this.vtxRingsArray)return this.vtxRingsArray[t]},Ye.prototype.newVtxRing=function(){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);var t=new Ke;return this.vtxRingsArray.push(t),t},Ye.prototype.copyFrom=function(t){if(void 0!==t){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);for(var e=t.getVtxRingsCount(),i=0;i<e;i++)this.newVtxRing().copyFrom(t.getVtxRing(i))}},Ye.prototype.translate=function(t,e,i){for(var o=this.getVtxRingsCount(),r=0;r<o;r++)this.vtxRingsArray[r].translate(t,e,i)},Ye.prototype.transformPointsByMatrix4=function(t){for(var e=this.getVtxRingsCount(),i=0;i<e;i++)this.vtxRingsArray[i].transformPointsByMatrix4(t)},Ye.prototype.getAllVertices=function(t){if(void 0===this.vtxRingsArray)return t;for(var e=this.getVtxRingsCount(),i=0;i<e;i++)this.vtxRingsArray[i].getAllVertices(t);return t},Ye.prototype.setVerticesIdxInList=function(){if(void 0!==this.vtxRingsArray)for(var t=this.getVtxRingsCount(),e=0;e<t;e++)this.vtxRingsArray[e].setVerticesIdxInList()},Ye.getProjectedOntoPlane=function(t,e,i,o){if(void 0===t)return o;var r,n;void 0===o&&(o=new Ye);for(var a=t.getVtxRingsCount(),s=0;s<a;s++)r=t.getVtxRing(s),n=o.newVtxRing(),n=Ke.getProjectedOntoPlane(r,e,i,n);return o};var qe=function(t,e){if(!(this instanceof qe))throw new Error(j.CONSTRUCT_ERROR);this.startVertex,this.endVertex,t&&(this.startVertex=t),e&&(this.endVertex=e)};qe.prototype.setVertices=function(t,e){this.startVertex=t,this.endVertex=e},qe.prototype.getDirection=function(t){if(void 0!==(t=this.getVector()))return t.unitary(),t},qe.prototype.getVector=function(t){if(void 0!==this.startVertex&&void 0!==this.endVertex){var e=this.startVertex.point3d,i=this.endVertex.point3d;if(void 0!==e&&void 0!==i)return t=e.getVectorToPoint(i,t)}},qe.prototype.getLine=function(t){void 0===t&&(t=new se);var e=this.getDirection(),i=this.startVertex.point3d;return t.setPointAndDir(i.x,i.y,i.z,e.x,e.y,e.z),t},qe.prototype.getSquaredLength=function(){return this.startVertex.point3d.squareDistToPoint(this.endVertex.point3d)},qe.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},qe.prototype.intersectionWithPoint=function(t,e){var i=this.getLine();if(void 0===e&&(e=1e-7),!i.isCoincidentPoint(t,e))return s.INTERSECTION_OUTSIDE;var o=this.startVertex.point3d.distToPoint(t),r=this.endVertex.point3d.distToPoint(t),n=this.getLength();return o<e?s.INTERSECTION_POINT_A:r<e?s.INTERSECTION_POINT_B:o>n||r>n?s.INTERSECTION_OUTSIDE:Math.abs(o+r-n)<e?s.INTERSECTION_INSIDE:void 0};var Ze=function(){if(!(this instanceof Ze))throw new Error(j.CONSTRUCT_ERROR);this.curNode=void 0,this.curBuilding=void 0,this.curOctree=void 0,this.curObject=void 0},Qe=function(t){if(!(this instanceof Qe))throw new Error(j.CONSTRUCT_ERROR);this.currentObjectsRendering=new Ze,this.renderNormals=!0,this.renderTexture=!0,this.magoManager=t};Qe.prototype.renderNodes=function(t,e,i,o,r,n,a,s){t.enable(t.DEPTH_TEST),"true"===l.getPolicy().geo_cull_face_enable?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.enable(t.CULL_FACE),t.frontFace(t.CCW),2===n&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc)),0===n&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc));for(var d=e.length,h=0;h<d;h++)e[h].renderContent(i,o,n,s)},Qe.prototype.getPointsCountForDistance=function(t,e,i){var o=i.magoPolicy.getPointsCloudSettings();return t<=10?Math.floor(o.MaxPerUnitPointsRenderDistToCam0m*e):t<100?Math.floor(o.MaxPerUnitPointsRenderDistToCam100m*e):t<200?Math.floor(o.MaxPerUnitPointsRenderDistToCam200m*e):t<400?Math.floor(o.MaxPerUnitPointsRenderDistToCam400m*e):t<800?Math.floor(o.MaxPerUnitPointsRenderDistToCam800m*e):t<1600?Math.floor(o.MaxPerUnitPointsRenderDistToCam1600m*e):Math.floor(o.MaxPerUnitPointsRenderDistToCamMoreThan1600m*e)},Qe.prototype.renderPCloud=function(t,e,i,o,r,n){if(0!==e.vbo_vicks_container.vboCacheKeysArray.length){t.frontFace(t.CCW);var a=e.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(0!==s){var l=this.getPointsCountForDistance(n,s,i);if(i.isCameraMoving&&(l=Math.floor(l/5)),!(l<=0))if(0===r){if(!a.bindDataPosition(o,i.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l)}else if(1===r){if(!a.bindDataPosition(o,i.vboMemoryManager))return!1;if(!a.bindDataColor(o,i.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l)}}}},Qe.prototype.renderNeoBuildingsPCloud=function(t,e,i,o,r,n){var a,s,l;t.uniform1f(o.fixPointSize_loc,1),t.uniform1i(o.bUseFixPointSize_loc,!1);for(var d=e.length,h=0;h<d;h++)if(s=(a=e[h]).getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding)&&void 0!==l.octree){var c=l.metaData.projectDataType,u=s.getCurrentGeoLocationData();if(t.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,u.rotMatrix._floatArrays),t.uniform3fv(o.buildingPosHIGH_loc,u.positionHIGH),t.uniform3fv(o.buildingPosLOW_loc,u.positionLOW),void 0!==c&&5===c){void 0===i.myCameraRelative&&(i.myCameraRelative=new v);var f=i.myCameraRelative;f.frustum.copyParametersFrom(i.myCameraSCX.bigFrustum),(f=u.getTransformedRelativeCamera(i.sceneState.camera,f)).calculateFrustumsPlanes();n=n;l.octree.test__renderPCloud(i,l,n,o,f,!0)}}o.disableVertexAttribArrayAll()},Qe.prototype.enableStencilBuffer=function(t){t.enable(t.STENCIL_TEST),t.stencilFunc(t.ALWAYS,1,1),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.enable(t.POLYGON_OFFSET_FILL)},Qe.prototype.disableStencilBuffer=function(t){t.disable(t.STENCIL_TEST),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.disable(t.POLYGON_OFFSET_FILL)},Qe.prototype.renderObject=function(t,e,i,o,r,n){var a=e.getVboKeysContainer();if(void 0!==a&&0!==a.vboCacheKeysArray.length){void 0===n&&(n=!1);for(var s=a.getVbosCount(),l=0;l<s;l++){var d=a.vboCacheKeysArray[l],h=d.vertexCount;if(0===h)return;if(!d.bindDataPosition(o,i.vboMemoryManager))return!1;if(1===r){if(!d.bindDataNormal(o,i.vboMemoryManager))return!1;if(!d.bindDataColor(o,i.vboMemoryManager))return!1}if(!1===n)if(d.indicesCount>0){if(!d.bindDataIndice(o,i.vboMemoryManager))return!1;t.drawElements(t.TRIANGLES,d.indicesCount,t.UNSIGNED_SHORT,0)}else t.drawArrays(t.TRIANGLES,0,h);else t.drawArrays(t.LINE_STRIP,0,h);if(t.getError()!==t.NO_ERROR);}}},Qe.prototype.renderGeometryDepth=function(t,e,i){var o,r=this.magoManager;if(void 0!==r.modeler){(o=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),o.program,o.useProgram(),o.disableVertexAttribArrayAll(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),t.uniform1i(o.bApplySsao_loc,!1);var n=0;e=0;r.modeler.render(r,o,e),o.disableVertexAttribArrayAll(),t.useProgram(null)}var a=i.currentVisibles0.length,s=i.currentVisibles2.length,l=i.currentVisibles3.length;if((a>0||s>0||l>0)&&0===r.currentFrustumIdx){(o=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),o.program,o.useProgram(),o.disableVertexAttribArrayAll(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals();n=0;r.renderer.renderNodes(t,i.currentVisibles0,r,o,!1,e,0,0,n),o.disableVertexAttribArray(o.position3_loc),t.useProgram(null)}if(r.visibleObjControlerNodes.currentVisiblesAux.length>0){(o=r.postFxShadersManager.getShader("pointsCloudDepth")).useProgram(),o.resetLastBuffersBinded(),o.disableVertexAttribArrayAll(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals();var d=r.magoPolicy.getPointsCloudSettings();t.uniform1f(o.maxPointSize_loc,d.maxPointSize),t.uniform1f(o.minPointSize_loc,d.minPointSize),t.uniform1f(o.pendentPointSize_loc,d.pendentPointSize),void 0===r.visibleObjControlerPCloudOctrees&&(r.visibleObjControlerPCloudOctrees=new gt),r.visibleObjControlerPCloudOctrees.clear(),r.renderer.renderNeoBuildingsPCloud(t,r.visibleObjControlerNodes.currentVisiblesAux,r,o,!1,e),o.disableVertexAttribArrayAll(),t.useProgram(null);var h=r.visibleObjControlerPCloudOctrees.currentVisibles0,c=h.length,u=0;if(!r.isCameraMoving&&!r.mouseLeftDown&&!r.mouseMiddleDown)for(var f=0;f<c;f++){if(h[f].preparePCloudData(r)&&u++,u>1)break}}if(r.weatherStation&&r.weatherStation.test_renderCuttingPlanes(r,e),void 0!==r.tinTerrainManager){r.tinTerrainManager.render(r,!0),t.useProgram(null)}var g=r.selectionManager.getSelectionCandidatesFamily("general");if(g){var p=g.currentSelected;p&&p instanceof te&&r.test_renderDepth_objectSelected(p)}},Qe.prototype.renderAtmosphere=function(){},Qe.prototype.renderGeometry=function(t,e,i){var o,r,n,s;t.frontFace(t.CCW),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE);var l=this.magoManager,d=l._settings.getRenderingSettings();if(0===e&&(t.disable(t.BLEND),l.renderer.renderGeometryDepth(t,e,i),l.magoPolicy.getShowOrigin()&&void 0!==l.nodeSelected)){var h=[s=l.nodeSelected];this.renderAxisNodes(h,e)}if(1===e){var c=l.texturesManager.getTextureAux1x1(),u=l.texturesManager.getNoiseTexture4x4();if(void 0!==l.tinTerrainManager){t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);l.tinTerrainManager.render(l,!1,e),void 0===l.sky&&(l.sky=new Ee),(o=l.postFxShadersManager.getShader("atmosphere")).useProgram();var f=!1;t.uniform1i(o.bApplySsao_loc,f),t.uniform1i(o.bApplySpecularLighting_loc,!1),t.disableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.colorType_loc,0),t.uniform4fv(o.oneColor4_loc,[.1,.8,.99,1]),t.uniform3fv(o.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(o.buildingPosLOW_loc,[0,0,0]),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,l.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,u),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,c),o.last_tex_id=c;var g=0,p=0,v=(e=1,0),y=void 0;l.sky.render(l,o,e,y),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),t.useProgram(null)}if(void 0!==l.modeler){(o=l.postFxShadersManager.getShader("modelRefSsao")).useProgram(),t.uniform1i(o.bApplySsao_loc,!0),t.uniform1i(o.bApplySpecularLighting_loc,!0),t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),t.enableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&t.disableVertexAttribArray(o.color4_loc),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.textureFlipYAxis_loc,l.sceneState.textureFlipYAxis),t.uniform1i(o.colorType_loc,0),t.uniform4fv(o.oneColor4_loc,[1,1,1,1]),o.bindUniformGenerals(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,l.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,u),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,c),o.last_tex_id=c;g=0,p=0,e=1,v=0;l.modeler.render(l,o,e),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),t.useProgram(null)}l.checkChangesHistoryMovements(i.currentVisibles0),l.checkChangesHistoryColors(i.currentVisibles0),l.checkChangesHistoryMovements(i.currentVisibles2),l.checkChangesHistoryColors(i.currentVisibles2),l.checkChangesHistoryMovements(i.currentVisibles3),l.checkChangesHistoryColors(i.currentVisibles3);var m=i.currentVisibles0.length,x=i.currentVisibles2.length,b=i.currentVisibles3.length;if(m>0||x>0||b>0){t.enable(t.BLEND),(o=l.postFxShadersManager.getShader("modelRefSsao")).useProgram();f=!1;0===l.currentFrustumIdx&&(f=!0),t.uniform1i(o.bApplySsao_loc,f),t.uniform1i(o.bApplySpecularLighting_loc,!0),t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),t.enableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&t.disableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.textureFlipYAxis_loc,l.sceneState.textureFlipYAxis),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,l.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,u),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,c),o.last_tex_id=c;g=0,p=0,e=1,v=0;l.renderer.renderNodes(t,i.currentVisibles0,l,o,!1,e,p,g),f=!1,t.uniform1i(o.bApplySsao_loc,f),l.renderer.renderNodes(t,i.currentVisibles2,l,o,!1,e,p,g),l.renderer.renderNodes(t,i.currentVisibles3,l,o,!1,e,p,g),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),t.useProgram(null)}if(l.nodeSelected){if(l.magoPolicy.getObjectMoveMode()===a.moveMode.OBJECT&&l.objectSelected){var C=(s=l.nodeSelected).getNodeGeoLocDataManager();n=l.buildingSelected;var A=C.getCurrentGeoLocationData();l.octreeSelected.neoReferencesMotherAndIndices,y=t.POINTS;y=t.TRIANGLES;v=0;(o=l.postFxShadersManager.getModelRefSilhouetteShader()).useProgram(),o.enableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc),A.bindGeoLocationUniforms(t,o),t.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,l.sceneState.modelViewProjRelToEyeMatrix._floatArrays),t.uniformMatrix4fv(o.ModelViewMatrixRelToEye_loc,!1,l.sceneState.modelViewRelToEyeMatrix._floatArrays),t.uniform3fv(o.cameraPosHIGH_loc,l.sceneState.encodedCamPosHigh),t.uniform3fv(o.cameraPosLOW_loc,l.sceneState.encodedCamPosLow),t.uniform4fv(o.color4Aux_loc,[0,1,0,1]),t.uniform2fv(o.screenSize_loc,[l.sceneState.drawingBufferWidth,l.sceneState.drawingBufferHeight]),t.uniformMatrix4fv(o.ProjectionMatrix_loc,!1,l.sceneState.projectionMatrix._floatArrays),t.enable(t.STENCIL_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.depthRange(0,0),t.stencilFunc(t.EQUAL,0,1),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE),y=t.TRIANGLES;p=0;var M=.003;t.uniform2fv(o.camSpacePixelTranslation_loc,[M,M]),l.objectSelected.render(l,n,0,!1,o,v,p),t.uniform2fv(o.camSpacePixelTranslation_loc,[-M,M]),l.objectSelected.render(l,n,0,!1,o,v,p),t.uniform2fv(o.camSpacePixelTranslation_loc,[M,-M]),l.objectSelected.render(l,n,0,!1,o,v,p),t.uniform2fv(o.camSpacePixelTranslation_loc,[-M,-M]),l.objectSelected.render(l,n,0,!1,o,v,p),t.enable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.depthRange(0,1),o.disableVertexAttribArrayAll(),t.useProgram(null)}if(l.magoPolicy.getObjectMoveMode()===a.moveMode.ALL&&l.buildingSelected&&void 0!==(s=l.nodeSelected)){C=s.getNodeGeoLocDataManager();n=l.buildingSelected;A=C.getCurrentGeoLocationData();(o=l.postFxShadersManager.getModelRefSilhouetteShader()).useProgram(),t.enableVertexAttribArray(o.position3_loc),A.bindGeoLocationUniforms(t,o),t.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,l.sceneState.modelViewProjRelToEyeMatrix._floatArrays),t.uniformMatrix4fv(o.ModelViewMatrixRelToEye_loc,!1,l.sceneState.modelViewRelToEyeMatrix._floatArrays),t.uniform3fv(o.cameraPosHIGH_loc,l.sceneState.encodedCamPosHigh),t.uniform3fv(o.cameraPosLOW_loc,l.sceneState.encodedCamPosLow),t.uniform4fv(o.color4Aux_loc,[0,1,0,1]),t.uniform2fv(o.screenSize_loc,[l.sceneState.drawingBufferWidth,l.sceneState.drawingBufferHeight]),t.uniformMatrix4fv(o.ProjectionMatrix_loc,!1,l.sceneState.projectionMatrix._floatArrays),t.uniform3fv(o.aditionalMov_loc,[0,0,0]),t.enable(t.STENCIL_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.depthRange(0,0),t.stencilFunc(t.EQUAL,0,1),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE),y=t.TRIANGLES,t.uniform1i(o.refMatrixType_loc,0);g=0,p=0,e=0,v=0,M=.004;t.uniform2fv(o.camSpacePixelTranslation_loc,[M,M]),l.renderer.renderNodes(t,[s],l,o,!1,e,p,g),t.uniform2fv(o.camSpacePixelTranslation_loc,[-M,M]),l.renderer.renderNodes(t,[s],l,o,!1,e,p,g),t.uniform2fv(o.camSpacePixelTranslation_loc,[M,-M]),l.renderer.renderNodes(t,[s],l,o,!1,e,p,g),t.uniform2fv(o.camSpacePixelTranslation_loc,[-M,-M]),l.renderer.renderNodes(t,[s],l,o,!1,e,p,g),o.disableVertexAttribArrayAll()}if(l.magoPolicy.getShowOrigin()){h=[s=l.nodeSelected];this.renderAxisNodes(h,e)}}var P=l.visibleObjControlerNodes.currentVisiblesAux.length;if((m>0||x>0||b>0||P>0)&&l.magoPolicy.getShowBoundingBox()){this.renderBoundingBoxesNodes(l.visibleObjControlerNodes.currentVisibles0,void 0,!0),this.renderBoundingBoxesNodes(l.visibleObjControlerNodes.currentVisibles2,void 0,!0),this.renderBoundingBoxesNodes(l.visibleObjControlerNodes.currentVisibles3,void 0,!0),this.renderBoundingBoxesNodes(l.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}var T=l.objMarkerManager.objectMarkerArray.length;if(T>0){void 0===l.pin.positionBuffer&&l.pin.createPinCenterBottom(t),(o=l.postFxShadersManager.pngImageShader).resetLastBuffersBinded(),r=o.program,t.useProgram(r),t.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,l.sceneState.modelViewProjRelToEyeMatrix._floatArrays),t.uniform3fv(o.cameraPosHIGH_loc,l.sceneState.encodedCamPosHigh),t.uniform3fv(o.cameraPosLOW_loc,l.sceneState.encodedCamPosLow),t.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,l.sceneState.modelViewRelToEyeMatrixInv._floatArrays),t.uniform1i(o.textureFlipYAxis_loc,l.sceneState.textureFlipYAxis),t.uniform1i(o.texture_loc,0),t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),t.activeTexture(t.TEXTURE0),t.depthRange(0,0),t.bindBuffer(t.ARRAY_BUFFER,l.pin.positionBuffer),t.vertexAttribPointer(o.position3_loc,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,l.pin.texcoordBuffer),t.vertexAttribPointer(o.texCoord2_loc,2,t.FLOAT,!1,0,0);for(var _=0,w=0;w<T;w++){_>=l.pin.texturesArray.length&&(_=0);var S=l.pin.texturesArray[_],R=l.objMarkerManager.objectMarkerArray[w].geoLocationData;t.bindTexture(t.TEXTURE_2D,S.texId),t.uniform3fv(o.buildingPosHIGH_loc,R.positionHIGH),t.uniform3fv(o.buildingPosLOW_loc,R.positionLOW),t.drawArrays(t.TRIANGLES,0,6),_++}t.depthRange(0,1),t.useProgram(null),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll()}if(l.visibleObjControlerNodes.currentVisiblesAux.length>0){l.sceneState.camera.setCurrentFrustum(0);var L=l.currentFrustumIdx;l.sceneState.camera.frustum.near[0]=l.sceneState.camera.frustumsArray[L].near[0],l.sceneState.camera.frustum.far[0]=l.sceneState.camera.frustumsArray[L].far[0],(o=d.getApplySsao()?d.getPointsCloudInColorRamp()?l.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):l.postFxShadersManager.getShader("pointsCloudSsao"):d.getPointsCloudInColorRamp()?l.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):l.postFxShadersManager.getShader("pointsCloud")).useProgram(),o.resetLastBuffersBinded(),o.enableVertexAttribArray(o.position3_loc),o.enableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1);f=!0;t.uniform1i(o.bApplySsao_loc,f),void 0!==l.pointsCloudWhite&&l.pointsCloudWhite?(t.uniform1i(o.bUse1Color_loc,!0),t.uniform4fv(o.oneColor4_loc,[.99,.99,.99,1])):t.uniform1i(o.bUse1Color_loc,!1);var D=l.magoPolicy.getPointsCloudSettings();t.uniform1i(o.bUseColorCodingByHeight_loc,!0),t.uniform1f(o.minHeight_rainbow_loc,D.minHeightRainbow),t.uniform1f(o.maxHeight_rainbow_loc,D.maxHeightRainbow),t.uniform1f(o.maxPointSize_loc,D.maxPointSize),t.uniform1f(o.minPointSize_loc,D.minPointSize),t.uniform1f(o.pendentPointSize_loc,D.pendentPointSize),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,l.depthFboNeo.colorBuffer),void 0===l.visibleObjControlerPCloudOctrees&&(l.visibleObjControlerPCloudOctrees=new gt),l.visibleObjControlerPCloudOctrees.clear(),l.renderer.renderNeoBuildingsPCloud(t,l.visibleObjControlerNodes.currentVisiblesAux,l,o,!1,e),o.disableVertexAttribArrayAll(),t.useProgram(null)}}t.disable(t.BLEND),t.depthRange(0,1)},Qe.prototype.renderAxisNodes=function(t,e){var i=this.magoManager;0===i.axisXYZ.vbo_vicks_container.vboCacheKeysArray.length&&i.axisXYZ.makeMesh(30).getVboTrianglesConvex(i.axisXYZ.vbo_vicks_container,i.vboMemoryManager);var o,r,n=i.getGl();0===e&&(r=i.postFxShadersManager.getShader("modelRefDepth"),n.disable(n.BLEND)),1===e&&(r=i.postFxShadersManager.getShader("modelRefSsao"),n.enable(n.BLEND));var a=i.texturesManager.getNoiseTexture4x4();r.useProgram(),n.uniform1i(r.bApplySsao_loc,!0),n.uniform1i(r.refMatrixType_loc,0),n.uniform1i(r.colorType_loc,1),r.disableVertexAttribArray(r.texCoord2_loc);r.program;if(r.bindUniformGenerals(),n.enableVertexAttribArray(r.position3_loc),1===e){var s=i.texturesManager.getTextureAux1x1();n.enableVertexAttribArray(r.normal3_loc),n.enableVertexAttribArray(r.color4_loc),n.uniform1i(r.bUse1Color_loc,!1),n.uniform4fv(r.oneColor4_loc,[1,.1,.1,1]),n.uniform1i(r.bUseNormal_loc,!0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,a),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,s)}for(var l=t.length,d=0;d<l;d++){(o=t[d]).data.neoBuilding,n.uniform3fv(r.scale_loc,[1,1,1]),o.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(n,r),n.uniform3fv(r.aditionalMov_loc,[0,0,0]),i.renderer.renderObject(n,i.axisXYZ,i,r,e)}r.disableVertexAttribArrayAll(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,null),n.disable(n.BLEND)},Qe.prototype.renderBoundingBoxesNodes=function(t,e,i){var o=this.magoManager,r=o.getGl();if(void 0!==t&&0!==t.length){var n;void 0===o.unitaryBoxSC&&(o.unitaryBoxSC=new Qt,o.unitaryBoxSC.makeAABB(1,1,1),o.unitaryBoxSC.vBOVertexIdxCacheKey=o.unitaryBoxSC.triPolyhedron.getVBOArrayModePosNorCol(o.unitaryBoxSC.vBOVertexIdxCacheKey,o.vboMemoryManager));var a=o.postFxShadersManager.getTriPolyhedronShader(),s=a.program;r.enable(r.BLEND),r.frontFace(r.CCW),r.useProgram(s),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),r.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,o.sceneState.modelViewProjRelToEyeMatrix._floatArrays),r.uniformMatrix4fv(a.modelViewMatrix4RelToEye_loc,!1,o.sceneState.modelViewRelToEyeMatrix._floatArrays),r.uniformMatrix4fv(a.modelViewMatrix4_loc,!1,o.sceneState.modelViewMatrix._floatArrays),r.uniformMatrix4fv(a.projectionMatrix4_loc,!1,o.sceneState.projectionMatrix._floatArrays),r.uniform3fv(a.cameraPosHIGH_loc,o.sceneState.encodedCamPosHigh),r.uniform3fv(a.cameraPosLOW_loc,o.sceneState.encodedCamPosLow),r.uniform1f(a.near_loc,o.sceneState.camera.frustum.near),r.uniform1f(a.far_loc,o.sceneState.camera.frustum.far),r.uniform1i(a.bApplySsao_loc,!1),r.uniformMatrix4fv(a.normalMatrix4_loc,!1,o.sceneState.normalMatrix4._floatArrays),r.uniform1i(a.hasAditionalMov_loc,!0),r.uniform3fv(a.aditionalMov_loc,[0,0,0]),r.uniform1i(a.bScale_loc,!0);r.uniform1i(a.bUse1Color_loc,!0),e?r.uniform4fv(a.oneColor4_loc,[e.r,e.g,e.b,1]):r.uniform4fv(a.oneColor4_loc,[1,0,1,1]),r.uniform1i(a.depthTex_loc,0),r.uniform1i(a.noiseTex_loc,1),r.uniform1i(a.diffuseTex_loc,2),r.uniform1f(a.fov_loc,o.sceneState.camera.frustum.fovyRad),r.uniform1f(a.aspectRatio_loc,o.sceneState.camera.frustum.aspectRatio),r.uniform1f(a.screenWidth_loc,o.sceneState.drawingBufferWidth),r.uniform1f(a.screenHeight_loc,o.sceneState.drawingBufferHeight);var l,d=o.texturesManager.getNoiseTexture4x4();r.uniform2fv(a.noiseScale2_loc,[o.depthFboNeo.width/d.width,o.depthFboNeo.height/d.height]),r.uniform3fv(a.kernel16_loc,o.kernel),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,o.depthFboNeo.colorBuffer),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,d);for(var h=t.length,c=0;c<h;c++){a.resetLastBuffersBinded(),(n=t[c]).data.neoBuilding,l=n.getBBox(),r.uniform3fv(a.scale_loc,[l.getXLength(),l.getYLength(),l.getZLength()]),n.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(r,a),o.pointSC=l.getCenterPoint(o.pointSC),r.uniform3fv(a.aditionalMov_loc,[o.pointSC.x,o.pointSC.y,o.pointSC.z]),this.renderObject(r,o.unitaryBoxSC,o,a,1,i)}a.resetLastBuffersBinded(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),r.disable(r.BLEND)}},Qe.prototype.renderFilter=function(){var t=this.magoManager,e=t.getGl();if(void 0===t.screenQuad){t.sceneState;var i=t.myCameraSCX.bigFrustum,o=(t.sceneState.camera.frustum.fovyRad,i.aspectRatio[0]),r=i.tangentOfHalfFovy[0],n=r*o,a=new Ce(-n,-r,-1),s=new Ce(n,-r,-1),l=new Ce(n,r,-1),d=new Ce(-n,r,-1),h=new Float32Array([a.x,a.y,a.z,s.x,s.y,s.z,d.x,d.y,d.z,s.x,s.y,s.z,l.x,l.y,l.z,d.x,d.y,d.z]);t.screenQuad=b.createBuffer(e,h)}var c=t.postFxShadersManager.getShader("filterSilhouette");c.useProgram(),e.uniform1i(c.bApplySsao_loc,!0);var u=t.texturesManager.getNoiseTexture4x4();e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.enableVertexAttribArray(c.position3_loc),c.bindUniformGenerals(),e.uniform1i(c.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,u),e.activeTexture(e.TEXTURE2),e.bindBuffer(e.ARRAY_BUFFER,t.screenQuad),e.vertexAttribPointer(c.position3_loc,3,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.disable(e.BLEND),e.enable(e.DEPTH_TEST),c.disableVertexAttribArrayAll(),e.useProgram(null)},Qe.prototype.renderGeometryColorCoding=function(t){var e=this.magoManager,i=e.getGl(),o=e.postFxShadersManager.getShader("modelRefColorCoding");o.useProgram(),o.enableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.bindUniformGenerals(),i.disable(i.CULL_FACE);if(e.renderer.renderNodes(i,t.currentVisibles0,e,o,!1,2,0,0),e.renderer.renderNodes(i,t.currentVisibles2,e,o,!1,2,0,0),e.renderer.renderNodes(i,t.currentVisibles3,e,o,!1,2,0,0),i.enable(i.CULL_FACE),o.disableVertexAttribArray(o.position3_loc),i.useProgram(null),e.weatherStation&&e.weatherStation.test_renderCuttingPlanes(e,2),e.magoPolicy.objectMoveMode===a.moveMode.GEOGRAPHICPOINTS&&void 0!==e.modeler){var r=e.postFxShadersManager.getShader("modelRefColorCoding");r.useProgram(),r.enableVertexAttribArray(r.position3_loc),r.disableVertexAttribArray(r.texCoord2_loc),r.disableVertexAttribArray(r.normal3_loc),r.bindUniformGenerals(),i.disable(i.CULL_FACE),e.modeler.render(e,r,2)}if(void 0!==e.tinTerrainManager){e.tinTerrainManager.render(e,!1,2),i.useProgram(null)}},Qe.prototype.renderMagoGeometries=function(t){this.magoManager};var Je=function(){if(!(this instanceof Je))throw new Error(j.CONSTRUCT_ERROR);this._bApplySsao=!0,this._bPointsCloudInColorRamp=!1};Je.prototype.getApplySsao=function(){return this._bApplySsao},Je.prototype.setApplySsao=function(t){this._bApplySsao=t},Je.prototype.getPointsCloudInColorRamp=function(){return this._bPointsCloudInColorRamp},Je.prototype.setPointsCloudInColorRamp=function(t){this._bPointsCloudInColorRamp=t};var $e=function(){if(!(this instanceof $e))throw new Error(j.CONSTRUCT_ERROR);this.gl,this.modelViewProjRelToEyeMatrix=new B,this.modelViewRelToEyeMatrix=new B,this.modelViewRelToEyeMatrixInv=new B,this.modelViewMatrix=new B,this.modelViewMatrixInv=new B,this.projectionMatrix=new B,this.modelViewProjMatrix=new B,this.normalMatrix4=new B,this.identityMatrix4=new B,this.encodedCamPosHigh=new Float32Array([0,0,0]),this.encodedCamPosLow=new Float32Array([0,0,0]),this.camera=new v,this.drawingBufferWidth=new Int32Array([1e3]),this.drawingBufferHeight=new Int32Array([1e3]),this.mouseAction=new U,this.ambientReflectionCoef=new Float32Array([.45]),this.diffuseReflectionCoef=new Float32Array([.75]),this.specularReflectionCoef=new Float32Array([.6]),this.specularColor=new Float32Array([.7,.7,.7]),this.ssaoRadius=new Float32Array([.15]),this.shininessValue=new Float32Array([40]),this.ssaoNoiseScale2=new Float32Array([1,1]),this.ssaoKernel16=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35]),this.ssaoSphereKernel32=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35,.33,0,-.85,.25,.3,-.5,.1,.3,-.85,-.15,.2,-.85,-.33,.05,-.6,-.1,-.15,-.85,-.05,-.32,-.25,.2,-.15,-.85,.6,0,-.55,.5,.6,-.45,-.01,.7,-.35,-.33,.5,-.45,-.45,0,-.55,-.65,-.5,-.7,0,-.5,-.55,.33,.3,-.35]),this.bMust=!1,this.dc,this.insertIssueState=0,this.textureFlipYAxis=!1,this.mouseButton=-1};$e.prototype.getModelViewMatrixInv=function(){return this.modelViewMatrixInv};var ti=function(){if(!(this instanceof ti))throw new Error(j.CONSTRUCT_ERROR);this.drawing_height,this.drawing_width,this.GAIA_selectFrameBuffer,this.GAIA_selectRenderBuffer,this.GAIA_selectRttTexture,this.currentByteColorPicked=new Uint8Array(4),this.currentSelectedObj_idx=-1};ti.prototype.init=function(t,e,i){this.drawing_height=i,this.drawing_width=e,this.GAIA_selectFrameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.GAIA_selectFrameBuffer),this.GAIA_selectRenderBuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.drawing_width,this.drawing_height),this.GAIA_selectRttTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.GAIA_selectRttTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.drawing_width,this.drawing_height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.GAIA_selectRttTexture,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)};var ei=function(){if(!(this instanceof ei))throw new Error(j.CONSTRUCT_ERROR);this.familyTypeName,this.candidatesMap={},this.currentSelected};ei.prototype.setCandidate=function(t,e){void 0!==t&&e&&(this.candidatesMap[t]=e)},ei.prototype.clearCandidate=function(){this.candidatesMap={},this.currentSelected=void 0},ei.prototype.clearCurrentSelected=function(){this.currentSelected=void 0},ei.prototype.selectObject=function(t){return this.currentSelected=this.candidatesMap[t],this.currentSelected};var ii=function(){if(!(this instanceof ii))throw new Error(j.CONSTRUCT_ERROR);this.selCandidatesMap={},this.currentGeneralObjectSelected,this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.currentReferenceSelected,this.currentOctreeSelected,this.currentBuildingSelected,this.currentNodeSelected,this.selCandidatesFamilyMap={},this.parentSelected=!1};ii.prototype.newCandidatesFamily=function(t){var e=new ei;return e.familyTypeName=t,this.selCandidatesFamilyMap[t]=e,e},ii.prototype.getSelectionCandidatesFamily=function(t){return this.selCandidatesFamilyMap[t]},ii.prototype.setCandidateCustom=function(t,e,i){var o=this.getSelectionCandidatesFamily(e);o&&o.setCandidate(t,i)},ii.prototype.setCandidateGeneral=function(t,e){this.selCandidatesMap[t]=e},ii.prototype.getCandidateGeneral=function(t){return this.selCandidatesMap[t]},ii.prototype.getSelectedGeneral=function(){return this.currentGeneralObjectSelected},ii.prototype.setCandidates=function(t,e,i,o,r){e&&(this.referencesMap[t]=e),i&&(this.octreesMap[t]=i),o&&(this.buildingsMap[t]=o),r&&(this.nodesMap[t]=r)},ii.prototype.clearCandidates=function(){for(var t in this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].clearCandidate()}this.selCandidatesMap={}},ii.prototype.selectObjects=function(t){for(var e in this.currentReferenceSelected=this.referencesMap[t],this.currentOctreeSelected=this.octreesMap[t],this.currentBuildingSelected=this.buildingsMap[t],this.currentNodeSelected=this.nodesMap[t],this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].selectObject(t)}this.currentGeneralObjectSelected=this.selCandidatesMap[t]},ii.prototype.clearCurrents=function(t){for(var e in this.currentReferenceSelected=void 0,this.currentOctreeSelected=void 0,this.currentBuildingSelected=void 0,this.currentNodeSelected=void 0,this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].clearCurrentSelected()}this.currentGeneralObjectSelected=void 0};var oi=function(){if(!(this instanceof oi))throw new Error(j.CONSTRUCT_ERROR);this.attribLocationEnabled=!1},ri=function(t){if(!(this instanceof ri))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name,this.attribLocationCacheObj={},this.uniformsArrayGeneral=[],this.uniformsMapGeneral={},this.uniformsArrayLocal=[],this.uniformsMapLocal={},this.camera,this.program,this.shader_vertex,this.shader_fragment,this.last_vboPos_binded,this.last_vboNor_binded,this.last_vboCol_binded,this.last_vboIdx_binded,this.last_tex_id,this.last_isAditionalMovedZero=!1,this.last_vboTexCoord_binded,this.attribLocationStateArray=[]};ri.prototype.resetLastBuffersBinded=function(){if(this.last_vboPos_binded=void 0,this.last_vboNor_binded=void 0,this.last_vboIdx_binded=void 0,this.last_vboTexCoord_binded=void 0,this.last_tex_id=void 0,this.last_isAditionalMovedZero=!1,this.disableVertexAttribArrayAll(),this.attribLocationStateArray){for(var t=this.attribLocationStateArray.length,e=0;e<t;e++){var i=this.attribLocationStateArray[e];void 0!==i&&(i.attribLocationEnabled=void 0,this.attribLocationStateArray[e]=void 0)}this.attribLocationStateArray.length=0}},ri.prototype.enableVertexAttribArray=function(t){if(!(void 0===t||t<0)){var e=this.attribLocationStateArray[t];void 0===e&&(e=new oi,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!1),e.attribLocationEnabled||(this.gl.enableVertexAttribArray(t),e.attribLocationEnabled=!0)}},ri.prototype.disableTextureImagesUnitsAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),i=0;i<e;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,null)},ri.prototype.disableVertexAttribArrayAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),i=0;i<e;i++)t.disableVertexAttribArray(i)},ri.prototype.disableVertexAttribArray=function(t){if(!(void 0===t||t<0)){var e=this.attribLocationStateArray[t];void 0===e&&(e=new oi,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!0),e.attribLocationEnabled&&(this.gl.disableVertexAttribArray(t),e.attribLocationEnabled=!1)}},ri.prototype.useProgram=function(){var t=this.gl;t.getParameter(t.CURRENT_PROGRAM)!==this.program&&t.useProgram(this.program),this.resetLastBuffersBinded()},ri.prototype.bindUniformGenerals=function(){if(void 0!==this.uniformsArrayGeneral){for(var t=this.uniformsArrayGeneral.length,e=0;e<t;e++)this.uniformsArrayGeneral[e].bindUniform();this.camera&&this.camera.bindUniforms(this.gl,this)}},ri.prototype.newUniformDataPair=function(t,e){var i;return"Matrix4fv"===t?(i=new di(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec4fv"===t?(i=new ui(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec3fv"===t?(i=new ci(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec2fv"===t?(i=new hi(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"1f"===t?(i=new si(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"1i"===t&&(i=new li(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i),i},ri.prototype.newUniformDataPairLocal=function(t,e){var i;return"Matrix4fv"===t?(i=new di(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec4fv"===t?(i=new ui(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec3fv"===t?(i=new ci(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec2fv"===t?(i=new hi(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"1f"===t?(i=new si(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"1i"===t&&(i=new li(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i),i},ri.prototype.createUniformGenerals=function(t,e,i){var o,r;null!==(r=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","mvpMat4RelToEye")).uniformLocation=r,o.matrix4fv=i.modelViewProjRelToEyeMatrix._floatArrays),null!==(r=t.getUniformLocation(e.program,"ModelViewProjectionMatrix"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","mvpMat4")).uniformLocation=r,o.matrix4fv=i.modelViewProjMatrix._floatArrays),null!==(r=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","mvMat4RelToEye")).uniformLocation=r,o.matrix4fv=i.modelViewRelToEyeMatrix._floatArrays),null!==(r=t.getUniformLocation(e.program,"modelViewMatrix"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","modelViewMatrix")).uniformLocation=r,o.matrix4fv=i.modelViewMatrix._floatArrays),null!==(r=t.getUniformLocation(e.program,"projectionMatrix"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","pMat4")).uniformLocation=r,o.matrix4fv=i.projectionMatrix._floatArrays),null!==(r=t.getUniformLocation(e.program,"normalMatrix4"))&&void 0!==r&&((o=e.newUniformDataPair("Matrix4fv","normalMat4")).uniformLocation=r,o.matrix4fv=i.normalMatrix4._floatArrays),null!==(r=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"))&&void 0!==r&&((o=e.newUniformDataPair("Vec3fv","encodedCamPosHigh")).uniformLocation=r,o.vec3fv=i.encodedCamPosHigh),null!==(r=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"))&&void 0!==r&&((o=e.newUniformDataPair("Vec3fv","encodedCamPosLow")).uniformLocation=r,o.vec3fv=i.encodedCamPosLow),null!==(r=t.getUniformLocation(e.program,"fov"))&&void 0!==r&&((o=e.newUniformDataPair("1f","fovyRad")).uniformLocation=r,o.floatValue=i.camera.frustum.fovyRad),null!==(r=t.getUniformLocation(e.program,"aspectRatio"))&&void 0!==r&&((o=e.newUniformDataPair("1f","aspectRatio")).uniformLocation=r,o.floatValue=i.camera.frustum.aspectRatio),null!==(r=t.getUniformLocation(e.program,"screenWidth"))&&void 0!==r&&((o=e.newUniformDataPair("1f","drawBuffWidht")).uniformLocation=r,o.floatValue=i.drawingBufferWidth),null!==(r=t.getUniformLocation(e.program,"screenHeight"))&&void 0!==r&&((o=e.newUniformDataPair("1f","drawBuffHeight")).uniformLocation=r,o.floatValue=i.drawingBufferHeight),null!==(r=t.getUniformLocation(e.program,"depthTex"))&&void 0!==r&&((o=e.newUniformDataPair("1i","depthTex")).uniformLocation=r,o.intValue=0),null!==(r=t.getUniformLocation(e.program,"noiseTex"))&&void 0!==r&&((o=e.newUniformDataPair("1i","noiseTex")).uniformLocation=r,o.intValue=1),null!==(r=t.getUniformLocation(e.program,"diffuseTex"))&&void 0!==r&&((o=e.newUniformDataPair("1i","diffuseTex")).uniformLocation=r,o.intValue=2),null!==(r=t.getUniformLocation(e.program,"specularColor"))&&void 0!==r&&((o=e.newUniformDataPair("Vec3fv","specularColor")).uniformLocation=r,o.vec3fv=i.specularColor),null!==(r=t.getUniformLocation(e.program,"radius"))&&void 0!==r&&((o=e.newUniformDataPair("1f","radius")).uniformLocation=r,o.floatValue=i.ssaoRadius),null!==(r=t.getUniformLocation(e.program,"ambientReflectionCoef"))&&void 0!==r&&((o=e.newUniformDataPair("1f","ambientReflectionCoef")).uniformLocation=r,o.floatValue=i.ambientReflectionCoef),null!==(r=t.getUniformLocation(e.program,"diffuseReflectionCoef"))&&void 0!==r&&((o=e.newUniformDataPair("1f","diffuseReflectionCoef")).uniformLocation=r,o.floatValue=i.diffuseReflectionCoef),null!==(r=t.getUniformLocation(e.program,"specularReflectionCoef"))&&void 0!==r&&((o=e.newUniformDataPair("1f","specularReflectionCoef")).uniformLocation=r,o.floatValue=i.specularReflectionCoef),null!==(r=t.getUniformLocation(e.program,"shininessValue"))&&void 0!==r&&((o=e.newUniformDataPair("1f","shininessValue")).uniformLocation=r,o.floatValue=i.shininessValue),null!==(r=t.getUniformLocation(e.program,"noiseScale"))&&void 0!==r&&((o=e.newUniformDataPair("Vec2fv","ssaoNoiseScale2")).uniformLocation=r,o.vec2fv=i.ssaoNoiseScale2),null!==(r=t.getUniformLocation(e.program,"kernel"))&&void 0!==r&&((o=e.newUniformDataPair("Vec3fv","ssaoKernel16")).uniformLocation=r,o.vec3fv=i.ssaoKernel16),this.camera=i.camera},ri.prototype.bindAttribLocations=function(t,e){t.bindAttribLocation(e.program,0,"position"),t.bindAttribLocation(e.program,1,"normal"),t.bindAttribLocation(e.program,2,"texCoord"),t.bindAttribLocation(e.program,3,"color4")},ri.prototype.createUniformLocals=function(t,e,i){e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.color4_loc=t.getAttribLocation(e.program,"color4"),e.bUse1Color_loc=t.getUniformLocation(e.program,"bUse1Color"),e.oneColor4_loc=t.getUniformLocation(e.program,"oneColor4"),e.bApplySsao_loc=t.getUniformLocation(e.program,"bApplySsao"),e.posDataByteSize_loc=t.getUniformLocation(e.program,"posDataByteSize"),e.texCoordByteSize_loc=t.getUniformLocation(e.program,"texCoordByteSize"),e.compressionMaxPoint_loc=t.getUniformLocation(e.program,"compressionMaxPoint"),e.compressionMinPoint_loc=t.getUniformLocation(e.program,"compressionMinPoint"),e.bApplySpecularLighting_loc=t.getUniformLocation(e.program,"bApplySpecularLighting"),e.colorType_loc=t.getUniformLocation(e.program,"colorType"),e.externalAlpha_loc=t.getUniformLocation(e.program,"externalAlpha"),e.fixPointSize_loc=t.getUniformLocation(e.program,"fixPointSize"),e.bUseFixPointSize_loc=t.getUniformLocation(e.program,"bUseFixPointSize"),e.frustumNear_loc=t.getUniformLocation(e.program,"near"),e.frustumFar_loc=t.getUniformLocation(e.program,"far")};var ni=function(){if(!(this instanceof ni))throw new Error(j.CONSTRUCT_ERROR);this.gl,this.pFx_shaders_array=[],this.shadersMap={},this.modelRefShader,this.modelRefSilhouetteShader,this.lodBuildingShader};ni.prototype.newShader=function(t){var e=new ri(this.gl);return e.name=t,this.shadersMap[t]=e,e},ni.prototype.getShader=function(t){return this.shadersMap[t]},ni.prototype.createShader=function(t,e,i,o){var r=t.createShader(i);return t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert("ERROR IN "+o+" SHADER : "+t.getShaderInfoLog(r)),!1)},ni.prototype.createDefaultShaders=function(t,e){this.pngImageShader=this.createPngImageShader(t),this.modelRefSilhouetteShader=this.createSilhouetteShaderModelRef(t),this.triPolyhedronShader=this.createSsaoShaderBox(t)},ni.prototype.getModelRefSilhouetteShader=function(){return this.modelRefSilhouetteShader},ni.prototype.getTriPolyhedronDepthShader=function(){return this.triPolyhedronDepthShader},ni.prototype.getTriPolyhedronShader=function(){return this.triPolyhedronShader},ni.prototype.getInvertedBoxShader=function(){return this.invertedBoxShader},ni.prototype.createPngImageShader=function(t){var e=new ri(this.gl);this.pFx_shaders_array.push(e);var i=ai.PngImageVS,o=ai.PngImageFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.texture_loc=t.getUniformLocation(e.program,"u_texture"),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.position3_loc=t.getAttribLocation(e.program,"a_position"),e.texCoord2_loc=t.getAttribLocation(e.program,"a_texcoord"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e},ni.prototype.createSilhouetteShaderModelRef=function(t){var e=new ri(this.gl);e.name="SilhouetteShaderModelRef",this.pFx_shaders_array.push(void 0);var i=ai.SilhouetteVS,o=ai.SilhouetteFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.camSpacePixelTranslation_loc=t.getUniformLocation(e.program,"camSpacePixelTranslation"),e.screenSize_loc=t.getUniformLocation(e.program,"screenSize"),e.ProjectionMatrix_loc=t.getUniformLocation(e.program,"ProjectionMatrix"),e.ModelViewMatrixRelToEye_loc=t.getUniformLocation(e.program,"ModelViewMatrixRelToEye"),e},ni.prototype.createSsaoShaderBox=function(t){var e=new ri(this.gl);this.pFx_shaders_array.push(e);var i=ai.BoxSsaoVS,o=ai.BoxSsaoFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewMatrix4RelToEye_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.normalMatrix4_loc=t.getUniformLocation(e.program,"normalMatrix4"),e.projectionMatrix4_loc=t.getUniformLocation(e.program,"projectionMatrix"),e.modelViewMatrix4_loc=t.getUniformLocation(e.program,"modelViewMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.bUse1Color_loc=t.getUniformLocation(e.program,"bUse1Color"),e.oneColor4_loc=t.getUniformLocation(e.program,"oneColor4"),e.bUseNormal_loc=t.getUniformLocation(e.program,"bUseNormal"),e.bScale_loc=t.getUniformLocation(e.program,"bScale"),e.scale_loc=t.getUniformLocation(e.program,"scale"),t.bindAttribLocation(e.program,0,"position"),t.bindAttribLocation(e.program,1,"normal"),t.bindAttribLocation(e.program,2,"texCoord"),t.bindAttribLocation(e.program,3,"color4"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.color4_loc=t.getAttribLocation(e.program,"color4"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.normal=t.getAttribLocation(e.program,"normal"),e.attribLocationCacheObj.color4=t.getAttribLocation(e.program,"color4"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.near_loc=t.getUniformLocation(e.program,"near"),e.far_loc=t.getUniformLocation(e.program,"far"),e.fov_loc=t.getUniformLocation(e.program,"fov"),e.aspectRatio_loc=t.getUniformLocation(e.program,"aspectRatio"),e.screenWidth_loc=t.getUniformLocation(e.program,"screenWidth"),e.screenHeight_loc=t.getUniformLocation(e.program,"screenHeight"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.depthTex_loc=t.getUniformLocation(e.program,"depthTex"),e.noiseTex_loc=t.getUniformLocation(e.program,"noiseTex"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.useRefTransfMatrix_loc=t.getUniformLocation(e.program,"useRefTransfMatrix"),e.useTexture_loc=t.getUniformLocation(e.program,"useTexture"),e.invertNormals_loc=t.getUniformLocation(e.program,"invertNormals"),e},ni.prototype.createInvertedBoxShader=function(t){var e=new ri(this.gl);this.pFx_shaders_array.push(void 0);var i=ai.InvertedBoxVS,o=ai.InvertedBoxFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewMatrix4RelToEye_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.normalMatrix4_loc=t.getUniformLocation(e.program,"normalMatrix4"),e.projectionMatrix4_loc=t.getUniformLocation(e.program,"projectionMatrix"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.texCoord=t.getAttribLocation(e.program,"texCoord"),e.attribLocationCacheObj.normal=t.getAttribLocation(e.program,"normal"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.near_loc=t.getUniformLocation(e.program,"near"),e.far_loc=t.getUniformLocation(e.program,"far"),e.fov_loc=t.getUniformLocation(e.program,"fov"),e.aspectRatio_loc=t.getUniformLocation(e.program,"aspectRatio"),e.screenWidth_loc=t.getUniformLocation(e.program,"screenWidth"),e.screenHeight_loc=t.getUniformLocation(e.program,"screenHeight"),e.shininessValue_loc=t.getUniformLocation(e.program,"shininessValue"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.depthTex_loc=t.getUniformLocation(e.program,"depthTex"),e.noiseTex_loc=t.getUniformLocation(e.program,"noiseTex"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.specularColor_loc=t.getUniformLocation(e.program,"specularColor"),e.ssaoRadius_loc=t.getUniformLocation(e.program,"radius"),e.ambientReflectionCoef_loc=t.getUniformLocation(e.program,"ambientReflectionCoef"),e.diffuseReflectionCoef_loc=t.getUniformLocation(e.program,"diffuseReflectionCoef"),e.specularReflectionCoef_loc=t.getUniformLocation(e.program,"specularReflectionCoef"),e};var ai={atmosphereFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 v3Pos;\nvarying vec3 camPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform float externalAlpha;\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}               \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}\n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{  \n\tfloat camElevation = length(camPos) - equatorialRadius;\n\tif(v3Pos.z > (camElevation + equatorialRadius))\n\t\tdiscard;\n\t\t\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\n\tfloat linearDepth = getDepth(screenPos);\n\tif(linearDepth < 1.0)\n\tdiscard;\n\t\n\tfloat distToCam = length(vec3(v3Pos));\n\t\n\tif(bIsMakingDepth)\n\t{\n\t\tgl_FragColor = packDepth(-depthValue);\n\t}\n\telse{\n\t\tvec4 textureColor;\n\t\tif(colorType == 0)\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 2)\n\t\t{\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\t\t// Calculate the angle between camDir & vNormal.***\n\t\tvec3 camDir = normalize(vec3(v3Pos.x, v3Pos.y*0.5, -v3Pos.z));\n\t\tvec3 normal = vNormal;\n\t\tfloat angRad = acos(dot(camDir, normal));\n\t\tfloat angDeg = angRad*180.0/PI;\n\n\t\tif(angDeg > 130.0)\n\t\t\ttextureColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\telse if(angDeg > 120.0)\n\t\t\ttextureColor = vec4(0.0, 1.0, 0.0, 1.0);\n\t\telse if(angDeg > 110.0)\n\t\t\ttextureColor = vec4(0.0, 0.0, 1.0, 1.0);\n\t\telse if(angDeg > 100.0)\n\t\t\ttextureColor = vec4(1.0, 1.0, 0.0, 1.0);\n\t\telse if(angDeg > 90.0)\n\t\t\ttextureColor = vec4(1.0, 0.0, 1.0, 1.0);\n\t\t\t\n\t\t//textureColor = vec4(vNormal, 1.0);\n\t\t\n\t\tfloat maxAngDeg = 105.0;\n\t\tfloat A = 1.0/(maxAngDeg-95.0);\n\t\tfloat B = -A*95.0;\n\t\tfloat alpha = A*angDeg+B;\n\t\tif(alpha < 0.0 )\n\t\talpha = 0.0;\n\t\t\n\t\tfloat alphaPlusPerDist = 4.0*(distToCam/equatorialRadius);\n\t\tif(alphaPlusPerDist > 1.0)\n\t\talphaPlusPerDist = 1.0;\n\n\t\ttextureColor = vec4(alpha*0.6*alphaPlusPerDist, alpha*0.9*alphaPlusPerDist, alpha, 1.0);\n\n\n\t\tgl_FragColor = vec4(textureColor.xyz, alpha); \n\t}\n}",atmosphereVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec3 v3Pos;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 camPos;\n\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\tvNormal = (normalMatrix4 * vec4(normal, 0.0)).xyz;\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tcamPos = encodedCameraPositionMCHigh.xyz + encodedCameraPositionMCLow.xyz;\n\tv3Pos = gl_Position.xyz;\n\t\n}",BlendingCubeFS:"\tprecision lowp float;\n\tvarying vec4 vColor;\n\n\tvoid main()\n    {\n\t\tgl_FragColor = vColor;\n\t}",BlendingCubeVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec4 color;\nvarying vec4 vColor;\n\nvoid main()\n{\n    vec3 highDifference = -encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = position.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(position.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",BlurFS:"#ifdef GL_ES\n    precision highp float;\n    #endif\nuniform sampler2D colorTex;\nuniform vec2 texelSize;\nvarying vec2 vTexCoord; \t \t\n\nvoid main()\n{\n    vec3 result = vec3(0.0);\n    for (int i = 0; i < 4; ++i) {\n        for (int j = 0; j < 4; ++j) {\n            vec2 offset = vec2(texelSize.x * float(j), texelSize.y * float(i));\n            result += texture2D(colorTex, vTexCoord + offset).rgb;\n        }\n    }\n            \n    gl_FragColor.rgb = vec3(result * 0.0625); \n    gl_FragColor.a = 1.0;\n}\n",BlurVS:"attribute vec4 position;\nattribute vec2 texCoord;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;  \n\nvarying vec2 vTexCoord;\n\nvoid main()\n{\t\n    vTexCoord = texCoord;\n    \n    gl_Position = projectionMatrix * modelViewMatrix * position;\n}\n",BoxSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\nuniform bool bUseNormal;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nconst int kernelSize = 16;  \nconst float radius = 0.5;      \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{ \n\tvec4 textureColor;\n\ttextureColor = vcolor4;  \n\tif(bUseNormal)\n    {\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos);          \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\t\tvec3 normal2 = vNormal;   \n\t\t\t\t\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfloat occlusion = 0.0;\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n\t\t\tif (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t\t\n\t\t}   \n\t\t\t\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\t\t\t\t\t\t\n\t\tvec3 lightPos = vec3(10.0, 10.0, 10.0);\n\t\tvec3 L = normalize(lightPos);\n\t\tfloat DiffuseFactor = dot(normal2, L);\n\t\tfloat NdotL = abs(DiffuseFactor);\n\t\tvec3 diffuse = vec3(NdotL);\n\t\tvec3 ambient = vec3(1.0);\n\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n\t\tgl_FragColor.a = 1.0; \n\t}\n\telse\n\t{\n\t\tgl_FragColor.rgb = vec3(textureColor.xyz); \n\t\tgl_FragColor.a = 1.0; \n\t}\t\n}\n",BoxSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool bUseNormal;\nuniform vec3 scale;\nuniform bool bScale;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 position2 = vec4(position.xyz, 1.0);\n    if(bScale)\n    {\n        position2.x *= scale.x;\n        position2.y *= scale.y;\n        position2.z *= scale.z;\n    }\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    if(bUseNormal)\n    {\n\t\tvec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8, 0.8, 0.8);\n\t\tvec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n\t\tvec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t}\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",CloudFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",CloudVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 cloudPosHIGH;\nuniform vec3 cloudPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec3 objPosHigh = cloudPosHIGH;\n    vec3 objPosLow = cloudPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",ColorFS:"precision mediump float;\nuniform int byteColor_r;\nuniform int byteColor_g;\nuniform int byteColor_b;\n\nvoid main()\n{\n    float byteMaxValue = 255.0;\n\n    gl_FragColor = vec4(float(byteColor_r)/byteMaxValue, float(byteColor_g)/byteMaxValue, float(byteColor_b)/byteMaxValue, 1);\n}\n",ColorSelectionSsaoFS:"precision highp float;\nuniform vec4 oneColor4;\n\nvoid main()\n{          \n    gl_FragColor = oneColor4;\n}\n",ColorSelectionSsaoVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvoid main()\n{\n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_PointSize = 10.0;\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",ColorVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",draw_frag:"precision mediump float;\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n}\n",draw_vert:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.0;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",draw_vert3D:"precision mediump float;\n\n\t// This shader draws windParticles in 3d directly from positions on u_particles image.***\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\nuniform mat4 ModelViewProjectionMatrix;\n\nvarying vec2 v_particle_pos;\n\n#define M_PI 3.1415926535897932384626433832795\nvec4 geographicToWorldCoord(float lonDeg, float latDeg, float alt)\n{\n\t// defined in the LINZ standard LINZS25000 (Standard for New Zealand Geodetic Datum 2000)\n\t// https://www.linz.govt.nz/data/geodetic-system/coordinate-conversion/geodetic-datum-conversions/equations-used-datum\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tfloat degToRadFactor = M_PI/180.0;\n\tfloat equatorialRadius = 6378137.0; // meters.\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat lonRad = lonDeg * degToRadFactor;\n\tfloat latRad = latDeg * degToRadFactor;\n\tfloat cosLon = cos(lonRad);\n\tfloat cosLat = cos(latRad);\n\tfloat sinLon = sin(lonRad);\n\tfloat sinLat = sin(latRad);\n\tfloat a = equatorialRadius;\n\tfloat e2 = firstEccentricitySquared;\n\tfloat v = a/sqrt(1.0 - e2 * sinLat * sinLat);\n\tfloat h = alt;\n\t\n\tvec4 resultCartesian = vec4((v+h)*cosLat*cosLon, (v+h)*cosLat*sinLon, (v*(1.0-e2)+h)*sinLat, 1.0);\n\treturn resultCartesian;\n}\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.0;\n    vec4 pos2d = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n\t\n\t// Now, must calculate geographic coords of the pos2d.***\n\tfloat longitudeDeg = -180.0 + pos2d.x * 360.0;\n\tfloat latitudeDeg = 90.0 - pos2d.y * 180.0;\n\tfloat altitude = 0.0;\n\t// Now, calculate worldPosition of the geographicCoords (lon, lat, alt).***\n\tvec4 worldPos = geographicToWorldCoord(longitudeDeg, latitudeDeg, altitude);\n\t\n\t// Now calculate the position on camCoord.***\n\t\n\tgl_Position = ModelViewProjectionMatrix * worldPos;\n}",filterSilhouetteFS:"precision mediump float;\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform mat4 projectionMatrix;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \n\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tvec3 normal2 = vec3(0.0, 0.0, 1.0);\n\tfloat radiusAux = radius * 5.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos); \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\t//vec3 sample = origin + (tbn * kernel[i]) * radiusAux;\n\t\t\tvec3 sample = origin + (kernel[i]) * radiusAux;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tif(sampleDepth > 0.49)\n\t\t\t\tcontinue;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radiusAux*0.998;\n\t\t\tif (range_check > radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t}   \n\t\t\n\t\tif(occlusion > float(kernelSize)*0.4)\n\t\t{\n\t\t\tocclusion = occlusion / float(kernelSize);\n\t\t}\n\t\telse{\n\t\t\tocclusion = 0.0;\n\t\t}\n\t\t//occlusion = 1.0 - occlusion / float(kernelSize);\n\t}\n\telse{\n\t\tocclusion = 0.0;\n\t}\n\n    vec4 finalColor;\n\tfinalColor = vec4(1.0, 1.0, 1.0, occlusion*0.9);\n    gl_FragColor = finalColor; \n}\n",InvertedBoxFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec3 lightPos = vec3(20.0, 60.0, 20.0);\n    vec3 L = normalize(lightPos - vertexPos);\n    float lambertian = max(dot(normal2, L), 0.0);\n    float specular = 0.0;\n    if(lambertian > 0.0)\n    {\n        vec3 R = reflect(-L, normal2);      // Reflected light vector\n        vec3 V = normalize(-vertexPos); // Vector to viewer\n        \n        // Compute the specular term\n        float specAngle = max(dot(R, V), 0.0);\n        specular = pow(specAngle, shininessValue);\n    }\n\t\n\tif(lambertian < 0.5)\n    {\n\t\tlambertian = 0.5;\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vColor4Aux;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\n    gl_FragColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n}\n",InvertedBoxVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",ModelRefSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nvarying float applySpecLighting;\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tvec3 normal2 = vNormal;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos);          \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tfloat realLinearDepth = linearDepth * far;\n\t\t\t\n\t\t\tif(sampleDepth > 0.49)\n\t\t\t\tcontinue;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\n\t\t\t\n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue);\n\t\t\tif(range_check > 0.000000001 && range_check < 0.00000007)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\telse if (depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t}   \n\t\t\t\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    // Do specular lighting.***\n\tfloat lambertian;\n\tfloat specular;\n\t\t\n\tif(applySpecLighting> 0.0)\n\t{\n\t\t//vec3 lightPos = vec3(20.0, 60.0, 200.0);\n\t\tvec3 lightPos = vec3(1.0, 1.0, 1.0);\n\t\tvec3 L = normalize(lightPos - vertexPos);\n\t\tlambertian = max(dot(normal2, L), 0.0);\n\t\tspecular = 0.0;\n\t\tif(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, normal2);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vertexPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t\t\n\t\t\tif(specular > 1.0)\n\t\t\t{\n\t\t\t\tspecular = 1.0;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(lambertian < 0.5)\n\t\t{\n\t\t\tlambertian = 0.5;\n\t\t}\n\n\t}\n\n    vec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = aColor4;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\tfloat alfa = textureColor.w * externalAlpha;\n\n    vec4 finalColor;\n\tif(applySpecLighting> 0.0)\n\t{\n\t\tfinalColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, alfa); \n\t}\n\telse{\n\t\tfinalColor = vec4((textureColor.xyz) * occlusion, alfa);\n\t}\n\t//finalColor = vec4(vNormal, 1.0); // test to render normal color coded.***\n    gl_FragColor = finalColor; \n}",ModelRefSsaoVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\tvarying vec4 aColor4; // color from attributes\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\t//vertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\t\n\t\tif(colorType == 1)\n\t\t\taColor4 = color4;\n\t}",PngImageFS:"precision mediump float;\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\n\nvoid main()\n{\n    vec4 textureColor;\n    if(textureFlipYAxis)\n    {\n        textureColor = texture2D(u_texture, vec2(v_texcoord.s, 1.0 - v_texcoord.t));\n    }\n    else\n    {\n        textureColor = texture2D(u_texture, v_texcoord);\n    }\n    if(textureColor.w < 0.1)\n    {\n        discard;\n    }\n\n    gl_FragColor = textureColor;\n}",PngImageVS:"attribute vec3 a_position;\nattribute vec2 a_texcoord;\nuniform mat4 buildingRotMatrix;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec2 v_texcoord;\n\nvoid main()\n{\n    vec4 position2 = vec4(a_position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    v_texcoord = a_texcoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",PointCloudDepthVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 modelViewMatrixRelToEye; \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nattribute vec4 color4;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\n//varying float glPointSize;\nvarying float depth;  \n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n\tif(gl_PointSize < 2.0)\n\t\tgl_PointSize = 2.0;\n\t\t\n\tdepth = (modelViewMatrixRelToEye * pos).z/far; // original.***\n}\n",PointCloudFS:"\tprecision lowp float;\n\tvarying vec4 vColor;\n\n\tvoid main()\n    {\n\t\tgl_FragColor = vColor;\n\t}",PointCloudSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}",PointCloudSsaoFS_rainbow:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nuniform bool bUseColorCodingByHeight;\nuniform float minHeight_rainbow;   \nuniform float maxHeight_rainbow;  \nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}  \n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tif(bUseColorCodingByHeight)\n\t{\n\t\tfloat rainbow = 0.5;\n\t\tfloat texCol = 0.5;\n\t\tvec3 rainbowColor3 = getRainbowColor_byHeight(realHeigh);\n\t\tvec3 blendedColor3 = vec3(vColor.x * texCol + rainbowColor3.r * rainbow, vColor.y * texCol + rainbowColor3.g * rainbow, vColor.z * texCol + rainbowColor3.b * rainbow);\n\t\tfinalColor = vec4(blendedColor3 * occlusion, externalAlpha);\n\t}\n\telse\n\t\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nuniform bool bUseColorCodingByHeight;\nvarying vec4 vColor;\nvarying float glPointSize;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n\tif(gl_PointSize < 2.0)\n\t\tgl_PointSize = 2.0;\n\t\t\n\tglPointSize = gl_PointSize;\n}",PointCloudVS_rainbow:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trealHeigh = realPos.z;\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n    gl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n    if(gl_PointSize < 2.0)\n        gl_PointSize = 2.0;\n        \n    glPointSize = gl_PointSize;\n}\n",quad_vert:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n",RenderShowDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n\t//gl_FragData[0].r = -depth/far;\n}",RenderShowDepthVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvarying float depth;\n  \nvoid main()\n{\t\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    depth = (modelViewMatrixRelToEye * pos4).z/far; // original.***\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tgl_PointSize = 2.0;\n}",screen_frag:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, 1.0 - v_tex_pos);\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}\n",SilhouetteFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}",SilhouetteVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewMatrixRelToEye;\nuniform mat4 ProjectionMatrix;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform vec2 camSpacePixelTranslation;\nuniform vec2 screenSize;    \nvarying vec2 camSpaceTranslation;\n\nvoid main()\n{    \n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 camSpacePos = ModelViewMatrixRelToEye * pos4;\n    vec4 translationVec = ProjectionMatrix * vec4(camSpacePixelTranslation.x*(-camSpacePos.z), camSpacePixelTranslation.y*(-camSpacePos.z), 0.0, 1.0);\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n    gl_Position += translationVec;  \n}",StandardFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",StandardVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",Test_QuadFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n \nuniform sampler2D diffuseTex;  \nvarying vec2 vTexCoord; \nvoid main()\n{          \n    vec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n    gl_FragColor = textureColor; \n}\n",Test_QuadVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",TextureA1FS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}\n",TextureA1VS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",TextureFS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}",TextureNormalFS:"\tprecision mediump float;\n\tvarying vec4 vColor;\n\tvarying vec2 vTextureCoord;\n\tuniform sampler2D uSampler;\n\tvarying vec3 vLightWeighting;\n\n\tvoid main()\n    {\n\t\tvec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n        \n\t\tgl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);\n\t}\n",TextureNormalVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nattribute vec3 aVertexNormal;\nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nuniform mat3 uNMatrix;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    vColor = aVertexColor;\n    vTextureCoord = aTextureCoord;\n    \n    vLightWeighting = vec3(1.0, 1.0, 1.0);\n    uAmbientColor = vec3(0.7, 0.7, 0.7);\n    vec3 uLightingDirection = vec3(0.8, 0.2, -0.9);\n    vec3 directionalLightColor = vec3(0.4, 0.4, 0.4);\n    vec3 transformedNormal = uNMatrix * aVertexNormal;\n    float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);\n    vLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",TextureVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 Mmatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec4 rotatedPos = Mmatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n    \n}",TinTerrainFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\nvarying float depthValue;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}               \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}\n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{           \n\tif(bIsMakingDepth)\n\t{\n\t\tgl_FragColor = packDepth(-depthValue);\n\t}\n\telse{\n\t\tvec4 textureColor;\n\t\tif(colorType == 0)\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 2)\n\t\t{\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\t\t//vec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\t\tgl_FragColor = vec4(textureColor.xyz, externalAlpha); \n\t}\n}",TinTerrainVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\n}",update_frag:"precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    // return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n}\n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(windMapTexCoord));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n    // take EPSG:4236 distortion into account for calculating where the particle moved\n    float distortion = cos(radians(pos.y * 180.0 - 90.0));\n    vec2 offset = vec2(velocity.x / distortion, -velocity.y) * 0.0001 * u_speed_factor;\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\n    // a random seed to use for the particle drop\n    vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\n    // drop rate is a chance a particle will restart at random position, to avoid degeneration\n    float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    float drop = step(1.0 - drop_rate, rand(seed));\n\n    vec2 random_pos = vec2(\n        rand(seed + 1.3),\n        rand(seed + 2.1));\n    pos = mix(pos, random_pos, drop);\n\n    // encode the new particle position back into RGBA\n    gl_FragColor = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n}",vol_fs:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n//---------------------------------------------------------\n// MACROS\n//---------------------------------------------------------\n\n#define EPS       0.0001\n#define PI        3.14159265\n#define HALFPI    1.57079633\n#define ROOTTHREE 1.73205081\n\n#define EQUALS(A,B) ( abs((A)-(B)) < EPS )\n#define EQUALSZERO(A) ( ((A)<EPS) && ((A)>-EPS) )\n\n\n//---------------------------------------------------------\n// CONSTANTS\n//---------------------------------------------------------\n\n// 32 48 64 96 128\n#define MAX_STEPS 64\n\n#define LIGHT_NUM 2\n//#define uTMK 20.0\n#define TM_MIN 0.05\n\n\n//---------------------------------------------------------\n// SHADER VARS\n//---------------------------------------------------------\n\nvarying vec2 vUv;\nvarying vec3 vPos0; // position in world coords\nvarying vec3 vPos1; // position in object coords\nvarying vec3 vPos1n; // normalized 0 to 1, for texture lookup\n\nuniform vec3 uOffset; // TESTDEBUG\n\nuniform vec3 uCamPos;\n\nuniform vec3 uLightP[LIGHT_NUM];  // point lights\nuniform vec3 uLightC[LIGHT_NUM];\n\nuniform vec3 uColor;      // color of volume\nuniform sampler2D uTex;   // 3D(2D) volume texture\nuniform vec3 uTexDim;     // dimensions of texture\n\nuniform float uTMK;\n\nfloat gStepSize;\nfloat gStepFactor;\n\n\n//---------------------------------------------------------\n// PROGRAM\n//---------------------------------------------------------\n\n// TODO: convert world to local volume space\nvec3 toLocal(vec3 p) {\n  return p + vec3(0.5);\n}\n\nfloat sampleVolTex(vec3 pos) {\n  pos = pos + uOffset; // TESTDEBUG\n  \n  // note: z is up in 3D tex coords, pos.z is tex.y, pos.y is zSlice\n  float zSlice = (1.0-pos.y)*(uTexDim.z-1.0);   // float value of slice number, slice 0th to 63rd\n  \n  // calc pixels from top of texture\n  float fromTopPixels =\n    floor(zSlice)*uTexDim.y +   // offset pix from top of tex, from upper slice  \n    pos.z*(uTexDim.y-1.0) +     // y pos in pixels, range 0th to 63rd pix\n    0.5;  // offset to center of cell\n    \n  // calc y tex coords of two slices\n  float y0 = min( (fromTopPixels)/(uTexDim.y*uTexDim.z), 1.0);\n  float y1 = min( (fromTopPixels+uTexDim.y)/(uTexDim.y*uTexDim.z), 1.0);\n    \n  // get (bi)linear interped texture reads at two slices\n  float z0 = texture2D(uTex, vec2(pos.x, y0)).g;\n  float z1 = texture2D(uTex, vec2(pos.x, y1)).g;\n  \n  // lerp them again (thus trilinear), using remaining fraction of zSlice\n  return mix(z0, z1, fract(zSlice));\n}\n\n// accumulate density by ray marching\nfloat getDensity(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  float density = 0.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    density += (1.0-density) * sampleVolTex(pos) * gStepFactor;\n    //density += sampleVolTex(pos);\n    \n    pos += step;\n    \n    if (density > 0.95 ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  return density;\n}\n\n// calc transmittance\nfloat getTransmittance(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  float tm = 1.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    tm *= exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  return tm;\n}\n\nvec4 raymarchNoLight(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  vec3 col = vec3(0.0);\n  float tm = 1.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    float dtm = exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    tm *= dtm;\n    \n    col += (1.0-dtm) * uColor * tm;\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  float alpha = 1.0-tm;\n  return vec4(col/alpha, alpha);\n}\n\nvec4 raymarchLight(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  \n  vec3 col = vec3(0.0);   // accumulated color\n  float tm = 1.0;         // accumulated transmittance\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    // delta transmittance \n    float dtm = exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    tm *= dtm;\n    \n    // get contribution per light\n    for (int k=0; k<LIGHT_NUM; ++k) {\n      vec3 ld = normalize( toLocal(uLightP[k])-pos );\n      float ltm = getTransmittance(pos,ld);\n      \n      col += (1.0-dtm) * uColor*uLightC[k] * tm * ltm;\n    }\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  float alpha = 1.0-tm;\n  return vec4(col/alpha, alpha);\n}\n\nvoid main() {\n  // in world coords, just for now\n  vec3 ro = vPos1n;\n  vec3 rd = normalize( ro - toLocal(uCamPos) );\n  //vec3 rd = normalize(ro-uCamPos);\n  \n  // step_size = root_three / max_steps ; to get through diagonal  \n  gStepSize = ROOTTHREE / float(MAX_STEPS);\n  gStepFactor = 32.0 * gStepSize;\n  \n  gl_FragColor = raymarchLight(ro, rd);\n  //gl_FragColor = vec4(uColor, getDensity(ro,rd));\n  //gl_FragColor = vec4(vec3(sampleVolTex(pos)), 1.0);\n  //gl_FragColor = vec4(vPos1n, 1.0);\n  //gl_FragColor = vec4(uLightP[0], 1.0);\n}",vol_vs:"attribute vec3 aPosition;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec3 vPosObjectCoord;\nvarying vec3 vPosCameraCoord;\nvarying vec3 vPosWorldCoord;\n\n// Render a fullScreen quad (2 triangles).***\nvoid main()\n{\n\tvec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}",wgs84_volumFS:"precision mediump float;\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D volumeTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform float aspectRatio;\nuniform float far;\nuniform float fovyRad;\nuniform float tanHalfFovy;\n\n// volume tex definition.***\nuniform int texNumCols;\nuniform int texNumRows;\nuniform int texNumSlices;\nuniform int numSlicesPerStacks;\nuniform int slicesNumCols;\nuniform int slicesNumRows;\nuniform float maxLon;\nuniform float minLon;\nuniform float maxLat;\nuniform float minLat;\nuniform float maxAlt;\nuniform float minAlt;\nuniform vec4 cuttingPlanes[6];   \nuniform int cuttingPlanesCount;\n\nuniform float maxValue;\nuniform float minValue;\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tanHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n} \n\nfloat squaredLength(vec3 point1, vec3 point2)\n{\n\tfloat a = point1.x - point2.x;\n\tfloat b = point1.y - point2.y;\n\tfloat c = point1.z - point2.z;\n\t\n\tfloat sqDist = a*a + b*b + c*c;\n\treturn sqDist;\n}\n\nvoid intersectionLineSphere(float radius, vec3 rayPos, vec3 rayDir, out int intersectType, out vec3 nearIntersectPos, out vec3 farIntersectPos)\n{\n\t// line: (x, y, z) = x1 + t(x2 - x1), y1 + t(y2 - y1), z1 + t(z2 - z1)\n\t// sphere: (x - x3)^2 + (y - y3)^2 + (z - z3)^2 = r^2, where x3, y3, z3 is the center of the sphere.\n\t\n\t// line:\n\tvec3 p1 = rayPos;\n\tvec3 lineDir = rayDir;\n\tfloat dist = 1000.0;// any value is ok.***\n\tvec3 p2 = vec3(p1.x + lineDir.x * dist, p1.y + lineDir.y * dist, p1.z + lineDir.z * dist);\n\tfloat x1 = p1.x;\n\tfloat y1 = p1.y;\n\tfloat z1 = p1.z;\n\tfloat x2 = p2.x;\n\tfloat y2 = p2.y;\n\tfloat z2 = p2.z;\n\n\t// sphere:\n\tfloat x3 = 0.0;\n\tfloat y3 = 0.0;\n\tfloat z3 = 0.0;\n\tfloat r = radius;\n\t\n\t// resolve:\n\tfloat x21 = (x2-x1);\n\tfloat y21 = (y2-y1);\n\tfloat z21 = (z2-z1);\n\t\n\tfloat a = x21*x21 + y21*y21 + z21*z21;\n\t\n\tfloat x13 = (x1-x3);\n\tfloat y13 = (y1-y3);\n\tfloat z13 = (z1-z3);\n\t\n\tfloat b = 2.0*(x21 * x13 + y21 * y13 + z21 * z13);\n\t\n\tfloat c = x3*x3 + y3*y3 + z3*z3 + x1*x1 + y1*y1 + z1*z1 - 2.0*(x3*x1 + y3*y1+ z3*z1) - r*r;\n\t\n\tfloat discriminant = b*b - 4.0*a*c;\n\t\n\tif (discriminant < 0.0)\n\t{\n\t\t// no intersection.***\n\t\tintersectType = 0;\n\t}\n\telse if (discriminant == 0.0)\n\t{\n\t\t// this is tangent.***\n\t\tintersectType = 1;\n\t\t\n\t\tfloat t1 = (-b)/(2.0*a);\n\t\tnearIntersectPos = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t}\n\telse\n\t{\n\t\tintersectType = 2;\n\t\t\n\t\t// find the nearest to p1.***\n\t\tfloat sqrtDiscriminant = sqrt(discriminant);\n\t\tfloat t1 = (-b + sqrtDiscriminant)/(2.0*a);\n\t\tfloat t2 = (-b - sqrtDiscriminant)/(2.0*a);\n\t\t\n\t\t// solution 1.***\n\t\tvec3 intersectPoint1 = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t\tvec3 intersectPoint2 = vec3(x1 + (x2 - x1)*t2, y1 + (y2 - y1)*t2, z1 + (z2 - z1)*t2);\n\t\t\n\t\tfloat dist1 = squaredLength(p1,intersectPoint1);\n\t\tfloat dist2 = squaredLength(p1,intersectPoint2);\n\t\t\n\t\t// nearIntersectPos, out vec3 farIntersectPos\n\t\tif (dist1 < dist2)\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint1;\n\t\t\tfarIntersectPos = intersectPoint2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint2;\n\t\t\tfarIntersectPos = intersectPoint1;\n\t\t}\n\t}\n}\n\nfloat atan2(float y, float x) \n{\n\tif(x > 0.0)\n\t{\n\t\treturn atan(y/x);\n\t}\n\telse if(x < 0.0)\n\t{\n\t\tif(y >= 0.0)\n\t\t{\n\t\t\treturn atan(y/x) + M_PI;\n\t\t}\n\t\telse{\n\t\t\treturn atan(y/x) - M_PI;\n\t\t}\n\t}\n\telse if(x == 0.0)\n\t{\n\t\tif(y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if(y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse{\n\t\t\treturn 0.0; // return undefined.***\n\t\t}\n\t}\n}\n\nvoid cartesianToGeographicWgs84(vec3 point, out vec3 result) \n{\n\t// From WebWorldWind.***\n\t// According to H. Vermeille, An analytical method to transform geocentric into geodetic coordinates\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\t// wwwind coord type.***\n\t// X = point.z;\n\t// Y = point.x;\n\t// Z = point.y;\n\n\t// magoWorld coord type.***\n\tfloat X = point.x;\n\tfloat Y = point.y;\n\tfloat Z = point.z;\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atanAux;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\tfloat cbrtFac = 1.0/3.0;\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by near... the cusps of the evolute.\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = pow((rad1 + rad2) * (rad1 + rad2), cbrtFac);\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * pow((rad1 + rad2) * (rad1 + rad2), cbrtFac)\n\t\t\t\t\t+ 0.5 * pow((rad1 - rad2) * (rad1 - rad2), cbrtFac);\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatanAux = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atanAux) * cos(M_PI / 6.0 + atanAux);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tsqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, sqrtDDpZZ + D);\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it's not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tresult = vec3(factor * lambda, factor * phi, h); // (longitude, latitude, altitude).***\n}\n\nbool isPointRearCamera(vec3 point, vec3 camPos, vec3 camDir)\n{\n\tbool isRear = false;\n\tfloat lambdaX = 10.0;\n\tfloat lambdaY = 10.0;\n\tfloat lambdaZ = 10.0;\n\tif(abs(camDir.x) > 0.0000001)\n\t{\n\t\tfloat lambdaX = (point.x - camPos.x)/camDir.x;\n\t}\n\telse if(abs(camDir.y) > 0.0000001)\n\t{\n\t\tfloat lambdaY = (point.y - camPos.y)/camDir.y;\n\t}\n\telse if(abs(camDir.z) > 0.0000001)\n\t{\n\t\tfloat lambdaZ = (point.z - camPos.z)/camDir.z;\n\t}\n\t\n\tif(lambdaZ < 0.0 || lambdaY < 0.0 || lambdaX < 0.0)\n\t\t\tisRear = true;\n\t\telse\n\t\t\tisRear = false;\n\treturn isRear;\n}\n\nfloat distPointToPlane(vec3 point, vec4 plane)\n{\n\treturn (point.x*plane.x + point.y*plane.y + point.z*plane.z + plane.w);\n}\n\nbool getValue(vec3 geoLoc, out vec4 value)\n{\n\t// geoLoc = (longitude, latitude, altitude).***\n\tfloat lon = geoLoc.x;\n\tfloat lat = geoLoc.y;\n\tfloat alt = geoLoc.z;\n\t\n\t// 1rst, check if geoLoc intersects the volume.***\n\t// Note: minLon, maxLon, minLat, maxLat, minAlt & maxAlt are uniforms.***\n\tif(lon < minLon || lon > maxLon)\n\t\treturn false;\n\telse if(lat < minLat || lat > maxLat)\n\t\treturn false;\n\telse if(alt < minAlt || alt > maxAlt)\n\t\treturn false;\n\t\t\n\tfloat lonRange = maxLon - minLon;\n\tfloat latRange = maxLat - minLat;\n\tfloat altRange = maxAlt - minAlt;\n\tfloat col = (lon - minLon)/lonRange * float(slicesNumCols); \n\tfloat row = (lat - minLat)/latRange * float(slicesNumRows); \n\tfloat slice = (alt - minAlt)/altRange * float(texNumSlices); // slice if texture has only one stack.***\n\tfloat sliceDown = floor(slice);\n\tfloat sliceUp = ceil(slice);\n\tfloat sliceDownDist = slice - sliceDown;\n\t//slice = 18.0; // test. force slice to nearest to ground.***\n\t\n\tfloat stackDown = floor(sliceDown/float(numSlicesPerStacks));\n\tfloat realSliceDown = sliceDown - stackDown * float(numSlicesPerStacks);\n\tfloat tx = stackDown * float(slicesNumCols) + col;\n\tfloat ty = realSliceDown * float(slicesNumRows) + row;\n\tvec2 texCoord = vec2(tx/float(texNumCols), ty/float(texNumRows));\n\tvec4 valueDown = texture2D(volumeTex, texCoord);\n\t\n\tif(sliceDown < float(texNumSlices-1))\n\t{\n\t\tfloat stackUp = floor(sliceUp/float(numSlicesPerStacks));\n\t\tfloat realSliceUp = sliceUp - stackUp * float(numSlicesPerStacks);\n\t\tfloat tx2 = stackUp * float(slicesNumCols) + col;\n\t\tfloat ty2 = realSliceUp * float(slicesNumRows) + row;\n\t\tvec2 texCoord2 = vec2(tx2/float(texNumCols), ty2/float(texNumRows));\n\t\tvec4 valueUp = texture2D(volumeTex, texCoord2);\n\t\tvalue = valueDown*(1.0-sliceDownDist)+valueUp*(sliceDownDist);\n\t}\n\telse{\n\t\tvalue = valueDown;\n\t}\n\t//if((value.r * (maxValue - minValue)) > maxValue * 0.3)\n\t//\treturn true;\n\t//else return false;\n\treturn true;\n}\n\nvoid main() {\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\tfloat linearDepth = 1.0; // the quad is 1m of dist of the camera.***          \n    vec3 rayCamCoord = getViewRay(screenPos) * linearDepth;  \n\trayCamCoord = normalize(rayCamCoord);\n\t\n\tvec3 camTarget = rayCamCoord * 10000.0;\n\tvec4 camPosWorld = vec4(encodedCameraPositionMCHigh + encodedCameraPositionMCLow, 1.0);\n\tvec4 camTargetWorld = modelViewMatrixInv * vec4(camTarget.xyz, 1.0);\n\tvec3 camDirWorld = camTargetWorld.xyz - camPosWorld.xyz;\n\tcamDirWorld = normalize(camDirWorld);\n\n\t// now, must find sampling points.***\n\tint intersectType = 0;\n\tvec3 nearP;\n\tvec3 farP;\n\tfloat radius = 6378137.0 + maxAlt; // equatorial radius.***\n\t//radius = 6250000.0 + maxAlt; // test radius.***\n\t\n\tintersectionLineSphere(radius, camPosWorld.xyz, camDirWorld, intersectType, nearP, farP);\n\t\n\tif(intersectType == 0)\n\t{\n\t\tdiscard;\n\t}\n\t\t\n\tif(intersectType == 1)\n\t{\n\t\t// provisionally discard.***\n\t\tdiscard;\t\n\t}\n\t\n\t// check if nearP is rear of the camera.***\n\tif(isPointRearCamera(nearP, camPosWorld.xyz, camDirWorld.xyz))\n\t{\n\t\tnearP = vec3(camPosWorld.xyz);\n\t}\n\tfloat dist = distance(nearP, farP);\n\tfloat testDist = dist;\n\tif(dist > 1500000.0)\n\t\ttestDist = 1500000.0;\n\t\n\t// now calculate the geographicCoords of 2 points.***\n\t// now, depending the dist(nearP, endPoint), determine numSmples.***\n\t// provisionally take 16 samples.***\n\tfloat numSamples = 512.0;\n\tvec4 color = vec4(0.0, 0.0, 0.0, 0.0);\n\tfloat alpha = 0.8/numSamples;\n\tfloat tempRange = maxValue - minValue;\n\tvec4 value;\n\tfloat totalValue = 0.0;\n\tint sampledsCount = 0;\n\tint intAux = 0;\n\tfloat increDist = testDist / numSamples;\n\tint c = 0;\n\tbool isPointRearPlane = true;\n\tfor(int i=0; i<512; i++)\n\t{\n\t\tvec3 currGeoLoc;\n\t\tvec3 currPosWorld = vec3(nearP.x + camDirWorld.x * increDist*float(c), nearP.y + camDirWorld.y * increDist*float(c), nearP.z + camDirWorld.z * increDist*float(c));\n\t\t// Check if the currPosWorld is in front or rear of planes (if exist planes).***\n\t\tint planesCounter = 0;\n\t\tfor(int j=0; j<6; j++)\n\t\t{\n\t\t\tif(planesCounter == cuttingPlanesCount)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tvec4 plane = cuttingPlanes[j];\n\t\t\tfloat dist = distPointToPlane(currPosWorld, plane);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tisPointRearPlane = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tisPointRearPlane = true;\n\t\t\t}\n\t\t\tplanesCounter++;\n\t\t}\n\t\t\n\t\t\n\t\tif(isPointRearPlane)\n\t\t{\n\t\t\tcartesianToGeographicWgs84(currPosWorld, currGeoLoc);\n\t\t\tif(getValue(currGeoLoc, value))\n\t\t\t{\n\t\t\t\tfloat realValue = value.r * tempRange + minValue*255.0;\n\t\t\t\ttotalValue += (value.r);\n\t\t\t\tsampledsCount += 1;\n\t\t\t}\n\t\t}\n\t\tif(sampledsCount >= 1)\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tc++;\n\t}\n\tif(sampledsCount == 0)\n\t{\n\t\tdiscard;\n\t}\n\tfloat fValue = totalValue/numSamples;\n\tfValue = totalValue;\n\tif(fValue > 1.0)\n\t{\n\t\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\treturn;\n\t}\n\tfloat b = 1.0 - fValue;\n\tfloat g;\n\tif(fValue > 0.5)\n\t{\n\t\tg = 2.0-2.0*fValue;\n\t}\n\telse{\n\t\tg = 2.0*fValue;\n\t}\n\tfloat r = fValue;\n\tcolor += vec4(r,g,b,0.8);\n\tgl_FragColor = color;\n}",wgs84_volumVS:"precision mediump float;\n\nattribute vec3 position;\nuniform mat4 projectionMatrix;\n\nvoid main()\n{\t\n\tvec4 pos = projectionMatrix * vec4(position.xyz, 1.0);\n    gl_Position = pos;\n}"},si=function(t,e){if(!(this instanceof si))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.floatValue};si.prototype.bindUniform=function(){this.gl.uniform1f(this.uniformLocation,this.floatValue[0])};var li=function(t,e){if(!(this instanceof li))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.intValue};li.prototype.bindUniform=function(){this.gl.uniform1i(this.uniformLocation,this.intValue)};var di=function(t,e){if(!(this instanceof di))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.matrix4fv};di.prototype.bindUniform=function(){this.gl.uniformMatrix4fv(this.uniformLocation,!1,this.matrix4fv)};var hi=function(t,e){if(!(this instanceof hi))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec2fv};hi.prototype.bindUniform=function(){this.gl.uniform2fv(this.uniformLocation,this.vec2fv)};var ci=function(t,e){if(!(this instanceof ci))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec3fv};ci.prototype.bindUniform=function(){this.gl.uniform3fv(this.uniformLocation,this.vec3fv)};var ui=function(t,e){if(!(this instanceof ui))throw new Error(j.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec4fv};ui.prototype.bindUniform=function(){this.gl.uniform4fv(this.uniformLocation,this.vec4fv)};var fi=function(t){if(!(this instanceof fi))throw new Error(j.CONSTRUCT_ERROR);this.nodeOwner,t&&(this.nodeOwner=t),this.id,this.nodesArray,this.edgesArray,this.spacesArray,this.attributes,this.edgesVboKeysContainer,this.nodesVboKeysContainer,this.renderSpaces=!0,this.spacesAlpha=.2};fi.prototype.newNode=function(){void 0===this.nodesArray&&(this.nodesArray=[]);var t=new pi(this);return this.nodesArray.push(t),t},fi.prototype.newEdge=function(){void 0===this.edgesArray&&(this.edgesArray=[]);var t=new gi(this);return this.edgesArray.push(t),t},fi.prototype.newSpace=function(){void 0===this.spacesArray&&(this.spacesArray=[]);var t=new vi(this);return this.spacesArray.push(t),t},fi.prototype.test__makeVbos=function(t){var e=0;this.edgesArray&&(e=this.edgesArray.length);for(var i=[],o=0;o<e;o++){var r=this.edgesArray[o].vtxSegment,n=r.startVertex.point3d,a=r.endVertex.point3d;i.push(n.x),i.push(n.y),i.push(n.z),i.push(a.x),i.push(a.y),i.push(a.z)}void 0===this.edgesVboKeysContainer&&(this.edgesVboKeysContainer=new ft);var s=this.edgesVboKeysContainer.newVBOVertexIdxCacheKey(),l=3*(2*e),d=t.vboMemoryManager.getClassifiedBufferSize(l);s.posVboDataArray=new Float32Array(d),s.posVboDataArray.set(i),s.posArrayByteSize=i.length,s.segmentsCount=e},fi.prototype.parseTopologyData=function(t,e){var i=new u;i.minX=e.min_X,i.minY=e.min_Y,i.minZ=e.min_Z,i.maxX=e.max_X,i.maxY=e.max_Y,i.maxZ=e.max_Z;var o=new Ce;o.set(-115.0978055,31.885502,-28.5);for(var r={},n=e.nodes.length,a=0;a<n;a++){var s=e.nodes[a],l=this.newNode();l.id="#"+s.id,l.position=new Ce(s.coordinates[0],s.coordinates[1],s.coordinates[2]),l.position.addPoint(o),l.position.add(0,0,.1),l.box=new Wt(.6,.6,.6),r[l.id]=l}var d={},h=e.cellSpaceMembers.length;for(a=0;a<h;a++){var c=e.cellSpaceMembers[a],f=(c.href,this.newSpace()),g=new ce;f.mesh=g;for(var p=g.getVertexList(),v=c.surfaceMember.length,y=0;y<v;y++){for(var m=g.newSurface().newFace(),x=c.surfaceMember[y].coordinates,b=x.length/3,C=0;C<b;C++){var A=x[3*C],M=x[3*C+1],P=x[3*C+2],T=p.newVertex();T.setPosition(A,M,P),T.point3d.addPoint(o),m.addVertex(T)}m.solveUroborus(),m.calculateVerticesNormals()}d[c.href]=c}var _=e.edges.length;for(a=0;a<_;a++){var w=e.edges[a],S=this.newEdge(),R=w.stateMembers[0].coordinates,L=w.stateMembers[1].coordinates,D=new ke,I=new ke;D.setPosition(R[0],R[1],R[2]),I.setPosition(L[0],L[1],L[2]),D.point3d.addPoint(o),D.point3d.add(0,0,.1),I.point3d.addPoint(o),I.point3d.add(0,0,.1);var E=new qe(D,I);S.vtxSegment=E;var O=w.connects[0],F=w.connects[1];S.strNodeId=O,S.endNodeId=F}this.test__makeVbos(t)},fi.prototype.renderColorCoding=function(t,e,i){var o=t.selectionColor,r=(n=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===r&&(r=n.newCandidatesFamily("networkNodes"));var n,a=(n=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===a&&(a=n.newCandidatesFamily("networkEdges"));var s=t.vboMemoryManager,l=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),l.uniform1i(e.hasTexture_loc,!1),l.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(l.uniform1i(e.hasAditionalMov_loc,!1),l.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var d,h=0;if(this.nodesArray&&(h=this.nodesArray.length),h>0){var c=1;l.uniform1i(e.refMatrixType_loc,c);for(var u=this.nodesArray[0],f=0;f<h;f++){var g=this.nodesArray[f];l.uniform3fv(e.refTranslationVec_loc,[g.position.x,g.position.y,g.position.z]);var p=o.getAvailableColor(void 0),v=o.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkNodes",g),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),u.box.render(t,e,i)}}if(this.edgesVboKeysContainer&&(d=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(l,s)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),c=0,l.uniform1i(e.refMatrixType_loc,c),d.meshVertexCacheKey!==e.last_vboPos_binded&&(l.bindBuffer(l.ARRAY_BUFFER,d.meshVertexCacheKey),l.vertexAttribPointer(e.position3_loc,3,l.FLOAT,!1,0,0),e.last_vboPos_binded=d.meshVertexCacheKey);var y=this.edgesArray.length;for(f=0;f<y;f++){var m=this.edgesArray[f];p=o.getAvailableColor(void 0),v=o.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkEdges",m),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),l.drawArrays(l.LINES,2*f,2)}}},fi.prototype.render=function(t,e,i){if(2!==i){t.selectionColor.init();var o=(r=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===o&&(o=r.newCandidatesFamily("networkNodes"));var r,n=(r=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===n&&(n=r.newCandidatesFamily("networkEdges"));var a=t.vboMemoryManager,s=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(s.uniform1i(e.hasAditionalMov_loc,!1),s.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var l,d=0;if(this.nodesArray&&(d=this.nodesArray.length),d>0){s.uniform1i(e.colorType_loc,0);var h=1;s.uniform1i(e.refMatrixType_loc,h),s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1]);for(var c=this.nodesArray[0],u=0;u<d;u++){var f=this.nodesArray[u];f===o.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.9,.5,.1,1]),s.uniform3fv(e.refTranslationVec_loc,[f.position.x,f.position.y,f.position.z]),c.box.render(t,e,i),f===o.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1])}}if(this.edgesVboKeysContainer)if((l=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(s,a)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),h=0,s.uniform1i(e.refMatrixType_loc,h),s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1]),l.meshVertexCacheKey!==e.last_vboPos_binded&&(s.bindBuffer(s.ARRAY_BUFFER,l.meshVertexCacheKey),s.vertexAttribPointer(e.position3_loc,3,s.FLOAT,!1,0,0),e.last_vboPos_binded=l.meshVertexCacheKey);var g=this.edgesArray.length;for(u=0;u<g;u++){var p=this.edgesArray[u];p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[0,1,0,1]),s.drawArrays(s.LINES,2*u,2),p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1])}}if(this.renderSpaces=t.tempSettings.renderSpaces,this.spacesAlpha=t.tempSettings.spacesAlpha,1===i&&e.enableVertexAttribArray(e.normal3_loc),this.renderSpaces){s.uniform1i(e.colorType_loc,0),h=0,s.uniform1i(e.refMatrixType_loc,h),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,this.spacesAlpha]),s.enable(s.BLEND);var v=0;this.spacesArray&&(v=this.spacesArray.length);for(u=0;u<v;u++){this.spacesArray[u].mesh.render(t,e)}s.disable(s.BLEND)}}else this.renderColorCoding(t,e,i)};var gi=function(t){if(!(this instanceof gi))throw new Error(j.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.strNode,this.endNode,this.sense,this.attributes,this.strNodeId,this.endNodeId},pi=function(t){if(!(this instanceof pi))throw new Error(j.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.edgesArray,this.attributes,this.box},vi=function(t){if(!(this instanceof vi))throw new Error(j.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.mesh,this.attributes},yi=function(){if(!(this instanceof yi))throw new Error(j.CONSTRUCT_ERROR);this.ByteR=0,this.ByteG=0,this.ByteB=0,this.ByteAlfa=255};function mi(t,e){return void 0!==t&&null!==t?t:e}function xi(t){return void 0!==t&&null!==t}yi.prototype.destroy=function(){this.ByteR=null,this.ByteG=null,this.ByteB=null,this.ByteAlfa=null},yi.prototype.set=function(t,e,i){this.ByteR=t,this.ByteG=e,this.ByteB=i};var bi=function(){if(!(this instanceof bi))throw new Error(j.CONSTRUCT_ERROR)};function Ci(t,e,i,o,r){if(!xi(t))throw new Error("url required");return new Promise(function(n,a){void 0===e&&(e=new XMLHttpRequest),r=r||"GET",e.open(r,t,!0),e.responseType=o||"arraybuffer",void 0!==i&&(e.timeout=i),e.onload=function(){e.status<200||e.status>=300?a(e.status):n(e.response)},e.ontimeout=function(t){a(-1)},e.onerror=function(t){console.log("Invalid XMLHttpRequest response type."),a(e.status)},e.send(null)})}bi.getNextIdx=function(t,e){return t===e-1?0:t+1},bi.getPrevIdx=function(t,e){return 0===t?e-1:t-1},bi.getIndicesTrianglesRegularNet=function(t,e,i,o){var r,n,a;void 0===i&&(i=new Uint16Array(3*((t-1)*(e-1)*2)));var s=0,l=!1,d=!0;void 0!==o&&(void 0!==o.bLoopColumns&&(l=o.bLoopColumns),void 0!==o.bTrianglesSenseCCW&&(d=o.bTrianglesSenseCCW));for(var h=0;h<e-1;h++)for(var c=0;c<t-1;c++)r=He.getIndexOfArray(t,e,c,h),n=He.getIndexOfArray(t,e,c+1,h),a=He.getIndexOfArray(t,e,c,h+1),d?(i[s]=r,i[++s]=n,i[++s]=a,s++):(i[s]=r,i[++s]=a,i[++s]=n,s++),r=He.getIndexOfArray(t,e,c+1,h),n=He.getIndexOfArray(t,e,c+1,h+1),a=He.getIndexOfArray(t,e,c,h+1),d?(i[s]=r,i[++s]=n,i[++s]=a,s++):(i[s]=r,i[++s]=a,i[++s]=n,s++);if(l){var u=t;for(h=0;h<e-1;h++)r=He.getIndexOfArray(t,e,u,h),n=He.getIndexOfArray(t,e,0,h),a=He.getIndexOfArray(t,e,u,h+1),d?(i[s]=r,i[++s]=n,i[++s]=a,s++):(i[s]=r,i[++s]=a,i[++s]=n,s++),r=He.getIndexOfArray(t,e,0,h),n=He.getIndexOfArray(t,e,0,h+1),a=He.getIndexOfArray(t,e,u,h+1),d?(i[s]=r,i[++s]=n,i[++s]=a,s++):(i[s]=r,i[++s]=a,i[++s]=n,s++)}return i};var Ai=function(){};function Mi(t,e){this.jsonresponse=t,this.nodes=[],this.edges=[],this.cellSpaceMembers=[],this.cellSpaceBoundaryMembers=[],this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0,this.center_X=0,this.center_Y=0,this.ENU=new Cesium.Matrix4,this.jsonParsor,this.parsingJson(t,e),this.setCenter()}function Pi(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function Ti(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function _i(t,e,i,o){if(this.description=t,this.href=e,this.id=i,this.surfaceMember=o,this.usage="",-1!=t.indexOf("Usage=")){var r=t.indexOf("Usage=")+6;this.usage=t.substring(r,t.indexOf(":",r))}if(this.section="",-1!=t.indexOf("Section=")){var n=t.indexOf("Section=")+8;this.section=t.substring(n,t.indexOf(":",n))}if(this.floor="",-1!=t.indexOf("Floor=")){var a=t.indexOf("Floor=")+6;this.floor=t.substring(a)}}function wi(t){this.coordinates=t}function Si(t){this.coordinates=t}function Ri(t,e,i){if(this.connects=t,this.description=e,this.stateMembers=i,null!=e){if(this.usage="",-1!=e.indexOf("Usage=")){var o=e.indexOf("Usage=")+6;this.usage=e.substring(o,e.indexOf(":",o))}if(this.section="",-1!=e.indexOf("Section=")){var r=e.indexOf("Section=")+8;this.section=e.substring(r,e.indexOf(":",r))}if(this.floor="",-1!=e.indexOf("Floor=")){var n=e.indexOf("Floor=")+6;this.floor=e.substring(n)}}}Ai.pointToGeographicCoord=function(t,e,i){void 0===e&&(e=new R);var o=F.CartesianToGeographicWgs84(t.x,t.y,t.z,o);return e.setLonLatAlt(o.longitude,o.latitude,o.altitude),e},Ai.geographicCoordToWorldPoint=function(t,e,i,o,r){void 0===o&&(o=new Ce);var n=F.geographicToCartesianWgs84(t,e,i,void 0);return o.set(n[0],n[1],n[2]),o},Ai.translatePivotPointGeoLocationData=function(t,e){if(void 0!==t){var i=new Ce;i.set(-e.x,-e.y,-e.z),t.pivotPointTraslationLC=i,t.doEffectivePivotPointTranslation()}},Ai.calculateGeoLocationMatrixAtWorldPosition=function(t,e){return void 0===e&&(e=new B),F.transformMatrixAtCartesianPointWgs84(t.x,t.y,t.z,e._floatArrays),e},Ai.calculateGeoLocationMatrixAtLonLatAlt=function(t,e,i,o){void 0===o&&(o=new B);var r=this.geographicCoordToWorldPoint(t,e,i,r);return o=Ai.calculateGeoLocationMatrixAtWorldPosition(r,o)},Ai.calculateTransformMatrixAtWorldPosition=function(t,e,i,o,r,n){var a,s,l,d=new B,h=new B,c=new B;return void 0!==e&&0!==e&&c.rotationAxisAngDeg(e,0,0,1),void 0!==i&&0!==i&&d.rotationAxisAngDeg(i,1,0,0),void 0!==o&&0!==o&&h.rotationAxisAngDeg(o,0,1,0),void 0===r&&(r=new B),void 0===n&&(n=new B),r=Ai.calculateGeoLocationMatrixAtWorldPosition(t,r),n.copyFromMatrix4(r),a=c.getMultipliedByMatrix(n,a),s=d.getMultipliedByMatrix(a,s),n=l=h.getMultipliedByMatrix(s,l)},Ai.calculateGeoLocationData=function(t,e,i,o,r,n,a,s){if(void 0===a&&(a=new E),void 0===a.geographicCoord&&(a.geographicCoord=new R),void 0!==t?a.geographicCoord.longitude=t:t=a.geographicCoord.longitude,void 0!==e?a.geographicCoord.latitude=e:e=a.geographicCoord.latitude,void 0!==i?a.geographicCoord.altitude=i:i=a.geographicCoord.altitude,void 0!==o&&(a.heading=o),void 0!==r&&(a.pitch=r),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude&&void 0!==s.configInformation)return a.position=this.geographicCoordToWorldPoint(t,e,i,a.position),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.tMatrix?a.tMatrix=new B:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new B:a.geoLocMatrix.Identity(),void 0===a.rotMatrix?a.rotMatrix=new B:a.rotMatrix.Identity(),a.tMatrixInv=void 0,a.rotMatrixInv=void 0,a.geoLocMatrixInv=void 0,a.tMatrix=Ai.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,void 0===a.pivotPoint&&(a.pivotPoint=new Ce),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a},Ai.calculateGeoLocationDataByAbsolutePoint=function(t,e,i,o,r){if(void 0===o&&(o=new E),void 0===o.geographicCoord&&(o.geographicCoord=new R),void 0!==r.configInformation){if(void 0===o.position&&(o.position=new Ce),o.position.x=t,o.position.y=e,o.position.z=i,r.configInformation.geo_view_library===s.CESIUM){var n=new Cesium.Cartographic,a=new Cesium.Cartesian3;a.x=t,a.y=e,a.z=i,n=Cesium.Cartographic.fromCartesian(a,r.scene._globe._ellipsoid,n),o.geographicCoord.longitude=180*n.longitude/Math.PI,o.geographicCoord.latitude=180*n.latitude/Math.PI,o.geographicCoord.altitude=n.height}void 0===o.positionHIGH&&(o.positionHIGH=new Float32Array([0,0,0])),void 0===o.positionLOW&&(o.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([o.position.x,o.position.y,o.position.z],o.positionHIGH,o.positionLOW),void 0===o.tMatrix?o.tMatrix=new B:o.tMatrix.Identity(),void 0===o.geoLocMatrix?o.geoLocMatrix=new B:o.geoLocMatrix.Identity(),void 0===o.geoLocMatrixInv?o.geoLocMatrixInv=new B:o.geoLocMatrixInv.Identity(),void 0===o.tMatrixInv?o.tMatrixInv=new B:o.tMatrixInv.Identity(),void 0===o.rotMatrix?o.rotMatrix=new B:o.rotMatrix.Identity(),void 0===o.rotMatrixInv?o.rotMatrixInv=new B:o.rotMatrixInv.Identity();var l=new B,d=new B,h=new B;if(void 0!==o.heading&&0!==o.heading&&h.rotationAxisAngDeg(o.heading,0,0,-1),void 0!==o.pitch&&0!==o.pitch&&l.rotationAxisAngDeg(o.pitch,-1,0,0),void 0!==o.roll&&0!==o.roll&&d.rotationAxisAngDeg(o.roll,0,-1,0),r.configInformation.geo_view_library===s.CESIUM){Cesium.Transforms.eastNorthUpToFixedFrame(o.position,void 0,o.tMatrix._floatArrays),o.geoLocMatrix.copyFromMatrix4(o.tMatrix);var c=h.getMultipliedByMatrix(o.tMatrix,c),u=l.getMultipliedByMatrix(c,u),f=d.getMultipliedByMatrix(u,f);o.tMatrix=f,o.rotMatrix.copyFromMatrix4(o.tMatrix),o.rotMatrix._floatArrays[12]=0,o.rotMatrix._floatArrays[13]=0,o.rotMatrix._floatArrays[14]=0,Cesium.Matrix4.inverse(o.tMatrix._floatArrays,o.tMatrixInv._floatArrays),Cesium.Matrix4.inverse(o.rotMatrix._floatArrays,o.rotMatrixInv._floatArrays),Cesium.Matrix4.inverse(o.geoLocMatrix._floatArrays,o.geoLocMatrixInv._floatArrays)}return void 0===o.pivotPoint&&(o.pivotPoint=new Ce),o.pivotPoint.set(o.position.x,o.position.y,o.position.z),o}},Ai.calculateSplitedValues=function(t,e){var i;return void 0===e&&(e=new tt),t>=0?(i=65536*Math.floor(t/65536),e.high=i,e.low=t-i):(i=65536*Math.floor(-t/65536),e.high=-i,e.low=t+i),e},Ai.calculateSplited3fv=function(t,e,i){if(void 0!==t){void 0===e&&(e=new Float32Array(3)),void 0===i&&(i=new Float32Array(3));var o=new tt;o=this.calculateSplitedValues(t[0],o);var r=new tt;r=this.calculateSplitedValues(t[1],r);var n=new tt;n=this.calculateSplitedValues(t[2],n),e[0]=o.high,e[1]=r.high,e[2]=n.high,i[0]=o.low,i[1]=r.low,i[2]=n.low}},Ai.calculatePixelLinearDepth=function(t,e,i,o,r){void 0===o&&(o=r.depthFboNeo),o&&o.bind();var n=new Uint8Array(4);return t.readPixels(e,r.sceneState.drawingBufferHeight-i,1,1,t.RGBA,t.UNSIGNED_BYTE,n),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256},Ai.calculatePixelPositionCamCoord=function(t,e,i,o,r,n,a){void 0===n&&(n=a.sceneState.camera.frustum.far);var s=Ai.calculatePixelLinearDepth(t,e,i,r,a)*n;return a.resultRaySC=Ai.getRayCamSpace(e,i,a.resultRaySC,a),void 0===o&&(o=new Ce),o.set(a.resultRaySC[0]*s,a.resultRaySC[1]*s,a.resultRaySC[2]*s),t.bindFramebuffer(t.FRAMEBUFFER,null),o},Ai.cameraCoordPositionToWorldCoord=function(t,e,i){var o=i.sceneState.getModelViewMatrixInv();if(void 0===e)e=new Ce;return e=o.transformPoint3D(t,e)},Ai.calculatePixelPositionWorldCoord=function(t,e,i,o,r,n,a){var s=new Ce;if(void 0===n&&(n=a.sceneState.camera.frustum.far),void 0===r&&(r=a.depthFboNeo),s=Ai.calculatePixelPositionCamCoord(t,e,i,s,r,n,a),void 0===o)o=new Ce;return o=Ai.cameraCoordPositionToWorldCoord(s,o,a)},Ai.calculateWorldPositionToScreenCoord=function(t,e,i,o,r,n){void 0===r&&(r=new Ce),void 0===n.pointSC&&(n.pointSC=new Ce),void 0===n.pointSC2&&(n.pointSC2=new Ce),n.pointSC.set(e,i,o);var a=n.pointSC2,s=n.sceneState,l=(a=s.modelViewMatrix.transformPoint3D(n.pointSC,a)).z;if(l>0)return r.set(-1,-1,0),r;var d=s.camera.frustum.tangentOfHalfFovy*l*2,h=d*s.camera.frustum.aspectRatio,c=-a.x*s.drawingBufferWidth/h,u=-a.y*s.drawingBufferHeight/d;return c+=s.drawingBufferWidth/2,u+=s.drawingBufferHeight/2,u=s.drawingBufferHeight-u,r.set(c,u,0),r},Ai.getRayCamSpace=function(t,e,i,o){var r=o.sceneState,n=r.camera.frustum,a=n.aspectRatio,s=2*n.tangentOfHalfFovy*1,l=s*a,d=t,h=r.drawingBufferHeight-e;return void 0===i&&(i=new Float32Array(3)),i[0]=l*(d/r.drawingBufferWidth-.5),i[1]=s*(h/r.drawingBufferHeight-.5),i[2]=-1,i},Ai.getRayWorldSpace=function(t,e,i,o,r){void 0===o&&(o=new se);var n=r.sceneState.camera.position,a=new Float32Array(3);a=Ai.getRayCamSpace(e,i,a,r),void 0===r.pointSC&&(r.pointSC=new Ce);var s=r.pointSC,l=r.pointSC2;return s.set(a[0],a[1],a[2]),(l=r.sceneState.modelViewMatrixInv.rotatePoint3D(s,l)).unitary(),o.setPointAndDir(n.x,n.y,n.z,l.x,l.y,l.z),o},"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})}),function t(e,i,o){function r(a,s){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var h=i[a]={exports:{}};e[a][0].call(h.exports,function(t){var i=e[a][1][t];return r(i||t)},h,h.exports,t,e,i,o)}return i[a].exports}for(var n="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(t,e,i){var o=t("asap/raw");function r(){}var n=null,a={};function s(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==r&&f(t,this)}function l(t,e){for(;3===t._37;)t=t._12;0!==t._37?o(function(){var i=1===t._37?e.onFulfilled:e.onRejected;if(null!==i){var o=function(t,e){try{return t(e)}catch(t){return n=t,a}}(i,t._12);o===a?h(e.promise,n):d(e.promise,o)}else 1===t._37?d(e.promise,t._12):h(e.promise,t._12)}):t._59.push(e)}function d(t,e){if(e===t)return h(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"==typeof e||"function"==typeof e)){var i=function(t){try{return t.then}catch(t){return n=t,a}}(e);if(i===a)return h(t,n);if(i===t.then&&e instanceof s)return t._37=3,t._12=e,void c(t);if("function"==typeof i)return void f(i.bind(e),t)}t._37=1,t._12=e,c(t)}function h(t,e){t._37=2,t._12=e,c(t)}function c(t){for(var e=0;e<t._59.length;e++)l(t,t._59[e]);t._59=null}function u(t,e,i){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=i}function f(t,e){var i=!1,o=function(t,e,i){try{t(e,i)}catch(t){return n=t,a}}(t,function(t){i||(i=!0,d(e,t))},function(t){i||(i=!0,h(e,t))});i||o!==a||(i=!0,h(e,n))}e.exports=s,s._99=r,s.prototype.then=function(t,e){if(this.constructor!==s)return function(t,e,i){return new t.constructor(function(o,n){var a=new s(r);a.then(o,n),l(t,new u(e,i,a))})}(this,t,e);var i=new s(r);return l(this,new u(t,e,i)),i}},{"asap/raw":4}],2:[function(t,e,i){var o=t("./core.js");e.exports=o;var r=h(!0),n=h(!1),a=h(null),s=h(void 0),l=h(0),d=h("");function h(t){var e=new o(o._99);return e._37=1,e._12=t,e}o.resolve=function(t){if(t instanceof o)return t;if(null===t)return a;if(void 0===t)return s;if(!0===t)return r;if(!1===t)return n;if(0===t)return l;if(""===t)return d;if("object"==typeof t||"function"==typeof t)try{var e=t.then;if("function"==typeof e)return new o(e.bind(t))}catch(t){return new o(function(e,i){i(t)})}return h(t)},o.all=function(t){var e=Array.prototype.slice.call(t);return new o(function(t,i){if(0===e.length)return t([]);var r=e.length;function n(a,s){if(s&&("object"==typeof s||"function"==typeof s)){if(s instanceof o&&s.then===o.prototype.then){for(;3===s._37;)s=s._12;return 1===s._37?n(a,s._12):(2===s._37&&i(s._12),void s.then(function(t){n(a,t)},i))}var l=s.then;if("function"==typeof l)return void new o(l.bind(s)).then(function(t){n(a,t)},i)}e[a]=s,0==--r&&t(e)}for(var a=0;a<e.length;a++)n(a,e[a])})},o.reject=function(t){return new o(function(e,i){i(t)})},o.race=function(t){return new o(function(e,i){t.forEach(function(t){o.resolve(t).then(e,i)})})},o.prototype.catch=function(t){return this.then(null,t)}},{"./core.js":1}],3:[function(t,e,i){var o=t("./raw"),r=[],n=[],a=o.makeRequestCallFromTimer(function(){if(n.length)throw n.shift()});function s(t){var e;(e=r.length?r.pop():new l).task=t,o(e)}function l(){this.task=null}e.exports=s,l.prototype.call=function(){try{this.task.call()}catch(t){s.onerror?s.onerror(t):(n.push(t),a())}finally{this.task=null,r[r.length]=this}}},{"./raw":4}],4:[function(t,e,i){(function(t){function i(t){r.length||(o(),!0),r[r.length]=t}e.exports=i;var o,r=[],n=0,a=1024;function s(){for(;n<r.length;){var t=n;if(n+=1,r[t].call(),n>a){for(var e=0,i=r.length-n;e<i;e++)r[e]=r[e+n];r.length-=n,n=0}}r.length=0,n=0,!1}var l,d,h,c=t.MutationObserver||t.WebKitMutationObserver;function u(t){return function(){var e=setTimeout(o,0),i=setInterval(o,50);function o(){clearTimeout(e),clearInterval(i),t()}}}"function"==typeof c?(l=1,d=new c(s),h=document.createTextNode(""),d.observe(h,{characterData:!0}),o=function(){l=-l,h.data=l}):o=u(s),i.requestFlush=o,i.makeRequestCallFromTimer=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(t,e,i){"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})})},{}],6:[function(t,e,i){t("asap");"undefined"==typeof Promise&&(Promise=t("./lib/core.js"),t("./lib/es6-extensions.js")),t("./polyfill-done.js")},{"./lib/core.js":1,"./lib/es6-extensions.js":2,"./polyfill-done.js":5,asap:3}]},{},[6]),Mi.prototype.parsingJson=function(t,e){"1.0.1"==e?this.jsonParsor=new Pi(t):"1.0.3"==e?this.jsonParsor=new Ti(t):alert(e+" is not a vailid version!"),this.nodes=this.jsonParsor.parsingNodeData(t),this.edges=this.jsonParsor.parsingEdgeData(t),this.cellSpaceMembers=this.jsonParsor.parsingCellSpaceMember(t),this.max_X=this.jsonParsor.getMaxX(),this.max_Y=this.jsonParsor.getMaxY(),this.max_Z=this.jsonParsor.getMaxZ(),this.min_X=this.jsonParsor.getMinX(),this.min_Y=this.jsonParsor.getMinY(),this.min_Z=this.jsonParsor.getMinZ()},Mi.prototype.setCenter=function(){this.center_X=(this.min_X+this.max_X)/2,this.center_Y=(this.min_Y+this.max_Y)/2},Mi.prototype.rotateBuilding=function(t,e,i){var o=t.scene.globe.ellipsoid,r=new Cesium.Matrix4(Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,1,0,0,0,0,1);this.rotateCellSpaceMember(r,e,o),this.rotateCellSpaceBoundaryMembers(r,e,o),this.rotateNodes(r),this.rotateEdges(r)},Mi.prototype.rotateNodes=function(t){for(var e=this.nodes.length,i=0;i<e;i++){var o=new Cesium.Cartesian3(this.nodes[i].coordinates[0]-this.center_X,this.nodes[i].coordinates[1]-this.center_Y,this.nodes[i].coordinates[2]-this.min_Z),r=Cesium.Matrix4.multiplyByPoint(t,o,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,r,r);this.nodes[i].coordinates[0]=n.x,this.nodes[i].coordinates[1]=n.y,this.nodes[i].coordinates[2]=n.z}},Mi.prototype.rotateEdges=function(t){for(var e=0;e<this.edges.length;e++)for(var i=0;i<this.edges[e].stateMembers.length;i++){var o=new Cesium.Cartesian3(this.edges[e].stateMembers[i].coordinates[0]-this.center_X,this.edges[e].stateMembers[i].coordinates[1]-this.center_Y,this.edges[e].stateMembers[i].coordinates[2]-this.min_Z),r=Cesium.Matrix4.multiplyByPoint(t,o,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,r,r);this.edges[e].stateMembers[i].coordinates[0]=n.x,this.edges[e].stateMembers[i].coordinates[1]=n.y,this.edges[e].stateMembers[i].coordinates[2]=n.z}},Mi.prototype.rotateCellSpaceMember=function(t,e,i){Cesium.Transforms.eastNorthUpToFixedFrame(e,i,this.ENU);for(var o=0;o<this.cellSpaceMembers.length;o++)for(var r=this.cellSpaceMembers[o].surfaceMember.length,n=0;n<r;n++)for(var a=this.cellSpaceMembers[o].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceMembers[o].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceMembers[o].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceMembers[o].surfaceMember[n].coordinates[s+2]-this.min_Z),d=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),h=Cesium.Matrix4.multiplyByPoint(this.ENU,d,d);this.cellSpaceMembers[o].surfaceMember[n].coordinates[s]=h.x,this.cellSpaceMembers[o].surfaceMember[n].coordinates[s+1]=h.y,this.cellSpaceMembers[o].surfaceMember[n].coordinates[s+2]=h.z}},Mi.prototype.rotateCellSpaceBoundaryMembers=function(t,e,i){Cesium.Transforms.eastNorthUpToFixedFrame(e,i,this.ENU);for(var o=0;o<this.cellSpaceBoundaryMembers.length;o++)for(var r=this.cellSpaceBoundaryMembers[o].surfaceMember.length,n=0;n<r;n++)for(var a=this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s+2]-this.min_Z),d=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),h=Cesium.Matrix4.multiplyByPoint(this.ENU,d,d);this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s]=h.x,this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s+1]=h.y,this.cellSpaceBoundaryMembers[o].surfaceMember[n].coordinates[s+2]=h.z}},Pi.prototype.parsingNodeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,o=i.length,r=0;r<o;r++){var n=new wi(i[r].state.geometry.point.pos.value);e.push(n)}return e},Pi.prototype.parsingEdgeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,o=0;o<i.length;o++){for(var r,n=[],a=0;a<i[o].transition.connects.length;a++)n.push(i[o].transition.connects[a].href);null!=i[o].transition.description&&(r=i[o].transition.description.value);for(var s=[],l=0;l<i[o].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var d=new wi(i[o].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(d)}var h=new Ri(n,r,s);e.push(h)}return e},Pi.prototype.parsingCellSpaceMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,o=0;o<i;o++){var r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[o],n="";null!=r.abstractFeature.value.description&&(n=r.abstractFeature.value.description.value);var a="";null!=r.abstractFeature.value.id&&(a=r.abstractFeature.value.id);var s="";null!=r.abstractFeature.value.duality.href&&(s=r.abstractFeature.value.duality.href);var l=new _i(n,s,a,[]);null!=r.abstractFeature.value.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(r):null!=r.abstractFeature.value.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(r)),e.push(l)}return e},Pi.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,o=0;o<i;o++){var r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[o],n="";null!=r.abstractFeature.value.description&&(n=r.abstractFeature.value.description.value);var a="";null!=r.abstractFeature.value.id&&(a=r.abstractFeature.value.id);var s="";null!=r.abstractFeature.value.duality&&(s=r.abstractFeature.value.duality.href);var l=new _i(n,s,a,[]);null!=r.abstractFeature.value.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(r)),e.push(l)}return e},Pi.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,i=[],o=0;o<e;o++){for(var r=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[o],n=new Si([]),a=r.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=r.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);i.push(n)}return i},Pi.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],i=t.abstractFeature.value.geometry2D.abstractSurface.value.exterior.abstractRing,o=new Si([]),r=i.value.posOrPointPropertyOrPointRep.length,n=0;n<r;n++)o=this.abstractCoordinate(i.value.posOrPointPropertyOrPointRep[n].value.value,o);return e.push(o),e},Pi.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new Si([]),i=[];if(null!=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior)for(var o=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,r=0;r<o;r++)e=this.abstractCoordinate(t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[r].value.value,e);return i.push(e),i},Pi.prototype.abstractCoordinate=function(t,e){var i=t[0];e.coordinates.push(i),i>this.max_X?this.max_X=i:i<this.min_X&&(this.min_X=i);var o=t[1];e.coordinates.push(o),o>this.max_Y?this.max_Y=o:o<this.min_Y&&(this.min_Y=o);var r=t[2];return e.coordinates.push(r),r>this.max_Z?this.max_Z=r:r<this.min_Z&&(this.min_Z=r),e},Pi.prototype.getMaxX=function(){return this.max_X},Pi.prototype.getMaxY=function(){return this.max_Y},Pi.prototype.getMaxZ=function(){return this.max_Z},Pi.prototype.getMinX=function(){return this.min_X},Pi.prototype.getMinY=function(){return this.min_Y},Pi.prototype.getMinZ=function(){return this.min_Z},Ti.prototype.parsingNodeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,o=i.length,r=0;r<o;r++){var n=new wi(i[r].state.geometry.point.pos.value);n.id=i[r].state.id,e.push(n)}return e},Ti.prototype.parsingEdgeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,o=0;o<i.length;o++){for(var r,n=[],a=0;a<i[o].transition.connects.length;a++)n.push(i[o].transition.connects[a].href);null!=i[o].transition.description&&(r=i[o].transition.description.value);for(var s=[],l=0;l<i[o].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var d=new wi(i[o].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(d)}var h=new Ri(n,r,s);e.push(h)}return e},Ti.prototype.parsingCellSpaceMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,o=0;o<i;o++){var r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[o],n="";null!=r.cellSpace.description&&(n=r.cellSpace.description.value);var a="";null!=r.cellSpace.id&&(a=r.cellSpace.id);var s="";null!=r.cellSpace.duality.href&&(s=r.cellSpace.duality.href);var l=new _i(n,s,a,[]);null!=r.cellSpace.cellSpaceGeometry.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(r):null!=r.cellSpace.cellSpaceGeometry.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(r)),e.push(l)}return e},Ti.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,o=0;o<i;o++){var r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[o],n="";null!=r.cellSpaceBoundary.description&&(n=r.cellSpaceBoundary.description.value);var a="";null!=r.cellSpaceBoundary.id&&(a=r.cellSpaceBoundary.id);var s="";null!=r.cellSpaceBoundary.duality&&(s=r.cellSpaceBoundary.duality.href);var l=new _i(n,s,a,[]);null!=r.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(r)),e.push(l)}return e},Ti.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,i=[],o=0;o<e;o++){for(var r=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[o],n=new Si([]),a=r.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=r.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);i.push(n)}return i},Ti.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],i=t.cellSpace.cellSpaceGeometry.geometry2D.abstractSurface.value.exterior.abstractRing,o=new Si([]),r=i.value.posOrPointPropertyOrPointRep.length,n=0;n<r;n++)o=this.abstractCoordinate(i.value.posOrPointPropertyOrPointRep[n].value.value,o);return e.push(o),e},Ti.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new Si([]),i=[];if(null!=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior)for(var o=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,r=0;r<o;r++)e=this.abstractCoordinate(t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[r].value.value,e);return i.push(e),i},Ti.prototype.abstractCoordinate=function(t,e){var i=t[0];e.coordinates.push(i),i>this.max_X?this.max_X=i:i<this.min_X&&(this.min_X=i);var o=t[1];e.coordinates.push(o),o>this.max_Y?this.max_Y=o:o<this.min_Y&&(this.min_Y=o);var r=t[2];return e.coordinates.push(r),r>this.max_Z?this.max_Z=r:r<this.min_Z&&(this.min_Z=r),e},Ti.prototype.getMaxX=function(){return this.max_X},Ti.prototype.getMaxY=function(){return this.max_Y},Ti.prototype.getMaxZ=function(){return this.max_Z},Ti.prototype.getMinX=function(){return this.min_X},Ti.prototype.getMinY=function(){return this.min_Y},Ti.prototype.getMinZ=function(){return this.min_Z};var Li={VERSION:"2.0"};return Li.ColorAPI=t,Li.DrawAPI=e,Li.LocationAndRotationAPI=i,Li.LodAPI=o,Li.AnimationData=h,Li.AnimationManager=c,Li.BoundingBox=u,Li.BoundingSphere=f,Li.BuildingSeed=g,Li.BuildingSeedList=p,Li.Camera=v,Li.CCTV=m,Li.CCTVList=y,Li.Color=x,Li.FBO=b,Li.FileRequestControler=C,Li.FirstPersonView=_,Li.Frustum=w,Li.FrustumVolumeControl=S,Li.GeographicCoord=R,Li.GeographicCoordSegment=L,Li.GeographicCoordsList=D,Li.GeographicExtent=I,Li.GeoLocationData=E,Li.GeoLocationDataManager=O,Li.Globe=F,Li.MagoManager=N,Li.ManagerFactory=V,Li.Matrix4=B,Li.Message=kt,Li.MouseAction=U,Li.ObjectMarker=G,Li.OcclusionCullingOctree=z,Li.OcclusionCullingOctreeCell=H,Li.Pin=W,Li.Plane=X,Li.Quaternion=K,Li.SelectionColor=Y,Li.Settings=q,Li.SmartTile=Z,Li.SmartTileManager=Q,Li.Sphere=J,Li.SplitValue=tt,Li.TerranTile=et,Li.Texture=it,Li.TexturesManager=ot,Li.TriPolyhedron=nt,Li.TriSurface=at,Li.VboBuffer=st,Li.VBOKeysNation=lt,Li.VBOKeysStore=dt,Li.VBOKeysWorld=ht,Li.VBOMemoryManager=ct,Li.VBOVertexIdxCacheKey=ut,Li.VBOVertexIdxCacheKeysContainer=ft,Li.VisibleObjectsController=gt,Li.API=r,Li.ChangeHistory=n,Li.CODE=a,Li.Constant=s,Li.MagoConfig=l,Li.Policy=d,Li.Accessor=pt,Li.Block=vt,Li.BlocksArrayPartition=yt,Li.BlocksList=mt,Li.HierarchyManager=xt,Li.InspectorBox=bt,Li.Lego=Ct,Li.LoadQueue=Mt,Li.LodBuildingData=Pt,Li.MetaData=Tt,Li.ModelReferencedGroup=_t,Li.NeoBuilding=St,Li.NeoBuildingsList=Rt,Li.NeoReference=Lt,Li.NeoReferencesMotherAndIndices=Dt,Li.NeoSimpleBuilding=It,Li.NeoTexture=Et,Li.Node=Ot,Li.Octree=Ft,Li.ParseQueue=Nt,Li.ProcessQueue=Vt,Li.ProjectTree=Bt,Li.ReaderWriter=jt,Li.TinTerrain=Ut,Li.TinTerrainManager=Gt,Li.Arc2D=Yt,Li.AxisXYZ=qt,Li.BoundingRectangle=Zt,Li.BoxAux=Qt,Li.BSplineCubic3D=Jt,Li.Circle2D=$t,Li.CuttingPlane=te,Li.Excavation=ee,Li.Face=ie,Li.HalfEdge=oe,Li.HalfEdgesList=re,Li.IndexData=ne,Li.IndexRange=ae,Li.Intersect={OUTSIDE:0,INTERSECT:1,INSIDE:2,POINT_A:3,POINT_B:4},Li.Line=se,Li.Line2D=le,Li.MagoNativeProject=de,Li.MagoWorld=he,Li.Mesh=ce,Li.Modeler=ue,Li.ParametricMesh=fe,Li.Path3D=ge,Li.PipeKnot=pe,Li.PipePath=ve,Li.PlaneGrid=ye,Li.Point2D=me,Li.Point2DList=xe,Li.Point3D=Ce,Li.Point3DList=be,Li.Point4D=Ae,Li.Polygon2D=Me,Li.PolyLine2D=Pe,Li.PolyLine3D=Te,Li.Profile2D=_e,Li.Profiles2DList=we,Li.Rectangle2D=Se,Li.Ring2D=Re,Li.Ring2DList=Le,Li.RingType={ARC:0,CIRCLE:1,POLYLINE:2,RECTANGLE:3,Star2D:4,NUMBER_OF_RING_TYPE:5},Li.Segment2D=De,Li.Segment3D=Ie,Li.Sky=Ee,Li.Star2D=Oe,Li.StaticModel=Fe,Li.Surface=Ve,Li.Triangle=Be,Li.TrianglesList=je,Li.TrianglesMatrix=Ue,Li.Tunnel=Ge,Li.Vertex=ke,Li.VertexList=ze,Li.VertexMatrix=He,Li.VtxProfile=We,Li.VtxProfilesList=Xe,Li.VtxRing=Ke,Li.VtxRingsList=Ye,Li.VtxSegment=qe,Li.Message=kt,Li.MessageSource=zt,Li.BasicFactory=Ht,Li.Box=Wt,Li.Ellipsoid=Xt,Li.Pipe=Kt,Li.Renderer=Qe,Li.RenderingSettings=Je,Li.SceneState=$e,Li.Selection=ti,Li.SelectionCandidateFamily=ei,Li.SelectionManager=ii,Li.AttribLocationState=oi,Li.PostFxShader=ri,Li.PostFxShadersManager=ni,Li.ShaderSource=ai,Li.Uniform1fDataPair=si,Li.Uniform1iDataPair=li,Li.UniformMatrix4fvDataPair=di,Li.UniformVec2fvDataPair=hi,Li.UniformVec3fvDataPair=ci,Li.UniformVec4fvDataPair=ui,Li.Network=fi,Li.NetworkEdge=gi,Li.NetworkNode=pi,Li.NetworkSpace=vi,Li.ByteColor=yi,Li.defaultValue=mi,Li.defined=xi,Li.GeometryUtils=bi,Li.loadWithXhr=Ci,Li.ManagerUtils=Ai,Li["Promise.done"]=Promise.done,Li.Promise=Promise,Li.GMLDataContainer=Mi,Li.JsonParsor_1_0_1=Pi,Li.JsonParsor_1_0_3=Ti,Li.CellSpaceMember=_i,Li.StateMember=wi,Li.SurfaceMember=Si,Li.TransitionMember=Ri,Li}();